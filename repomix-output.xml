This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.eslintrc.json
.gitignore
{
components.json
next.config.mjs
package.json
postcss.config.mjs
public/awajahi logo.png
public/next.svg
public/service-worker.js
public/vercel.svg
README.md
service_account.json
src/app/(admin)/admin-login/page.tsx
src/app/(admin)/admin-page/layout.tsx
src/app/(admin)/admin-page/page.tsx
src/app/(admin)/layout.tsx
src/app/about/page.tsx
src/app/api/admin/login/route.ts
src/app/api/admin/users/route.ts
src/app/api/api_code.docx
src/app/api/contact/route.ts
src/app/api/cron/send-expiry-notifications/route.ts
src/app/api/dashboard/route.ts
src/app/api/documents/[documentId]/route.ts
src/app/api/documents/extractExpenseRecipt/route.ts
src/app/api/documents/recent/route.ts
src/app/api/documents/reminders/route.ts
src/app/api/documents/route.ts
src/app/api/documents/validate/route.ts
src/app/api/drivers/[driverId]/accounts/[accountId]/route.ts
src/app/api/drivers/[driverId]/calculateBalance/route.ts
src/app/api/drivers/[driverId]/documents/route.ts
src/app/api/drivers/[driverId]/name/route.ts
src/app/api/drivers/[driverId]/route.ts
src/app/api/drivers/create/route.ts
src/app/api/drivers/documents/route.ts
src/app/api/drivers/route.ts
src/app/api/expenses/[expenseId]/route.ts
src/app/api/expenses/calculate/route.ts
src/app/api/expenses/draft/[expenseId]/route.ts
src/app/api/expenses/draft/route.ts
src/app/api/expenses/expenseType/route.ts
src/app/api/expenses/officeExpense/calculate/route.ts
src/app/api/expenses/officeExpense/route.ts
src/app/api/expenses/route.ts
src/app/api/expenses/tripExpense/calculate/route.ts
src/app/api/expenses/tripExpense/route.ts
src/app/api/expenses/truckExpense/calculate/route.ts
src/app/api/expenses/truckExpense/route.ts
src/app/api/generateReport/route.ts
src/app/api/invoices/[invoiceId]/route.ts
src/app/api/invoices/route.ts
src/app/api/login/route.ts
src/app/api/login/sendOtp/route.ts
src/app/api/login/verifyOtp/route.ts
src/app/api/logout/route.ts
src/app/api/notifications/send-test-notifications/route.ts
src/app/api/notifications/set-token/route.ts
src/app/api/parties/[partyId]/payments/[paymentId]/route.ts
src/app/api/parties/[partyId]/payments/route.ts
src/app/api/parties/[partyId]/route.ts
src/app/api/parties/create/route.ts
src/app/api/parties/route.ts
src/app/api/s3Upload/route.ts
src/app/api/schedule-demo/route.ts
src/app/api/search/route.ts
src/app/api/shopkhata/[shopId]/accounts/[accountsId]/route.ts
src/app/api/shopkhata/[shopId]/accounts/calculate/route.ts
src/app/api/shopkhata/[shopId]/accounts/route.ts
src/app/api/shopkhata/[shopId]/route.ts
src/app/api/shopkhata/route.ts
src/app/api/suppliers/[supplierId]/payments/[paymentId]/route.ts
src/app/api/suppliers/[supplierId]/payments/route.ts
src/app/api/suppliers/[supplierId]/payments/trips/[tripId]/route.ts
src/app/api/suppliers/[supplierId]/payments/trips/route.ts
src/app/api/suppliers/[supplierId]/route.ts
src/app/api/suppliers/route.ts
src/app/api/tripCharges/[chargeId]/route.ts
src/app/api/trips/[tripId]/accounts/[accountId]/route.ts
src/app/api/trips/[tripId]/documents/route.ts
src/app/api/trips/[tripId]/expenses/route.ts
src/app/api/trips/[tripId]/route.ts
src/app/api/trips/documents/route.ts
src/app/api/trips/getEwaybillDetails/route.ts
src/app/api/trips/getEwaybillDetails/text/route.ts
src/app/api/trips/invoice/download/route.ts
src/app/api/trips/invoice/route.ts
src/app/api/trips/party/[partyId]/accounts/route.ts
src/app/api/trips/party/[partyId]/route.ts
src/app/api/trips/route.ts
src/app/api/trips/supplier/[supplierId]/route.ts
src/app/api/trips/truck/[truckNo]/route.ts
src/app/api/trucks/[truckNo]/documents/route.ts
src/app/api/trucks/[truckNo]/expense/route.ts
src/app/api/trucks/[truckNo]/route.ts
src/app/api/trucks/[truckNo]/summary/route.ts
src/app/api/trucks/create/route.ts
src/app/api/trucks/documents/route.ts
src/app/api/trucks/route.ts
src/app/api/users/grant-access/route.ts
src/app/api/users/revoke-access/[userId]/route.ts
src/app/api/users/route.ts
src/app/contact/page.tsx
src/app/expense-management/page.tsx
src/app/favicon.ico
src/app/global-error.tsx
src/app/globals.css
src/app/layout.tsx
src/app/login/layout.tsx
src/app/login/page.tsx
src/app/not-found.tsx
src/app/page.tsx
src/app/privacy-policy/page.tsx
src/app/route-optimization/page.tsx
src/app/sitemap.ts
src/app/terms/page.tsx
src/app/trip-management/page.tsx
src/app/user/documents/companyDocuments/page.tsx
src/app/user/documents/driverDocuments/[driverId]/page.tsx
src/app/user/documents/driverDocuments/page.tsx
src/app/user/documents/layout.tsx
src/app/user/documents/loading.tsx
src/app/user/documents/otherDocuments/page.tsx
src/app/user/documents/page.tsx
src/app/user/documents/tripDocuments/[tripId]/page.tsx
src/app/user/documents/tripDocuments/page.tsx
src/app/user/documents/truckDocuments/[truckNo]/page.tsx
src/app/user/documents/truckDocuments/page.tsx
src/app/user/drivers/[driverId]/documents/page.tsx
src/app/user/drivers/[driverId]/layout.tsx
src/app/user/drivers/[driverId]/loading.tsx
src/app/user/drivers/[driverId]/page.tsx
src/app/user/drivers/[driverId]/trips/page.tsx
src/app/user/drivers/create/page.tsx
src/app/user/drivers/layout.tsx
src/app/user/drivers/loading.tsx
src/app/user/drivers/page.tsx
src/app/user/expenses/draft/page.tsx
src/app/user/expenses/layout.tsx
src/app/user/expenses/loading.tsx
src/app/user/expenses/officeExpense/page.tsx
src/app/user/expenses/page.tsx
src/app/user/expenses/tripExpense/page.tsx
src/app/user/expenses/truckExpense/page.tsx
src/app/user/home/page.tsx
src/app/user/invoice/page.tsx
src/app/user/layout.tsx
src/app/user/loading.tsx
src/app/user/page.tsx
src/app/user/parties/[singleparty]/details/page.tsx
src/app/user/parties/[singleparty]/layout.tsx
src/app/user/parties/[singleparty]/loading.tsx
src/app/user/parties/[singleparty]/monthly-balances/page.tsx
src/app/user/parties/[singleparty]/passbook/page.tsx
src/app/user/parties/[singleparty]/trips/page.tsx
src/app/user/parties/create/page.tsx
src/app/user/parties/layout.tsx
src/app/user/parties/loading.tsx
src/app/user/parties/page.tsx
src/app/user/profile/access/page.tsx
src/app/user/profile/details/page.tsx
src/app/user/profile/layout.tsx
src/app/user/profile/reports/page.tsx
src/app/user/search/page.tsx
src/app/user/shopkhata/[shopId]/layout.tsx
src/app/user/shopkhata/[shopId]/loading.tsx
src/app/user/shopkhata/[shopId]/page.tsx
src/app/user/shopkhata/create/page.tsx
src/app/user/shopkhata/layout.tsx
src/app/user/shopkhata/page.tsx
src/app/user/suppliers/[supplierId]/layout.tsx
src/app/user/suppliers/[supplierId]/passbook/page.tsx
src/app/user/suppliers/[supplierId]/trips/page.tsx
src/app/user/suppliers/[supplierId]/trucks/page.tsx
src/app/user/suppliers/create/page.tsx
src/app/user/suppliers/layout.tsx
src/app/user/suppliers/loading.tsx
src/app/user/suppliers/page.tsx
src/app/user/trips/[tripId]/documents/page.tsx
src/app/user/trips/[tripId]/layout.tsx
src/app/user/trips/[tripId]/page.tsx
src/app/user/trips/create/page.tsx
src/app/user/trips/invoice/page.tsx
src/app/user/trips/layout.tsx
src/app/user/trips/loading.tsx
src/app/user/trips/page.tsx
src/app/user/trucks/[truckNo]/documents/page.tsx
src/app/user/trucks/[truckNo]/driverExpense/page.tsx
src/app/user/trucks/[truckNo]/fuel/page.tsx
src/app/user/trucks/[truckNo]/layout.tsx
src/app/user/trucks/[truckNo]/loading.tsx
src/app/user/trucks/[truckNo]/maintainence/page.tsx
src/app/user/trucks/[truckNo]/page.tsx
src/app/user/trucks/[truckNo]/trips/page.tsx
src/app/user/trucks/create/page.tsx
src/app/user/trucks/layout.tsx
src/app/user/trucks/loading.tsx
src/app/user/trucks/page.tsx
src/assets/ai icon.png
src/assets/awajahi logo.png
src/assets/awajahi-white-logo.png
src/assets/bilty-home-icon.png
src/assets/bilty-icon.png
src/assets/comming-soon.png
src/assets/currently-building.png
src/assets/ewb-icon.png
src/assets/expense management icon.png
src/assets/fb-icon.png
src/assets/fm-home-icon.png
src/assets/folder-icon.png
src/assets/Group 427320428.png
src/assets/gst-banner.png
src/assets/hero section illustration.png
src/assets/home-icon.png
src/assets/insta-icon.png
src/assets/insurance-icon.png
src/assets/linkedin-icon.png
src/assets/loading-slip-home-icon.png
src/assets/login icon.png
src/assets/mobile-img.png
src/assets/not-found.webp
src/assets/others.png
src/assets/otp-pic.png
src/assets/permit-icon.png
src/assets/playstore.png
src/assets/pod-icon.png
src/assets/qr code.png
src/assets/quotation-home-icon.png
src/assets/rc-icon.png
src/assets/route management icon.png
src/assets/sampleInvoice.png
src/assets/section3-img.png
src/assets/trip management icon.png
src/assets/trips-icon.png
src/assets/truck.webp
src/assets/youtube-icon.png
src/components/AddExpenseModal.tsx
src/components/AdExpenseTypeModal.tsx
src/components/admin/Header.tsx
src/components/admin/Sidebar.tsx
src/components/AppDownload.tsx
src/components/createDriver.tsx
src/components/createParty.tsx
src/components/createSupplier.tsx
src/components/documents/company-document-upload-modal.tsx
src/components/documents/CompanyDocumentUpload.tsx
src/components/documents/DriverDocumentUpload.tsx
src/components/documents/other-document-upload-modal.tsx
src/components/documents/OtherDocumentUpload.tsx
src/components/documents/PreviewDocument.tsx
src/components/documents/RecentDocuments.tsx
src/components/documents/TripDocumentUpload.tsx
src/components/documents/TruckDocumentUpload.tsx
src/components/driver/driverActions.tsx
src/components/driver/DriverBalance.tsx
src/components/driver/DriverDocument.tsx
src/components/driver/driverLayout.tsx
src/components/driver/driverModal.tsx
src/components/driver/DriverName.tsx
src/components/driver/dropdownMenu.tsx
src/components/driver/editDriverModal.tsx
src/components/ExpenseFilterModal.tsx
src/components/ExpenseHeader.tsx
src/components/ExpenseProvider.tsx
src/components/ExpenseTable.tsx
src/components/FeatureSection.tsx
src/components/FileUploader.tsx
src/components/Footer.tsx
src/components/HeroSection.tsx
src/components/hooks/use-toast.ts
src/components/hooks/useAnimatedNumber.ts
src/components/hooks/useExpenseData.ts
src/components/layout/ExpenseLayout.tsx
src/components/layout/MainLayout.tsx
src/components/layout/PartyLayout.tsx
src/components/layout/ProfileLayout.tsx
src/components/layout/SupplierLayout.tsx
src/components/layout/TruckLayout.tsx
src/components/LogoutModal.tsx
src/components/Navigation.tsx
src/components/Notification.tsx
src/components/OtpLogin.tsx
src/components/party/PartyName.tsx
src/components/party/PaymentModal.tsx
src/components/percentageDonut.tsx
src/components/RecentActivites.tsx
src/components/RenderDocument.tsx
src/components/Report.tsx
src/components/ScheduleDemo.tsx
src/components/search/Driver.tsx
src/components/search/Expense.tsx
src/components/search/OfficeExpense.tsx
src/components/search/Party.tsx
src/components/search/Supplier.tsx
src/components/search/SupplierAccount.tsx
src/components/search/Trip.tsx
src/components/search/TripCharges.tsx
src/components/search/Truck.tsx
src/components/shopkhata/dropDownMenu.tsx
src/components/shopkhata/EditShopModal.tsx
src/components/shopkhata/shopActions.tsx
src/components/shopkhata/ShopBalance.tsx
src/components/shopkhata/ShopKhataForm.tsx
src/components/shopkhata/ShopLayout.tsx
src/components/shopkhata/ShopModal.tsx
src/components/shopkhata/ShopSelect.tsx
src/components/SingleFileUploader.tsx
src/components/supplier/AddPaymentModal.tsx
src/components/supplier/EditSupplierModal.tsx
src/components/supplier/SupplierBalance.tsx
src/components/supplier/SupplierName.tsx
src/components/supplier/TripAllocationModal.tsx
src/components/trip/BillingInfo.tsx
src/components/trip/BiltyForm.tsx
src/components/trip/DateInputs.tsx
src/components/trip/DriverSelect.tsx
src/components/trip/EditTripForm.tsx
src/components/trip/FrieghtMemo.tsx
src/components/trip/MaterialInput.tsx
src/components/trip/PartySelect.tsx
src/components/trip/RouteInputs.tsx
src/components/trip/tripDetail/ChargeModal.tsx
src/components/trip/tripDetail/Charges.tsx
src/components/trip/tripDetail/DataList.tsx
src/components/trip/tripDetail/EditChargeModal.tsx
src/components/trip/tripDetail/EwayBillUpload.tsx
src/components/trip/tripDetail/ExpenseModal.tsx
src/components/trip/tripDetail/Modal.tsx
src/components/trip/tripDetail/Payments.tsx
src/components/trip/tripDetail/PODViewer.tsx
src/components/trip/tripDetail/Profit.tsx
src/components/trip/tripDetail/Profit/ProfitItem.tsx
src/components/trip/tripDetail/Profit/TripRevenue.tsx
src/components/trip/tripDetail/TripDetail.tsx
src/components/trip/tripDetail/TripFunctions/FrieghtInvoice.tsx
src/components/trip/tripDetail/TripFunctions/InoiveForm.tsx
src/components/trip/tripDetail/TripFunctions/InvoiceForm.tsx
src/components/trip/tripDetail/TripFunctions/InvoicePaymentModal.tsx
src/components/trip/tripDetail/TripFunctions/LoadingSlip.tsx
src/components/trip/tripDetail/TripFunctions/StatusButton.tsx
src/components/trip/tripDetail/TripFunctions/StatusModal.tsx
src/components/trip/tripDetail/TripFunctions/ViewBill.tsx
src/components/trip/tripDetail/TripInfo.tsx
src/components/trip/tripDetail/TripStatus.tsx
src/components/trip/TripDocuments.tsx
src/components/trip/TripForm.tsx
src/components/trip/TripRoute.tsx
src/components/trip/TruckSelect.tsx
src/components/TripCard.tsx
src/components/truck/AdditionalDetails.tsx
src/components/truck/EditTruckModal.tsx
src/components/truck/FuelInput.tsx
src/components/truck/SupplierSelect.tsx
src/components/truck/TruckDocument.tsx
src/components/ui/alert.tsx
src/components/ui/button.tsx
src/components/ui/calendar.tsx
src/components/ui/card.tsx
src/components/ui/carousel.tsx
src/components/ui/chart.tsx
src/components/ui/checkbox.tsx
src/components/ui/dialog.tsx
src/components/ui/dropdown-menu.tsx
src/components/ui/input-otp.tsx
src/components/ui/input.tsx
src/components/ui/label.tsx
src/components/ui/LoadingIndicator.tsx
src/components/ui/popover.tsx
src/components/ui/radio-group.tsx
src/components/ui/resizable.tsx
src/components/ui/select.tsx
src/components/ui/table.tsx
src/components/ui/tabs.tsx
src/components/ui/toast.tsx
src/components/ui/toaster.tsx
src/components/ui/tooltip.tsx
src/components/WhyChooseUs.tsx
src/context/AdvanceContext.tsx
src/context/context.tsx
src/context/driverContext.tsx
src/context/expenseContext.tsx
src/context/partyContext.tsx
src/context/recentDocs.tsx
src/context/reminderContext.tsx
src/context/supplierContext.tsx
src/context/tripContext.tsx
src/context/truckContext.tsx
src/firebase/firbaseConfig.ts
src/firebase/firebaseAdmin.ts
src/helpers/DeleteAccount.ts
src/helpers/driverOperations.ts
src/helpers/ExpenseOperation.ts
src/helpers/fetchPartyName.ts
src/helpers/fetchTripBalance.ts
src/helpers/fileOperation.ts
src/helpers/ImageOperation.ts
src/helpers/modifyInvoice.ts
src/helpers/recentActivity.ts
src/helpers/removebg.ts
src/helpers/SupplierOperation.ts
src/helpers/TripOperation.ts
src/helpers/truckOperations.ts
src/lib/analytics.tsx
src/lib/utils.ts
src/middleware.ts
src/services/expiryCheckService.ts
src/services/notificationService.ts
src/store/api.ts
src/store/hooks.ts
src/store/store.ts
src/store/tripsSlice.ts
src/utils/animation.ts
src/utils/auth.ts
src/utils/cities.ts
src/utils/CountryCodes.ts
src/utils/DocGeneration.tsx
src/utils/encryption.ts
src/utils/EwayBillColor.tsx
src/utils/excelOperation.ts
src/utils/icons.tsx
src/utils/imgColor.ts
src/utils/interface.ts
src/utils/renderTripCell.tsx
src/utils/saveTripDocs.ts
src/utils/schema.ts
src/utils/utilArray.ts
src/utils/validate.ts
tailwind.config.ts
tsconfig.json
vercel.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".eslintrc.json">
{
  "extends": "next/core-web-vitals"
}
</file>

<file path="components.json">
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "default",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.ts",
    "css": "src/app/globals.css",
    "baseColor": "slate",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils"
  }
}
</file>

<file path="next.config.mjs">
/** @type {import('next').NextConfig} */
const nextConfig = {
  webpack: (config) => {
    config.resolve.alias.canvas = false;
    return config;
  },
  experimental : {
    serverActions : {
      bodySizeLimit : '10mb'
    }
  },
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: `${process.env.AWS_S3_BUCKET_NAME}.s3.${process.env.AWS_S3_REGION}.amazonaws.com`,
        port: '',
        pathname: '/**', // Allow all paths from this bucket
      },
      {
        protocol: 'https',
        hostname: `${process.env.AWS_S3_BUCKET_NAME_PREV}.s3.${process.env.AWS_S3_REGION_PREV}.amazonaws.com`,
        port: '',
        pathname: '/**', // Allow all paths from the second bucket
      },
      {
        protocol: 'https',
        hostname: `www.awajahi.com`,
        port: '',
        pathname: '/**', // Allow all paths from the second bucket
      },
      {
        protocol: 'https',
        hostname: `img.icons8.com`,
        port: '',
        pathname: '/**', // Allow all paths from this bucket
      },
    ],
  },
};

export default nextConfig;
 
//
</file>

<file path="postcss.config.mjs">
/** @type {import('postcss-load-config').Config} */
const config = {
  plugins: {
    tailwindcss: {},
  },
};

export default config;
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/vercel.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 283 64"><path fill="black" d="M141 16c-11 0-19 7-19 18s9 18 20 18c7 0 13-3 16-7l-7-5c-2 3-6 4-9 4-5 0-9-3-10-7h28v-3c0-11-8-18-19-18zm-9 15c1-4 4-7 9-7s8 3 9 7h-18zm117-15c-11 0-19 7-19 18s9 18 20 18c6 0 12-3 16-7l-8-5c-2 3-5 4-8 4-5 0-9-3-11-7h28l1-3c0-11-8-18-19-18zm-10 15c2-4 5-7 10-7s8 3 9 7h-19zm-39 3c0 6 4 10 10 10 4 0 7-2 9-5l8 5c-3 5-9 8-17 8-11 0-19-7-19-18s8-18 19-18c8 0 14 3 17 8l-8 5c-2-3-5-5-9-5-6 0-10 4-10 10zm83-29v46h-9V5h9zM37 0l37 64H0L37 0zm92 5-27 48L74 5h10l18 30 17-30h10zm59 12v10l-3-1c-6 0-10 4-10 10v15h-9V17h9v9c0-5 6-9 13-9z"/></svg>
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org/) project bootstrapped with [`create-next-app`](https://github.com/vercel/next.js/tree/canary/packages/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/basic-features/font-optimization) to automatically optimize and load Inter, a custom Google Font.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js/) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/deployment) for more details.
</file>

<file path="src/app/(admin)/admin-login/page.tsx">
'use client';

import { Button } from '@/components/ui/button';
import { useRouter, useSearchParams } from 'next/navigation';
import React, { Suspense, useEffect, useState } from 'react';


const AdminLogin = () => {
  const router = useRouter();
  const params = useSearchParams();
  const phone = params ? params.get('phone') : ''; // Handle fallback for `useSearchParams`
  const [password, setPassword] = useState('');

  useEffect(() => {
    if (!phone || !(JSON.parse(process.env.NEXT_PUBLIC_ADMIN_LOGIN_PHONE as string) as [string]).includes(phone)) {
      router.push('/user/home');
    }
    if (localStorage.getItem('adminToken')) {
      router.push('/admin-page');
    }
  }, [phone, router]);

  const handlePasswordChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setPassword(e.target.value);
  };

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();

    try {
      const response = await fetch('/api/admin/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ phone, password }),
      });

      if (response.ok) {
        const data = await response.json();
        if (data) {
          localStorage.setItem('adminToken', JSON.stringify(data.token));
          router.push('/admin-page');
        } else {
          console.error('Token missing in response');
        }
      } else {
        const errorText = await response.text();
        console.error('Login failed:', errorText);
      }
    } catch (error) {
      console.error('Error during login:', error);
    }
  };

  return (
    <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100">
      <form
        onSubmit={handleSubmit}
        className="w-full max-w-sm bg-white p-6 rounded-lg shadow-md"
      >
        <h2 className="text-2xl font-bold mb-4 text-center">Admin Login</h2>

        <div className="mb-4">
          <label htmlFor="phone">Phone</label>
          <input type="text" id="phone" name="phone" value={phone || ''} disabled />
        </div>

        <div className="mb-4">
          <label htmlFor="password">Password</label>
          <input
            type="password"
            id="password"
            name="password"
            value={password}
            onChange={handlePasswordChange}
            required
          />
        </div>

        <Button type="submit" className="w-full">
          Submit
        </Button>
      </form>
    </div>
  );
};


export default function Page() {
    return (
      <Suspense fallback={<div>Loading...</div>}>
        <AdminLogin />
      </Suspense>
    );
  }
</file>

<file path="src/app/(admin)/admin-page/layout.tsx">
import type { Metadata } from "next"
import { Inter } from "next/font/google"
import "@/app/globals.css"
import Header from "@/components/admin/Header"
import Sidebar from "@/components/admin/Sidebar"

const inter = Inter({ subsets: ["latin"] })

export const metadata: Metadata = {
    title: "Awajahi Dashboard",
    description: "Admin dashboard for Awajahi",
}

export default function RootLayout({
    children,
}: {
    children: React.ReactNode
}) {
    return (
        <html lang="en">
            <body className={inter.className}>
                <div className="min-h-screen bg-gray-100 flex flex-col">
                    <Header />
                    <div className="grid grid-cols-6">
                        <div className="col-span-1">
                            <Sidebar />
                        </div>

                        <main className="flex-1 overflow-y-auto p-8 col-span-5">{children}</main>
                    </div>
                </div>
            </body>
        </html>
    )
}
</file>

<file path="src/app/(admin)/admin-page/page.tsx">
"use client"

import React, { useEffect, useState } from "react"
import { HomeIcon, UsersIcon, BuildingIcon as BuildingOfficeIcon, CogIcon, SearchIcon } from "lucide-react"
import { useRouter } from "next/navigation"
import Image from "next/image"
import { Button } from "@/components/ui/button"
import Link from "next/link"
import { formatNumber } from "@/utils/utilArray"

interface User {
  phone: string
  name: string
  role: { name: string }
  companyName: string
  address: string
  deviceType: string
  lastLogin: string
  createdAt: string
}

const AdminPage = () => {
  const router = useRouter()
  const [users, setUsers] = useState<User[]>([])
  const [searchTerm, setSearchTerm] = useState("")
  const [activeTab, setActiveTab] = useState("Dashboard")

  const fetchUsers = async () => {
    try {
      const res = await fetch("/api/admin/users", {
        method: "GET",
        headers: {
          Authorization: `Bearer ${localStorage.getItem("adminToken")}`,
        },
      })
      if (res.status === 401) {
        localStorage.removeItem("adminToken")
        router.push("/user/profile/details")
      }
      if (res.ok) {
        const data = await res.json()
        setUsers(data.users)
      } else {
        throw new Error("Error fetching Users")
      }
    } catch (error) {
      console.error(error)
      alert("Failed to fetch users")
    }
  }

  useEffect(() => {
    fetchUsers()
  }, [])

  const filteredUsers = users.filter((user) =>
    Object.values(user).some((value) => String(value).toLowerCase().includes(searchTerm.toLowerCase())),
  )

  const newUsers = users?.filter(user => new Date(user.createdAt) === new Date(Date.now())).length


  const sidebarItems = [
    { icon: HomeIcon, label: "Dashboard" },
    { icon: CogIcon, label: "Settings" },
  ]

  return (
    <>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-4">
        <div className="p-4 text-black rounded-xl border bg-white text-left gap-4">
          <span className="text-sm">Total Users</span>
          <p className="mt-3 text-xl font-semibold">{formatNumber(users.length)}</p>
        </div>
        <div className="p-4 text-black rounded-xl border bg-white text-left gap-4">
          <span className="text-sm">Active Users</span>
          <p className="mt-3 text-xl font-semibold">{formatNumber(users.length)}</p>
        </div>
        <div className="p-4 text-black rounded-xl border bg-white text-left gap-4">
          <span className="text-sm">New Users</span>
          <p className="mt-3 text-xl font-semibold">{formatNumber(newUsers)}</p>
        </div>
        <div className="p-4 text-black rounded-xl border bg-white text-left gap-4">
          <span className="text-sm">Inactive Users</span>
          <p className="mt-3 text-xl font-semibold">{formatNumber(0)}</p>
        </div>
      </div>
      <div className="mb-6 flex justify-between items-center">
        <h1 className="text-2xl font-bold text-gray-800">User Details</h1>
        <div className="relative">
          <input
            type="text"
            placeholder="Search users..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="pl-10 pr-4 py-2"
          />
        </div>
      </div>

      <div className="bg-white shadow-md rounded-lg overflow-hidden">
        <div className="overflow-x-auto">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                {["Phone", "Name", "Role", "Company Name", "Address", "Device Type", "Last Login"].map((header) => (
                  <th
                    key={header}
                    className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    {header}
                  </th>
                ))}
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {filteredUsers.map((user, index) => (
                <tr key={index} className="hover:bg-gray-50">
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{user.phone}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{user.name}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{user.role?.name}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{user.companyName}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{user.address}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{user.deviceType}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {new Date(user.lastLogin).toLocaleDateString("en-IN")}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </>
  )
}

export default AdminPage
</file>

<file path="src/app/(admin)/layout.tsx">
import type { Metadata } from "next";
import '@/app/globals.css';
import { cn } from "@/lib/utils";
import { Roboto as FontSans } from "next/font/google";

// Load Roboto font with multiple weights
const fontSans = FontSans({
  subsets: ["latin"],
  weight: ["100", "300", "400", "500", "700"],
  variable: "--font-sans",
});

export const metadata: Metadata = {
  title: "Awajahi Admin - Management of Users",
  description: "Awajahi is transforming transportation in India, one mile at a time. Discover our services and how we are moving India efficiently and reliably.",
  keywords: ["Awajahi", "Transport", "Logistics", "India", "Moving Services", "Web Application", "Fleet Management", "awajahi"],
  authors: [{ name: "Awajahi Team" }],
  robots: {
    index: true,
    follow: true,
  },
  openGraph: {
    title: "Awajahi - Moving India One Mile at a Time",
    description: "Explore Awajahi for reliable and efficient transportation services across India.",
    url: "https://www.awajahi.com",
    type: "website",
    locale: "en_IN",
    images: [
      {
        url: "https://www.awajahi.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fawajahi%20logo.e4977a4d.png&w=64&q=75",
        width: 1200,
        height: 630,
        alt: "Awajahi Logo",
      },
    ],
  },
  icons: {
    icon: "/favicon.ico",
  },
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en" suppressHydrationWarning>
      <head>
        {/* Add Google Analytics Script */}
        
      </head>
      <body
        className={cn(
          "min-h-screen bg-background font-roboto antialiased",
          fontSans.variable
        )}
      >
        {children}
        
      </body>
    </html>
  );
}
</file>

<file path="src/app/api/admin/login/route.ts">
import { NextResponse } from "next/server";
import bcrypt from "bcrypt";
import jwt from "jsonwebtoken";
import { serialize } from "cookie";

const SECRET_KEY = process.env.JWT_SECRET || "your-default-secret";

export async function POST(req: Request) {
  try {
    // Parse the request body
    const data = await req.json();
    const { phone, password } = data;

    // Retrieve admin phone numbers from environment variables
    const phonearr = JSON.parse(
      process.env.NEXT_PUBLIC_ADMIN_LOGIN_PHONE as string
    ) as string[];

    if (!phonearr.includes(phone)) {
      return NextResponse.json({ error: "Invalid phone number" }, { status: 400 });
    }

    // Retrieve the hashed password from environment variables
    const hashedPassword = "$2b$10$GyrD9WkJ3agyLNo.yJUP1em9gHCGoYJR5DTr2mmMGTRmgTrxaLQ2a"

    if (!hashedPassword) {
      return NextResponse.json({ error: "Server configuration error" }, { status: 500 });
    }

    // Compare the provided password with the stored hash
    const hash = await bcrypt.hash(password,10)
    // console.log('user-pass',hash)
    // console.log('env-pass',hashedPassword)
    const isPasswordValid = await bcrypt.compare(password, hashedPassword);

    if (!isPasswordValid) {
      return NextResponse.json({ error: "Invalid password" }, { status: 401 });
    }

    // Create a JWT token
    const token = jwt.sign(
      { phone, role: "admin" }, // Payload
      SECRET_KEY, // Secret key
      { expiresIn: "1d" } // Token expiry
    );

    // Set the JWT as a cookie
    const cookie = serialize("token", token, {
      httpOnly: true, // Prevents client-side access
      secure: process.env.NODE_ENV === "production", // Ensures secure cookies in production
      sameSite: "strict", // Prevents CSRF
      maxAge: 60 * 60 * 24, // 1 hour
      path: "/", // Available across the entire app
    });

    return NextResponse.json({ message: "Login successful", token : cookie },{status : 200});
  } catch (error) {
    console.error("Error in admin login:", error);
    return NextResponse.json({ error: "Internal server error" }, { status: 500 });
  }
}
</file>

<file path="src/app/api/admin/users/route.ts">
import { NextResponse } from "next/server";
import jwt, { JwtPayload } from "jsonwebtoken";
import { connectToDatabase, userSchema } from "@/utils/schema";
import { models, model } from "mongoose";
import {parse} from 'cookie'

const User = models.User || model("User", userSchema);

export async function GET(req: Request) {
  try {
    // Extract the 'Authorization' header
    const authHeader = req.headers.get("authorization");
    if (!authHeader) {
      return NextResponse.json(
        { message: "Unauthorized access: Missing authorization header" },
        { status: 401 }
      );
    }

    // Parse the token from the 'Authorization' header
    const tokenMatch = authHeader.match(/Bearer\s+(.*)/);
    const token = tokenMatch ? parse(tokenMatch[1])['"token'] : null;
    console.log(parse(token as string))

    if (!token) {
      return NextResponse.json(
        { message: "Unauthorized access: Token not found" },
        { status: 401 }
      );
    }

    // Verify the token
    let verifiedToken: JwtPayload | string;
    try {
      verifiedToken = jwt.verify(token, process.env.JWT_SECRET as string) as JwtPayload;
    } catch (err) {
      // Catch JWT-specific errors and return 401
      if (
        err instanceof jwt.JsonWebTokenError || // Invalid token
        err instanceof jwt.TokenExpiredError || // Expired token
        err instanceof jwt.NotBeforeError // Token not active yet
      ) {
        return NextResponse.json(
          { message: `Unauthorized access: ${err.message}` },
          { status: 401 }
        );
      }
      throw err; // Re-throw other errors for generic handling
    }

    // Connect to the database
    await connectToDatabase();

    // Fetch users from the database
    const users = await User.find();
    return NextResponse.json({ users }, { status: 200 });
  } catch (error: any) {
    console.error("Error fetching users:", error.message);
    return NextResponse.json(
      { message: "Internal server error", error: error.message },
      { status: 500 }
    );
  }
}
</file>

<file path="src/app/api/cron/send-expiry-notifications/route.ts">
// app/api/cron/send-expiry-notifications/route.ts

import { NextResponse } from 'next/server';
import { handleDailyExpiryCheck } from '@/services/expiryCheckService';

export async function GET(req: Request) {
    // 1. Authenticate the request
    // This ensures that only Vercel's scheduler (or someone with the secret) can run this job.
    const { searchParams } = new URL(req.url);
    if (searchParams.get('cron_secret') !== process.env.CRON_SECRET) {
        return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    // 2. Trigger the core logic from the dedicated service file
    try {
        const result = await handleDailyExpiryCheck();
        return NextResponse.json(result);
    } catch (error) {
        console.error("Cron job API handler encountered an error:", error);
        return NextResponse.json(
            { success: false, error: "Internal Server Error" },
            { status: 500 }
        );
    }
}
</file>

<file path="src/app/api/dashboard/route.ts">
import { model, models } from 'mongoose'
import { tripSchema, ExpenseSchema, connectToDatabase, RecentActivitiesSchema } from '@/utils/schema';
import { verifyToken } from '@/utils/auth';
import { NextResponse } from 'next/server';

const Trip = models.Trip || model('Trip', tripSchema)
const Expense = models.Expense || model('Expense', ExpenseSchema)
const RecentActivities = models.RecentActivities || model('RecentActivities',RecentActivitiesSchema)

async function getTripsByMonth(userId: string) {
  // Determine the current financial year
  const now = new Date();
  let startOfFinancialYear = new Date(now.getFullYear(), 3, 1); // April 1st
  let endOfFinancialYear = new Date(now.getFullYear() + 1, 2, 31, 23, 59, 59, 999); // March 31st next year

  if (now.getMonth() < 3) {
      startOfFinancialYear.setFullYear(now.getFullYear() - 1);
      endOfFinancialYear.setFullYear(now.getFullYear());
  }

  // Extract the start year and end year of the financial year
  const startYear = startOfFinancialYear.getFullYear();
  const endYear = endOfFinancialYear.getFullYear();

  // Perform the aggregation
  const result = await Trip.aggregate([
      {
          $match: {
              user_id: userId,
              startDate: { $gte: startOfFinancialYear, $lte: endOfFinancialYear },
          },
      },
      {
          $group: {
              _id: { 
                  month: { $month: "$startDate" }, // Extract month
                  year: { $year: "$startDate" },   // Extract year
              },
              count: { $sum: 1 }, // Count trips for each month
          },
      },
      {
          $sort: { "_id.year": 1, "_id.month": 1 }, // Sort by year and month
      },
      {
          $facet: {
              months: [
                  {
                      $project: {
                          month: "$_id.month",
                          year: "$_id.year",
                          count: 1,
                      },
                  },
              ],
              allMonths: [
                  {
                      $project: {
                          month: { $literal: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12] },
                      },
                  },
                  { $unwind: "$month" },
                  {
                      $project: {
                          month: 1,
                          year: {
                              $cond: [
                                  { $lte: ["$month", 3] }, // If the month is Jan-Mar
                                  endYear,
                                  startYear,
                              ],
                          },
                          count: { $literal: 0 }, // Default count = 0 for missing months
                      },
                  },
              ],
          },
      },
      {
          $project: {
              combined: {
                  $setUnion: ["$months", "$allMonths"], // Combine actual and default months
              },
          },
      },
      {
          $unwind: "$combined", // Flatten combined array
      },
      {
          $replaceRoot: { newRoot: "$combined" }, // Restructure output
      },
      {
          $group: {
              _id: { month: "$month", year: "$year" },
              count: { $max: "$count" }, // Take the actual count if exists, otherwise 0
          },
      },
      {
          $sort: { "_id.year": 1, "_id.month": 1 }, // Sort by year and month
      },
      {
          $project: {
              month: {
                  $arrayElemAt: [
                      [null, "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
                      "$_id.month",
                  ],
              },
              year: "$_id.year",
              count: 1,
          },
      },
      {
          $project: {
              monthYear: { $concat: ["$month", " ", { $toString: "$year" }] }, // Concatenate month and year
              count: 1,
          },
      },
  ]);

  return result;
}



async function getAccounts(userId : string){
    const accountsReceivable : any = await Trip.aggregate([
        {
          $match: { user_id: userId } // Filter by user ID
        },
        {
          $lookup: {
            from: 'tripcharges',
            localField: 'trip_id',
            foreignField: 'trip_id',
            as: 'tripExpenses'
          }
        },
        {
          $lookup: {
            from: 'partypayments',
            localField: 'trip_id',
            foreignField: 'trip_id',
            as: 'tripAccounts'
          }
        },
        {
          $addFields: {
            balance: {
              $let: {
                vars: {
                  accountBalance: {
                    $sum: {
                      $map: {
                        input: '$tripAccounts',
                        as: 'account',
                        in: '$$account.amount'
                      }
                    }
                  },
                  chargeToBill: {
                    $sum: {
                      $map: {
                        input: {
                          $filter: {
                            input: '$tripExpenses',
                            as: 'expense',
                            cond: { $eq: ['$$expense.partyBill', true] }
                          }
                        },
                        as: 'filteredExpense',
                        in: '$$filteredExpense.amount'
                      }
                    }
                  },
                  chargeNotToBill: {
                    $sum: {
                      $map: {
                        input: {
                          $filter: {
                            input: '$tripExpenses',
                            as: 'expense',
                            cond: { $eq: ['$$expense.partyBill', false] }
                          }
                        },
                        as: 'filteredExpense',
                        in: '$$filteredExpense.amount'
                      }
                    }
                  }
                },
                in: {
                  $subtract: [
                    { $add: ['$amount', '$$chargeToBill'] },  // Add trip amount and chargeToBill
                    { $add: ['$$accountBalance', '$$chargeNotToBill'] }  // Subtract accountBalance and chargeNotToBill
                  ]
                }
              }
            }
          }
        },
        {
          $group: {
            _id: null, // Group all trips together
            totalReceivable: { $sum: '$balance' } // Sum up all balances
          }
        },
        {
          $project: {
            _id: 0, // Exclude the _id field
            totalReceivable: 1 // Include only the totalReceivable field
          }
        }
      ]);

      return accountsReceivable['totalReceivable'];
}
async function categorizeExpenses(userId: string) {
    // Define the financial year
    const now = new Date();
    const startOfFinancialYear = new Date(now.getFullYear(), 3, 1); // April 1st
    const endOfFinancialYear = new Date(now.getFullYear() + 1, 2, 31, 23, 59, 59, 999); // March 31st next year

    if (now.getMonth() < 3) {
        startOfFinancialYear.setFullYear(now.getFullYear() - 1);
        endOfFinancialYear.setFullYear(now.getFullYear());
    }

    // Perform aggregation
    const result = await Expense.aggregate([
        {
            $match: {
                user_id: userId,
                date: { $gte: startOfFinancialYear, $lte: endOfFinancialYear }
            }
        },
        {
            $addFields: {
                category: {
                    $cond: [
                        { $ne: ["$trip_id", ""] }, // Trip Expense
                        "Trip",
                        {
                            $cond: [
                                { $and: [{ $eq: ["$trip_id", ""] }, { $ne: ["$truck", ""] }] }, // Truck Expense
                                "Truck",
                                "Office" // Office Expense
                            ]
                        }
                    ]
                }
            }
        },
        {
            $group: {
                _id: "$category",
                totalExpenses: { $sum: 1 },
                totalAmount: { $sum: "$amount" }
            }
        },
        {
            $sort: { _id: 1 } // Optional: Sort categories alphabetically
        }
    ]);

    return result;
}
async function calculateMonthlyProfit(user: string) {
    const now = new Date();
    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
    const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
  
    const result = await Trip.aggregate([
      {
        $match: {
          user_id: user,
          startDate: { $gte: startOfMonth, $lte: endOfMonth },
        },
      },
      {
        $lookup: {
          from: 'trucks',
          localField: 'truck',
          foreignField: 'truckNo',
          as: 'truckDetails',
        },
      },
      { $unwind: '$truckDetails' },
      {
        $lookup: {
          from: 'tripcharges',
          localField: 'trip_id',
          foreignField: 'trip_id',
          as: 'charges',
        },
      },
      { $unwind: { path: '$charges', preserveNullAndEmptyArrays: true } },
      {
        $group: {
          _id: null, // Combine all ownership types into a single result
          totalFreight: { $sum: '$amount' }, // Total freight
          totalCharges: {
            $sum: {
              $cond: [
                { $eq: ['$charges.partyBill', true] },
                { $ifNull: ['$charges.amount', 0] },
                0,
              ],
            },
          },
          totalDeductions: {
            $sum: {
              $cond: [
                { $eq: ['$charges.partyBill', false] },
                { $ifNull: ['$charges.amount', 0] },
                0,
              ],
            },
          },
        },
      },
      {
        $lookup: {
          from: 'expenses',
          pipeline: [
            {
              $match: {
                user_id: user,
                date: { $gte: startOfMonth, $lte: endOfMonth },
              },
            },
            { $group: { _id: null, totalExpense: { $sum: '$amount' } } },
          ],
          as: 'expensesData',
        },
      },
      { $unwind: { path: '$expensesData', preserveNullAndEmptyArrays: true } },
      {
        $project: {
          totalProfit: {
            $subtract: [
              { $add: ['$totalFreight', '$totalCharges'] }, // Freight + party charges
              { $add: ['$totalDeductions', { $ifNull: ['$expensesData.totalExpense', 0] }] }, // Deductions + expenses
            ],
          },
        },
      },
    ]);
  
    return result[0]?.totalProfit || 0; // Return total profit or 0 if no data
  }
  

export async function GET(req: Request) {
    try {
        const { user, error } = await verifyToken(req)
        if (!user || error) {
            return NextResponse.json({ error: 'unauthorized', status: 401 })
        }
        await connectToDatabase()
        const [expenses, trips, accountsReceivable, profit, recentActivities] = await Promise.all([categorizeExpenses(user), getTripsByMonth(user),getAccounts(user), calculateMonthlyProfit(user), RecentActivities.findOne({user_id : user}).select('activities').lean() ])
        return NextResponse.json({ expenses, trips, accountsReceivable, profit,recentActivities, status: 200 })
    } catch (error) {
        console.log(error)
        return NextResponse.json({ error, status: 500 })
    }
}
</file>

<file path="src/app/api/documents/[documentId]/route.ts">
import { recentActivity } from "@/helpers/recentActivity";
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, driverSchema, otherDocumentsSchema, tripSchema, truckSchema } from "@/utils/schema";
import { models, model } from "mongoose";
import { NextResponse } from "next/server";

const OtherDocuments = models.OtherDocuments || model("OtherDocuments", otherDocumentsSchema);

export async function PATCH(req: Request, { params }: { params: { documentId: string } }) {
    try {
        const { user, error } = await verifyToken(req);
        if (!user || error) {
            return NextResponse.json({ error: "Unauthorized user", status: 401 });
        }

        const { documentId } = params;
        await connectToDatabase();
        const data = await req.json();

        const document = await OtherDocuments.findByIdAndDelete(documentId);
        if (!document) {
            return NextResponse.json({ error: "Document not found", status: 404 });
        }

        const url = new URL(req.url);
        const movingto = url.searchParams.get("movingto");
        const commonDocFields = {
            filename: data.filename || "",
            type: data.docType,
            validityDate: new Date(data.validityDate),
            uploadedDate: new Date(),
            url: document.url,
        };

        switch (movingto) {
            case "trip": {
                const Trip = models.Trip || model("Trip", tripSchema);
                const { tripId } = data;
                if (!tripId) {
                    return NextResponse.json({ error: "Missing tripId", status: 400 });
                }

                const trip = await Trip.findOne({ user_id: user, trip_id: tripId });
                if (!trip) {
                    return NextResponse.json({ error: "Trip not found", status: 404 });
                }

                const existingDocIndex = trip.documents.findIndex((doc: any) => doc.type === data.docType);
                if (existingDocIndex !== -1) {
                    trip.documents[existingDocIndex] = commonDocFields;
                } else {
                    trip.documents.unshift(commonDocFields);
                }

                await Promise.all([trip.save(), recentActivity('Moved to Trip Document', trip, user)]);
                return NextResponse.json({ status: 200 });
            }

            case "truck": {
                const Truck = models.Truck || model("Truck", truckSchema);
                const { truckNo } = data;
                if (!truckNo) {
                    return NextResponse.json({ error: "Missing truckNo", status: 400 });
                }

                const truck = await Truck.findOne({ user_id: user, truckNo });
                if (!truck) {
                    return NextResponse.json({ error: "Truck not found", status: 404 });
                }

                const existingDocIndex = truck.documents.findIndex((doc: any) => doc.type === data.docType);
                if (existingDocIndex !== -1) {
                    truck.documents[existingDocIndex] = commonDocFields;
                } else {
                    truck.documents.unshift(commonDocFields);
                }

                await Promise.all([truck.save(), recentActivity('Moved to Lorry Document', truck, user)]);
                return NextResponse.json({ status: 200 });
            }

            case "driver": {
                const Driver = models.Driver || model("Driver", driverSchema);
                const { driverId } = data;
                if (!driverId) {
                    return NextResponse.json({ error: "Missing driverId", status: 400 });
                }

                const driver = await Driver.findOne({ user_id: user, driver_id: driverId });
                if (!driver) {
                    return NextResponse.json({ error: "Driver not found", status: 404 });
                }

                const existingDocIndex = driver.documents.findIndex((doc: any) => doc.type === data.docType);
                if (existingDocIndex !== -1) {
                    driver.documents[existingDocIndex] = commonDocFields;
                } else {
                    driver.documents.unshift(commonDocFields);
                }

                await Promise.all([driver.save(), recentActivity('Moved to Driver Document', driver, user)]);
                return NextResponse.json({ status: 200 });
            }

            case "company":
                return NextResponse.json({ error: "Company handling not implemented", status: 501 });

            default:
                return NextResponse.json({ error: "Invalid movingto value", status: 400 });
        }
    } catch (error) {
        console.error(error);
        return NextResponse.json({ error: "Internal Server Error", status: 500 });
    }
}
</file>

<file path="src/app/api/documents/extractExpenseRecipt/route.ts">
async function extractReciptDetails(text: string) {
    const prompt = `
    This is extracted text from pdf extract these details from it i.e amount, date, expenseType. Give all this in JSON format. Return Empty string for field if not found.

  
    Extracted Text:
    ${text}
  
    Response format :
    {
        amount : '',
        date : '',
        expenseType : '',
    }
  `;
  const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${process.env.GEMINI_API_KEY}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      "contents": [{
        "parts": [{
          "text": prompt
        }]
      }]
    })
  });
  const responseData = await res.json();
  let responseText = responseData.candidates[0].content.parts[0].text;

  // Remove extraneous characters (e.g., triple backticks, other non-JSON text)
  // console.log(responseText.split('```')[1].split('json')[1])
  // responseText = responseText.replace(/```json/g, '').replace(/```/g, '').trim();

  // Parse the cleaned string into a JSON object
  const jsonObject = JSON.parse(responseText.split('```')[1].split('json')[1]);
  return jsonObject
}

import { verifyToken } from "@/utils/auth";
import { NextResponse } from "next/server";

export async function POST(req:Request) {
    try {
        const {user, error} = await verifyToken(req)
        if(!user || error){
            return NextResponse.json({error : 'Unauthorized User', status : 401})
        }
        const text = await req.text()
        const reciptDetails = await extractReciptDetails(text)
        return NextResponse.json({success : true, reciptDetails, status : 200})
    } catch (error) {
        console.log(error)
        return NextResponse.json({error : 'Internal Server Error', status : 500})
    }
}
</file>

<file path="src/app/api/documents/recent/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, driverSchema, otherDocumentsSchema, tripSchema, truckSchema, userSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

// Initialize models if they don't exist
const Trip = models.Trip || model('Trip', tripSchema);
const Driver = models.Driver || model('Driver', driverSchema);
const Truck = models.Truck || model('Truck', truckSchema);
const User = models.User || model('User', userSchema);
const OtherDocuments = models.OtherDocuments || model('OtherDocuments', otherDocumentsSchema);

export async function GET(req: Request) {
    try {
        // Verify the user
        const { user, error } = await verifyToken(req);
        if (error || !user) {
            return NextResponse.json({ error: 'Unauthorized User', status: 401 });
        }

        // Connect to the database
        await connectToDatabase();

        // Use Promise.all for parallel queries
        const [tripResults, driverResults, truckResults, userResults, otherResults] = await Promise.all([
            Trip.aggregate([
                { $match: { user_id: user } },
                { $project: { documents: 1 } },
                { $unwind: { path: "$documents", preserveNullAndEmptyArrays: true } },
                { $sort: { "documents.uploadedDate": -1 } },
                { $limit: 5 }
            ]),
            Driver.aggregate([
                { $match: { user_id: user } },
                { $project: { documents: 1 } },
                { $unwind: { path: "$documents", preserveNullAndEmptyArrays: true } },
                { $sort: { "documents.uploadedDate": -1 } },
                { $limit: 5 }
            ]),
            Truck.aggregate([
                { $match: { user_id: user } },
                { $project: { documents: 1 } },
                { $unwind: { path: "$documents", preserveNullAndEmptyArrays: true } },
                { $sort: { "documents.uploadedDate": -1 } },
                { $limit: 5 }
            ]),
            User.aggregate([
                { $match: { user_id: user } },
                { $project: { documents: 1 } },
                { $unwind: { path: "$documents", preserveNullAndEmptyArrays: true } },
                { $sort: { "documents.uploadedDate": -1 } },
                { $limit: 5 }
            ]),
            OtherDocuments.aggregate([
                { $match: { user_id: user } },
                { $sort: { uploadedDate: -1 } },
                { $limit: 5 }
            ])
        ]);

        // Combine and get the latest 5 documents across all collections
        const allDocuments = [...tripResults, ...driverResults, ...truckResults, ...userResults, ...otherResults]
            .map(doc => doc.documents || doc) // Ensure consistent structure for "documents"
            .sort((a, b) => new Date(b.uploadedDate).getTime() - new Date(a.uploadedDate).getTime())
            .slice(0, 5);

        // Count documents for each collection
        const [tripDocumentsCount, driverDocumentsCount, truckDocumentsCount, userDocumentsCount, otherDocumentsCount] = await Promise.all([
            Trip.aggregate([
                { $match: { user_id: user } },
                { $project: { documents: { $ifNull: ["$documents", []] } } }, // Ensure documents field exists
                { $group: { _id: null, count: { $sum: { $size: "$documents" } } } } // Sum up the sizes of the documents array
            ]).then(res => res[0]?.count || 0),

            Driver.aggregate([
                { $match: { user_id: user } },
                { $project: { documents: { $ifNull: ["$documents", []] } } },
                { $group: { _id: null, count: { $sum: { $size: "$documents" } } } }
            ]).then(res => res[0]?.count || 0),

            Truck.aggregate([
                { $match: { user_id: user } },
                { $project: { documents: { $ifNull: ["$documents", []] } } },
                { $group: { _id: null, count: { $sum: { $size: "$documents" } } } }
            ]).then(res => res[0]?.count || 0),

            User.aggregate([
                { $match: { user_id: user } },
                { $project: { documents: { $ifNull: ["$documents", []] } } },
                { $group: { _id: null, count: { $sum: { $size: "$documents" } } } }
            ]).then(res => res[0]?.count || 0),

            OtherDocuments.aggregate([
                { $match: { user_id: user } },
                { $count: "count" } // Directly count documents matching the condition
            ]).then(res => res[0]?.count || 0)
        ]);


        // Return the latest 5 documents along with document counts
        return NextResponse.json({
            documents: allDocuments,
            counts: {
                tripDocuments: tripDocumentsCount,
                driverDocuments: driverDocumentsCount,
                truckDocuments: truckDocumentsCount,
                companyDocuments: userDocumentsCount,
                otherDocuments: otherDocumentsCount
            },
            status: 200
        });
    } catch (error) {
        console.error('Error fetching documents:', error);
        return NextResponse.json({ error: 'Internal Server Error', status: 500 });
    }
}
</file>

<file path="src/app/api/documents/reminders/route.ts">
import { verifyToken } from "@/utils/auth";
import { NextResponse } from "next/server";
import { models, model } from 'mongoose';
import { driverSchema, tripSchema, truckSchema } from "@/utils/schema";

// Abstract common logic for reminders
async function fetchReminders(
    modelName: string,
    schema: any,
    userId: string,
    projectionFields: Record<string, number>
) {
    const Model = models[modelName] || model(modelName, schema);

    const oneWeekAgo = new Date();
    const oneWeekFromNow = new Date();
    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7); // Past one week
    oneWeekFromNow.setDate(oneWeekFromNow.getDate() + 7); // Upcoming one week

    return Model.aggregate([
        { $match: { user_id: userId } },
        { $unwind: "$documents" },
        {
            $match: {
                "documents.validityDate": { $gte: oneWeekAgo, $lte: oneWeekFromNow }, // Expired or expiring
            }
        },
        {
            $project: {
                ...projectionFields,
                "documents.filename": 1,
                "documents.type": 1,
                "documents.validityDate": 1,
                "documents.uploadedDate": 1,
                "documents.url": 1,
            }
        }
    ]);
}

// Fetch trip reminders
const TripReminders = (userId: string) =>
    fetchReminders("Trip", tripSchema, userId, {
        trip_id: 1,
        LR: 1,
        truck: 1,
        startDate: 1,
    });

// Fetch truck reminders
const TruckReminders = (userId: string) =>
    fetchReminders("Truck", truckSchema, userId, {
        truckNo: 1,
    });

// Fetch driver reminders
const DriverReminders = (userId: string) =>
    fetchReminders("Driver", driverSchema, userId, {
        name: 1,
        contactNumber: 1,
    });

export async function GET(req: Request) {
    try {
        const { user, error } = await verifyToken(req);
        if (!user || error) {
            return NextResponse.json({ error: "Unauthorized user" }, { status: 401 });
        }

        // Parallel execution for efficiency
        const [tripReminders, truckReminders, driverReminders] = await Promise.all([
            TripReminders(user),
            TruckReminders(user),
            DriverReminders(user),
        ]);

        return NextResponse.json({
            tripReminders,
            truckReminders,
            driverReminders,
        });
    } catch (error) {
        console.error("Error fetching reminders:", error);
        return NextResponse.json(
            { error: "Failed to fetch reminders" },
            { status: 500 }
        );
    }
}
</file>

<file path="src/app/api/documents/route.ts">
import { uploadFileToS3 } from "@/helpers/fileOperation";
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, otherDocumentsSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";
import { v4 as uuidV4 } from 'uuid'

const OtherDocuments = models.OtherDocuments || model('OtherDocuments', otherDocumentsSchema);


export async function GET(req: Request) {
  try {
    // Verify user token
    const { user, error } = await verifyToken(req);

    if (!user || error) {
      throw new Error('Unauthorized user');
    }

    // Fetch documents for the user
    await connectToDatabase()
    const documents = await OtherDocuments.find({ user_id: user });
    return NextResponse.json({
      status: 200,
      documents,
    });
  } catch (error: any) {
    console.error('Error fetching documents:', error);

    // Handle unauthorized user
    if (error.message === 'Unauthorized user') {
      const response = NextResponse.json({
        status: 401,
        error: 'Unauthorized',
      });

      // Remove the auth_token cookie
      response.cookies.set('auth_token', '', { maxAge: 0 });
      return response;
    }

    // Handle internal server error
    return NextResponse.json({
      status: 500,
      error: 'Internal Server Error',
    });
  }
}

export async function POST(req: Request) {
  try {
    // Verify user token
    const { user, error } = await verifyToken(req);

    if (!user || error) {
      throw new Error('Unauthorized user');
    }
    await connectToDatabase()

    // Parse form data
    const formData = await req.formData();
    const filesData = JSON.parse(formData.get('filesData') as string);

    const uploadedDocuments = [];

    for (const fileData of filesData) {
      const file = formData.get(`file-${fileData.id}`) as File;

      if (!file) {
        throw new Error(`File not found for id: ${fileData.id}`);
      }

      // Prepare file for S3 upload
      const fileBuffer = Buffer.from(await file.arrayBuffer());
      const fileName = `users/${user}/${uuidV4()}`;
      const contentType = file.type;

      // Upload file to S3
      const s3FileName = await uploadFileToS3(fileBuffer, fileName, contentType);
      const fileUrl = `https://${process.env.AWS_S3_BUCKET_NAME}.s3.${process.env.AWS_S3_REGION}.amazonaws.com/${s3FileName}${contentType === 'application/pdf' ? '.pdf' : ''}`;

      // Create a new document record
      const newDocument = new OtherDocuments({
        user_id: user,
        filename: fileData.filename || file.name, // Use custom filename if provided
        url: fileUrl,
        uploadedDate: new Date(Date.now()),
        validityDate: fileData.validityDate || null,
      });

      await newDocument.save();
      uploadedDocuments.push(newDocument);
    }

    // Return the newly created documents
    return NextResponse.json({
      status: 200,
      message: `${uploadedDocuments.length} document(s) uploaded successfully`,
      documents: uploadedDocuments
    });
  } catch (error: any) {
    console.error('Error uploading document(s):', error);

    // Handle unauthorized user
    if (error.message === 'Unauthorized user') {
      return NextResponse.json({
        status: 401,
        error: 'Unauthorized',
      });
    }

    // Handle other errors
    return NextResponse.json({
      status: 500,
      error: 'Internal Server Error',
    });
  }
}
</file>

<file path="src/app/api/documents/validate/route.ts">
import { extractTextFromImage, extractTextFromPdf } from "@/helpers/fileOperation";
import { getDocType } from "@/helpers/ImageOperation";
import { verifyToken } from "@/utils/auth";
import { NextResponse } from "next/server";

// Helper function to determine document type based on text content
// Helper function to determine document type based on text content


const extractLatestDate = (text: string) => {
    // Regular expression to match dates in formats: dd/MM/yyyy, dd-MM-yyyy, dd-MMM-yyyy
    const dateRegex = /\b\d{2}[\/-]\w{3,}[\/-]\d{2,4}\b|\b\d{2}[\/-]\d{2}[\/-]\d{2,4}\b/g;

    let latestDate: Date | null = null;

    // Find all matches
    const matches = text.match(dateRegex);

    if (!matches) return null;

    matches.forEach(dateStr => {
        let parsedDate = null;

        try {
            // Handle date parsing based on format
            if (dateStr.includes('/')) {
                parsedDate = parseDate(dateStr, 'dd/MM/yyyy');
            } else if (dateStr.includes('-')) {
                if (dateStr.split('-')[1].length === 3) {
                    parsedDate = parseDate(dateStr, 'dd-MMM-yyyy');
                } else {
                    parsedDate = parseDate(dateStr, 'dd-MM-yyyy');
                }
            }

            // Update latestDate if parsedDate is more recent
            if (parsedDate && (!latestDate || parsedDate > latestDate)) {
                latestDate = parsedDate;
            }
        } catch (e) {
            console.error(`Error parsing date: ${dateStr}`, e);
        }
    });

    return latestDate ? latestDate : null;
};

// Helper function to parse date according to format
const parseDate = (dateStr: string, format: string) => {
    const parts = dateStr.split(/[\/-]/);
    let day, month, year;

    switch (format) {
        case 'dd/MM/yyyy':
        case 'dd-MM-yyyy':
            day = parseInt(parts[0], 10);
            month = parseInt(parts[1], 10) - 1; // Month is zero-indexed in JS Date
            year = parseInt(parts[2], 10);
            break;
        case 'dd-MMM-yyyy':
            day = parseInt(parts[0], 10);
            month = parseMonth(parts[1]); // Custom month parsing function for short month names
            year = parseInt(parts[2], 10);
            break;
        default:
            return null;
    }

    // Adjust for 2-digit years
    if (year < 100) {
        year += year < 50 ? 2000 : 1900;
    }

    return new Date(year, month, day);
};

// Helper function to parse month from "MMM" format (e.g., "Jan", "Feb")
const parseMonth = (monthStr: string) => {
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return months.indexOf(monthStr);
};


export async function POST(req: Request) {
    const { user, error } = await verifyToken(req);

    if (!user || error) {
        return NextResponse.json({ error: 'Unauthorized User', status: 401 });
    }

    try {
        const formData = await req.formData();
        const file = formData.get('file') as File;

        if (!file) {
            return NextResponse.json({ error: 'No file uploaded', status: 400 });
        }

        // Ensure `file` is treated as a Blob (for arrayBuffer to work)
        const fileBuffer = await file.arrayBuffer(); // Make sure this works correctly
        const fileType = file.type;

        let text: string;

        // Process the file based on the type
        if (fileType === 'application/pdf') {
            const pdfBuffer = Buffer.from(fileBuffer);
            text = await extractTextFromPdf(pdfBuffer);
        } else if (fileType.startsWith('image/')) {
            const imageBuffer = Buffer.from(fileBuffer);
            text = await extractTextFromImage(imageBuffer);
        } else {
            return NextResponse.json({ error: 'Unsupported file type', status: 400 });
        }

        // Determine the document type and extract validity
        const docType = getDocType(text);
        const validity = extractLatestDate(text);

        if(docType === 'Other' && !validity){
            return NextResponse.json({error : 'Failed to extract validity and type, Enter Manually', status : 402})
        }

        return NextResponse.json({ docType, validity, status: 200 });
    } catch (err) {
        console.error('Error processing file:', err);
        return NextResponse.json({ error: 'Internal Server Error', status: 500 });
    }
}
</file>

<file path="src/app/api/drivers/[driverId]/accounts/[accountId]/route.ts">
import { connectToDatabase, driverSchema } from "@/utils/schema";
import  {model, models } from "mongoose";

const Driver = models.Driver || model('Driver', driverSchema)

import { NextResponse } from 'next/server';
import { IDriver } from '@/utils/interface';
import { verifyToken } from "@/utils/auth";





export async function DELETE(req: Request,{ params }: { params: { driverId: string; accountId: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
    // const { driverId, accountId } = params;
    const url = req.url
    const url_arr = url?.split('/')
    const accountId = url_arr[7]
    const driverId = url_arr[5]  
    try {
      await connectToDatabase();
  
      // Find the driver document by driverId
      const driver = await Driver.findOne({ user_id: user, driver_id: driverId });
  
      if (!driver) {
        return NextResponse.json({ message: 'Driver not found' }, { status: 404 });
      }
  
      // Filter out the account with the specified accountId from the accounts array
      driver.accounts = driver.accounts.filter((account : any)  => account.account_id !== accountId);
  
      // Save the updated driver document
      await driver.save();
  
      return NextResponse.json({ driver }, { status: 200 });
    } catch (error) {
      console.error('Failed to delete account detail:', error);
      return NextResponse.json({ error: 'Failed to delete account detail' }, { status: 500 });
    }
  }


  
  export async function PATCH(req: Request, { params }: { params: { driverId: string; accountId: string } }) {
    const { user, error } = await verifyToken(req);
    if (error) {
      return NextResponse.json({ error });
    }
  
    const { driverId, accountId } = params;
    const data = await req.json();
    console.log(driverId)
    console.log(accountId)
  
    try {
      await connectToDatabase();
  
      // Find the driver document by driverId and user_id
      const driver = await Driver.findOne({ user_id: user, driver_id: driverId });
  
      if (!driver) {
        return NextResponse.json({ message: 'Driver not found' }, { status: 404 });
      }
  
      // Find the index of the account with the specified accountId
      const index = driver.accounts.findIndex((acc: any) => acc.account_id === accountId);
  
      if (index === -1) {
        return NextResponse.json({ message: 'Account not found' }, { status: 404 });
      }
  
      // Update the account with the new data
      console.log(driver.accounts[index])
      driver.accounts[index].reason = data.reason
      driver.accounts[index].gave = data.gave
      driver.accounts[index].got = data.got
      driver.accounts[index].date = data.date
  
      // Save the updated driver document
      await driver.save();
  
      return NextResponse.json({ driver }, { status: 200 });
    } catch (error) {
      console.error('Failed to update account detail:', error);
      return NextResponse.json({ error: 'Failed to update account detail' }, { status: 500 });
    }
  }
</file>

<file path="src/app/api/drivers/[driverId]/calculateBalance/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, driverSchema, ExpenseSchema, tripSchema } from "@/utils/schema";
import { models, model } from "mongoose";
import { NextResponse } from "next/server";

const Trip = models.Trip || model('Trip', tripSchema);
const Expense = models.Expense || model('Expense', ExpenseSchema);
const Driver = models.Driver || model('Driver', driverSchema);

export async function GET(req: Request, { params }: { params: { driverId: string } }) {
    try {
        const { user, error } = await verifyToken(req);
        if (!user || error) {
            return NextResponse.json({ error });
        }
        const { driverId } = params;
        await connectToDatabase();

        // Aggregate trips with accounts
        const accounts = await Trip.aggregate([
            { $match: { user_id: user, driver: driverId } },
            { $unwind: "$accounts" },
            { $sort: { "dates.0": -1 } },
            {
                $project: {
                    _id: 0,
                    account: "$accounts",
                    tripId: "$trip_id"
                }
            },
            { $replaceRoot: { newRoot: { $mergeObjects: ["$account", { tripId: "$tripId" }] } } },
            { $match: { receivedByDriver: true } } // Optional: filter accounts received by driver
        ]);

        // Sum the amounts from expenses
        const expenseSum = await Expense.aggregate([
            { $match: { user_id: user, driver: driverId } },
            { $group: { _id: null, totalExpense: { $sum: "$amount" } } }
        ]);

        // Find the driver and calculate driver accounts balance
        const driver = await Driver.findOne({ user_id: user, driver_id: driverId }).select('accounts')

        let totalExpense = expenseSum.length > 0 ? expenseSum[0].totalExpense : 0;

        let totalAccounts = accounts.reduce((sum, account) => sum + account.amount, 0);

        let totalDriverAccounts = driver.accounts.reduce((sum : any, account : any) => sum + account.got - account.gave, 0);

        const total = totalDriverAccounts + totalAccounts - totalExpense;

        return NextResponse.json({ total });

    } catch (error : any) {
        return NextResponse.json({ error: error.message, status: 500 });
    }
}
</file>

<file path="src/app/api/drivers/[driverId]/documents/route.ts">
import Trip from "@/components/search/Trip";
import { uploadFileToS3 } from "@/helpers/fileOperation";
import { recentActivity } from "@/helpers/recentActivity";
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, driverSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const Driver = models.Driver || model('Driver', driverSchema)

export async function GET(req: Request, { params }: { params: { driverId: string } }) {
    try {
        const { user, error } = await verifyToken(req)
        if (!user || error) {
            return NextResponse.json({ error })
        }
        const { driverId } = params
        await connectToDatabase()
        const driver = await Driver.findOne({ user_id: user, driver_id: driverId }).select(['driver_id', 'documents']).exec();
        return NextResponse.json({ status: 200, documents: driver.documents })
    } catch (error) {
        console.log(error)
        return NextResponse.json({ status: 500, error })
    }
}

export async function PUT(req: Request, { params }: { params: { driverId: string } }) {
    try {
        // Verify user token
        const { user, error } = await verifyToken(req);
        if (!user || error) {
            return NextResponse.json({ error: 'Unauthorized User', status: 401 });
        }

        const { driverId } = params;

        // Connect to the database
        await connectToDatabase();

        // Get form data
        const formdata = await req.formData();
        const file = formdata.get('file') as File;
        const docType = formdata.get('docType') as string;
        const validity = new Date(formdata.get('validityDate') as string);
        const filename = formdata.get('filename') as string;

        // Validate form data
        if (!file || !docType || !validity) {
            return NextResponse.json({ error: 'Missing required fields', status: 400 });
        }

        // Find the trip by user and tripId
        const driver = await Driver.findOne({ user_id: user, driver_id: driverId });
        if (!driver) {
            return NextResponse.json({ error: 'Driver not found', status: 404 });
        }

        // Prepare file for upload to S3
        const fileBuffer = Buffer.from(await file.arrayBuffer());
        const fileName = `drivers/${driverId}/${docType}`;
        const contentType = file.type;

        // Upload file to S3
        const s3FileName = await uploadFileToS3(fileBuffer, fileName, contentType);
        const fileUrl = `https://${process.env.AWS_S3_BUCKET_NAME}.s3.${process.env.AWS_S3_REGION}.amazonaws.com/${s3FileName}${contentType === 'application/pdf' ? '.pdf' : ''}`;

        // Check if the document type already exists in the documents array
        const existingDocIndex = driver.documents.findIndex((doc: any) => doc.type === docType);

        let document

        if (existingDocIndex !== -1) {
            // Replace the existing document with the new one
            driver.documents[existingDocIndex] = {
                filename: filename || '',
                type: docType,
                validityDate: validity,
                uploadedDate: new Date(Date.now()),
                url: fileUrl,
            };
            document = driver.documents[existingDocIndex]
        } else {
            // Add new document if not found
            driver.documents.unshift({
                filename: filename || '',
                type: docType,
                validityDate: validity,
                uploadedDate: new Date(),
                url: fileUrl,
            });
            document = driver.documents[0]
        }

        // Save the updated trip document
        await Promise.all([driver.save(), recentActivity('Added Driver Document', {
            driver_id: driver.driver_id,
            name: driver.name,
            filename: filename,
            type: docType,
            url: fileUrl
        }, user)]);

        // Return success response
        return NextResponse.json({ message: 'Document uploaded successfully', status: 200, document : document });

    } catch (error) {
        // Log the error and return server error response
        console.error("Error in uploading document:", error);
        return NextResponse.json({ error: 'Failed to upload document', status: 500 });
    }
}
</file>

<file path="src/app/api/drivers/[driverId]/name/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, driverSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const Driver = models.Driver || model('Driver', driverSchema)

export async function GET(req: Request, { params }: { params: { driverId: string } }) {
    const { user, error } = await verifyToken(req);
    if (error) {
      return NextResponse.json({ error });
    }
    const { driverId } = params;
  
    try {
      await connectToDatabase();
  
      const driver = await Driver.findOne({user_id : user, driver_id : driverId}).select('name');
  
      if (!driver) {
        return NextResponse.json({ message: 'Driver not found' }, { status: 404 });
      }
  
      return NextResponse.json(driver, { status: 200 });
    } catch (err: any) {
      console.log(err);
      return NextResponse.json({ message: 'Internal Server Error', error: err.message }, { status: 500 });
    }
  }
</file>

<file path="src/app/api/drivers/[driverId]/route.ts">
import { connectToDatabase, driverSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { v4 as uuidv4 } from 'uuid'

const Driver = models.Driver || model('Driver', driverSchema)

import { NextResponse } from 'next/server';
import { IDriver } from '@/utils/interface';
import { verifyToken } from "@/utils/auth";
import { recentActivity } from "@/helpers/recentActivity";


export async function GET(req: Request, { params }: { params: { driverId: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  const { driverId } = params;

  try {
    await connectToDatabase();

    // const driver: IDriver = await Driver.findOne({ user_id: user, driver_id: driverId }).exec();
    const drivers = await Driver.aggregate([
      {
        $match: { user_id: user, driver_id: driverId }
      },
      {
        $lookup: {
          from: 'expenses',
          localField: 'driver_id',
          foreignField: 'driver',
          as: 'driverExpenses'
        }
      },
      {
        $lookup: {
          from: 'trips',
          localField: 'driver_id',
          foreignField: 'driver',
          as: 'driverTrips'
        }
      },
      {
        $lookup: {
          from: 'partypayments',
          localField: 'driver_id',
          foreignField: 'driver_id',
          as: 'tripAccounts'
        }
      },
      {
        $lookup: {
          from: 'parties',
          localField: 'driverTrips.party', // The field linking driverTrips to parties
          foreignField: 'party_id', // The matching field in parties
          as: 'partyDetails'
        }
      },
      {
        // Add party name to each trip
        $addFields: {
          driverTrips: {
            $map: {
              input: '$driverTrips',
              as: 'trip',
              in: {
                $mergeObjects: [
                  {
                    route: '$$trip.route',
                    LR: '$$trip.LR',
                    party_id: '$$trip.party',
                    trip_id: '$$trip.trip_id',
                    truck: '$$trip.truck',
                    startDate: '$$trip.startDate',
                    status: '$$trip.status'
                  },
                  {
                    partyName: {
                      $arrayElemAt: [
                        {
                          $map: {
                            input: {
                              $filter: {
                                input: '$partyDetails',
                                as: 'party',
                                cond: { $eq: ['$$party.party_id', '$$trip.party'] } // Match party ID
                              }
                            },
                            as: 'party',
                            in: '$$party.name' // Extract only the name
                          }
                        },
                        0
                      ]
                    }
                  }
                ]
              }
            }
          }
        }
      },
      {
        $addFields: {
          // Combine driver expenses and trip accounts from partypayments
          driverExpAccounts: {
            $concatArrays: [
              {
                $filter: {
                  input: '$driverExpenses',
                  as: 'expense',
                  cond: { $ne: ['$$expense.driver', ''] } // Filter out empty driver references
                }
              },
              {
                $filter: {
                  input: '$tripAccounts',
                  as: 'payment',
                  cond: { $ne: ['$$payment.amount', null] } // Include non-null payments
                }
              },
              {
                $ifNull: ['$accounts', []]
              }
            ]
          }
        }
      },
      {
        // Sort driverExpAccounts by date
        $addFields: {
          driverExpAccounts: {
            $sortArray: {
              input: '$driverExpAccounts',
              sortBy: { date: -1 } // Sort by date descending
            }
          }
        }
      },
      {
        // Calculate total trip account amounts from partypayments
        $addFields: {
          totalTripAccounts: {
            $reduce: {
              input: '$tripAccounts',
              initialValue: 0,
              in: { $add: ['$$value', '$$this.amount'] }
            }
          },
          totalExpenses: {
            $reduce: {
              input: '$driverExpenses',
              initialValue: 0,
              in: { $add: ['$$value', '$$this.amount'] }
            }
          },
          driverAccountsBalance: {
            $reduce: {
              input: '$accounts',
              initialValue: 0,
              in: { $add: ['$$value', { $subtract: ['$$this.got', '$$this.gave'] }] }
            }
          }
        }
      },
      {
        // Calculate final balance: (Trip accounts + driver accounts - total expenses)
        $addFields: {
          balance: {
            $subtract: [
              { $add: ['$totalTripAccounts', '$driverAccountsBalance'] },
              '$totalExpenses'
            ]
          }
        }
      },
      {
        // Project specific fields and exclude partyDetails
        $project: {
          tripAccounts: 0,
          driverExpenses: 0,
          partyDetails: 0, // Exclude partyDetails
        }
      }
    ]);


    if (!drivers) {
      return NextResponse.json({ message: 'Driver not found' }, { status: 404 });
    }

    return NextResponse.json({ driver: drivers[0], status: 200 });
  } catch (err: any) {
    console.log(err);
    return NextResponse.json({ message: 'Internal Server Error', error: err.message }, { status: 500 });
  }
}

export async function PUT(req: Request, { params }: { params: { driverId: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  const { driverId } = params
  const data = await req.json()
  try {
    await connectToDatabase();
    const driver: IDriver = await Driver.findOne({ user_id: user, driver_id: driverId }).exec();
    driver.balance = driver.balance + data.got - data.gave
    driver.accounts.push({
      account_id: 'account' + uuidv4(),
      date: data.date,
      reason: data.reason,
      gave: data.gave,
      got: data.got
    })

    await Promise.all([driver.save(),recentActivity('Added Driver Payments', driver, user)])
    return NextResponse.json({ accounts: driver.accounts , status: 200 })
  } catch (err) {
    console.log(err)
  }
}

export async function DELETE(req: Request, { params }: { params: { driverId: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  const { driverId } = params;
  try {
    await connectToDatabase();
    const foundDriver = await Driver.findOne({ user_id: user, driver_id: driverId });
    if (foundDriver.status == 'On Trip') {
      return NextResponse.json({ message: 'Driver On Trip Cannot Delete' }, { status: 400 });
    }
    const driver = await Driver.findOneAndDelete({ driver_id: driverId });

    if (!driver) {
      return NextResponse.json({ message: 'Driver not found' }, { status: 404 });
    }
    return NextResponse.json({ message: 'Driver Deleted' }, { status: 200 });
  } catch (err: any) {
    return NextResponse.json({ message: err.message }, { status: 500 });
  }
}

export async function PATCH(req: Request, { params }: { params: { driverId: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  try {
    const { driverId } = params;
    const data = await req.json();

    console.log(data)

    await connectToDatabase(); // Ensure this function is properly defined and imported

    const driver = await Driver.findOneAndUpdate({ user_id: user, driver_id: driverId }, data, {new :true});

    if (!driver) {
      return NextResponse.json({ message: 'No Driver Found' }, { status: 404 });
    }

    await Promise.all([driver.save(), recentActivity('Updated Driver Detials', driver, user)]);

    return NextResponse.json({ driver: driver }, { status: 200 });
  } catch (err: any) {
    console.log(err)
    return NextResponse.json({ message: err.message }, { status: 500 });
  }
}
</file>

<file path="src/app/api/drivers/create/route.ts">
import { NextResponse } from 'next/server';
import mongoose, { model, models } from 'mongoose';
import { connectToDatabase, driverSchema } from '@/utils/schema';
import { IDriver } from '@/utils/interface';
import { verifyToken } from '@/utils/auth';


const Driver = models.Driver || model('Driver', driverSchema);



export async function GET(req : Request) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  try {
    await connectToDatabase()

    const drivers = await Driver.find({user_id : user}).select(['name', 'driver_id','status','contactNumber']).lean().exec();
    return NextResponse.json({ drivers });
  } catch (err) {
    console.error(err);
    return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/drivers/documents/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, driverSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const Driver = models.Driver || model('Driver', driverSchema);

export async function GET(req: Request) {
    try {
        // Verify user token
        const { user, error } = await verifyToken(req);
        if (!user || error) {
            return NextResponse.json({ error: 'Unauthorized User', status: 401 });
        }

        // Extract 'type' from query parameters
        const url = new URL(req.url);
        const documentType = url.searchParams.get('type');

        // Ensure 'type' is provided
        if (!documentType) {
            return NextResponse.json({ error: 'Document type is required', status: 400 });
        }

        // Connect to the database
        await connectToDatabase();

        // Use aggregation to filter documents directly in MongoDB
        const drivers = await Driver.aggregate([
            {
                $match: { user_id: user } // Match the user_id with the user
            },
            {
                $project: {
                    user_id: 1,
                    driver_id: 1,
                    name: 1,
                    contactNumber: 1,
                    documents: {
                        $filter: {
                            input: '$documents',
                            as: 'document',
                            cond: { $eq: ['$$document.type', documentType] }
                        }
                    }
                }
            },
            {
                $match: { 'documents.0': { $exists: true } } // Only return drivers with matching documents
            }
        ]);

        // Format the result to combine driver info with each document
        const formattedDocs = drivers.flatMap((driver: any) => 
            driver.documents.map((doc: any) => ({
                filename: doc.filename,
                type: doc.type,
                validityDate: doc.validityDate,
                uploadedDate: doc.uploadedDate,
                url: doc.url,
                user_id: driver.user_id,
                driver_id: driver.driver_id,
                name: driver.name,
                contactNumber: driver.contactNumber
            }))
        );

        // Return the formatted documents
        return NextResponse.json({documents : formattedDocs, status : 200});

    } catch (error) {
        console.error(error);
        return NextResponse.json({ error: 'Something went wrong', status: 500 });
    }
}
</file>

<file path="src/app/api/drivers/route.ts">
import { NextResponse } from 'next/server';
import { model, models } from 'mongoose';
import { connectToDatabase, driverSchema } from '@/utils/schema';
import { IDriver } from '@/utils/interface';
import { verifyToken } from '@/utils/auth';
import { v4 as uuidv4 } from 'uuid'
import { recentActivity } from '@/helpers/recentActivity';


const Driver = models.Driver || model('Driver', driverSchema);



export async function GET(req: Request) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  try {
    await connectToDatabase()

    const drivers = await Driver.aggregate([
      {
        $match: { user_id: user }  // Find drivers for the specific user
      },
      {
        $lookup: {
          from: 'trips',  // Lookup trips to aggregate accounts related to each driver
          let: { driverId: "$driver_id" },
          pipeline: [
            { $match: { $expr: { $eq: ["$driver", "$$driverId"] } } },  // Match trips by driverId
            { $unwind: "$accounts" },  // Unwind accounts array
            { $match: { "accounts.receivedByDriver": true } },  // Filter only accounts received by driver
            {
              $group: {
                _id: null,
                totalTripAccounts: { $sum: "$accounts.amount" }  // Sum of account amounts from trips where receivedByDriver is true
              }
            }
          ],
          as: 'tripAccounts'
        }
      },
      {
        $lookup: {
          from: 'expenses',  // Lookup expenses related to each driver
          let: { driverId: "$driver_id" },
          pipeline: [
            { $match: { $expr: { $eq: ["$driver", "$$driverId"] } } },  // Match expenses by driverId
            {
              $group: {
                _id: null,
                totalExpenses: { $sum: "$amount" }  // Sum of expense amounts
              }
            }
          ],
          as: 'driverExpenses'
        }
      },
      {
        $addFields: {
          totalTripAccounts: { $ifNull: [{ $arrayElemAt: ["$tripAccounts.totalTripAccounts", 0] }, 0] },  // Default to 0 if no trip accounts
          totalExpenses: { $ifNull: [{ $arrayElemAt: ["$driverExpenses.totalExpenses", 0] }, 0] },  // Default to 0 if no expenses
          driverAccountsBalance: {
            $reduce: {
              input: "$accounts",  // Driver's own accounts (got - gave)
              initialValue: 0,
              in: { $add: ["$$value", { $subtract: ["$$this.got", "$$this.gave"] }] }
            }
          }
        }
      },
      {
        $addFields: {
          balance: {
            $subtract: [
              { $add: ["$totalTripAccounts", "$driverAccountsBalance"] },  // Sum trip accounts and driver accounts
              "$totalExpenses"  // Subtract total expenses
            ]
          }
        }
      },
      {
        $project: {
          driver_id: 1,
          name: 1,  // Project necessary fields (e.g., driver name)
          balance: 1 ,
          status : 1,
          contactNumber : 1, // Include the calculated balance field
          licenseNo : 1,
          aadharNo : 1,
          lastJoiningDate : 1,
        }
      }
    ]);


    return NextResponse.json({ drivers });
  } catch (err) {
    console.error(err);
    return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 });
  }
}

export async function POST(req: Request) {

  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }

  try {
    await connectToDatabase()

    const data = await req.json();



    // Phone number validation (10 digits starting with 7, 8, or 9)
    const phoneRegex = /^[6789]\d{9}$/;
    if (data.contactNumber != '' && !phoneRegex.test(data.contactNumber)) {
      return NextResponse.json({ message: 'Invalid phone number' }, { status: 400 });
    }


    const newDriver: IDriver = new Driver({
      user_id: user,
      driver_id: 'driver' + uuidv4(),
      name: data.name,
      contactNumber: data.contactNumber,
      balance: data.balance,
      status: data.status
    });

    const [savedDriver,recent] = await Promise.all([ newDriver.save(),recentActivity('Added New Driver', newDriver, user)]);
    return NextResponse.json({ message: 'Saved Successfully', data: savedDriver, status: 200 });

  } catch (error: any) {
    console.error('Error saving Driver:', error);

    if (error.name === 'ValidationError') {
      return NextResponse.json({ message: 'Validation Error', details: error.message }, { status: 400 });
    } else if (error.name === 'MongoError' && error.code === 11000) {
      return NextResponse.json({ message: 'Duplicate Key Error', details: error.message }, { status: 409 });
    } else {
      return NextResponse.json({ message: 'Internal Server Error', details: error.message }, { status: 500 });
    }
  }
}
</file>

<file path="src/app/api/expenses/[expenseId]/route.ts">
import { uploadFileToS3 } from "@/helpers/fileOperation";
import { recentActivity } from "@/helpers/recentActivity";
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, ExpenseSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const Expense = models.Expense || model('Expense', ExpenseSchema)

export async function PUT(req: Request, { params }: { params: { expenseId: string } }) {
  // Connect to the database
  await connectToDatabase();
  const { expenseId } = params

  // Extract the tripId from the request params

  try {
    const { user, error } = await verifyToken(req);
    if (error) {
      return NextResponse.json({ error });
    }
    const formdata = await req.formData()
    const file = formdata.get('file') as File
    const expenseData = JSON.parse(formdata.get('expense') as string);
    await connectToDatabase()

    // Create a new instance of TripExpense with the parsed data and tripId
    const expense = await Expense.findByIdAndUpdate(expenseId, expenseData, { new: true })
    if (file) {
      const fileBuffer = Buffer.from(await file.arrayBuffer());
      const fileName = `expenses/${expense._id}`;
      const contentType = file.type;

      // Upload file to S3
      const s3FileName = await uploadFileToS3(fileBuffer, fileName, contentType);
      const fileUrl = `https://${process.env.AWS_S3_BUCKET_NAME}.s3.${process.env.AWS_S3_REGION}.amazonaws.com/${s3FileName}${contentType === 'application/pdf' ? '.pdf' : ''}`;
      expense.url = fileUrl;
    }
    await Promise.all([expense.save(), recentActivity('Edited Expense', expense, user)])
    // Return a success response with the new charge
    return NextResponse.json({ status: 200, expense });

  } catch (error) {
    // Handle any errors that occur during the process
    console.error("Error creating new trip expense:", error);
    return NextResponse.json({ status: 500, error: "Failed to edit expense" });
  }
}

export async function DELETE(req: Request, { params }: { params: { expenseId: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }

  const { expenseId } = params

  await connectToDatabase()
  try {
    const charge = await Expense.findByIdAndDelete(expenseId)
    if (!charge) {
      return NextResponse.json({ status: 404, message: "Charge Not Found" })
    }

    await recentActivity('Deleted Expense', charge, user)
    return NextResponse.json({ message: 'Deletion Success', status: 200, expense: charge })
  } catch (error) {
    console.log(error)
    return NextResponse.json({ message: error, status: 500 })
  }
}
</file>

<file path="src/app/api/expenses/calculate/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, ExpenseSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

// Define the Expense model
const Expense = models.Expense || model('Expense', ExpenseSchema);

export async function GET(req: Request) {
    try {
        const { user, error } = await verifyToken(req);
        if (error) {
            return NextResponse.json({ error }, { status: 401 }); // Unauthorized
        }

        await connectToDatabase()
        // Get the current date
        const currentDate = new Date();

        // Calculate the start and end dates of the financial year
        const currentYear = currentDate.getFullYear();
        const financialYearStart = new Date(currentDate.getMonth() >= 3 ? currentYear : currentYear - 1, 3, 1); // April 1st
        const financialYearEnd = new Date(currentDate.getMonth() >= 3 ? currentYear + 1 : currentYear, 2, 31, 23, 59, 59); // March 31st

        const expensesSummary = await Expense.aggregate([
            {
                $match: {
                    user_id: user, // Filter by user
                    date: { $gte: financialYearStart, $lte: financialYearEnd } // Filter by current financial year
                }
            },
            {
                $facet: {
                    tripExpense: [
                        {
                            $match: {
                                trip_id: { $exists: true, $ne: "" } // trip_id exists and is not empty
                            }
                        },
                        {
                            $group: {
                                _id: null,
                                totalAmount: { $sum: "$amount" }
                            }
                        },
                        {
                            $project: {
                                totalAmount: { $ifNull: ["$totalAmount", 0] } // Handle empty result
                            }
                        }
                    ],
                    truckExpense: [
                        {
                            $match: {
                                $and: [
                                    {
                                        $or: [
                                            { trip_id: { $exists: false } }, // trip_id does not exist
                                            { trip_id: { $eq: '' } }         // or trip_id is an empty string
                                        ]
                                    },
                                    { truck: { $exists: true, $ne: '' } } // truck exists and is not an empty string
                                ]
                            }
                        },
                        {
                            $group: {
                                _id: null,
                                totalAmount: { $sum: "$amount" }
                            }
                        },
                        {
                            $project: {
                                totalAmount: { $ifNull: ["$totalAmount", 0] } // Handle empty result
                            }
                        }
                    ],

                    officeExpense: [
                        {
                            $match: {
                                $and: [
                                    {
                                        $or: [
                                            { trip_id: { $exists: false } },
                                            { trip_id: { $eq: '' } }
                                        ]
                                    },
                                    {
                                        $or: [
                                            { truck: { $exists: false } },
                                            { truck: { $eq: '' } }
                                        ]
                                    }
                                ]
                            }
                        },
                        {
                            $group: {
                                _id: null,
                                totalAmount: { $sum: "$amount" }
                            }
                        },
                        {
                            $project: {
                                totalAmount: { $ifNull: ["$totalAmount", 0] } // Handle empty result
                            }
                        }
                    ]
                }
            }
        ]);

        // Process the result
        const expenses = {
            totalTruckExpense: expensesSummary[0].truckExpense[0]?.totalAmount || 0,
            totalTripExpense: expensesSummary[0].tripExpense[0]?.totalAmount || 0,
            totalOfficeExpense: expensesSummary[0].officeExpense[0]?.totalAmount || 0
        };




        return NextResponse.json({ expenses, status: 200 });
    } catch (err: any) {
        console.error('Error fetching expenses:', err);
        return NextResponse.json({ message: 'Internal Server Error', status: 500 });
    }
}
</file>

<file path="src/app/api/expenses/draft/[expenseId]/route.ts">
import { uploadFileToS3 } from "@/helpers/fileOperation";
import { recentActivity } from "@/helpers/recentActivity";
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, draftExpenseSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const DraftExpense = models.DraftExpense || model('DraftExpense', draftExpenseSchema);

export async function DELETE(req: Request, { params }: { params: { expenseId: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }

  const { expenseId } = params

  await connectToDatabase()
  try {
    const charge = await DraftExpense.findByIdAndDelete(expenseId)
    if (!charge) {
      return NextResponse.json({ status: 404, message: "Charge Not Found" })
    }
    return NextResponse.json({ message: 'Deletion Success', status: 200, expense: charge })
  } catch (error) {
    console.log(error)
    return NextResponse.json({ message: error, status: 500 })
  }
}

export async function PUT(req: Request, { params }: { params: { expenseId: string } }) {
  // Connect to the database
  await connectToDatabase();
  const { expenseId } = params

  // Extract the tripId from the request params

  try {
    const { user, error } = await verifyToken(req);
    if (error) {
      return NextResponse.json({ error });
    }
    const formdata = await req.formData()
    const file = formdata.get('file') as File
    const expenseData = JSON.parse(formdata.get('expense') as string);
    await connectToDatabase()

    // Create a new instance of TripExpense with the parsed data and tripId
    const charge = await DraftExpense.findByIdAndUpdate(expenseId, expenseData, { new: true })
    if (file) {
      const fileBuffer = Buffer.from(await file.arrayBuffer());
      const fileName = `expenses/${charge._id}`;
      const contentType = file.type;

      // Upload file to S3
      const s3FileName = await uploadFileToS3(fileBuffer, fileName, contentType);
      const fileUrl = `https://${process.env.AWS_S3_BUCKET_NAME}.s3.${process.env.AWS_S3_REGION}.amazonaws.com/${s3FileName}${contentType === 'application/pdf' ? '.pdf' : ''}`;
      charge.url = fileUrl;
    }
    await Promise.all([charge.save(), recentActivity('Edited Draft Expense', charge, user)])
    console.log(charge)
    // Return a success response with the new charge
    return NextResponse.json({ status: 200, expense: charge });

  } catch (error) {
    // Handle any errors that occur during the process
    console.error("Error creating new trip expense:", error);
    return NextResponse.json({ status: 500, error: "Failed to edit expense" });
  }
}
</file>

<file path="src/app/api/expenses/draft/route.ts">
import { uploadFileToS3 } from "@/helpers/fileOperation";
import { recentActivity } from "@/helpers/recentActivity";
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, draftExpenseSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const DraftExpense = models.DraftExpense || model('DraftExpense', draftExpenseSchema)

export async function GET(req: Request) {
    try {
        const { user, error } = await verifyToken(req);
        if (error) {
            return NextResponse.json({ error });
        }

        await connectToDatabase();
        const expenses = await DraftExpense.aggregate([
            {
                $match: { user_id: user }
            },
            {
                // Lookup trips details
                $lookup: {
                    from: 'trips',
                    localField: 'trip_id',
                    foreignField: 'trip_id',
                    as: 'trips'
                }
            },
            {
                // Lookup drivers details if driver_id exists
                $lookup: {
                    from: 'drivers',
                    let: { driver_id: '$driver' },
                    pipeline: [
                        {
                            $match: {
                                $expr: {
                                    $eq: ['$driver_id', '$$driver_id'] // Match only if driver_id exists
                                }
                            }
                        }
                    ],
                    as: 'drivers'
                }
            },
            {
                // Lookup shops details if shop_id exists
                $lookup: {
                    from: 'shopkhatas',
                    let: { shop_id: '$shop_id' },
                    pipeline: [
                        {
                            $match: {
                                $expr: {
                                    $eq: ['$shop_id', '$$shop_id'] // Match only if shop_id exists
                                }
                            }
                        }
                    ],
                    as: 'shops'
                }
            },
            {
                // Add fields for results and handle cases where lookups return empty arrays
                $addFields: {
                    tripRoute: { $arrayElemAt: ['$trips.route', 0] }, // Access route from trips if it exists
                    driverName: { $ifNull: [{ $arrayElemAt: ['$drivers.name', 0] }, 'N/A'] }, // Provide 'N/A' if no driver
                    shopName: { $ifNull: [{ $arrayElemAt: ['$shops.name', 0] }, 'N/A'] } // Provide 'N/A' if no shop
                }
            },
            {
                $project: {
                    shops: 0,
                    drivers: 0,
                    trips: 0
                }
            },
            {
                $sort: { date: -1 }
            }
        ]);
        return NextResponse.json({ expenses, status: 200 });
    } catch (error) {
        console.log(error)
        return NextResponse.json({ error, status: 500 })
    }
}

export async function POST(req: Request) {

    try {
        const { user, error } = await verifyToken(req)
        if (!user || error) {
            return NextResponse.json({ error: "Unauthorized User", status: 401 })
        }
        const formdata = await req.formData()
        const file = formdata.get('file') as File

        const expenseData = JSON.parse(formdata.get('expense') as string);
        await connectToDatabase()
        const newExpense = new DraftExpense({
            user_id: user,
            ...expenseData
        })
        if (file) {
            const fileBuffer = Buffer.from(await file.arrayBuffer());
            const fileName = `expenses/${newExpense._id}`;
            const contentType = file.type;

            // Upload file to S3
            const s3FileName = await uploadFileToS3(fileBuffer, fileName, contentType);
            const fileUrl = `https://${process.env.AWS_S3_BUCKET_NAME}.s3.${process.env.AWS_S3_REGION}.amazonaws.com/${s3FileName}${contentType === 'application/pdf' ? '.pdf' : ''}`;
            newExpense.url = fileUrl;
        }


        await Promise.all([newExpense.save(), recentActivity('Added Draft Expense', newExpense, user)])
        return NextResponse.json({ expense: newExpense, status: 200 })

    } catch (error: any) {
        console.log(error)
        return NextResponse.json({ error: "Internal Server Error", status: 500 })
    }
}
</file>

<file path="src/app/api/expenses/expenseType/route.ts">
import { verifyToken } from "@/utils/auth";
import { userExpenseTypesSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const UserExpenseType = models.UserExpenseType || model("UserExpenseType", userExpenseTypesSchema)

export async function GET(req : Request){
    try {
        const {user, error} = await verifyToken(req)
        if (!user|| error){
            return NextResponse.json({error : 'Unauthorized User', status : 401})
        }
        const userdata = await UserExpenseType.findOne({user_id : user})
        return NextResponse.json({expenseTypes : userdata.expenseTypes, status : 200}, {status : 200})
    } catch (error) {
        console.log(error)
        return NextResponse.json({error : 'Internal Server Error', status : 500})
    }
}

export async function POST(req : Request){
    try {
        const {user, error} = await verifyToken(req)
        if (!user|| error){
            return NextResponse.json({error : 'Unauthorized User', status : 401})
        }
        const data = await req.json()
        let userdata = await UserExpenseType.findOne({user_id : user})
        if(!userdata){
            userdata = await new UserExpenseType({user_id : user, expenseTypes : [data.expenseType]})
        }else{
            userdata.expenseTypes.unshift(data.expenseType)
        }
        
        await userdata.save()
        return NextResponse.json({expenseTypes : userdata.expenseTypes, status : 200}, {status : 200})
    } catch (error) {
        console.log(error)
        return NextResponse.json({error : 'Internal Server Error', status : 500})
    }
}
</file>

<file path="src/app/api/expenses/officeExpense/calculate/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, ExpenseSchema, OfficeExpenseSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

// Define the Expense model
const OfficeExpense = models.OfficeExpense || model('OfficeExpense', OfficeExpenseSchema);

export async function GET(req: Request) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error }, { status: 401 }); // Unauthorized
  }

  const url = new URL(req.url);
  const month = url.searchParams.get('month');
  const year = url.searchParams.get('year');
  
  if (!month || !year) {
    await connectToDatabase();
    const expenses = await OfficeExpense.find({ user_id: user }).lean();
    
    // Calculate the total expense
    const totalExpense = expenses.reduce((sum, expense) => sum + (expense.amount || 0), 0);
    
    return NextResponse.json({ expenses, totalExpense, status: 200 });
  }

  // Map of month names to month numbers (0-indexed)
  const monthMap: { [key: string]: number } = {
    January: 0,
    February: 1,
    March: 2,
    April: 3,
    May: 4,
    June: 5,
    July: 6,
    August: 7,
    September: 8,
    October: 9,
    November: 10,
    December: 11
  };

  const monthNumber = monthMap[month];
  if (monthNumber === undefined) {
    return NextResponse.json({ error: 'Invalid month name', status: 400 });
  }

  const startDate = new Date(Number(year), monthNumber, 1);
  const endDate = new Date(Number(year), monthNumber + 1, 1); // Next month's start date

  try {
    await connectToDatabase();
    const expenses = await OfficeExpense.find({
      user_id: user,
      date: {
        $gte: startDate,
        $lt: endDate,
      }
    }).lean();

    // Calculate the total expense
    const totalExpense = expenses.reduce((sum, expense) => sum + (expense.amount || 0), 0);

    return NextResponse.json({totalExpense, status: 200 });
  } catch (err: any) {
    console.error('Error fetching expenses:', err);
    return NextResponse.json({ message: 'Internal Server Error', status: 500 });
  }
}
</file>

<file path="src/app/api/expenses/officeExpense/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, ExpenseSchema, OfficeExpenseSchema } from "@/utils/schema";
import { monthMap } from "@/utils/utilArray";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const Expense = models.Expense || model('Expense', ExpenseSchema)

export async function GET(req: Request) {
  try {
    const { user, error } = await verifyToken(req);
    if (error) {
      return NextResponse.json({ error });
    }

    const url = new URL(req.url);
    const filter = JSON.parse(url.searchParams.get('filter') as string);

    let query: any = { user_id: user };

    // Handle the month-year array in filter?
    if (filter && filter.monthYear && filter.monthYear.length > 0) {
      const dateConditions = filter.monthYear.map((monYear: string) => {
        const [month, year] = monYear.split(' ');
        const monthNumber = monthMap[month];
        const startDate = new Date(parseInt(year), monthNumber, 1);
        const endDate = new Date(parseInt(year), monthNumber + 1, 1);

        return {
          date: {
            $gte: startDate,
            $lt: endDate
          }
        };
      });

      console.log(dateConditions)

      query.$and = query.$and || [];
      query.$and.push({ $or: dateConditions });
    }

    // Add additional filters (drivers, trucks, etc.) if they exist


    if (filter?.paymentModes && filter.paymentModes.length > 0) {
      query.$and = query.$and || [];
      query.$and.push({ paymentMode: { $in: filter.paymentModes } });
    }

    if (filter?.shops && filter.shops.length > 0) {
      query.$and = query.$and || [];
      query.$and.push({ shop_id: { $in: filter.shops } });
    }

    if (filter?.expenseTypes && filter.expenseTypes.length > 0) {
      query.$and = query.$and || [];
      query.$and.push({ expenseType: { $in: filter.expenseTypes } });
    }

    query.$and = query.$and || [];
    query.$and.push({
      $and: [
        {
          $or: [
            { trip_id: { $exists: false } },
            { trip_id: { $eq: '' } }
          ]
        },
        {
          $or: [
            { truck: { $exists: false } },
            { truck: { $eq: '' } }
          ]
        }
      ]

    });

    await connectToDatabase();
    const expenses = await Expense.aggregate([
      {
        $match: query
      },
      {
        // Lookup shops details if shop_id exists
        $lookup: {
          from: 'shopkhatas',
          let: { shop_id: '$shop_id' },
          pipeline: [
            {
              $match: {
                $expr: {
                  $eq: ['$shop_id', '$$shop_id'] // Match only if shop_id exists
                }
              }
            }
          ],
          as: 'shops'
        }
      },
      {
        // Add fields for results and handle cases where lookups return empty arrays
        $addFields: {
          shopName: { $ifNull: [{ $arrayElemAt: ['$shops.name', 0] }, 'N/A'] } // Provide 'N/A' if no shop
        }
      },
      {
        $project: {
          shops: 0,
        }
      }
    ]).sort({date : -1});

    return NextResponse.json({ expenses: expenses, status: 200 });
  } catch (err: any) {
    console.log(err);
    return NextResponse.json({ message: err.message, status: 500 });
  }
}

export async function POST(req: Request) {
  try {
    const { user, error } = await verifyToken(req)
    if (!user || error) {
      return NextResponse.json({ error })
    }
    await connectToDatabase()
    const data = await req.json()
    const expense = new Expense({ ...data, user_id: user })
    await expense.save()
    return NextResponse.json({ expense, status: 200 })
  } catch (error: any) {
    console.error(error)
    return NextResponse.json({ status: 500, error })
  }
}
</file>

<file path="src/app/api/expenses/route.ts">
import { uploadFileToS3 } from "@/helpers/fileOperation";
import { recentActivity } from "@/helpers/recentActivity";
import { verifyToken } from "@/utils/auth";
import { IExpense } from "@/utils/interface";
import { connectToDatabase, ExpenseSchema, RecentActivitiesSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const Expense = models.Expense || model('Expense', ExpenseSchema);
const monthMap: { [key: string]: number } = {
    January: 0,
    February: 1,
    March: 2,
    April: 3,
    May: 4,
    June: 5,
    July: 6,
    August: 7,
    September: 8,
    October: 9,
    November: 10,
    December: 11
};

export async function GET(req: Request) {
    try {
        const { user, error } = await verifyToken(req);
        if (error) {
            return NextResponse.json({ error });
        }

        const url = new URL(req.url);
        const filter = JSON.parse(url.searchParams.get('filter') as string);

        let query: any = { user_id: user };

        // Handle the month-year array in filter?
        if (filter && filter.monthYear && filter.monthYear.length > 0) {
            const dateConditions = filter.monthYear.map((monYear: string) => {
                const [month, year] = monYear.split(' ');
                const monthNumber = monthMap[month];
                const startDate = new Date(parseInt(year), monthNumber, 1);
                const endDate = new Date(parseInt(year), monthNumber + 1, 1);

                return {
                    date: {
                        $gte: startDate,
                        $lt: endDate
                    }
                };
            });


            query.$and = query.$and || [];
            query.$and.push({ $or: dateConditions });
        }

        // Add additional filters (drivers, trucks, etc.) if they exist
        if (filter?.drivers && filter.drivers.length > 0) {
            query.$and = query.$and || [];
            query.$and.push({ driver: { $in: filter.drivers } });
        }

        if (filter?.trucks && filter.trucks.length > 0) {
            query.$and = query.$and || [];
            query.$and.push({ truck: { $in: filter.trucks } });
        }

        if (filter?.paymentModes && filter.paymentModes.length > 0) {
            query.$and = query.$and || [];
            query.$and.push({ paymentMode: { $in: filter.paymentModes } });
        }

        if (filter?.shops && filter.shops.length > 0) {
            query.$and = query.$and || [];
            query.$and.push({ shop_id: { $in: filter.shops } });
        }

        if (filter?.expenseTypes && filter.expenseTypes.length > 0) {
            query.$and = query.$and || [];
            query.$and.push({ expenseType: { $in: filter.expenseTypes } });
        }



        await connectToDatabase();
        const expenses = await Expense.aggregate([
            {
                $match: query
            },
            {
                // Lookup trips details
                $lookup: {
                    from: 'trips',
                    localField: 'trip_id',
                    foreignField: 'trip_id',
                    as: 'trips'
                }
            },
            {
                // Lookup drivers details if driver_id exists
                $lookup: {
                    from: 'drivers',
                    let: { driver_id: '$driver' },
                    pipeline: [
                        {
                            $match: {
                                $expr: {
                                    $eq: ['$driver_id', '$$driver_id'] // Match only if driver_id exists
                                }
                            }
                        }
                    ],
                    as: 'drivers'
                }
            },
            {
                // Lookup shops details if shop_id exists
                $lookup: {
                    from: 'shopkhatas',
                    let: { shop_id: '$shop_id' },
                    pipeline: [
                        {
                            $match: {
                                $expr: {
                                    $eq: ['$shop_id', '$$shop_id'] // Match only if shop_id exists
                                }
                            }
                        }
                    ],
                    as: 'shops'
                }
            },
            {
                // Add fields for results and handle cases where lookups return empty arrays
                $addFields: {
                    tripRoute: { $arrayElemAt: ['$trips.route', 0] }, // Access route from trips if it exists
                    driverName: { $ifNull: [{ $arrayElemAt: ['$drivers.name', 0] }, 'N/A'] }, // Provide 'N/A' if no driver
                    shopName: { $ifNull: [{ $arrayElemAt: ['$shops.name', 0] }, 'N/A'] } // Provide 'N/A' if no shop
                }
            },
            {
                $project: {
                    shops: 0,
                    drivers: 0,
                    trips: 0
                }
            },
            {
                $sort: { date: -1 }
            }
        ]);
        return NextResponse.json({ expenses, status: 200 });
    } catch (error) {
        console.log(error)
        return NextResponse.json({ error, status: 500 })
    }

}

export async function POST(req: Request) {
    
    try {
        const { user, error } = await verifyToken(req)
        if (!user || error) {
            return NextResponse.json({ error: "Unauthorized User", status: 401 })
        }
        const formdata = await req.formData()
        const file = formdata.get('file') as File

        const expenseData = JSON.parse(formdata.get('expense') as string);
        console.log(expenseData)
        await connectToDatabase()
        const newExpense = new Expense({
            user_id: user,
            ...expenseData
        })
        if (file) {
            const fileBuffer = Buffer.from(await file.arrayBuffer());
            const fileName = `expenses/${newExpense._id}`;
            const contentType = file.type;

            // Upload file to S3
            const s3FileName = await uploadFileToS3(fileBuffer, fileName, contentType);
            const fileUrl = `https://${process.env.AWS_S3_BUCKET_NAME}.s3.${process.env.AWS_S3_REGION}.amazonaws.com/${s3FileName}${contentType === 'application/pdf' ? '.pdf' : ''}`;
            newExpense.url = fileUrl;
        }

        
        await Promise.all([newExpense.save(),recentActivity('Added New Expense', newExpense, user)])
        return NextResponse.json({ expense: newExpense, status: 200 })

    } catch (error: any) {
        console.log(error)
        return NextResponse.json({ error: "Internal Server Error", status: 500 })
    }
}
</file>

<file path="src/app/api/expenses/tripExpense/calculate/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, tripChargesSchema, ExpenseSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const TripCharges = models.TripCharges || model('TripCharges', tripChargesSchema);
const Expense = models.Expense || model('Expense', ExpenseSchema);

export async function GET(req: Request) {
    const { user, error } = await verifyToken(req);
    if (error) {
        return NextResponse.json({ error }, { status: 401 }); // Unauthorized
    }

    const url = new URL(req.url);
    const month = url.searchParams.get('month');
    const year = url.searchParams.get('year');

    await connectToDatabase();

    if (!month || !year) {
        const tripExpense = await Expense.find({ user_id: user }).lean();
        // Calculate total expense
        const totalExpense = tripExpense.reduce((sum, expense) => sum + (expense.amount || 0), 0);
        return NextResponse.json({ tripExpense, totalExpense, status: 200 });
    }

    const monthMap: { [key: string]: number } = {
        January: 0,
        February: 1,
        March: 2,
        April: 3,
        May: 4,
        June: 5,
        July: 6,
        August: 7,
        September: 8,
        October: 9,
        November: 10,
        December: 11
    };

    const monthNumber = monthMap[month];
    if (monthNumber === undefined) {
        return NextResponse.json({ error: 'Invalid month name', status: 400 });
    }

    const startDate = new Date(parseInt(year), monthNumber, 1);
    const endDate = new Date(parseInt(year), monthNumber + 1, 1);

    try {
        const [tripExpense, truckExpense] = await Promise.all([
            TripCharges.find({
                user_id: user,
                date: {
                    $gte: startDate,
                    $lt: endDate
                },
                partyBill: false
            }).lean(),
            Expense.find({
                user_id: user,
                date: {
                    $gte: startDate,
                    $lt: endDate
                },
                trip_id: { $exists: true, $ne: '' }
            }).lean()
        ]);

        // Combine expenses and calculate the total
        const combinedExpenses = [...tripExpense, ...truckExpense];
        const totalExpense = combinedExpenses.reduce((sum, expense) => sum + (expense.amount || 0), 0);

        return NextResponse.json({ totalExpense, status: 200 });
    } catch (err: any) {
        console.error('Error fetching expenses:', err);
        return NextResponse.json({ message: 'Internal Server Error', status: 500 });
    }
}
</file>

<file path="src/app/api/expenses/tripExpense/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, tripChargesSchema, ExpenseSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const Expense = models.Expense || model('Expense', ExpenseSchema);
const monthMap: { [key: string]: number } = {
    January: 0,
    February: 1,
    March: 2,
    April: 3,
    May: 4,
    June: 5,
    July: 6,
    August: 7,
    September: 8,
    October: 9,
    November: 10,
    December: 11
  };

export async function GET(req: Request) {
    try {
        const { user, error } = await verifyToken(req);
        if (error) {
            return NextResponse.json({ error });
        }

        const url = new URL(req.url);
        const filter = JSON.parse(url.searchParams.get('filter') as string);

        let query: any = { user_id: user };

        // Handle the month-year array in filter?
        if (filter && filter.monthYear && filter.monthYear.length > 0) {
            const dateConditions = filter.monthYear.map((monYear: string) => {
                const [month, year] = monYear.split(' ');
                const monthNumber = monthMap[month];
                const startDate = new Date(parseInt(year), monthNumber, 1);
                const endDate = new Date(parseInt(year), monthNumber + 1, 1);

                return {
                    date: {
                        $gte: startDate,
                        $lt: endDate
                    }
                };
            });


            query.$and = query.$and || [];
            query.$and.push({ $or: dateConditions });
        }

        // Add additional filters (drivers, trucks, etc.) if they exist
        if (filter?.drivers && filter.drivers.length > 0) {
            query.$and = query.$and || [];
            query.$and.push({ driver: { $in: filter.drivers } });
        }

        if (filter?.trucks && filter.trucks.length > 0) {
            query.$and = query.$and || [];
            query.$and.push({ truck: { $in: filter.trucks } });
        }

        if (filter?.paymentModes && filter.paymentModes.length > 0) {
            query.$and = query.$and || [];
            query.$and.push({ paymentMode: { $in: filter.paymentModes } });
        }

        if (filter?.shops && filter.shops.length > 0) {
            query.$and = query.$and || [];
            query.$and.push({ shop_id: { $in: filter.shops } });
        }

        if (filter?.expenseTypes && filter.expenseTypes.length > 0) {
            query.$and = query.$and || [];
            query.$and.push({ expenseType: { $in: filter.expenseTypes } });
        }

        query.$and = query.$and || [];
        query.$and.push({
            $and: [
                { trip_id: { $exists: true } },
                { trip_id: { $ne: '' } }
            ]
        });

        await connectToDatabase();
        const tripExpense = await Expense.aggregate([
            {
                $match: query
            },
            {
                // Lookup trips details
                $lookup: {
                    from: 'trips',
                    localField: 'trip_id',
                    foreignField: 'trip_id',
                    as: 'trips'
                }
            },
            {
                // Lookup drivers details if driver_id exists
                $lookup: {
                    from: 'drivers',
                    let: { driver_id: '$driver' },
                    pipeline: [
                        {
                            $match: {
                                $expr: {
                                    $eq: ['$driver_id', '$$driver_id'] // Match only if driver_id exists
                                }
                            }
                        }
                    ],
                    as: 'drivers'
                }
            },
            {
                // Lookup shops details if shop_id exists
                $lookup: {
                    from: 'shopkhatas',
                    let: { shop_id: '$shop_id' },
                    pipeline: [
                        {
                            $match: {
                                $expr: {
                                    $eq: ['$shop_id', '$$shop_id'] // Match only if shop_id exists
                                }
                            }
                        }
                    ],
                    as: 'shops'
                }
            },
            {
                // Add fields for results and handle cases where lookups return empty arrays
                $addFields: {
                    tripRoute: { $arrayElemAt: ['$trips.route', 0] }, // Access route from trips if it exists
                    driverName: { $ifNull: [{ $arrayElemAt: ['$drivers.name', 0] }, 'N/A'] }, // Provide 'N/A' if no driver
                    shopName: { $ifNull: [{ $arrayElemAt: ['$shops.name', 0] }, 'N/A'] } // Provide 'N/A' if no shop
                }
            },
            {
                $project: {
                    shops: 0,
                    drivers: 0,
                    trips: 0
                }
            },
            {
                $sort : { date : -1}
              }
        ]);
        return NextResponse.json({ tripExpense, status: 200 });
    } catch (error) {
        console.log(error)
        return NextResponse.json({ error, status: 500 })
    }

}
</file>

<file path="src/app/api/expenses/truckExpense/calculate/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, ExpenseSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

// Define the Expense model
const Expense = models.Expense || model('Expense', ExpenseSchema);

export async function GET(req: Request) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error }, { status: 401 }); // Unauthorized
  }

  const url = new URL(req.url);
  const month = url.searchParams.get('month');
  const year = url.searchParams.get('year');

  if (!month || !year) {
    await connectToDatabase();
    const expenses = await Expense.find({
      user_id: user, $or: [
        { trip_id: { $exists: false } },
        { trip_id: { $eq: '' } }
      ]
    }).lean();

    // Calculate the total expense
    const totalExpense = expenses.reduce((sum, expense) => sum + (expense.amount || 0), 0);

    return NextResponse.json({ expenses, totalExpense, status: 200 });
  }

  // Map of month names to month numbers (0-indexed)
  const monthMap: { [key: string]: number } = {
    January: 0,
    February: 1,
    March: 2,
    April: 3,
    May: 4,
    June: 5,
    July: 6,
    August: 7,
    September: 8,
    October: 9,
    November: 10,
    December: 11
  };

  const monthNumber = monthMap[month];
  if (monthNumber === undefined) {
    return NextResponse.json({ error: 'Invalid month name', status: 400 });
  }

  const startDate = new Date(Number(year), monthNumber, 1);
  const endDate = new Date(Number(year), monthNumber + 1, 1); // Next month's start date

  try {
    await connectToDatabase();
    const expenses = await Expense.find({
      user_id: user,
      date: {
        $gte: startDate,
        $lt: endDate,
      },
      $or: [
        { trip_id: { $exists: false } },
        { trip_id: { $eq: '' } }
      ]
    }).lean();

    // Calculate the total expense
    const totalExpense = expenses.reduce((sum, expense) => sum + (expense.amount || 0), 0);

    return NextResponse.json({ totalExpense, status: 200 });
  } catch (err: any) {
    console.error('Error fetching expenses:', err);
    return NextResponse.json({ message: 'Internal Server Error', status: 500 });
  }
}
</file>

<file path="src/app/api/expenses/truckExpense/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, ExpenseSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const Expense = models.Expense || model('Expense', ExpenseSchema)

const monthMap: { [key: string]: number } = {
  January: 0,
  February: 1,
  March: 2,
  April: 3,
  May: 4,
  June: 5,
  July: 6,
  August: 7,
  September: 8,
  October: 9,
  November: 10,
  December: 11
};

export async function GET(req: Request) {
  try {
    const { user, error } = await verifyToken(req);
    if (error) {
      return NextResponse.json({ error });
    }

    const url = new URL(req.url);
    const filter = JSON.parse(url.searchParams.get('filter') as string);

    let query: any = { user_id: user };

    // Handle the month-year array in filter?
    if (filter && filter.monthYear && filter.monthYear.length > 0) {
      const dateConditions = filter.monthYear.map((monYear: string) => {
        const [month, year] = monYear.split(' ');
        const monthNumber = monthMap[month];
        const startDate = new Date(parseInt(year), monthNumber, 1);
        const endDate = new Date(parseInt(year), monthNumber + 1, 1);

        return {
          date: {
            $gte: startDate,
            $lt: endDate
          }
        };
      });

      console.log(dateConditions)

      query.$and = query.$and || [];
      query.$and.push({ $or: dateConditions });
    }

    // Add additional filters (drivers, trucks, etc.) if they exist
    if (filter?.drivers && filter.drivers.length > 0) {
      query.$and = query.$and || [];
      query.$and.push({ driver: { $in: filter.drivers } });
    }

    if (filter?.trucks && filter.trucks.length > 0) {
      query.$and = query.$and || [];
      query.$and.push({ truck: { $in: filter.trucks } });
    }

    if (filter?.paymentModes && filter.paymentModes.length > 0) {
      query.$and = query.$and || [];
      query.$and.push({ paymentMode: { $in: filter.paymentModes } });
    }

    if (filter?.shops && filter.shops.length > 0) {
      query.$and = query.$and || [];
      query.$and.push({ shop_id: { $in: filter.shops } });
    }

    if (filter?.expenseTypes && filter.expenseTypes.length > 0) {
      query.$and = query.$and || [];
      query.$and.push({ expenseType: { $in: filter.expenseTypes } });
    }

    query.$and = query.$and || [];
    query.$and.push({
      $and: [{ truck: { $exists: true } }, { truck: { $ne: '' } }], // truck must exist
      $or: [
        { trip_id: { $exists: false } }, // trip_id must not exist
        { trip_id: { $eq: '' } } // or trip_id is an empty string
      ]
    });



    // Connect to the database and run the query
    await connectToDatabase();
    const expenses = await Expense.aggregate([
      { $match: query },
      // Lookup logic for drivers and shops (as you already have)
      {
        $lookup: {
          from: 'drivers',
          localField: 'driver',
          foreignField: 'driver_id',
          as: 'drivers'
        }
      },
      {
        $lookup: {
          from: 'shopkhatas',
          let: { shop_id: '$shop_id' },
          pipeline: [
            {
              $match: {
                $expr: { $eq: ['$shop_id', '$$shop_id'] }
              }
            }
          ],
          as: 'shops'
        }
      },
      {
        $addFields: {
          driverName: { $ifNull: [{ $arrayElemAt: ['$drivers.name', 0] }, 'N/A'] },
          shopName: { $ifNull: [{ $arrayElemAt: ['$shops.name', 0] }, 'N/A'] }
        }
      },
      {
        $project: {
          shops: 0,
          drivers: 0
        }
      },
      {
        $sort : { date : -1}
      }
    ]);

    return NextResponse.json({ truckExpense: expenses, status: 200 });
  } catch (err: any) {
    console.log(err);
    return NextResponse.json({ message: err.message, status: 500 });
  }
}
</file>

<file path="src/app/api/generateReport/route.ts">
import { recentActivity } from "@/helpers/recentActivity";
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, ExpenseSchema, OfficeExpenseSchema, tripChargesSchema, tripSchema, truckSchema } from "@/utils/schema";
import { monthMap } from "@/utils/utilArray";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const Trip = models.Trip || model('Trip', tripSchema);
const Expense = models.Expense || model('Expense', ExpenseSchema);
const TripCharges = models.TripCharges || model('TripCharges', tripChargesSchema);
const Truck = models.Truck || model('Truck', truckSchema);
const OfficeExpense = models.OfficeExpense || model('OfficeExpense', OfficeExpenseSchema);

export async function GET(req: Request) {
    try {
        const { user, error } = await verifyToken(req);
        if (!user || error) {
            return NextResponse.json({ error });
        }

        const url = new URL(req.url);
        const month = url.searchParams.get('month');
        const year = url.searchParams.get('year');

        const monthNumber = monthMap[month as any];
        if (monthNumber === undefined) {
            return NextResponse.json({ error: 'Invalid month name', status: 400 });
        }

        const startDate = new Date(year as any, monthNumber, 1);
        const endDate = new Date(year as any, monthNumber + 1, 1);

        await connectToDatabase();

        const tripsData = await Trip.aggregate([
            {
                $match: {
                    user_id: user,
                    startDate: { $gte: startDate, $lt: endDate }
                }
            },
            {
                $lookup: {
                    from: 'trucks',
                    localField: 'truck',
                    foreignField: 'truckNo',
                    as: 'truckDetails'
                }
            },
            { $unwind: '$truckDetails' },
            {
                $lookup: {
                    from: 'tripcharges',
                    localField: 'trip_id',
                    foreignField: 'trip_id',
                    as: 'charges'
                }
            },
            { $unwind: { path: '$charges', preserveNullAndEmptyArrays: true } },
            {
                $group: {
                    _id: '$truckDetails.ownership',
                    tripCount: { $sum: 1 }, // Counting the number of trips per ownership type
                    totalFreight: { $sum: '$amount' },
                    totalCharges: {
                        $sum: {
                            $cond: [{ $eq: ['$charges.partyBill', true] }, { $ifNull: ['$charges.amount', 0] }, 0]
                        }
                    },
                    totalDeductions: {
                        $sum: {
                            $cond: [{ $eq: ['$charges.partyBill', false] }, { $ifNull: ['$charges.amount', 0] }, 0]
                        }
                    },
                    trips: { $push: '$$ROOT' }
                }
            }
        ]);

        const marketTruckTrips = tripsData.find(d => d._id === 'Market') || { trips: [], tripCount: 0, totalFreight: 0, totalCharges: 0, totalDeductions: 0 };
        const ownTruckTrips = tripsData.find(d => d._id === 'Self') || { trips: [], tripCount: 0, totalFreight: 0, totalCharges: 0, totalDeductions: 0 };



        const [expenses, officeExpenses] = await Promise.all([
            // Fetch all expenses within the date range
            Expense.find({ user_id: user, date: { $gte: startDate, $lt: endDate } }).select('amount').lean(),

            // Fetch office expenses where trip_id and truck are either empty strings or null
            Expense.find({
                user_id: user,
                date: { $gte: startDate, $lt: endDate },
                $or: [
                    { trip_id: "" },
                    { trip_id: null },
                    { truck: "" },
                    { truck: null }
                ]
            }).select('amount').lean()
        ]);


        const totalExpense = expenses.reduce((total, expense) => total + expense.amount, 0);
        const totalOfficeExpense = officeExpenses.reduce((total, expense) => total + expense.amount, 0);

        const marketTruckProfit = marketTruckTrips.totalFreight + marketTruckTrips.totalCharges - marketTruckTrips.totalDeductions - totalExpense;
        const ownTruckProfit = ownTruckTrips.totalFreight + ownTruckTrips.totalCharges - ownTruckTrips.totalDeductions - totalOfficeExpense;

        const totalTrips = marketTruckTrips.tripCount + ownTruckTrips.tripCount; // Total number of trips

        const htmlReport = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balance Report for ${month} ${year}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f8ff;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color : #F3FAFF;
            padding : 2rem
        }
        h1 {
            font-size: 18px;
            color: #333;
            margin-bottom: 20px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .card {
            background-color: white;
            border-radius: 8px;
            border : 1px solid #E5E7EB;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        .card-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .section-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .small-card {
            background-color: white;
            border-radius: 8px;
            border : 1px solid #E5E7EB;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .small-card-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .small-card-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .profit {
            color: #22c55e;
        }
        .expense {
            color: #ef4444;
        }
        .button {
            background-color: #f97316;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            display: block;
            width: 100%;
            max-width: 200px;
            margin: 20px auto;
            text-align: center;
        }
            .footer {
            display : inline-flex;
            align-items: center;
            gap : 2px;
  text-align: center;
  padding: 10px;
  font-size: 14px;
  color: #333;
}

.footer-logo {
  width: 20px;
  height: auto;
  vertical-align: middle;
  margin: 0 5px;
}

    </style>
</head>
<body>
    <div class="container">
        <h1>Balance Report for ${month} ${year}</h1>
        
        <div class="grid">
            <div class="card">
                <div class="card-title">Overall Profit</div>
                <div class="card-value profit">${ownTruckProfit + marketTruckProfit}</div>
            </div>
            <div class="card">
                <div class="card-title">Total Trips</div>
                <div class="card-value">${totalTrips}</div>
            </div>
        </div>

        <div class="section-title">Revenue from Market Trucks</div>
        <div class="grid-4">
            <div class="small-card">
                <div class="small-card-title">Total Freight</div>
                <div class="small-card-value">${marketTruckTrips.totalFreight}</div>
            </div>
            <div class="small-card">
                <div class="small-card-title">Total Charges</div>
                <div class="small-card-value">${marketTruckTrips.totalCharges}</div>
            </div>
            <div class="small-card">
                <div class="small-card-title">Total Deductions</div>
                <div class="small-card-value">${marketTruckTrips.totalDeductions}</div>
            </div>
            <div class="small-card">
                <div class="small-card-title">Profit</div>
                <div class="small-card-value profit">${marketTruckProfit}</div>
            </div>
        </div>

        <div class="section-title">Own Trucks</div>
        <div class="grid-4">
            <div class="small-card">
                <div class="small-card-title">Total Freight</div>
                <div class="small-card-value">${ownTruckTrips.totalFreight}</div>
            </div>
            <div class="small-card">
                <div class="small-card-title">Total Charges</div>
                <div class="small-card-value">${ownTruckTrips.totalCharges}</div>
            </div>
            <div class="small-card">
                <div class="small-card-title">Total Deductions</div>
                <div class="small-card-value">${ownTruckTrips.totalDeductions}</div>
            </div>
            <div class="small-card">
                <div class="small-card-title">Profit</div>
                <div class="small-card-value profit">${ownTruckProfit}</div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <div class="card-title">Total Expense</div>
                <div class="card-value expense">${totalExpense}</div>
            </div>
            <div class="card">
                <div class="card-title">Office Expense</div>
                <div class="card-value">${totalOfficeExpense}</div>
            </div>
        </div>

        <div class="footer">
  Generated with 
  <img src="https://www.awajahi.com/awajahi%20logo.png" alt="Awajahi logo" class="footer-logo" /> 
  Awajahi.com
</div>

    </div>
</body>
</html>
`;
        await recentActivity('Generated Report', {
            month: month,
            year: year
        }, user)
        return new Response(htmlReport, {
            headers: { 'Content-Type': 'text/html' },
        });

    } catch (error) {
        console.error(error);
        return NextResponse.json({ error: 'Failed to fetch trip data', status: 500 });
    }
}
</file>

<file path="src/app/api/invoices/[invoiceId]/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, InvoiceSchema, tripSchema } from "@/utils/schema";
import { NextResponse } from "next/server";
import { models, model } from "mongoose";

const Invoice = models.Invoice || model("Invoice", InvoiceSchema);

export async function GET(req : Request, {params} : {params : {invoiceId : string}}){
    try {
        const {user, error} = await verifyToken(req)
        if(!user || error){
            return NextResponse.json({error : 'Unauthorized user'}, {status : 401})
        }
        const {invoiceId} = params

        const invoice = await Invoice.findById(invoiceId)
        return NextResponse.json({invoice}, {status : 200})
    } catch (error) {
        console.log(error)
        return NextResponse.json({error, status : 500}, {status : 500})
    }
}

export async function PATCH(req: Request, { params }: { params: { invoiceId: string } }) {
    try {
        // Verify user token
        const { user, error } = await verifyToken(req);
        if (!user || error) {
            return NextResponse.json({ error: 'Unauthorized User', status: 401 });
        }

        const { invoiceId } = params

        // Connect to the database
        await connectToDatabase();

        // Get form data
        const data = await req.json()

        console.log(data)

        // Check if the document type already exists in the documents array

        const invoice = await Invoice.findByIdAndUpdate(invoiceId, data)


        // Return success response
        return NextResponse.json({ message: 'Invoice saved successfully', status: 200 });

    } catch (error) {
        // Log the error and return server error response
        console.error("Error in uploading document:", error);
        return NextResponse.json({ error: 'Failed to upload document', status: 500 });
    }
}

export async function DELETE(req: Request, { params }: { params: { invoiceId: string } }) {
    try {
        // Verify user token
        const { user, error } = await verifyToken(req);
        if (!user || error) {
            return NextResponse.json({ error: 'Unauthorized User', status: 401 });
        }

        const { invoiceId } = params

        // Connect to the database
        await connectToDatabase();


        const invoice = await Invoice.findByIdAndDelete(invoiceId)

        const Trip = models.Trip || model('Trip', tripSchema)

        await Trip.updateMany(
            { trip_id: { $in: invoice.trips } },
            { $set: { invoice: false, invoice_id : ''} },
        
        );



        // Return success response
        return NextResponse.json({ message: 'Invoice Deleted successfully', status: 200 });

    } catch (error) {
        // Log the error and return server error response
        console.error("Failed to delete invoice:", error);
        return NextResponse.json({ error: 'Failed to delete invoice', status: 500 });
    }
}
</file>

<file path="src/app/api/invoices/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, InvoiceSchema, tripSchema } from "@/utils/schema";
import { NextResponse } from "next/server";
import { models, model } from "mongoose";
import { recentActivity } from "@/helpers/recentActivity";

const Invoice = models.Invoice || model("Invoice", InvoiceSchema);

export async function GET(req: Request) {
    try {
        const { user, error } = await verifyToken(req);
        if (!user || error) {
            return NextResponse.json({ message: "Unauthorized User" }, { status: 401 });
        }

        await connectToDatabase()

        const debugPipeline = [
            { $match: { user_id: user } },
            {
                $lookup: {
                    from: "parties",
                    localField: "party_id",
                    foreignField: "party_id",
                    as: "partyDetails",
                },
            },
            { $unwind: { path: "$partyDetails", preserveNullAndEmptyArrays: true } }, // Ensure null values are preserved for debugging
            {
                $addFields: {
                    partyName: "$partyDetails.name",
                },
            },
            {
                $project: {
                    partyDetails: 0,
                },
            },
        ];

        const invoices = await Invoice.aggregate(debugPipeline);

        return NextResponse.json({ invoices }, { status: 200 });
    } catch (error) {
        console.error(error);
        return NextResponse.json({ message: "Internal Server Error" }, { status: 500 });
    }
}

export async function POST(req: Request) {
    try {
        // Verify user token
        const { user, error } = await verifyToken(req);
        if (!user || error) {
            return NextResponse.json({ error: 'Unauthorized User', status: 401 });
        }

        // Connect to the database
        await connectToDatabase();

        // Get form data
        const data = await req.json()



        // Check if the document type already exists in the documents array

        const invoices = await Invoice.find({ user_id: user })

        const newInvoice = new Invoice({
            user_id: user,
            invoiceNo: invoices.length + 1,
            date: new Date(data?.date),
            dueDate: new Date(data?.dueDate),
            route: data.route,
            party_id: data.party_id,
            trips: data?.trips,
            balance: data.balance,
            invoiceStatus: data?.invoiceStatus,
            total: data?.total,
            advance: data?.advance
        })

        await Promise.all([newInvoice.save(), recentActivity('Generated Invoice', newInvoice, user)]);

        const Trip = models.Trip || model('Trip', tripSchema)

        await Trip.updateMany(
            { trip_id: { $in: data.trips } },
            { $set: { invoice: true, invoice_id: newInvoice._id } }
        );

        // Save the updated trip document


        // Return success response
        return NextResponse.json({ message: 'Document uploaded successfully', status: 200 });

    } catch (error) {
        // Log the error and return server error response
        console.error("Error in uploading document:", error);
        return NextResponse.json({ error: 'Failed to upload document', status: 500 });
    }
}
</file>

<file path="src/app/api/login/route.ts">
import { verifyToken } from "@/utils/auth";
import { encryptData, decryptData } from "@/utils/encryption";
import { connectToDatabase, userSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";


const User = models.User || model('User', userSchema);


export async function POST(req: Request) {
    try {
        const data = await req.json();
        await connectToDatabase();

        const { user_id } = data;
        if (!user_id) {
            return NextResponse.json({ message: "User ID is required", status: 400 });
        }

        const user = await User.findOne({ user_id });
        if (!user) {
            const newUser = new User(data);
            await newUser.save();
            return NextResponse.json({ message: "User Created", status: 201 });
        } else {
            return NextResponse.json({ message: "User Logged in", status: 200 });
        }
    } catch (error) {
        console.error('POST /api/user error:', error);
        return NextResponse.json({ error: 'Internal Server Error', status: 500 });
    }
}

export async function GET(req: Request) {
    try {
        const { user, error } = await verifyToken(req);
        if (error || !user) {
            return NextResponse.json({ error: 'Unauthorized', status: 401 });
        }

        await connectToDatabase();
        const curUser = await User.findOne({ user_id: user });
        if (!curUser) {
            return NextResponse.json({ message: "User not found", status: 404 });
        }

        // Decrypt the phone before sending it to the frontend

        return NextResponse.json({ user: curUser.toObject(), status: 200 });
    } catch (error) {
        console.error('GET /api/user error:', error);
        return NextResponse.json({ error: 'Internal Server Error', status: 500 });
    }
}
</file>

<file path="src/app/api/login/sendOtp/route.ts">
import { NextResponse } from "next/server"
import { log } from "node:console"

export async function POST(req: Request) {
    try {
        const { phone } = await req.json()
        if (phone === `+91${process.env.DUMMY_CRED_PHONE}`) {
            return NextResponse.json({
                data: {
                    "Status": "Success",
                    "Details": "l60gaseavbemjvlgw7o-7303503698702e11",
                    "OTP": process.env.DUMMY_CRED_OTP
                }, status: 200, message: 'OTP Sent'
            })
        }
        console.log(phone)
        const response = await fetch(`https://2factor.in/API/V1/${process.env.TWO_FACTOR_API_KEY}/SMS/${phone}/AUTOGEN2/`)
        if (!response.ok) {
            return NextResponse.json({ error: 'Internal Server Error' })
        }
        const data = await response.json()
        console.log(data)
        return NextResponse.json({ data, message: 'OTP sent', status: 200 })
    } catch (error: any) {
        console.log(error)
        return NextResponse.json({ error: error.message, status: 500 })
    }
}
</file>

<file path="src/app/api/login/verifyOtp/route.ts">
import { NextRequest, NextResponse, userAgent } from "next/server";
import jwt from "jsonwebtoken";
import { model, models } from "mongoose";
import { connectToDatabase, driverSchema, userSchema } from "@/utils/schema";
import { generateUserId } from "@/utils/auth";

const User = models.User || model("User", userSchema);

// Helper to verify OTP
async function verifyOTP(session: string, otp: string): Promise<boolean> {
  if (!session || !otp) return false;

  const otpResponse = await fetch(
    `https://2factor.in/API/V1/${process.env.TWO_FACTOR_API_KEY}/SMS/VERIFY/${session}/${otp}`
  );

  const otpData = await otpResponse.json();
  return otpData.Status === "Success";
}

// Helper to create JWT and set cookies
async function createJWTAndSetCookies(user: any) {
  let jwtObject: any = { user_id: user.user_id, phone: user.phone };

  if (user.role?.name === "driver") {
    const Driver = models.Driver || model("Driver", driverSchema);
    const driver = await Driver.findOne({ user_id: user.role.user, contactNumber: user.phone });
    jwtObject.role = {
      name: "driver",
      user: user.role.user,
      driver_id: driver?.driver_id,
    };
  } else if (user.role?.name === "accountant") {
    jwtObject.role = {
      name: "accountant",
      user: user.role.user,
    };
  }

  // Generate tokens
  const token = jwt.sign(jwtObject, process.env.JWT_SECRET as string, { expiresIn: "30d" });
  const roleToken = jwt.sign({ role: jwtObject.role }, process.env.JWT_SECRET as string, {
    expiresIn: "30d",
  });

  // Create response and set cookies
  const response = NextResponse.json({ message: "User Logged In", status: 200, roleToken, token });
  response.cookies.set("auth_token", token, {
    httpOnly: true,
    path: "/",
    sameSite: "strict",
    maxAge: 30 * 24 * 60 * 60,
  });

  if (jwtObject.role) {
    response.cookies.set("role_token", roleToken, {
      path: "/",
      sameSite: "strict",
    });
  }

  return response;
}

// Helper to find or create a user
async function findOrCreateUser(phone: string, deviceType: string) {
  const uid = generateUserId(phone);
  let user = await User.findOne({ user_id: uid });

  if (!user) {
    user = new User({
      user_id: uid,
      phone,
      deviceType,
      lastLogin: Date.now(),
    });
    await user.save();
  } else {
    user.deviceType = user.deviceType || deviceType;
    user.lastLogin = Date.now();
    await user.save();
  }

  return user;
}

export async function POST(req: NextRequest) {
  try {
    // Validate environment variables
    const { TWO_FACTOR_API_KEY, JWT_SECRET, DUMMY_CRED_PHONE, DUMMY_CRED_OTP } = process.env;
    if (!TWO_FACTOR_API_KEY || !JWT_SECRET) {
      throw new Error("Missing required environment variables");
    }

    // Parse request body
    const { phone, session, otp } = await req.json();
    if (!phone || !otp) {
      return NextResponse.json({ message: "Missing phone or OTP" }, { status: 400 });
    }

    await connectToDatabase();

    // Handle dummy credentials for testing
    if (phone === DUMMY_CRED_PHONE && otp === DUMMY_CRED_OTP) {
      const user = await findOrCreateUser(phone, "dummy");
      return await createJWTAndSetCookies(user);
    }

    // Verify OTP
    const otpValid = await verifyOTP(session, otp);
    if (!otpValid) {
      return NextResponse.json({ message: "Invalid OTP" }, { status: 400 });
    }

    // Extract device information
    const { device } = userAgent(req);
    const deviceType = device?.type || "unknown";

    // Format phone and find or create the user
    const formattedPhone = phone.startsWith("+91") ? phone.slice(3) : phone;
    const user = await findOrCreateUser(formattedPhone, deviceType);

    return await createJWTAndSetCookies(user);
  } catch (error: any) {
    console.error("Error in POST handler:", error.message);
    return NextResponse.json({ message: "Internal server error" }, { status: 500 });
  }
}
</file>

<file path="src/app/api/logout/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, TokenBlacklistSchema } from "@/utils/schema";
import { NextRequest, NextResponse } from "next/server";
import jwt from 'jsonwebtoken';
import { model, models } from "mongoose";

// Define the TokenBlackList model
const TokenBlackList = models.TokenBlackList || model('TokenBlackList', TokenBlacklistSchema);

export async function GET(req: NextRequest) {
    try {
        // Connect to the database
        await connectToDatabase();

        // Get the token from cookies
        const token = req.cookies.get('auth_token')?.value;
        if (!token) {
            return NextResponse.redirect(new URL('/login', req.url));
        }

        // Decode the token
        const decoded = jwt.decode(token);

        // Check if the decoded token is a JwtPayload and has the 'exp' property
        if (decoded && typeof decoded !== 'string' && 'exp' in decoded) {
            // Calculate the expiration date
            const expiresAt = new Date((decoded.exp as any) * 1000);

            // Check if the token is already blacklisted
            const blacklistedToken = await TokenBlackList.findOne({ token });
            if (!blacklistedToken) {
                const newToken = new TokenBlackList({ token, expiresAt });
                await newToken.save();
            }

            // Prepare the response object
            const response = NextResponse.json({ message: 'Token invalidated successfully', status: 200 });

            // Clear the token cookies
            response.cookies.delete('auth_token');
            response.cookies.delete('role_token');

            // Set the Location header for redirect
            response.headers.set('Location', new URL('/api/logout', req.url).toString());

            // Return the response (with redirect and cookies)
            return response;
        } else {
            return NextResponse.json({ error: 'Invalid token', status: 400 });
        }
    } catch (error) {
        console.error('Error processing token invalidation:', error);
        return NextResponse.json({ error: 'Internal server error', status: 500 });
    }
}
</file>

<file path="src/app/api/notifications/send-test-notifications/route.ts">
// pages/api/send-test-notification.ts

import { sendNotificationToUser } from '@/services/notificationService';
import { NextApiRequest, NextApiResponse } from 'next';
import { NextResponse } from 'next/server';

export  async function POST(req: Request) {
  if (req.method !== 'POST') {
    return NextResponse.json({ message: 'Method not allowed' });
  }

    const { userId } = await req.json();

  if (!userId) {
    return NextResponse.json({ message: 'User ID is required' });
  }

  try {
    // Define the notification content
    const notificationPayload = {
      title: 'Hello from the Server!',
      body: `This is a test notification for user ${userId}.`,
      data: {
        // This data is received in your Flutter app's `_handleMessage` function
        screen: 'details',
        itemId: '12345',
      },
    };

    // Call the service function
    await sendNotificationToUser(userId, notificationPayload);

   return NextResponse.json({ message: 'Notification sent successfully!' });
  } catch (error) {
    console.error('Failed to send notification:', error);
   return NextResponse.json({ message: 'Internal Server Error' });
  }
}
</file>

<file path="src/app/api/notifications/set-token/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase } from "@/utils/schema";
import { NextResponse } from "next/server";
import { fcmTokenSchema } from '../../../../utils/schema';
import { model, models } from "mongoose";

// Add timestamps to your schema to track when tokens are added or updated
fcmTokenSchema.set('timestamps', true);
const FcmToken = models.fcmToken || model('fcmToken', fcmTokenSchema);

export async function POST(req: Request) {
  const { user, error } = await verifyToken(req);
  if (error) {
    console.log(error);
    return NextResponse.json({ error, status: 500 });
  }

  await connectToDatabase();
  try {
    const { fcm_token } = await req.json();

    if (!fcm_token) {
        return NextResponse.json({ error: 'FCM token is required', status: 400 });
    }

    // Use findOneAndUpdate with upsert:true
    const updatedToken = await FcmToken.findOneAndUpdate(
      { user_id: user, fcm_token: fcm_token }, // Query: Find a doc with this user AND this token
      { $set: { user_id: user, fcm_token: fcm_token } }, // Data to set (ensures user_id is correct)
      { upsert: true, new: true } // Options: create if not found, and return the new/updated doc
    );

    return NextResponse.json({
      message: 'FCM token registered successfully',
      status: 200,
      fcm_token: updatedToken
    });

  } catch (err) {
    console.log(err);
    return NextResponse.json({ error: 'Internal Server Error', status: 500 });
  }
}
</file>

<file path="src/app/api/parties/[partyId]/payments/[paymentId]/route.ts">
import { AddtoInvoice } from "@/helpers/modifyInvoice"
import { recentActivity } from "@/helpers/recentActivity"
import { verifyToken } from "@/utils/auth"
import { connectToDatabase, PartyPaymentSchema } from "@/utils/schema"
import { model, models } from "mongoose"
import { NextResponse } from "next/server"

const PartyPayment = models.PartyPayment || model('PartyPayment', PartyPaymentSchema)

export async function PUT(req: Request, { params }: { params: { paymentId: string } }) {
    try {
        // Verify user token
        const { user, error } = await verifyToken(req);
        if (!user || error) {
            return NextResponse.redirect('/api/logout');
        }

        // Parse request body
        const data = await req.json();
        const { paymentId } = params;

        // Validate paymentId and data
        if (!paymentId || !data) {
            return NextResponse.json({ error: "Invalid payment ID or data", status: 400 });
        }

        // Connect to the database
        await connectToDatabase();

        // Fetch the previous payment and update it in a single operation
        const prevPayment = await PartyPayment.findById(paymentId);
        if (!prevPayment) {
            return NextResponse.json({ error: "Payment not found", status: 404 });
        }

        const updatedPayment = await PartyPayment.findByIdAndUpdate(paymentId, data, { new: true });

        // Check if trip_id and amount are present and if the amount has changed
        if (updatedPayment.trip_id && updatedPayment.amount && updatedPayment.amount !== prevPayment.amount) {
            const diffAmount = Number(updatedPayment.amount) - Number(prevPayment.amount);
            await AddtoInvoice(updatedPayment.trip_id, user, Number(diffAmount));
        }

        // Log recent activity
        await recentActivity('Updated Party Payment', updatedPayment, user);

        // Return the updated payment
        return NextResponse.json({ payment: updatedPayment, status: 200 });
    } catch (error) {
        console.error("Error in PUT /api/payments/[paymentId]:", error);
        return NextResponse.json({ error: "Internal Server Error", status: 500 });
    }
}

export async function DELETE(req: Request, { params }: { params: { paymentId: string } }) {
    try {
        const { user, error } = await verifyToken(req)
        if (!user || error) {
            return NextResponse.redirect('/api/logout')
        }
        const { paymentId } = params
        await connectToDatabase()
        const payment = await PartyPayment.findByIdAndDelete(paymentId)
        if (payment.trip_id) {
            await AddtoInvoice(payment.trip_id, user, -payment.amount)
        }
        await recentActivity('Deleted Party Payment', payment, user)
        return NextResponse.json({ payment, status: 200 })
    } catch (error) {
        console.log(error)
        return NextResponse.json({ error, status: 500 })
    }
}
</file>

<file path="src/app/api/parties/[partyId]/payments/route.ts">
import { AddtoInvoice } from "@/helpers/modifyInvoice";
import { recentActivity } from "@/helpers/recentActivity";
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, InvoiceSchema, PartyPaymentSchema, tripSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const PartyPayment = models.PartyPayment || model('PartyPayment', PartyPaymentSchema)


export async function POST(req: Request, { params }: { params: { partyId: string } }) {

    try {
        const { user, error } = await verifyToken(req)
        if (!user || error) {
            return NextResponse.redirect('/api/logout')
        }
        const data = await req.json()
        const { partyId } = params
        await connectToDatabase()
        const payment = new PartyPayment({
            user_id: user,
            party_id: partyId,
            ...data
        })
        if (data.trip_id && data.amount) {
            await AddtoInvoice(data.trip_id, user, Number(data.amount))
        }
        await Promise.all([payment.save(), recentActivity('Added Party Payment', payment, user)])
        return NextResponse.json({ payment, status: 200 })
    } catch (error) {
        console.log(error)
        return NextResponse.json({ error, status: 500 })
    }
}
</file>

<file path="src/app/api/parties/[partyId]/route.ts">
import { recentActivity } from "@/helpers/recentActivity";
import { verifyToken } from "@/utils/auth";
import { connectToDatabase } from "@/utils/schema";
import { partySchema } from "@/utils/schema";
import { models, model } from 'mongoose'
import { NextResponse } from "next/server";


const Party = models.Party || model('Party', partySchema)

export async function GET(req: Request, { params }: { params: { partyId: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  const { partyId } = params;

  try {
    await connectToDatabase();

    // const party = await Party.findOne({ party_id: partyId, user_id: user }).lean().exec();
    const parties = await Party.aggregate([
      {
        $match: { user_id: user, party_id: partyId }
      },
      {
        $lookup: {
          from: 'trips',
          localField: 'party_id',
          foreignField: 'party',
          as: 'trips'
        }
      },
      {
        $lookup: {
          from: 'partypayments',
          localField: 'party_id',
          foreignField: 'party_id',
          as: 'partyPayments'
        }
      },
      {
        $lookup: {
          from: 'tripcharges',
          localField: 'trips.trip_id',
          foreignField: 'trip_id',
          as: 'tripCharges'
        }
      },
      {
        $addFields: {
          trips: {
            $map: {
              input: '$trips',
              as: 'trip',
              in: {
                type: 'trip',
                date: '$$trip.startDate',
                description: '$$trip.route',
                status: '$$trip.status',
                trip_id: '$$trip.trip_id',
                truck: '$$trip.truck',
                amount : '$$trip.amount',
                revenue: {
                  $let: {
                    vars: {
                      chargeToBill: {
                        $sum: {
                          $filter: {
                            input: '$tripCharges',
                            as: 'charge',
                            cond: { $eq: ['$$charge.partyBill', true] }
                          }
                        }
                      },
                      chargeNotToBill: {
                        $sum: {
                          $filter: {
                            input: '$tripCharges',
                            as: 'charge',
                            cond: { $eq: ['$$charge.partyBill', false] }
                          }
                        }
                      }
                    },
                    in: {
                      $subtract: [
                        { $add: ['$$trip.amount', '$$chargeToBill'] },
                        '$$chargeNotToBill'
                      ]
                    }
                  }
                },
                totalPayments: {
                  $let: {
                    vars: {
                      matchingPayments: {
                        $filter: {
                          input: '$partyPayments',
                          as: 'payment',
                          cond: { $eq: ['$$payment.trip_id', '$$trip.trip_id'] }
                        }
                      }
                    },
                    in: { $sum: '$$matchingPayments.amount' }
                  }
                }
              }
            }
          },
          partyPayments: {
            $map: {
              input: '$partyPayments',
              as: 'payment',
              in: {
                _id : '$$payment._id',
                type: 'payment',
                date: '$$payment.date',
                amount: '$$payment.amount',
                description: 'Payment',
                paymentType: '$$payment.paymentType',
                trip_id: { $ifNull: ['$$payment.trip_id', null] }
              }
            }
          }
        }
      },
      {
        // Combine `trips` and `partyPayments` into a single array
        $addFields: {
          items: { $concatArrays: ['$trips', '$partyPayments'] }
        }
      },
      {
        // Sort by date descending
        $sort: { 'items.date': -1 }
      },
      {
        // Group final result
        $group: {
          _id: '$_id',
          party_id: { $first: '$party_id' },
          name: { $first: '$name' },
          contactNumber: { $first: '$contactNumber' },
          contactPerson: { $first: '$contactPerson' },
          address: { $first: '$address' },
          gstNumber: { $first: '$gstNumber' },
          items: { $first: '$items' }  // Keep sorted items
        }
      }
    ]);




    if (!parties) {
      return NextResponse.json({ message: 'Party not found' }, { status: 404 });
    }

    return NextResponse.json({ party: parties[0] }, { status: 200 });
  } catch (err: any) {
    console.error(err);
    return NextResponse.json({ message: 'Internal Server Error', error: err.message }, { status: 500 });
  }
}

export async function PUT(req: Request, { params }: { params: { partyId: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  const { partyId } = params;
  const data = await req.json()

  try {
    await connectToDatabase();

    const gstRegex = /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/;
    if (data.gstNumber && !gstRegex.test(data.gstNumber)) {
      return NextResponse.json({ message: 'Invalid GST number' }, { status: 400 });
    }

    // Phone number validation (10 digits starting with 7, 8, or 9)
    const phoneRegex = /^[789]\d{9}$/;
    if (data.contactNumber != '' && !phoneRegex.test(data.contactNumber)) {
      return NextResponse.json({ message: 'Invalid phone number' }, { status: 400 });
    }

    const party = await Party.findOneAndUpdate({ party_id: partyId, user_id: user }, data, { new: true }).lean().exec();
    await recentActivity('Updated Customer Details', party, user)

    if (!party) {
      return NextResponse.json({ message: 'Party not found' }, { status: 404 });
    }

    return NextResponse.json({ party: party }, { status: 200 });
  } catch (err: any) {
    console.error(err);
    return NextResponse.json({ message: 'Internal Server Error', error: err.message }, { status: 500 });
  }
}

export async function DELETE(req: Request, { params }: { params: { partyId: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  const { partyId } = params;

  try {
    await connectToDatabase();

    const party = await Party.findOneAndDelete({ party_id: partyId, user_id: user }).lean().exec();

    if (!party) {
      return NextResponse.json({ message: 'Party not found' }, { status: 404 });
    }

    return NextResponse.json({ party: party }, { status: 200 });
  } catch (err: any) {
    console.error(err);
    return NextResponse.json({ message: 'Internal Server Error', error: err.message }, { status: 500 });
  }
}
</file>

<file path="src/app/api/parties/create/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, partySchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const Party = models.Party || model('Party', partySchema)

export async function GET(req : Request) {
    const { user, error } = await verifyToken(req);
    if (error) {
      return NextResponse.json({ error });
    }
    
  
    try {
      await connectToDatabase()
  
      const parties = await Party.find({user_id : user}).select(['name', 'party_id']).lean().exec();
      return NextResponse.json({ parties });
    } catch (err) {
      console.error(err);
      return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 });
    }
  }
</file>

<file path="src/app/api/parties/route.ts">
import { NextResponse, NextRequest } from 'next/server';
import { model, models } from 'mongoose';
import { connectToDatabase, partySchema } from '@/utils/schema';
import { IParty } from '@/utils/interface';

import { v4 as uuidv4 } from 'uuid'

import { verifyToken } from '@/utils/auth';
import { recentActivity } from '@/helpers/recentActivity';

const Party = models.Party || model('Party', partySchema);

export async function GET(req: Request) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.redirect(new URL('/api/logout', req.url));
  }


  try {
    await connectToDatabase()

    const parties = await Party.aggregate([
      { $match: { user_id: user } }, // Match based on user ID
      {
        $lookup: {
          from: 'trips', // Join with trips collection
          localField: 'party_id',
          foreignField: 'party',
          as: 'trips'
        }
      },
      // Group the trips to sum up the amounts before unwinding
      {
        $addFields: {
          totalTripAmount: {
            $sum: { $ifNull: ['$trips.amount', 0] } // Sum of amounts for all trips
          }
        }
      },
      {
        $lookup: {
          from: 'tripcharges', // Join with tripcharges collection
          localField: 'trips.trip_id',
          foreignField: 'trip_id',
          as: 'tripExpenses'
        }
      },
      {
        $lookup: {
          from: 'partypayments', // Join with partypayments collection for account balance
          localField: 'party_id',
          foreignField: 'party_id',
          as: 'tripAccounts'
        }
      },
      {
        $addFields: {
          chargeToBill: {
            $sum: {
              $map: {
                input: {
                  $filter: {
                    input: { $ifNull: ['$tripExpenses', []] }, // Handle null tripExpenses
                    as: 'expense',
                    cond: { $eq: ['$$expense.partyBill', true] }
                  }
                },
                as: 'filteredExpense',
                in: { $ifNull: ['$$filteredExpense.amount', 0] }
              }
            }
          },
          chargeNotToBill: {
            $sum: {
              $map: {
                input: {
                  $filter: {
                    input: { $ifNull: ['$tripExpenses', []] }, // Handle null tripExpenses
                    as: 'expense',
                    cond: { $eq: ['$$expense.partyBill', false] }
                  }
                },
                as: 'filteredExpense',
                in: { $ifNull: ['$$filteredExpense.amount', 0] }
              }
            }
          },
          accountBalance: {
            $sum: {
              $map: {
                input: { $ifNull: ['$tripAccounts', []] }, // Handle null tripAccounts
                as: 'account',
                in: { $ifNull: ['$$account.amount', 0] }
              }
            }
          }
        }
      },
      {
        $addFields: {
          partyBalance: {
            $subtract: [
              { $add: ['$totalTripAmount', '$chargeToBill'] }, // sum of totalTripAmount and chargeToBill
              { $add: ['$accountBalance', '$chargeNotToBill'] } // sum of accountBalance and chargeNotToBill
            ]
          }
        }
      },
      {
        $group: {
          _id: '$_id', // Group by party_id
          partyBalance: { $sum: '$partyBalance' }, // Sum of balances for all trips
          party: { $first: '$$ROOT' } // Preserve the full party document
        }
      },
      {
        $addFields: {
          'party.partyBalance': '$partyBalance' // Add partyBalance field to the party document
        }
      },
      { $replaceRoot: { newRoot: '$party' } }, // Replace the root with the full party document
      { $project: { trips: 0, tripExpenses: 0, tripAccounts: 0 } }, // Optionally remove trips and tripExpenses if not needed in the final output
      { $sort: { name: 1 } }
    ]);


    return NextResponse.json({ parties });
  } catch (err) {
    console.error(err);
    return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 });
  }
}


export async function POST(req: Request) {

  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }


  try {
    await connectToDatabase()

    const data = await req.json();

    // Basic validation


    // GST number validation
    const gstRegex = /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/;
    if (data.gstNumber && !gstRegex.test(data.gstNumber)) {
      return NextResponse.json({ message: 'Invalid GST number' }, { status: 400 });
    }

    // Phone number validation (10 digits starting with 7, 8, or 9)
    const phoneRegex = /^[6789]\d{9}$/;
    if (data.contactNumber != '' && !phoneRegex.test(data.contactNumber)) {
      return NextResponse.json({ message: 'Invalid phone number' }, { status: 400 });
    }


    const newParty: IParty = new Party({
      user_id: user,
      party_id: 'party' + uuidv4(),
      name: data.name,
      contactPerson: data.contactPerson,
      contactNumber: data.contactNumber,
      address: data.address,
      gstNumber: data.gstNumber,
      balance: data.balance,
      createdAt: data.createdAt || new Date(),
      updatedAt: data.updatedAt || new Date(),
    });

    const [savedParty,un] = await Promise.all([newParty.save(), recentActivity('Added New Customer', newParty, user)]);
    return NextResponse.json({ message: 'Saved Successfully', data: savedParty }, { status: 200 });

  } catch (error: any) {
    console.error('Error saving party:', error);

    if (error.name === 'ValidationError') {
      return NextResponse.json({ message: 'Validation Error', details: error.message }, { status: 400 });
    } else if (error.name === 'MongoError' && error.code === 11000) {
      return NextResponse.json({ message: 'Duplicate Key Error', details: error.message }, { status: 409 });
    } else {
      return NextResponse.json({ message: 'Internal Server Error', details: error.message }, { status: 500 });
    }
  }
}
</file>

<file path="src/app/api/s3Upload/route.ts">
import { NextResponse } from "next/server";
import { S3Client, PutObjectCommand } from "@aws-sdk/client-s3";
import { model, models } from "mongoose";
import { tripSchema } from "@/utils/schema";
import pdf from 'pdf-parse-new';
import sharp from 'sharp'
import tesseract from 'node-tesseract-ocr';
import { verifyToken } from "@/utils/auth";

const s3Client = new S3Client({
  region: process.env.AWS_S3_REGION,
  credentials: {
    accessKeyId: process.env.AWS_S3_ACCESS_KEY_ID!,
    secretAccessKey: process.env.AWS_S3_SECRET_ACCESS_KEY!,
  },
});

const Trip = models.Trip || model('Trip', tripSchema);


function extractTripDetails(text: string) {
  const originRegex = /From\s+.*Pincode:-\s*(\d{6})/;
  const destinationRegex = /To\s+.*Pincode:-\s*(\d{6})/;
  const startDateRegex = /Generated Date:(\d{2}\/\d{2}\/\d{4}\s+\d{2}:\d{2}\s+\w{2})/;
  const freightAmountRegex = /Total Inv\.Amt\s*(\d+\.\d{2})/;
  const truckNumberRegex = /Vehicle\s*\/\s*Trans\s*Doc\s*No\s*&\s*Dt\.\s*.*\nRoad([A-Z]{2}\d{2}[A-Z]{1,2}\d{4})/;

  const originMatch = text.match(originRegex);
  const destinationMatch = text.match(destinationRegex);
  const startDateMatch = text.match(startDateRegex);
  const freightAmountMatch = text.match(freightAmountRegex);
  const truckNumberMatch = text.match(truckNumberRegex);

  const origin = originMatch ? originMatch[1] : null;
  const destination = destinationMatch ? destinationMatch[1] : null;
  const startDate = startDateMatch ? startDateMatch[1] : null;
  const freightAmount = freightAmountMatch ? freightAmountMatch[1] : null;
  const truckNumber = truckNumberMatch ? truckNumberMatch[1] : null;

  return {
    origin,
    destination,
    startDate,
    freightAmount,
    truckNumber
  };
}

async function uploadFileToS3(fileBuffer: Buffer, fileName: string, contentType: string): Promise<string> {
  const params = {
    Bucket: process.env.AWS_S3_BUCKET_NAME!,
    Key: fileName,
    Body: fileBuffer,
    ContentType: contentType,
  };

  const command = new PutObjectCommand(params);
  await s3Client.send(command);
  return fileName;
}

async function extractValidityDate(text: string): Promise<Date | null> {
  const regex = /(?:valid|vahd)?\s*upto\s*[:\-]?\s*(\d{2})\/(\d{2})\/(\d{4})/i

  const match = text.match(regex);

  if (match) {
    const [_, day, month, year] = match;
    return new Date(`${year}-${month}-${day}`);
  }

  return null;
}

// Function to extract text from a PDF using pdf-parse
async function extractTextFromPdf(buffer: Buffer): Promise<string> {
  try {
    const data = await pdf(buffer);
    console.log(extractTripDetails(data.text))
    return data.text;
  } catch (error) {
    console.error("Error extracting text from PDF:", error);
    throw new Error("Failed to extract text from PDF");
  }
}

async function preprocessImage(buffer: Buffer): Promise<Buffer> {
  const preprocessedBuffer = await sharp(buffer)
    .resize({ width: 1500 })  // Resize for better OCR accuracy
    .grayscale()  // Convert to grayscale
    .normalize()  // Normalize to enhance contrast
    .sharpen({
      sigma: 1,  // Controls the amount of blur applied before calculating the difference (higher values mean less sharpening)
      m1: 1,     // Controls the level of sharpening (mid-tone)
      m2: 0.5,   // Controls the level of sharpening (shadow area)
      x1: 2,     // Threshold below which the pixels are left unchanged
      y2: 10,    // Controls the range of sharpening applied (upper bound for adjustment)
      y3: 2      // Controls the range of sharpening applied (lower bound for adjustment)
    })
    .median(3)  // Apply median filter to reduce noise
    .threshold(180)  // Binarize the image
    .removeAlpha()  // Remove alpha channel if present
    .toBuffer();

  return preprocessedBuffer;
}

// Function to extract text from an image using node-tesseract-ocr
async function extractTextFromImage(buffer: Buffer): Promise<string> {
  const preprocessedBuffer = await preprocessImage(buffer);
  const text = await tesseract.recognize(preprocessedBuffer, {
    lang: "eng",
    psm: 3,  // Try different PSM values
    oem: 3,  // Use the best OCR Engine mode
    tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789/:', // Whitelist for known characters
  });
  console.log(extractTripDetails(text))
  return text;
}

export async function POST(request: Request) {
  try {
    const {user, error} = await verifyToken(request)
    if( !user || error){
      return NextResponse.json({error : 'Unauthorized User', status : 401})
    }
    const formData = await request.formData();
    const file = formData.get("file") as File;
    const tripId = formData.get("tripId") as string;
    let ewbValidityDate = formData.get('ewbValidityDate') ? new Date(formData.get('ewbValidityDate') as string) : null;

    if (!file || !tripId) {
      return NextResponse.json({ error: "File and tripId are required." }, { status: 400 });
    }

    const fileBuffer = Buffer.from(await file.arrayBuffer());
    const fileName = `trips/ewaybill-${tripId}`;
    const contentType = file.type;

    // If ewbValidityDate is not provided, extract it from the file
    if (!ewbValidityDate) {
      if (contentType === "application/pdf") {
        // Extract text from PDF using pdf-parse
        const pdfText = await extractTextFromPdf(fileBuffer);
        ewbValidityDate = await extractValidityDate(pdfText);
      } else if (contentType.startsWith("image/")) {
        // Extract text from image using node-tesseract-ocr
        const imageText = await extractTextFromImage(fileBuffer);
        ewbValidityDate = await extractValidityDate(imageText);
      }

      // If ewbValidityDate is still null, return an error response
      if (!ewbValidityDate) {
        return NextResponse.json({
          success: false,
          message: "Failed to extract validity date. Please enter it manually.",
        });
      }
    }

    // Upload the file to S3
    const s3FileName = await uploadFileToS3(fileBuffer, fileName, contentType);
    const fileUrl = `https://${process.env.AWS_S3_BUCKET_NAME}.s3.${process.env.AWS_S3_REGION}.amazonaws.com/${s3FileName}${contentType === 'application/pdf' ? '.pdf' : ''}`;

    // Update the Trip document with the E-Way Bill URL and validity date
    const updateResult = await Trip.updateOne(
      { user_id: user, trip_id: tripId },
      {
        $push: {
          documents: {
            filename: file.name,
            type: 'E-Way Bill',
            uploadedDate: new Date(),
            validityDate: ewbValidityDate,
            url: fileUrl,
          },
        },
      }
    );

    if (updateResult.modifiedCount === 0) {
      return NextResponse.json({ error: 'Trip not found or update failed.' }, { status: 404 });
    }

    return NextResponse.json({ success: true, fileUrl, ewbValidityDate });

  } catch (error) {
    console.error("Error uploading e-way bill:", error);
    return NextResponse.json({ error: "Failed to upload e-way bill." }, { status: 500 });
  }
}
</file>

<file path="src/app/api/schedule-demo/route.ts">
import { NextResponse } from 'next/server';
import nodemailer from 'nodemailer';

// Create a transporter using SMTP
const transporter = nodemailer.createTransport({
  host: process.env.EMAIL_HOST,
  port: parseInt(process.env.EMAIL_PORT || '587'),
  secure: process.env.EMAIL_SECURE === 'true',
  auth: {
    user: process.env.EMAIL_USER,
    pass: process.env.EMAIL_PASS,
  },
});

export async function POST(request: Request) {
  const body = await request.json();
  const { name, phone, email, company, notes } = body;

  try {
    // Send email
    await transporter.sendMail({
      from: process.env.EMAIL_FROM,
      to: process.env.EMAIL_TO,
      subject: 'New Demo Request',
      html: `
        <h1>New Demo Request</h1>
        <p><strong>Name:</strong> ${name}</p>
        <p><strong>Phone:</strong> ${phone}</p>
        <p><strong>Email:</strong> ${email}</p>
        <p><strong>Company:</strong> ${company}</p>
        <p><strong>Notes:</strong> ${notes}</p>
      `,
    });

    return NextResponse.json({ message: 'Email sent successfully', status: 200 });
  } catch (error) {
    console.error('Failed to send email:', error);
    return NextResponse.json({ message: 'Failed to send email' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/search/route.ts">
import { verifyToken } from "@/utils/auth";
import {
    connectToDatabase,
    driverSchema,
    ExpenseSchema,
    OfficeExpenseSchema,
    partySchema,
    supplierAccountSchema,
    supplierSchema,
    tripChargesSchema,
    tripSchema,
    truckSchema,
} from "@/utils/schema";
import { models, model } from "mongoose";
import { NextResponse } from "next/server";

const Party = models.Party || model("Party", partySchema);
const Trip = models.Trip || model("Trip", tripSchema);
const Driver = models.Driver || model("Driver", driverSchema);
const Truck = models.Truck || model("Truck", truckSchema);
const Supplier = models.Supplier || model("Supplier", supplierSchema);
const Expense = models.Expense || model("Expense", ExpenseSchema);
const SupplierAccount = models.SupplierAccount || model("SupplierAccount", supplierAccountSchema);
const OfficeExpense = models.OfficeExpense || model("OfficeExpense", OfficeExpenseSchema);
const TripCharges = models.TripCharges || model("TripCharges", tripChargesSchema);

export async function GET(req: Request) {
    try {
        // Verify the user's token
        const { user, error } = await verifyToken(req);
        if (!user || error) {
            return NextResponse.json({ error: error || "Unauthorized access" }, { status: 401 });
        }

        // Parse the query parameter from the request
        const { searchParams } = new URL(req.url);
        const query = searchParams.get("query") || "";

        // Connect to the database
        await connectToDatabase();

        const numericQuery = parseFloat(query);
        const isNumericQuery = !isNaN(numericQuery);

        // Define the search criteria for each collection
        const searchCriteria = query
            ? {
                user_id: user,
                $or: [
                    { name: { $regex: query, $options: "i" } },
                    { party_id: { $regex: query, $options: "i" } },
                    { contactPerson: { $regex: query, $options: "i" } },
                    { contactNumber: { $regex: query, $options: "i" } },
                    { address: { $regex: query, $options: "i" } },
                    { gstNumber: { $regex: query, $options: "i" } },
                ],
            }
            : { user_id: user };

        // Fetch data from all collections
        const [parties, trips, drivers, trucks, suppliers, expenses, supplierAccounts, officeExpenses, tripCharges] =
            await Promise.all([
                Party.find(searchCriteria).lean(),
                Trip.find({
                    user_id: user,
                    $or: [
                        { billingType: { $regex: query, $options: "i" } },
                        { LR: { $regex: query, $options: "i" } },
                        { truck: { $regex: query, $options: "i" } },
                        { notes: { $regex: query, $options: "i" } },
                        ...(isNumericQuery ? [{ amount: numericQuery }, { "accounts.amount": numericQuery }] : []),
                        { "accounts.paymentType": { $regex: query, $options: "i" } },
                        { "accounts.notes": { $regex: query, $options: "i" } },
                        { "route.origin": { $regex: query, $options: "i" } },
                        { "route.destination": { $regex: query, $options: "i" } },
                    ],
                }).lean(),

                Driver.find({
                    user_id: user,
                    $or: [
                        { name: { $regex: query, $options: "i" } },
                        { licenseNumber: { $regex: query, $options: "i" } },
                        { contactNumber: { $regex: query, $options: "i" } },
                        { status: { $regex: query, $options: "i" } }
                    ],
                }).lean(),
                Truck.find({
                    user_id: user,
                    $or: [
                        { truckNo: { $regex: query, $options: "i" } },
                        { truckType: { $regex: query, $options: "i" } },
                        { model: { $regex: query, $options: "i" } },
                        { capacity: { $regex: query, $options: "i" } },
                        { bodyLength: { $regex: query, $options: "i" } },
                        { ownerShip: { $regex: query, $options: "i" } },
                    ],
                }).lean(),
                Supplier.find({
                    user_id: user,
                    $or: [
                        { name: { $regex: query, $options: "i" } },
                        { contactNumber: { $regex: query, $options: "i" } },
                    ],
                }).lean(),
                Expense.find({
                    user_id: user,
                    $or: [
                        ...(isNumericQuery ? [{ amount: numericQuery }] : []),
                        { expenseType: { $regex: query, $options: "i" } },
                        { paymentMode: { $regex: query, $options: "i" } },
                        { transaction_id: { $regex: query, $options: "i" } },
                        { notes: { $regex: query, $options: "i" } },
                    ],
                }).lean(),
                SupplierAccount.find({
                    user_id: user,
                    $or: [
                        { refNo: { $regex: query, $options: "i" } },
                        { paymentMode: { $regex: query, $options: "i" } },
                        ...(isNumericQuery ? [{ amount: numericQuery }] : []),
                        { notes: { $regex: query, $options: "i" } },
                    ],
                }).lean(),
                OfficeExpense.find({
                    user_id: user,
                    $or: [
                        ...(isNumericQuery ? [{ amount: numericQuery }] : []),
                        { expenseType: { $regex: query, $options: "i" } },
                        { paymentMode: { $regex: query, $options: "i" } },
                        { transactionId: { $regex: query, $options: "i" } },
                        { notes: { $regex: query, $options: "i" } },
                    ],
                }).lean(),
                TripCharges.find({
                    user_id: user,
                    $or: [
                        ...(isNumericQuery ? [{ amount: numericQuery }] : []),
                        { expenseType: { $regex: query, $options: "i" } },
                        { notes: { $regex: query, $options: "i" } },
                    ],
                }).lean(),
            ]);

        // Return the fetched data
        return NextResponse.json({
            parties,
            trips,
            drivers,
            trucks,
            suppliers,
            expenses,
            supplierAccounts,
            officeExpenses,
            tripCharges,
        });
    } catch (error: any) {
        // Handle any errors that occur during the process
        console.log(error);
        return NextResponse.json({ error: error.message || "Internal Server Error" }, { status: 500 });
    }
}
</file>

<file path="src/app/api/shopkhata/[shopId]/accounts/[accountsId]/route.ts">
import { verifyToken } from "@/utils/auth";
import { ShopKhataAccountsSchema } from "@/utils/schema";
import { NextResponse } from "next/server";
import { models, model } from 'mongoose'


const ShopKhataAccounts = models.ShopKhataAccounts || model('ShopKhataAccounts', ShopKhataAccountsSchema);

export async function PATCH(req: Request, { params }: { params: { shopId: string, accountId: string } }) {

}

export async function DELETE(req: Request, { params }: { params: { shopId: string, accountId: string } }) {
    try {
        const { user, error } = await verifyToken(req)
        if (!user || error) {
            return NextResponse.json({ error: 'Unauthorized user' }, { status: 401 })
        }
        const { shopId, accountId } = params
        await ShopKhataAccounts.findByIdAndDelete(accountId)

        return NextResponse.json({ message: 'Entry Deleted' }, { status: 200 })

    } catch (error) {
        console.log(error)
        return NextResponse.json({ error, status: 500 }, { status: 500 })
    }
}
</file>

<file path="src/app/api/shopkhata/[shopId]/accounts/calculate/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, ExpenseSchema, OfficeExpenseSchema, ShopKhataAccountsSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const Expense = models.Expense || model('Expense', ExpenseSchema)
const ShopKhataAccounts = models.ShopKhataAccounts || model('ShopKhataAccount', ShopKhataAccountsSchema)
const OfficeExpense = models.OfficeExpense || model('OfficeExpense', OfficeExpenseSchema)

export async function GET(req: Request, { params }: { params: { shopId: string } }) {
    try {
      // Verify the user token
      const { user, error } = await verifyToken(req);
      if (!user || error) {
        return NextResponse.json({ error: 'Unauthorized User', status: 401 });
      }
  
      const { shopId } = params;
  
      // Connect to the database
      await connectToDatabase();
  
      // Use aggregation to calculate total credit and payment from ShopKhataAccounts
      const [khataTotals] = await ShopKhataAccounts.aggregate([
        { $match: { user_id: user, shop_id: shopId } },
        {
          $group: {
            _id: null,
            totalCredit: { $sum: '$credit' },
            totalPayment: { $sum: '$payment' },
          },
        },
      ]);
  
      // Use aggregation to calculate total expense from Expense and OfficeExpense
      const [expenseTotal] = await Expense.aggregate([
        { $match: { user_id: user, shop_id: shopId } },
        { $group: { _id: null, totalExpense: { $sum: '$amount' } } },
      ]);
  
      const [officeExpenseTotal] = await OfficeExpense.aggregate([
        { $match: { user_id: user, shop_id: shopId } },
        { $group: { _id: null, totalOfficeExpense: { $sum: '$amount' } } },
      ]);
  
      // Calculate the total balance
      const totalCredit = khataTotals?.totalCredit || 0;
      const totalPayment = khataTotals?.totalPayment || 0;
      const totalExpenses = (expenseTotal?.totalExpense || 0) + (officeExpenseTotal?.totalOfficeExpense || 0);
  
      // Shop balance calculation
      const balance =   totalPayment - totalExpenses -totalCredit;
  
      return NextResponse.json({ balance, totalCredit, totalPayment, totalExpenses, status: 200 });
    } catch (error) {
      console.error(error);
      return NextResponse.json({ error, status: 500 });
    }
  }
</file>

<file path="src/app/api/shopkhata/[shopId]/accounts/route.ts">
import { recentActivity } from "@/helpers/recentActivity";
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, ExpenseSchema, OfficeExpenseSchema, ShopKhataAccountsSchema, ShopKhataSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const ShopKhataAccounts = models.ShopKhataAccounts || model('ShopKhataAccounts', ShopKhataAccountsSchema)
const ShopKhata = models.ShopKhata || model('ShopKhata', ShopKhataSchema)
const Expense = models.Expense || model('Expense', ExpenseSchema)
const OfficeExpense = models.OfficeExpense || model('OfficeExpense', OfficeExpenseSchema)

export async function POST(req: Request, { params }: { params: { shopId: string } }) {
  try {
    const { user, error } = await verifyToken(req)
    if (!user || error) {
      return NextResponse.json({ error: "Unauthorized user", status: 401 })
    }
    const { shopId } = params
    await connectToDatabase()
    const data = await req.json()
    const newkhata = new ShopKhataAccounts({
      user_id: user,
      shop_id: shopId,
      ...data
    })
    await Promise.all([newkhata.save(), recentActivity('Added Shop Payment', newkhata, user)])
    return NextResponse.json({ newkhata, status: 200 })
  } catch (error) {
    console.log(error)
    return NextResponse.json({ error, status: 500 })
  }
}

export async function GET(req: Request, { params }: { params: { shopId: string } }) {
  try {
    // Verify user token
    const { user, error } = await verifyToken(req);
    if (!user || error) {
      return NextResponse.json({ error: "Unauthorized user", status: 401 });
    }

    const { shopId } = params;

    // Connect to the database
    await connectToDatabase();

    // Fetch shop khata, expenses, and office expenses concurrently

    const shop = await ShopKhata.aggregate([
      {
        $match: {
          user_id: user,
          shop_id: shopId,
        },
      },
      {
        $lookup: {
          from: "shopkhataaccounts",
          localField: "shop_id",
          foreignField: "shop_id",
          as: "shopKhataAccounts",
        },
      },
      {
        $lookup: {
          from: "expenses",
          localField: "shop_id",
          foreignField: "shop_id",
          as: "expenses",
        },
      },
      {
        $project: {
          shopKhataAccounts: {
            $map: {
              input: "$shopKhataAccounts",
              as: "account",
              in: {
                $mergeObjects: [
                  "$$account",
                  { type: "shopKhata" }, // Add type field for shopKhataAccounts
                ],
              },
            },
          },
          expenses: {
            $map: {
              input: "$expenses",
              as: "expense",
              in: {
                $mergeObjects: [
                  "$$expense",
                  { type: "expense" }, // Add type field for expenses
                ],
              },
            },
          },
        },
      },
      {
        $project: {
          combined: {
            $concatArrays: ["$shopKhataAccounts", "$expenses"], // Combine the two arrays
          },
        },
      },
      {
        $unwind: "$combined", // Unwind the combined array for sorting
      },
      {
        $sort: { "combined.date": -1 }, // Sort by date (ascending order)
      },
      {
        $group: {
          _id: "$_id",
          combined: { $push: "$combined" }, // Group back into a single document
        },
      },
    ]);

    console.log(shop)

    // const [khata, expenses, officeExpenses] = await Promise.all([
    //   ShopKhataAccounts.find({ user_id: user, shop_id: shopId }).lean(),  // Fetch khata
    //   Expense.find({ user_id: user, shop_id: shopId }, { amount: 1, expenseType: 1, paymentMode: 1, date: 1 }).lean(),  // Fetch expenses with selected fields
    //   OfficeExpense.find({ user_id: user, shop_id: shopId }, { amount: 1, expenseType: 1, paymentMode: 1, date: 1 }).lean(),  // Fetch office expenses
    // ]);

    // // Format expenses and office expenses to match ShopKhataAccountsSchema structure
    // const formattedExpenses = expenses.map((expense) => ({
    //   user_id: user,
    //   shop_id: shopId,
    //   reason: expense.expenseType,  // Assign the expense type as the reason
    //   credit: expense.amount,       // Treat amount as credit
    //   date: expense.date,
    // }));

    // const formattedOfficeExpenses = officeExpenses.map((officeExpense) => ({
    //   user_id: user,
    //   shop_id: shopId,
    //   reason: officeExpense.expenseType,  // Assign the office expense type as the reason
    //   credit: officeExpense.amount,       // Treat amount as credit
    //   date: officeExpense.date,
    // }));

    // // Combine khata, formatted expenses, and formatted office expenses
    // const combinedData = [...khata, ...formattedExpenses, ...formattedOfficeExpenses].sort(
    //   (a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()
    // );

    return NextResponse.json({ khata : shop[0], status: 200 });
  } catch (error) {
    console.log(error);
    return NextResponse.json({ error, status: 500 });
  }
}
</file>

<file path="src/app/api/shopkhata/[shopId]/route.ts">
import {models, model} from 'mongoose'
import { connectToDatabase, ShopKhataSchema } from '@/utils/schema';
import { verifyToken } from '@/utils/auth';
import { NextResponse } from 'next/server';
import {v4 as uuidv4} from 'uuid'

const ShopKhata = models.ShopKhata || model('ShopKhata', ShopKhataSchema)

export async function GET(req : Request, {params} : {params : {shopId : string}}){
    try{
        const {user, error} = await verifyToken(req)
        if(!user || error){
            return NextResponse.json({error : "Unauthorized User", status : 401})
        }
        const {shopId} = params
        await connectToDatabase()
        const shop = await ShopKhata.findOne({user_id : user, shop_id : shopId})
        return NextResponse.json({shop, status : 200})
    }catch(error){
        console.log(error)
        return NextResponse.json({error, status : 500})
    }
}
</file>

<file path="src/app/api/shopkhata/route.ts">
import { models, model } from 'mongoose'
import { connectToDatabase, ShopKhataSchema } from '@/utils/schema';
import { verifyToken } from '@/utils/auth';
import { NextResponse } from 'next/server';
import { v4 as uuidv4 } from 'uuid'
import { recentActivity } from '@/helpers/recentActivity';

const ShopKhata = models.ShopKhata || model('ShopKhata', ShopKhataSchema)

export async function GET(req: Request) {
    try {
        const { user, error } = await verifyToken(req)
        if (!user || error) {
            return NextResponse.json({ error: "Unauthorized User", status: 401 })
        }
        await connectToDatabase()
        // const shops = await ShopKhata.find({ user_id: user })
        const shops = await ShopKhata.aggregate([
            {
                $match: { user_id: user }
            },
            {
                $lookup: {
                    from: 'shopkhataaccounts',
                    localField: 'shop_id',
                    foreignField: 'shop_id',
                    as: 'shopKhataAccounts'
                }
            },
            {
                $lookup: {
                    from: 'expenses',
                    localField: 'shop_id',
                    foreignField: 'shop_id',
                    as: 'expenses'
                }
            },

            {
                $lookup: {
                    from: 'officeexpenses',
                    localField: 'shop_id',
                    foreignField: 'shop_id',
                    as: 'officeexpenses'
                }
            },
            {
                $addFields: {
                    totalExpenses: {
                        $sum: '$expenses.amount' // Summing the total expenses amount
                    },
                    totalCredit: {
                        $sum: '$shopKhataAccounts.credit' // Summing the total credit from shopKhataAccounts
                    },
                    totalPayment: {
                        $sum: '$shopKhataAccounts.payment' // Summing the total payments from shopKhataAccounts
                    },
                    totalOfficeExpense: {
                        $sum: '$officeexpenses.amount'
                    }
                }
            },
            {
                $addFields: {
                    balance: {
                        $subtract: [
                            '$totalPayment',
                            { $add: ['$totalCredit', '$totalExpenses', '$totalOfficeExpense'] }, // Subtract total credit
                        ]
                    }
                }
            }
        ]);


        return NextResponse.json({ shops, status: 200 })
    } catch (error) {
        console.log(error)
        return NextResponse.json({ error, status: 500 })
    }
}

export async function POST(req: Request) {
    try {
        const { user, error } = await verifyToken(req)
        if (!user || error) {
            return NextResponse.json({ error: "Unauthorized User", status: 401 })
        }
        const data = await req.json()
        await connectToDatabase()
        const shopId = 'shop' + uuidv4()
        const newShop = new ShopKhata({
            shop_id: shopId,
            user_id: user,
            ...data
        })
        await Promise.all([newShop.save(), recentActivity('Added New Shop', newShop, user)])
        return NextResponse.json({ newShop, status: 200 })
    } catch (error) {
        console.log(error)
        return NextResponse.json({ error, status: 500 })
    }
}
</file>

<file path="src/app/api/suppliers/[supplierId]/payments/[paymentId]/route.ts">
import { recentActivity } from "@/helpers/recentActivity";
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, supplierAccountSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const SupplierAccount = models.SupplierAccount || model('SupplierAccount', supplierAccountSchema);

export async function DELETE(req: Request, { params }: { params: { paymentId: string } }) {
    try {
        // Verify the token and user
        const { user, error } = await verifyToken(req);
        if (!user || error) {
            return NextResponse.json({ error: 'Unauthorized', status: 401 });
        }

        // Extract the paymentId from params
        const { paymentId } = params;

        // Connect to the database
        await connectToDatabase();

        // Find and delete the SupplierAccount by paymentId
        const account = await SupplierAccount.findByIdAndDelete(paymentId);
        await recentActivity('Deleted Supplier Payment', account, user)

        // Check if the account was found and deleted
        if (!account) {
            return NextResponse.json({ error: 'Payment not found', status: 404 });
        }

        // Return the deleted account with a success status
        return NextResponse.json({ payment: account, status: 200 });
    } catch (error) {
        console.error('Error deleting payment:', error);
        // Return an internal server error status
        return NextResponse.json({ error: 'Internal Server Error', status: 500 });
    }
}
</file>

<file path="src/app/api/suppliers/[supplierId]/payments/route.ts">
import { recentActivity } from "@/helpers/recentActivity";
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, supplierAccountSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const SupplierAccount = models.SupplierAccount || model('SupplierAccount', supplierAccountSchema)

export async function POST(req: Request, { params }: { params: { supplierId: string } }) {
    try {
        const { user, error } = await verifyToken(req);
        if (!user || error) {
            return NextResponse.json({ error });
        }

        const { supplierId } = params;
        const payments = await req.json(); // Assuming the body is an array of payments
        await connectToDatabase();

        const savedPayments = [];
        for (const payment of payments) {
            const supplierAccount = new SupplierAccount({
                user_id: user, // Assuming user contains an id property
                supplier_id: supplierId,
                ...payment
            });
            const savedPayment = await supplierAccount.save();
            savedPayments.push(savedPayment);
        }
        await recentActivity('Added Supplier Payment', {
            supplier_id : supplierId
        }, user);
        return NextResponse.json({ success: true, payments: savedPayments });
    } catch (error: any) {
        console.error('Error saving supplier account:', error);
        return NextResponse.json({ error: error.message || 'Internal server error' });
    }
}


export async function GET(req: Request, { params }: { params: { supplierId: string } }) {
    try {
        const { user, error } = await verifyToken(req);
        if (!user || error) {
            return NextResponse.json({ error });
        }

        const { supplierId } = params;
        await connectToDatabase();
        const supplierAccounts = await SupplierAccount.find({user_id : user, supplier_id : supplierId}).lean()

        return NextResponse.json({ status : 200, supplierAccounts });
    } catch (error: any) {
        console.error('Error saving supplier account:', error);
        return NextResponse.json({ error: error.message || 'Internal server error' });
    }
}
</file>

<file path="src/app/api/suppliers/[supplierId]/payments/trips/[tripId]/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, supplierAccountSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const SupplierAccount = models.SupplierAccount || model('SupplierAccount', supplierAccountSchema)

export async function GET(req: Request, { params }: { params: { supplierId: string, tripId: string } }) {
    try {
        const { user, error } = await verifyToken(req);
        if (!user || error) {
            return NextResponse.json({ error });
        }

        const { supplierId, tripId } = params;
        await connectToDatabase();
        const supplierAccounts = await SupplierAccount.find({ user_id: user, supplier_id: supplierId, trip_id: tripId }).lean();

        const totalAmount = supplierAccounts.reduce((sum, account) => sum + account.amount, 0);

        return NextResponse.json({ status: 200, totalAmount, supplierAccounts });
    } catch (error: any) {
        console.error('Error saving supplier account:', error);
        return NextResponse.json({ error: error.message || 'Internal server error' });
    }
}
</file>

<file path="src/app/api/suppliers/[supplierId]/payments/trips/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, tripSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const Trip = models.Trip || model('Trip', tripSchema)

export async function GET(req : Request, {params} : {params : {supplierId : string}}) {
    const { user, error } = await verifyToken(req);
    if (error) {
      return NextResponse.json({ error });
    }
    const {supplierId} = params
    try {
      await connectToDatabase();
  
      const trips = await Trip.find({user_id : user,supplier : supplierId}).select(['trip_id','route','truckHireCost','startDate','truck']).lean().sort({ 'dates.0': -1 }).exec();
      return NextResponse.json({ trips });
    } catch (err) {
      console.error(err);
      return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 });
    }
  }
</file>

<file path="src/app/api/suppliers/[supplierId]/route.ts">
// Import necessary modules and schemas
import { connectToDatabase, supplierAccountSchema } from "@/utils/schema";
import { models, model } from 'mongoose';
import { supplierSchema } from "@/utils/schema";
import { NextResponse } from "next/server";
import { verifyToken } from "@/utils/auth";
import { recentActivity } from "@/helpers/recentActivity";

// Retrieve or define Mongoose model for Supplier
const Supplier = models.Supplier || model('Supplier', supplierSchema);
const SupplierAccount = models.SupplierAccount || model('SupplierAccount', supplierAccountSchema)
// GET request handler function
export async function GET(req: Request, { params }: { params: { supplierId: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  const { supplierId } = params;

  try {
    // Connect to the MongoDB database
    await connectToDatabase();

    // Find the supplier based on supplierId
    // const supplier = await Supplier.findOne({ user_id: user, supplier_id: supplierId }).lean();
    const suppliers = await Supplier.aggregate([
      {
        $match: { user_id: user, supplier_id: supplierId }
      },
      {
        // Lookup trucks related to the supplier and fetch necessary fields
        $lookup: {
          from: 'trucks',
          localField: 'supplier_id',
          foreignField: 'supplier',
          pipeline: [
            { $match: { user_id: user } }, // Filter trucks by user_id
            {
              $lookup: {
                from: 'drivers',
                localField: 'driver_id',
                foreignField: 'driver_id',
                pipeline: [
                  { $project: { name: 1 } } // Only get the driver name
                ],
                as: 'drivers'
              }
            },
            {
              $lookup: {
                from: 'trips',
                localField: 'truckNo',
                foreignField: 'truck',
                pipeline: [
                  { $project: { trip_id: 1, party: 1, route: 1, startDate: 1, status: 1 } }
                ],
                as: 'trips'
              }
            },
            {
              $unwind: { path: '$trips', preserveNullAndEmptyArrays: true } // Allow trucks with no trips
            },
            {
              $lookup: {
                from: 'parties',
                localField: 'trips.party',
                foreignField: 'party_id',
                pipeline: [
                  { $project: { name: 1 } } // Only get the party name
                ],
                as: 'partyDetails'
              }
            },
            {
              $unwind: { path: '$partyDetails', preserveNullAndEmptyArrays: true } // Handle trips without party data
            },
            {
              $group: {
                _id: '$_id', // Group by truck
                truckNo: { $first: '$truckNo' },
                truckType: { $first: '$truckType' },
                model: { $first: '$model' },
                capacity: { $first: '$capacity' },
                bodyLength: { $first: '$bodyLength' },
                ownership: { $first: '$ownership' },
                status: { $first: '$status' },
                driver_id: { $first: '$driver_id' },
                driverName: { $first: { $arrayElemAt: ['$drivers.name', 0] } }, // Extract driver name
                trips: {
                  $push: {
                    trip_id: '$trips.trip_id',
                    partyName: '$partyDetails.name',
                    route: '$trips.route',
                    startDate: '$trips.startDate',
                    status: '$trips.status'
                  }
                }
              }
            },
            {
              $addFields: {
                trips: { $sortArray: { input: '$trips', sortBy: { startDate: -1 } } } // Sort trips by startDate descending
              }
            },
            {
              $addFields: {
                latestTrip: { $arrayElemAt: ['$trips', 0] } // Extract the latest trip after sorting
              }
            },
            {
              $project: { trips: 0 } // Exclude trips field if only latestTrip is needed
            }
          ],
          as: 'supplierTrucks'
        }
      },
      {
        $lookup: {
          from: 'trips',
          localField: 'supplier_id',
          foreignField: 'supplier',
          as: 'supplierTrips'
        }
      },
      {
        $lookup: {
          from: 'supplieraccounts',
          localField: 'supplier_id',
          foreignField: 'supplier_id',
          as: 'supplierAccounts'
        }
      },
      {
        $addFields: {
          supplierTripAccounts: {
            $concatArrays: [
              {
                $map: {
                  input: { $ifNull: ['$supplierTrips', []] },
                  as: 'trip',
                  in: {
                    trip_id: '$$trip.trip_id',
                    supplier_id: '$$trip.supplier',
                    truckHireCost: '$$trip.truckHireCost',
                    route: '$$trip.route',
                    LR: '$$trip.LR',
                    date: '$$trip.startDate',
                    type: 'trip',
                    status: '$$trip.status',
                    truck: '$$trip.truck',
                    amount: { $ifNull: ['$$trip.truckHireCost', 0] },
                    balance: { $subtract: [0, '$$trip.truckHireCost'] }
                  }
                }
              },
              {
                $map: {
                  input: { $ifNull: ['$supplierAccounts', []] },
                  as: 'payment',
                  in: {
                    _id: '$$payment._id',
                    supplier_id: '$$payment.supplier_id',
                    date: '$$payment.date',
                    type: 'payment',
                    amount: { $ifNull: ['$$payment.amount', 0] },
                    balance: { $add: [0, '$$payment.amount'] },
                    route: {
                      $let: {
                        vars: {
                          matchedTrip: {
                            $arrayElemAt: [
                              {
                                $filter: {
                                  input: { $ifNull: ['$supplierTrips', []] },
                                  as: 'trip',
                                  cond: { $eq: ['$$trip.trip_id', '$$payment.trip_id'] }
                                }
                              },
                              0
                            ]
                          }
                        },
                        in: { $ifNull: ['$$matchedTrip.route', null] }
                      }
                    }
                  }
                }
              }
            ]
          }
        }
      },
      {
        $addFields: {
          supplierTripAccounts: {
            $sortArray: {
              input: '$supplierTripAccounts',
              sortBy: { date: 1 }
            }
          }
        }
      },
      {
        $addFields: {
          supplierTripAccounts: {
            $reduce: {
              input: '$supplierTripAccounts',
              initialValue: { balance: 0, items: [] },
              in: {
                balance: { $add: ['$$value.balance', '$$this.balance'] },
                items: {
                  $concatArrays: [
                    '$$value.items',
                    [
                      {
                        $mergeObjects: [
                          '$$this',
                          { balance: { $add: ['$$value.balance', '$$this.balance'] } }
                        ]
                      }
                    ]
                  ]
                }
              }
            }
          }
        }
      },
      {
        $project: {
          supplierTripAccounts: '$supplierTripAccounts.items',
          balance: '$supplierTripAccounts.balance',
          name: 1,
          contactNumber: 1,
          supplier_id: 1,
          supplierTrucks: 1 // Include supplierTrucks in the output
        }
      }
    ]);


    // Handle case where supplier is not found
    if (!suppliers) {
      return NextResponse.json({ message: "No supplier found" }, { status: 404 });
    }

    // Return the supplier details
    return NextResponse.json({ supplier: suppliers[0] }, { status: 200 });

  } catch (error) {
    console.error('Error fetching supplier:', error);
    return NextResponse.json({ message: "Internal Server Error" }, { status: 500 });
  }
}

export async function PATCH(req: Request, { params }: { params: { supplierId: String } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  const { supplierId } = params;
  const data = await req.json()
  const newBalance = data.truckHireCost

  try {
    await connectToDatabase()
    const supplier = await Supplier.findOne({ user_id: user, supplier_id: supplierId })
    supplier.balance = parseFloat(supplier.balance) + parseFloat(newBalance)
    await supplier.save()
    return NextResponse.json({ message: 'Balance updated successfully', balance: supplier.balance }, { status: 200 })
  } catch (error) {
    console.log(error)
    return NextResponse.json({ message: "error" }, { status: 500 })
  }
}

export async function DELETE(req: Request, { params }: { params: { supplierId: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  const { supplierId } = params;

  try {
    // Connect to the MongoDB database
    await connectToDatabase();

    // Find the supplier based on supplierId
    const supplier = await Supplier.findOneAndDelete({ user_id: user, supplier_id: supplierId }).lean();
    await SupplierAccount.deleteMany({ user_id: user, supplier_id: supplierId })

    // Handle case where supplier is not found
    if (!supplier) {
      return NextResponse.json({ message: "No supplier found" }, { status: 404 });
    }

    // Return the supplier details
    return NextResponse.json({ supplier: supplier }, { status: 200 });

  } catch (error) {
    console.error('Error fetching supplier:', error);
    return NextResponse.json({ message: "Internal Server Error" }, { status: 500 });
  }
}

export async function PUT(req: Request, { params }: { params: { supplierId: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  const { supplierId } = params;
  const data = await req.json()

  try {
    // Connect to the MongoDB database
    await connectToDatabase();

    // Find the supplier based on supplierId
    const phoneRegex = /^[789]\d{9}$/;
    if (data.contactNumber != '' && !phoneRegex.test(data.contactNumber)) {
      return NextResponse.json({ message: 'Invalid phone number' }, { status: 400 });
    }
    const supplier = await Supplier.findOneAndUpdate({ user_id: user, supplier_id: supplierId }, data).lean();
    await recentActivity('Updated Supplier Details', supplier, user)

    // Handle case where supplier is not found
    if (!supplier) {
      return NextResponse.json({ message: "No supplier found" }, { status: 404 });
    }

    // Return the supplier details
    return NextResponse.json({ supplier: supplier }, { status: 200 });

  } catch (error) {
    console.error('Error fetching supplier:', error);
    return NextResponse.json({ message: "Internal Server Error" }, { status: 500 });
  }
}
</file>

<file path="src/app/api/suppliers/route.ts">
import { NextResponse, NextRequest } from 'next/server';
import mongoose, { model, models } from 'mongoose';
import { connectToDatabase, supplierSchema } from '@/utils/schema';
import { ISupplier } from '@/utils/interface';
import { v4 as uuidv4 } from 'uuid';
import { verifyToken } from '@/utils/auth';
import { recentActivity } from '@/helpers/recentActivity';

const Supplier = models.Supplier || model('Supplier', supplierSchema);

export async function GET(req: Request) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  try {
    await connectToDatabase()

    const suppliers = await Supplier.aggregate([
      {
        $match: { user_id: user }
      },
      {
        $lookup: {
          from: 'trips',
          localField: 'supplier_id',
          foreignField: 'supplier',
          as: 'trips'
        }
      },
      {
        // Add a new field `filteredTrips` containing only trips with status 1
        $addFields: {
          filteredTrips: {
            $filter: {
              input: '$trips',
              as: 'trip',
              cond: { $lt: ['$$trip.status', 1] }
            }
          }
        }
      },
      {
        // Add another field `tripCount` which is the size of the `filteredTrips` array
        $addFields: {
          tripCount: { $size: '$filteredTrips' }
        }
      },
      {
        // Lookup the supplier account to fetch the totalAmount from SupplierAccount collection
        $lookup: {
          from: 'supplieraccounts', // Collection name
          localField: 'supplier_id',
          foreignField: 'supplier_id',
          as: 'accounts'
        }
      },
      {
        // Add a new field to sum the totalAmount from SupplierAccount collection
        $addFields: {
          totalAccountBalance: {
            $sum: '$accounts.amount'
          }
        }
      },
      {
        // Add a field to sum up the total truck hire cost from filteredTrips
        $addFields: {
          totalTruckHireCost: {
            $sum: '$trips.truckHireCost'
          }
        }
      },
      {
        // Calculate the balance (totalAccountBalance - totalTruckHireCost)
        $addFields: {
          balance: { $subtract: ['$totalAccountBalance', '$totalTruckHireCost'] }
        }
      },
      {
        $project: {
          supplier_id: 1,
          totalAccountBalance: 1,
          totalTruckHireCost: 1,
          balance: 1,
          tripCount: 1,
          name : 1,
          contactNumber : 1
        }
      }
    ]);
    
    return NextResponse.json({ suppliers }, { status: 200 });
  } catch (err) {
    console.error(err);
    return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 });
  }
}

export async function POST(req: Request) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  try {
    await connectToDatabase

    const data = await req.json();

    // Basic validation
    if (!data.name) {
      return NextResponse.json({ message: 'Missing required fields' }, { status: 400 });
    }


    const phoneRegex = /^[789]\d{9}$/;
    if (data.contactNumber != '' && !phoneRegex.test(data.contactNumber)) {
      return NextResponse.json({ message: 'Invalid phone number' }, { status: 400 });
    }


    const newSupplier: ISupplier = new Supplier({
      user_id: user,
      supplier_id: 'suppllier' + uuidv4(),
      name: data.name,
      contactNumber: data.contactNumber,
      tripCount: 0,
      balance: 0,
    });

    await Promise.all([newSupplier.save(), recentActivity('Added New Supplier', newSupplier, user)]);
    return NextResponse.json({ message: 'Saved Successfully', data: newSupplier }, { status: 200 });

  } catch (error: any) {
    console.error('Error saving party:', error);

    if (error.name === 'ValidationError') {
      return NextResponse.json({ message: 'Validation Error', details: error.message }, { status: 400 });
    } else if (error.name === 'MongoError' && error.code === 11000) {
      return NextResponse.json({ message: 'Duplicate Key Error', details: error.message }, { status: 409 });
    } else {
      return NextResponse.json({ message: 'Internal Server Error', details: error.message }, { status: 500 });
    }
  }
}
</file>

<file path="src/app/api/tripCharges/[chargeId]/route.ts">
import { recentActivity } from "@/helpers/recentActivity";
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, tripChargesSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const TripCharges = models.TripCharges || model('TripCharges', tripChargesSchema)

export async function DELETE(req: Request, { params }: { params: { chargeId: string } }) {
    await connectToDatabase();
    const {chargeId} = params
  
    try {
      const { user, error } = await verifyToken(req);
      if (!user || error) {
        return NextResponse.json({ error });
      }
      const expense = await TripCharges.findByIdAndDelete(chargeId);
      await recentActivity('Deleted Trip Charge', expense, user)
      if (!expense) {
        return NextResponse.json({ message: 'Expense not found' }, { status: 404 });
      }
      return NextResponse.json({ status: 200, charge: expense });
    } catch (error) {
      return NextResponse.json({ message: 'An error occurred while deleting the expense' }, { status: 500 });
    }
  }
</file>

<file path="src/app/api/trips/[tripId]/accounts/[accountId]/route.ts">
import { fetchBalanceBack } from "@/helpers/fetchTripBalance";
import { verifyToken } from "@/utils/auth";
import { ITrip } from "@/utils/interface";
import { connectToDatabase, tripChargesSchema, tripSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const Trip = models.Trip || model('Trip', tripSchema);

export async function DELETE(req: Request, { params }: { params: { tripId: string, accountId: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  const { tripId, accountId } = params;
  await connectToDatabase();

  try {
    // Fetch the trip
    const trip: ITrip | null = await Trip.findOne({ user_id: user, trip_id: tripId });

    // Check if trip exists
    if (!trip) {
      return NextResponse.json({ message: 'Trip not found' }, { status: 404 });
    }

    // Filter out the account to be deleted
    trip.accounts = trip.accounts.filter(acc => acc._id.toString() !== accountId);
    const TripExpense = models.TripExpense || model('TripExpense', tripChargesSchema)
    const charges = await TripExpense.find({ user_id: user, trip_id: trip.trip_id })
    const pending = await fetchBalanceBack(trip, charges)
    if (pending < 0) {
      return NextResponse.json({ message: "Balance going negative", status: 400 })
    }

    // Save the updated trip
    await trip.save();

    // Return success response
    return NextResponse.json({ trip: trip }, { status: 200 });
  } catch (error: any) {
    console.error(error);
    return NextResponse.json({ message: 'Failed to delete account', error: error.message }, { status: 500 });
  }
}


export async function PATCH(req: Request, { params }: { params: { tripId: string, accountId: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  const { tripId, accountId } = params;
  const { account } = await req.json()
  await connectToDatabase();

  try {
    // Fetch the trip
    const trip: ITrip | null = await Trip.findOne({ user_id: user, trip_id: tripId });

    // Check if trip exists
    if (!trip) {
      return NextResponse.json({ message: 'Trip not found' }, { status: 404 });
    }

    // Filter out the account to be deleted
    const index = trip.accounts.findIndex(acc => acc._id.toString() === accountId)
    trip.accounts[index] = account
    
    const TripExpense = models.TripExpense || model('TripExpense', tripChargesSchema)
    const charges = await TripExpense.find({ user_id: user, trip_id: trip.trip_id })
    const pending = await fetchBalanceBack(trip, charges)
    if (pending < 0) {
      return NextResponse.json({ message: "Balance going negative", status: 400 })
    }

    // Save the updated trip
    await trip.save();

    // Return success response
    return NextResponse.json({ trip: trip }, { status: 200 });
  } catch (error: any) {
    console.error(error);
    return NextResponse.json({ message: 'Failed to delete account', error: error.message }, { status: 500 });
  }
}
</file>

<file path="src/app/api/trips/[tripId]/documents/route.ts">
import { uploadFileToS3 } from "@/helpers/fileOperation";
import { recentActivity } from "@/helpers/recentActivity";
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, tripSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const Trip = models.Trip || model('Trip', tripSchema);

export async function GET(req: Request, { params }: { params: { tripId: string } }) {
    try {
        const { user, error } = await verifyToken(req)
        if (!user || error) {
            return NextResponse.json({ error })
        }
        const { tripId } = params
        await connectToDatabase()
        const trip = await Trip.findOne({ user_id: user, trip_id: tripId }).select(['trip_id', 'documents', 'route', 'startDate']).exec();
        return NextResponse.json({ status: 200, documents: trip.documents })
    } catch (error) {
        console.log(error)
        return NextResponse.json({ status: 500, error })
    }
}

export async function PUT(req: Request, { params }: { params: { tripId: string } }) {
    try {
        // Verify user token
        const { user, error } = await verifyToken(req);
        if (!user || error) {
            return NextResponse.json({ error: 'Unauthorized User', status: 401 });
        }

        const { tripId } = params;

        // Connect to the database
        await connectToDatabase();

        // Get form data
        const formdata = await req.formData();
        const file = formdata.get('file') as File;
        const docType = formdata.get('docType') as string;
        const validity = new Date(formdata.get('validityDate') as string) || null;
        const filename = formdata.get('filename') as string;

        // Validate form data
        if (!file || !docType || !validity) {
            return NextResponse.json({ error: 'Missing required fields', status: 400 });
        }

        // Find the trip by user and tripId
        const trip = await Trip.findOne({ user_id: user, trip_id: tripId });
        if (!trip) {
            return NextResponse.json({ error: 'Trip not found', status: 404 });
        }

        // Prepare file for upload to S3
        const fileBuffer = Buffer.from(await file.arrayBuffer());
        const fileName = `trips/${docType}-${tripId}`;
        const contentType = file.type;

        // Upload file to S3
        const s3FileName = await uploadFileToS3(fileBuffer, fileName, contentType);
        const fileUrl = `https://${process.env.AWS_S3_BUCKET_NAME}.s3.${process.env.AWS_S3_REGION}.amazonaws.com/${s3FileName}${contentType === 'application/pdf' ? '.pdf' : ''}`;

        // Check if the document type already exists in the documents array
        const existingDocIndex = trip.documents.findIndex((doc: any) => doc.type === docType);

        if (existingDocIndex !== -1) {
            // Replace the existing document with the new one
            trip.documents[existingDocIndex] = {
                filename: filename || '',
                type: docType,
                validityDate: validity,
                uploadedDate: new Date(Date.now()),
                url: fileUrl,
            };
        } else {
            // Add new document if not found
            trip.documents.push({
                filename: filename || '',
                type: docType,
                validityDate: validity,
                uploadedDate: new Date(),
                url: fileUrl,
            });
        }

        // Save the updated trip document
        await Promise.all([trip.save(), recentActivity('Added Trip Document', {
            trip_id: tripId,
            filename: filename || '',
            type: docType,
            url: fileUrl,
        }, user)]);

        // Return success response
        return NextResponse.json({ documents: trip.documents, message: 'Document uploaded successfully', status: 200 });

    } catch (error) {
        // Log the error and return server error response
        console.error("Error in uploading document:", error);
        return NextResponse.json({ error: 'Failed to upload document', status: 500 });
    }
}
</file>

<file path="src/app/api/trips/[tripId]/expenses/route.ts">
import { fetchBalanceBack } from "@/helpers/fetchTripBalance";
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, tripChargesSchema, tripSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextRequest, NextResponse } from "next/server";

// Initialize the TripExpense model
const TripCharges = models.TripCharges || model('TripCharges', tripChargesSchema);

export async function GET(req: Request, { params }: { params: { tripId: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  // Connect to the database
  await connectToDatabase();

  // Extract the tripId from the request params
  const { tripId } = params;

  try {
    // Fetch the trip expenses from the database
    const charges = await TripCharges.find({ user_id: user, trip_id: tripId }).lean();

    // Return a success response with the charges
    return NextResponse.json({ status: 200, charges });
  } catch (error) {
    // Handle any errors that occur during the process
    console.error("Error fetching trip expenses:", error);
    return NextResponse.json({ status: 500, error: "Failed to fetch trip expenses" });
  }
}


// Define the POST handler
export async function POST(req: Request, { params }: { params: { tripId: string } }) {
  // Connect to the database
  await connectToDatabase();

  // Extract the tripId from the request params
  const { tripId } = params;

  try {
    const { user, error } = await verifyToken(req);
    if (error) {
      return NextResponse.json({ error });
    }
    // Parse the request body as JSON
    const data = await req.json();

    // Create a new instance of TripExpense with the parsed data and tripId
    if(data.amount === 0 || !data.expenseType || !data.date){
      throw new Error('Please fill in the required feilds')
    }
    const newCharge = new TripCharges({
      ...data,
      trip_id: tripId,
      user_id: user
    });

    const Trip = models.Trip || model('Trip', tripSchema)
    const trip = await Trip.findOne({user_id : user, trip_id : tripId})

    const charges = await TripCharges.find({ user_id: user, trip_id: trip.trip_id })
    const pending = await fetchBalanceBack(trip, charges)
    if (pending < 0) {
      return NextResponse.json({ message: "Balance going negative", status: 400 })
    }


    // Save the new charge to the database
    await newCharge.save();

    // Return a success response with the new charge
    return NextResponse.json({ status: 200, newCharge });

  } catch (error: any) {
    // Handle any errors that occur during the process
    console.error("Error creating new trip expense:", error);
    return NextResponse.json({ status: 500, error:error.message });
  }
}

export async function PATCH(req: Request, { params }: { params: { tripId: string } }) {
  await connectToDatabase();
  const edited = await req.json();

  try {
    const { user, error } = await verifyToken(req);
    if (error) {
      return NextResponse.json({ error });
    }
    const expense = await TripCharges.findOneAndUpdate({user_id : user, _id : edited._id}, edited, { new: true });
    if (!expense) {
      return NextResponse.json({ message: 'Expense not found' }, { status: 404 });
    }
    return NextResponse.json({ status: 200, charge: expense });
  } catch (error) {
    return NextResponse.json({ message: 'An error occurred while updating the expense' }, { status: 500 });
  }
}

export async function DELETE(req: Request, { params }: { params: { tripId: string } }) {
  await connectToDatabase();
  const { id } = await req.json()

  try {
    const { user, error } = await verifyToken(req);
    if (error) {
      return NextResponse.json({ error });
    }
    const expense = await TripCharges.findOneAndDelete({user_id : user, _id : id});
    if (!expense) {
      return NextResponse.json({ message: 'Expense not found' }, { status: 404 });
    }
    return NextResponse.json({ status: 200, charge: expense });
  } catch (error) {
    return NextResponse.json({ message: 'An error occurred while deleting the expense' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/trips/[tripId]/route.ts">
import { fetchBalanceBack } from "@/helpers/fetchTripBalance";
import { uploadFileToS3 } from "@/helpers/fileOperation";
import { recentActivity } from "@/helpers/recentActivity";
import { verifyToken } from "@/utils/auth";
import { ITrip, PaymentBook } from "@/utils/interface";
import { connectToDatabase, driverSchema, ExpenseSchema, partySchema, supplierAccountSchema, tripChargesSchema, truckSchema } from "@/utils/schema";
import { tripSchema } from "@/utils/schema";
import { models, model } from 'mongoose'
import { NextResponse } from "next/server";
import { v4 as uuidv4 } from "uuid";


const Trip = models.Trip || model('Trip', tripSchema)
const TripCharges = models.TripCharges || model('TripCharges', tripChargesSchema)
const SupplierAccount = models.SupplierAccount || model('SupplierAccount', supplierAccountSchema)
const Expense = models.Expense || model('Expense', ExpenseSchema)

export async function GET(req: Request, { params }: { params: { tripId: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  const { tripId } = params;

  try {
    await connectToDatabase();

    const trips = await Trip.aggregate([
      {
        $match: {
          user_id: user,
          trip_id: tripId
        }
      },
      {
        $lookup: {
          from: 'parties',
          let: { party_id: '$party' },
          pipeline: [
            { $match: { $expr: { $eq: ['$party_id', '$$party_id'] } } },
            { $project: { name: 1 } }  // Project only the fields needed
          ],
          as: 'partyDetails'
        }
      },
      { $unwind: '$partyDetails' },  // Unwind after filtered `$lookup`
      {
        $lookup: {
          from: 'suppliers',
          let: { supplier_id: '$supplier' },
          pipeline: [
            {
              $match: {
                $expr: {
                  $and: [
                    { $eq: ['$supplier_id', '$$supplier_id'] },
                    { $ne: ['$supplier_id', null] },  // Exclude null supplier IDs
                    { $ne: ['$supplier_id', ''] }     // Exclude empty string supplier IDs
                  ]
                }
              }
            },
            { $project: { name: 1 } }
          ],
          as: 'supplierDetails'
        }
      },
      {
        $addFields: {
          supplierName: { $arrayElemAt: ['$supplierDetails.name', 0] }  // Extract supplier name
        }
      },
      {
        $lookup: {
          from: 'drivers',
          let: { driver_id: '$driver' },
          pipeline: [
            { $match: { $expr: { $eq: ['$driver_id', '$$driver_id'] } } },
            { $project: { name: 1 } },
          ],
          as: 'driverDetails',
        },
      },
      {
        $unwind: {
          path: '$driverDetails',
          preserveNullAndEmptyArrays: true, // Include documents where `driverDetails` is null or empty
        },
      },
      {
        $lookup: {
          from: 'expenses',
          let: { trip_id: '$trip_id' },
          pipeline: [
            { $match: { $expr: { $eq: ['$trip_id', '$$trip_id'] } } },
          ],
          as: 'tripExpenses'
        }
      },
      {
        $lookup: {
          from: 'tripcharges',
          let: { trip_id: '$trip_id' },
          pipeline: [
            { $match: { $expr: { $eq: ['$trip_id', '$$trip_id'] } } },
          ],
          as: 'tripCharges'
        }
      },
      {
        $lookup: {
          from: 'partypayments',
          let: { trip_id: '$trip_id' },
          pipeline: [
            { $match: { $expr: { $eq: ['$trip_id', '$$trip_id'] } } },
          ],
          as: 'tripAccounts'
        }
      },
      {
        $addFields: {
          balance: {
            $let: {
              vars: {
                accountBalance: { $sum: '$tripAccounts.amount' },
                chargeToBill: {
                  $sum: {
                    $map: {
                      input: {
                        $filter: {
                          input: '$tripCharges',
                          as: 'expense',
                          cond: { $eq: ['$$expense.partyBill', true] }
                        }
                      },
                      as: 'filteredExpense',
                      in: '$$filteredExpense.amount'
                    }
                  }
                },
                chargeNotToBill: {
                  $sum: {
                    $map: {
                      input: {
                        $filter: {
                          input: '$tripCharges',
                          as: 'expense',
                          cond: { $eq: ['$$expense.partyBill', false] }
                        }
                      },
                      as: 'filteredExpense',
                      in: '$$filteredExpense.amount'
                    }
                  }
                }
              },
              in: {
                $subtract: [
                  { $add: ['$amount', '$$chargeToBill'] },
                  { $add: ['$$accountBalance', '$$chargeNotToBill'] }
                ]
              }
            }
          },
          partyName: '$partyDetails.name',
          driverName: '$driverDetails.name'
        }
      },
      {
        $sort: { startDate: -1 }
      },
      {
        $project: {
          supplierDetails: 0,
          driverDetails: 0,
        }
      }
    ]);



    if (!trips) {
      return NextResponse.json({ message: 'Trip not found' }, { status: 404 });
    }

    return NextResponse.json({ trip: trips[0] }, { status: 200 });
  } catch (err: any) {
    console.error(err);
    return NextResponse.json({ message: 'Internal Server Error', error: err.message }, { status: 500 });
  }
}

export async function PATCH(req: Request, { params }: { params: { tripId: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  try {
    const { tripId } = params;
    const { data } = await req.json();
    console.log(data)
    const {  podImage, status, dates, notes } = data;
    // console.log(status)
    // console.log(dates)
    await connectToDatabase();


    const trip = await Trip.findOne({ user_id: user, trip_id: tripId });
    // console.log(trip)

    if (!trip) {
      return NextResponse.json({ message: 'No Trip Found' }, { status: 404 });
    }

    if (notes) {
      trip.notes = notes
    }

    if (status !== undefined && dates) {
      trip.status = status;
      trip.dates = dates;
    }

    if (podImage) {
      // Extract the MIME type and remove the Base64 prefix
      const base64String = podImage;
      const contentType = base64String.match(/^data:(.+);base64,/)[1];
      const base64Data = base64String.replace(/^data:.+;base64,/, '');

      // Convert the Base64 string to a Buffer
      const fileBuffer = Buffer.from(base64Data, 'base64');

      // Define the S3 file name
      const fileName = `trips/pod-${trip.trip_id}`;

      // Upload the file to S3
      const s3FileName = await uploadFileToS3(fileBuffer, fileName, contentType);
      const fileUrl = `https://${process.env.AWS_S3_BUCKET_NAME}.s3.${process.env.AWS_S3_REGION}.amazonaws.com/${s3FileName}${contentType === 'application/pdf' ? '.pdf' : ''}`
      trip.documents.push({
        filename: '',
        validityDate: new Date(),
        uploadedDate: new Date(),
        type: 'POD',
        url: fileUrl
      })
    }


    await trip.save();
    return NextResponse.json({ trip: trip }, { status: 200 });
  } catch (err: any) {
    console.log(err);
    return NextResponse.json({ message: err.message }, { status: 500 });
  }
}

export async function PUT(req: Request, { params }: { params: { tripId: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error }, { status: 401 });
  }

  const { tripId } = params;

  try {
    await connectToDatabase();

    // Parse and validate incoming data
    const { data } = await req.json();
    if (!data) {
      return NextResponse.json({ message: 'No data provided' }, { status: 400 });
    }

    const Truck = models.Truck || model('Truck', truckSchema);
    const Driver = models.Driver || model('Driver', driverSchema);
    const Trip = models.Trip || model('Trip', tripSchema);

    // Fetch old trip details
    const oldTrip = await Trip.findOne({ user_id: user, trip_id: tripId });
    if (!oldTrip) {
      return NextResponse.json({ message: 'Trip not found' }, { status: 404 });
    }

    // Update trip data
    const updatedTrip = await Trip.findOneAndUpdate(
      { user_id: user, trip_id: tripId },
      data,
      { new: true }
    );
    if (!updatedTrip) {
      return NextResponse.json({ message: 'Trip update failed' }, { status: 404 });
    }

    // Handle E-Way Bill validity date
    if (data.ewbValidity) {
      const eWayBillDoc = updatedTrip.documents.find((doc : any) => doc.type === 'E-Way Bill');
      if (eWayBillDoc) {
        eWayBillDoc.validityDate = new Date(data.ewbValidity);
      } else {
        updatedTrip.documents.push({
          type: 'E-Way Bill',
          validityDate: new Date(data.ewbValidity),
          filename: '',
          uploadedDate: new Date(),
          url: '',
        });
      }
    }

    // Update trip start date
    if (data.startDate) {
      updatedTrip.dates[0] = data.startDate;
    }

    // Update statuses for driver and truck
    const isTripCompleted = updatedTrip?.status > 0;

    // Handle previous driver and truck
    if (oldTrip.driver !== updatedTrip.driver && oldTrip.driver) {
      await Driver.findOneAndUpdate({ driver_id: oldTrip.driver }, { status: 'Available' });
    }
    if (oldTrip.truck !== updatedTrip.truck && oldTrip.truck) {
      await Truck.findOneAndUpdate({ truckNo: oldTrip.truck }, { status: 'Available' });
    }

    // Handle new driver and truck
    if (updatedTrip.driver) {
      await Driver.findOneAndUpdate(
        { driver_id: updatedTrip.driver },
        { status: isTripCompleted ? 'Available' : 'On Trip' }
      );
    }
    if (updatedTrip.truck) {
      await Truck.findOneAndUpdate(
        { truckNo: updatedTrip.truck },
        { status: isTripCompleted ? 'Available' : 'On Trip' }
      );
    }

    await updatedTrip.save();

    // Log recent activity
    await recentActivity('Updated Trip Details', updatedTrip, user);

    return NextResponse.json({ trip: updatedTrip, status: 200 });
  } catch (err: any) {
    console.error(err);
    return NextResponse.json({ message: 'Internal Server Error', error: err.message, status: 500 });
  }
}



export async function DELETE(req: Request, { params }: { params: { tripId: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  const { tripId } = params;
  const Truck = models.Truck || model('Truck', truckSchema);
  const Driver = models.Driver || model('Driver', driverSchema);

  try {
    await connectToDatabase();

    const trip = await Trip.findOneAndDelete({ user_id: user, trip_id: tripId }).exec();

    if (!trip) {
      return NextResponse.json({ message: 'Trip not found' }, { status: 404 });
    }

    await Truck.findOneAndUpdate({ user_id: user, truckNo: trip.truck }, { status: 'Available' })
    await Driver.findOneAndUpdate({ user_id: user, driver_id: trip.driver }, { status: 'Available' })
    await TripCharges.deleteMany({ user_id: user, trip_id: tripId })
    await Expense.deleteMany({ user_id: user, trip_id: tripId })
    await SupplierAccount.deleteMany({ user_id: user, trip_id: tripId })

    return NextResponse.json({ trip }, { status: 200 });
  } catch (err: any) {
    console.error(err);
    return NextResponse.json({ message: 'Internal Server Error', error: err.message }, { status: 500 });
  }
}
</file>

<file path="src/app/api/trips/documents/route.ts">
import { NextResponse } from 'next/server';
import { connectToDatabase, tripSchema } from '@/utils/schema';
import { model, models } from 'mongoose';
import { verifyToken } from '@/utils/auth';

const Trip = models.Trip || model('Trip', tripSchema);



export async function GET(req: Request) {
  try {
    // Verify user token
    const { user, error } = await verifyToken(req);
    if (!user || error) {
      return NextResponse.json({ error: 'Unauthorized User', status: 401 });
    }

    // Extract 'type' from query parameters
    const url = new URL(req.url);
    const documentType = url.searchParams.get('type');
    await connectToDatabase();
    // Ensure 'type' is provided
    if (!documentType) {
      return NextResponse.json({error : 'No docType provided', status : 400})
    }

    // Connect to the database
    

    // Use aggregation to filter documents directly in MongoDB
    const trips = await Trip.aggregate([
      {
        $match: { user_id: user } // Match the user_id with the user
      },
      {
        $project: {
          user_id: 1,
          trip_id: 1,
          LR: 1,
          startDate: 1,
          route : 1,
          truck : 1,
          documents: {
            $filter: {
              input: '$documents',
              as: 'document',
              cond: { $eq: ['$$document.type', documentType] }
            }
          }
        }
      },
      {
        $match: { 'documents.0': { $exists: true } } // Only return drivers with matching documents
      }
    ]);

    // Format the result to combine driver info with each document
    const formattedDocs = trips.flatMap((trip: any) =>
      trip.documents.map((doc: any) => ({
        filename: doc.filename,
        type: doc.type,
        validityDate: doc.validityDate,
        uploadedDate: doc.uploadedDate,
        url: doc.url,
        user_id: trip.user_id,
        trip_id: trip.trip_id,
        route: trip.route,
        LR: trip.LR,
        truck : trip.truck,
        startDate : trip.startDate
      }))
    );

    // Return the formatted documents
    return NextResponse.json({ documents: formattedDocs, status: 200 });

  } catch (error) {
    console.error(error);
    return NextResponse.json({ error: 'Something went wrong', status: 500 });
  }
}
</file>

<file path="src/app/api/trips/getEwaybillDetails/route.ts">
import { NextResponse } from "next/server";
import { S3Client, PutObjectCommand } from "@aws-sdk/client-s3";
import { model, models } from "mongoose";
import { tripSchema } from "@/utils/schema";
import pdf from 'pdf-parse-new';
import sharp from 'sharp'
import tesseract from 'node-tesseract-ocr';

const s3Client = new S3Client({
    region: process.env.AWS_S3_REGION,
    credentials: {
        accessKeyId: process.env.AWS_S3_ACCESS_KEY_ID!,
        secretAccessKey: process.env.AWS_S3_SECRET_ACCESS_KEY!,
    },
});

const Trip = models.Trip || model('Trip', tripSchema);


function extractTripDetails(text: string) {
    const originRegex = /From\s+.*Pincode:-\s*(\d{6})/;
    const destinationRegex = /To\s+.*Pincode:-\s*(\d{6})/;
    const startDateRegex = /Generated Date:(\d{2}\/\d{2}\/\d{4}\s+\d{2}:\d{2}\s+\w{2})/;
    const freightAmountRegex = /Total Inv\.Amt\s*(\d+\.\d{2})/;
    const truckNumberRegex = /Vehicle\s*\/\s*Trans\s*Doc\s*No\s*&\s*Dt\.\s*.*\nRoad([A-Z]{2}\d{2}[A-Z]{1,2}\d{4})/;

    const originMatch = text.match(originRegex);
    const destinationMatch = text.match(destinationRegex);
    const startDateMatch = text.match(startDateRegex);
    const freightAmountMatch = text.match(freightAmountRegex);
    const truckNumberMatch = text.match(truckNumberRegex);

    const origin = originMatch ? originMatch[1] : null;
    const destination = destinationMatch ? destinationMatch[1] : null;
    const startDate = startDateMatch ? startDateMatch[1] : null;
    const freightAmount = freightAmountMatch ? freightAmountMatch[1] : null;
    const truckNumber = truckNumberMatch ? truckNumberMatch[1] : null;

    return {
        origin,
        destination,
        startDate,
        freightAmount,
        truckNumber
    };
}

async function uploadFileToS3(fileBuffer: Buffer, fileName: string, contentType: string): Promise<string> {
    const params = {
        Bucket: process.env.AWS_S3_BUCKET_NAME!,
        Key: fileName,
        Body: fileBuffer,
        ContentType: contentType,
    };

    const command = new PutObjectCommand(params);
    await s3Client.send(command);
    return fileName;
}

async function extractValidityDate(text: string) {
    const prompt = `
                This is extracted text from pdf extract these details from it i.e origin, destination, freight amount (total invoice amount), start date(the generation date of the document), truckNo, validity date. Give all this in JSON format
    
                Extracted Text:
                ${text}

                Response Object format :
                {
                    startDate : '',
                    origin : '',
                    destination : '',
                    validity : '',
                    truckNo : '',
                }
            `;

    // Send the prompt and extracted text to the Gemini API
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${process.env.GEMINI_API_KEY}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            "contents": [{
                "parts": [{
                    "text": prompt
                }]
            }]
        })
    });
    const responseData = await res.json();
    let responseText = responseData.candidates[0].content.parts[0].text;

    // Remove extraneous characters (e.g., triple backticks, other non-JSON text)
    responseText = responseText.replace(/```json/g, '').replace(/```/g, '').trim();

    // Parse the cleaned string into a JSON object
    const jsonObject = JSON.parse(responseText);
    console.log(jsonObject)
    return jsonObject
}

// Function to extract text from a PDF using pdf-parse
async function extractTextFromPdf(buffer: Buffer): Promise<string> {
    try {
        const data = await pdf(buffer);
        console.log(extractTripDetails(data.text))
        return data.text;
    } catch (error) {
        console.error("Error extracting text from PDF:", error);
        throw new Error("Failed to extract text from PDF");
    }
}

async function preprocessImage(buffer: Buffer): Promise<Buffer> {
    const preprocessedBuffer = await sharp(buffer)
        .resize({ width: 1500 })  // Resize for better OCR accuracy
        .grayscale()  // Convert to grayscale
        .normalize()  // Normalize to enhance contrast
        .sharpen({
            sigma: 1,  // Controls the amount of blur applied before calculating the difference (higher values mean less sharpening)
            m1: 1,     // Controls the level of sharpening (mid-tone)
            m2: 0.5,   // Controls the level of sharpening (shadow area)
            x1: 2,     // Threshold below which the pixels are left unchanged
            y2: 10,    // Controls the range of sharpening applied (upper bound for adjustment)
            y3: 2      // Controls the range of sharpening applied (lower bound for adjustment)
        })
        .median(3)  // Apply median filter to reduce noise
        .threshold(180)  // Binarize the image
        .removeAlpha()  // Remove alpha channel if present
        .toBuffer();

    return preprocessedBuffer;
}

// Function to extract text from an image using node-tesseract-ocr
async function extractTextFromImage(buffer: Buffer): Promise<string> {
    const preprocessedBuffer = await preprocessImage(buffer);
    const text = await tesseract.recognize(preprocessedBuffer, {
        lang: "eng",
        psm: 3,  // Try different PSM values
        oem: 3,  // Use the best OCR Engine mode
        tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789/:', // Whitelist for known characters
    });
    return text;
}

export async function POST(request: Request) {
    try {
        const formData = await request.formData();
        const file = formData.get("file") as File;
        // const tripId = formData.get("tripId") as string;
        let ewbValidityDate = formData.get('ewbValidityDate') ? new Date(formData.get('ewbValidityDate') as string) : null;

        // if (!file || !tripId) {
        //     return NextResponse.json({ error: "File and tripId are required." }, { status: 400 });
        // }

        const fileBuffer = Buffer.from(await file.arrayBuffer());
        // const fileName = `trips/ewaybill-${tripId}`;
        const contentType = file.type;

        // If ewbValidityDate is not provided, extract it from the file
        
            if (contentType === "application/pdf") {
                // Extract text from PDF using pdf-parse
                const pdfText = await extractTextFromPdf(fileBuffer);
                ewbValidityDate = await extractValidityDate(pdfText);
            } else if (contentType.startsWith("image/")) {
                // Extract text from image using node-tesseract-ocr
                const imageText = await extractTextFromImage(fileBuffer);
                ewbValidityDate = await extractValidityDate(imageText);
            }

            // If ewbValidityDate is still null, return an error response
            if (!ewbValidityDate) {
                return NextResponse.json({
                    success: false,
                    message: "Failed to extract validity date. Please enter it manually.",
                });
            }
        

        // Upload the file to S3
        // const s3FileName = await uploadFileToS3(fileBuffer, fileName, contentType);
        // const fileUrl = `https://${process.env.AWS_S3_BUCKET_NAME}.s3.${process.env.AWS_S3_REGION}.amazonaws.com/${s3FileName}${contentType === 'application/pdf' ? '.pdf' : ''}`;

        // Update the Trip document with the E-Way Bill URL and validity date
        // const trip = await Trip.findOneAndUpdate(
        //     { trip_id: tripId },
        //     { ewayBill: fileUrl, ewbValidityDate },
        //     { new: true }
        // );

        return NextResponse.json({ success: true, ewbValidityDate });
    } catch (error) {
        console.error("Error uploading e-way bill:", error);
        return NextResponse.json({ error: "Failed to upload e-way bill." }, { status: 500 });
    }
}
</file>

<file path="src/app/api/trips/getEwaybillDetails/text/route.ts">
import { extractEWayBillDetails } from "@/helpers/TripOperation";
import { verifyToken } from "@/utils/auth";
import { NextResponse } from "next/server";

export async function POST(req:Request) {
    try {
        const {user, error} = await verifyToken(req)
        if(!user || error){
            return NextResponse.json({error : 'Unauthorized User', status : 401})
        }
        const text = await req.text()
        const ewaybillDetails = await extractEWayBillDetails(text)
        return NextResponse.json({success : true,ewbValidityDate :  ewaybillDetails, status : 200})
    } catch (error) {
        console.log(error)
        return NextResponse.json({error : 'Internal Server Error', status : 500})
    }
}
</file>

<file path="src/app/api/trips/invoice/download/route.ts">
import { verifyToken } from "@/utils/auth";
import { PartyPaymentSchema, tripChargesSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const TripCharges = models.TripCharges || model("TripCharges", tripChargesSchema);
const PartyPayments = models.PartyPayments || model("PartyPayments", PartyPaymentSchema);

export async function POST(req: Request) {
  try {
    const { user, error } = await verifyToken(req);
    if (!user || error) {
      return NextResponse.json({ error: "Unauthorized User" }, { status: 401 });
    }

    const data = await req.json();
    console.log(data)
    const {
      editedPayments,
      editedCharges,
      deletedChargeIds,
      deletedPaymentIds,
      newPayments,
      newCharges,
    } = data;

    const bulkOperations: Promise<any>[] = [];

    // Handle Edited Payments
    if (editedPayments && editedPayments.length > 0) {
      const paymentUpdates = editedPayments.map((payment: any) => ({
        updateOne: {
          filter: { _id: payment.id },
          update: { $set: payment },
        },
      }));
      bulkOperations.push(PartyPayments.bulkWrite(paymentUpdates));
    }

    // Handle Edited Charges
    if (editedCharges && editedCharges.length > 0) {
      const chargeUpdates = editedCharges.map((charge: any) => ({
        updateOne: {
          filter: { _id: charge._id },
          update: { $set: charge },
        },
      }));
      bulkOperations.push(TripCharges.bulkWrite(chargeUpdates));
    }

    // Handle Deleted Payments
    if (deletedPaymentIds && deletedPaymentIds.length > 0) {
      bulkOperations.push(PartyPayments.deleteMany({ _id: { $in: deletedPaymentIds } }));
    }

    // Handle Deleted Charges
    if (deletedChargeIds && deletedChargeIds.length > 0) {
      bulkOperations.push(TripCharges.deleteMany({ _id: { $in: deletedChargeIds } }));
    }

    // Handle New Payments
    if (newPayments && newPayments.length > 0) {
      const payments = newPayments.map((payment : any)=>({
        user_id : user,
        ...payment
      }))
      bulkOperations.push(PartyPayments.insertMany(payments));
    }

    // Handle New Charges
    if (newCharges && newCharges.length > 0) {
      const charges = newCharges.map((charge : any)=>({
        user_id : user,
        ...charge
      }))
      bulkOperations.push(TripCharges.insertMany(charges));
    }

    // Execute All Bulk Operations
    const results = await Promise.all(bulkOperations);

    return NextResponse.json(
      { message: "Operations successful", results },
      { status: 200 }
    );
  } catch (error : any) {
    console.error("Error handling request:", error);
    return NextResponse.json(
      { error: "Internal Server Error", details: error.message },
      { status: 500 }
    );
  }
}
</file>

<file path="src/app/api/trips/invoice/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, InvoiceSchema, tripSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const Trip = models.Trip || model('Trip', tripSchema)
const Invoice = models.Invoice || model('Invoice', InvoiceSchema)


export async function GET(req: Request) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }

  const url = new URL(req.url)
  const reqTrips = JSON.parse(url.searchParams.get('trips') as string)
  console.log(reqTrips)

  try {
    await connectToDatabase();

    const trips = await Trip.aggregate([
      {
        $match: {
          user_id: user,
          trip_id: { $in: reqTrips }
        }
      },
      {
        $lookup: {
          from: 'parties',
          let: { party_id: '$party' },
          pipeline: [
            { $match: { $expr: { $eq: ['$party_id', '$$party_id'] } } },
            { $project: { name: 1, address : 1 } }  // Project only the fields needed
          ],
          as: 'partyDetails'
        }
      },
      { $unwind: '$partyDetails' },  // Unwind after filtered `$lookup`
      {
        $lookup: {
          from: 'suppliers',
          let: { supplier_id: '$supplier' },
          pipeline: [
            {
              $match: {
                $expr: {
                  $and: [
                    { $eq: ['$supplier_id', '$$supplier_id'] },
                    { $ne: ['$supplier_id', null] },  // Exclude null supplier IDs
                    { $ne: ['$supplier_id', ''] }     // Exclude empty string supplier IDs
                  ]
                }
              }
            },
            { $project: { name: 1 } }
          ],
          as: 'supplierDetails'
        }
      },
      {
        $addFields: {
          supplierName: { $arrayElemAt: ['$supplierDetails.name', 0] }  // Extract supplier name
        }
      },
      {
        $lookup: {
          from: 'drivers',
          let: { driver_id: '$driver' },
          pipeline: [
            { $match: { $expr: { $eq: ['$driver_id', '$$driver_id'] } } },
            { $project: { name: 1 } }
          ],
          as: 'driverDetails'
        }
      },
      { $unwind: '$driverDetails' },  // Unwind after filtered `$lookup`
      {
        $lookup: {
          from: 'expenses',
          let: { trip_id: '$trip_id' },
          pipeline: [
            { $match: { $expr: { $eq: ['$trip_id', '$$trip_id'] } } },
          ],
          as: 'tripExpenses'
        }
      },
      {
        $lookup: {
          from: "tripcharges",
          let: { trip_id: "$trip_id" },
          pipeline: [
            {
              $match: {
                $expr: { $eq: ["$trip_id", "$$trip_id"] },
                partyBill: true
              }
            }
          ],
          as: "tripCharges"
        }
      },
      {
        $lookup: {
          from: 'partypayments',
          let: { trip_id: '$trip_id' },
          pipeline: [
            { $match: { $expr: { $eq: ['$trip_id', '$$trip_id'] } } },
          ],
          as: 'tripAccounts'
        }
      },
      {
        $addFields: {
          balance: {
            $let: {
              vars: {
                accountBalance: { $sum: '$tripAccounts.amount' },
                chargeToBill: {
                  $sum: {
                    $map: {
                      input: {
                        $filter: {
                          input: '$tripCharges',
                          as: 'expense',
                          cond: { $eq: ['$$expense.partyBill', true] }
                        }
                      },
                      as: 'filteredExpense',
                      in: '$$filteredExpense.amount'
                    }
                  }
                },
                chargeNotToBill: {
                  $sum: {
                    $map: {
                      input: {
                        $filter: {
                          input: '$tripCharges',
                          as: 'expense',
                          cond: { $eq: ['$$expense.partyBill', false] }
                        }
                      },
                      as: 'filteredExpense',
                      in: '$$filteredExpense.amount'
                    }
                  }
                }
              },
              in: {
                $subtract: [
                  { $add: ['$amount', '$$chargeToBill'] },
                  { $add: ['$$accountBalance', '$$chargeNotToBill'] }
                ]
              }
            }
          },
          partyName: '$partyDetails.name',
          driverName: '$driverDetails.name'
        }
      },
      {
        $sort: { startDate: -1 }
      },
      {
        $project: {
          supplierDetails: 0,
          driverDetails: 0,
        }
      }
    ]);



    if (!trips) {
      return NextResponse.json({ message: 'Trip not found' }, { status: 404 });
    }

    return NextResponse.json({ trips: trips }, { status: 200 });
  } catch (err: any) {
    console.error(err);
    return NextResponse.json({ message: 'Internal Server Error', error: err.message }, { status: 500 });
  }
}
</file>

<file path="src/app/api/trips/party/[partyId]/accounts/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, tripSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const Trip = models.Trip || model('Trip', tripSchema);

export async function GET(req: Request, { params }: { params: { driverId: string, partyId: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }

  try {
    const { partyId } = params;
    await connectToDatabase();

    const accounts = await Trip.aggregate([
      { $match: { user_id: user, party: partyId } },
      { $unwind: "$accounts" },
      { $sort: { "dates.0": -1 } },
      { $project: { 
          _id: 0, 
          account: "$accounts",
          trip_id: "$trip_id" 
      }},
      { $replaceRoot: { newRoot: { $mergeObjects: ["$account", { trip_id: "$trip_id" }] } } },// Optional: filter accounts received by driver
    ]);

    return NextResponse.json({ accounts });
  } catch (err) {
    console.error(err);
    return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/trips/party/[partyId]/route.ts">
import { NextResponse } from 'next/server';
import mongoose from 'mongoose';
import { connectToDatabase, tripSchema, partySchema } from '@/utils/schema';
import { verifyToken } from '@/utils/auth';

const Trip = mongoose.models.Trip || mongoose.model('Trip', tripSchema);
const Party = mongoose.models.Party || mongoose.model('Party', partySchema);

export async function GET(request: Request, { params }: { params: { partyId: string } }) {
  const { user, error } = await verifyToken(request);
  if (error) {
    return NextResponse.json({ error }, { status: 401 });
  }

  try {
    await connectToDatabase();

    const { partyId } = params;
    const trips = await Trip.aggregate([
      { 
        $match: { 
          user_id: user, 
          party: partyId 
        } 
      }, // Filter trips based on user_id and partyId
      {
        $lookup: {
          from: 'parties', // Join with the Party collection
          localField: 'party',
          foreignField: 'party_id',
          as: 'partyDetails'
        }
      },
      { $unwind: '$partyDetails' }, // Unwind partyDetails array
      {
        $lookup: {
          from: 'tripcharges', // Join with the TripExpense collection
          localField: 'trip_id',
          foreignField: 'trip_id',
          as: 'tripExpenses'
        }
      },
      {
        $addFields: {
          // Calculate the final balance based on the fetchBalance logic
          balance: {
            $let: {
              vars: {
                accountBalance: {
                  $sum: {
                    $map: {
                      input: '$accounts',
                      as: 'account',
                      in: '$$account.amount'
                    }
                  }
                },
                chargeToBill: {
                  $sum: {
                    $filter: {
                      input: '$tripExpenses',
                      as: 'expense',
                      cond: { $eq: ['$$expense.partyBill', true] }
                    }
                  }
                },
                chargeNotToBill: {
                  $sum: {
                    $filter: {
                      input: '$tripExpenses',
                      as: 'expense',
                      cond: { $eq: ['$$expense.partyBill', false] }
                    }
                  }
                }
              },
              in: {
                $subtract: [
                  { $add: ['$amount', '$$chargeToBill'] },  // Add trip amount and chargeToBill
                  { $add: ['$$accountBalance', '$$chargeNotToBill'] }  // Subtract accountBalance and chargeNotToBill
                ]
              }
            }
          },
          revenue: {
            $let: {
                vars: {
                    accountBalance: {
                        $sum: {
                            $map: {
                                input: '$accounts',
                                as: 'account',
                                in: '$$account.amount'
                            }
                        }
                    }
                },
                in: { $add: ['$amount', '$$accountBalance'] }  // Add trip amount and account balance
            }
        },
          // Include the party name from the joined partyDetails
          partyName: '$partyDetails.name'
        }
      },
      { 
        $project: {
          trip_id: 1,
          startDate: 1,
          truck: 1,
          route: 1,
          truckHireCost: 1,
          status: 1,
          balance: 1, // Include the calculated balance
          partyName: 1,
          LR : 1, // Include the party name,
          revenue : 1
        } 
      }
    ]);
    

    return NextResponse.json({ trips });
  } catch (err) {
    console.error('Error fetching trips:', err);
    return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/trips/supplier/[supplierId]/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, supplierSchema, tripSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const Supplier = models.Supplier || model('Supplier', supplierSchema)
const Trip = models.Trip || model('Trip', tripSchema)

export async function GET(req: Request, params: { params: { supplierId: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  const { supplierId } = params.params;

  try {
    // Connect to the MongoDB database
    await connectToDatabase();

    // Find the supplier based on supplierId
    const trips = await Trip.aggregate([
      { $match: {user_id : user, supplier : supplierId} },  // Filter trips based on user_id and optional statuses
      {
        $lookup: {
          from: 'parties',  // Join with the Party collection
          localField: 'party',
          foreignField: 'party_id',
          as: 'partyDetails'
        }
      },
      { $unwind: '$partyDetails' },  // Unwind partyDetails array
      {
        $lookup: {
          from: 'tripcharges',  // Join with the TripExpense collection
          localField: 'trip_id',
          foreignField: 'trip_id',
          as: 'tripExpenses'
        }
      },
      {
        $addFields: {
          // Calculate the final balance based on the fetchBalance logic
          balance: {
            $let: {
              vars: {
                accountBalance: {
                  $sum: {
                    $map: {
                      input: '$accounts',
                      as: 'account',
                      in: '$$account.amount'
                    }
                  }
                },
                chargeToBill: {
                  $sum: {
                    $map: {
                      input: {
                        $filter: {
                          input: '$tripExpenses',
                          as: 'expense',
                          cond: { $eq: ['$$expense.partyBill', true] }
                        }
                      },
                      as: 'filteredExpense',
                      in: '$$filteredExpense.amount'
                    }
                  }
                },
                chargeNotToBill: {
                  $sum: {
                    $map: {
                      input: {
                        $filter: {
                          input: '$tripExpenses',
                          as: 'expense',
                          cond: { $eq: ['$$expense.partyBill', false] }
                        }
                      },
                      as: 'filteredExpense',
                      in: '$$filteredExpense.amount'
                    }
                  }
                }
              },
              in: {
                $subtract: [
                  { $add: ['$amount', '$$chargeToBill'] },  // Add trip amount and chargeToBill
                  { $add: ['$$accountBalance', '$$chargeNotToBill'] }  // Subtract accountBalance and chargeNotToBill
                ]
              }
            }
          },
          // Include the party name from the joined partyDetails
          partyName: '$partyDetails.name'
        }
      },  // Sort by startDate in descending order
      // Exclude unnecessary fields including accountBalance, chargeToBill, and chargeNotToBill
      {
        $project: {
          'party': 1,
          'partyName': 1,
          'trip_id': 1,
          'startDate': 1,
          'truck': 1,
          'truckHireCost': 1,
          'status': 1, // Include the calculated balance
          'partyBalance': 1,
          'route' : 1 ,
          'balance' : 1// Include party balance if required
          // Exclude fields you don't need
        }
      }
    ]);
    // Handle case where supplier is not found
    if (!trips) {
      return NextResponse.json({ message: "No trips found" }, { status: 404 });
    }

    // Return the supplier details
    return NextResponse.json({ trips: trips }, { status: 200 });

  } catch (error) {
    console.error('Error fetching supplier:', error);
    return NextResponse.json({ message: "Internal Server Error" }, { status: 500 });
  }
}
</file>

<file path="src/app/api/trips/truck/[truckNo]/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, tripSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const Trip = models.Trip || model('Trip', tripSchema)

export async function GET(req: Request, { params }: { params: { truckNo: string } }) {
    const { user, error } = await verifyToken(req);
    if (error) {
        return NextResponse.json({ error });
    }
    try {
        const { truckNo } = params;
        await connectToDatabase();

        const trips = await Trip.aggregate([
            { $match: { user_id: user, truck: truckNo } },  // Filter trips based on user_id and truckNo
            {
                $lookup: {
                    from: 'parties',  // Join with the Party collection
                    localField: 'party',
                    foreignField: 'party_id',
                    as: 'partyDetails'
                }
            },
            { $unwind: '$partyDetails' },  // Unwind partyDetails array
            {
                $lookup: {
                    from: 'tripcharges',  // Join with the TripExpense collection
                    localField: 'trip_id',
                    foreignField: 'trip_id',
                    as: 'tripExpenses'
                }
            },
            {
                $addFields: {
                    // Calculate the final balance based on the fetchBalance logic
                    balance: {
                        $let: {
                            vars: {
                                accountBalance: {
                                    $sum: {
                                        $map: {
                                            input: '$accounts',
                                            as: 'account',
                                            in: '$$account.amount'
                                        }
                                    }
                                },
                                chargeToBill: {
                                    $sum: {
                                        $map: {
                                            input: {
                                                $filter: {
                                                    input: '$tripExpenses',
                                                    as: 'expense',
                                                    cond: { $eq: ['$$expense.partyBill', true] }
                                                }
                                            },
                                            as: 'filteredExpense',
                                            in: '$$filteredExpense.amount'
                                        }
                                    }
                                },
                                chargeNotToBill: {
                                    $sum: {
                                        $map: {
                                            input: {
                                                $filter: {
                                                    input: '$tripExpenses',
                                                    as: 'expense',
                                                    cond: { $eq: ['$$expense.partyBill', false] }
                                                }
                                            },
                                            as: 'filteredExpense',
                                            in: '$$filteredExpense.amount'
                                        }
                                    }
                                }
                            },
                            in: {
                                $subtract: [
                                    { $add: ['$amount', '$$chargeToBill'] },  // Add trip amount and chargeToBill
                                    { $add: ['$$accountBalance', '$$chargeNotToBill'] }  // Subtract accountBalance and chargeNotToBill
                                ]
                            }
                        }
                    },
                    // Corrected revenue calculation: Add the trip amount and account balance
                    revenue: {
                        $let: {
                            vars: {
                                accountBalance: {
                                    $sum: {
                                        $map: {
                                            input: '$accounts',
                                            as: 'account',
                                            in: '$$account.amount'
                                        }
                                    }
                                }
                            },
                            in: { $add: ['$amount', '$$accountBalance'] }  // Add trip amount and account balance
                        }
                    },
                    // Include the party name from the joined partyDetails
                    partyName: '$partyDetails.name'
                }
            },  // Sort by startDate in descending order
            // Exclude unnecessary fields
            {
                $project: {
                    startDate: 1,
                    LR: 1,
                    partyName: 1,
                    route: 1,
                    status: 1,
                    balance: 1,
                    revenue: 1
                }
            }
        ]);

        return NextResponse.json({ trips });
    } catch (err) {
        console.error(err);
        return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 });
    }
}
</file>

<file path="src/app/api/trucks/[truckNo]/documents/route.ts">
import { uploadFileToS3 } from "@/helpers/fileOperation";
import { recentActivity } from "@/helpers/recentActivity";
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, truckSchema, } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const Truck = models.Truck || model('Truck', truckSchema)

export async function GET(req: Request, { params }: { params: { truckNo: string } }) {
    try {
        const { user, error } = await verifyToken(req)
        if (!user || error) {
            return NextResponse.json({ error })
        }
        const { truckNo } = params
        await connectToDatabase()
        const truck = await Truck.findOne({ user_id: user, truckNo: truckNo }).select(['truckNo', 'documents']).exec();

        return NextResponse.json({ status: 200, documents: truck.documents })
    } catch (error) {
        console.log(error)
        return NextResponse.json({ status: 500, error })
    }
}

export async function PUT(req: Request, { params }: { params: { truckNo: string } }) {
    try {
        // Verify user token
        const { user, error } = await verifyToken(req);
        if (!user || error) {
            return NextResponse.json({ error: 'Unauthorized User', status: 401 });
        }

        const { truckNo } = params;

        // Connect to the database
        await connectToDatabase();

        // Get form data
        const formdata = await req.formData();
        const file = formdata.get('file') as File;
        const docType = formdata.get('docType') as string;
        const validity = new Date(formdata.get('validityDate') as string);
        const filename = formdata.get('filename') as string;

        // Validate form data
        if (!file || !docType || !validity) {
            return NextResponse.json({ error: 'Missing required fields', status: 400 });
        }

        // Find the trip by user and tripId
        const truck = await Truck.findOne({ user_id: user, truckNo: truckNo });
        console.log(truck)
        if (!truck) {
            return NextResponse.json({ error: 'Truck not found', status: 404 });
        }

        // Prepare file for upload to S3
        const fileBuffer = Buffer.from(await file.arrayBuffer());
        const fileName = `trucks/${truckNo}/${docType}`;
        const contentType = file.type;

        // Upload file to S3
        const s3FileName = await uploadFileToS3(fileBuffer, fileName, contentType);
        const fileUrl = `https://${process.env.AWS_S3_BUCKET_NAME}.s3.${process.env.AWS_S3_REGION}.amazonaws.com/${s3FileName}${contentType === 'application/pdf' ? '.pdf' : ''}`;

        // Check if the document type already exists in the documents array
        const existingDocIndex = truck.documents.findIndex((doc: any) => doc.type === docType);

        let document
        if (existingDocIndex !== -1) {
            // Replace the existing document with the new one
            truck.documents[existingDocIndex] = {
                filename: filename || '',
                type: docType,
                validityDate: validity,
                uploadedDate: new Date(Date.now()),
                url: fileUrl,
            };
            document = truck.documents[existingDocIndex];
        } else {
            // Add new document if not found
            truck.documents.unshift({
                filename: filename || '',
                type: docType,
                validityDate: validity,
                uploadedDate: new Date(),
                url: fileUrl,
            });
            document = truck.documents[0]
        }

        // Save the updated trip document

        await Promise.all([truck.save(), recentActivity('Added Truck Document', {
            truckNo: truckNo,
            filename: filename || '',
            type: docType,
            url: fileUrl,
        }, user)]);

        // Return success response
        return NextResponse.json({ message: 'Document uploaded successfully', status: 200 , document});

    } catch (error) {
        // Log the error and return server error response
        console.error("Error in uploading document:", error);
        return NextResponse.json({ error: 'Failed to upload document', status: 500 });
    }
}
</file>

<file path="src/app/api/trucks/[truckNo]/expense/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, ExpenseSchema } from "@/utils/schema";
import { NextResponse } from "next/server";
import { maintenanceChargeTypes } from "@/utils/utilArray";
import { model, models } from "mongoose";

const Expense = models.Expense || model('Expense', ExpenseSchema)

export async function GET(req: Request, { params }: { params: { truckNo: string } }) {
  const { truckNo } = params;
  const url = new URL(req.url);
  const expenseType = url.searchParams.get('type');
  const { user, error } = await verifyToken(req);

  if (error) {
    return NextResponse.json({ error }, { status: 401 });
  }

  await connectToDatabase();

  try {
    let filter : any= { user_id: user, truck: truckNo };
    
    if (expenseType === 'fuel') {
      filter = { ...filter, expenseType: 'Fuel Expense' };
    } else if (expenseType === 'maintenance') {
      filter = { ...filter, expenseType: { $in: Array.from(maintenanceChargeTypes) } };
    } else if (expenseType === 'other') {
      filter = { ...filter, expenseType: { $nin: Array.from(maintenanceChargeTypes) } };
    }

    const expenses = await Expense.aggregate([
      {
        $match : filter
      },
      {
        $lookup : {
          from : 'trips',
          localField : 'trip_id',
          foreignField : 'trip_id',
          as : 'trips'
        }
      },
      {
        $lookup : {
          from : 'drivers',
          localField : 'driver',
          foreignField : 'driver_id',
          as : 'drivers'
        }
      },
      {
        $addFields : {
          tripRoute : { $arrayElemAt : ['$trips.route', 0] },
          driverName : { $ifNull : [{ $arrayElemAt : ['$drivers.name', 0] }, 'N/A'] }
        }
      },{
        $project : {
          trips : 0
        }
      },
      {
        $sort : { date : -1 }
      }
    ]);
    return NextResponse.json({expenses , status : 200});
  } catch (error: any) {
    console.log(error);
    return NextResponse.json({ message: error.message, status: 500 });
  }
}
</file>

<file path="src/app/api/trucks/[truckNo]/route.ts">
import { NextResponse } from 'next/server';// Ensure to import Request from 'express' or another appropriate package
import { connectToDatabase, ExpenseSchema, tripSchema, truckSchema } from '@/utils/schema';
import { TruckModel } from '@/utils/interface';
import mongoose, { model, Model, models } from 'mongoose';
import { verifyToken } from '@/utils/auth';
import { recentActivity } from '@/helpers/recentActivity';

const Truck = mongoose.models.Truck || mongoose.model<TruckModel>('Truck', truckSchema);
const Trip = models.Trip || model('Trip', tripSchema)
const Expense = models.Expense || model('Expense', ExpenseSchema)

export async function PATCH(req: Request, { params }: { params: { truckNo: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  try {
    const { truckNo } = params;
    const { status } = await req.json(); // Assuming 'status' is in the body of the PATCH request

    await connectToDatabase(); // Ensure this function is properly defined and imported

    const truck = await Truck.findOne({ user_id: user, truckNo: truckNo });

    if (!truck) {
      return NextResponse.json({ message: 'No Truck Found' }, { status: 404 });
    }

    if (status) truck.status = status;

    await truck.save();

    return NextResponse.json({ truck: truck }, { status: 200 });
  } catch (err: any) {
    return NextResponse.json({ message: err.message }, { status: 500 });
  }
}


export async function PUT(req: Request, { params }: { params: { truckNo: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error }, { status: 401 });
  }

  try {
    const { truckNo } = params;
    const data = await req.json();


    await connectToDatabase();

    const truck = await Truck.findOneAndUpdate({ user_id: user, truckNo }, data, { new: true });

    if (!truck) {
      return NextResponse.json({ message: 'No Truck Found' }, { status: 404 });
    }

    const trips = await Trip.updateMany({ user_id: user, truck: truckNo }, { $set: { truck: data.truckNo } });


    // Update the truck number in the Expense collection
    const [updatedExpenses, un] = await Promise.all([Expense.updateMany(
      { user_id: user, truck: truckNo }, // Query to find matching documents with the old truck number
      { $set: { truck: data.truckNo } }  // Update operation to set the new truck number
    ), recentActivity('Updated Lorry Details', truck, user)]);

    return NextResponse.json({ truck, status: 200 });
  } catch (err: any) {
    return NextResponse.json({ message: err.message }, { status: 500 });
  }
}

export async function GET(req: Request, { params }: { params: { truckNo: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  try {
    const { truckNo } = params;// Assuming 'status' is in the body of the PATCH request

    await connectToDatabase(); // Ensure this function is properly defined and imported

    const truck = await Truck.aggregate([
      {
        $match: {
          user_id: user,
          truckNo: truckNo
        }
      },
      {
        $lookup: {
          from: 'suppliers',
          let: { supplier_id: '$supplier' },
          pipeline: [
            {
              $match: {
                $expr: {
                  $and: [
                    { $eq: ['$supplier_id', '$$supplier_id'] },
                    { $ne: ['$supplier_id', null] },  // Exclude null supplier IDs
                    { $ne: ['$supplier_id', ''] }     // Exclude empty string supplier IDs
                  ]
                }
              }
            },
            { $project: { name: 1 } }
          ],
          as: 'supplierDetails'
        }
      },
      {
        $addFields: {
          supplierName: { $arrayElemAt: ['$supplierDetails.name', 0] }  // Extract supplier name
        }
      },
      {
        $lookup: {
          from: 'trips',
          let: { truckNo: '$truckNo', userId: user },
          pipeline: [
            {
              $match: {
                $expr: {
                  $and: [
                    { $eq: ['$truck', '$$truckNo'] },
                    { $eq: ['$user_id', '$$userId'] }
                  ]
                }
              }
            }
          ],
          as: 'trips'
        }
      },
      {
        $lookup: {
          from: 'expenses',
          let: { truckNo: '$truckNo', userId: user},
          pipeline: [
            {
              $match: {
                $expr: {
                  $and: [
                    { $eq: ['$truck', '$$truckNo'] },
                    { $eq: ['$user_id', '$$userId'] }
                  ]
                }
              }
            }
          ],
          as: 'expenses'
        }
      },
      
      // Perform lookup to add partyName from 'parties' collection to each trip
      {
        $lookup: {
          from: 'parties',
          localField: 'trips.party',    // Use the party_id field from trips
          foreignField: 'party_id',             // Use the _id field from parties
          as: 'partyDetails'
        }
      },
      {
        $unwind: { path: '$partyDetails', preserveNullAndEmptyArrays: true } // Unwind to access party details
      },
      // Add tripRevenue to trips and rename startDate to date for uniform sorting
      {
        $addFields: {
          trips: {
            $map: {
              input: '$trips',
              as: 'trip',
              in: {
                $mergeObjects: [
                  '$$trip',
                  {
                    tripRevenue: {
                      $add: [
                        '$$trip.amount',
                        {
                          $reduce: {
                            input: '$$trip.accounts',
                            initialValue: 0,
                            in: {
                              $cond: [
                                { $eq: ['$$this.partyBill', true] },
                                { $add: ['$$value', '$$this.amount'] },
                                '$$value'
                              ]
                            }
                          }
                        }
                      ]
                    },
                    date: '$$trip.startDate',  // Rename startDate to date
                    partyName: '$partyDetails.name',  // Add partyName from lookup
                    type: 'trip'
                  }
                ]
              }
            }
          }
        }
      },
      // Combine trips and expenses into truckLedger array
      {
        $addFields: {
          truckLedger: { $concatArrays: ['$trips', '$expenses'] }
        }
      },
      // Sort the combined truckLedger array by date
      {
        $addFields: {
          truckLedger: { $sortArray: { input: '$truckLedger', sortBy: { date: -1 } } }  // 1 for ascending
        }
      },
      // Optionally project to return only necessary fields
      {
        $project: {
          trips: 0,      // Optionally exclude original trips
          expenses: 0,   // Optionally exclude original expenses
          // Include other fields if necessary
        }
      }
    ]);


    if (!truck) {
      return NextResponse.json({ message: 'No Truck Found' }, { status: 404 });
    }

    return NextResponse.json({ truck: truck[0] }, { status: 200 });
  } catch (err: any) {
    return NextResponse.json({ message: err.message }, { status: 500 });
  }
}

export async function DELETE(req: Request, { params }: { params: { truckNo: string } }) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  try {
    const { truckNo } = params;// Assuming 'status' is in the body of the PATCH request

    await connectToDatabase(); // Ensure this function is properly defined and imported

    const foundTruck = await Truck.findOne({ user_id: user, truckNo: truckNo });
    if (foundTruck.status == 'On Trip') {
      return NextResponse.json({ message: "Truck currently on Trip", status: 400 })
    }

    const trips = await Trip.find({ user_id: user, truck: truckNo });

    if (trips.length > 0) {
      const tripDetails = trips.map((trip) => {
        const origin = trip.route.origin;
        const destination = trip.route.destination;
        return `${origin} -> ${destination} ${new Date(trip.startDate).toISOString().split('T')[0]}`;
      }).join(', ');

      return NextResponse.json({
        message: `Truck is associated with trips:\n ${tripDetails}`,
        status: 400
      });
    }
    const truck = await Truck.findOneAndDelete({ user_id: user, truckNo: truckNo });

    if (!truck) {
      return NextResponse.json({ message: 'No Truck Found' }, { status: 404 });
    }

    return NextResponse.json({ truck: truck }, { status: 200 });
  } catch (err: any) {
    return NextResponse.json({ message: err.message }, { status: 500 });
  }
}
</file>

<file path="src/app/api/trucks/[truckNo]/summary/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, ExpenseSchema, tripSchema, tripChargesSchema } from "@/utils/schema";
import { model, models, Schema } from "mongoose";
import { NextResponse } from "next/server";

// Define models if not already defined
const Trip = models.Trip || model('Trip', tripSchema);
const Expense = models.Expense || model('Expense', ExpenseSchema);
const TripCharge = models.TripCharge || model('TripCharge', tripChargesSchema);

export async function GET(req: Request, {params} : {params : {truckNo : string}}) {
  const { user, error } = await verifyToken(req);
  if (!user || error) {
    return NextResponse.json({ error, status: 401 });
  }

  try {
    await connectToDatabase();
    const {truckNo} = params
    
    // Fetch all trips for the user
    const trips = await Trip.find({ user_id: user , truck : truckNo});

    // Calculate tripRevenue
    let tripRevenue = 0;
    for (const trip of trips) {
      tripRevenue += trip.amount;
      
      // Fetch trip charges for the current trip
      const tripCharges = await TripCharge.find({user_id : user, trip_id: trip.trip_id });
      
      // Calculate the charges
      for (const charge of tripCharges) {
        if (charge.partyBill) {
          tripRevenue += charge.amount;
        } else {
          tripRevenue -= charge.amount;
        }
      }
    }

    // Fetch all expenses for the user
    const expenses = await Expense.find({ user_id: user, truck: truckNo }).select('amount');

    // Calculate truckExpense
    let truckExpense = 0;
    for (const expense of expenses) {
        truckExpense += expense.amount;
    }

    return NextResponse.json({ truckExpense, tripRevenue }, { status: 200 });
  } catch (err: any) {
    console.error(err);
    return NextResponse.json({ error: 'Internal Server Error', status: 500 });
  }
}
</file>

<file path="src/app/api/trucks/create/route.ts">
import { NextResponse } from 'next/server';
import { model, models } from 'mongoose';
import { connectToDatabase, truckSchema } from '@/utils/schema';
import { verifyToken } from '@/utils/auth';

const Truck = models.Truck || model('Truck', truckSchema);

export async function GET(req: Request) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  try {
    await connectToDatabase()

    const trucks = await Truck.find({ user_id: user }).select(['truckNo','status','supplier','driver_id']).exec();
    return NextResponse.json({ trucks });
  } catch (err) {
    console.error(err);
    return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/trucks/documents/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, truckSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";

const Truck = models.Truck || model('Truck', truckSchema);

export async function GET(req: Request) {
    try {
        // Verify user token
        const { user, error } = await verifyToken(req);
        if (!user || error) {
            return NextResponse.json({ error: 'Unauthorized User', status: 401 });
        }

        // Extract 'type' from query parameters
        const url = new URL(req.url);
        const documentType = url.searchParams.get('type');

        // Ensure 'type' is provided
        if (!documentType) {
            return NextResponse.json({ error: 'Document type is required', status: 400 });
        }

        // Connect to the database
        await connectToDatabase();

        // Use aggregation to filter documents directly in MongoDB
        const trucks = await Truck.aggregate([
            {
                $match: { user_id: user } // Match the user_id with the user
            },
            {
                $project: {
                    user_id: 1,
                    truckNo: 1,
                    truckType: 1,
                    documents: {
                        $filter: {
                            input: '$documents',
                            as: 'document',
                            cond: { $eq: ['$$document.type', documentType] }
                        }
                    }
                }
            },
            {
                $match: { 'documents.0': { $exists: true } } // Only return trucks with matching documents
            }
        ]);

        // Format the result to combine truck info with each document
        const formattedDocs = trucks.flatMap((truck: any) =>
            truck.documents.map((doc: any) => ({
                filename: doc.filename,
                type: doc.type,
                validityDate: doc.validityDate,
                uploadedDate: doc.uploadedDate,
                url: doc.url,
                user_id: truck.user_id,
                truckNo: truck.truckNo,
                truckType: truck.truckType
            }))
        );

        // Return the formatted documents
        return NextResponse.json({ documents: formattedDocs, status: 200 });

    } catch (error) {
        console.error('Error fetching truck documents:', error);
        return NextResponse.json({ error: 'Something went wrong', status: 500 });
    }
}
</file>

<file path="src/app/api/trucks/route.ts">
import { NextResponse } from 'next/server';
import mongoose, { model, models } from 'mongoose';
import { connectToDatabase, truckSchema } from '@/utils/schema';
import { verifyToken } from '@/utils/auth';
import { v4 as uuidv4 } from 'uuid'
import { validateTruckNo } from '@/utils/validate';
import { recentActivity } from '@/helpers/recentActivity';


const Truck = models.Truck || model('Truck', truckSchema);

export async function GET(req: Request) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }
  try {
    await connectToDatabase()
    const trucks = await Truck.aggregate([
      {
        $match: { user_id: user }, // Filter trucks by user_id
      },
      {
        // Optimize supplier lookup to only return necessary fields
        $lookup: {
          from: 'suppliers',
          localField: 'supplier',
          foreignField: 'supplier_id',
          pipeline: [
            { $project: { name: 1 } }, // Only get the supplier name
          ],
          as: 'suppliers',
        },
      },
      {
        // Optimize driver lookup to only return necessary fields
        $lookup: {
          from: 'drivers',
          localField: 'driver_id',
          foreignField: 'driver_id',
          pipeline: [
            { $project: { name: 1 } }, // Only get the driver name
          ],
          as: 'drivers',
        },
      },
      {
        $lookup: {
          from: 'trips',
          let: { truckNo: '$truckNo', userId: user },
          pipeline: [
            {
              $match: {
                $expr: {
                  $and: [
                    { $eq: ['$truck', '$$truckNo'] }, // Match truckNo
                    { $eq: ['$user_id', '$$userId'] } // Match user_id
                  ]
                }
              }
            }, // Return relevant fields
          ],
          as: 'trips',
        },
      },
      
      {
        $unwind: {
          path: '$trips',
          preserveNullAndEmptyArrays: true, // Allow trucks with no trips
        },
      },
      {
        // Optimize party lookup for trips, only fetching necessary fields
        $lookup: {
          from: 'parties',
          localField: 'trips.party',
          foreignField: 'party_id',
          pipeline: [
            { $project: { name: 1 } }, // Only get the party name
          ],
          as: 'partyDetails',
        },
      },
      {
        $unwind: {
          path: '$partyDetails',
          preserveNullAndEmptyArrays: true, // Handle trips without party data
        },
      },
      {
        $group: {
          _id: '$_id', // Group by truck
          truckNo: { $first: '$truckNo' },
          truckType: { $first: '$truckType' },
          model: { $first: '$model' },
          capacity: { $first: '$capacity' },
          bodyLength: { $first: '$bodyLength' },
          ownership: { $first: '$ownership' },
          status: { $first: '$status' },
          driver_id: { $first: '$driver_id' },
          supplierName: { $first: { $arrayElemAt: ['$suppliers.name', 0] } },
          driverName: { $first: { $arrayElemAt: ['$drivers.name', 0] } }, // Extract driver name
          supplier: { $first: '$supplier' },
          trips: {
            $push: {
              trip_id: '$trips.trip_id',
              partyName: '$partyDetails.name',
              route: '$trips.route',
              startDate: '$trips.startDate',
              status: '$trips.status',
            },
          },
        },
      },
      {
        $addFields: {
          trips: {
            $sortArray: { input: '$trips', sortBy: { startDate: -1 } }, // Sort trips by startDate descending
          },
        },
      },
      {
        $addFields: {
          latestTrip: {
            $arrayElemAt: ['$trips', 0], // Extract the latest trip after sorting
          },
        },
      },
      {
        $sort: { 'latestTrip.startDate': -1 }, // Sort trucks by latest trip date
      },
      {
        $project: {
          trips: 0
        }
      }
    ]);



    return NextResponse.json({ trucks });
  } catch (err) {
    console.error(err);
    return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 });
  }
}


export async function POST(req: Request) {
  const { user, error } = await verifyToken(req); // Authenticate the user

  if (error) {
    return NextResponse.json({ status: "error", message: error }, { status: 401 });
  }

  try {
    await connectToDatabase(); // Ensure DB connection

    const data = await req.json(); // Parse request body

    // Validation
    if (!validateTruckNo(data.truckNo)) {
      return NextResponse.json({ status: "error", message: "Enter a valid Truck No" }, { status: 400 });
    }
    if (!data.truckNo || !data.ownership) {
      return NextResponse.json({
        status: "error",
        message: data.truckNo ? "Ownership type is required" : "Truck Number is required"
      }, { status: 400 });
    }
    if (data.ownership === "Market" && !data.supplier) {
      return NextResponse.json({ status: "error", message: "Supplier is required for Market ownership" }, { status: 400 });
    }

    // Check for existing truck
    const existingTruck = await Truck.findOne({ user_id: user, truckNo: data.truckNo.toUpperCase() });
    if (existingTruck) {
      return NextResponse.json({ status: "error", message: "Lorry Already Exists" }, { status: 400 });
    }

    // External API request
    let truckData = {};
    try {
      const res = await fetch("https://api.invincibleocean.com/invincible/vehicleRcV6", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          secretKey: process.env.INVINCIBLE_SECRET_KEY as string,
          clientId: process.env.INVINCIBLE_CLIENT_ID as string,
        },
        body: JSON.stringify({ vehicleNumber: data.truckNo.toUpperCase() }),
      });
      const resData = await res.json();
      truckData = resData.result?.data || {};
    } catch (apiError) {
      console.error("External API error:", apiError);
    }

    // Create a new truck
    const newTruck = new Truck({
      user_id: user,
      truck_id: "truck_id" + uuidv4(),
      truckNo: data.truckNo.toUpperCase(),
      truckType: data.truckType || "",
      model: data.model || "",
      capacity: data.capacity || "",
      bodyLength: data.bodyLength || null,
      ownership: data.ownership,
      supplier: data.supplier || "",
      status: "Available",
      trip_id: "",
      createdAt: new Date(),
      updatedAt: new Date(),
      driver_id: data.driver || "",
      data : truckData,
    });

    await Promise.all([
      newTruck.save(),
      recentActivity("Added New Lorry", newTruck, user),
    ]);


    return NextResponse.json({ status: "success", data: newTruck });
  } catch (err: any) {
    console.error("Error creating truck:", err);
    return NextResponse.json({ status: "error", message: err.message || "Failed to add lorry" }, { status: 500 });
  }
}
</file>

<file path="src/app/api/users/grant-access/route.ts">
import { generateUserId, verifyToken } from "@/utils/auth";
import { connectToDatabase, driverSchema, userSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextRequest, NextResponse } from "next/server";

const User = models.User || model('User', userSchema);

export async function POST(req: NextRequest) {
    try {
        const { user, error } = await verifyToken(req as Request);
        
        if (!user || error) {
            return NextResponse.json({ error: 'Authentication failed' }, { status: 401 });
        }

        await connectToDatabase();

        const data = await req.json();
        const phone = data.phone;
        const role = data.role;

        if (!phone || !role) {
            return NextResponse.json({ error: 'Invalid input' }, { status: 400 });
        }

        // Check if the user exists in Firebase
        const uid = generateUserId(phone);

        // Now query your database with the uid from Firebase
        let existingUser = await User.findOne({ user_id: uid });

        if (!existingUser) {
            // If the user does not exist in your database, create a new one
            const Driver = models.Driver || model('Driver', driverSchema)
            const driver = await Driver.findOne({user_id : user, contactNumber : phone})
            if(!driver && role === 'driver'){
                return NextResponse.json({error : 'Driver Not Found', status : 400})
            }
            const newUser = new User({
                user_id: uid,
                phone: phone,
                role: {
                    name : role,
                    user : user
                },
            });
            await newUser.save();
        } else {
            // If the user exists, update the role or any other necessary fields
            return NextResponse.json({error : "User Already Exists", status : 400})
        }

        return NextResponse.json({ success: true });

    } catch (err) {
        console.error('Error processing request:', err);
        return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
    }
}



export async function GET(req: Request) {
    try {
        // Verify the token and get the user information
        const { user, error } = await verifyToken(req);

        if (!user || error) {
            return NextResponse.json({ error: 'Authentication failed' }, { status: 401 });
        }

        // Connect to the database
        await connectToDatabase();

        // Fetch users where the role.user matches the authenticated user's ID
        const users = await User.find({ 'role.user': user })

        return NextResponse.json({ users ,status: 200 });
    } catch (error) {
        console.error(error);
        return NextResponse.json({ error: 'Internal Server Error' ,status: 500 });
    }
}
</file>

<file path="src/app/api/users/revoke-access/[userId]/route.ts">
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, userSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";
const User = models.User || model('User', userSchema)

export async function DELETE(req : Request, {params} : {params : {userId : string}}) {
    try {
        const {user, error} = await verifyToken(req)
        if(!user || error){
            return NextResponse.json({error : 'Authentication Failed', status : 401})
        }
        const {userId} = params
        await connectToDatabase()
        await User.findOneAndDelete({user_id : userId})
        return NextResponse.json({message : 'Access Revoked', status : 200})
    } catch (error) {
        console.log(error)
        return NextResponse.json({error , status : 500})
    }
}
</file>

<file path="src/app/api/users/route.ts">
import { uploadFileToS3 } from "@/helpers/fileOperation";
import { verifyToken } from "@/utils/auth";
import { connectToDatabase, DeletedAccountSchema, driverSchema, ExpenseSchema, InvoiceSchema, PartyPaymentSchema, partySchema, supplierAccountSchema, supplierSchema, tripChargesSchema, tripSchema, truckSchema, userSchema } from "@/utils/schema";
import { model, models } from "mongoose";
import { NextResponse } from "next/server";
import { v4 as uuidV4 } from 'uuid'

const User = models.User || model('User', userSchema)

export async function GET(req: Request) {
  try {
    const { user, error } = await verifyToken(req)
    if (!user || error) {
      return NextResponse.json({ error })
    }
    await connectToDatabase()
    const userData = await User.findOne({ user_id: user })
    if (!userData) {
      return NextResponse.json({ error: 'User Not Found', status: 400 })
    }
    return NextResponse.json({ status: 200, user: userData })
  } catch (error) {
    console.log(error)
    return NextResponse.json({ status: 500, error: error })
  }
}


export async function PATCH(req: Request) {
  try {
    // Verify token
    const { user, error } = await verifyToken(req);
    if (!user || error) {
      return NextResponse.json({ error: 'Unauthorized access', status: 401 });
    }

    // Parse form data
    const formData = await req.formData();
    const files: File[] = [];
    const filenames: string[] = [];


    // Collect all files and filenames
    for (const [key, value] of formData.entries()) {
      if (key.startsWith('filename')) {
        filenames.push(value as string);
      } else if (key.startsWith('file')) {
        files.push(value as File);
      }
    }



    // Validation: Ensure files and filenames match
    if (files.length === 0) {
      return NextResponse.json({ error: 'At least one file is required', status: 400 });
    }
    if (files.length !== filenames.length) {
      return NextResponse.json({ error: 'Mismatched files and filenames', status: 400 });
    }

    const uploadedDocuments = [];

    // Process each file
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const filename = filenames[i] || file.name;

      // Convert file to buffer
      const fileBuffer = Buffer.from(await file.arrayBuffer());
      const fileName = `users/${user}/${uuidV4()}`;
      const contentType = file.type;

      // Upload file to S3
      const s3Filename = await uploadFileToS3(fileBuffer, fileName, contentType);
      const fileUrl = `https://${process.env.AWS_S3_BUCKET_NAME}.s3.${process.env.AWS_S3_REGION}.amazonaws.com/${s3Filename}${contentType === 'application/pdf' ? '.pdf' : ''}`;

      // Prepare document data
      uploadedDocuments.push({
        filename,
        uploadedDate: new Date(),
        url: fileUrl,
      });
    }

    // Update user's document list
    const updatedUser = await User.findOneAndUpdate(
      { user_id: user },
      { $push: { documents: { $each: uploadedDocuments, $position: 0 } } },
      { new: true, projection: { user_id: 0 } } // Exclude `user_id` from the returned data
    );

    if (!updatedUser) {
      return NextResponse.json({ error: 'User not found', status: 404 });
    }

    return NextResponse.json({
      message: `${uploadedDocuments.length} document(s) added successfully`,
      status: 200,
      user: updatedUser,
    });
  } catch (error) {
    console.error('Error updating user documents:', error);
    return NextResponse.json({ error: 'Internal Server Error', status: 500 });
  }
}

export async function PUT(req: Request) {
  try {
    const { user, error } = await verifyToken(req);
    if (!user || error) {
      console.error("Token verification error:", error);
      return NextResponse.json({ error: 'Unauthorized access', status: 401 });
    }

    const formData = await req.formData();
    if (!formData.has('data')) {
      return NextResponse.json({ error: 'Missing required data field', status: 400 });
    }

    const data = JSON.parse(formData.get('data') as string);
    console.log(data)

    const uploadIfPresent = async (file: File | null, folder: string) => {
      if (!file) return '';

      try {
        const fileBuffer = Buffer.from(await file.arrayBuffer());
        const fileName = `${folder}/${user}`;
        const contentType = file.type;

        const s3FileName = await uploadFileToS3(fileBuffer, fileName, contentType);
        return `https://${process.env.AWS_S3_BUCKET_NAME}.s3.${process.env.AWS_S3_REGION}.amazonaws.com/${s3FileName}${contentType === 'application/pdf' ? '.pdf' : ''}`;
      } catch (error) {
        console.error(`Error uploading ${folder} file:`, error);
        throw new Error(`Failed to upload ${folder} file`);
      }
    };

    const logoUrl = await uploadIfPresent(formData.get('logo') as File | null, 'logos');
    const stampUrl = await uploadIfPresent(formData.get('stamp') as File | null, 'stamps');
    const signatureUrl = await uploadIfPresent(formData.get('signature') as File | null, 'signatures');

    await connectToDatabase();
    const updatedUser = await User.findOneAndUpdate({ user_id: user }, data, { new: true });

    if (!updatedUser) {
      console.error('User not found:', user);
      return NextResponse.json({ error: 'User not found', status: 400 });
    }

    if (logoUrl) updatedUser.logoUrl = logoUrl;
    if (stampUrl) updatedUser.stampUrl = stampUrl;
    if (signatureUrl) updatedUser.signatureUrl = signatureUrl;

    const {deleteLogo, deleteStamp, deleteSignature} = data
    if(deleteLogo) updatedUser.logoUrl = ''
    if(deleteStamp) updatedUser.stampUrl = ''
    if(deleteSignature) updatedUser.signatureUrl = ''

    await updatedUser.save();

    return NextResponse.json({ status: 200, user: updatedUser });
  } catch (error) {
    console.error('Error in PUT:', error);
    return NextResponse.json({ error: 'Internal Server Error', status: 500 });
  }
}


export async function DELETE(req : Request){
  const Trip = models.Trip || model('Trip', tripSchema)
  const Expense = models.Expenses || model('Expense', ExpenseSchema)
  const Invoice = models.Invoice || model('Invoice', InvoiceSchema)
  const Truck = models.Truck || model('Truck', truckSchema)
  const Party = models.Party || model('Party', partySchema)
  const Driver = models.Driver || model('Driver', driverSchema)
  const DeletedAccount = models.DeletedAccount || model('DeletedAccount', DeletedAccountSchema)
  const Supplier = models.Supplier || model('Supplier', supplierSchema)
  const TripCharges = models.TripCharges || model('TripCharges', tripChargesSchema)
  const PartyPayment = models.PartyPayment || model('PartyPayment', PartyPaymentSchema)
  const SupplierAccount = models.SupplierAccount || model('SupplierAccount', supplierAccountSchema)

  try {
    const { user, error } = await verifyToken(req);
    if (!user || error) {
      console.error("Token verification error:", error);
      return NextResponse.json({ error: 'Unauthorized access', status: 401 }, {status : 401});
    }
    const data = await req.json();
    const {reason} = data.reason;
    await connectToDatabase();

    const deletedUser = await User.findOneAndDelete({user_id : user})

    await Promise.all([
      Trip.deleteMany({user_id : user}),
      Expense.deleteMany({user_id : user}),
      Invoice.deleteMany({user_id : user}),
      Truck.deleteMany({user_id : user}),
      Party.deleteMany({user_id : user}),
      Driver.deleteMany({user_id : user}),
      Supplier.deleteMany({user_id : user}),
      TripCharges.deleteMany({user_id : user}),
      PartyPayment.deleteMany({user_id : user}),
      SupplierAccount.deleteMany({user_id : user}),
      DeletedAccount.create({user_id : user, phone : deletedUser.phone, reason : reason}) // create a new entry in DeletedAccount table with user_id and reason for deletion
    ])

    return NextResponse.json({message : "Account Deleted Successfully"}, {status : 200})

  } catch (error) {
    console.log(error)
    return NextResponse.json({error : "Internal Server Error"}, {status : 500})
  }
}
</file>

<file path="src/app/global-error.tsx">
'use client'
 
export default function GlobalError({
  error,
  reset,
}: {
  error: Error & { digest?: string }
  reset: () => void
}) {
  return (
    <html>
      <body>
        <h2>Something went wrong!</h2>
        <p>{error.message}</p>
        <button onClick={() => reset()}>Try again</button>
      </body>
    </html>
  )
}
</file>

<file path="src/app/layout.tsx">
import type { Metadata } from "next";
import './globals.css';
import { cn } from "@/lib/utils";
import { Roboto as FontSans } from "next/font/google";
import Script from "next/script";

// Load Roboto font with multiple weights
const fontSans = FontSans({
  subsets: ["latin"],
  weight: ["100", "300", "400", "500", "700"],
  variable: "--font-sans",
});

export const metadata: Metadata = {
  title: "Awajahi - Moving India One Mile at a Time",
  description: "Awajahi is transforming transportation in India, one mile at a time. Discover our services and how we are moving India efficiently and reliably.",
  keywords: ["Awajahi", "Transport", "Logistics", "India", "Moving Services", "Web Application", "Fleet Management", "awajahi"],
  authors: [{ name: "Awajahi Team" }],
  robots: {
    index: true,
    follow: true,
  },
  openGraph: {
    title: "Awajahi - Moving India One Mile at a Time",
    description: "Explore Awajahi for reliable and efficient transportation services across India.",
    url: "https://www.awajahi.com",
    type: "website",
    locale: "en_IN",
    images: [
      {
        url: "https://www.awajahi.com/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fawajahi%20logo.e4977a4d.png&w=64&q=75",
        width: 1200,
        height: 630,
        alt: "Awajahi Logo",
      },
    ],
  },
  icons: {
    icon: "/favicon.ico",
  },
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en" suppressHydrationWarning>
      <head>
        {/* Add Google Analytics Script */}
        <Script
          src={`https://www.googletagmanager.com/gtag/js?id=G-BMXWP592W0`} // Replace with your Measurement ID
          strategy="afterInteractive"
        />
        <Script id="google-analytics" strategy="afterInteractive">
          {`
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}

            // Function to capture UTM parameters
            function getUTMParams() {
              const urlParams = new URLSearchParams(window.location.search);
              return {
                utm_source: urlParams.get('utm_source') || '(direct)',
                utm_medium: urlParams.get('utm_medium') || '(none)',
                utm_campaign: urlParams.get('utm_campaign') || '',
                utm_content: urlParams.get('utm_content') || '',
                utm_term: urlParams.get('utm_term') || '',
              };
            }

            // Set up Google Analytics with UTM parameters
            gtag('js', new Date());

            // Get the UTM parameters and include them in the gtag config
            const utmParams = getUTMParams();
            gtag('config', 'G-BMXWP592W0', {
              page_path: window.location.pathname,
              ...utmParams
            });
          `}
        </Script>
      </head>
      <body
        className={cn(
          "min-h-screen bg-background font-roboto antialiased",
          fontSans.variable
        )}
      >
        {children}
        
      </body>
    </html>
  );
}
</file>

<file path="src/app/login/layout.tsx">
import type { Metadata } from "next";
import { Roboto as FontSans } from "next/font/google"
import '@/app/globals.css'

const fontSans = FontSans({
  subsets: ["latin"],
  weight: ["400", "500", "700"], // You can specify the font weights you want to use
  variable: "--font-roboto", 
})

export const metadata: Metadata = {
  title: "Awajahi Login Page",
  description: "Login to Awajahji",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {

  return (
      <div>
      {children}
      </div>
      
        
        
  );
}
</file>

<file path="src/app/login/page.tsx">
'use client'
import OtpLogin from "@/components/OtpLogin";
function LoginPage() {


  return (
    <div className="min-h-screen">

      <OtpLogin />
    </div>
  );
}

export default LoginPage;
</file>

<file path="src/app/not-found.tsx">
import Link from 'next/link';
import Image from 'next/image';
import notfound from '../assets/not-found.webp';

export default function Error({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  

  return (
    <div className="flex items-center justify-center min-h-screen bg-gradient-to-r from-blue-100 to-gray-100 p-4">
      <div className="max-w-md text-center p-8 bg-white shadow-2xl rounded-lg">
        <Image src={notfound} alt="Not Found" width={480} height={360} className="mx-auto rounded" />
        <h1 className="text-5xl font-bold text-gray-800 mt-6">404</h1>
        <p className="text-lg text-gray-600 mt-2">Oops! The page you are looking for doe not exist.</p>
        <Link href="/" className="mt-4 inline-block px-4 py-2 bg-gray-700 text-gray-200 rounded-md hover:bg-gray-600 hover:text-white transition duration-200 shadow-lg">
        
            Go Home
        </Link>
      </div>
    </div>
  );
}
</file>

<file path="src/app/privacy-policy/page.tsx">
import '@/app/globals.css'
import React from 'react';
import Image from 'next/image';
import logo_img from '@/assets/awajahi logo.png'
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import loginIcon from '@/assets/login icon.png'

export const metadata = {
    title: 'Privacy Policy - Awajahi',
    description: 'Awajahi\'s privacy policy outlining how we collect, use, and protect your personal information when using our website and services.',
    keywords: 'Awajahi, Privacy Policy, Personal Information, Data Security, Cookies',
    openGraph: {
        title: 'Privacy Policy - Awajahi',
        description: 'Awajahi\'s Privacy Policy detailing how we handle personal and non-personal data.',
        url: 'https://www.awajahi.com/privacy-policy',
        images: [
            {
                url: '../assets/awajahi logo.png',
                width: 800,
                height: 600,
                alt: 'Awajahi Privacy Policy',
            },
        ],
        type: 'website',
    },
}

const PrivacyPolicyPage = () => {
    return (
        <div className='w-full bg-[radial-gradient(ellipse_at_80%_50%,_#FFC499_0%,_#FFFFFF_80%)]'>
            <div className="container mx-auto p-4  text-black" suppressHydrationWarning>
                <div className="flex flex-wrap justify-between items-center w-full py-4 sm:py-6">
                    {/* Logo Section */}
                    <div className="flex items-center space-x-2 sm:space-x-4">
                        <Image
                            src={logo_img}
                            alt="Awajahi Logo"
                            width={60}
                            height={60}
                            className="w-[25px] h-[27px] sm:w-[60px] sm:h-[60px]"
                        />
                        <Link href={'/'}><span className="text-lg sm:text-2xl font-bold text-black">Awajahi</span></Link>
                    </div>

                    {/* Navigation Links Section */}
                    <ul className="hidden sm:flex items-center space-x-4 sm:space-x-8 md:space-x-16 text-lg sm:text-xl md:text-2xl font-semibold text-[#333333]">
                        <li>
                            <Link href="/" className="hover:text-[#FF6A00] transition-colors duration-300">About Us</Link>
                        </li>
                        <li>
                            <Link href="/login" className="hover:text-[#FF6A00] transition-colors duration-300 flex items-center">
                                <span>Login</span>
                                <Image src={loginIcon} width={24} height={24} className="sm:w-6 sm:h-6" alt="login" />
                            </Link>
                        </li>
                        <li>
                            <Link href="/login">
                                <Button className="rounded-full bg-[#CC5500] text-white px-4 sm:px-6 py-2 sm:py-3 font-bold text-md sm:text-lg">
                                    Sign Up
                                </Button>
                            </Link>
                        </li>
                    </ul>
                </div>
                <div className="mb-6">
                    <h1 className="text-3xl font-bold">Privacy Policy</h1>
                    <span className="text-gray-600">Last Updated: {new Date('2024-10-21').toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' })}</span>
                </div>
                <div className="mb-6">
                    <p className="text-lg">
                        At Awajahi, we value your privacy and are committed to protecting your personal information. This Privacy Policy explains how we collect, use, disclose, and safeguard your information when you use our web and Android applications.By using Awajahi, you agree to the terms of this Privacy Policy. If you do not agree with these terms, please do not access or use our services.
                    </p>
                </div>
                <hr className='text-[#BCBCBC]' />
                <div>
                    <ol className="list-decimal pl-6 space-y-2 text-lg" type='1'>
                        <li>
                            <strong>Information We Collect</strong>
                            <p className="ml-4 mt-2">
                                We collect several types of information to provide and improve our services:
                            </p>
                            <ol className="list-decimal pl-6 mt-2" type="1">
                                <li>
                                    <strong>Personal Information</strong>
                                    <ul className="list-disc pl-6 mt-1">
                                        <li>Name</li>
                                        <li>Email address</li>
                                        <li>Phone number</li>
                                        <li>Company details (for carriers and shippers)</li>
                                        <li>Payment information (for marketplace and invoicing features)</li>
                                    </ul>
                                </li>
                                <li className="mt-2">
                                    <strong>Operational Data</strong>
                                    <ul className="list-disc pl-6 mt-1">
                                        <li>Trip details (origin, destination, route information)</li>
                                        <li>Expense management data</li>
                                        <li>Load and shipment details</li>
                                    </ul>
                                </li>
                                <li className="mt-2">
                                    <strong>GPS Location Data</strong>
                                    <ul className="list-disc pl-6 mt-1">
                                        <li>
                                            Real-time location data from third-party GPS tracking devices and your mobile device when using the GPS tracking feature.
                                        </li>
                                    </ul>
                                </li>
                                <li className="mt-2">
                                    <strong>Document Data</strong>
                                    <ul className="list-disc pl-6 mt-1">
                                        <li>
                                            We collect and store documents you upload, such as invoices, E-Way Bills, RCs, and other logistical documents.
                                        </li>
                                    </ul>
                                </li>
                                <li className="mt-2">
                                    <strong>Device Information</strong>
                                    <ul className="list-disc pl-6 mt-1">
                                        <li>IP address</li>
                                        <li>Browser type</li>
                                        <li>Device ID</li>
                                        <li>Operating system</li>
                                        <li>Mobile network information</li>
                                    </ul>
                                </li>
                                <li className="mt-2">
                                    <strong>Usage Data</strong>
                                    <ul className="list-disc pl-6 mt-1">
                                        <li>Information about interactions with the platform, such as pages viewed, buttons clicked, and time spent on each section.</li>
                                    </ul>
                                </li>
                            </ol>
                        </li>

                        <hr className='text-[#BCBCBC]' />
                        <li>
                            <strong>How We Use Your Information</strong>
                            <p className="ml-4 mt-2">We use your data to improve our services, provide a seamless user experience, and ensure efficient logistics management:</p>
                            <ol className="list-decimal pl-6 mt-2">
                                <li>
                                    <strong>Service Delivery</strong>
                                    <p className="ml-4 mt-1">
                                        To manage your account, provide customer support, and respond to inquiries.<br />
                                        To facilitate trip and expense management, GPS tracking, and document management.<br />
                                        To enable marketplace functionalities like bidding and load management between carriers and shippers.
                                    </p>
                                </li>
                                <li className="mt-2">
                                    <strong>Analytics and Improvements</strong>
                                    <p className="ml-4 mt-1">
                                        To understand how users interact with our platform and improve its functionality.<br />
                                        To monitor usage patterns, user feedback, and operational performance for platform optimization.
                                    </p>
                                </li>
                                <li className="mt-2">
                                    <strong>Marketing and Communication</strong>
                                    <p className="ml-4 mt-1">
                                        To send you notifications about updates, new features, or marketing materials, subject to your communication preferences.<br />
                                        To notify you about relevant offers, promotions, or events related to Awajahi.
                                    </p>
                                </li>
                                <li className="mt-2">
                                    <strong>Security and Fraud Prevention</strong>
                                    <p className="ml-4 mt-1">
                                        To detect, prevent, and respond to fraud, unauthorized activities, or security threats on the platform.
                                    </p>
                                </li>
                            </ol>
                        </li>

                        <hr className='text-[#BCBCBC]' />
                        <li>
                            <strong>Sharing Your Information</strong>
                            <p className="ml-4 mt-2">
                                We do not sell or share your personal information with third parties except in the following circumstances:
                            </p>
                            <ol className="list-decimal pl-6 mt-2">
                                <li>
                                    <strong>Third-Party Service Providers</strong>
                                    <p className="ml-4 mt-1">
                                        We may share your information with trusted third-party service providers who help us operate the platform, including:
                                        <ul className="list-disc pl-6 mt-1">
                                            <li>Payment gateways (e.g., Paytm, PhonePe)</li>
                                            <li>GPS tracking hardware providers</li>
                                            <li>Cloud storage and hosting services</li>
                                        </ul>
                                        These providers are obligated to protect your data and use it only for the services they are providing to Awajahi.
                                    </p>
                                </li>
                                <li className="mt-2">
                                    <strong>Business Transfers</strong>
                                    <p className="ml-4 mt-1">
                                        In the event of a merger, acquisition, or asset sale, your information may be transferred as part of the transaction. You will be notified of any such change in ownership or control.
                                    </p>
                                </li>
                                <li className="mt-2">
                                    <strong>Legal Obligations</strong>
                                    <p className="ml-4 mt-1">
                                        We may disclose your information if required by law or to comply with legal processes such as a subpoena, court order, or governmental regulation.
                                    </p>
                                </li>
                            </ol>
                        </li>

                        <hr className='text-[#BCBCBC]' />
                        <li>
                            <strong>Data Security</strong>
                            <p className="ml-4 mt-2">We take reasonable measures to secure your data, using industry-standard encryption protocols to protect personal and operational information. However, no method of transmission over the internet is completely secure. While we strive to protect your information, we cannot guarantee its absolute security.</p>
                        </li>
                        <hr className='text-[#BCBCBC]' />
                        <li>
                            <strong>Data Retention</strong>
                            <p className='ml-4 mt-2'>We will retain your information for as long as your account is active or as necessary to provide our services. You may request deletion of your account and data at any time, subject to certain legal or business requirements to retain specific information.</p>
                        </li>
                        <li>
                            <strong>Your Data Rights</strong>
                            <p className="ml-4 mt-2">
                                Depending on your jurisdiction, you may have the following rights concerning your personal data:
                            </p>
                            <ol className="list-decimal pl-6 mt-2">
                                <li>
                                    <strong>Access</strong>
                                    <p className="ml-4 mt-1">
                                        You can request a copy of the data we hold about you.
                                    </p>
                                </li>
                                <li className="mt-2">
                                    <strong>Correction</strong>
                                    <p className="ml-4 mt-1">
                                        You can request that we update or correct inaccurate information.
                                    </p>
                                </li>
                                <li className="mt-2">
                                    <strong>Deletion</strong>
                                    <p className="ml-4 mt-1">
                                        You can request that we delete your personal data, subject to legal retention requirements.
                                    </p>
                                </li>
                                <li className="mt-2">
                                    <strong>Objection</strong>
                                    <p className="ml-4 mt-1">
                                        You can object to the processing of your data for specific purposes, like marketing.
                                    </p>
                                </li>
                            </ol>
                            <p className="ml-4 mt-4">
                                To exercise any of these rights, please contact us at <a href="mailto:info@awajahi.com">info@awajahi.com</a>.
                            </p>
                        </li>
                        <hr className='text-[#BCBCBC]' />
                        <li>
                            <strong>Cookies and Tracking Technologies</strong>
                            <p className="ml-4 mt-2">We may use cookies and similar tracking technologies to monitor activity on our platform and store certain information. You can modify your browser settings to disable cookies, but doing so may affect your ability to use certain features of the platform.</p>
                        </li>
                        <hr className='text-[#BCBCBC]' />
                        <li>
                            <strong>Third Party Links</strong>
                            <p className="ml-4 mt-2">Our platform may contain links to third-party websites. We are not responsible for the privacy practices or content of these external sites. We encourage users to review the privacy policies of any third-party websites they visit</p>
                        </li>
                        <hr className='text-[#BCBCBC]' />
                        <li>
                            <strong>Children Privacy</strong>
                            <p className='ml-4 mt-2'>Awajahi is not intended for use by individuals under the age of 18. We do not knowingly collect or store personal information from children under the age of 18. If we become aware of such data, it will be deleted immediately.</p>
                        </li>
                        <hr className='text-[#BCBCBC]' />
                        <li>
                            <strong>Changes to this Privacy Policy</strong>
                            <p className='ml-4 mt-2'>We reserve the right to update or modify this Privacy Policy at any time. Any changes will be communicated to users via email or through a notification on the platform. Your continued use of the platform after such changes indicates your acceptance of the updated policy.</p>
                        </li>
                        <hr className='text-[#BCBCBC]' />
                        <li>
                            <strong>Contact Us</strong>
                            <p className="ml-4 mt-2">
                                If you have any questions or concerns about this Privacy Policy or our data practices, please contact us at:
                            </p>
                            <p className="ml-4 mt-1">
                                Email: <a href="mailto:info@awajahi.com">info@awajahi.com</a>
                            </p>
                        </li>

                    </ol>
                </div>
                <footer className="mt-8 text-center">
                    <a className="text-blue-600">By using our website, you agree to this Privacy Policy.</a>
                </footer>
            </div>
        </div>

    );
};

export default PrivacyPolicyPage;
</file>

<file path="src/app/sitemap.ts">
import type { MetadataRoute } from 'next';

export default function sitemap(): MetadataRoute.Sitemap {
  return [
    {
      url: 'https://www.awajahi.com/',
      lastModified: new Date(),
      changeFrequency: 'weekly',
      priority: 1,
    },
    {
      url: 'https://www.awajahi.com/terms',
      lastModified: new Date('2024-10-21'),
      changeFrequency: 'yearly',
      priority: 0.7,
    },
    {
      url: 'https://www.awajahi.com/privacy-policy',
      lastModified: new Date(),
      changeFrequency: 'yearly',
      priority: 0.7,
    }
  ];
}
</file>

<file path="src/app/terms/page.tsx">
import '@/app/globals.css'
import React from 'react';
import Image from 'next/image';
import logo_img from '@/assets/awajahi logo.png'
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import loginIcon from '@/assets/login icon.png'

export const metadata = {
    title: 'Terms and Conditions - Awajahi',
    description: 'Awajahi\'s terms and conditions outlining the rules and guidelines for using our website and services. By accessing our services, you agree to comply with these terms.',
    keywords: 'Awajahi, Terms and Conditions, User Agreement, Service Terms, Legal Policy',
    openGraph: {
        title: 'Terms and Conditions - Awajahi',
        description: 'Awajahi\'s terms and conditions detailing how users can engage with our website and services. Understand your rights and responsibilities while using Awajahi.',
        url: 'https://www.awajahi.com/terms',
        images: [
            {
                url: '../assets/awajahi logo.png',
                width: 800,
                height: 600,
                alt: 'Awajahi Terms and Conditions',
            },
        ],
        type: 'website',
    },
}


const TermsPage = () => {
    return (
        <div className='w-full bg-[radial-gradient(ellipse_at_80%_50%,_#FFC499_0%,_#FFFFFF_80%)]'>
            <div className="container mx-auto p-4  text-black" suppressHydrationWarning>
                <div className="flex flex-wrap justify-between items-center w-full py-4 sm:py-6">
                    {/* Logo Section */}
                    <div className="flex items-center space-x-2 sm:space-x-4">
                        <Image
                            src={logo_img}
                            alt="Awajahi Logo"
                            width={60}
                            height={60}
                            className="w-[25px] h-[27px] sm:w-[60px] sm:h-[60px]"
                        />
                        <Link href={'/'}><span className="text-lg sm:text-2xl font-bold text-black">Awajahi</span></Link>
                    </div>

                    {/* Navigation Links Section */}
                    <ul className="hidden sm:flex items-center space-x-4 sm:space-x-8 md:space-x-16 text-lg sm:text-xl md:text-2xl font-semibold text-[#333333]">
                        <li>
                            <Link href="/" className="hover:text-[#FF6A00] transition-colors duration-300">About Us</Link>
                        </li>
                        <li>
                            <Link href="/login" className="hover:text-[#FF6A00] transition-colors duration-300 flex items-center">
                                <span>Login</span>
                                <Image src={loginIcon} width={24} height={24} className="sm:w-6 sm:h-6" alt="login" />
                            </Link>
                        </li>
                        <li>
                            <Link href="/login">
                                <Button className="rounded-full bg-[#CC5500] text-white px-4 sm:px-6 py-2 sm:py-3 font-bold text-md sm:text-lg">
                                    Sign Up
                                </Button>
                            </Link>
                        </li>
                    </ul>
                </div>
                <div className="mb-6">
                    <h1 className="text-3xl font-bold">Terms and Conditions</h1>
                    <span className="text-gray-600">Last Updated: {new Date('2024-10-21').toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' })}</span>
                </div>
                <div className="mb-6">
                    <p className="text-lg">
                        Welcome to Awajahi, a platform designed for efficient management of logistics, trip planning, expense tracking, document management, and fleet management. These terms and conditions outline the rules and regulations for the use of the Awajahi web and Android applications.By accessing or using our services, you agree to be bound by these terms. If you disagree with any part of the terms, you may not access the services.
                    </p>
                </div>
                <hr className='text-[#BCBCBC]' />
                <div>
                    <div className="privacy-policy">
                        <h2 className="text-2xl font-bold">Definitions</h2>
                        <ul className="list-disc pl-6 mt-2 text-lg">
                            <li><strong>Platform</strong>: Refers to both the web and mobile applications of Awajahi.</li>
                            <li><strong>User</strong>: Refers to anyone who accesses or uses the platform, including carriers, shippers, drivers, or fleet owners.</li>
                            <li><strong>Company</strong>: Refers to Awajahi.</li>
                            <li><strong>Content</strong>: Refers to any data, information, or material posted or available on the platform.</li>
                        </ul>

                        <h2 className="text-2xl font-bold mt-6">User Accounts</h2>
                        <ul className="list-disc pl-6 mt-2 text-lg">
                            <li>Users must register an account to access certain services. You are responsible for maintaining the confidentiality of your account details and agree to notify us immediately of any unauthorized use.</li>
                            <li>Users agree to provide accurate and complete information when registering and using the platform.</li>
                        </ul>

                        <h2 className="text-2xl font-bold mt-6">Use of the Platform</h2>
                        <ul className="list-disc pl-6 mt-2 text-lg">
                            <li>Awajahi provides tools for managing logistics operations, including trip planning, expense tracking, document management, and marketplace functionalities.</li>
                            <li>Users agree not to misuse the platform for illegal purposes and to use it in compliance with all applicable laws and regulations.</li>
                            <li>You are solely responsible for any content you post or upload on the platform, including but not limited to documents, load details, invoices, or messages.</li>
                        </ul>

                        <h2 className="text-2xl font-bold mt-6">Payment and Billing</h2>
                        <ul className="list-disc pl-6 mt-2 text-lg">
                            <li>Awajahi may offer payment features to facilitate transactions between shippers and carriers. However, Awajahi is not responsible for the payments between parties; we only provide a platform to assist in this process.</li>
                            <li>Users must agree to the terms of the third-party payment gateways integrated into the platform, such as Paytm and PhonePe, if applicable.</li>
                        </ul>

                        <h2 className="text-2xl font-bold mt-6">Marketplace</h2>
                        <ul className="list-disc pl-6 mt-2 text-lg">
                            <li>Carriers and shippers can post loads and bid on jobs. The terms and conditions of any contract or bid are between the shipper and the carrier. Awajahi does not participate in, endorse, or guarantee any transaction between users.</li>
                            <li>Awajahi reserves the right to moderate or remove any bids or listings that violate our policies or are deemed inappropriate.</li>
                        </ul>

                        <h2 className="text-2xl font-bold mt-6">GPS Tracking</h2>
                        <ul className="list-disc pl-6 mt-2 text-lg">
                            <li>Awajahi may use third-party hardware and services for GPS tracking. By using this feature, you agree to Awajahi and its third-party partners processing your location data.</li>
                            <li>Awajahi is not responsible for inaccuracies in location data provided by third-party devices or services.</li>
                        </ul>

                        <h2 className="text-2xl font-bold mt-6">Document Management</h2>
                        <ul className="list-disc pl-6 mt-2 text-lg">
                            <li>The platform provides a document management system where users can upload, store, and manage logistics-related documents such as invoices, receipts, RCs, E-Way Bills, etc.</li>
                            <li>Users are responsible for ensuring the accuracy and legality of all uploaded documents. Awajahi does not verify or endorse the authenticity of any documents uploaded by users.</li>
                        </ul>

                        <h2 className="text-2xl font-bold mt-6">Data Privacy</h2>
                        <ul className="list-disc pl-6 mt-2 text-lg">
                            <li>Awajahi values your privacy and adheres to applicable data protection laws. Your personal and operational data will be stored securely and only used in accordance with our Privacy Policy.</li>
                            <li>By using the platform, you consent to the collection and use of your data as outlined in our Privacy Policy.</li>
                        </ul>

                        <h2 className="text-2xl font-bold mt-6">Intellectual Property</h2>
                        <ul className="list-disc pl-6 mt-2 text-lg">
                            <li>All content and materials available on the platform, including but not limited to text, graphics, logos, and software, are the property of Awajahi or its licensors and are protected by intellectual property laws.</li>
                            <li>Users are prohibited from copying, distributing, or creating derivative works from any content on the platform without prior written permission from Awajahi.</li>
                        </ul>

                        <h2 className="text-2xl font-bold mt-6">Limitation of Liability</h2>
                        <ul className="list-disc pl-6 mt-2 text-lg">
                            <li>Awajahi is provided &quot;as is&quot; and &quot;as available.&quot; We do not guarantee that the platform will always be available, error-free, or secure. We disclaim all liability for any damages arising from the use or inability to use the platform.</li>
                            <li>Awajahi will not be held responsible for any loss or damage, including financial losses, that may occur due to delays, interruptions, or failures in the platforms functionality.</li>
                        </ul>

                        <h2 className="text-2xl font-bold mt-6">Termination</h2>
                        <ul className="list-disc pl-6 mt-2 text-lg">
                            <li>Awajahi reserves the right to terminate or suspend your account at any time for violation of these terms or if we suspect unlawful activity.</li>
                            <li>Upon termination, your access to the platform will cease immediately, and all content uploaded by you may be deleted.</li>
                        </ul>

                        <h2 className="text-2xl font-bold mt-6">Changes to Terms</h2>
                        <ul className="list-disc pl-6 mt-2 text-lg">
                            <li>Awajahi reserves the right to modify these terms at any time. Users will be notified of significant changes via email or a notification on the platform.</li>
                            <li>Continued use of the platform after the modification of terms constitutes your acceptance of the updated terms.</li>
                        </ul>

                        <h2 className="text-2xl font-bold mt-6">Governing Law</h2>
                        <ul className="list-disc pl-6 mt-2 text-lg">
                            <li>These terms are governed by and construed in accordance with the laws of India, and any disputes shall be subject to the exclusive jurisdiction of the courts in Delhi, India.</li>
                        </ul>

                        <h2 className="text-2xl font-bold mt-6">Contact Us</h2>
                        <ul className="list-disc pl-6 mt-2 text-lg">
                            <li>For any questions or concerns regarding these terms, please contact us at: <a className='text-blue-500' href="mailto:info@awajahi.com">info@awajahi.com</a></li>
                        </ul>


                    </div>

                </div>
            </div>
        </div>


    );
};

export default TermsPage;
</file>

<file path="src/app/trip-management/page.tsx">
import Navigation from '@/components/Navigation';
import Footer from '@/components/Footer';
import Image from 'next/image';
import tripIcon from '@/assets/trip management icon.png';

export default function TripManagement() {
  return (
    <div className="w-full overflow-x-hidden text-black">
      <Navigation />

      <main className="container mx-auto px-4 py-16">
        <div className="max-w-4xl mx-auto text-center">
          <div className="mb-8">
            <Image
              src={tripIcon}
              alt="Trip Management Icon"
              width={100}
              height={100}
              className="mx-auto mb-6"
            />
            <h1 className="text-4xl font-bold mb-4 text-[#FE8631]">Trip Management</h1>
            <p className="text-xl text-gray-600 mb-8">
              Streamline your logistics operations with our comprehensive trip management solution.
            </p>
          </div>

          <div className="grid md:grid-cols-2 gap-8 text-left">
            <div className="bg-white p-6 rounded-lg shadow-md">
              <h2 className="text-2xl font-semibold mb-4 text-[#FE8631]">Key Features</h2>
              <ul className="space-y-3 text-gray-700">
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Real-time trip tracking and monitoring
                </li>
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Automated route planning and optimization
                </li>
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Driver and vehicle assignment
                </li>
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Trip documentation and reporting
                </li>
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Fuel consumption tracking
                </li>
              </ul>
            </div>

            <div className="bg-white p-6 rounded-lg shadow-md">
              <h2 className="text-2xl font-semibold mb-4 text-[#FE8631]">Benefits</h2>
              <ul className="space-y-3 text-gray-700">
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Improved operational efficiency
                </li>
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Reduced transportation costs
                </li>
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Better customer service with accurate ETAs
                </li>
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Enhanced compliance and documentation
                </li>
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Real-time visibility across your fleet
                </li>
              </ul>
            </div>
          </div>

          <div className="mt-12 bg-gradient-to-r from-[#FE8631] to-[#FFC499] p-8 rounded-lg text-white">
            <h2 className="text-3xl font-bold mb-4">Ready to Optimize Your Trips?</h2>
            <p className="text-lg mb-6">
              Join thousands of businesses already using Awajahi for efficient trip management.
            </p>
            <button className="bg-white text-[#FE8631] px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 transition">
              Schedule a Demo
            </button>
          </div>
        </div>
      </main>

      <Footer />
    </div>
  );
}
</file>

<file path="src/app/user/documents/companyDocuments/page.tsx">
'use client';

import Link from 'next/link';
import React, { useCallback, useEffect, useState, useMemo } from 'react';
import { FaChevronRight } from 'react-icons/fa6';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import dynamic from 'next/dynamic';
import { useToast } from '@/components/hooks/use-toast';
import { Loader2 } from 'lucide-react';
import CompanyDocumentUploadModal from '@/components/documents/company-document-upload-modal';
import debounce from 'lodash/debounce';
import filter from 'lodash/filter';

const RecentDocuments = dynamic(() => import('@/components/documents/RecentDocuments'), { ssr: false })

interface Document {
  id: string;
  filename: string;
  url: string;
  uploadedDate: string;
  // Add other properties as needed
}

const CompanyDocuments = () => {
  const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid');
  const [searchTerm, setSearchTerm] = useState<string>('');
  const [docs, setDocs] = useState<Document[]>([]);
  const [message, setMessage] = useState('');
  const [loading, setLoading] = useState(true);
  const { toast } = useToast();

  const fetchDocuments = async () => {
    try {
      setMessage('Fetching documents...');
      const res = await fetch(`/api/users`);
      if (!res.ok) {
        throw new Error('Failed to fetch documents');
      }
      const data = await res.json();
      setDocs(data.user.documents);
      setMessage('');
    } catch (error) {
      toast({
        description: 'Failed to fetch documents',
        variant: 'destructive'
      });
      console.error(error);
      setMessage('Failed to fetch documents');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchDocuments();
  }, []);

  const filteredDocs = useMemo(() => {
    return filter(docs, (doc) => 
      doc.filename?.toLowerCase().includes(searchTerm.toLowerCase())
    );
  }, [docs, searchTerm]);

  const debouncedSearch = useMemo(
    () => debounce((value: string) => {
      setSearchTerm(value);
    }, 300),
    []
  );

  const handleSearch = (e: React.ChangeEvent<HTMLInputElement>) => {
    debouncedSearch(e.target.value);
  };

  useEffect(() => {
    return () => {
      debouncedSearch.cancel();
    };
  }, [debouncedSearch]);

  return (
    <div className="p-6 bg-gray-100 min-h-screen">
      <div className="flex items-center justify-between mb-4 border-b-2 border-gray-300 pb-2">
        <h1 className="text-2xl font-semibold text-black flex items-center space-x-2">
          <Button variant="link" className="p-0 m-0">
            <Link href={`/user/documents`} className="text-2xl font-semibold hover:underline">
              Docs
            </Link>
          </Button>
          <FaChevronRight className="text-lg text-gray-500" />
          <span>Company Docs</span>
        </h1>
        <div className="flex items-center space-x-4">
          <Input
            type="text"
            placeholder="Search documents"
            onChange={handleSearch}
            className="px-4 py-2 rounded-md border border-gray-300"
            aria-label="Search documents"
          />
          <CompanyDocumentUploadModal setDocs={setDocs} />
        </div>
      </div>

      <div className="py-4">
        {loading ? (
          <p className="text-center flex items-center justify-center">
            <Loader2 className="text-bottomNavBarColor mr-2 animate-spin" />
            {message}
          </p>
        ) : filteredDocs.length > 0 ? (
          <RecentDocuments docs={filteredDocs} />
        ) : searchTerm ? (
          <p className="text-center">No documents found matching &quot;{searchTerm}&quot;</p>
        ) : (
          <p className="text-center">No documents found</p>
        )}
      </div>
    </div>
  );
};

export default CompanyDocuments;
</file>

<file path="src/app/user/documents/driverDocuments/[driverId]/page.tsx">
'use client'
import React from 'react'
import dynamic from 'next/dynamic'
import { useParams } from 'next/navigation';


const DriverDocumentsPage = () => {
    const DriverDocument = dynamic(() => import('@/components/driver/DriverDocument'), { ssr: false });
    const {driverId} = useParams()
  return (
    <div><DriverDocument driverId={driverId as string} /></div>
  )
}

export default DriverDocumentsPage
</file>

<file path="src/app/user/documents/layout.tsx">
'use client'
import { Roboto } from 'next/font/google';
import { RecentDocumentsProvider } from "@/context/recentDocs";

// Import Roboto font from Google Fonts




export default function RootLayout({
    children,
}: Readonly<{
    children: React.ReactNode;
}>) {
    return (
        <div className="">
            <RecentDocumentsProvider>
                {children}
            </RecentDocumentsProvider>
        </div>
    );
}
</file>

<file path="src/app/user/documents/loading.tsx">
import React from "react";

export default function Loading() {
  return (
    <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-10 z-50">
      
        <iframe 
          src="https://lottie.host/embed/3d45f054-61ac-4d4e-837c-2fa3006e28cc/MeZ8JDXVB5.json" 
        ></iframe>
    </div>
  );}
</file>

<file path="src/app/user/documents/otherDocuments/page.tsx">
'use client';

import Link from 'next/link';
import React, { useCallback, useEffect, useState, useMemo } from 'react';
import { FaChevronRight } from 'react-icons/fa6';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import dynamic from 'next/dynamic';
import { useToast } from '@/components/hooks/use-toast';
import { Loader2 } from 'lucide-react';
import OtherDocumentUploadModal from '@/components/documents/other-document-upload-modal';
import debounce from 'lodash/debounce';
import filter from 'lodash/filter';

const RecentDocuments = dynamic(() => import('@/components/documents/RecentDocuments'), { ssr: false })

interface Document {
  id: string;
  filename: string;
  url: string;
  uploadedDate: string;
  validityDate?: string;
  // Add other properties as needed
}

const OtherDocuments = () => {
  const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid');
  const [searchTerm, setSearchTerm] = useState<string>('');
  const [documents, setDocuments] = useState<Document[]>([]);
  const [message, setMessage] = useState('');
  const [loading, setLoading] = useState(true);
  const { toast } = useToast();

  const fetchDocuments = async () => {
    try {
      setMessage('Fetching documents...');
      const res = await fetch(`/api/documents`);
      if (!res.ok) {
        throw new Error('Failed to fetch documents');
      }
      const data = await res.json();
      setDocuments(data.documents);
      setMessage('');
    } catch (error) {
      toast({
        description: 'Failed to fetch documents',
        variant: 'destructive'
      });
      console.error(error);
      setMessage('Failed to fetch documents');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchDocuments();
  }, []);

  const filteredDocuments = useMemo(() => {
    return filter(documents, (doc) => 
      doc.filename.toLowerCase().includes(searchTerm.toLowerCase())
    );
  }, [documents, searchTerm]);

  const debouncedSearch = useMemo(
    () => debounce((value: string) => {
      setSearchTerm(value);
    }, 300),
    []
  );

  const handleSearch = (e: React.ChangeEvent<HTMLInputElement>) => {
    debouncedSearch(e.target.value);
  };

  useEffect(() => {
    return () => {
      debouncedSearch.cancel();
    };
  }, [debouncedSearch]);

  return (
    <div className="p-6 bg-gray-100 min-h-screen">
      <div className="flex items-center justify-between mb-4 border-b-2 border-gray-300 pb-2">
        <h1 className="text-2xl font-semibold text-black flex items-center space-x-2">
          <Button variant="link" className="p-0 m-0">
            <Link href={`/user/documents`} className="text-2xl font-semibold hover:underline">
              Docs
            </Link>
          </Button>
          <FaChevronRight className="text-lg text-gray-500" />
          <span>Ouick Uploads</span>
        </h1>
        <div className="flex items-center space-x-4">
          <Input
            type="text"
            placeholder="Search documents"
            onChange={handleSearch}
            className="px-4 py-2 rounded-md border border-gray-300"
            aria-label="Search documents"
          />
          <OtherDocumentUploadModal setDocs={setDocuments} />
        </div>
      </div>

      <div className="py-4">
        {loading ? (
          <p className="text-center flex items-center justify-center">
            <Loader2 className="mr-2 text-bottomNavBarColor animate-spin" />
            {message}
          </p>
        ) : filteredDocuments.length > 0 ? (
          <RecentDocuments docs={filteredDocuments} setDocs={setDocuments}/>
        ) : searchTerm ? (
          <p className="text-center">No documents found matching &quot;{searchTerm}&quot;</p>
        ) : (
          <p className="text-center">No documents found</p>
        )}
      </div>
    </div>
  );
};

export default OtherDocuments;
</file>

<file path="src/app/user/documents/page.tsx">
'use client';
import Link from 'next/link';
import React, { useEffect, useState } from 'react';
import { FaRoute, FaTruck } from 'react-icons/fa';
import { PiSteeringWheel } from 'react-icons/pi';
import { GoOrganization } from 'react-icons/go';
import dynamic from 'next/dynamic';
import { loadingIndicator } from '@/components/ui/LoadingIndicator';
import { useRecentDocsCtx } from '@/context/recentDocs';
import { BiCloudUpload } from 'react-icons/bi';
import { useSWRConfig } from 'swr';
import { Button } from '@/components/ui/button';
import { CloudUpload, X } from 'lucide-react';
import { motion } from 'framer-motion';
import TruckDocumentUpload from '@/components/documents/TruckDocumentUpload';
import TripDocumentUpload from '@/components/documents/TripDocumentUpload';
import DriverDocumentUpload from '@/components/documents/DriverDocumentUpload';
import CompanyDocumentUpload from '@/components/documents/CompanyDocumentUpload';
import OtherDocumentUpload from '@/components/documents/OtherDocumentUpload';

const RecentDocuments = dynamic(() => import('@/components/documents/RecentDocuments'), { ssr: false });

const DocumentsPage = () => {
  const { documents, counts, docsLoading } = useRecentDocsCtx()
  const [error, setError] = useState('');
  const { mutate } = useSWRConfig()
  const [open, setOpen] = useState(false)
  const [tripOpen, setTripOpen] = useState(false);
  const [truckOpen, setTruckOpen] = useState(false);
  const [driverOpen, setDriverOpen] = useState(false);
  const [companyOpen, setCompanyOpen] = useState(false);
  const [otherOpen, setOtherOpen] = useState(false);


  useEffect(() => {
    mutate('/api/documents/recent')
  }, [mutate])

  // const fetchRecentDocuments = async () => {
  //   try {
  //     const res = await fetch(`/api/documents/recent`);
  //     if (!res.ok) {
  //       throw new Error('Failed to fetch recent documents');
  //     }
  //     const data = await res.json();
  //     if (data.documents.length === 0) {
  //       setError('No recent documents found');
  //       return;
  //     }

  //     // Update both recentDocs and counts
  //     setRecentDocs(data.documents);
  //     setCounts(data.counts);  // Assuming `data.counts` contains {tripDocuments, driverDocuments, truckDocuments}
  //   } catch (error: any) {
  //     console.log(error);
  //     setError('Failed to load documents');
  //   } finally {
  //     setLoading(false);
  //   }
  // };

  const documentTypes = [
    {
      title: 'Trip Documents',
      link: '/user/documents/tripDocuments',
      icon: <FaRoute className='text-bottomNavBarColor' size={40} />
    },
    {
      title: 'Driver Documents',
      link: '/user/documents/driverDocuments',
      icon: <PiSteeringWheel className='text-bottomNavBarColor' size={40} />
    },
    {
      title: 'Lorry Documents',
      link: '/user/documents/truckDocuments',
      icon: <FaTruck className='text-bottomNavBarColor' size={40} />
    },
    {
      title: 'Company Documents',
      link: '/user/documents/companyDocuments',
      icon: <GoOrganization className='text-bottomNavBarColor' size={40} />
    },
    {
      title: 'Quick Uploads',
      link: '/user/documents/otherDocuments',
      icon: <BiCloudUpload className='text-bottomNavBarColor' size={40} />
    }
  ];

  const openModal = (title: string) => {
    setOpen(false)
    switch (title) {
      case 'Trip Documents':
        setTripOpen(!tripOpen);
        break;
      case 'Truck Documents':
        setTruckOpen(!truckOpen);
        break;
      case 'Driver Documents':
        setDriverOpen(!driverOpen);
        break;
      case 'Company Documents':
        setCompanyOpen(!companyOpen);
        break;
      case 'Quick Uploads':
        setOtherOpen(!otherOpen);
        break;
      default:
        break;
    }
  }

  // useEffect(() => {
  //   fetchRecentDocuments();
  // }, []);

  return (
    <div className="p-6 bg-gray-100 min-h-screen">
      <div className="flex items-center justify-between mb-4 border-b-2 border-gray-300 pb-2">
        <h1 className="text-2xl font-semibold text-black">Documents</h1>
      </div>

      <div className='flex justify-end my-2 fixed right-4 bottom-4'>
        <Button onClick={() => setOpen(true)} className='rounded-full h-full py-2'><CloudUpload size={40} /></Button>
      </div>

      <div className="grid grid-cols-5 gap-4 border-b-2 border-gray-300 py-4">
        {documentTypes.map((type) => (
          <Link href={type.link} key={type.title}>
            <div className="bg-white p-4 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300 ease-in-out hover:shadow-lightOrangeButtonColor hover:bg-lightOrange cursor-pointer">
              <div className="flex flex-col items-start">
                {type.icon}
                <h1 className="text-left text-lg font-semibold text-black mt-4">
                  {type.title}
                </h1>
                <p className="text-gray-400">
                  {/* Display the counts from the state */}
                  {type.title === 'Trip Documents' && counts.tripDocuments + ' files'}
                  {type.title === 'Driver Documents' && counts.driverDocuments + ' files'}
                  {type.title === 'Lorry Documents' && counts.truckDocuments + ' files'}
                  {type.title === 'Company Documents' && counts.companyDocuments + ' files'}
                  {type.title === 'Quick Uploads' && counts.otherDocuments + ' files'}
                </p>
              </div>
            </div>
          </Link>
        ))}
      </div>

      <div>
        <div className="mb-2">
          <h1 className="text-xl text-black font-semibold my-4">Recently Uploaded</h1>
        </div>
        {docsLoading && <div>{loadingIndicator}</div>}
        {error && <p className="text-red-500">{error}</p>}
        {documents && <RecentDocuments docs={documents} />}
      </div>
      {
        open &&
        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-40 flex items-center justify-center">
          <motion.div
            initial={{ opacity: 0, scale: 0.95 }}
            animate={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, scale: 0.95 }}
            transition={{
              duration: 0.2,
              ease: [0.4, 0, 0.2, 1]
            }}
            className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden"
          >
            <div className="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
              <h2 className="text-2xl font-semibold text-gray-900 dark:text-gray-100">Select Document Type</h2>
              <Button variant="ghost" size="icon" onClick={() => setOpen(false)}>
                <X className="h-5 w-5" />
              </Button>
            </div>
            <div className="p-6 grid grid-cols-2 sm:grid-cols-5 gap-6">
              {documentTypes.map(({ title, icon }) => (
                <Button
                  key={title}
                  variant="outline"
                  className="flex flex-col items-center justify-center h-32 hover:bg-gray-50 dark:hover:bg-gray-700"
                  onClick={() => openModal(title)}
                >
                  {/* Replace with your actual icon component */}
                  <div className="text-3xl mb-2">{icon}</div>
                  <p className="text-sm font-medium">{title.split(' ')[0]}</p>
                </Button>
              ))}
            </div>


          </motion.div>

        </div>
      }

      <TruckDocumentUpload open={truckOpen} setOpen={setTruckOpen} />



      <TripDocumentUpload open={tripOpen} setOpen={setTripOpen} />


      <DriverDocumentUpload open={driverOpen} setOpen={setDriverOpen} />


      <CompanyDocumentUpload open={companyOpen} setOpen={setCompanyOpen} />


      <OtherDocumentUpload open={otherOpen} setOpen={setOtherOpen} />

    </div>
  );
};

export default DocumentsPage;
</file>

<file path="src/app/user/documents/tripDocuments/[tripId]/page.tsx">
'use client'

import Loading from '@/app/user/loading'
import { Button } from '@/components/ui/button'
import { ITrip } from '@/utils/interface'
import { useParams } from 'next/navigation'
import React, { useEffect, useState } from 'react'
import dynamic from 'next/dynamic'
import Link from 'next/link'
import TripDocumentUpload from '@/components/documents/TripDocumentUpload'
import { FaChevronRight } from 'react-icons/fa6'
import { CloudUpload } from 'lucide-react'

const TripDocumentsPage = () => {
    const { tripId } = useParams() as { tripId: string };
    const [trip, setTrip] = useState<ITrip | null>(null);
    const [loading, setLoading] = useState(true)
    const [modalOpen, setModalOpen] = useState(false)

    const TripDocuments = dynamic(() => import('@/components/trip/TripDocuments'), { ssr: false })

    const fetchTrip = async () => {
        try {
            const res = await fetch(`/api/trips/${tripId}`);
            if (res.ok) {
                const data = await res.json();
                console.log(data)
                setTrip(data.trip);
            } else {
                alert('Failed to fetch trip');
            }
        } catch (error) {
            console.error(error);
            alert('Failed to fetch trip');
        } finally {
            setLoading(false)
        }
    };

    useEffect(() => {
        if (tripId) {
            fetchTrip();
        }
    }, [tripId]);

    if (loading) {
        return <Loading />
    }

    return (
        <div className="p-6 bg-white shadow-lg rounded-lg">
            {/* Trip Documents Section */}

            <div>
                {/* Title and Upload Button */}
                <div className="flex items-center justify-between mb-6 border-b-2 border-gray-300 pb-2">
                    <h1 className="text-2xl font-semibold text-black flex items-center space-x-2">
                        <Button variant={'link'}>
                            <Link href="/user/documents" className="text-2xl font-semibold hover:underline">
                                Docs
                            </Link>
                        </Button>

                        <FaChevronRight className="text-lg text-gray-500" />
                        <Button variant={'link'}>
                            <Link href="/user/documents/tripDocuments" className="text-2xl font-semibold hover:underline">
                                Trip Docs
                            </Link>
                        </Button>

                        <FaChevronRight className="text-lg text-gray-500" />
                        <span className="text-2xl font-semibold hover:underline">Trip...</span>
                    </h1>

                    <div className='flex justify-end my-2 fixed right-4 bottom-4'>
                        <Button onClick={() => setModalOpen(true)} className='rounded-full h-full py-2'><CloudUpload size={40} /></Button>
                    </div>
                </div>

                {/* Trip Documents Component */}
                {trip &&
                    <TripDocuments
                        startDate={new Date(trip.startDate)}
                        route={trip.route}
                        ewbValidityDate={new Date(trip.ewbValidityDate)}
                        documents={trip.documents || []}
                    />
                }


                        <TripDocumentUpload open={modalOpen} setOpen={setModalOpen} tripId={tripId} />
                   
            </div>
        </div>


    );
};

export default TripDocumentsPage;
</file>

<file path="src/app/user/documents/tripDocuments/page.tsx">
'use client';


import Link from 'next/link';
import React, { useCallback, useEffect, useState } from 'react';
import { FaChevronRight, FaFolder, FaList } from 'react-icons/fa6';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import dynamic from 'next/dynamic';
import { loadingIndicator } from '@/components/ui/LoadingIndicator';
import ewbIcon from '@/assets/ewb-icon.png';
import podIcon from '@/assets/pod-icon.png';
import otherIcon from '@/assets/others.png';
import Image from 'next/image';
import biltyIcon from '@/assets/bilty-icon.png';
import folderIcon from '@/assets/folder-icon.png'
import { FaThLarge } from 'react-icons/fa';
import TripDocumentUpload from '@/components/documents/TripDocumentUpload';
import { CloudUpload } from 'lucide-react';
import { useExpenseData } from '@/components/hooks/useExpenseData';
import { motion } from 'framer-motion';

const TripDocumentsLanding = () => {
  const TripDocArray = [
    {
      title: 'E-Way Bill',
      icon: ewbIcon, // Icon representing an invoice-like document for E-Way Bill
    },
    {
      title: 'POD',
      icon: podIcon, // Icon representing proof of delivery (contract-like document)
    },
    {
      title: 'Bilty',
      icon: biltyIcon, // Icon representing a truck loading document (Bilty)
    },
    {
      title: 'FM/Challan',
      icon: biltyIcon
    },
    {
      title: 'Other',
      icon: otherIcon, // Folder icon for "Other" category
    },
  ];

  const { trips, isLoading } = useExpenseData();
  const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid');
  const [searchTerm, setSearchTerm] = useState<string>('');
  const [modalOpen, setModalOpen] = useState(false);
  const [message, setMessage] = useState('');
  const [loading, setLoading] = useState(false);
  const [documents, setDocuments] = useState<any[]>([]);
  const [type, setType] = useState('');

  const RecentDocuments = dynamic(() => import('@/components/documents/RecentDocuments'), { ssr: false });

  const fetchDocuments = useCallback(async () => {
    if (type) {
      try {
        setLoading(true)
        setMessage('Fetching documents...');
        const res = await fetch(`/api/trips/documents?type=${encodeURIComponent(type as string)}`);
        const data = res.ok ? await res.json() : setMessage('Failed to fetch documents');
        setDocuments(data.documents);
        setMessage('');
        if (data.documents.length === 0) {
          setMessage('No documents found');
        }
      } catch (error) {
        console.error(error);
        alert('Failed to fetch documents');
        setMessage('Failed to fetch documents');
      } finally {
        setLoading(false);
      }
    }
  }, [type]);

  useEffect(() => {
    fetchDocuments();
  }, [fetchDocuments]);

  const filteredTrips = trips.filter(
    (trip) =>
      trip.route.origin.toLowerCase().includes(searchTerm.toLowerCase()) ||
      trip.route.destination.toLowerCase().includes(searchTerm.toLowerCase()) ||
      new Date(trip.startDate).toLocaleDateString().includes(searchTerm.toLowerCase()) ||
      trip.LR.toLowerCase().includes(searchTerm.toLowerCase()) ||
      trip.truck.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const filteredDocs = documents.filter(
    (doc) =>
      doc.route.origin.toLowerCase().includes(searchTerm.toLowerCase()) ||
      doc.route.destination.toLowerCase().includes(searchTerm.toLowerCase()) ||
      doc.LR.toLowerCase().includes(searchTerm.toLowerCase()) ||
      doc.truck.toLowerCase().includes(searchTerm.toLowerCase()) ||
      new Date(doc.startDate).toLocaleDateString().includes(searchTerm.toLowerCase())
  );

  return (
    <div className="p-6 bg-[#FBFBFB] min-h-screen">
      <div className="flex items-center justify-between mb-4 border-b-2 border-gray-300 pb-2">
        <h1 className="text-2xl font-semibold text-black flex items-center space-x-2">
          <Button variant="link" className="p-0 m-0">
            <Link href={`/user/documents`} className="text-2xl font-semibold hover:underline">
              Docs
            </Link>
          </Button>
          <FaChevronRight className="text-lg text-gray-500" />
          <span>Trip Docs</span>
        </h1>

        <div className="flex items-center space-x-4">
          <Input
            type="text"
            placeholder="Search"
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="px-4 py-2 rounded-md border border-gray-300"
          />
          {!type && (
            <Button onClick={() => setViewMode(viewMode === 'grid' ? 'list' : 'grid')}>
              {viewMode === 'grid' ? (
                <FaList className="text-xl" />
              ) : (
                <FaThLarge className="text-xl" />
              )}
            </Button>
          )}
          <div className='flex justify-end my-2 fixed right-4 bottom-4'>
            <Button onClick={() => setModalOpen(true)} className='rounded-full h-full py-2'><CloudUpload size={40} /></Button>
          </div>
        </div>
      </div>

      <div className="my-4">
        <h1 className="text-lg font-semibold text-black my-4">Select Document Type</h1>
        <div className="grid grid-cols-5 gap-4">
          {TripDocArray.map((item: any, index: number) => (
            <motion.div
              key={index}
              onClick={() => setType((prev) => (prev === item.title ? '' : item.title))}
              initial={{ opacity: 0, scale: 0.9 }}
              animate={{ opacity: 1, scale: 1 }}
              whileHover={{ scale: 1.1, boxShadow: '0px 4px 10px rgba(0, 0, 0, 0.1)' }}
              transition={{ duration: 0.3, ease: 'easeInOut' }}
            >
              <div
                className={`flex flex-col items-center justify-center border border-gray-300 gap-4 bg-[#FBFBFB] rounded-lg p-6 transition-all cursor-pointer ${type === item.title ? 'bg-lightOrange' : ''
                  }`}
              >
                <Image src={item.icon} alt={item.title} width={100} height={100} priority />
                <h2 className="text-xl font-semibold text-black text-center">{item.title}</h2>
              </div>
            </motion.div>
          ))}
        </div>
      </div>

      {!type ? (
        <div>
          <h1 className="text-lg font-semibold text-black py-4 mt-4">Or Select Trip</h1>
          <div className={viewMode === 'grid' ? 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6' : 'flex flex-col space-y-4'}>
            {filteredTrips.length > 0 ? (
              filteredTrips.map((trip) => (
                <Link
                  href={{
                    pathname: `/user/documents/tripDocuments/${trip.trip_id}`,
                  }}
                  key={trip.trip_id}
                >
                  <motion.div
                    initial={{ opacity: 0 }} // Initial state: fully transparent
                    animate={{ opacity: 1 }} // Final state: fully visible
                    transition={{ duration: 1 }} // Optional: transition duration in seconds
                    className={`bg-white p-6 rounded-xl hover:shadow-lg border border-gray-300 transition-all duration-300 ease-in-out hover:bg-gray-50 cursor-pointer ${viewMode === 'grid' ? 'h-full' : 'flex justify-between items-center w-full px-8 py-6'
                      }`}
                  >
                    {/* Folder icon */}
                    <Image src={folderIcon} alt='folder icon' width={48} height={48} priority className={viewMode === 'list' ? 'mr-6' : ''} />

                    {/* Trip Details */}
                    <div className="flex flex-col flex-grow">
                      <span className="font-semibold text-black">{trip.route.origin} &rarr; {trip.route.destination}</span>
                      <span className="text-gray-500">Start Date: {new Date(trip.startDate).toLocaleDateString()}</span>

                      {/* Additional Information */}
                      <div className="flex justify-between items-center mt-2">
                        <span className="text-gray-500">LR: {trip.LR}</span>
                        <span className="text-gray-700">Truck: {trip.truck}</span>
                      </div>
                    </div>
                  </motion.div>
                </Link>
              ))
            ) : (
              <span className="text-center col-span-3 text-gray-500">
                {(isLoading || loading) && loadingIndicator} {message}
              </span>
            )}
          </div>
        </div>
      ) : (
        <div className='py-4'>
          {loading ? (
            <p className='text-center'>{loadingIndicator} {message}</p>
          ) : (
            filteredDocs.length > 0 ? <RecentDocuments docs={filteredDocs} /> : <p>No documents found</p>
          )}
        </div>
      )}

      <TripDocumentUpload open={modalOpen} setOpen={setModalOpen} />

    </div>
  );
};

export default TripDocumentsLanding;
</file>

<file path="src/app/user/documents/truckDocuments/[truckNo]/page.tsx">
'use client'
import React from 'react'
import dynamic from 'next/dynamic'
import { useParams } from 'next/navigation';


const TruckDocumentsPage = () => {
    const TruckDocument = dynamic(() => import('@/components/truck/TruckDocument'), { ssr: false });
    const {truckNo} = useParams()
  return (
    <div><TruckDocument truckNo={truckNo as string} /></div>
  )
}

export default TruckDocumentsPage
</file>

<file path="src/app/user/documents/truckDocuments/page.tsx">
'use client';

import { truckTypesIcons } from '@/utils/utilArray';
import Link from 'next/link';
import React, { useCallback, useEffect, useState } from 'react';
import { FaChevronRight, FaFileContract, FaFolder, FaFolderOpen, FaLeaf, FaList, FaRegIdCard } from 'react-icons/fa6';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import dynamic from 'next/dynamic';
import { loadingIndicator } from '@/components/ui/LoadingIndicator';
import { FaShieldAlt, FaThLarge } from 'react-icons/fa';
import folderIcon from '@/assets/folder-icon.png'
import Image from 'next/image';
import { TbReceiptTax } from 'react-icons/tb';
import TruckDocumentUpload from '@/components/documents/TruckDocumentUpload';
import { CloudUpload } from 'lucide-react';
import { useExpenseData } from '@/components/hooks/useExpenseData';
import { motion } from 'framer-motion';

const TruckDocArray = [
  {
    title: 'Registration Certificate',
    icon: <FaRegIdCard className='text-bottomNavBarColor' size={70} /> // Icon representing an ID card or certificate
  },
  {
    title: 'Permit',

    icon: <FaFileContract className='text-bottomNavBarColor' size={70} /> // Icon representing a legal permit or document
  },
  {
    title: 'Insurance',

    icon: <FaShieldAlt className='text-bottomNavBarColor' size={70} /> // Icon representing protection or insurance
  },
  {
    title: 'Pollution Certificate',

    icon: <FaLeaf className='text-bottomNavBarColor' size={70} /> // Icon representing environmental or pollution-related certification
  },
  {
    title: 'Fitness Certificate',

    icon: <FaFolderOpen className='text-bottomNavBarColor' size={70} /> // Folder icon for "Other" category
  },

  {
    title: 'Tax',

    icon: <TbReceiptTax className='text-bottomNavBarColor' size={70} /> // Folder icon for "Other" category
  },
  {
    title: 'Other',

    icon: <FaFolderOpen className='text-bottomNavBarColor' size={70} /> // Folder icon for "Other" category
  },

];

const TruckDocuments = () => {
  const { isLoading, trucks } = useExpenseData()
  const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid');
  const [searchTerm, setSearchTerm] = useState<string>('');
  const [modalOpen, setModalOpen] = useState(false)
  const [documents, setDocuments] = useState<any[]>([])
  const [message, setMessage] = useState('')
  const [loading, setLoading] = useState(false)
  const [type, setType] = useState('')

  const RecentDocuments = dynamic(() => import('@/components/documents/RecentDocuments'))



  const fetchDocuments = useCallback(async () => {
    if (!type) return;

    setMessage('Fetching documents...');
    setLoading(true);

    try {
      const res = await fetch(`/api/trucks/documents?type=${encodeURIComponent(type)}`);
      const data = await res.json();
      if (res.ok && data.documents.length > 0) {
        setDocuments(data.documents);

        setMessage('');
      } else {
        setDocuments([]);
        setMessage('No documents found');
      }
    } catch (error) {
      console.error('Failed to fetch documents:', error);
      setMessage('Failed to fetch documents');
    } finally {
      setLoading(false);
    }
  }, [type]);

  useEffect(() => {
    fetchDocuments();
  }, [fetchDocuments]);

  const getTruckIcon = (truckType: string) => {
    const truckIconObj = truckTypesIcons.find((iconObj) => iconObj.type === truckType);
    return truckIconObj ? (
      <truckIconObj.Icon size={70} className="text-bottomNavBarColor mb-4" />
    ) : (
      <FaFolder size={70} className="text-bottomNavBarColor mb-4" />
    );
  };

  const filteredTrucks = trucks.filter(
    (truck) =>
      truck.truckNo.toLowerCase().includes(searchTerm.toLowerCase()) ||
      truck.truckType.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const filteredDocs = documents?.filter(
    (doc) =>
      doc.truckNo.toLowerCase().includes(searchTerm?.toLowerCase()) ||
      doc.truckType.toLowerCase().includes(searchTerm?.toLowerCase())
  );

  return (
    <div className="p-6 bg-[#FBFBFB] min-h-screen">
      <div className="flex items-center justify-between mb-4 border-b-2 border-gray-300 pb-2">
        <h1 className="text-2xl font-semibold text-black flex items-center space-x-2">
          <Button variant="link" className="p-0 m-0">
            <Link href={`/user/documents`} className="text-2xl font-semibold hover:underline">
              Docs
            </Link>
          </Button>
          <FaChevronRight className="text-lg text-gray-500" />
          <span>Lorry Docs</span>
        </h1>

        <div className="flex items-center space-x-4">
          <Input
            type="text"
            placeholder="Search"
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="px-4 py-2 rounded-md border border-gray-300"
          />
          {!type && (
            <Button onClick={() => setViewMode(viewMode === 'grid' ? 'list' : 'grid')}>
              {viewMode === 'grid' ? (
                <FaList className="text-xl" />
              ) : (
                <FaThLarge className="text-xl" />
              )}
            </Button>
          )}
          <div className='flex justify-end my-2 fixed right-4 bottom-4'>
            <Button onClick={() => setModalOpen(true)} className='rounded-full h-full py-2'><CloudUpload size={40} /></Button>
          </div>
        </div>
      </div>

      <div className="my-4">
        <h1 className="text-lg font-semibold text-black my-4">Select Document Type</h1>
        <div className="grid grid-cols-7 gap-6">
          {TruckDocArray.map((item: any, index: number) => (
            <motion.div
              key={index}
              onClick={() => setType((prev) => (prev === item.title ? '' : item.title))}
              initial={{ opacity: 0, scale: 0.9 }}
              animate={{ opacity: 1, scale: 1 }}
              whileHover={{ scale: 1.1, boxShadow: '0px 4px 10px rgba(0, 0, 0, 0.1)' }}
              transition={{ duration: 0.3, ease: 'easeInOut' }}
              className="col-span-1 max-h-[200px]"
            >
              <div
                className={`flex flex-col items-center justify-center border border-gray-300 gap-4 bg-[#FBFBFB] rounded-lg p-6 transition-all hover:shadow-md transform hover:scale-105 cursor-pointer h-full ${type === item.title ? 'bg-lightOrange' : ''}`}
              >
                {item.icon}
                <h2 className="text-lg font-semibold text-black text-center truncate max-w-full whitespace-normal h-[50px] flex items-center justify-center">
                  {item.title}
                </h2>
              </div>
            </motion.div>
          ))}
        </div>
      </div>


      {!type ? (
        <div>
          <h1 className="text-lg font-semibold text-black py-4 mt-4">Or Select Lorry</h1>
          <div className={viewMode === 'grid' ? 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6' : 'flex flex-col space-y-4'}>
            {filteredTrucks.length > 0 ? (
              filteredTrucks.map((truck) => (
                <Link
                  href={{
                    pathname: `/user/documents/truckDocuments/${truck.truckNo}`,
                  }}
                  key={truck.truckNo}
                >
                  <motion.div
                    initial={{ opacity: 0 }} // Initial state: fully transparent
                    animate={{ opacity: 1 }} // Final state: fully visible
                    transition={{ duration: 1 }} // Optional: transition duration in seconds
                    className={`bg-white p-6 rounded-xl hover:shadow-md border border-gray-300 transition-all duration-300 ease-in-out hover:bg-gray-50 cursor-pointer ${viewMode === 'grid' ? 'h-full flex justify-between items-center' : 'flex items-center space-x-4'}`}
                  >
                    <div className="flex-shrink-0">
                      <Image
                        src={folderIcon}
                        alt='folder icon'
                        width={48}
                        height={48}
                        className="object-contain"
                        priority
                      />
                    </div>

                    <div className="flex flex-col">
                      <span className="font-semibold">{truck.truckNo}</span>
                      <span className="text-gray-500">{truck.truckType}</span>
                      <span className="text-gray-500">{truck.supplierName}</span>
                    </div>
                  </motion.div>

                </Link>
              ))
            ) : (
              <span className="text-center col-span-3 text-gray-500">
                {(isLoading || loading) && loadingIndicator} {message}
              </span>
            )}
          </div>
        </div>
      ) : (
        <div className='py-4'>
          {loading ?
            <p className='text-center'>{loadingIndicator} {message}</p> :
            filteredDocs.length > 0 ? <RecentDocuments docs={filteredDocs} /> : <p>No documents found</p>
          }
        </div>
      )}


      <TruckDocumentUpload open={modalOpen} setOpen={setModalOpen} />

    </div>
  );
};

export default TruckDocuments;
</file>

<file path="src/app/user/drivers/[driverId]/documents/page.tsx">
'use client'
import { Button } from '@/components/ui/button'
import { useParams } from 'next/navigation'
import React, { useEffect, useState } from 'react'
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog'
import Link from 'next/link'
import DriverDocumentUpload from '@/components/documents/DriverDocumentUpload'
import { useDriver } from '@/context/driverContext'
import { loadingIndicator } from '@/components/ui/LoadingIndicator'
import RecentDocuments from '@/components/documents/RecentDocuments'
import { CloudUpload } from 'lucide-react'

// Define allowed document types
const allowedDocuments = ["License", "Aadhar", "PAN", "PoliceVerification"];
type Document = {
  _id: string,
  filename: string,
  docType: string,
  uploadedDate: string,
  validityDate: string,
  url: string
}
const DriverDocuments = () => {
  const { driver, setDriver, loading } = useDriver()
  const [isModalOpen, setIsModalOpen] = useState(false)




  if (loading) {
    return <div>{loadingIndicator}</div>
  }

  return (
    <div className="container mx-auto p-4">
      <div className="mb-6 flex items-center justify-between">
        <h1 className="text-2xl font-semibold text-gray-800">Driver Documents</h1>
        <Button onClick={() => setIsModalOpen(true)} className='rounded-full h-full py-2'><CloudUpload size={40} />
        </Button>
      </div>

      
          <DriverDocumentUpload open={isModalOpen} setOpen={setIsModalOpen} setDriver={setDriver} driverId={driver.driver_id} />

      <div>
        <RecentDocuments docs={driver?.documents} />
      </div>
    </div>
  )
}

export default DriverDocuments
</file>

<file path="src/app/user/drivers/[driverId]/layout.tsx">
'use client';

import { useParams, useRouter } from 'next/navigation';
import DriverLayout from '@/components/driver/driverLayout';
import { DriverProvider } from '@/context/driverContext';

interface PartyLayoutProps {
  children: React.ReactNode;
}

const Layout: React.FC<PartyLayoutProps> = ({ children }) => {
  const { driverId } = useParams();
  const router = useRouter()
  return (
    <DriverProvider driverId={driverId as string}>
      <DriverLayout driverId={driverId as string} onDriverUpdate={() => router.refresh()}>

        {children}

      </DriverLayout>
    </DriverProvider>
  );
};

export default Layout;
</file>

<file path="src/app/user/drivers/[driverId]/loading.tsx">
import React from "react";

export default function Loading() {
  return (
    <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-10 z-50">
      
        <iframe 
          src="https://lottie.host/embed/3d45f054-61ac-4d4e-837c-2fa3006e28cc/MeZ8JDXVB5.json" 
        ></iframe>
    </div>
  );}
</file>

<file path="src/app/user/drivers/[driverId]/page.tsx">
'use client'
import React, { useEffect, useMemo, useState } from 'react';
import { useParams, useRouter } from 'next/navigation';
import { MdDelete, MdEdit } from "react-icons/md";
import { IDriver, IDriverAccount, IExpense, PaymentBook } from '@/utils/interface';
import Loading from '../loading';
import { DeleteExpense, ExpenseforDriver, handleEditExpense } from '@/helpers/ExpenseOperation';
import { handleDelete as DeleteForExpense } from '@/helpers/ExpenseOperation';
import { DeleteAccount } from '@/helpers/TripOperation';
import { deleteDriverAccount, EditDriverAccount } from '@/helpers/driverOperations';
import { Button } from '@/components/ui/button';
import DriverModal from '@/components/driver/driverModal';
import { handleEditAccount } from '@/helpers/TripOperation';
import { handleAddCharge as EditExpense } from '@/helpers/ExpenseOperation';
import { FaCalendarAlt, FaSort, FaSortDown, FaSortUp } from 'react-icons/fa';
import Link from 'next/link';
import { formatNumber } from '@/utils/utilArray';
import dynamic from 'next/dynamic';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { useDriver } from '@/context/driverContext';

const Driver: React.FC = () => {
  const { driverId } = useParams();

  const { driver, loading, setDriver } = useDriver()
  const [error, setError] = useState<string | null>(null);
  const [expenseEdit, setExpenseEdit] = useState(false);
  const [paymentEdit, setPaymentEdit] = useState(false);
  const [accountEdit, setAccountEdit] = useState(false);
  const [selected, setSelected] = useState<any>([]);
  const [sortConfig, setSortConfig] = useState<any>({ key: null, direction: 'asc' })


  const AddExpenseModal = dynamic(() => import('@/components/AddExpenseModal'), { ssr: false })


  const sortedAccounts = useMemo(() => {
    if (!driver?.driverExpAccounts || driver?.driverExpAccounts.length === 0) return []; // Ensure accounts is not null or empty

    // Utility functions to get sortable values for specific fields
    const getSortableDate = (account: any) => {
      return new Date(account.date || account.paymentDate).getTime(); // Use date if available, otherwise fallback to paymentDate
    };

    const getSortableGave = (account: any) => {
      return account.gave || (account.type === 'truck' ? account.amount : 0); // Use 'gave' or fallback to 'amount' if it's a truck expense
    };

    const getSortableGot = (account: any) => {
      return account.got || (account.type !== 'truck' ? account.amount : 0); // Use 'got' or fallback to 'amount' for non-truck types
    };

    let sortableAccounts = [...driver?.driverExpAccounts as any];

    if (sortConfig.key !== null) {
      sortableAccounts.sort((a, b) => {
        let aValue, bValue;
        if (sortConfig.key === 'date') {
          // Special case for date column
          aValue = getSortableDate(a);
          bValue = getSortableDate(b);
        } else if (sortConfig.key === 'gave') {
          // Special case for 'gave'
          aValue = getSortableGave(a);
          bValue = getSortableGave(b);
        } else if (sortConfig.key === 'got') {
          // Special case for 'got'
          aValue = getSortableGot(a);
          bValue = getSortableGot(b);
        } else {
          // Generic case for other fields
          aValue = a[sortConfig.key];
          bValue = b[sortConfig.key];
        }

        if (aValue < bValue) {
          return sortConfig.direction === 'asc' ? -1 : 1;
        }
        if (aValue > bValue) {
          return sortConfig.direction === 'asc' ? 1 : -1;
        }
        return 0;
      });
    }

    return sortableAccounts;
  }, [driver, sortConfig]);


  const requestSort = (key: any) => {
    let direction: 'asc' | 'desc' = 'asc'
    if (sortConfig.key === key && sortConfig.direction === 'asc') {
      direction = 'desc'
    }
    setSortConfig({ key, direction })
  }

  const getSortIcon = (columnName: any) => {
    if (sortConfig.key === columnName) {
      return sortConfig.direction === 'asc' ? <FaSortUp /> : <FaSortDown />
    }
    return <FaSort />
  }

  // const Modal = dynamic(() => import('@/components/trip/tripDetail/Modal'), { ssr: false })

  const handleDelete = async (account: any) => {
    let balance = driver.balance
    try {
      let deletedAccount: any;

      if (account.expenseType) {
        deletedAccount = await DeleteExpense(account._id);
        setDriver((prev : IDriver | any)=>({
          ...prev,
          driverExpAccounts : prev.driverExpAccounts.filter((acc : any) => acc._id !== deletedAccount._id),
          balance : prev.balance + deletedAccount.amount
        }))
      } else if (account.accountType) {
        deletedAccount = await DeleteAccount(account._id, account.trip_id, account.party_id);
        setDriver((prev : IDriver | any)=>({
          ...prev,
          driverExpAccounts : prev.driverExpAccounts.filter((acc : any) => acc.paymentBook_id !== deletedAccount.paymentBook_id),
          balance : prev.balance + deletedAccount.amount
        }))
      } else {
        const data = await deleteDriverAccount(driverId as string, account.account_id);
        deletedAccount = data.driver;
        setDriver((prev : IDriver | any)=>({
          ...prev,
          driverExpAccounts : prev.driverExpAccounts.filter((acc : any) => acc.account_id !== account.account_id),
          balance : prev.balance - account.got + account.gave
        }))
      }

      // Update driverExpAccounts in driver state with the updated accounts
      // setDriver((prev: any) => ({
      //   ...prev,
      //   driverExpAccounts: accounts.filter(acc => acc.account_id !== account.account_id),
      //   balance : balance
      // }));
    } catch (error) {
      console.error(error);
      alert(error);
    }
  };


  // const fetchDriverDetails = async () => {
  //   try {
  //     const response = await fetch(`/api/drivers/${driverId}`, {
  //       method: 'GET',
  //       headers: {
  //         'Content-Type': 'application/json',
  //       },
  //     });

  //     if (!response.ok) {
  //       throw new Error('Failed to fetch driver');
  //     }

  //     const result = await response.json();
  //     setDriver(result);
  //     setDriverAccounts(result.accounts);
  //   } catch (err: any) {
  //     setError(err.message);
  //   } finally {
  //     setLoading(false);
  //   }
  // };

  // const fetchTrips = async () => {
  //   try {
  //     const res = await fetch(`/api/trips/driver/${driverId}/accounts`, {
  //       method: 'GET',
  //       headers: {
  //         'Content-Type': 'application/json',
  //       },
  //     });

  //     if (!res.ok) {
  //       throw new Error('Failed to fetch trips');
  //     }

  //     const data = await res.json();
  //     return data.accounts;
  //   } catch (err) {
  //     setError((err as Error).message);
  //     console.log(err)
  //     return [];
  //   }
  // };

  // const fetchTruckExpenses = async () => {
  //   try {
  //     const truckExpense = await ExpenseforDriver(driverId as string);
  //     const formattedTruckExpenses = truckExpense.map((expense: IExpense) => ({
  //       ...expense,
  //       date: expense.date,
  //       type: 'truck',
  //     }));
  //     return formattedTruckExpenses;
  //   } catch (err) {
  //     setError((err as Error).message);
  //     return [];
  //   }
  // };

  // const fetchAllData = async () => {
  //   setLoading(true);
  //   const accountsData = await fetchTrips();
  //   const truckExpensesData = await fetchTruckExpenses();
  //   const allAccounts = [
  //     ...accountsData,
  //     ...truckExpensesData,
  //     ...driverAccounts,
  //   ];

  //   setAccounts(allAccounts.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()));
  //   setLoading(false);
  // };

  const handleEditAccounts = async (account: any) => {
    try {
      // Create a variable to store the updated accounts
      let updatedAccounts: any[] = [...driver?.driverExpAccounts];
      let updatedAccount: any;
      let balance : number = driver.balance

      if (account.expenseType) {
        // Handle expense edit logic
        const expense = await handleEditExpense(account, selected._id);
        balance += selected.amount
        updatedAccount = expense;

        updatedAccounts = updatedAccounts.filter(acc => acc._id !== expense._id);
       
        if (expense.driver === selected.driver) {
          updatedAccounts.push({ ...expense });
          balance -= expense.amount
        }

      } else if (account.accountType) {
        // Handle payment edit logic
        const result = await handleEditAccount(account, selected.trip_id, selected.party_id);
        if (result.error) {
          alert(result.error);
          return;
        }
        updatedAccount = result;
        balance = balance - (selected.amount - result.amount)

        updatedAccounts = updatedAccounts.map(acc =>
          acc._id === result._id ? { ...acc, ...updatedAccount } : acc
        );

      } else {
        // Handle driver account edit logic
        const data = await EditDriverAccount(driverId as string, account, selected.account_id);
        updatedAccount = data;
        balance = balance - (selected.got - updatedAccount.got + updatedAccount.gave - selected.gave)
        updatedAccounts = updatedAccounts.map(acc =>
          acc.account_id === updatedAccount.account_id ? { ...acc, ...updatedAccount } : acc
        );
      }

      // Now update the accounts and driverExpAccounts using updatedAccounts
      setDriver((prev: any) => ({
        ...prev,
        balance : balance,
        driverExpAccounts: updatedAccounts.map(acc => ({ ...acc })), // Ensure driverExpAccounts is synced
      }));

    } catch (error) {
      console.error(error);
      alert('Failed to Edit Account');
    }
  };



  // useEffect(() => {
  //   fetchDriverDetails();
  // }, [driverId]);

  // useEffect(() => {
  //   fetchAllData();
  // }, [driverId, driverAccounts]);

  if (loading) {
    return <Loading />;
  }

  if (error) {
    return <div>Error: {error}</div>;
  }

  if (!driver) {
    return <div>No driver found</div>;
  }

  return (
    <div className="w-full">

      <div className="w-full h-full p-4">
        <div className="table-container">
          <Table className="custom-table">
            <TableHeader>
              <TableRow>
                <TableHead onClick={() => requestSort('date')}>
                  <div className='flex justify-between'>
                    Date {getSortIcon('date')}
                  </div>

                </TableHead>
                <TableHead>Reason</TableHead>
                <TableHead onClick={() => requestSort('gave')}>
                  <div className='flex justify-between'>
                    Driver Gave {getSortIcon('gave')}
                  </div>
                </TableHead>
                <TableHead onClick={() => requestSort('got')}>
                  <div className='flex justify-between'>
                    Driver Got {getSortIcon('got')}
                  </div>
                </TableHead>
                <TableHead>Action</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {sortedAccounts.map((account, index: number) => (
                <TableRow key={account._id}>
                  <TableCell>
                    <div className='flex items-center space-x-2'>
                      <FaCalendarAlt className='text-bottomNavBarColor' />
                      <span>{new Date(account.date || account.paymentDate).toLocaleDateString('en-IN')}</span>
                    </div>
                  </TableCell>
                  <TableCell >
                    <div className='flex items-center space-x-2 '>
                      <span>{account.reason || account.expenseType || `Trip ${account.accountType} `}</span>
                      {account.trip_id && <Button variant={"link"} className='text-red-500 pt-1 rounded-lg'><Link href={`/user/trips/${account.trip_id}`}>from a trip</Link></Button>}
                    </div>
                  </TableCell>
                  <TableCell><span className='text-red-600 font-semibold'>{formatNumber(account.gave) || (account.expenseType && formatNumber(account.amount)) || 0}</span></TableCell>
                  <TableCell ><span className='text-green-600 font-semibold'>{formatNumber(account.got) || (account.paymentType && formatNumber(account.amount)) || 0}</span></TableCell>
                  <TableCell>
                    <div className='flex gap-2 items-center w-full'>
                      {!account.accountType && <Button
                        variant={'outline'}
                        onClick={() => {
                          setSelected(account);
                          if (account.expenseType) {
                            setExpenseEdit(true);
                          } else if (account.accountType) {
                            setPaymentEdit(true);
                          } else {
                            setAccountEdit(true);
                          }
                        }}
                      >
                        <MdEdit />
                      </Button>}
                      <Button
                        variant={'destructive'}
                        onClick={() => {
                          handleDelete(account);
                        }}
                      >
                        <MdDelete />
                      </Button>
                    </div>
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </div>
      </div>
      {/* <ExpenseModal
        isOpen={expenseEdit}
        onClose={() => setExpenseEdit(false)}
        onSave={handleEditAccounts}
        driverId={selected.driver || ''}
        selected={selected}
      /> */}
      <AddExpenseModal
        isOpen={expenseEdit}
        onClose={() => setExpenseEdit(false)}
        onSave={handleEditAccounts}
        driverId={driverId as string}
        selected={selected} categories={['Truck Expense', 'Trip Expense']} />

      {/* {selected != null && <Modal
        isOpen={paymentEdit}
        onClose={() => setPaymentEdit(false)}
        onSave={handleEditAccounts}
        modalTitle="Edit Item"
        accountType={selected.accountType}
        editData={selected}
      />} */}
      <DriverModal
        open={accountEdit}
        onClose={() => setAccountEdit(false)}
        onConfirm={handleEditAccounts}
        type={selected.gave ? 'gave' : 'got'}
        selected={selected}
      />
    </div>
  );
};

export default Driver;
</file>

<file path="src/app/user/drivers/[driverId]/trips/page.tsx">
'use client';
import React, { useMemo, useState } from 'react';
import { useRouter } from 'next/navigation';
import { ITrip } from '@/utils/interface';
import { statuses } from '@/utils/schema';
import { FaCalendarAlt, FaTruck, FaRoute, FaSort, FaSortDown, FaSortUp } from 'react-icons/fa';
import { GoOrganization } from 'react-icons/go';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import Loading from '../loading';
import PartyName from '@/components/party/PartyName';
import { useDriver } from '@/context/driverContext';
import { renderCellContent } from '@/utils/renderTripCell';

const DriverTrips: React.FC = () => {
  const { driver, loading } = useDriver();
  const router = useRouter();
  const [sortConfig, setSortConfig] = useState<{ key: keyof ITrip | null; direction: 'asc' | 'desc' }>({
    key: null,
    direction: 'asc',
  });

  const columnOptions = [
    { label: 'Start Date', value: 'startDate' },
    { label: 'Truck Number', value: 'truck' },
    { label: 'Party Name', value: 'party' },
    { label: 'Route', value: 'route' },
    { label: 'Status', value: 'status' },
  ];

  const trips = driver?.driverTrips || [];

  const sortedTrips = useMemo(() => {
    if (trips.length === 0) return [];
    const sortableTrips = [...trips];
    if (sortConfig.key) {
      sortableTrips.sort((a, b) => {
        if (a[sortConfig.key!] < b[sortConfig.key!]) return sortConfig.direction === 'asc' ? -1 : 1;
        if (a[sortConfig.key!] > b[sortConfig.key!]) return sortConfig.direction === 'asc' ? 1 : -1;
        return 0;
      });
    }
    return sortableTrips;
  }, [trips, sortConfig]);

  const requestSort = (key: keyof ITrip) => {
    let direction: 'asc' | 'desc' = 'asc';
    if (sortConfig.key === key && sortConfig.direction === 'asc') {
      direction = 'desc';
    }
    setSortConfig({ key, direction });
  };

  const getSortIcon = (columnName: keyof ITrip) => {
    if (sortConfig.key === columnName) {
      return sortConfig.direction === 'asc' ? <FaSortUp /> : <FaSortDown />;
    }
    return <FaSort />;
  };

  if (loading) return <Loading />;
  if (!trips.length) return <div>No trips for this driver</div>;

  return (
    <div className="table-container flex flex-col justify-start gap-3">
      <Table className="custom-table">
        <TableHeader>
          <TableRow>
            <TableHead onClick={() => requestSort('startDate')}>
              <div className="flex justify-between">
                Start Date {getSortIcon('startDate')}
              </div>
            </TableHead>
            <TableHead>Truck Number</TableHead>
            <TableHead>Route</TableHead>
            <TableHead onClick={() => requestSort('status')}>
              <div className="flex justify-between">
                Status {getSortIcon('status')}
              </div>
            </TableHead>
            <TableHead onClick={() => requestSort('partyName')}>
              <div className="flex justify-between">
                Party Name {getSortIcon('partyName')}
              </div>
            </TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {sortedTrips.map((trip) => (
            <TableRow
              key={trip.trip_id}
              className="border-t hover:bg-orange-100 cursor-pointer transition-colors"
              onClick={() => router.push(`/user/trips/${trip.trip_id}`)}
            >
              {columnOptions.map(col => 
                      <TableCell key={col.value}>
                        {renderCellContent(col.value, trip)}
                      </TableCell>
                    
                  )}
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  );
};

export default DriverTrips;
</file>

<file path="src/app/user/drivers/create/page.tsx">
'use client'

import React, { useEffect, useState } from 'react';
import DriverForm from '@/components/createDriver';
import { IDriver } from '@/utils/interface';
import { useRouter, useSearchParams } from 'next/navigation';
import Loading from '../loading';
import { mutate } from 'swr';


const isValidPhone = (phone: string): boolean => {
    return /^[6789]\d{9}$/.test(phone); // Phone number validation logic for India
};

const CreateDriverPage: React.FC = () => {
    const [saving, setSaving] = useState(false)
    const router = useRouter();
    const params = useSearchParams()
    const nextpath = params.get('nextpath')


    const handleDriverSubmit = async (driver: IDriver) => {
        setSaving(true);

        if (driver.contactNumber && !isValidPhone(driver.contactNumber)) {
            alert('Invalid phone number. Please enter a 10-digit phone number.');
            return;
        }

        try {

            const res = await fetch('/api/drivers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(driver),
            });

            if (!res.ok) {
                if (res.status === 400) {
                    const errorData = await res.json();
                    alert(`Error: ${errorData.message}`);
                    return;
                } else {
                    alert('An unexpected error occurred. Please try again.');
                    return;
                }
            }

            const data = await res.json();
            if(nextpath){
                const current = JSON.parse(localStorage.getItem('tripData') as any)
                current.driver = data.data.driver_id
                localStorage.setItem('tripData', JSON.stringify(current))
            }
            router.push(nextpath ? nextpath : '/user/drivers');
        } catch (error) {
            console.error('Error saving party:', error);
            alert('An error occurred while saving the party. Please try again.');
        } finally {
            setSaving(false)
        }
    };

    return (
        <>
            {saving && (
                <div className='absolute inset-0 bg-black bg-opacity-10 flex justify-center items-center z-50'>
                    <Loading />
                </div>
            )}
            <div className='w-full h-full'>
                <DriverForm onSubmit={handleDriverSubmit} />
            </div>
        </>

    );
};

export default CreateDriverPage;
</file>

<file path="src/app/user/drivers/layout.tsx">
// DriversLayout.tsx
'use client'
import { Button } from "@/components/ui/button";
import { Inter } from "next/font/google";
import Link from 'next/link';
import { usePathname } from "next/navigation";
import { ReactNode } from "react";

const inter = Inter({ subsets: ["latin"] });

const headings: any = {
  '/user/drivers': 'Drivers',
  '/user/drivers/create': 'New Driver'
}

interface DriversLayoutProps {
  children: ReactNode;
}

const DriversLayout = ({ children }: DriversLayoutProps) => {
  const pathname = usePathname()
  return (
    <div className={`${inter.className} max-h-screen flex flex-col`}>
      <div className="container mx-auto p-2 flex flex-col bg-white ">
        <div className="flex items-center justify-between mb-4 border-b-2 border-gray-300 pb-2">
          <h1 className="text-3xl font-bold text-black">{headings[pathname] || 'Driver Details'}</h1>
          <div className="flex space-x-4">
            {!pathname.includes('create') &&
              <Link href="/user/drivers/create">
                <Button>

                  Add Driver

                </Button>
              </Link>
            }
          </div>
        </div>
        <div className="flex-grow">
          {children}
        </div>
      </div>
    </div>
  );
};

export default DriversLayout;
</file>

<file path="src/app/user/drivers/loading.tsx">
export default function Loading() {
  return (
    <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-10 z-50">
      
        <iframe 
          src="https://lottie.host/embed/3d45f054-61ac-4d4e-837c-2fa3006e28cc/MeZ8JDXVB5.json" 
        ></iframe>
    </div>
  );}
</file>

<file path="src/app/user/drivers/page.tsx">
'use client'

import React, { useCallback, useEffect, useMemo, useState } from 'react';
import { useRouter } from 'next/navigation';
import debounce from 'lodash.debounce';
import { FaUser, FaPhone, FaSort, FaSortDown, FaSortUp } from 'react-icons/fa';

import { IDriver } from '@/utils/interface';
import { formatNumber } from '@/utils/utilArray';
import Loading from './loading';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Input } from '@/components/ui/input';
import { useExpenseData } from '@/components/hooks/useExpenseData';
import { handleExportToExcel } from '@/utils/excelOperation';
import { BsFiletypeXlsx } from 'react-icons/bs';
import { Button } from '@/components/ui/button';

type SortConfig = {
  key: keyof IDriver | null;
  direction: 'asc' | 'desc';
};

export default function DriversPage() {

  const router = useRouter();
  const { drivers, isLoading , refetchDrivers} = useExpenseData();
  const [sortConfig, setSortConfig] = useState<SortConfig>({ key: null, direction: 'asc' });
  const [searchQuery, setSearchQuery] = useState('');


  useEffect(() => {
    refetchDrivers()
  }, [refetchDrivers])

  const debouncedSearch = useMemo(
    () => debounce((query: string) => setSearchQuery(query), 300),
    []
  );

  const handleSearch = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    debouncedSearch(e.target.value.toLowerCase());
  }, [debouncedSearch]);

  const sortedDrivers = useMemo(() => {
    if (!drivers || drivers.length === 0) return [];

    let sortableDrivers = [...drivers];

    if (searchQuery) {
      const lowercaseQuery = searchQuery.toLowerCase();
      sortableDrivers = sortableDrivers.filter((driver) =>
        Object.values(driver).some(value =>
          typeof value === 'string' && value.toLowerCase().includes(lowercaseQuery)
        )
      );
    }

    if (sortConfig.key) {
      sortableDrivers.sort((a, b) => {
        if (a[sortConfig.key!] < b[sortConfig.key!]) {
          return sortConfig.direction === 'asc' ? -1 : 1;
        }
        if (a[sortConfig.key!] > b[sortConfig.key!]) {
          return sortConfig.direction === 'asc' ? 1 : -1;
        }
        return 0;
      });
    }

    return sortableDrivers;
  }, [drivers, sortConfig, searchQuery]);

  const requestSort = useCallback((key: keyof IDriver) => {
    setSortConfig((prevConfig) => ({
      key,
      direction: prevConfig.key === key && prevConfig.direction === 'asc' ? 'desc' : 'asc',
    }));
  }, []);

  const getSortIcon = useCallback((columnName: keyof IDriver) => {
    if (sortConfig.key === columnName) {
      return sortConfig.direction === 'asc' ? <FaSortUp /> : <FaSortDown />;
    }
    return <FaSort />;
  }, [sortConfig]);

  const handleExport = ()=>{
    const selectedColumns = ["name", "contactNumber", "status", "balane"]
    handleExportToExcel(sortedDrivers,selectedColumns, "drivers.xlsx")
  }

  if (isLoading) return <Loading />;

  if (!drivers || drivers.length === 0) {
    return (
      <div className="flex justify-center items-center h-full">
        <div className="text-gray-500">No drivers found</div>
      </div>
    );
  }

  return (
    <div className="w-full h-full p-4">
      <div className='flex items-center gap-2 w-full px-60 mb-4'>
        <Input
          type="text"
          placeholder="Search..."
          onChange={handleSearch}
          className="w-full"
        />
        <div className='p-2 flex justify-end'>
        <Button onClick={()=>handleExport()}>
          <BsFiletypeXlsx size={20}/>
        </Button>
        </div>
      </div>
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead onClick={() => requestSort('name')} className="cursor-pointer">
              <div className='flex justify-between items-center'>
                Name {getSortIcon('name')}
              </div>
            </TableHead>
            <TableHead>Contact Number</TableHead>
            <TableHead>Aadhar</TableHead>
            <TableHead>License</TableHead>
            <TableHead>Last Joining</TableHead>
            <TableHead onClick={() => requestSort('status')} className="cursor-pointer">
              <div className='flex justify-between items-center'>
                Status {getSortIcon('status')}
              </div>
            </TableHead>
            <TableHead onClick={() => requestSort('balance')} className="cursor-pointer">
              <div className='flex justify-between items-center'>
                Balance {getSortIcon('balance')}
              </div>
            </TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {sortedDrivers.map((driver, index) => (
            <TableRow
              index={index + 1}
              key={driver.driver_id}
              className="border-t hover:bg-blue-100 cursor-pointer transition-colors"
              onClick={() => router.push(`/user/drivers/${driver.driver_id}`)}
            >
              <TableCell className="border p-4">
                <div className='flex items-center gap-3'>
                  <FaUser className="text-bottomNavBarColor" />
                  <span>{driver.name}</span>
                </div>
              </TableCell>
              <TableCell className="border p-4">
                <div className='flex items-center gap-3'>
                  <FaPhone className="text-green-500" />
                  <span>{driver.contactNumber || ''}</span>
                </div>
              </TableCell>
              <TableCell>{driver.aadharNo || "NA"}</TableCell>
              <TableCell>{driver.licenseNo || "NA"}</TableCell>
              <TableCell>{driver.lastJoiningDate ? new Date(driver.lastJoiningDate).toLocaleDateString('en-IN') : "NA"}</TableCell>
              <TableCell className="border p-4">
                <span
                  className={`inline-block px-3 py-1 rounded-full text-sm font-semibold ${driver.status === 'Available' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                    }`}
                >
                  {driver.status}
                </span>
              </TableCell>
              <TableCell className="border p-4 font-semibold text-xl">
                <span className={`${Number(driver.balance) < 0 ? 'text-red-500' : 'text-green-500'} font-semibold`}>
                  {formatNumber(Number(driver.balance))}
                </span>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  );
}
</file>

<file path="src/app/user/expenses/draft/page.tsx">
'use client';
import Loading from '../loading';
import { Button } from '@/components/ui/button';
import { IExpense, } from '@/utils/interface';
import React, { Suspense, useCallback, useEffect, useMemo, useState } from 'react';

import {  handleAddExpense, } from '@/helpers/ExpenseOperation';
;
import { FaSort, FaSortDown, FaSortUp,  } from 'react-icons/fa';

import debounce from 'lodash.debounce';
import dynamic from 'next/dynamic';

import { loadingIndicator } from '@/components/ui/LoadingIndicator';
import { TbPlus } from 'react-icons/tb';
import { DropdownMenu, DropdownMenuCheckboxItem, DropdownMenuContent, DropdownMenuLabel, DropdownMenuSeparator, DropdownMenuTrigger } from '@/components/ui/dropdown-menu';
import ExpenseTable from '@/components/ExpenseTable';
import { useToast } from '@/components/hooks/use-toast';

const AddExpenseModal = dynamic(() => import('@/components/AddExpenseModal'), { ssr: false, loading: () => <div>{loadingIndicator}</div> })
const ExpenseFilterModal = dynamic(() => import('@/components/ExpenseFilterModal'), { ssr: false, loading: () => <div>{loadingIndicator}</div> })
const DraftExpense: React.FC = () => {
    const [error, setError] = useState<string | null>(null);
    const [loading, setLoading] = useState<boolean>(true);
    const [truckExpenseBook, setTruckExpenseBook] = useState<IExpense[] | any[]>([]);
    const [modalOpen, setModalOpen] = useState<boolean>(false);
    const [selected, setSelected] = useState<IExpense | null>(null);
    const [sortConfig, setSortConfig] = useState<any>({ key: null, direction: 'asc' })
    const [searchQuery, setSearchQuery] = useState('')
    const { toast } = useToast()


    const [visibleColumns, setVisibleColumns] = useState({
        date: true,
        amount: true,
        expenseType: true,
        notes: true,
        truck: true,
        action: true,
        ledger: true
    });


    const sortedExpense = useMemo(() => {
        if (!truckExpenseBook || truckExpenseBook.length === 0) return [];  // This line ensures that truckExpenseBook is not null or empty
        let filteredexpenses = [...truckExpenseBook]

        if (searchQuery) {
            const lowercaseQuery = searchQuery.toLowerCase()
            filteredexpenses = truckExpenseBook.filter((expense: any) =>
                expense?.expenseType.toLowerCase().includes(lowercaseQuery) ||
                expense?.paymentMode.toLowerCase().includes(lowercaseQuery) ||
                new Date(expense?.date).toLocaleDateString().includes(lowercaseQuery) ||
                expense?.amount.toString().includes(lowercaseQuery) ||
                expense?.notes.toString().includes(lowercaseQuery) ||
                expense?.driverName.toString().includes(lowercaseQuery) ||
                expense?.truck.toLowerCase().includes(lowercaseQuery)
            )
        }
        if (sortConfig.key !== null) {
            filteredexpenses.sort((a: any, b: any) => {
                if (a[sortConfig.key] < b[sortConfig.key]) {
                    return sortConfig.direction === 'asc' ? -1 : 1;
                }
                if (a[sortConfig.key] > b[sortConfig.key]) {
                    return sortConfig.direction === 'asc' ? 1 : -1;
                }
                return 0;
            });
        }
        return filteredexpenses;
    }, [truckExpenseBook, sortConfig, searchQuery]);


    const requestSort = (key: any) => {
        let direction: 'asc' | 'desc' = 'asc'
        if (sortConfig.key === key && sortConfig.direction === 'asc') {
            direction = 'desc'
        }
        setSortConfig({ key, direction })
    }

    const getSortIcon = (columnName: any) => {
        if (sortConfig.key === columnName) {
            return sortConfig.direction === 'asc' ? <FaSortUp /> : <FaSortDown />
        }
        return <FaSort />
    }

    // Debounce the search input to reduce re-renders on each keystroke
    const debouncedSearch = useCallback(
        debounce((query) => setSearchQuery(query), 300),
        []
    );

    // Handle search input
    const handleSearch: any = (e: React.ChangeEvent<HTMLInputElement>) => {
        debouncedSearch(e.target.value);
    };


    const getBook = async () => {
        try {
            setLoading(true);
            const res = await fetch('/api/expenses/draft')
            const data = await res.json()
            setTruckExpenseBook(data.expenses);
        } catch (error) {
            setError((error as Error).message);
        } finally {
            setLoading(false);
        }
    };

    const handleDelete = async (id: string) => {
        try {
            const res = await fetch(`/api/expenses/draft/${id}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            const data = await res.json()
            setTruckExpenseBook((prev) => {
                return prev.filter((item) => item._id !== id)
            })
        } catch (error) {
            toast({
                description: 'An error occurred. Please try again.',
                variant: 'destructive',
            })
        }
    }

    const handleExpense = async (expense: IExpense, id?: string, file?: File | null) => {
        try {
            // Execute add expense and delete draft in parallel for efficiency
            const missingFields = new Set()
            if (!expense.expenseType) missingFields.add('expenseType');
            if (!expense.date) missingFields.add('date');
            if (!expense.amount) missingFields.add('amount');
            if (!expense.paymentMode) missingFields.add('paymentMode');
            if (missingFields.size > 0) {
                toast({
                    description: `Missing required fields: ${Array.from(missingFields).join(', ')}`,
                    variant: 'warning',
                })
                return
            }
            const [addedExpense, delRes] = await Promise.all([
                handleAddExpense(expense, file),
                fetch(`/api/expenses/draft/${selected?._id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
            ]);

            const delData = await delRes.json();

            if (!delRes.ok) {
                throw new Error(`Failed to delete draft: ${delData.message || 'Unknown error'}`);
            }

            // Update the truck expense book
            setTruckExpenseBook((prev) =>
                prev.filter((exp) => exp._id !== delData.expense._id)
            );
        } catch (error: unknown) {
            console.error('Error in handleExpense:', error);
            toast({
                description: 'An error occurred. Please try again.',
                variant: 'destructive',
            });
        } finally {
            // Ensure modal state is updated even if an error occurs
            setSelected(null);
            setModalOpen(false);
        }
    };


    useEffect(() => {
        // Call getBook with null for the first render
        getBook();
    }, [])

    if (loading) return <Loading />;
    if (error) return <div className="text-red-500">Error: {error}</div>;

    const handleToggleColumn = (column: keyof typeof visibleColumns) => {
        setVisibleColumns((prev) => ({
            ...prev,
            [column]: !prev[column],
        }));
    };

    const handleSelectAll = (selectAll: boolean) => {
        setVisibleColumns({
            date: selectAll,
            amount: selectAll,
            expenseType: selectAll,
            notes: selectAll,
            truck: selectAll,
            action: selectAll,
            ledger: selectAll
        });
    };

    return (
        <div className="w-full h-full">

            <div className="flex items-center justify-between gap-4 bg-transparent p-4">
                <div className="flex items-center gap-4 flex-grow">
                    <DropdownMenu>
                        <DropdownMenuTrigger asChild>
                            <Button variant="outline" size="sm">Columns</Button>
                        </DropdownMenuTrigger>
                        <DropdownMenuContent className="w-56">
                            <DropdownMenuLabel>Visible Columns</DropdownMenuLabel>
                            <DropdownMenuSeparator />
                            <DropdownMenuCheckboxItem
                                checked={Object.values(visibleColumns).every(Boolean)}
                                onCheckedChange={handleSelectAll}
                            >
                                Select All
                            </DropdownMenuCheckboxItem>
                            {Object.entries(visibleColumns).map(([column, isVisible]) => (
                                <DropdownMenuCheckboxItem
                                    key={column}
                                    checked={isVisible}
                                    onCheckedChange={() => handleToggleColumn(column as any)}
                                >
                                    {column.charAt(0).toUpperCase() + column.slice(1)}
                                </DropdownMenuCheckboxItem>
                            ))}
                        </DropdownMenuContent>
                    </DropdownMenu>
                    <input
                        type="text"
                        onChange={handleSearch}
                        placeholder={`Search from ${sortedExpense.length} expenses...`}
                        className="max-w-xs"
                    />
                </div>
                <div className="flex items-center gap-2">
                    <Button
                        size="sm"
                        onClick={() => {
                            setSelected(null)
                            setModalOpen(true)
                        }}
                    >
                        <TbPlus className="mr-2 h-4 w-4" /> Add
                    </Button>

                </div>
            </div>

            <div className="">
                <ExpenseTable
                    sortedExpense={sortedExpense}
                    handleDelete={handleDelete}
                    visibleColumns={visibleColumns}
                    requestSort={requestSort}
                    getSortIcon={getSortIcon}
                    setSelected={setSelected}
                    setTruckExpenseBook={setTruckExpenseBook}
                    setModalOpen={setModalOpen}
                />
            </div>


            <AddExpenseModal
                isOpen={modalOpen}
                onClose={() => setModalOpen(false)}
                onSave={handleExpense}
                driverId={selected?.driver as string}
                selected={selected} categories={['Truck Expense', 'Trip Expense', 'Office Expense']}
                setDrafts={setTruckExpenseBook} />

        </div>
    );
};

const DraftExpenseWrapper: React.FC = () => {
    return (
        <Suspense fallback={<Loading />}>
            <DraftExpense />
        </Suspense>
    )

}

export default DraftExpenseWrapper;
</file>

<file path="src/app/user/expenses/layout.tsx">
import ExpenseLayout from '@/components/layout/ExpenseLayout';

interface PartyLayoutProps {
  children: React.ReactNode;
}

const Layout: React.FC<PartyLayoutProps> = ({ children }) => {

  return (
      <ExpenseLayout >
        {children}
      </ExpenseLayout>
  );
};

export default Layout;
</file>

<file path="src/app/user/expenses/loading.tsx">
export default function Loading() {
  return (
    <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-10 z-50">
      
        <iframe 
          src="https://lottie.host/embed/3d45f054-61ac-4d4e-837c-2fa3006e28cc/MeZ8JDXVB5.json" 
        ></iframe>
    </div>
  );}
</file>

<file path="src/app/user/expenses/officeExpense/page.tsx">
'use client';

import Loading from '../loading';

import { IExpense } from '@/utils/interface';
import React, { useEffect, useState, Suspense, useCallback, useMemo } from 'react';

import {  FaSort, FaSortDown, FaSortUp } from 'react-icons/fa';
import {generateMonthYearOptions } from '@/utils/utilArray';


import debounce from 'lodash.debounce';
import dynamic from 'next/dynamic';
import { handleAddExpense, handleEditExpense } from '@/helpers/ExpenseOperation';
import { ExpenseHeader } from '@/components/ExpenseHeader';
import { loadingIndicator } from '@/components/ui/LoadingIndicator';
import ExpenseTable from '@/components/ExpenseTable';
import { useToast } from '@/components/hooks/use-toast';

const AddExpenseModal = dynamic(() => import('@/components/AddExpenseModal'), { ssr: false, loading: () => <div>{loadingIndicator}</div> })
const ExpenseFilterModal = dynamic(() => import('@/components/ExpenseFilterModal'), { ssr: false, loading: () => <div>{loadingIndicator}</div> })
const OfficeExpense: React.FC = () => {
    const [error, setError] = useState<string | null>(null);
    const [loading, setLoading] = useState<boolean>(true);
    const [maintainenceBook, setMaintainenceBook] = useState<IExpense[] | any[]>([]);
    const [modalOpen, setModalOpen] = useState<boolean>(false);
    const [selected, setSelected] = useState<IExpense | null>(null);
    const [visibleColumns, setVisibleColumns] = useState({
        date: true,
        amount: true,
        expenseType: true,
        notes: true,
        paymentMode: true,
        action: true,
    });
    const [sortConfig, setSortConfig] = useState<any>({ key: null, direction: 'asc' })
    const [searchQuery, setSearchQuery] = useState('')
    const [filterModalOpen, setFilterModalOpen] = useState(false)
    const {toast} = useToast()



    const handleSelectAll = (selectAll: boolean) => {
        setVisibleColumns({
            date: selectAll,
            amount: selectAll,
            expenseType: selectAll,
            notes: selectAll,
            action: selectAll,
            paymentMode: selectAll,
        });
    };

    const handleToggleColumn = (column: keyof typeof visibleColumns) => {
        setVisibleColumns((prev) => ({
            ...prev,
            [column]: !prev[column],
        }));
    };

    const [month, year] = [null, null];

    const getBook = async () => {
        try {
            setLoading(true);
            let res;
            if (month === null || year === null) {
                res = await fetch(`/api/expenses/officeExpense`)
            } else {
                res = await fetch(`/api/expenses/officeExpense?month=${month}&year=${year}`);
            }
            if (!res.ok) throw new Error('Error fetching expenses');
            const data = await res.json();
            setMaintainenceBook(data.expenses || []);
        } catch (error) {
            setError((error as Error).message);
        } finally {
            setLoading(false);
        }
    };

    const handleExpense = async (expense: IExpense | any, id?: string, file?: File | null) => {
        try {
            const data = selected ? await handleEditExpense(expense, selected._id as string, file) : await handleAddExpense(expense, file)
            selected ?
                setMaintainenceBook((prev) => (
                    prev.map((exp) => exp._id === data._id ? ({ ...exp, ...data }) : exp)
                )) : setMaintainenceBook((prev) => [
                    { ...data },
                    ...prev
                ])
            toast({
                description : `Expense ${selected ? 'edited' : 'added'} successfully`
            })

        } catch (error) {
            toast({
                description : 'Please try again',
                variant : 'destructive'
            })
        } finally {
            setSelected(null)
            setModalOpen(false);
        }
    };

    const handleDelete = async (expenseId: string) => {
        try {
            const res = await fetch(`/api/expenses/${expenseId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
            if (!res.ok) {
                toast({
                    description : 'Failed to delete expense',
                    variant : 'destructive'
                })
                return;
            }
            setMaintainenceBook((prev) => prev.filter((item) => item._id !== expenseId));
            toast({
                description : 'Expense deleted successfully'
            })
        } catch (error: any) {
            toast({
                description : 'Failed to delete expense',
                variant : 'destructive'
            })
        }
    };

    const handleFilter = async (filter: { paymentModes: string[], monYear: string[], shops: string[], expenseType: string[] }) => {
        try {
            const res = await fetch(`/api/expenses/officeExpense?filter=${encodeURIComponent(JSON.stringify(filter))}`)
            const data = await res.json()
            setMaintainenceBook(data.expenses)
        } catch (error) {
            console.log(error)
        } finally {
            setFilterModalOpen(false)
        }
    }

    const sortedExpense = useMemo(() => {
        if (!maintainenceBook || maintainenceBook.length === 0) return [];  // This line ensures that truckExpenseBook is not null or empty
        let filteredexpenses = [...maintainenceBook]

        if (searchQuery) {
            const lowercaseQuery = searchQuery.toLowerCase()
            filteredexpenses = maintainenceBook.filter((expense: any) =>
                expense.expenseType.toLowerCase().includes(lowercaseQuery) ||
                expense.paymentMode.toLowerCase().includes(lowercaseQuery) ||
                new Date(expense.date).toLocaleDateString().includes(lowercaseQuery) ||
                expense.amount.toString().includes(lowercaseQuery) ||
                expense.notes.toString().includes(lowercaseQuery) ||
                expense.shopName.toString().includes(lowercaseQuery)
            )
        }
        if (sortConfig.key !== null) {
            filteredexpenses.sort((a: any, b: any) => {
                if (a[sortConfig.key] < b[sortConfig.key]) {
                    return sortConfig.direction === 'asc' ? -1 : 1;
                }
                if (a[sortConfig.key] > b[sortConfig.key]) {
                    return sortConfig.direction === 'asc' ? 1 : -1;
                }
                return 0;
            });
        }
        return filteredexpenses;
    }, [maintainenceBook, sortConfig, searchQuery]);

    const requestSort = (key: any) => {
        let direction: 'asc' | 'desc' = 'asc'
        if (sortConfig.key === key && sortConfig.direction === 'asc') {
            direction = 'desc'
        }
        setSortConfig({ key, direction })
    }
    const getSortIcon = (columnName: any) => {
        if (sortConfig.key === columnName) {
            return sortConfig.direction === 'asc' ? <FaSortUp /> : <FaSortDown />
        }
        return <FaSort />
    }

    

    // Debounce the search input to reduce re-renders on each keystroke
    const debouncedSearch = useCallback(
        debounce((query) => setSearchQuery(query), 300),
        []
    );

    // Handle search input
    const handleSearch: any = (e: React.ChangeEvent<HTMLInputElement>) => {
        debouncedSearch(e.target.value);
    };


    useEffect(() => {
        getBook();
    }, [month, year]);

    


    if (loading) return <Loading />;
    if (error) return <div className="text-red-500">Error: {error}</div>;

    return (
        <div className="w-full h-full">
            <ExpenseHeader visibleColumns={visibleColumns} handleSearch={handleSearch} handleSelectAll={handleSelectAll} handleToggleColumn={handleToggleColumn} sortedExpense={sortedExpense} setSelected={setSelected} setModalOpen={setModalOpen} setFilterModalOpen={setFilterModalOpen} />

            <div className="">
                <ExpenseTable
                    sortedExpense={sortedExpense}
                    handleDelete={handleDelete}
                    visibleColumns={visibleColumns}
                    requestSort={requestSort}
                    getSortIcon={getSortIcon}
                    setSelected={setSelected}
                    setTruckExpenseBook={setMaintainenceBook}
                    setModalOpen={setModalOpen}
                />
            </div>
            <AddExpenseModal
                isOpen={modalOpen}
                onClose={() => {
                    setModalOpen(false);
                    setSelected(null);
                }}
                onSave={handleExpense}
                selected={selected} driverId={''} categories={['Truck Expense', 'Trip Expense', 'Office Expense']} 
                />
            <ExpenseFilterModal
                isOpen={filterModalOpen}
                paymentModes={['Online', 'Cash', 'Credit']}
                handleFilter={handleFilter}
                monthYearOptions={generateMonthYearOptions()}
                onClose={() => setFilterModalOpen(false)}
            />
        </div>
    );
};

const OfficeExpenseWrapper: React.FC = () => (
    <Suspense fallback={<Loading />}>
        <OfficeExpense />
    </Suspense>
);

export default OfficeExpenseWrapper;
</file>

<file path="src/app/user/expenses/page.tsx">
'use client';
import Loading from '../loading';
import { IExpense } from '@/utils/interface';
import React, { Suspense, useCallback, useEffect, useMemo, useState } from 'react';
import { DeleteExpense, handleEditExpense, handleAddExpense, } from '@/helpers/ExpenseOperation';

import { FaSort, FaSortDown, FaSortUp } from 'react-icons/fa';


import { generateMonthYearOptions } from '@/utils/utilArray';
import debounce from 'lodash.debounce';
import dynamic from 'next/dynamic';
import ExpenseTable from '@/components/ExpenseTable';
import { ExpenseHeader } from '@/components/ExpenseHeader';
import { loadingIndicator } from '@/components/ui/LoadingIndicator';
import { useToast } from '@/components/hooks/use-toast';

const AddExpenseModal = dynamic(() => import('@/components/AddExpenseModal'), { ssr: false, loading: () => <div>{loadingIndicator}</div> })
const ExpenseFilterModal = dynamic(() => import('@/components/ExpenseFilterModal'), { ssr: false, loading: () => <div>{loadingIndicator}</div> })

const TripExpense: React.FC = () => {
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState<boolean>(true);
  const [truckExpenseBook, setTruckExpenseBook] = useState<IExpense[] | any[]>([]);
  const [modalOpen, setModalOpen] = useState<boolean>(false);
  const [selected, setSelected] = useState<IExpense | null>(null);
  const [sortConfig, setSortConfig] = useState<any>({ key: null, direction: 'asc' })
  const [searchQuery, setSearchQuery] = useState('')
  const [filterModalOpen, setFilterModalOpen] = useState(false)
  const { toast } = useToast()




  const monthYearOptions = generateMonthYearOptions()

  const [visibleColumns, setVisibleColumns] = useState({
    date: true,
    amount: true,
    expenseType: true,
    notes: true,
    truck: true,
    ledger: true,
    action: true,
    trip: true
  });


  const handleFilter = async (filter: { drivers: string[], trips: string[], trucks: string[], paymentModes: string[], monYear: string[], shops: string[], expenseTypes: string[] }) => {
    console.log(filter)
    try {
      const res = await fetch(`/api/expenses/tripExpense?filter=${encodeURIComponent(JSON.stringify(filter))}`)
      const data = await res.json()
      console.log(data)
      setTruckExpenseBook(data.tripExpense)
    } catch (error) {
      console.log(error)
    } finally {
      setFilterModalOpen(false)
    }
  }

  const sortedExpense = useMemo(() => {
    if (!truckExpenseBook || truckExpenseBook.length === 0) return [];  // This line ensures that truckExpenseBook is not null or empty
    let filteredexpenses = [...truckExpenseBook]

    if (searchQuery) {
      const lowercaseQuery = searchQuery.toLowerCase()
      filteredexpenses = truckExpenseBook.filter((expense: any) =>
        expense.expenseType?.toLowerCase().includes(lowercaseQuery) ||
        expense.paymentMode?.toLowerCase().includes(lowercaseQuery) ||
        new Date(expense.date)?.toLocaleDateString().includes(lowercaseQuery) ||
        expense.amount?.toString().includes(lowercaseQuery) ||
        expense.notes?.toString().includes(lowercaseQuery) ||
        expense.driverName?.toString().includes(lowercaseQuery) ||
        expense.truck?.toLowerCase().includes(lowercaseQuery)
      )
    }
    if (sortConfig.key !== null) {
      filteredexpenses.sort((a: any, b: any) => {
        if (a[sortConfig.key] < b[sortConfig.key]) {
          return sortConfig.direction === 'asc' ? -1 : 1;
        }
        if (a[sortConfig.key] > b[sortConfig.key]) {
          return sortConfig.direction === 'asc' ? 1 : -1;
        }
        return 0;
      });
    }
    return filteredexpenses;
  }, [truckExpenseBook, sortConfig, searchQuery]);


  const requestSort = (key: any) => {
    let direction: 'asc' | 'desc' = 'asc'
    if (sortConfig.key === key && sortConfig.direction === 'asc') {
      direction = 'desc'
    }
    setSortConfig({ key, direction })
  }

  const getSortIcon = (columnName: any) => {
    if (sortConfig.key === columnName) {
      return sortConfig.direction === 'asc' ? <FaSortUp /> : <FaSortDown />
    }
    return <FaSort />
  }

  // Debounce the search input to reduce re-renders on each keystroke
  const debouncedSearch = useCallback(
    debounce((query) => setSearchQuery(query), 300),
    []
  );

  // Handle search input
  const handleSearch: any = (e: React.ChangeEvent<HTMLInputElement>) => {
    debouncedSearch(e.target.value);
  };


  const getBook = async () => {
    try {
      setLoading(true);
      const res = await fetch('/api/expenses')
      if (!res.ok) {
        alert("error fetching expenses")
      }
      const data = await res.json();
      setTruckExpenseBook(data.expenses);
    } catch (error) {
      alert('Internal Server Error')
      console.log(error)
    } finally {
      setLoading(false);
    }
  };

  const handleDelete = async (id: string) => {
    try {
      const expense = await DeleteExpense(id)
      setTruckExpenseBook(truckExpenseBook.filter((item) => item._id !== expense._id));
      toast({
        description: 'Expense deleted successfully'
      })
    } catch (error) {
      toast({
        description: 'Failed to Delete Expense',
        variant: 'destructive'
      })
    }
  }

  const handleExpense = async (expense: IExpense | any, id?: string, file?: File | null) => {
    console.log(file)
    try {
      const data = selected ? await handleEditExpense(expense, selected._id as string, file, toast) : await handleAddExpense(expense, file, toast)
      selected ?
        setTruckExpenseBook((prev) => (
          prev.map((exp) => exp._id === data._id ? ({ ...exp, ...data }) : exp)
        )) : setTruckExpenseBook((prev) => [
          { ...data },
          ...prev
        ])
      toast({
        description: `Expense ${selected ? 'edited' : 'added'} successfully`
      })
    } catch (error) {
      toast({
        description: 'Please try again',
        variant: 'destructive'
      })
    } finally {
      setSelected(null)
      setModalOpen(false);
    }
  };

  useEffect(() => {
    // Call getBook with null for the first render
    getBook();
  }, [])

  if (loading) return <Loading />;
  if (error) return <div className="text-red-500">Error: {error}</div>;

  const handleToggleColumn = (column: keyof typeof visibleColumns) => {
    setVisibleColumns((prev) => ({
      ...prev,
      [column]: !prev[column],
    }));
  };

  const handleSelectAll = (selectAll: boolean) => {
    setVisibleColumns({
      date: selectAll,
      amount: selectAll,
      expenseType: selectAll,
      notes: selectAll,
      truck: selectAll,
      action: selectAll,
      trip: selectAll,
      ledger: selectAll,
    });
  };

  return (
    <div className="w-full h-full">

      <ExpenseHeader visibleColumns={visibleColumns} handleSearch={handleSearch} handleSelectAll={handleSelectAll} handleToggleColumn={handleToggleColumn} sortedExpense={sortedExpense} setSelected={setSelected} setModalOpen={setModalOpen} setFilterModalOpen={setFilterModalOpen} />

      <div className="">
        <ExpenseTable
          sortedExpense={sortedExpense}
          handleDelete={handleDelete}
          visibleColumns={visibleColumns}
          requestSort={requestSort}
          getSortIcon={getSortIcon}
          setSelected={setSelected}
          setTruckExpenseBook={setTruckExpenseBook}
          setModalOpen={setModalOpen}
        />
      </div>


      <AddExpenseModal
        isOpen={modalOpen}
        onClose={() => {
          setModalOpen(false);
          setSelected(null);
      }}
        onSave={handleExpense}
        driverId={selected?.driver as string}
        selected={selected}
        categories={['Truck Expense', 'Trip Expense', 'Office Expense']}
        
      />
      <ExpenseFilterModal
        isOpen={filterModalOpen}
        onClose={() => setFilterModalOpen(false)}
        paymentModes={['Paid By Driver', 'Cash', 'Online', 'Credit']}
        monthYearOptions={monthYearOptions}
        handleFilter={handleFilter} />

    </div>
  );
};

const TruckExpenseWrapper: React.FC = () => {
  return (
    <Suspense fallback={<Loading />}>
      <TripExpense />
    </Suspense>
  )

}

export default TruckExpenseWrapper;
</file>

<file path="src/app/user/expenses/tripExpense/page.tsx">
'use client';
import Loading from '../loading';

import { IExpense } from '@/utils/interface';
import React, { Suspense, useCallback, useEffect, useMemo, useState } from 'react';

import { DeleteExpense, fetchTripExpense, handleAddExpense, handleEditExpense } from '@/helpers/ExpenseOperation';

import { FaSort, FaSortDown, FaSortUp } from 'react-icons/fa';

import { generateMonthYearOptions } from '@/utils/utilArray';

import debounce from 'lodash.debounce';

import dynamic from 'next/dynamic';
import { ExpenseHeader } from '@/components/ExpenseHeader';
import { loadingIndicator } from '@/components/ui/LoadingIndicator';
import ExpenseTable from '@/components/ExpenseTable';
import { useToast } from '@/components/hooks/use-toast';

const AddExpenseModal = dynamic(() => import('@/components/AddExpenseModal'), { ssr: false, loading: () => <div>{loadingIndicator}</div> })
const ExpenseFilterModal = dynamic(() => import('@/components/ExpenseFilterModal'), { ssr: false, loading: () => <div>{loadingIndicator}</div> })
const TripExpense: React.FC = () => {
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState<boolean>(true);
  const [truckExpenseBook, setTruckExpenseBook] = useState<IExpense[] | any[]>([]);
  const [modalOpen, setModalOpen] = useState<boolean>(false);
  const [selected, setSelected] = useState<IExpense | null>(null);
  const [sortConfig, setSortConfig] = useState<any>({ key: null, direction: 'asc' })
  const [searchQuery, setSearchQuery] = useState('')
  const [filterModalOpen, setFilterModalOpen] = useState(false)
  const { toast } = useToast()



  const monthYearOptions = generateMonthYearOptions()

  const [visibleColumns, setVisibleColumns] = useState({
    date: true,
    amount: true,
    expenseType: true,
    notes: true,
    truck: true,
    ledger: true,
    action: true,
    trip: true
  });


  const handleFilter = async (filter: { drivers: string[], trips: string[], trucks: string[], paymentModes: string[], monYear: string[], shops: string[], expenseTypes: string[] }) => {
    try {
      setTruckExpenseBook([])
      const res = await fetch(`/api/expenses/tripExpense?filter=${encodeURIComponent(JSON.stringify(filter))}`)
      const data = await res.json()
      console.log(data)
      setTruckExpenseBook(data.tripExpense)
    } catch (error) {
      console.log(error)
    } finally {
      setFilterModalOpen(false)
    }
  }

  const sortedExpense = useMemo(() => {
    if (!truckExpenseBook || truckExpenseBook.length === 0) return [];  // This line ensures that truckExpenseBook is not null or empty
    let filteredexpenses = [...truckExpenseBook]

    if (searchQuery) {
      const lowercaseQuery = searchQuery.toLowerCase()
      filteredexpenses = truckExpenseBook.filter((expense: any) =>
        expense.expenseType.toLowerCase().includes(lowercaseQuery) ||
        expense.paymentMode.toLowerCase().includes(lowercaseQuery) ||
        new Date(expense.date).toLocaleDateString().includes(lowercaseQuery) ||
        expense.amount.toString().includes(lowercaseQuery) ||
        expense.notes.toString().includes(lowercaseQuery) ||
        expense.driverName.toString().includes(lowercaseQuery) ||
        expense.truck.toLowerCase().includes(lowercaseQuery)
      )
    }
    if (sortConfig.key !== null) {
      filteredexpenses.sort((a: any, b: any) => {
        if (a[sortConfig.key] < b[sortConfig.key]) {
          return sortConfig.direction === 'asc' ? -1 : 1;
        }
        if (a[sortConfig.key] > b[sortConfig.key]) {
          return sortConfig.direction === 'asc' ? 1 : -1;
        }
        return 0;
      });
    }
    return filteredexpenses;
  }, [truckExpenseBook, sortConfig, searchQuery]);


  const requestSort = (key: any) => {
    let direction: 'asc' | 'desc' = 'asc'
    if (sortConfig.key === key && sortConfig.direction === 'asc') {
      direction = 'desc'
    }
    setSortConfig({ key, direction })
  }

  const getSortIcon = (columnName: any) => {
    if (sortConfig.key === columnName) {
      return sortConfig.direction === 'asc' ? <FaSortUp /> : <FaSortDown />
    }
    return <FaSort />
  }

  // Debounce the search input to reduce re-renders on each keystroke
  const debouncedSearch = useCallback(
    debounce((query) => setSearchQuery(query), 300),
    []
  );

  // Handle search input
  const handleSearch: any = (e: React.ChangeEvent<HTMLInputElement>) => {
    debouncedSearch(e.target.value);
  };


  const getBook = async () => {
    try {
      setLoading(true);
      const truckExpenses = await fetchTripExpense();
      setTruckExpenseBook(truckExpenses);
    } catch (error) {
      setError((error as Error).message);
    } finally {
      setLoading(false);
    }
  };

  const handleExpense = async (expense: IExpense | any, id?: string, file?: File | null) => {
    try {
      const data = selected ? await handleEditExpense(expense, selected._id as string, file, toast) : await handleAddExpense(expense, file, toast)
      selected ?
        setTruckExpenseBook((prev) => (
          prev.map((exp) => exp._id === data._id ? ({ ...exp, ...data }) : exp)
        )) : setTruckExpenseBook((prev) => [
          { ...data },
          ...prev
        ])
      toast({
        description: `Expense ${selected ? 'edited' : 'added'} successfully`
      })
    } catch (error) {
      toast({
        description: 'Please try again',
        variant: 'destructive'
      })
    } finally {
      setSelected(null)
      setModalOpen(false);
    }
  };

  useEffect(() => {
    // Call getBook with null for the first render
    getBook();
  }, [])

  if (loading) return <Loading />;
  if (error) return <div className="text-red-500">Error: {error}</div>;

  const handleToggleColumn = (column: keyof typeof visibleColumns) => {
    setVisibleColumns((prev) => ({
      ...prev,
      [column]: !prev[column],
    }));
  };

  const handleDelete = async (id: string) => {
    try {
      const expense = await DeleteExpense(id)
      setTruckExpenseBook(truckExpenseBook.filter((item) => item._id !== expense._id));
      toast({
        description: 'Expense deleted successfully'
      })
    } catch (error) {
      toast({
        description: 'Failed to Delete Expense',
        variant: 'destructive'
      })
    }
  }

  const handleSelectAll = (selectAll: boolean) => {
    setVisibleColumns({
      date: selectAll,
      amount: selectAll,
      expenseType: selectAll,
      notes: selectAll,
      truck: selectAll,
      action: selectAll,
      trip: selectAll,
      ledger: selectAll,
    });
  };

  return (
    <div className="w-full h-full">

      <ExpenseHeader visibleColumns={visibleColumns} handleSearch={handleSearch} handleSelectAll={handleSelectAll} handleToggleColumn={handleToggleColumn} sortedExpense={sortedExpense} setSelected={setSelected} setModalOpen={setModalOpen} setFilterModalOpen={setFilterModalOpen} />

      <div className="">
        <ExpenseTable
          sortedExpense={sortedExpense}
          handleDelete={handleDelete}
          visibleColumns={visibleColumns}
          requestSort={requestSort}
          getSortIcon={getSortIcon}
          setSelected={setSelected}
          setTruckExpenseBook={setTruckExpenseBook}
          setModalOpen={setModalOpen}
        />
      </div>


      <AddExpenseModal
        isOpen={modalOpen}
        onClose={() => {
          setModalOpen(false);
          setSelected(null);
      }}
        onSave={handleExpense}
        driverId={selected?.driver as string}
        selected={selected}
        categories={['Truck Expense', 'Trip Expense', 'Office Expense']}
      />
      <ExpenseFilterModal
        isOpen={filterModalOpen}
        onClose={() => setFilterModalOpen(false)}
        paymentModes={['Paid By Driver', 'Cash', 'Online', 'Credit']}
        monthYearOptions={monthYearOptions}
        handleFilter={handleFilter} />

    </div>
  );
};

const TruckExpenseWrapper: React.FC = () => {
  return (
    <Suspense fallback={<Loading />}>
      <TripExpense />
    </Suspense>
  )

}

export default TruckExpenseWrapper;
</file>

<file path="src/app/user/expenses/truckExpense/page.tsx">
'use client';
import Loading from '../loading';
import { IExpense, } from '@/utils/interface';
import React, { Suspense, useCallback, useEffect, useMemo, useState } from 'react';

import { DeleteExpense, fetchTruckExpense, handleAddExpense, handleEditExpense } from '@/helpers/ExpenseOperation';

import { FaSort, FaSortDown, FaSortUp } from 'react-icons/fa';

import { formatNumber, generateMonthYearOptions } from '@/utils/utilArray';
import debounce from 'lodash.debounce';
import dynamic from 'next/dynamic';
import { ExpenseHeader } from '@/components/ExpenseHeader';
import { loadingIndicator } from '@/components/ui/LoadingIndicator';
import ExpenseTable from '@/components/ExpenseTable';
import { useToast } from '@/components/hooks/use-toast';

const AddExpenseModal = dynamic(() => import('@/components/AddExpenseModal'), { ssr: false, loading: () => <div>{loadingIndicator}</div> })
const ExpenseFilterModal = dynamic(() => import('@/components/ExpenseFilterModal'), { ssr: false, loading: () => <div>{loadingIndicator}</div> })
const TruckExpense: React.FC = () => {
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState<boolean>(true);
  const [truckExpenseBook, setTruckExpenseBook] = useState<IExpense[] | any[]>([]);
  const [modalOpen, setModalOpen] = useState<boolean>(false);
  const [selected, setSelected] = useState<IExpense | null>(null);
  const [sortConfig, setSortConfig] = useState<any>({ key: null, direction: 'asc' })
  const [searchQuery, setSearchQuery] = useState('')
  const [filterModalOpen, setFilterModalOpen] = useState(false)
  const {toast} = useToast()

  const monthYearOptions = generateMonthYearOptions()

  const [visibleColumns, setVisibleColumns] = useState({
    date: true,
    amount: true,
    expenseType: true,
    notes: true,
    truck: true,
    ledger: true,
    action: true,
  });


  const handleFilter = async (filter: { drivers: string[], trips: string[], trucks: string[], paymentModes: string[], monYear: string[], shops: string[], expenseTypes: [] }) => {
    try {
      const res = await fetch(`/api/expenses/truckExpense?filter=${encodeURIComponent(JSON.stringify(filter))}`)
      const data = await res.json()
      setTruckExpenseBook(data.truckExpense)
    } catch (error) {
      console.log(error)
    } finally {
      setFilterModalOpen(false)
    }
  }

  const sortedExpense = useMemo(() => {
    if (!truckExpenseBook || truckExpenseBook.length === 0) return [];  // This line ensures that truckExpenseBook is not null or empty
    let filteredexpenses = [...truckExpenseBook]

    if (searchQuery) {
      const lowercaseQuery = searchQuery.toLowerCase()
      filteredexpenses = truckExpenseBook.filter((expense: any) =>
        expense.expenseType.toLowerCase().includes(lowercaseQuery) ||
        expense.paymentMode.toLowerCase().includes(lowercaseQuery) ||
        new Date(expense.date).toLocaleDateString().includes(lowercaseQuery) ||
        expense.amount.toString().includes(lowercaseQuery) ||
        expense.notes.toString().includes(lowercaseQuery) ||
        expense.driverName.toString().includes(lowercaseQuery) ||
        expense.truck.toLowerCase().includes(lowercaseQuery)
      )
    }
    if (sortConfig.key !== null) {
      filteredexpenses.sort((a: any, b: any) => {
        if (a[sortConfig.key] < b[sortConfig.key]) {
          return sortConfig.direction === 'asc' ? -1 : 1;
        }
        if (a[sortConfig.key] > b[sortConfig.key]) {
          return sortConfig.direction === 'asc' ? 1 : -1;
        }
        return 0;
      });
    }
    return filteredexpenses;
  }, [truckExpenseBook, sortConfig, searchQuery]);


  const requestSort = (key: any) => {
    let direction: 'asc' | 'desc' = 'asc'
    if (sortConfig.key === key && sortConfig.direction === 'asc') {
      direction = 'desc'
    }
    setSortConfig({ key, direction })
  }

  const getSortIcon = (columnName: any) => {
    if (sortConfig.key === columnName) {
      return sortConfig.direction === 'asc' ? <FaSortUp /> : <FaSortDown />
    }
    return <FaSort />
  }

  // Debounce the search input to reduce re-renders on each keystroke
  const debouncedSearch = useCallback(
    debounce((query) => setSearchQuery(query), 300),
    []
  );

  // Handle search input
  const handleSearch: any = (e: React.ChangeEvent<HTMLInputElement>) => {
    debouncedSearch(e.target.value);
  };


  const getBook = async (month: string | null, year: string | null) => {
    try {
      setLoading(true);
      const truckExpenses = await fetchTruckExpense(month, year);
      setTruckExpenseBook(truckExpenses);
    } catch (error) {
      setError((error as Error).message);
    } finally {
      setLoading(false);
    }
  };

  const handleExpense = async (expense: IExpense | any, id?: string, file?: File | null) => {
    try {
      const data = selected ? await handleEditExpense(expense, selected._id as string, file, toast) : await handleAddExpense(expense, file, toast)
      selected ?
        setTruckExpenseBook((prev) => (
          prev.map((exp) => exp._id === data._id ? ({ ...exp, ...data }) : exp)
        )) : setTruckExpenseBook((prev) => [
          { ...data },
          ...prev
        ])
        toast({
          description: `Expense ${selected ? 'edited' : 'added'} successfully`
        })
    } catch (error) {
      toast({
        description: 'Please try again',
        variant: 'destructive'
      })
    } finally {
      setSelected(null)
      setModalOpen(false);
    }
  };

  useEffect(() => {
    // Call getBook with null for the first render
    getBook(null, null);
  }, [])

  if (loading) return <Loading />;
  if (error) return <div className="text-red-500">Error: {error}</div>;

  const handleToggleColumn = (column: keyof typeof visibleColumns) => {
    setVisibleColumns((prev) => ({
      ...prev,
      [column]: !prev[column],
    }));
  };

  const handleDelete = async (id: string) => {
    try {
      const expense = await DeleteExpense(id)
      setTruckExpenseBook(truckExpenseBook.filter((item) => item._id !== expense._id));
      toast({
        description: 'Expense deleted successfully'
      })
    } catch (error) {
      toast({
        description: 'Failed to Delete Expense',
        variant: 'destructive'
      })
    }
  }

  const handleSelectAll = (selectAll: boolean) => {
    setVisibleColumns({
      date: selectAll,
      amount: selectAll,
      expenseType: selectAll,
      notes: selectAll,
      truck: selectAll,
      action: selectAll,
      ledger: selectAll,
    });
  };

  return (
    <div className="w-full h-full">

      <ExpenseHeader visibleColumns={visibleColumns} handleSearch={handleSearch} handleSelectAll={handleSelectAll} handleToggleColumn={handleToggleColumn} sortedExpense={sortedExpense} setSelected={setSelected} setModalOpen={setModalOpen} setFilterModalOpen={setFilterModalOpen} />


      <div className="">
        <ExpenseTable
          sortedExpense={sortedExpense}
          handleDelete={handleDelete}
          visibleColumns={visibleColumns}
          requestSort={requestSort}
          getSortIcon={getSortIcon}
          setSelected={setSelected}
          setTruckExpenseBook={setTruckExpenseBook}
          setModalOpen={setModalOpen}
        />
      </div>


      <AddExpenseModal
        isOpen={modalOpen}
        onClose={() => {
          setModalOpen(false);
          setSelected(null);
      }}
        onSave={handleExpense}
        driverId={selected?.driver as string}
        selected={selected} categories={['Truck Expense', 'Trip Expense', 'Office Expense']} 
        />
      <ExpenseFilterModal
        isOpen={filterModalOpen}
        onClose={() => setFilterModalOpen(false)}
        paymentModes={['Paid By Driver', 'Cash', 'Online', 'Credit']}
        monthYearOptions={monthYearOptions}
        handleFilter={handleFilter} />

    </div>
  );
};

const TruckExpenseWrapper: React.FC = () => {
  return (
    <Suspense fallback={<Loading />}>
      <TruckExpense />
    </Suspense>
  )

}

export default TruckExpenseWrapper;
</file>

<file path="src/app/user/home/page.tsx">
'use client'

import React, { useEffect, useMemo, useRef, useState } from 'react';
import { FaArrowRightLong, FaRegCircleUser, FaRoute, FaTruck } from 'react-icons/fa6';
import { IoNotificationsOutline } from "react-icons/io5";
import Link from 'next/link';
import { ChartConfig, ChartContainer, ChartLegend, ChartLegendContent, ChartTooltip, ChartTooltipContent } from "@/components/ui/chart"
import { Bar, CartesianGrid, Cell, Label, Legend, Pie, ResponsiveContainer, XAxis, YAxis } from "recharts"
import { useToast } from '@/components/hooks/use-toast';
import Loading from '../loading';
import { useAnimatedNumber } from '@/components/hooks/useAnimatedNumber';
import { useExpenseData } from '@/components/hooks/useExpenseData';
import dynamic from 'next/dynamic';
import { useReminder } from '@/context/reminderContext';
import { Button } from '@/components/ui/button';
import TruckDocumentUpload from '@/components/documents/TruckDocumentUpload';
import TripDocumentUpload from '@/components/documents/TripDocumentUpload';
import DriverDocumentUpload from '@/components/documents/DriverDocumentUpload';
import CompanyDocumentUpload from '@/components/documents/CompanyDocumentUpload';
import OtherDocumentUpload from '@/components/documents/OtherDocumentUpload';
import { motion } from 'framer-motion';
import { PiSteeringWheel } from 'react-icons/pi';
import { X } from 'lucide-react';
import { BiCloudUpload } from 'react-icons/bi';
import { GoOrganization } from 'react-icons/go';
import { useRouter } from 'next/navigation';
import { loadingIndicator } from '@/components/ui/LoadingIndicator';
import { handleAddExpense } from '@/helpers/ExpenseOperation';
import { IExpense } from '@/utils/interface';
import Image from 'next/image';
import biltyImg from '@/assets/bilty-home-icon.png'
import fmImg from '@/assets/fm-home-icon.png'
import loadingSlipImg from '@/assets/loading-slip-home-icon.png'
import quotationImg from '@/assets/quotation-home-icon.png'
import { Dialog, DialogContent, DialogTrigger } from '@/components/ui/dialog';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { statuses } from '@/utils/schema';
import { formatNumber } from '@/utils/utilArray';

const piechartConfig: ChartConfig = {
  totalAmount: {
    label: "Expenses",
    color: "#EA3A88",
  },
  Truck: {
    label: "Truck",
    color: "#5687F2",
  },
  Trip: {
    label: "Trip",
    color: "#60CA3B",
  },
  Office: {
    label: "Office",
    color: "#EA3A88",
  },
}

const chartConfig: ChartConfig = {
  count: {
    label: "Number of Trips :",
    color: "#3190F5",
  },
}

const documentTypes = [
  {
    title: 'Trip Documents',
    link: '/user/documents/tripDocuments',
    icon: <FaRoute className='text-bottomNavBarColor' size={40} />
  },
  {
    title: 'Driver Documents',
    link: '/user/documents/driverDocuments',
    icon: <PiSteeringWheel className='text-bottomNavBarColor' size={40} />
  },
  {
    title: 'Lorry Documents',
    link: '/user/documents/truckDocuments',
    icon: <FaTruck className='text-bottomNavBarColor' size={40} />
  },
  {
    title: 'Company Documents',
    link: '/user/documents/companyDocuments',
    icon: <GoOrganization className='text-bottomNavBarColor' size={40} />
  },
  {
    title: 'Quick Uploads',
    link: '/user/documents/otherDocuments',
    icon: <BiCloudUpload className='text-bottomNavBarColor' size={40} />
  }
];

const RecentActivities = dynamic(() => import('@/components/RecentActivites'), { ssr: false })
const Notification = dynamic(() => import('@/components/Notification'), { ssr: false })
const InvoiceForm = dynamic(() => import('@/components/trip/tripDetail/TripFunctions/InvoiceForm'), { ssr: false, loading: () => <div>{loadingIndicator}</div> })
const AddExpenseModal = dynamic(() => import('@/components/AddExpenseModal'), {
  ssr: false,
  loading: () => <div>{loadingIndicator}</div>
})


const TripSelect = ({ tripId, setTripId, trips }: { tripId: string, setTripId: React.Dispatch<React.SetStateAction<string>>, trips: any[] }) => {
  const [searchTerm, setSearchTerm] = useState('');

  const filteredTrips = useMemo(() => {
    if (!trips || trips.length === 0) return [];
    let filtered = [...trips];
    if (searchTerm) {
      const lowercaseQuery = searchTerm.toLowerCase();
      filtered = trips.filter((trip) =>
        trip.LR.toLowerCase().includes(lowercaseQuery) ||
        trip.partyName.toLowerCase().includes(lowercaseQuery) ||
        trip.route.origin.toLowerCase().includes(lowercaseQuery) ||
        trip.route.destination.toLowerCase().includes(lowercaseQuery) ||
        new Date(trip.startDate).toLocaleDateString().includes(lowercaseQuery) ||
        trip.amount.toString().includes(lowercaseQuery) ||
        trip.truckHireCost.toString().includes(lowercaseQuery) ||
        trip.balance.toString().includes(lowercaseQuery) ||
        trip.truck.toLowerCase().includes(lowercaseQuery)
      );
    }
    return filtered;
  }, [trips, searchTerm]);

  return (
    <div className="mb-4">
      <label className="block text-sm text-gray-700">Trip*</label>
      <Select name="tripId" defaultValue={tripId} onValueChange={(value) => setTripId(value)}>
        <SelectTrigger className="w-full">
          <SelectValue placeholder="Select Trip" />
        </SelectTrigger>
        <SelectContent className="max-h-[300px]">
          <div className="p-2">
            <input
              type="text"
              placeholder="Search..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full p-2 border border-gray-300 rounded-md"
            />
          </div>
          {filteredTrips && filteredTrips.length > 0 ? (
            filteredTrips.map((trip) => (
              <SelectItem key={trip.trip_id} value={trip.trip_id} className='border rounded-md'>
                <div className="grid grid-cols-2 gap-2 p-2 space-x-2 ">
                  {/* Route and Party Name */}
                  <div className="flex items-center justify-between">
                    <span className="font-semibold text-gray-700 whitespace-nowrap">
                      {trip.route.origin.split(',')[0]} &rarr; {trip.route.destination.split(',')[0]}
                    </span>
                    <span className="text-sm text-gray-600 whitespace-nowrap">
                      {trip.partyName}
                    </span>
                  </div>

                  {/* Status and Progress Bar */}
                  <div className="flex flex-col space-y-1">
                    <span className="text-sm text-gray-600">
                      Status: {statuses[trip.status as number]}
                    </span>
                    <div className="relative w-full h-1 bg-gray-200 rounded">
                      <div
                        className={`absolute top-0 left-0 h-1 rounded transition-width duration-500 ${trip.status === 0
                          ? 'bg-red-500'
                          : trip.status === 1
                            ? 'bg-yellow-500'
                            : trip.status === 2
                              ? 'bg-blue-500'
                              : trip.status === 3
                                ? 'bg-green-500'
                                : 'bg-green-800'
                          }`}
                        style={{ width: `${(trip.status as number / 4) * 100}%` }}
                      />
                    </div>
                  </div>

                  {/* LR Number and Start Date */}
                  <div className="flex items-center justify-between">
                    <span className="text-sm text-gray-600 whitespace-nowrap">
                      LR: {trip.LR}
                    </span>
                    <span className="text-sm text-gray-600 whitespace-nowrap">
                      Date: {new Date(trip.startDate).toISOString().split('T')[0]}
                    </span>
                  </div>

                  {/* Balance and Truck Details */}
                  <div className="flex items-center gap-2 justify-between">
                    <span className="text-sm text-gray-600 whitespace-nowrap">
                      Balance: {formatNumber(trip.balance)}
                    </span>
                    <span className="text-sm text-gray-600 whitespace-nowrap">
                      Truck: {trip.truck}
                    </span>
                  </div>
                </div>
              </SelectItem>
            ))
          ) : (
            <div className="p-2 text-gray-500">No Trips found</div>
          )}
        </SelectContent>
      </Select>
    </div>
  );
};

const BarChart = dynamic(() => import('recharts').then((mod) => mod.BarChart), { ssr: false });
const PieChart = dynamic(() => import('recharts').then((mod) => mod.PieChart), { ssr: false });

const Page = () => {
  const router = useRouter()
  const { toast } = useToast()
  const { dashboardData: data, trips, isLoading, refetchDashboard } = useExpenseData()
  const [isNotificationOpen, setIsNotificationOpen] = useState(false)
  const notificationIconRef = useRef<HTMLDivElement>(null);
  const { reminders } = useReminder()
  const [open, setOpen] = useState(false)
  const [tripOpen, setTripOpen] = useState(false);
  const [truckOpen, setTruckOpen] = useState(false);
  const [driverOpen, setDriverOpen] = useState(false);
  const [companyOpen, setCompanyOpen] = useState(false);
  const [otherOpen, setOtherOpen] = useState(false);
  const [InvoiceOpen, setInvoiceOpen] = useState(false);
  const [expenseOpen, setExpenseOpen] = useState(false)
  const [tripId, setTripId] = useState<string>('')

  const totalCost = useMemo(() => {
    return data?.expenses?.reduce((acc, curr) => acc + curr.totalAmount, 0) || 0
  }, [data])

  const totalTrip = useMemo(() => {
    return data?.trips?.reduce((acc, curr) => acc + curr.count, 0) || 0
  }, [data])

  const totalRecievable = useMemo(() => {
    return trips?.reduce((acc, curr) => acc + curr.balance, 0)
  }, [trips])

  const animatedTotalTrip = useAnimatedNumber(totalTrip);
  const animatedTotalCost = useAnimatedNumber(totalCost);
  const animatedTotalReceivable = useAnimatedNumber(totalRecievable);
  const animatedProfit = useAnimatedNumber(data?.profit || 0);


  const openModal = (title: string) => {
    setOpen(false)
    switch (title) {
      case 'Trip Documents':
        setTripOpen(!tripOpen);
        break;
      case 'Truck Documents':
        setTruckOpen(!truckOpen);
        break;
      case 'Driver Documents':
        setDriverOpen(!driverOpen);
        break;
      case 'Company Documents':
        setCompanyOpen(!companyOpen);
        break;
      case 'Quick Uploads':
        setOtherOpen(!otherOpen);
        break;
      default:
        break;
    }
  }

  const handleExpense = async (expense: IExpense | any, id?: string, file?: File | null) => {
    try {
      const data = await handleAddExpense(expense, file, toast)

      toast({
        description: `Expense added successfully`
      })
    } catch (error) {
      toast({
        description: 'Please try again',
        variant: 'destructive'
      })
    } finally {
      setExpenseOpen(false);
    }
  };


  useEffect(() => {
    refetchDashboard()
  }, [refetchDashboard])

  if (isLoading) {
    return <Loading />
  }

  if (!data) {
    return <div className="flex items-center justify-center h-screen">No data available</div>
  }

  return (
    <div className='w-full h-screen bg-white overflow-hidden flex flex-col'>
      <div className='text-black border-b-2 border-gray-400 flex justify-between p-4 xl:px-8 xl:py-2'>
        <h1 className='text-2xl font-semibold'>
          Hey!
        </h1>
        <div className='flex items-center gap-4'>
          <div ref={notificationIconRef} className="relative">
            <button
              onClick={() => setIsNotificationOpen(!isNotificationOpen)}
              className="relative flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-200 transition-colors duration-200"
            >
              <IoNotificationsOutline size={24} />
              {reminders?.tripReminders?.length + reminders?.truckReminders?.length + reminders?.driverReminders?.length > 0 && (
                <span className="absolute top-0 right-0 flex items-center justify-center w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full">
                  {reminders?.tripReminders?.length + reminders?.truckReminders?.length + reminders?.driverReminders?.length}
                </span>
              )}
            </button>
            <Notification
              tripReminders={reminders?.tripReminders || []}
              truckReminders={reminders?.truckReminders || []}
              driverReminders={reminders?.driverReminders || []}
              isOpen={isNotificationOpen}
              onClose={() => setIsNotificationOpen(false)}
            />
          </div>
          <Link href={'/user/profile/details'}>
            <div className="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 transition-colors duration-200">
              <FaRegCircleUser size={24} className='font-normal' />
            </div>
          </Link>
        </div>
      </div>

      <div className='flex h-[calc(100vh-64px)] overflow-hidden'>
        <div className='flex-grow overflow-y-auto border-r border-gray-300 p-4 xl:p-10 xl:py-2 no-scrollbar'>
          <div className='grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4 xl:gap-10 mb-8'>
            <div className='py-3 text-white bg-bottomNavBarColor text-center rounded-xl shadow-xl flex flex-col gap-2'>
              <p className="text-sm">Total Trips</p>
              <p className='text-xl xl:text-2xl font-semibold'>{animatedTotalTrip}</p>
            </div>
            <div className='py-3 text-white bg-bottomNavBarColor text-center rounded-xl shadow-xl flex flex-col gap-2'>
              <p className="text-sm">Total Expenses</p>
              <p className='text-xl xl:text-2xl font-semibold'>{animatedTotalCost}</p>
            </div>
            <div className='py-3 text-white bg-bottomNavBarColor text-center rounded-xl shadow-xl flex flex-col gap-2'>
              <p className="text-sm">Accounts Receivable</p>
              <p className='text-xl xl:text-2xl font-semibold'>{animatedTotalReceivable}</p>
            </div>
          </div>

          <div className="grid gap-8 xl:grid-cols-2 grid-cols-1">
            {/* Trips Section */}
            <div className="bg-white rounded-xl border shadow-md p-4">
              <h2 className="text-xl font-semibold mb-4">Trips</h2>
              {data?.trips?.length > 0 ?
                <ChartContainer config={chartConfig} className="h-[200px] w-full" title="Trips per month">
                  <ResponsiveContainer width="100%" height={250}>
                    <BarChart data={data.trips} barSize={15} margin={{ left: -20, right: 10 }}>
                      <CartesianGrid strokeDasharray="3 3" vertical={false} />
                      <XAxis
                        dataKey="monthYear"
                        tickLine={false}
                        tickMargin={10}
                        axisLine={false}
                        tickFormatter={(value) => value.slice(0, 3)}
                        fontSize={10}
                      />
                      <YAxis axisLine={false} tickLine={false} tick={false} />
                      <ChartTooltip content={<ChartTooltipContent />} />
                      <Bar dataKey="count" fill={chartConfig.count.color} radius={[8, 8, 8, 8]} width={5} />
                    </BarChart>
                  </ResponsiveContainer>
                </ChartContainer>
                :
                <div className="flex items-center justify-center ">
                  <p className="text-center text-gray-500 text-xs">Your monthly trips</p>   
                </div>

              }

            </div>

            {/* Expenses Section */}
            <div className="bg-white rounded-xl border shadow-md p-4">
              <h2 className="text-xl font-semibold mb-4">Expenses</h2>
              {
                data.expenses.length > 0 ?
                  <ChartContainer
                    config={piechartConfig}
                    className="mx-auto aspect-square h-[200px] w-full"
                  >
                    <ResponsiveContainer width="100%" height={250}>
                      <PieChart>
                        <ChartTooltip cursor={false} content={<ChartTooltipContent hideLabel />} />
                        <ChartLegend
                          content={<ChartLegendContent className="flex flex-col items-start xl:items-end" />}
                          iconSize={25}
                          layout="vertical"
                          align="right"
                          verticalAlign="middle"
                        />
                        <Pie
                          data={data.expenses}
                          dataKey="totalAmount"
                          nameKey="_id"
                          innerRadius="60%"
                          outerRadius="100%"
                          paddingAngle={2}
                        >
                          {data.expenses.map((entry, index) => (
                            <Cell
                              key={`cell-${index}`}
                              fill={
                                piechartConfig[entry._id as keyof typeof piechartConfig]?.color ||
                                piechartConfig.totalAmount.color
                              }
                            />
                          ))}
                          <Label
                            content={({ viewBox }) => {
                              if (viewBox && "cx" in viewBox && "cy" in viewBox) {
                                return (
                                  <text
                                    x={viewBox.cx}
                                    y={viewBox.cy}
                                    textAnchor="middle"
                                    dominantBaseline="middle"
                                  >
                                    <tspan
                                      x={viewBox.cx}
                                      y={viewBox.cy}
                                      className="fill-foreground text-xl font-semibold"
                                    >
                                      {totalCost.toLocaleString("en-IN")}
                                    </tspan>
                                    <tspan
                                      x={viewBox.cx}
                                      y={(viewBox.cy || 0) + 20}
                                      className="fill-muted-foreground text-xs"
                                    >
                                      Total Expense
                                    </tspan>
                                  </text>
                                );
                              }
                            }}
                          />
                        </Pie>
                      </PieChart>
                    </ResponsiveContainer>
                  </ChartContainer> :
                  <div className='flex items-center justify-center text-gray-500 text-xs'>
                    <p className='text-center'>Your Expense Analysis</p>
                  </div>
              }

            </div>
          </div>
          <div className='p-2 bg-gray-100 rounded-xl shadow-sm mt-8'>
            <h2 className='font-semibold text-lg xl:text-xl text-black p-4'>Generate Documents</h2>
            <div className='grid gap-4 grid-cols-2 xl:grid-cols-4 py-4 px-4'>
              <Button variant='ghost' className='w-full h-full' onClick={() => toast({
                description: 'Functionality under development',
                variant: 'warning'
              })}>
                <div className='flex flex-col items-center justify-center h-full'>
                  <Image src={quotationImg} alt='Quotation' width={80} height={80} />
                  <p className='text-center text-sm mt-2'>Quotation</p>
                </div>
              </Button>
              <Button variant='ghost' className='w-full h-full' onClick={() => toast({
                description: 'Functionality under development',
                variant: 'warning'
              })}>
                <div className='flex flex-col items-center justify-center h-full'>
                  <Image src={loadingSlipImg} alt='Quotation' width={80} height={80} />
                  <p className='text-center text-sm mt-2'>Loading Slip</p>
                </div>
              </Button>
              <Dialog>
                <DialogTrigger>
                  <Button variant='ghost' className='w-full h-full '>
                    <div className='flex flex-col items-center justify-center h-full'>
                      <Image src={biltyImg} alt='Quotation' width={80} height={80} />
                      <p className='text-center text-sm mt-2'>Bilty</p>
                    </div>
                  </Button>
                </DialogTrigger>
                <DialogContent className='max-w-2xl'>
                  <h2>Select Trip</h2>
                  <TripSelect trips={trips} tripId={tripId} setTripId={setTripId} />
                  {tripId && <div className='flex justify-end'>
                    <Link href={{
                      pathname: `/user/trips/${tripId}`,
                      query: { open: 'bilty' },
                    }}>
                      <Button>
                        <FaArrowRightLong />
                      </Button>
                    </Link>
                  </div>}

                </DialogContent>
              </Dialog>

              <Dialog>
                <DialogTrigger>
                  <Button variant='ghost' className='w-full h-full'>
                    <div className='flex flex-col items-center justify-center h-full'>
                      <Image src={fmImg} alt='Frieght Memo' width={80} height={80} />
                      <p className='text-center text-sm mt-2'>Frieght Memo</p>
                    </div>
                  </Button>
                </DialogTrigger>
                <DialogContent className='max-w-2xl'>
                  <h2>Select Trip</h2>
                  <TripSelect trips={trips} tripId={tripId} setTripId={setTripId} />
                  {tripId && <div className='flex justify-end'>
                    <Link href={{
                      pathname: `/user/trips/${tripId}`,
                      query: { open: 'fm' },
                    }}>
                      <Button>
                        <FaArrowRightLong />
                      </Button>
                    </Link>
                  </div>}

                </DialogContent>
              </Dialog>
            </div>
          </div>
          <div className='grid gap-8 grid-cols-2 xl:grid-cols-4 mt-8 py-4 border-b-2 border-gray-200'>
            <Button onClick={() => router.replace('/user/trips/create')}>
              Add Trip
            </Button>
            <Button onClick={() => setOpen(true)}>
              Add Document
            </Button>
            <Button onClick={() => setExpenseOpen(true)}>
              Add Expense
            </Button>
            <Button onClick={() => setInvoiceOpen(true)}>
              Generate Invoice
            </Button>
          </div>
        </div>
        <div className='w-1/3 xl:w-1/4 xl:min-w-[300px] p-4 xl:p-8 overflow-y-auto'>
          <h2 className="text-2xl font-semibold mb-4">Summary</h2>
          <div className='border-2 border-gray-300 rounded-xl p-4 bg-white shadow-md'>
            <div className='flex items-center justify-between text-sm text-gray-500 mb-2'>
              <p>Your Profit</p>
              <p>{new Date(Date.now()).toLocaleDateString('en-IN', {
                month: 'long',
                year: 'numeric'
              })}</p>
            </div>
            <p className='text-3xl font-semibold'>{animatedProfit}</p>
          </div>
          <div className='mt-8'>
            <h3 className='font-semibold text-xl mb-2'>
              Recent Activities
            </h3>
            <RecentActivities data={data} />
          </div>
        </div>
      </div>



      {
        open &&
        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-40 flex items-center justify-center">
          <motion.div
            initial={{ opacity: 0, scale: 0.95 }}
            animate={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, scale: 0.95 }}
            transition={{
              duration: 0.2,
              ease: [0.4, 0, 0.2, 1]
            }}
            className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden"
          >
            <div className="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
              <h2 className="text-2xl font-semibold text-gray-900 dark:text-gray-100">Select Document Type</h2>
              <Button variant="ghost" size="icon" onClick={() => setOpen(false)}>
                <X className="h-5 w-5" />
              </Button>
            </div>
            <div className="p-6 grid grid-cols-2 sm:grid-cols-5 gap-6">
              {documentTypes.map(({ title, icon }) => (
                <Button
                  key={title}
                  variant="outline"
                  className="flex flex-col items-center justify-center h-32 hover:bg-gray-50 dark:hover:bg-gray-700"
                  onClick={() => openModal(title)}
                >
                  {/* Replace with your actual icon component */}
                  <div className="text-3xl mb-2">{icon}</div>
                  <p className="text-sm font-medium">{title.split(' ')[0]}</p>
                </Button>
              ))}
            </div>


          </motion.div>

        </div>
      }
      <TruckDocumentUpload open={truckOpen} setOpen={setTruckOpen} />



      <TripDocumentUpload open={tripOpen} setOpen={setTripOpen} />


      <DriverDocumentUpload open={driverOpen} setOpen={setDriverOpen} />


      <CompanyDocumentUpload open={companyOpen} setOpen={setCompanyOpen} />


      <OtherDocumentUpload open={otherOpen} setOpen={setOtherOpen} />
      <InvoiceForm open={InvoiceOpen} setOpen={setInvoiceOpen} />
      <AddExpenseModal
        isOpen={expenseOpen}
        onClose={() => {
          setExpenseOpen(false);
        }}
        driverId=''
        onSave={handleExpense}
        categories={['Truck Expense', 'Trip Expense', 'Office Expense']}

      />
    </div>
  );
};

export default Page;
</file>

<file path="src/app/user/invoice/page.tsx">
"use client"

import { useExpenseData } from "@/components/hooks/useExpenseData"
import type React from "react"
import { useEffect, useState } from "react"
import Loading from "../loading"
import invImg from "@/assets/sampleInvoice.png"
import Image from "next/image"
import { formatNumber } from "@/utils/utilArray"
import { PercentageDonut } from "@/components/percentageDonut"
import { useRouter } from "next/navigation"
import { FaLongArrowAltDown } from "react-icons/fa"
import { useToast } from "@/components/hooks/use-toast"
import { Trash2, ArrowUpDown } from "lucide-react"
import { Button } from "@/components/ui/button"
import { motion } from "framer-motion"
import { Input } from "@/components/ui/input"
import { invData } from "@/utils/interface"

const InvoicePage = () => {
  const { invoices, refetchInvoice, isLoading } = useExpenseData()
  const { toast } = useToast()
  const router = useRouter()
  const [sortedInvoices, setSortedInvoices] = useState(invoices)
  const [sortConfig, setSortConfig] = useState({ key: "", direction: "" })
  const [searchTerm, setSearchTerm] = useState("")

  useEffect(() => {
    refetchInvoice()
  }, [refetchInvoice])

  useEffect(() => {
    setSortedInvoices(invoices)
  }, [invoices])

  if (isLoading) {
    return <Loading />
  }

  const handleDelete = async (id: string) => {
    toast({
      description: "Deleting invoice...",
      variant: "warning",
    })
    try {
      const res = await fetch(`/api/invoices/${id}`, {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
        },
      })
      if (!res.ok) {
        throw new Error("Failed to delete invoice")
      }
      refetchInvoice()
      toast({
        description: "Invoice Deleted Successfully",
      })
    } catch (error) {
      toast({
        description: "Failed to delete invoice",
        variant: "destructive",
      })
    }
  }

  const handleSort = (key: string) => {
    let direction = "ascending"
    if (sortConfig.key === key && sortConfig.direction === "ascending") {
      direction = "descending"
    }
    setSortConfig({ key, direction })

    setSortedInvoices(
      [...sortedInvoices as invData[]].sort((a, b) => {
        if (a[key as keyof invData] < b[key as keyof invData]) return direction === "ascending" ? -1 : 1
        if (a[key as keyof invData] > b[key as keyof invData]) return direction === "ascending" ? 1 : -1
        return 0
      }),
    )
  }

  const handleSearch = (event: React.ChangeEvent<HTMLInputElement>) => {
    setSearchTerm(event.target.value)
    const filteredInvoices = invoices?.filter(
      (invoice) =>
        invoice.partyName.toLowerCase().includes(event.target.value.toLowerCase()) ||
        invoice.invoiceNo.toString().includes(event.target.value),
    )
    setSortedInvoices(filteredInvoices)
  }

  return (
    <div className="px-8 container mx-auto">
      <h1 className="text-black text-3xl font-semibold my-4">Invoices</h1>
      <div className="mb-4">
        <Input
          type="text"
          placeholder="Search by party name or invoice number"
          value={searchTerm}
          onChange={handleSearch}
          className="w-full max-w-sm"
        />
      </div>
      <div className="py-2 px-1 rounded-lg shadow-sm border-2 border-gray-300">
        <table className="min-w-full table-auto border-collapse border border-gray-200 rounded-xl">
          <thead>
            <tr className="bg-gray-200">
              <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600">Invoice</th>
              <th
                className="py-3 px-4 text-left text-sm font-semibold text-gray-600 cursor-pointer"
                onClick={() => handleSort("partyName")}
              >
                Party {sortConfig.key === "partyName" && <ArrowUpDown className="inline h-4 w-4" />}
              </th>
              <th
                className="py-3 px-4 text-left text-sm font-semibold text-gray-600 cursor-pointer"
                onClick={() => handleSort("date")}
              >
                Issued Date {sortConfig.key === "date" && <ArrowUpDown className="inline h-4 w-4" />}
              </th>
              <th
                className="py-3 px-4 text-left text-sm font-semibold text-gray-600 cursor-pointer"
                onClick={() => handleSort("dueDate")}
              >
                Due Date {sortConfig.key === "dueDate" && <ArrowUpDown className="inline h-4 w-4" />}
              </th>
              <th
                className="py-3 px-4 text-left text-sm font-semibold text-gray-600 cursor-pointer"
                onClick={() => handleSort("total")}
              >
                Total {sortConfig.key === "total" && <ArrowUpDown className="inline h-4 w-4" />}
              </th>
              <th
                className="py-3 px-4 text-left text-sm font-semibold text-gray-600 cursor-pointer"
                onClick={() => handleSort("advance")}
              >
                Advance {sortConfig.key === "advance" && <ArrowUpDown className="inline h-4 w-4" />}
              </th>
              <th
                className="py-3 px-4 text-left text-sm font-semibold text-gray-600 cursor-pointer"
                onClick={() => handleSort("balance")}
              >
                Balance {sortConfig.key === "balance" && <ArrowUpDown className="inline h-4 w-4" />}
              </th>
              <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600">Action</th>
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-100">
            {sortedInvoices && sortedInvoices?.length > 0 ? (
              sortedInvoices?.map((invoice, index) => (
                <motion.tr
                  key={invoice._id}
                  className="hover:bg-gray-50 cursor-pointer"
                  onClick={() => router.push(`/user/trips/invoice?party=${encodeURIComponent(invoice.party_id)}&route=${encodeURIComponent(JSON.stringify(invoice.route))}&trips=${encodeURIComponent(JSON.stringify(invoice.trips))}&invoiceId=${encodeURIComponent(invoice._id)}&issuedDate=${encodeURIComponent(invoice.date)}&dueDate=${encodeURIComponent(invoice.dueDate)}&gst=${encodeURIComponent(invoice.gst || 0)}`)}
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ duration: 0.3, delay: index * 0.1 }}
                >
                  <td className="py-2 px-3 text-sm text-gray-700 border-b border-gray-200">
                    <div className="">
                      <Image
                        src={invImg || "/placeholder.svg"}
                        alt="Invoice"
                        width={100}
                        height={100}
                        className="border border-gray-400 rounded-md"
                      />
                      <p className="text-center mt-2">#invoice {invoice.invoiceNo}</p>
                    </div>
                  </td>
                  <td className="py-2 px-3 text-sm text-gray-500 border-b border-gray-200">
                    <div>
                      <p className="mb-2">{invoice.partyName || ""}</p>
                      {invoice.route ? (
                        <p>
                          {invoice.route.origin} <FaLongArrowAltDown size={15} /> {invoice.route.destination}
                        </p>
                      ) : (
                        ""
                      )}
                    </div>
                  </td>
                  <td className="py-2 px-3 text-sm text-gray-500 border-b border-gray-200">
                    {new Date(invoice.date).toLocaleDateString("en-IN")}
                  </td>
                  <td className="py-2 px-3 text-sm text-gray-500 border-b border-gray-200">
                    {new Date(invoice.dueDate).toLocaleDateString("en-IN")}
                  </td>
                  <td className="py-2 px-3 text-sm text-gray-500 border-b border-gray-200">
                    {formatNumber(invoice.total)}
                  </td>
                  <td className="py-2 px-3 text-sm text-gray-500 border-b border-gray-200">
                    {formatNumber(invoice.advance)}
                  </td>
                  <td className="py-2 px-3 text-sm text-gray-500 border-b border-gray-200">
                    <div className="flex items-center gap-1">
                      {formatNumber(invoice.balance)}
                      <PercentageDonut percentage={(invoice.advance / invoice.total) * 100} size={100} />
                    </div>
                  </td>
                  <td className="py-2 px-3 text-sm text-gray-500 border-b border-gray-200">
                    <Button
                      variant={"destructive"}
                      onClick={(e) => {
                        e.stopPropagation()
                        handleDelete(invoice._id)
                      }}
                    >
                      <Trash2 size={15} />
                    </Button>
                  </td>
                </motion.tr>
              ))
            ) : (
              <tr>
                <td colSpan={8} className="text-center py-4">
                  No invoice found
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  )
}

export default InvoicePage
</file>

<file path="src/app/user/layout.tsx">
'use client'
import "@/app/globals.css";
import dynamic from 'next/dynamic';
import { Roboto } from 'next/font/google';
import { Toaster } from "@/components/ui/toaster";
import { useEffect } from "react";
import { SpeedInsights } from "@vercel/speed-insights/next"

// Import Roboto font from Google Fonts
const roboto = Roboto({
  subsets: ['latin'], // Define which character subsets to include (e.g., Latin)
  weight: ['400', '500', '700'], // Define which font weights to include
  variable: '--font-roboto', // Variable to be used in CSS
});

// Dynamically import MainLayout without SSR
const MainLayout = dynamic(() => import('@/components/layout/MainLayout'), { ssr: false });


export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {

  useEffect(() => {
    if (typeof window !== 'undefined' && 'serviceWorker' in navigator) {
      navigator.serviceWorker
        .register('/service-worker.js')
        .then((registration) => {
          console.log('Service Worker registered:', registration.scope);
        })
        .catch((err) => console.error('Service Worker registration failed:', err));

      // Request notification permissions for /user/* pages
      if (Notification.permission === 'default') {
        Notification.requestPermission().then((permission) => {
          if (permission === 'granted') {
            console.log('Notifications are enabled');
          } else {
            console.warn('Notifications are disabled');
          }
        });
      }
    }
  }, []);
  return (
        <div className="flex flex-row">
          {/* Sidebar: 3/12 width */}
          <div className="w-screen text-black">
            <MainLayout>{children}</MainLayout>
            <Toaster />
            <SpeedInsights />
          </div>
        </div>
  );
}
</file>

<file path="src/app/user/loading.tsx">
import React from "react";

export default function Loading() {
  return (
    <div className="absolute inset-0 flex flex-col items-center justify-center bg-black bg-opacity-10 z-50">
      
        <iframe 
          src="https://lottie.host/embed/3d45f054-61ac-4d4e-837c-2fa3006e28cc/MeZ8JDXVB5.json" 
        ></iframe>
    </div>
  );}
</file>

<file path="src/app/user/page.tsx">
'use client'
import { useRouter } from 'next/navigation'
import React from 'react'

const UserPage = () => {
  const router = useRouter()
  router.replace('/login')
  return (
    <div>UserPage</div>
  )
}

export default UserPage
</file>

<file path="src/app/user/parties/[singleparty]/details/page.tsx">
'use client';
import { Button } from '@/components/ui/button';
import { useParams, useRouter } from 'next/navigation';
import React, { useEffect, useState } from 'react';
import Loading from '../loading';
import Link from 'next/link';
import { useParty } from '@/context/partyContext';

interface Party {
  address: string;
  balance: number;
  contactNumber: string;
  contactPerson: string;
  gstNumber: string;
  name: string;
  party_id: string;
  user_id: string;
}

const PartyDetails = () => {
  const router = useRouter();
  const { party, setParty, loading } = useParty()
  const [error, setError] = useState<string | null>(null);
  const [isEditing, setIsEditing] = useState(false);

  // const fetchPartyDetails = async (partyId: string) => {
  //   try {
  //     const res = await fetch(`/api/parties/${partyId}`);
  //     if (!res.ok) {
  //       throw new Error('Failed to fetch party details');
  //     }
  //     const data = await res.json();
  //     setParty(data.party);
  //   } catch (err: any) {
  //     setError(err.message);
  //   } finally {
  //     setLoading(false);
  //   }
  // };

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (party) {
      setParty({ ...party, [e.target.name]: e.target.value });
    }
  };

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    if (party) {
      try {
        const res = await fetch(`/api/parties/${party.party_id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            name: party.name,
            contactPerson: party.contactPerson,
            contactNumber: party.contactNumber,
            address: party.address,
            gstNumber: party.gstNumber,
            pan: party.pan,
            email: party.email
          }),
        });
        if (!res.ok) {
          throw new Error('Failed to update party details');
        }
        setIsEditing(false);
        // Optionally refetch data

      } catch (err: any) {
        alert(err.message)
      } finally {

      }
    }
  };

  const handleDelete = async () => {
    if (party) {
      try {
        const res = await fetch(`/api/parties/${party.party_id}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          },
        });
        if (!res.ok) {
          throw new Error('Failed to delete party');
        }
        router.push('/user/parties');
      } catch (err: any) {
        console.log(err)
        alert(err.message)
      }
    }
  };


  if (loading) return <Loading />;
  if (error) return <div>Error: {error}</div>;

  return (
    <div className="max-w-4xl mx-auto p-6 bg-white shadow-md rounded-lg mt-6">
      <h1 className="text-2xl font-bold mb-4">Party Details</h1>
      {party && (
        <form className="grid grid-cols-1 md:grid-cols-2 gap-6" onSubmit={handleSave}>
          <div>
            <label className="block font-medium text-gray-700">Name:</label>
            <input
              type="text"
              name="name"
              value={party.name}
              onChange={handleInputChange}
              className="border border-gray-300 rounded-md p-2"
              disabled={!isEditing}
            />
          </div>
          <div>
            <label className="block font-medium text-gray-700">Contact Person:</label>
            <input
              type="text"
              name="contactPerson"
              value={party.contactPerson}
              onChange={handleInputChange}
              className="border border-gray-300 rounded-md p-2"
              disabled={!isEditing}
            />
          </div>
          <div>
            <label className="block font-medium text-gray-700">Contact Number:</label>
            <input
              type="text"
              name="contactNumber"
              value={party.contactNumber || ''}
              onChange={handleInputChange}
              className="border border-gray-300 rounded-md p-2"
              disabled={!isEditing}
            />
          </div>
          <div>
            <label className="block font-medium text-gray-700">GST Number:</label>
            <input
              type="text"
              name="gstNumber"
              value={party.gstNumber}
              onChange={handleInputChange}
              className="border border-gray-300 rounded-md p-2"
              disabled={!isEditing}
            />
          </div>
          <div>
            <label className="block font-medium text-gray-700">Address:</label>
            <input
              type="text"
              name="address"
              value={party.address}
              onChange={handleInputChange}
              className="border border-gray-300 rounded-md p-2"
              disabled={!isEditing}
            />
          </div>
          <label className="block mb-2">
            Email
            <input
              type="email"
              name="email"
              value={party.email}
              onChange={handleInputChange}
              disabled={!isEditing}
              className="block w-full p-2 mt-1 border border-gray-300 rounded-md"
            />
          </label>
          <label className="block mb-2">
            PAN (Permanent Account Number)
            <input
              type="text"
              name="pan"
              value={party.pan}
              onChange={handleInputChange}
              disabled={!isEditing}
              className="block w-full p-2 mt-1 border border-gray-300 rounded-md"
            />
          </label>
          <div className="flex justify-between col-span-2">
            <div className="mt-6 flex space-x-4">
              {isEditing ? (
                <>
                  <Button type="submit" variant="ghost">Save</Button>
                  <Button type="button" variant="outline" onClick={() => setIsEditing(false)}>Cancel</Button>
                </>
              ) : (
                <Button type="button" variant="outline" onClick={() => setIsEditing(true)}>Edit</Button>
              )}
              <Link href='/user/parties'><Button type="button" >Back to Parties List</Button></Link>
            </div>
            {/* <div className='mt-6 flex space-x-4'>
              <Button type="button" variant="destructive" onClick={handleDelete}>Delete</Button>
            </div> */}
          </div>
        </form>
      )}
    </div>
  );
};

export default PartyDetails;
</file>

<file path="src/app/user/parties/[singleparty]/layout.tsx">
'use client';

import React, { useEffect, useState } from 'react';
import { useParams } from 'next/navigation';
import PartyLayout from '@/components/layout/PartyLayout';
import { PartyProvider } from '@/context/partyContext';

interface PartyLayoutProps {
  children: React.ReactNode;
}

const Layout: React.FC<PartyLayoutProps> = ({ children }) => {
  const { singleparty } = useParams();

  if (!singleparty) {
    return <div>Loading...</div>;
  }

  return (
    <PartyProvider partyId={singleparty as string}>
      <PartyLayout partyId={singleparty as string}>
        {children}
      </PartyLayout>
    </PartyProvider>
  );
};

export default Layout;
</file>

<file path="src/app/user/parties/[singleparty]/loading.tsx">
import React from "react";

export default function Loading() {
  return (
    <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-10 z-50">
      
        <iframe 
          src="https://lottie.host/embed/3d45f054-61ac-4d4e-837c-2fa3006e28cc/MeZ8JDXVB5.json" 
        ></iframe>
    </div>
  );}
</file>

<file path="src/app/user/parties/[singleparty]/monthly-balances/page.tsx">
import React from 'react'

const page = () => {
  return (
    <div>page</div>
  )
}

export default page
</file>

<file path="src/app/user/parties/[singleparty]/passbook/page.tsx">
'use client'

import TripRevenue from '@/components/trip/tripDetail/Profit/TripRevenue';
import { useParams, useRouter } from 'next/navigation';
import React, { useEffect, useMemo, useState } from 'react';
import { FaCalendarAlt, FaRoute, FaSort, FaSortDown, FaSortUp, FaTruck } from 'react-icons/fa';
import Loading from '../loading';
import { formatNumber } from '@/utils/utilArray';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { useParty } from '@/context/partyContext';
import { Button } from '@/components/ui/button';
import { MdDelete, MdEdit } from 'react-icons/md';
import Link from 'next/link';
import dynamic from 'next/dynamic';
import { PaymentBook } from '@/utils/interface';

interface ITrip {
  trip_id: string;
  date: Date;
  truck: string;
  description: {
    origin: string;
    destination: string;
  };
  amount: number;
}

interface IAccount {
  accountType: string;
  amount: number;
  date: Date;
  trip_id: string;
}

const SinglePartyPassbook = () => {
  const { party, setParty, loading } = useParty()
  const router = useRouter();
  console.log(party)

  const [error, setError] = useState<string | null>(null);
  const [sortConfig, setSortConfig] = useState<any>({ key: null, direction: 'asc' })
  const [selected, setSelected] = useState<PaymentBook | any>()
  const [isOpen, setIsOpen] = useState(false)

  const PaymentModal = dynamic(() => import('@/components/party/PaymentModal'))


  const handleDelete = async (id: string) => {
    try {
      const res = await fetch(`/api/parties/${party.party_id}/payments/${id}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      if (!res.ok) {
        throw new Error('Failed to Delete Payment')
      }
      const data = await res.json()
      const payment = data.payment
      setParty((prev: any) => ({
        ...prev,
        items: prev.items.filter((item: PaymentBook | ITrip | any) => item._id !== payment._id)
      }))
    } catch (error) {
      alert('Failed to delete payment')
    }
  }


  const handlePayment = async (payment: PaymentBook | any) => {
    try {
      const res = await fetch(`/api/parties/${party.party_id}/payments/${selected?._id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payment)
      })
      if (!res.ok) {
        throw new Error('failed to add payment')
      }
      const data = await res.json();
      const editedPayment = data.payment;
      const updatedItems = party.items.map((item: any) => item._id === editedPayment._id ? { ...editedPayment, description: editedPayment.accountType, type: 'payment' } : item)


      setParty({ ...party, items: updatedItems });

    } catch (error) {
      alert('failed to edit payment')
    }
  }

  const sortedAccounts = useMemo(() => {
    if (!party?.items || party?.items.length === 0) return []; // Ensure that partyAccount is not null or empty
    let sortableAccounts = [...party.items]; // Clone the array

    // Apply sorting if sortConfig.key is not null
    if (sortConfig.key !== null) {
      sortableAccounts.sort((a, b) => {
        if (sortConfig.key === 'date') {
          // Sort by date field
          const aDate = new Date(a.date);
          const bDate = new Date(b.date);

          if (aDate < bDate) return sortConfig.direction === 'asc' ? -1 : 1;
          if (aDate > bDate) return sortConfig.direction === 'asc' ? 1 : -1;
          return 0;
        } else {
          // Sort by other fields (e.g., amount, revenue, etc.)
          if (a[sortConfig.key as keyof typeof a] < b[sortConfig.key as keyof typeof b]) {
            return sortConfig.direction === 'asc' ? -1 : 1;
          }
          if (a[sortConfig.key as keyof typeof a] > b[sortConfig.key as keyof typeof b]) {
            return sortConfig.direction === 'asc' ? 1 : -1;
          }
          return 0;
        }
      });
    }

    return sortableAccounts;
  }, [party, sortConfig]);



  const requestSort = (key: keyof ITrip | IAccount | any) => {
    let direction: 'asc' | 'desc' = 'asc'
    if (sortConfig.key === key && sortConfig.direction === 'asc') {
      direction = 'desc'
    }
    setSortConfig({ key, direction })
  }

  const getSortIcon = (columnName: keyof ITrip | IAccount | any) => {
    if (sortConfig.key === columnName) {
      return sortConfig.direction === 'asc' ? <FaSortUp /> : <FaSortDown />
    }
    return <FaSort />
  }


  if (loading) return <Loading />;
  if (error) return <div>Error: {error}</div>;
  if (party.items.length === 0) return <div>No transactions or trips for this party</div>;

  return (
    <div className="">
      <Table className="">
        <TableHeader>
          <TableRow>
            <TableHead onClick={() => requestSort('startDate')}>
              <div className='flex justify-between'>
                Date {getSortIcon('startDate')}
              </div>
            </TableHead>
            <TableHead>Details</TableHead>
            <TableHead onClick={() => requestSort('amount')}>
              <div className='flex justify-between'>
                Payment {getSortIcon('amount')}
              </div>
            </TableHead>
            <TableHead onClick={() => requestSort('revenue')}>
              <div className='flex justify-between'>
                Revenue {getSortIcon('revenue')}
              </div>
            </TableHead>
            <TableHead>
              Action
            </TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {sortedAccounts.map((acc: any, index) => (
            <TableRow
              key={index}
              className=" cursor-none"

            >
              <TableCell>
                <div className='flex items-center space-x-2'>
                  <FaCalendarAlt className='text-bottomNavBarColor' />
                  <span>{new Date(acc.date).toLocaleDateString('en-IN')}</span>
                </div>

              </TableCell>
              <TableCell className="p-4">
                {acc.type === 'payment' ? (
                  <div className='flex justify-between'>
                    <span className="text-lg font-semibold">{acc.description}</span>
                    {acc.trip_id && <Link href={`/user/trips/${acc.trip_id}`}><Button className='text-red-500 text-sm' variant={'link'}>from a trip</Button></Link>}
                  </div>

                ) : (
                  <div className="flex items-center space-x-4">
                    <div className="flex items-center space-x-3">
                      <FaTruck className="text-bottomNavBarColor text-2xl" />
                      <span className="ml-1 text-lg font-semibold text-gray-800">{acc.truck}</span>
                    </div>
                    <div className="flex items-center space-x-3 border-l-2 border-gray-200 pl-4">
                      <FaRoute className="text-bottomNavBarColor text-2xl" />
                      <span className="text-gray-700 text-md font-medium">
                        {acc.description?.origin.split(',')[0]} &rarr; {acc.description?.destination.split(',')[0]}
                      </span>
                    </div>
                  </div>

                )}
              </TableCell>



              <TableCell><span className='text-green-500 font-semibold'>{acc.type === 'payment' && `${formatNumber(acc.amount)}`}</span></TableCell>
              <TableCell><span className='text-green-500 font-semibold'>{acc.accountType ? '' : formatNumber(acc.revenue)}</span></TableCell>
              <TableCell>
                <div>
                  {acc.type === 'trip' ? <Button variant={'outline'} onClick={() => router.push(`/user/trips/${acc.trip_id}`)}>View Trip</Button> :

                    (
                      <div className='flex items-center space-x-2'>
                        <Button variant={'outline'} onClick={() => {
                          setSelected({
                            ...acc,
                            accountType: acc.description
                          })
                          setIsOpen(true)
                        }}><MdEdit /></Button>
                        <Button variant={'destructive'} onClick={() => handleDelete(acc._id)}><MdDelete /></Button>
                      </div>
                    )

                  }
                </div>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
      <PaymentModal
        isOpen={isOpen}
        onClose={() => setIsOpen(false)}
        editData={selected}
        onSave={handlePayment} modalTitle={'Payment'} accountType={selected?.accountType || 'Payments'}
      />
    </div>
  );
};

export default SinglePartyPassbook;
</file>

<file path="src/app/user/parties/[singleparty]/trips/page.tsx">
'use client';
import React, { useMemo, useState } from 'react';
import { useRouter } from 'next/navigation';
import { ITrip } from '@/utils/interface';
import { statuses } from '@/utils/schema';
import { FaCalendarAlt, FaTruck, FaRoute, FaFileInvoiceDollar, FaSort, FaSortDown, FaSortUp } from 'react-icons/fa';
import Loading from '../loading';
import { formatNumber } from '@/utils/utilArray';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { useParty } from '@/context/partyContext';
import { renderCellContent } from '@/utils/renderTripCell';

const SinglePartyTrips = () => {
  const { party, loading } = useParty();
  const router = useRouter();
  const [error, setError] = useState<string | null>(null);
  const [sortConfig, setSortConfig] = useState<{ key: keyof ITrip | null; direction: 'asc' | 'desc' }>({
    key: null,
    direction: 'asc',
  });

  const columnOptions = [
    { label: 'Start Date', value: 'date' },
    { label: 'LR Number', value: 'LR' },
    { label: 'Truck Number', value: 'truck' },
    { label: 'Route', value: 'description' },
    { label: 'Status', value: 'status' },
    { label: 'Invoice Amt', value: 'invoice' },
  ];

  // Memoized sorted trips
  const sortedTrips = useMemo(() => {
    if (!party?.items || party?.items?.length === 0) return []; // Ensure trips is not null or empty
    let sortableTrips: ITrip[] = [];

    // Filter trips based on type
    party.items.forEach((item: any) => {
      if (item.type === 'trip') sortableTrips.push(item);
    });

    // Apply sorting if sortConfig key is not null
    if (sortConfig.key) {
      sortableTrips.sort((a: ITrip, b: ITrip) => {
        const aValue = a[sortConfig.key as keyof ITrip];
        const bValue = b[sortConfig.key as keyof ITrip];

        if (aValue < bValue) return sortConfig.direction === 'asc' ? -1 : 1;
        if (aValue > bValue) return sortConfig.direction === 'asc' ? 1 : -1;
        return 0;
      });
    }

    return sortableTrips;
  }, [party, sortConfig]);

  // Function to request sorting
  const requestSort = (key: keyof ITrip) => {
    let direction: 'asc' | 'desc' = 'asc';
    if (sortConfig.key === key && sortConfig.direction === 'asc') {
      direction = 'desc';
    }
    setSortConfig({ key, direction });
  };

  // Function to get sort icon
  const getSortIcon = (columnName: keyof ITrip) => {
    if (sortConfig.key === columnName) {
      return sortConfig.direction === 'asc' ? <FaSortUp /> : <FaSortDown />;
    }
    return <FaSort />;
  };

  if (loading) return <Loading />;
  if (error) return <div>Error: {error}</div>;
  if (party?.items?.length === 0) return <div>No trips for this party</div>;

  return (
    <div className="">
      <Table className="">
        <TableHeader>
          <TableRow>
            <TableHead onClick={() => requestSort('startDate')}>
              <div className='flex justify-between'>
                Start Date {getSortIcon('startDate')}
              </div>
            </TableHead>
            <TableHead>LR Number</TableHead>
            <TableHead>Truck Number</TableHead>
            <TableHead>Route</TableHead>
            <TableHead>Status</TableHead>
            <TableHead onClick={() => requestSort('balance')}>
              <div className='flex justify-between'>
                Amount {getSortIcon('amount')}
              </div>
            </TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {sortedTrips?.map((trip: any) => (
            <TableRow
              key={trip.trip_id}
              className="border-t hover:bg-orange-100 cursor-pointer transition-colors"
              onClick={() => router.push(`/user/trips/${trip.trip_id}`)}
            >
              {columnOptions.map(col =>
                <TableCell key={col.value}>
                  {renderCellContent(col.value, trip)}
                </TableCell>

              )}
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  );
};

export default SinglePartyTrips;
</file>

<file path="src/app/user/parties/create/page.tsx">
'use client'

import React, { useEffect, useState } from 'react';
import PartyForm from '@/components/createParty';
import { IParty } from '@/utils/interface';
import { useRouter, useSearchParams } from 'next/navigation';
import { isValidGSTNumber } from '@/utils/validate';
import { isValidPhone } from '@/utils/validate';
import Loading from '../loading';



const CreatePartyPage: React.FC = () => {
    const [saving, setSaving] = useState(false)
    const router = useRouter()
    const params = useSearchParams()
    const nextpath = params.get('nextpath')


    const handlePartySubmit = async (party: IParty) => {
        setSaving(true)
        if (party.gstNumber && !isValidGSTNumber(party.gstNumber)) {
            alert('Invalid GST number. Please enter a valid GST number.');
            return;
        }

        try {

            const res = await fetch('/api/parties', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(party),
            });

            if (!res.ok) {
                if (res.status === 400) {
                    const errorData = await res.json();
                    alert(`Error: ${errorData.message}`);
                    return;
                } else if (res.status === 409) {
                    alert('Duplicate GST number. Please use a unique GST number.');
                    return;
                } else {
                    alert('An unexpected error occurred. Please try again.');
                    return;
                }
            }

            const data = await res.json();
            if(nextpath){
                const current = JSON.parse(localStorage.getItem('tripData') as any)
                current.party = data.data.party_id
                localStorage.setItem('tripData', JSON.stringify(current))
            }
            router.push(nextpath ? nextpath : '/user/parties');
        } catch (error) {
            console.error('Error saving party:', error);
            alert('An error occurred while saving the party. Please try again.');
        } finally {
            setSaving(false)
        }
    };

    return (
        <>
            {saving && (
                <div className='absolute inset-0 bg-black bg-opacity-10 flex justify-center items-center z-50'>
                    <Loading />
                </div>
            )}
            <div className='w-full h-full'>
                <PartyForm onSubmit={handlePartySubmit} />
            </div>
        </>

    );
};

export default CreatePartyPage;
</file>

<file path="src/app/user/parties/layout.tsx">
'use client'
import { useState, useEffect } from 'react';
import { Inter } from "next/font/google";
import Link from 'next/link';
import '@/app/globals.css';
import { Button } from "@/components/ui/button";
import { usePathname } from "next/navigation";

const inter = Inter({ subsets: ["latin"] });

// Notification Component


const PartiesLayout = ({ children }: { children: React.ReactNode }) => {

  const headings: any = {
    '/user/parties': 'Customers',
    '/user/parties/create': 'New Customer',
  };

  const pathname = usePathname();

  // Handle closing the notification


  // Effect to show notification on load


  return (
    <div className={`${inter.className} max-h-screen flex flex-col`}>
      <div className="container p-2 mx-auto flex flex-col bg-white">
        <div className="flex items-center justify-between mb-4 border-b-2 border-gray-300 pb-2">
          <h1 className="text-3xl font-bold text-black">{headings[pathname] || 'Customers'}</h1>
          <div className="flex space-x-4">
            {!pathname.includes('create') &&
              <Link href="/user/parties/create">
                <Button>

                  Add Customer

                </Button>
              </Link>
            }
            <Link href="/user/trips/create">
              <Button>

                Add Trip
              </Button>
            </Link>

          </div>
        </div>
        <div className="flex-grow">
          {children}
        </div>
      </div>


    </div>
  );
};

export default PartiesLayout;
</file>

<file path="src/app/user/parties/loading.tsx">
export default function Loading() {
  return (
    <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-10 z-50">
      
        <iframe 
          src="https://lottie.host/embed/3d45f054-61ac-4d4e-837c-2fa3006e28cc/MeZ8JDXVB5.json" 
        ></iframe>
    </div>
  );}
</file>

<file path="src/app/user/parties/page.tsx">
// PartiesPage.tsx
'use client';

import React, { useEffect, useMemo, useState } from 'react';
import { useRouter } from 'next/navigation';
import Loading from './loading';
import { FaPhone, FaSort, FaSortDown, FaSortUp, FaUserTie } from 'react-icons/fa6';
import { GoOrganization } from "react-icons/go";
import { FaAddressBook, FaObjectGroup } from 'react-icons/fa';
import { formatNumber } from '@/utils/utilArray';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';

import { useExpenseData } from '@/components/hooks/useExpenseData';
import { handleExportToExcel } from '@/utils/excelOperation';
import { Button } from '@/components/ui/button';
import { BsFiletypeXlsx } from 'react-icons/bs';

const PartiesPage = () => {

  // mutate('/api/parties')
  const router = useRouter();

  const {parties, isLoading, refetchParties} = useExpenseData()

  // const [parties, setParties] = useState<IParty[] | null>(null);
  // const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [sortConfig, setSortConfig] = useState<any>({ key: null, direction: 'asc' })

  useEffect(() => {
    refetchParties()
  }, [refetchParties])

  const sortedParties = useMemo(() => {
    if (!parties || parties.length === 0) return []; // This line ensures that trips is not null or empty
    let sortableTrips = [...parties as any];
    if (sortConfig.key !== null) {
      sortableTrips.sort((a, b) => {
        if (a[sortConfig.key!] < b[sortConfig.key!]) {
          return sortConfig.direction === 'asc' ? -1 : 1;
        }
        if (a[sortConfig.key!] > b[sortConfig.key!]) {
          return sortConfig.direction === 'asc' ? 1 : -1;
        }
        return 0;
      });
    }
    return sortableTrips;
  }, [parties, sortConfig]);

  


  const requestSort = (key: any) => {
    let direction: 'asc' | 'desc' = 'asc'
    if (sortConfig.key === key && sortConfig.direction === 'asc') {
      direction = 'desc'
    }
    setSortConfig({ key, direction })
  }

  const getSortIcon = (columnName: any) => {
    if (sortConfig.key === columnName) {
      return sortConfig.direction === 'asc' ? <FaSortUp /> : <FaSortDown />
    }
    return <FaSort />
  }

  const handleExport = ()=>{
    const selectedColums = ["name", "contactPerson", "contactNumber", "address", "gstNumber", "partyBalance"]
    handleExportToExcel(sortedParties,selectedColums, 'customers.xlsx')
  }

  if (isLoading) {
    return <Loading />;
  }

  if (error) {
    return <div>Error: {error}</div>;
  }

  if (!parties || parties.length === 0) {
    return <div>No parties found</div>;
  }

  return (
    <div className="w-full h-full p-4">
      <div className="">
        <div className='p-2 flex justify-end'>
        <Button onClick={()=>handleExport()}>
          <BsFiletypeXlsx size={20}/>
        </Button>
        </div>
        <Table className="">
          <TableHeader>
            <TableRow>
              <TableHead onClick={() => requestSort('name')}>
                <div className='flex justify-between'>
                  Name {getSortIcon('name')}
                </div>
              </TableHead>
              <TableHead>Contact Person</TableHead>
              <TableHead>Contact Number</TableHead>
              <TableHead>Address</TableHead>
              <TableHead>Email</TableHead>
              <TableHead>PAN</TableHead>
              <TableHead>GST Number</TableHead>
              <TableHead onClick={() => requestSort('partyBalance')}>
                <div className='flex justify-between'>
                  Balance {getSortIcon('partyBalance')}
                </div>
              </TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {sortedParties.map((party, index) => (
              <TableRow index={index + 1} key={party.party_id as string} className="border-t w-full cursor-pointer" onClick={() => router.push(`/user/parties/${party.party_id}/trips`)}>
                <TableCell>
                  <div className='flex items-center space-x-2'>
                    <GoOrganization className="text-bottomNavBarColor" />
                    <span>{party.name}</span>
                  </div>
                </TableCell>
                <TableCell>
                  <div className='flex items-center space-x-2'>
                    <FaUserTie className="text-bottomNavBarColor" />
                    <span>{party.contactPerson}</span>
                  </div>
                </TableCell>
                <TableCell>
                  <div className='flex items-center space-x-2'>
                    <FaPhone className="text-green-500" />
                    <span>{party.contactNumber}</span>
                  </div>
                </TableCell>
                <TableCell>
                  <div className='flex items-center space-x-2'>
                    <FaAddressBook className="text-bottomNavBarColor" />
                    <span>{party.address}</span>
                  </div></TableCell>
                  <TableCell>{party.email}</TableCell>
                  <TableCell>{party.pan}</TableCell>
                <TableCell>{party.gstNumber}</TableCell>
                <TableCell><span className='text-green-600 font-semibold'>{formatNumber(party.partyBalance) || ''}</span></TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </div>
    </div>
  );
};

export default PartiesPage;
</file>

<file path="src/app/user/profile/access/page.tsx">
'use client';

import { useSearchParams } from 'next/navigation';
import React, { useState, ChangeEvent, FormEvent, useEffect, Suspense } from 'react';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import Loading from '@/app/user/loading';

const AccessPage: React.FC = () => {
  const params = useSearchParams();
  const userId = params.get('user_id');
  const [phone, setPhone] = useState<string>('');
  const [role, setRole] = useState<'driver' | 'accountant'>('driver'); // default role
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);
  const [accessList, setAccessList] = useState<{ id: string; phone: string; role: string }[]>([]);

  const handleRoleChange = (e: ChangeEvent<HTMLSelectElement>) => {
    setRole(e.target.value as 'driver' | 'accountant');
  };

  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();

    const response = await fetch('/api/users/grant-access', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        userId,
        phone,
        role,
      }),
    });

    if (!response.ok) {
      throw new Error('Failed to Grant Access');
    }

    const data = await response.json();
    if (data.status === 400) {
      setError(data.error);
      return;
    }

    if (response.ok) {
      setSuccess('Access granted successfully');
      setPhone('');
      setRole('driver'); // Reset to default role
      fetchAccess(); // Refresh access list
    } else {
      setError('Failed to grant access');
    }
  };

  const fetchAccess = async () => {
    try {
      const res = await fetch(`/api/users/grant-access`);
      if (res.ok) {
        const resData = await res.json();
        setAccessList(resData.users);
      } else {
        alert('Failed to Fetch Access List');
      }
    } catch (error: any) {
      console.log(error);
      alert(error.message);
    }
  };

  const handleRevokeAccess = async (accessId: string) => {
    try {
      const response = await fetch(`/api/users/revoke-access/${accessId}`, {
        method: 'DELETE',
      });

      if (response.ok) {
        setAccessList((prevList) => prevList.filter((item : any) => item.user_id !== accessId));
        alert('Access Revoked')
      } else {
        setError('Failed to revoke access');
      }
    } catch (error: any) {
      console.log(error);
      alert('Failed to revoke access');
    }
  };

  useEffect(() => {
    fetchAccess();
  }, []);

  return (
    <Suspense fallback={<Loading />}>
      <div className="max-w-4xl container border border-gray-300 shadow-md rounded-lg p-8">
        <h2 className="text-2xl font-bold text-bottomNavBarColor mb-6 ">
          Grant Access 
        </h2>
        <form onSubmit={handleSubmit} className="space-y-6">
          <div>
            <label
              htmlFor="phone"
              className="block text-sm font-medium text-gray-700"
            >
              Phone Number
            </label>
            <input
              id="phone"
              type="text"
              value={phone}
              onChange={(e) => setPhone(e.target.value)}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent sm:text-sm transition-all duration-200"
              placeholder="19876543210"
              required
            />
          </div>
          <div>
            <label
              htmlFor="role"
              className="block text-sm font-medium text-gray-700"
            >
              Role
            </label>
            <select
              id="role"
              value={role}
              onChange={handleRoleChange}
              className="mt-1 block w-full px-4 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent sm:text-sm transition-all duration-200"
            >
              <option value="driver">Driver</option>
              <option value="accountant">Accountant</option>
            </select>
          </div>
          <Button
            type="submit"
            className="w-full bg-bottomNavBarColor text-white py-2 px-4 rounded-md hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-bottomNavBarColor transition-all duration-200"
          >
            Grant Access
          </Button>
        </form>
        <div className="mt-6 text-center">
          {error && (
            <p className="text-red-600 text-sm font-medium">{error}</p>
          )}
          {success && (
            <p className="text-green-600 text-sm font-medium">{success}</p>
          )}
        </div>

        {/* Access List Section */}
        <div className="mt-8">
          <h3 className="text-xl font-semibold text-bottomNavBarColor mb-4">
            Access List
          </h3>
          <ul className="space-y-4">
            {accessList?.map((access : any) => (
              <li
                key={access.user_id}
                className="flex justify-between items-center p-4 border border-gray-200 rounded-lg shadow-sm"
              >
                <div>
                  <p className="text-gray-800 font-medium">Phone: {access.phone}</p>
                  <p className="text-gray-600">Role: {access.role.name}</p>
                </div>
                <Button
                  onClick={() => handleRevokeAccess(access.user_id)}
                  className="bg-red-600 text-white px-3 py-2 rounded-md hover:bg-red-700 transition-all duration-200"
                >
                  Revoke Access
                </Button>
              </li>
            ))}
          </ul>
        </div>
      </div>
    </Suspense>
  );
};

export default AccessPage;
</file>

<file path="src/app/user/profile/details/page.tsx">
"use client"

import { Button } from "@/components/ui/button"
import { Loader2, Upload, X } from "lucide-react"
import { useRouter } from "next/navigation"
import type React from "react"
import { useEffect, useState, useRef, useCallback } from "react"
import Image from "next/image"
import { removeBackgroundFromImage } from "@/helpers/removebg"
import Loading from "@/app/user/loading"
import logoImg from "@/assets/awajahi logo.png"
import { isValidPhone } from "@/utils/validate"
import { useToast } from "@/components/hooks/use-toast"
import LogoutModal from "@/components/LogoutModal"

const DetailsPage = () => {
  const [user, setUser] = useState<any>()
  const router = useRouter()
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [isEditing, setIsEditing] = useState(false)
  const [logo, setLogo] = useState<File | null>(null)
  const [stamp, setStamp] = useState<File | null>(null)
  const [signature, setSignature] = useState<File | null>(null)
  const [innerLoading, setInnerLoading] = useState(false)
  const [previews, setPreviews] = useState({
    logo: "",
    stamp: "",
    signature: "",
  })
  const canvasRef = useRef<HTMLCanvasElement>(null)
  const [showBgRemovalPrompt, setShowBgRemovalPrompt] = useState(false)
  const [currentFile, setCurrentFile] = useState<{
    file: File
    setter: React.Dispatch<React.SetStateAction<File | null>>
    previewKey: "logo" | "stamp" | "signature"
  } | null>(null)
  const [deleteLogo, setDeleteLogo] = useState(false)
  const [deleteStamp, setDeleteStamp] = useState(false)
  const [deleteSignature, setDeleteSignature] = useState(false)
  const {toast} = useToast()

  const fetchUser = async () => {
    setLoading(true)
    try {
      const response = await fetch("/api/users")
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`)
      }
      const data = await response.json()
      setUser(data.user)
      setPreviews({
        logo: data.user.logoUrl,
        stamp: data.user.stampUrl,
        signature: data.user.signatureUrl,
      })
    } catch (error) {
      console.error("Error:", error)
    }
    setLoading(false)
  }

  useEffect(() => {
    fetchUser()
  }, [])

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (user) {
      if (e.target.name.startsWith("bankDetails")) {
        setUser({
          ...user,
          bankDetails: { ...user.bankDetails, [e.target.name.replace("bankDetails.", "")]: e.target.value },
        })
        return
      }
      setUser({ ...user, [e.target.name]: e.target.value })
    }
  }

  const handleCancel = () => {
    setIsEditing(false)
    setPreviews({
      logo: user.logoUrl || "",
      stamp: user.stampUrl || "",
      signature: user.signatureUrl || "",
    })
    setDeleteLogo(false)
    setDeleteStamp(false)
    setDeleteSignature(false)
  }

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault()
    if(user.altPhone && !isValidPhone(user.altPhone)){
      toast({
        description : "Please enter a correct phone number",
        variant : "destructive"
      })
      return
    }
    setInnerLoading(true)
    if (user) {
      try {
        const formdata = new FormData()
        formdata.append(
          "data",
          JSON.stringify({
            name: user.name,
            company: user.company,
            gstNumber: user.gstNumber,
            address: user.address,
            pincode: user.pincode,
            city: user.city,
            panNumber: user.panNumber,
            bankDetails: user.bankDetails,
            email: user.email,
            altPhone : user.altPhone,
            deleteLogo,
            deleteStamp,
            deleteSignature,
          }),
        )

        // Only append files if they exist and haven't been marked for deletion
        if (logo && !deleteLogo) {
          console.log("Appending logo:", logo)
          formdata.append("logo", logo)
        }
        if (stamp && !deleteStamp) {
          console.log("Appending stamp:", stamp)
          formdata.append("stamp", stamp)
        }
        
        if (signature && !deleteSignature) {
          console.log("Appending signature:", signature)
          formdata.append("signature", signature)
        }

        const res = await fetch(`/api/users`, {
          method: "PUT",
          body: formdata,
        })

        if (!res.ok) {
          throw new Error("Failed to update party details")
        }

        const data = await res.json()
        setUser(data.user)
        setIsEditing(false)
        // Reset deletion states
        setDeleteLogo(false)
        setDeleteStamp(false)
        setDeleteSignature(false)
      } catch (err: any) {
        console.error("Error saving user details:", err)
        alert(err.message)
      }
      setInnerLoading(false)
    }
  }

  const handleFileChange = useCallback(
    (
      e: React.ChangeEvent<HTMLInputElement>,
      setter: React.Dispatch<React.SetStateAction<File | null>>,
      previewKey: "logo" | "stamp" | "signature",
    ) => {
      e.preventDefault()
      if (e.target.files && e.target.files[0]) {
        const file = e.target.files[0]
        setCurrentFile({ file, setter, previewKey })
        setShowBgRemovalPrompt(true)
      }
    },
    [],
  )

  const handleBgRemovalChoice = useCallback(
    (removeBackground: boolean) => {
      setShowBgRemovalPrompt(false)
      if (currentFile && canvasRef.current) {
        const { file, setter, previewKey } = currentFile
        const reader = new FileReader()
        setInnerLoading(true)

        reader.onloadend = async () => {
          const img = document.createElement("img")
          img.onload = () => {
            let processedImageDataUrl: string
            if (removeBackground) {
              processedImageDataUrl = removeBackgroundFromImage(img, canvasRef.current!) as string
            } else {
              const canvas = canvasRef.current!
              canvas.width = img.width
              canvas.height = img.height
              const ctx = canvas.getContext("2d")!
              ctx.drawImage(img, 0, 0)
              processedImageDataUrl = canvas.toDataURL("image/png")
            }

            // Update preview immediately
            setPreviews((prev) => ({ ...prev, [previewKey]: processedImageDataUrl }))

            // Convert the processed image to a File object
            fetch(processedImageDataUrl)
              .then((res) => res.blob())
              .then((blob) => {
                // Create a new File from the processed image blob
                const processedFile = new File([blob], file.name, {
                  type: "image/png",
                })
                // Set the processed file using the appropriate setter
                setter(processedFile)
                setInnerLoading(false)
              })
              .catch((error) => {
                console.error("Error converting processed image to file:", error)
                setInnerLoading(false)
              })
          }
          img.src = reader.result as string
        }
        reader.readAsDataURL(file)
      }
      setCurrentFile(null)
    },
    [currentFile],
  )

  // Helper function to convert processed image URL to a File

  const renderPreview = (type: "logo" | "stamp" | "signature") => {
    const preview = previews[type]
    return (
      <div className="w-full h-40 border rounded-md overflow-hidden flex items-center justify-center bg-gray-100 relative group">
        {preview ? (
          <>
            <Image
              src={preview || "/placeholder.svg"}
              alt={`${type} preview`}
              fill
              className="transition-opacity group-hover:opacity-50 object-contain"
            />
            {isEditing && (
              <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                <Button
                  variant="destructive"
                  size="sm"
                  className="mr-2"
                  onClick={() => {
                    setPreviews((prev) => ({ ...prev, [type]: "" }))
                    if (type === "logo") setDeleteLogo(true)
                    if (type === "stamp") setDeleteStamp(true)
                    if (type === "signature") setDeleteSignature(true)
                  }}
                >
                  <X size={16} className="mr-1" /> Remove
                </Button>
                <label htmlFor={`${type}-upload`} className="cursor-pointer">
                  <Button variant="outline" size="sm" asChild>
                    <span>
                      <Upload size={16} className="mr-1" /> Change
                    </span>
                  </Button>
                </label>
                <input
                  id={`${type}-upload`}
                  name={type}
                  type="file"
                  accept="image/*"
                  onChange={(e) =>
                    handleFileChange(e, type === "logo" ? setLogo : type === "stamp" ? setStamp : setSignature, type)
                  }
                  hidden
                />
              </div>
            )}
          </>
        ) : (
          <label
            htmlFor={`${type}-upload`}
            className="cursor-pointer flex flex-col items-center justify-center text-gray-400"
          >
            <Upload size={24} />
            <span className="mt-2">Upload {type}</span>
            <input
              id={`${type}-upload`}
              name={type}
              type="file"
              accept="image/*"
              onChange={(e) => {
                handleFileChange(e, type === "logo" ? setLogo : type === "stamp" ? setStamp : setSignature, type)
                setIsEditing(true)
              }}
              hidden
            />
          </label>
        )}
      </div>
    )
  }

  if (loading) {
    return <Loading />
  }

  return (
    <div className="max-w-4xl container border border-gray-300 shadow-md rounded-lg p-8">
      {user && (
        <form className="" onSubmit={handleSave}>
          <h2 className="text-black text-lg text-left my-2">User Details</h2>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block font-medium text-gray-700">Name:</label>
              <input
                type="text"
                name="name"
                value={user.name}
                onChange={handleInputChange}
                className="border border-gray-300 rounded-md p-2"
                disabled={!isEditing}
              />
            </div>
            <div>
              <label className="block font-medium text-gray-700">Company Name:</label>
              <input
                type="text"
                name="company"
                value={user.company || ""}
                onChange={handleInputChange}
                className="border border-gray-300 rounded-md p-2"
                disabled={!isEditing}
              />
            </div>
            <div>
              <label className="block font-medium text-gray-700">Secondary Phone:</label>
              <input
                type="text"
                name="altPhone"
                value={user.altPhone || ""}
                onChange={handleInputChange}
                placeholder="9876543210"
                className="border border-gray-300 rounded-md p-2"
                disabled={!isEditing}
              />
            </div>
            <div>
              <label className="block font-medium text-gray-700">GST Number:</label>
              <input
                type="text"
                name="gstNumber"
                value={user.gstNumber || ""}
                onChange={handleInputChange}
                className="border border-gray-300 rounded-md p-2"
                disabled={!isEditing}
              />
            </div>
            <div>
              <label className="block font-medium text-gray-700">PAN Number:</label>
              <input
                type="text"
                name="panNumber"
                value={user.panNumber || ""}
                onChange={handleInputChange}
                className="border border-gray-300 rounded-md p-2"
                disabled={!isEditing}
              />
            </div>
            <div>
              <label className="block font-medium text-gray-700">Email:</label>
              <input
                type="email"
                name="email"
                value={user.email || ""}
                onChange={handleInputChange}
                className="border border-gray-300 rounded-md p-2"
                disabled={!isEditing}
              />
            </div>
            <div>
              <label className="block font-medium text-gray-700">Address:</label>
              <input
                type="text"
                name="address"
                value={user.address || ""}
                onChange={handleInputChange}
                className="border border-gray-300 rounded-md p-2"
                disabled={!isEditing}
              />
            </div>
            <div>
              <label className="block font-medium text-gray-700">City:</label>
              <input
                type="text"
                name="city"
                value={user.city || ""}
                onChange={handleInputChange}
                className="border border-gray-300 rounded-md p-2"
                disabled={!isEditing}
              />
            </div>
            <div>
              <label className="block font-medium text-gray-700">Pincode:</label>
              <input
                type="text"
                name="pincode"
                value={user.pincode || ""}
                onChange={handleInputChange}
                className="border border-gray-300 rounded-md p-2"
                disabled={!isEditing}
              />
            </div>
          </div>

          <h2 className="text-black text-lg text-left mb-2 mt-4">Bank Details</h2>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label htmlFor="bankMsmeNo">MSME Number</label>
              <input
                id="bankMsmeNo"
                name="bankDetails.msmeNo"
                value={user.bankDetails?.msmeNo || ""}
                onChange={handleInputChange}
                disabled={!isEditing}
              />
            </div>
            <div>
              <label htmlFor="bankAccountNo">Account Number</label>
              <input
                id="bankAccountNo"
                name="bankDetails.accountNo"
                value={user.bankDetails?.accountNo || ""}
                onChange={handleInputChange}
                disabled={!isEditing}
              />
            </div>
            <div>
              <label htmlFor="bankIfscCode">IFSC Code</label>
              <input
                id="bankIfscCode"
                name="bankDetails.ifscCode"
                value={user.bankDetails?.ifscCode || ""}
                onChange={handleInputChange}
                disabled={!isEditing}
              />
            </div>
            <div>
              <label htmlFor="bankName">Bank Name</label>
              <input
                id="bankName"
                name="bankDetails.bankName"
                value={user.bankDetails?.bankName || ""}
                onChange={handleInputChange}
                disabled={!isEditing}
              />
            </div>
            <div>
              <label htmlFor="bankBranch">Bank Branch</label>
              <input
                id="bankBranch"
                name="bankDetails.bankBranch"
                value={user.bankDetails?.bankBranch || ""}
                onChange={handleInputChange}
                disabled={!isEditing}
              />
            </div>
          </div>

          <div className="grid grid-cols-3 gap-4 mt-4">
            <div>
              <label className="block font-medium text-gray-700 mb-2">Logo</label>
              {renderPreview("logo")}
            </div>
            <div>
              <label className="block font-medium text-gray-700 mb-2">Stamp</label>
              {renderPreview("stamp")}
            </div>
            <div>
              <label className="block font-medium text-gray-700 mb-2">Signature</label>
              {renderPreview("signature")}
            </div>
          </div>

          {isEditing && (
            <footer className="text-red-500 text-xs mt-2">
              If the Background is not removed properly please upload brighter image*
            </footer>
          )}
          <div className="flex items-center justify-between col-span-2">
            <div className="mt-6 flex items-center   space-x-4">
              {isEditing ? (
                <>
                  <Button type="submit" variant="ghost" disabled={innerLoading}>
                    {innerLoading ? <Loader2 className="text-bottomNavBarColor animate-spin" /> : "Save"}
                  </Button>
                  <Button type="button" variant="outline" onClick={handleCancel}>
                    Cancel
                  </Button>
                </>
              ) : (
                <Button type="button" variant="outline" onClick={() => setIsEditing(true)}>
                  Edit
                </Button>
              )}
              <Button type="button" onClick={() => router.push("/user/parties")}>
                Back to Parties List
              </Button>
            </div>
           {!isEditing && <LogoutModal />}
          </div>
        </form>
      )}
      <canvas ref={canvasRef} style={{ display: "none" }} />
      {showBgRemovalPrompt && (
        <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
            <div className="flex justify-between items-center mb-6">
              <div className="flex items-center gap-2">
                <Image src={logoImg || "/placeholder.svg"} alt="logo" width={30} height={30} priority />
                <h3 className="text-2xl font-semibold text-gray-800">Background Removal</h3>
              </div>

              <button
                onClick={() => setShowBgRemovalPrompt(false)}
                className="text-gray-500 hover:text-gray-700 transition-colors"
              >
                <X size={24} />
              </button>
            </div>
            <p className="text-gray-600 mb-6">Would you like Awajahi to remove the background from this image?</p>
            <div className="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
              <Button onClick={() => handleBgRemovalChoice(true)}>Yes, Remove Background</Button>
              <Button
                onClick={() => handleBgRemovalChoice(false)}
                className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-6 rounded-lg "
              >
                No, Keep Original
              </Button>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}

export default DetailsPage
</file>

<file path="src/app/user/profile/layout.tsx">
'use client';

import React, { useEffect, useState } from 'react';
import { useParams } from 'next/navigation';
import PartyLayout from '@/components/layout/PartyLayout';
import ProfileLayout from '@/components/layout/ProfileLayout';

interface PartyLayoutProps {
  children: React.ReactNode;
}

const Layout: React.FC<PartyLayoutProps> = ({ children }) => {


  return (
    <ProfileLayout>
      {children}
      </ProfileLayout>
  );
};

export default Layout;
</file>

<file path="src/app/user/profile/reports/page.tsx">
"use client";


import React, { useState, Suspense, useRef } from "react";
import { Button } from "@/components/ui/button";
import Loading from "@/app/user/loading";
import { Loader2, X } from "lucide-react";

import { useToast } from "@/components/hooks/use-toast";
import dynamic from "next/dynamic";

const ReportPage: React.FC = () => {
  const [month, setMonth] = useState<string>("");
  const [year, setYear] = useState<string>("");
  const [error, setError] = useState<string | null>(null);
  const [isModalOpen, setModalOpen] = useState<boolean>(false);
  const [reportGernerating, setReportGenerating] = useState<boolean>(false);
  const [reportContent, setReportContent] = useState<string | null>(null);
  const reportRef = useRef<any>(null)
  const { toast } = useToast()
  const Report = dynamic(()=>import('@/components/Report'), {ssr : false})

  const handleGenerateReport = async () => {
    if (!month || !year) {
      toast({
        description: 'Please select month and year',
        variant: 'warning'
      })
      return;
    }
    setReportGenerating(true);
    const response = await fetch(
      `/api/generateReport?month=${month}&year=${year}`
    );

    if (response.ok) {
      const reportHtml = await response.text();
      setReportContent(reportHtml);
      setModalOpen(true); // Open modal-like div to display the report
    } else {
      setError("Failed to generate report");
    }
    setReportGenerating(false);
  };



  return (
    <Suspense fallback={<Loading />}>
      <div className="max-w-4xl container border border-gray-300 shadow-md rounded-lg p-8 overflow-hidden">
        <h2 className="text-2xl font-bold text-bottomNavBarColor mb-4">
          Generate Report
        </h2>
        <div className="space-y-6">
          <div>
            <label htmlFor="month" className="block text-sm font-medium text-gray-700">
              Month
            </label>
            <select
              id="month"
              value={month}
              onChange={(e) => setMonth(e.target.value)}
              className="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
            >
              <option value="">Select Month</option>
              <option value="January">January</option>
              <option value="February">February</option>
              <option value="March">March</option>
              <option value="April">April</option>
              <option value="May">May</option>
              <option value="June">June</option>
              <option value="July">July</option>
              <option value="August">August</option>
              <option value="September">September</option>
              <option value="October">October</option>
              <option value="November">November</option>
              <option value="December">December</option>
            </select>

            <label htmlFor="year" className="block text-sm font-medium text-gray-700 mt-4">
              Year
            </label>
            <input
              id="year"
              type="text"
              value={year}
              onChange={(e) => setYear(e.target.value)}
              className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm"
              placeholder="e.g., 2024"
              required
            />
          </div>

          <Button disabled={reportGernerating} type="button" className="mt-6" onClick={handleGenerateReport}>
            {reportGernerating ? <Loader2 className="text-white animate-spin" /> : 'Generate Report'}
          </Button>
        </div>

        <div className="p-10 text-center text-sm">
          {error && <p className="text-red-500">{error}</p>}
        </div>

        {isModalOpen && reportContent && (
          <Report reportContent={reportContent} setModalOpen={setModalOpen} reportRef={reportRef} month={month} year={year}/>
        )}
      </div>
    </Suspense>
  );
};

export default ReportPage;
</file>

<file path="src/app/user/search/page.tsx">
'use client';
import DriverName from '@/components/driver/DriverName';
import PartyName from '@/components/party/PartyName';
import Driver from '@/components/search/Driver';
import Expense from '@/components/search/Expense';
import OfficeExpense from '@/components/search/OfficeExpense';
import Party from '@/components/search/Party';
import Supplier from '@/components/search/Supplier';
import SupplierAccount from '@/components/search/SupplierAccount';
import Trip from '@/components/search/Trip';
import TripCharges from '@/components/search/TripCharges';
import Truck from '@/components/search/Truck';
import { Button } from '@/components/ui/button';
import { motion } from 'framer-motion';
import React, { useState, useEffect } from 'react';


const SearchPage = () => {
    const [query, setQuery] = useState(''); // State to manage the search query
    const [results, setResults] = useState<any>({}); // State to store the search results
    const [error, setError] = useState<string | null>(null); // State to handle errors
    const [loading, setLoading] = useState(false); // State to manage loading state
    const [debouncedQuery, setDebouncedQuery] = useState(query);

    // Debounce the search input to minimize API calls
    useEffect(() => {
        const timer = setTimeout(() => {
            setDebouncedQuery(query);
        }, 500); // Adjust the debounce delay as needed

        return () => {
            clearTimeout(timer);
        };
    }, [query]);

    // Function to handle the search request
    useEffect(() => {
        const handleSearch = async () => {
            if (!debouncedQuery) return;

            setLoading(true);
            setError(null);
            try {
                const response = await fetch(`/api/search?query=${encodeURIComponent(debouncedQuery)}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch results');
                }
                const data = await response.json();
                setResults(data); // Update the results state with the data received from the server
            } catch (err: any) {
                setError(err.message);
            } finally {
                setLoading(false);
            }
        };

        handleSearch();
    }, [debouncedQuery]);

    // Function to handle form submission
    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        setDebouncedQuery(query);
    };

    return (
        <div className='container flex flex-col space-y-4 bg-gray-100 rounded-md min-h-screen p-4'>
            <h1 className='text-bottomNavBarColor text-3xl font-bold'>Search anything...</h1>
            <form onSubmit={handleSubmit} className='flex items-center space-x-2'>
                <input
                    type='text'
                    placeholder='Search...'
                    value={query}
                    onChange={(e) => setQuery(e.target.value)}
                />
                <Button type='submit'>Search</Button>
            </form>

            {loading && <p>Loading...</p>}
            {error && <p className='text-red-500'>{error}</p>}

            <motion.div
                className='results flex flex-col space-y-4 mt-4 table-container overflow-auto bg-white shadow rounded-lg p-4 min-w-full'
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ duration: 0.3 }}
            >
                {Object.keys(results).length > 0 ? (
                    <div>
                        {/* Parties */}
                        {results.parties?.length > 0 && (
                            <Party parties={results.parties} />
                        )}
                        
                        {/* Trips */}
                        {results.trips?.length > 0 && (
                            <Trip trips={results.trips} />
                        )}

                        {/* Drivers */}
                        {results.drivers?.length > 0 && (
                            <Driver drivers={results.drivers} />
                        )}

                        {/* Trucks */}
                        {results.trucks?.length > 0 && (
                            <Truck trucks={results.trucks} />
                        )}

                        {/* Suppliers */}
                        {results.suppliers?.length > 0 && (
                           <Supplier suppliers={results.suppliers}/>
                        )}

                        {/* Expenses */}
                        {results.expenses?.length > 0 && (
                            <Expense expenses={results.expenses} />
                        )}

                        {/* Supplier Accounts */}
                        {results.supplierAccounts?.length > 0 && (
                            <SupplierAccount accounts={results.supplierAccounts} />
                        )}

                        {/* Office Expenses */}
                        {results.officeExpenses?.length > 0 && (
                            <OfficeExpense expenses={results.officeExpenses} />
                        )}

                        {/* Trip Charges */}
                        {results.tripCharges?.length > 0 && (
                            <TripCharges charges={results.tripCharges} />
                        )}
                    </div>
                ) : (
                    <p>No results found.</p>
                )}
            </motion.div>
        </div>
    );
};

export default SearchPage;
</file>

<file path="src/app/user/shopkhata/[shopId]/layout.tsx">
'use client';

import React, { useEffect, useState } from 'react';
import { useParams, useRouter } from 'next/navigation';
import { IDriver } from '@/utils/interface';
import DriverLayout from '@/components/driver/driverLayout';
import Loading from './loading'
import ShopLayout from '@/components/shopkhata/ShopLayout';

interface PartyLayoutProps {
  children: React.ReactNode;
}

const Layout: React.FC<PartyLayoutProps> = ({ children }) => {
  const {shopId} = useParams();
  const [shop, setShop] = useState<any>();
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<any>()
  const router = useRouter()

  const fetchDriverDetails = async () => {
    try {
      const response = await fetch(`/api/shopkhata/${shopId}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      });

      if (!response.ok) {
        throw new Error('Failed to fetch driver');
      }

      const result = await response.json();
      setShop(result.shop);
    } catch (err: any) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  useEffect(()=>{
    if(shopId){
        fetchDriverDetails()
    }
  },[shopId])

  if(loading) return <Loading />

  return (
    <ShopLayout name={shop?.name || '' }  onShopUpdate={() => router.refresh()} contactNumber={shop?.contactNumber || ''} shopId={shop?.shop_id || ''}>
      {children}
    </ShopLayout>
  );
};

export default Layout;
</file>

<file path="src/app/user/shopkhata/[shopId]/loading.tsx">
import React from "react";

export default function Loading() {
  return (
    <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-10 z-50">
      
        <iframe 
          src="https://lottie.host/embed/3d45f054-61ac-4d4e-837c-2fa3006e28cc/MeZ8JDXVB5.json" 
        ></iframe>
    </div>
  );}
</file>

<file path="src/app/user/shopkhata/[shopId]/page.tsx">
'use client'
import { useToast } from '@/components/hooks/use-toast'
import { Button } from '@/components/ui/button'
import { loadingIndicator } from '@/components/ui/LoadingIndicator'
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table'
import { DeleteExpense, handleEditExpense } from '@/helpers/ExpenseOperation'
import { IExpense } from '@/utils/interface'
import { formatNumber } from '@/utils/utilArray'
import dynamic from 'next/dynamic'
import Link from 'next/link'
import { useParams } from 'next/navigation'
import React, { useEffect, useState } from 'react'
import { FaCalendarAlt } from 'react-icons/fa'
import { MdDelete, MdEdit } from 'react-icons/md'


const AddExpenseModal = dynamic(() => import('@/components/AddExpenseModal'), { ssr: false, loading: () => <div>{loadingIndicator}</div> })

const ShopPage = () => {

  const { shopId } = useParams()
  const [accounts, setAccounts] = useState<any[]>([])
  const [selected, setSelected] = useState<IExpense | any | null>(null)
  const { toast } = useToast()
  const [expenseModal, setExpenseModal] = useState(false)
  const [shopModal, setShopModal] = useState(false)

  const fetchAccounts = async () => {
    const res = await fetch(`/api/shopkhata/${shopId}/accounts`)
    const data = res.ok ? await res.json() : alert('Failed to fetch shopkhata')
    setAccounts(data.khata.combined)
    console.log(data)
  }

  useEffect(() => {
    if (shopId) {
      fetchAccounts()
    }
  }, [shopId])

  const delelteShopKhata = async (id: string) => {
    try {
      const res = await fetch(`/api/shopkhata/${shopId}/accounts/${id}`, {
        method: 'DELETE'
      })
      if (res.ok) {
        toast({ description: 'Shopkhata deleted successfully' })
        setAccounts((prev) => prev.filter(acc => acc._id !== id))
        return
      } else {
        throw new Error('Failed to delete Entry')
      }
    } catch (error) {
      toast({
        description: 'Failed to delete Entry',
        variant: 'destructive'
      })
    }
  }

  const deleteExpense = async (id: string) => {
    try {
      await DeleteExpense(id)
      toast({ description: 'Expense deleted successfully' })
    } catch (error) {
      toast({
        description: 'Failed to delete Expense',
        variant: 'destructive'
      })
    }
  }

  const handleExpense = async (expense: IExpense | any, id: string, file?: File | null) => {
    console.log(file)
    try {
      const data = await handleEditExpense(expense, selected._id as string, file)

      if (data.shop_id !== shopId) {
        setAccounts(prev => prev.filter(acc => acc._id === selected._id))
      } else {
        setAccounts((prev) => (
          prev.map((exp) => exp._id === data._id ? ({ ...exp, ...data }) : exp)
        ))
      }
      toast({
        description: `Expense ${selected ? 'edited' : 'added'} successfully`
      })
    } catch (error) {
      toast({
        description: 'Please try again',
        variant: 'destructive'
      })
    } finally {
      setSelected(null)
      setExpenseModal(false);
    }
  };

  

  return (
    <div className="w-full">

      <div className="w-full h-full p-4">
        <div className="Table-container">
          <Table className="">
            <TableHeader>
              <TableRow>
                <TableHead>Date</TableHead>
                <TableHead>Reason</TableHead>
                <TableHead>Credit</TableHead>
                <TableHead>Payment</TableHead>
                <TableHead>Action</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {accounts.map((account, index: number) => (
                <TableRow key={account._id} index={index}>
                  <TableCell>
                    <div className='flex items-center space-x-2'>
                      <FaCalendarAlt className='text-bottomNavBarColor' />
                      <span>{new Date(account.date || account.paymentDate).toLocaleDateString()}</span>
                    </div>
                  </TableCell>
                  <TableCell >
                    <div className='flex items-center space-x-2 '>
                      <span>{account.reason || account.expenseType || `Trip ${account.accountType} `}</span>
                      {account.trip_id && <Button variant={"link"} className='text-red-500 pt-1 rounded-lg'><Link href={`/user/trips/${account.trip_id}`}>from a trip</Link></Button>}
                    </div>
                  </TableCell>
                  <TableCell><span className='text-red-600 font-semibold'>{formatNumber(account.credit) || formatNumber(account.amount)}</span></TableCell>
                  <TableCell ><span className='text-green-600 font-semibold'>{formatNumber(account.payment)}</span></TableCell>
                  <TableCell>
                    <div className='flex gap-2'>
                      <Button variant={'outline'} onClick={() => {
                        setSelected(account)
                        account.expenseType ? setExpenseModal(true) : setShopModal(true)
                      }}>
                        <MdEdit />
                      </Button>
                      <Button variant={'destructive'} onClick={() => {
                        account.expenseType ? deleteExpense(account._id) : delelteShopKhata(account._id)
                      }}>
                        <MdDelete />
                      </Button>
                    </div>
                  </TableCell>

                </TableRow>
              ))}
            </TableBody>
          </Table>

          <AddExpenseModal
            isOpen={expenseModal}
            onClose={() => {
              setExpenseModal(false);
              setSelected(null);
            }}
            onSave={handleExpense}
            driverId={selected?.driver as string}
            selected={selected}
            categories={['Truck Expense', 'Trip Expense', 'Office Expense']}

          />

        </div>
      </div>
    </div>
  )
}

export default ShopPage
</file>

<file path="src/app/user/shopkhata/create/page.tsx">
'use client'

import React, { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { isValidGSTNumber } from '@/utils/validate';
import Loading from '@/app/user/loading'
import ShopKhataForm from '@/components/shopkhata/ShopKhataForm';
import { mutate } from 'swr';



const CreateShopPage: React.FC = () => {
    const [saving, setSaving] = useState(false)
    const router = useRouter()


    const handleShopSubmit = async (shop: any) => {
        setSaving(true)
        if (shop.gstNumber && !isValidGSTNumber(shop.gstNumber)) {
            alert('Invalid GST number. Please enter a valid GST number.');
            return;
        }

        try {

            const res = await fetch('/api/shopkhata', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(shop),
            });

            if (!res.ok) {
                if (res.status === 400) {
                    const errorData = await res.json();
                    alert(`Error: ${errorData.message}`);
                    return;
                } else if (res.status === 409) {
                    alert('Duplicate GST number. Please use a unique GST number.');
                    return;
                } else {
                    alert('An unexpected error occurred. Please try again.');
                    return;
                }
            }

            const data = await res.json();
            mutate('/api/shopkhata')
            router.push('/user/shopkhata');
        } catch (error) {
            console.error('Error saving party:', error);
            alert('An error occurred while saving the party. Please try again.');
        } finally {
            
            setSaving(false)
        }
    };

    return (
        <>
            {saving && (
                <div className='absolute inset-0 bg-black bg-opacity-10 flex justify-center items-center z-50'>
                    <Loading />
                </div>
            )}
            <div className='w-full h-full'>
                <ShopKhataForm onSubmit={handleShopSubmit} />
            </div>
        </>

    );
};

export default CreateShopPage;
</file>

<file path="src/app/user/shopkhata/layout.tsx">
'use client'
import { useState, useEffect } from 'react';
import { Inter } from "next/font/google";
import Link from 'next/link';
import '@/app/globals.css';
import { Button } from "@/components/ui/button";
import { usePathname } from "next/navigation";

const inter = Inter({ subsets: ["latin"] });

// Notification Component
const Notification = ({ message, onClose }: { message: string, onClose: () => void }) => {
  return (
    <div className="fixed top-5 right-5 bg-lightOrange border-l-4 border-yellow-500 text-buttonTextColor p-4 rounded shadow-lg">
      <div className="flex items-center justify-between">
        <span>{message}</span>
        <button onClick={onClose} className="ml-4 text-buttonTextColor transform duration-300 ease-in-out hover:scale-125">X</button>
      </div>
    </div>
  );
};

const ShopLayout = ({ children }: { children: React.ReactNode }) => {
  // State for controlling notification visibility

  const headings: any = {
    '/user/shopkhata': 'Shops',
    '/user/shopkhata/create': 'New Shop',
  };

  const pathname = usePathname();


  return (
    <div className={`${inter.className} max-h-screen flex flex-col`}>
      <div className="container mx-auto p-2 flex flex-col bg-white">
        <div className="flex items-center justify-between mb-4 border-b-2 border-gray-300 pb-2">
          <h1 className="text-3xl font-bold text-black">{headings[pathname] || 'Shops'}</h1>
          <div className="flex space-x-4">
            {!pathname.includes('create') &&
              <Button>
                <Link href="/user/shopkhata/create">
                  Add Shop
                </Link>
              </Button>
            }
          </div>
        </div>
        <div className="flex-grow">
          {children}
        </div>
      </div>

    </div>
  );
};

export default ShopLayout;
</file>

<file path="src/app/user/shopkhata/page.tsx">
// PartiesPage.tsx
'use client';

import React, { useCallback, useEffect, useMemo, useState } from 'react';
import { useRouter } from 'next/navigation';
import Loading from '@/app/user/loading'
import { FaPhone } from 'react-icons/fa6';
import { GoOrganization } from "react-icons/go";
import { FaAddressBook, FaSort, FaSortDown, FaSortUp } from 'react-icons/fa';
import { formatNumber } from '@/utils/utilArray';
import debounce from 'lodash.debounce';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { useExpenseData } from '@/components/hooks/useExpenseData';

const ShopKhataPage = () => {
  const {shops, isLoading, refetchShops} = useExpenseData()
  const router = useRouter();
  const [error, setError] = useState<string | null>(null);
  const [sortConfig, setSortConfig] = useState<any>({ key: null, direction: 'asc' });
  const [searchQuery, setSearchQuery] = useState(''); // Track the search query



  useEffect(() => {
    refetchShops()
  }, [refetchShops])

  const requestSort = (key: any) => {
    let direction: 'asc' | 'desc' = 'asc';
    if (sortConfig.key === key && sortConfig.direction === 'asc') {
      direction = 'desc';
    }
    setSortConfig({ key, direction });
  };

  // Sort icon logic
  const getSortIcon = (columnName: any) => {
    if (sortConfig.key === columnName) {
      return sortConfig.direction === 'asc' ? <FaSortUp /> : <FaSortDown />;
    }
    return <FaSort />;
  };

  // Debounce the search input to reduce re-renders on each keystroke
  const debouncedSearch = useCallback(
    debounce((query) => setSearchQuery(query), 300),
    []
  );

  // Handle search input
  const handleSearch = (e: React.ChangeEvent<HTMLInputElement>) => {
    debouncedSearch(e.target.value.toLowerCase());
  };

  // Filter and sort suppliers based on search query and sort configuration
  const filteredAndSortedShops = useMemo(() => {
    let filteredShops = shops;

    // Filter based on search query
    if (searchQuery) {
      filteredShops = shops.filter((shop: any) =>
        shop.name.toLowerCase().includes(searchQuery) ||
        shop.contactNumber.toString().includes(searchQuery) ||
        shop.address.toString().includes(searchQuery) ||
        shop.balance.toString().includes(searchQuery) ||
        shop.gstNumber.toString().includes(searchQuery)
      );
    }

    // Sort the suppliers
    if (sortConfig.key !== null) {
      filteredShops.sort((a: any, b: any) => {
        if (a[sortConfig.key] < b[sortConfig.key]) {
          return sortConfig.direction === 'asc' ? -1 : 1;
        }
        if (a[sortConfig.key] > b[sortConfig.key]) {
          return sortConfig.direction === 'asc' ? 1 : -1;
        }
        return 0;
      });
    }

    return filteredShops;
  }, [shops, searchQuery, sortConfig]);


  if (isLoading) {
    return <Loading />;
  }

  if (error) {
    return <div>Error: {error}</div>;
  }

  if (!shops || shops.length === 0) {
    return <div>No Shops found</div>;
  }

  return (
    <div className="w-full h-full p-4">
      <input type='text' placeholder='Search' onChange={handleSearch} />
      <div className='mt-2'>
        <Table >
          <TableHeader>
            <TableRow>
              <TableHead onClick={() => requestSort('name')}>
                <div className='flex justify-between'>
                  Name {getSortIcon('name')}
                </div>
              </TableHead>
              <TableHead>Contact</TableHead>
              <TableHead onClick={() => requestSort('address')}>
                <div className='flex justify-between'>
                  Address {getSortIcon('address')}
                </div>
              </TableHead>
              <TableHead>GST Number</TableHead>
              <TableHead onClick={() => requestSort('name')}>
                <div className='flex justify-between'>
                  Shop Balance {getSortIcon('balance')}
                </div>
              </TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {filteredAndSortedShops.map((shop, index) => (
              <TableRow index={index + 1} key={shop.shop_id as string} className="border-t w-full cursor-pointer" onClick={() => router.push(`/user/shopkhata/${shop.shop_id}`)}>
                <TableCell>
                  <div className='flex items-center space-x-2'>
                    <GoOrganization className="text-bottomNavBarColor" />
                    <span>{shop.name}</span>
                  </div>
                </TableCell>
                <TableCell>
                  <div className='flex items-center space-x-2'>
                    <FaPhone className="text-green-500" />
                    <span>{shop.contactNumber}</span>
                  </div>
                </TableCell>
                <TableCell>
                  <div className='flex items-center space-x-2'>
                    <FaAddressBook className="text-bottomNavBarColor" />
                    <span>{shop.address}</span>
                  </div></TableCell>
                <TableCell>{shop.gstNumber}</TableCell>
                <TableCell><span className={`${shop.balance > 0 ? 'text-green-500' : 'text-red-500'} font-semibold`}>{formatNumber(shop.balance)}</span></TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </div>
    </div>
  );
};

export default ShopKhataPage;
</file>

<file path="src/app/user/suppliers/[supplierId]/layout.tsx">
'use client';

import { useParams } from 'next/navigation';
import Loading from '../loading';
import SupplierLayout from '@/components/layout/SupplierLayout';
import { SupplierProvider } from '@/context/supplierContext';

interface PartyLayoutProps {
  children: React.ReactNode;
}

const Layout: React.FC<PartyLayoutProps> = ({ children }) => {
  const {supplierId} = useParams();


  if (!supplierId) {
    return <Loading />
  }

  return (
    <SupplierProvider supplierId={supplierId as string}>
    <SupplierLayout>
      {children}
    </SupplierLayout>
    </SupplierProvider>
  );
};

export default Layout;
</file>

<file path="src/app/user/suppliers/[supplierId]/passbook/page.tsx">
'use client'
import Loading from '../../loading'
import TripRoute from '@/components/trip/TripRoute'
import { Button } from '@/components/ui/button'
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table'
import { useSupplier } from '@/context/supplierContext'
import { ISupplierAccount, ITrip } from '@/utils/interface'
import { formatNumber } from '@/utils/utilArray'
import Link from 'next/link'
import { useParams, useRouter } from 'next/navigation'
import React, { useEffect, useState } from 'react'
import { FaCalendarAlt, FaRoute, FaTruck, FaWallet } from 'react-icons/fa'
import { MdDelete, MdEdit } from 'react-icons/md'

const SupplierPassbook = () => {
  const router = useRouter()
  const { supplierId } = useParams()
  const { supplier, setSupplier, loading } = useSupplier()
  // const fetchData = async () => {
  //   const [tripRes, paymentRes] = await Promise.all([
  //     fetch(`/api/suppliers/${supplierId}/payments/trips`),
  //     fetch(`/api/suppliers/${supplierId}/payments`)
  //   ])

  //   const [tripData, paymentData] = await Promise.all([
  //     tripRes.ok ? tripRes.json() : [],
  //     paymentRes.ok ? paymentRes.json() : []
  //   ])

  //   setTrips(tripData.trips)
  //   setAccounts(paymentData.supplierAccounts)
  //   setLoading(false)
  // }

  // useEffect(() => {
  //   fetchData()
  // }, [supplierId])

  const handleDeleteAccount = async (paymentId: string) => {
    const res = await fetch(`/api/suppliers/${supplierId}/payments/${paymentId}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      }
    })
    if (!res.ok) {
      alert('Failed to delete payment')
      return
    }
    const data = await res.json()
    console.log(data)
    // setAccounts(accounts.filter((acc: ISupplierAccount) => acc._id !== paymentId))
    setSupplier((prev: any) => ({
      ...prev,
      supplierTripAccounts: prev.supplierTripAccounts.filter((acc: any) => acc._id !== paymentId),
      balance : prev.balance - data.payment.amount
    }))
  }

  if (loading) return <Loading />

  return (
    <div className="w-full h-full p-4">
      <div className="table-container">
        <Table className="custom-table">
          <TableHeader>
            <TableRow className="bg-gray-200">
              <TableHead className="border p-2">Date</TableHead>
              <TableHead className="border p-2">Details</TableHead>
              <TableHead className="border p-2">Payment</TableHead>
              <TableHead className="border p-2">Expense</TableHead>
              <TableHead className='border p-2'>Action</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {supplier.supplierTripAccounts && supplier.supplierTripAccounts.map((acc: any, index: number) => (
              <TableRow key={index} className="border-t hover:bg-slate-100 cursor-pointer">
                <TableCell className="border p-2">
                  <div className="flex items-center space-x-2">
                    <FaCalendarAlt className="text-bottomNavBarColor" />
                    <span>{new Date(acc.date).toLocaleDateString()}</span>
                  </div>
                </TableCell>
                <TableCell className="border p-2">
                  {acc.type === 'payment' ?
                    <div className='flex justify-between'>
                      <div className='flex items-center space-x-2'>
                        <FaWallet className='text-bottomNavBarColor' />
                        <span>Payment</span>
                      </div>
                      <div>
                        {acc.route && acc.trip_id && <p>{acc.route.origin.split(',')[0]} &rarr; {acc.route.destination.split(',')[0]}</p>}
                      </div>
                    </div> :
                    <div className="flex items-center justify-between space-y-2">
                      <span className="font-medium flex items-center space-x-2 p-1"><FaWallet className='text-bottomNavBarColor' /><span>Truck Hire Cost</span></span>

                      <span className=" text-gray-600 flex items-center space-x-2 p-1">
                        <FaRoute className='text-bottomNavBarColor' />
                        <p>{acc.route.origin.split(',')[0]} &rarr; {acc.route.destination.split(',')[0]}</p>
                      </span>
                    </div>
                  }

                </TableCell>
                <TableCell className="border p-2"><span className='text-green-600 font-semibold'>{acc.type === 'payment' && `${formatNumber(acc.amount)}`}</span></TableCell>
                <TableCell className="border p-2"><span className='text-red-600 font-semibold'>{acc.type === 'trip' && `${formatNumber(acc.amount)}`}</span></TableCell>
                <TableCell className='border p-2'>
                  {acc.type === 'payment' ?
                    <div className='flex items-center space-x-2'>

                      <Button variant={'destructive'} onClick={() => handleDeleteAccount(acc._id)}><MdDelete /></Button>
                      {acc.trip_id && <Link href={`/api/trips/${acc.trip_id}`}><Button variant={'outline'}>View Trip</Button></Link>}
                    </div> :
                    <div className='flex items-center gap-2'>
                      <Link href={`/user/trips/${acc.trip_id}`}><Button variant={'outline'}>View Trip</Button></Link>
                    </div>
                  }

                </TableCell>
              </TableRow>
            ))}

          </TableBody>
        </Table>
      </div>
    </div>
  )
}

export default SupplierPassbook
</file>

<file path="src/app/user/suppliers/[supplierId]/trips/page.tsx">
'use client'
import { Button } from '@/components/ui/button'
import {  ITrip } from '@/utils/interface'
import { statuses } from '@/utils/schema'
import Link from 'next/link'
import { useParams } from 'next/navigation'
import React, { useEffect, useMemo, useState } from 'react'
import Loading from '../../loading'
import { FaCalendarAlt, FaTruck, FaRoute, FaSort, FaSortDown, FaSortUp } from 'react-icons/fa'
import { formatNumber } from '@/utils/utilArray'
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table'
import { useSupplier } from '@/context/supplierContext'


const SupplierDetailPage = () => {

    const {supplier, setSupplier, loading} = useSupplier()
    const [sortConfig, setSortConfig] = useState<any>({ key: null, direction: 'asc' })

    const sortedTrips = useMemo(() => {
      if (!supplier?.supplierTripAccounts || supplier?.suppplierTripAccounts?.length === 0) return []; // This line ensures that trips is not null or empty
      let sortableTrips = [...supplier.supplierTripAccounts as any];
      if (sortConfig.key !== null) {
        sortableTrips.sort((a, b) => {
          if (a[sortConfig.key!] < b[sortConfig.key!]) {
            return sortConfig.direction === 'asc' ? -1 : 1;
          }
          if (a[sortConfig.key!] > b[sortConfig.key!]) {
            return sortConfig.direction === 'asc' ? 1 : -1;
          }
          return 0;
        });
      }
      return sortableTrips;
    }, [supplier, sortConfig]);
  
  
    const requestSort = (key: keyof ITrip) => {
      let direction: 'asc' | 'desc' = 'asc'
      if (sortConfig.key === key && sortConfig.direction === 'asc') {
        direction = 'desc'
      }
      setSortConfig({ key, direction })
    }
  
    const getSortIcon = (columnName: keyof ITrip) => {
      if (sortConfig.key === columnName) {
        return sortConfig.direction === 'asc' ? <FaSortUp /> : <FaSortDown />
      }
      return <FaSort />
    }

    // const fetchSupplierTrips = async (supplierId: string) => {
    //     const res = await fetch(`/api/trips/supplier/${supplierId}`, {
    //         method: 'GET',
    //         headers: {
    //             'Content-Type': 'application/json'
    //         }
    //     })
    //     const data = await res.json()
    //     console.log(data)
    //     setTrips(data.trips)
    //     setLoading(false)
    // }

    // useEffect(() => {
    //     if (supplierId) {
    //         fetchSupplierTrips(supplierId as string)
    //     }
    // }, [supplierId])

    if (loading) {
        return <Loading />
    }
    return (
        <div className="w-full h-full p-4">
            <div className="table-container">
                <Table className="custom-table">
                    <TableHeader>
                        <TableRow className="bg-gray-200">
                            <TableHead onClick={()=> requestSort('startDate')}>
                                <div className='flex justify-between'>
                                Start Date {getSortIcon('startDate')}
                                </div>
                                </TableHead>
                            <TableHead>Truck Number</TableHead>
                            <TableHead>Route</TableHead>
                            <TableHead onClick={()=> requestSort('truckHireCost')}>
                            <div className='flex justify-between'>
                                Truck Hire Cost {getSortIcon('truckHireCost')}
                                </div>
                            </TableHead>
                            <TableHead onClick={()=>requestSort('status')}>
                            <div className='flex justify-between'>
                                Status {getSortIcon('status')}
                                </div>
                            </TableHead>
                            <TableHead  onClick={()=> requestSort('amount')}>
                            <div className='flex justify-between'>
                                Trip Amount {getSortIcon('amount')}
                                </div>
                            </TableHead>
                            <TableHead className='border p-2'>Action</TableHead>
                        </TableRow>
                    </TableHeader>
                    <TableBody>
                        {sortedTrips.map((trip, index) => (
                            trip.type === 'trip' &&
                            <TableRow key={index} className="border-t hover:bg-slate-100 cursor-pointer">
                                <TableCell className="border p-4">
                                <div className='flex items-center space-x-2'>
                                    <FaCalendarAlt className="text-bottomNavBarColor" />
                                    <span>{new Date(trip.date).toLocaleDateString()}</span>
                                    </div>
                                </TableCell>
                                <TableCell className="border p-4 ">
                                    <div className='flex items-center space-x-2'>
                                        <FaTruck className="text-bottomNavBarColor" />
                                        <span>{trip.truck}</span>
                                    </div>

                                </TableCell>
                                <TableCell className="border p-4">
                                    <div className='flex items-center space-x-2'>
                                        <FaRoute className="text-bottomNavBarColor" />
                                        <span>{trip.route.origin.split(',')[0]} -&gt; {trip.route.destination.split(',')[0]}</span>
                                    </div>

                                </TableCell>
                                <TableCell><span className='text-red-500 font-semibold'>{formatNumber(trip.truckHireCost)}</span></TableCell>
                                <TableCell className="border p-4">
                                    <div className="flex flex-col items-center space-x-2">
                                        <span>{statuses[trip.status as number]}</span>
                                        <div className="relative w-full bg-gray-200 h-1 rounded">
                                            <div className={`absolute top-0 left-0 h-1 rounded transition-width duration-500 ${trip.status === 0 ? 'bg-red-500' : trip.status === 1 ? 'bg-yellow-500' : trip.status === 2 ? 'bg-blue-500' : trip.status === 3 ? 'bg-green-500' : 'bg-green-800'}`} style={{ width: `${(trip.status as number / 4) * 100}%` }}></div>
                                        </div>
                                    </div>
                                </TableCell>
                                <TableCell><span className='font-semibold text-green-500'>{formatNumber(trip.amount)}</span></TableCell>
                                <TableCell><Link href={`/user/trips/${trip.trip_id}`}><Button variant='outline'>View Trip</Button></Link></TableCell>

                            </TableRow>
                        ))}
                    </TableBody>
                </Table>
            </div>
        </div>
    )
}

export default SupplierDetailPage
</file>

<file path="src/app/user/suppliers/[supplierId]/trucks/page.tsx">
'use client'
import TripCard from '@/components/TripCard';
import { Table, TableHeader, TableRow, TableHead, TableBody, TableCell } from '@/components/ui/table';
import { statuses } from '@/utils/schema';
import { truckTypesIcons } from '@/utils/utilArray';
import debounce from 'lodash.debounce';
import {useRouter} from 'next/navigation';
import { Input } from '@/components/ui/input';
import React, { useCallback, useMemo, useState } from 'react'
import { Button } from '@/components/ui/button';
import { FaSortUp, FaSortDown, FaSort } from 'react-icons/fa';
import Loading from '../../loading';
import { useSupplier } from '@/context/supplierContext';
import Link from 'next/link';

const SupplierTrucks = () => {
    const router = useRouter();
    const { supplier, setSupplier, loading } = useSupplier()
    const [sortConfig, setSortConfig] = useState<any>({ key: null, direction: 'asc' });
    const [searchQuery, setSearchQuery] = useState('');
    const debouncedSearch = useMemo(
        () => debounce((query: string) => setSearchQuery(query), 300),
        []
    );

    const handleSearch = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
        debouncedSearch(e.target.value.toLowerCase());
    }, [debouncedSearch]);

    const sortedTrucks = useMemo(() => {
        if (!supplier?.supplierTrucks || supplier?.supplierTrucks.length === 0) return [];

        let filteredTrucks = [...supplier?.supplierTrucks];

        if (searchQuery) {
            const lowercaseQuery = searchQuery.toLowerCase();
            filteredTrucks = filteredTrucks.filter((truck) =>
                Object.values(truck).some(value =>
                    typeof value === 'string' && value.toLowerCase().includes(lowercaseQuery)
                ) ||
                truck.latestTrip?.partyName?.toLowerCase().includes(lowercaseQuery) ||
                truck.latestTrip?.route?.origin.toLowerCase().includes(lowercaseQuery) ||
                truck.latestTrip?.route?.destination.toLowerCase().includes(lowercaseQuery) ||
                new Date(truck.latestTrip?.startDate).toLocaleDateString().includes(lowercaseQuery)
            );
        }

        if (sortConfig.key) {
            filteredTrucks.sort((a, b) => {
                if (a[sortConfig.key!] < b[sortConfig.key!]) {
                    return sortConfig.direction === 'asc' ? -1 : 1;
                }
                if (a[sortConfig.key!] > b[sortConfig.key!]) {
                    return sortConfig.direction === 'asc' ? 1 : -1;
                }
                return 0;
            });
        }

        return filteredTrucks;
    }, [sortConfig, searchQuery]);

    const requestSort = useCallback((key: any) => {
        setSortConfig((prevConfig: any) => ({
            key,
            direction: prevConfig.key === key && prevConfig.direction === 'asc' ? 'desc' : 'asc',
        }));
    }, []);

    const getSortIcon = useCallback((columnName: any) => {
        if (sortConfig.key === columnName) {
            return sortConfig.direction === 'asc' ? <FaSortUp /> : <FaSortDown />;
        }
        return <FaSort />;
    }, [sortConfig]);

    if (loading) return <Loading />;

    if (!supplier?.supplierTrucks || supplier?.supplierTrucks.length === 0) {
        return <div className="text-gray-500 text-center py-8">No trucks found</div>;
    }

    return (
        <div className="w-full h-full p-4">
            <div className="flex w-full px-60 mb-2">
                <Input
                    type="text"
                    placeholder="Search..."
                    onChange={handleSearch}
                    className="w-full"
                />
            </div>
            <Table>
                <TableHeader>
                    <TableRow>
                        <TableHead>Truck Number</TableHead>
                        <TableHead onClick={() => requestSort('truckType')} className="cursor-pointer">
                            <div className="flex justify-between items-center">
                                Truck Type {getSortIcon('truckType')}
                            </div>
                        </TableHead>
                        <TableHead onClick={() => requestSort('status')} className="cursor-pointer">
                            <div className="flex justify-between items-center">
                                Status {getSortIcon('status')}
                            </div>
                        </TableHead>
                        <TableHead>Latest Trip</TableHead>
                    </TableRow>
                </TableHeader>
                <TableBody>
                    {sortedTrucks.map((truck) => {
                        const Icon = truckTypesIcons.find(item => item.type === truck.truckType)?.Icon;
                        return (
                            <TableRow
                                key={truck.truckNo}
                                className="border-t hover:bg-gray-100 transition-colors duration-200 cursor-pointer"
                                onClick={() => router.push(`/user/trucks/${truck.truckNo}`)}
                            >
                                <TableCell className="text-gray-800 font-medium">
                                    <div className="flex flex-col space-y-2">
                                        {truck.truckNo}
                                        {truck.driverName && (
                                            <span className="text-gray-400 text-sm">
                                                Driver:
                                                <Button variant="link" asChild>
                                                    <Link
                                                        href={`/user/drivers/${truck.driver_id}`}
                                                        onClick={(e) => e.stopPropagation()}
                                                    >
                                                        {truck.driverName}
                                                    </Link>
                                                </Button>
                                            </span>
                                        )}
                                    </div>
                                </TableCell>
                                <TableCell>
                                    <div className="flex items-center space-x-2 justify-between">
                                        <span>{truck.truckType}</span>
                                        {Icon && <Icon className="inline-block ml-2 h-6 w-6 text-bottomNavBarColor" />}
                                    </div>
                                </TableCell>
                                <TableCell>
                                    <span
                                        className={`inline-block px-3 py-1 rounded-full text-sm font-semibold ${truck.status === 'Available' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                                            }`}
                                    >
                                        {truck.status}
                                    </span>
                                </TableCell>
                                <TableCell>
                                    {truck.latestTrip && Object.keys(truck.latestTrip).length > 0 ? (
                                        <TripCard
                                            key={truck.latestTrip.trip_id}
                                            tripId={truck.latestTrip.trip_id}
                                            route={truck.latestTrip.route}
                                            partyName={truck.latestTrip.partyName}
                                            status={truck.latestTrip.status}
                                            statuses={statuses}
                                            startDate={truck.latestTrip.startDate}
                                        />
                                    ) : (
                                        'NA'
                                    )}
                                </TableCell>
                            </TableRow>
                        );
                    })}
                </TableBody>
            </Table>
        </div>
    )
}

export default SupplierTrucks
</file>

<file path="src/app/user/suppliers/layout.tsx">
'use client'
import { Button } from "@/components/ui/button";
import { Inter } from "next/font/google";
import Link from 'next/link';
import { usePathname } from "next/navigation";

const inter = Inter({ subsets: ["latin"] });

const headings: any = {
  '/user/suppliers': 'Suppliers',
  '/user/suppliers/create': 'New Supplier'
}

const SuppliersLayout = ({ children }: { children: React.ReactNode }) => {
  const pathname = usePathname()
  return (
    <div className={`${inter.className} max-h-screen flex flex-col`}>
      <div className="container mx-auto p-2 flex flex-col bg-white">
        <div className="flex items-center justify-between mb-4 border-b-2 border-gray-300 pb-2">
          <h1 className="text-3xl font-bold text-black">{headings[pathname] || 'Supplier Details'}</h1>
          <div className="flex space-x-4">
            {!pathname.includes('create') &&
              <Link href="/user/suppliers/create">
                <Button >

                  Add Supplier

                </Button>
              </Link>
            }
          </div>
        </div>
        <div className="flex-grow">
          {children}
        </div>
      </div>
    </div>
  );
};

export default SuppliersLayout;
</file>

<file path="src/app/user/suppliers/loading.tsx">
import React from "react";

export default function Loading() {
  return (
    <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-10 z-50">
      
        <iframe 
          src="https://lottie.host/embed/3d45f054-61ac-4d4e-837c-2fa3006e28cc/MeZ8JDXVB5.json" 
        ></iframe>
    </div>
  );}
</file>

<file path="src/app/user/suppliers/page.tsx">
// PartiesPage.tsx
'use client'

import React, { useCallback, useEffect, useMemo, useState } from 'react';
import { ISupplier } from '@/utils/interface';
import Loading from './loading';
import { useRouter } from 'next/navigation';
import { FaUserTie, FaPhone, FaTruck, FaWallet, FaSort, FaSortDown, FaSortUp } from 'react-icons/fa';
import { formatNumber } from '@/utils/utilArray';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import debounce from 'lodash.debounce';
import { useExpenseData } from '@/components/hooks/useExpenseData';

const SuppliersPage = () => {

  const router = useRouter();
  const {suppliers, isLoading, refetchSuppliers} = useExpenseData()
  // const [suppliers, setSuppliers] = useState<ISupplier[] | any>([]);
  // const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [sortConfig, setSortConfig] = useState<any>({ key: null, direction: 'asc' });
  const [searchQuery, setSearchQuery] = useState(''); // Track the search query

  useEffect(() => {
    refetchSuppliers()
  }, [refetchSuppliers])

  // Fetch suppliers data
  // useEffect(() => {
  //   const fetchSuppliers = async () => {
  //     try {
  //       const res = await fetch('/api/suppliers', {
  //         method: 'GET',
  //         headers: { 'Content-Type': 'application/json' },
  //       });

  //       if (!res.ok) {
  //         throw new Error('Failed to fetch suppliers');
  //       }

  //       const data = await res.json();
  //       setSuppliers(data.suppliers);
  //     } catch (err) {
  //       setError((err as Error).message);
  //     } finally {
  //       setLoading(false);
  //     }
  //   };

  //   fetchSuppliers();
  // }, []);

  // Function to request sorting
  const requestSort = (key: any) => {
    let direction: 'asc' | 'desc' = 'asc';
    if (sortConfig.key === key && sortConfig.direction === 'asc') {
      direction = 'desc';
    }
    setSortConfig({ key, direction });
  };

  // Sort icon logic
  const getSortIcon = (columnName: any) => {
    if (sortConfig.key === columnName) {
      return sortConfig.direction === 'asc' ? <FaSortUp /> : <FaSortDown />;
    }
    return <FaSort />;
  };

  // Debounce the search input to reduce re-renders on each keystroke
  const debouncedSearch = useCallback(
    debounce((query) => setSearchQuery(query), 300),
    []
  );

  // Handle search input
  const handleSearch = (e: React.ChangeEvent<HTMLInputElement>) => {
    debouncedSearch(e.target.value.toLowerCase());
  };

  // Filter and sort suppliers based on search query and sort configuration
  const filteredAndSortedSuppliers = useMemo(() => {
    let filteredSuppliers = suppliers;

    // Filter based on search query
    if (searchQuery) {
      filteredSuppliers = suppliers.filter((supplier: any) =>
        supplier.name.toLowerCase().includes(searchQuery) ||
        supplier.contactNumber.toString().includes(searchQuery) ||
        supplier.tripCount.toString().includes(searchQuery) ||
        supplier.balance.toString().includes(searchQuery)
      );
    }

    // Sort the suppliers
    if (sortConfig.key !== null) {
      filteredSuppliers.sort((a: any, b: any) => {
        if (a[sortConfig.key] < b[sortConfig.key]) {
          return sortConfig.direction === 'asc' ? -1 : 1;
        }
        if (a[sortConfig.key] > b[sortConfig.key]) {
          return sortConfig.direction === 'asc' ? 1 : -1;
        }
        return 0;
      });
    }

    return filteredSuppliers;
  }, [suppliers, searchQuery, sortConfig]);


  // useEffect(() => {
  //   const fetchSuppliers = async () => {
  //     try {
  //       const res = await fetch('/api/suppliers', {
  //         method: 'GET',
  //         headers: {
  //           'Content-Type': 'application/json',
  //         },
  //       });

  //       if (!res.ok) {
  //         throw new Error('Failed to fetch suppliers');
  //       }

  //       const data = await res.json();
  //       setSuppliers(data.suppliers);
  //     } catch (err) {
  //       setError((err as Error).message);
  //     } finally {
  //       setTimeout(() => {
  //         setLoading(false);
  //       }, 1000);
  //     }
  //   };

  //   fetchSuppliers();
  // }, []);

  if (isLoading) {
    return <Loading />;
  }

  if (error) {
    return (
      <div className="flex justify-center items-center h-full">
        <div className="text-red-500">{error}</div>
      </div>
    );
  }

  if (!suppliers || suppliers.length === 0) {
    return (
      <div className="flex justify-center items-center h-full">
        <div className="text-gray-500">No Suppliers found</div>
      </div>
    );
  }

  return (
    <div className="w-full h-full p-4">
      <input
        type="text"
        placeholder="Search"
        onChange={handleSearch}
      />
      <div className="mt-2">
        <Table className="">
          <TableHeader>
            <TableRow className="">
              <TableHead onClick={() => requestSort('name')}>
                <div className='flex justify-between'>
                  Supplier Name {getSortIcon('name')}
                </div>

              </TableHead>
              <TableHead>
                <div className='flex justify-between'>
                  Contact
                </div>
              </TableHead>
              <TableHead onClick={() => requestSort('tripCount')}>
                <div className='flex justify-between'>
                  Active Trips {getSortIcon('tripCount')}
                </div>
              </TableHead>
              <TableHead onClick={() => requestSort('balance')}>
                <div className='flex justify-between'>
                  Supplier Balance {getSortIcon('balance')}
                </div>
              </TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {filteredAndSortedSuppliers?.map((supplier: any, index) => (
              <TableRow
                index = {index + 1}
                key={supplier.supplier_id as string}
                onClick={() => router.push(`suppliers/${supplier.supplier_id}/trips`)}
              >
                <TableCell >
                  <div className="flex items-center space-x-2">
                    <FaUserTie className="text-bottomNavBarColor" />
                    <span>{supplier.name}</span>
                  </div>
                </TableCell>
                <TableCell >
                  <div className="flex items-center space-x-2">
                    <FaPhone className="text-green-500" />
                    <span>{supplier.contactNumber}</span>
                  </div>
                </TableCell>
                <TableCell >
                  <div className="flex items-center space-x-2">
                    <FaTruck className="text-bottomNavBarColor" />
                    <span>{supplier.tripCount}</span>
                  </div>
                </TableCell>
                <TableCell >
                  <div className="flex items-center space-x-2">
                    <FaWallet className="text-bottomNavBarColor" />
                    <span className={`${supplier.balance > 0 ? 'text-green-500' : 'text-red-500'} font-semibold`}>{formatNumber(supplier.balance)}</span>
                  </div>
                </TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </div>
    </div>
  );
};

export default SuppliersPage;
</file>

<file path="src/app/user/trips/[tripId]/documents/page.tsx">
'use client'
import React, { useEffect, useState } from 'react';

import { motion } from 'framer-motion';
import { useParams, useSearchParams } from 'next/navigation';
import RecentDocuments from '@/components/documents/RecentDocuments';
import { useTrip } from '@/context/tripContext';
import { Button } from '@/components/ui/button';
import TripDocumentUpload from '@/components/documents/TripDocumentUpload';
import { CloudUpload, Frown } from 'lucide-react';

const Page = () => {
  const {tripId} = useParams()
  const [isOpen, setIsOpen] = useState(false)
  const {trip, setTrip, loading} = useTrip()

  if(!trip){
    return <div className='flex items-center justify-center space-x-2'><Frown className='text-bottomNavBarColor' /> Trip Not Found</div>
  }

  return (
    <div className='mx-auto p-4'>
      <div className='flex justify-end my-2 fixed right-4 bottom-4'>
      <Button onClick={()=>setIsOpen(true)} className='rounded-full h-full py-2'><CloudUpload size={40}/></Button>
      </div>

      <RecentDocuments docs={trip?.documents || []} />
      
          <TripDocumentUpload open={isOpen} setOpen={setIsOpen} tripId={tripId as string} setTrip={setTrip}/>
        
    </div>
  );
};

export default Page;
</file>

<file path="src/app/user/trips/[tripId]/layout.tsx">
'use client'
import { TripProvider } from '@/context/tripContext';
import { motion } from 'framer-motion';
import Link from 'next/link';
import { useParams, usePathname } from 'next/navigation';
import React from 'react'

interface props {
    children: React.ReactNode
}

const Layout = ({ children }: { children: React.ReactNode }) => {
    const { tripId } = useParams()
    const pathname = usePathname()
    const tabs = [
        { name: 'Summary', path: `/user/trips/${tripId}` },
        { name: 'Documents', path: `/user/trips/${tripId}/documents` }
    ]
    return (
        <div>
            <TripProvider tripId={tripId as string} >
                <div className="flex items-center justify-around " style={{ scrollbarWidth: 'thin' }}>
                    {tabs.map((tab) => (
                        <Link
                            key={tab.name}
                            href={tab.path}
                            prefetch={true}
                        >
                            <motion.div
                                whileHover={{ scale: 1.05 }}
                                whileTap={{ scale: 0.95 }}
                                className={`px-4 py-2 transition duration-300 ease-in-out font-semibold rounded-md text-black hover:bg-hoverColor cursor-pointer ${pathname === tab.path
                                    ? 'border-b-2 border-[#3190F5] rounded-b-none bg-hoverColor'
                                    : 'border-transparent'
                                    }`}
                            >
                                <div className="flex items-center space-x-2">
                                    <span>{tab.name}</span>
                                </div>
                            </motion.div>

                        </Link>
                    ))}
                </div>
                {children}
            </TripProvider>
        </div>
    )
}

export default Layout;
</file>

<file path="src/app/user/trips/[tripId]/page.tsx">
'use client';

import React, { useState, useCallback } from 'react';
import dynamic from 'next/dynamic';
import { ITrip } from '@/utils/interface';
import { useParams, useRouter } from 'next/navigation';
import { MdEdit, MdDelete } from 'react-icons/md';
import { Button } from '@/components/ui/button';
import Loading from '../loading';
import { useTrip } from '@/context/tripContext';
import { Frown, Loader2, X } from 'lucide-react';
import TripDetails from '@/components/trip/tripDetail/TripDetail';
import { AnimatePresence, motion } from 'framer-motion';

// Dynamically import components
const EditTripForm = dynamic(() => import('@/components/trip/EditTripForm'), {
  ssr: false,
});


const TripPage: React.FC = () => {
  const { trip, setTrip, loading } = useTrip();
  const router = useRouter();
  const { tripId } = useParams();
  const [isEditing, setIsEditing] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [docModalOpen, setDocModalOpen] = useState(false)
  const [error, setError] = useState('')
  const [deleteModal, setDeleteModal] = useState(false)

  const TripDocumentUpload = dynamic(() => import('@/components/documents/TripDocumentUpload'), { ssr: false })

  const handleEdit = useCallback(async (data: Partial<ITrip>) => {
    setIsSubmitting(true);
    try {
      const res = await fetch(`/api/trips/${tripId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ data })
      });


      const newData = await res.json();
      if (newData.status === 400) {
        alert(newData.message);
        setIsSubmitting(false);
        return;
      }
      setTrip((prev: ITrip | any) => ({
        ...prev,
        ...newData.trip,
        balance: newData.trip.amount - (prev.amount - prev.balance)
      }));
      setIsEditing(false); // Close editing mode after successful edit

    } catch (error) {
      console.error('Error editing trip:', error);
    } finally {
      setIsSubmitting(false);
      setIsEditing(false);
    }
  }, [trip, tripId, router, setTrip]);

  const handleCancelEdit = () => {
    setIsEditing(false);
  };

  const handleDelete = useCallback(async () => {
    try {
      const res = await fetch(`/api/trips/${tripId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
      });
      if (!res.ok) throw new Error('Failed to delete trip');
      router.push('/user/trips'); // Redirect to trips list after deletion
    } catch (error) {
      console.error('Error deleting trip:', error);
    }
  }, [tripId, router]);

  if (loading) {
    return <Loading />;
  }

  if (!trip) {
    return <div className='flex items-center justify-center space-x-2'><Frown className='text-bottomNavBarColor' /> Trip Not Found</div>
  }

  if (error) {
    return <div>Error: {error}</div>;
  }

  return (
    <div className="mx-auto p-4">

      {
        isSubmitting &&
        <div className=''>
          <Loading /> {/* Ensure Loading component shows the GIF */}
        </div>
      }

      <div className='flex items-center justify-between'>
        <Button onClick={() => setDocModalOpen(true)}>
          Upload Document
        </Button>
        <div className="flex justify-end space-x-4 mb-4">
          <Button
            variant="outline"
            onClick={() => {
              setIsEditing(true);
            }}
            className="transition-all duration-300 ease-in-out transform hover:scale-105"
          >
            <MdEdit className="mr-2" /> Edit
          </Button>
          <Button
            variant="destructive"
            onClick={()=>setDeleteModal(true)}
            className="transition-all duration-300 ease-in-out transform hover:scale-105"
          >
            <MdDelete className="mr-2" /> Delete
          </Button>
        </div>
      </div>



      <EditTripForm
        isOpen={isEditing}
        onClose={handleCancelEdit}
        trip={trip as ITrip}
        onSubmit={handleEdit}
      />
      <TripDetails />
      {docModalOpen && (
        <div className="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50">
          <TripDocumentUpload open={docModalOpen} setOpen={setDocModalOpen} tripId={tripId as string} />
        </div>
      )}
      {deleteModal &&
        <AnimatePresence>
          <motion.div
            className="modal-class"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
          >
            <motion.div
              className="bg-white rounded-lg shadow-xl p-4 w-full max-w-sm mx-4"
              initial={{ scale: 0.9, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.9, opacity: 0 }}
              transition={{ type: 'spring', damping: 15, stiffness: 300 }}
            >
              <div className="flex justify-between items-center mb-3">
                <h3 className="text-lg font-semibold">Confirm Delete</h3>
                <Button variant="ghost" size="sm" onClick={() => setDeleteModal(false)} className='px-2 py-0'>
                  <X className="h-4 w-4" />
                  <span className="sr-only">Close</span>
                </Button>
              </div>
              <p className="text-gray-600 mb-6">Are you sure you want to Delete?</p>
              <div className="flex justify-end space-x-4">
                <Button variant="outline" onClick={() => setDeleteModal(false)}>
                  Cancel
                </Button>
                <Button onClick={handleDelete}>
                  Delete
                </Button>
              </div>
            </motion.div>
          </motion.div>
        </AnimatePresence>
      }
    </div>
  );
};

export default TripPage;
</file>

<file path="src/app/user/trips/create/page.tsx">
'use client'
import React, { useEffect, useState } from 'react';
import TripForm from '@/components/trip/TripForm';
import { useRouter, useSearchParams } from 'next/navigation';
import Loading from '../loading'; // Ensure the Loading component shows a GIF
import { useToast } from '@/components/hooks/use-toast';
import { useExpenseData } from '@/components/hooks/useExpenseData';

const CreateTripPage: React.FC = () => {
  const router = useRouter();

  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false); // New state for saving overlay
  const [error, setError] = useState<string | null>(null);
  const [latestLR, setLatestLR] = useState<string>(''); // State to hold the latest LR
  const data = useSearchParams()
  const duplicate = data.get('trip')
  const { toast } = useToast()
  const { trips,refetchTrucks, refetchParties, refetchDrivers } = useExpenseData()

  useEffect(() => {
    const fetchData = async () => {
      await Promise.allSettled([
        refetchTrucks(),
        refetchParties(),
        refetchDrivers(),
      ]).then(results => {
        results.forEach((result, index) => {
          if (result.status === 'rejected') {
            console.error(`Error in refetch ${index + 1}:`, result.reason);
          }
        });
      });
    };

    fetchData();
  }, []);

  useEffect(() => {
    const fetchData = async () => {
      try {
        // Fetch parties, trucks, drivers

        // Find the latest trip's LR
        if (trips && trips.length > 0) {
          const latestTrip = trips[0]; // Assuming the API returns trips sorted by date descending
          let lrString = latestTrip?.LR;
          if (lrString) {
            let num = parseInt(lrString.match(/\d+/)?.[0] || "0") + 1;
            const LR = `LRN ${typeof num === 'number' ? num : '001'}`;
            setLatestLR(LR); // Assuming 'LR' is the field containing LR in the trip object
          } else {
            setLatestLR('LRN 001');
          }
        } else {
          setLatestLR('LRN 001'); // No trips found
        }
      } catch (err) {
        setError((err as Error).message);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, []);

  const handleTripSubmit = async (trip: any) => {
    setSaving(true); // Show loading overlay

    try {
      // Create a new FormData object
      const formData = new FormData();

      // Append all trip data to the formData object
      formData.append('party', trip.party);
      formData.append('truck', trip.truck);
      formData.append('driver', trip.driver);
      formData.append('supplierId', trip.supplierId);
      formData.append('origin', trip.route.origin);
      formData.append('destination', trip.route.destination);
      formData.append('billingType', trip.billingType);
      formData.append('amount', trip.amount.toString());
      formData.append('startDate', trip.startDate);
      formData.append('truckHireCost', trip.truckHireCost.toString());
      formData.append('LR', trip.LR);
      formData.append('material', JSON.stringify(trip.material));
      formData.append('notes', trip.notes);
      formData.append('fmNo',trip.fmNo)
      if(trip.loadingSlipDetails) formData.append('loadingSlipDetails', JSON.stringify(trip.loadingSlipDetails));
      if (trip.billingType !== 'Fixed' && !trip.totalUnits && !trip.perUnit) {
        alert('Units and Rate is Required')
      }
      if (trip.billingType !== 'Fixed' && trip.totalUnits && trip.perUnit) {
        formData.append('units', trip.totalUnits)
        formData.append('rate', trip.perUnit)
      }

      // Append the file to formData if it exists
      if (trip.file) {
        formData.append('file', trip.file);
      }

      // Append the EWB validity date if it exists
      if (trip.ewbValidity) {
        formData.append('ewbValidity', trip.ewbValidity);
      }

      // Make the request to create the trip
      const tripRes = await fetch('/api/trips', {
        method: 'POST',
        body: formData, // Send formData as the body
      });

      if (!tripRes.ok) {
        throw new Error('Failed to create trip');
      }

      // Update supplier truck hire cost if needed
      if (trip.supplierId) {
        const supplierRes = await fetch(`/api/suppliers/${trip.supplierId}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ truckHireCost: trip.truckHireCost }), // Assuming truckHireCost is a field in trip
        });

        if (!supplierRes.ok) {
          throw new Error('Failed to update supplier');
        }
      }

      const data = await tripRes.json();
      toast({
        description: 'Trip saved successfully',
      })
      setTimeout(() => {
        router.push('/user/trips');
      }, 500);
    } catch (error: any) {
      toast({
        description: error.message,
        variant: 'destructive'
      })
    } finally {

      setSaving(false); // Hide loading overlay
    }
  };


  if (loading) return <Loading />;
  if (error) return <div>Error: {error}</div>;

  return (
    <>
      {saving && (
        <div className=''>
          <Loading /> {/* Ensure Loading component shows the GIF */}
        </div>
      )}
      <div className="w-full h-full relative">

        <TripForm onSubmit={handleTripSubmit} lr={latestLR} duplicate={duplicate ? JSON.parse(duplicate) : {}} />
      </div>
    </>

  );
};

export default CreateTripPage;
</file>

<file path="src/app/user/trips/layout.tsx">
'use client'
import { Button } from "@/components/ui/button";
import { Inter } from "next/font/google";
import Link from 'next/link';
import { useParams, usePathname } from "next/navigation";

const inter = Inter({ subsets: ["latin"] });



const TripsLayout = ({ children }: { children: React.ReactNode }) => {
  const {tripId} = useParams()
  const pathname = usePathname()
 

  const headings: any = {
    '/user/trips': 'Trips',
    '/user/trips/create': 'Create New Trip',
    [`/user/trips/${tripId}`] : 'Trip Details',
    [`/user/trips/${tripId}/documents`] : 'Trip Documents',
    '/user/trips/invoice' : 'Invoice Generation'
  }

  return (
    <div className={`${inter.className} max-h-screen flex flex-col`}>
      <div className="container mx-auto p-2 flex flex-col bg-white">
        <div className="flex items-center justify-between mb-4 border-b-2 border-gray-300 pb-2">
          <h1 className="text-3xl font-bold text-black">{headings[pathname]}</h1>
          <div className="flex space-x-4">
            {!pathname.includes('create') &&
              <Link href="/user/trips/create">
                <Button>

                  Add Trip
                </Button>
              </Link>

            }

          </div>
        </div>
        <div className="flex-grow overflow-y-auto">
          {children}
        </div>
      </div>
    </div>
  );
};

export default TripsLayout;
</file>

<file path="src/app/user/trips/loading.tsx">
export default function Loading() {
  return (
    <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-10 z-50">
      
        <iframe 
          src="https://lottie.host/embed/3d45f054-61ac-4d4e-837c-2fa3006e28cc/MeZ8JDXVB5.json" 
        ></iframe>
    </div>
  );}
</file>

<file path="src/app/user/trucks/[truckNo]/documents/page.tsx">
'use client'
import { Button } from '@/components/ui/button'
import { useParams } from 'next/navigation'
import React, { useEffect, useState } from 'react'
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog'
import Link from 'next/link'
import { useTruck } from '@/context/truckContext'
import RecentDocuments from '@/components/documents/RecentDocuments'
import { loadingIndicator } from '@/components/ui/LoadingIndicator'
import TruckDocumentUpload from '@/components/documents/TruckDocumentUpload'
import { CloudUpload } from 'lucide-react'

const documentTypes = ["RC", "Insurance", "Permit", "Pollution Certificate"]

const TruckDocuments = () => {
  const { truck, setTruck, loading } = useTruck()
  const [isModalOpen, setIsModalOpen] = useState(false)

  if (loading) {
    return <div>{loadingIndicator}</div>
  }


  return (
    <div className="container mx-auto px-4">
      <div className="mb-2 flex items-center justify-between">
        <h1 className="text-2xl font-semibold text-gray-800">Truck Documents</h1>
        <Button onClick={() => setIsModalOpen(true)} className='rounded-full h-full py-2'><CloudUpload size={30} />
        </Button>
      </div>

      <RecentDocuments docs={truck?.documents} />


      <TruckDocumentUpload truckNo={truck?.truckNo} open={isModalOpen} setOpen={setIsModalOpen} setTruck={setTruck} />

    </div>
  )
}

export default TruckDocuments
</file>

<file path="src/app/user/trucks/[truckNo]/driverExpense/page.tsx">
'use client';
import React, { useEffect, useState, useCallback, useMemo } from 'react';
import dynamic from 'next/dynamic';
import Loading from '../loading';
import { Button } from '@/components/ui/button';
import { IExpense } from '@/utils/interface';
import { useParams } from 'next/navigation';
import { MdDelete, MdEdit, MdLocalGasStation, MdPayment } from 'react-icons/md';
import { DeleteExpense, handleAddCharge, handleAddExpense, handleDelete, handleEditExpense } from '@/helpers/ExpenseOperation';
import { fetchDriverName } from '@/helpers/driverOperations';
import TripRoute from '@/components/trip/TripRoute';
import DriverName from '@/components/driver/DriverName';
import { FaCalendarAlt } from 'react-icons/fa';
import { IconKey, icons } from '@/utils/icons';
import { formatNumber } from '@/utils/utilArray';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';

// Dynamically import ExpenseModal to split the code


const OtherExpense = () => {
  const { truckNo } = useParams();
  const [error, setError] = useState<any>();
  const [loading, setLoading] = useState<boolean>(true);
  const [otherExpenses, setOtherExpenses] = useState<IExpense[] | any[]>([]);
  const [modelOpen, setModelOpen] = useState(false);
  const [selected, setSelected] = useState<IExpense | null>(null);

  const AddExpenseModal = dynamic(() => import('@/components/AddExpenseModal'), {
    loading: () => <Loading />,
  });

  const fetchOther = async () => {
    setLoading(true);
    try {
      const res = await fetch(`/api/trucks/${truckNo}/expense?type=other`);
      if (!res.ok) {
        throw new Error('Failed to fetch other expenses');
      }
      const data = await res.json();
      setOtherExpenses(data.expenses);
    } catch (error: any) {
      console.error(error);
      alert(error.message);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchOther();
  }, [truckNo]);

  const handleDelete = async (id: string, e: React.FormEvent) => {
    e.stopPropagation();
    try {
      const expense = await DeleteExpense(id)
      setOtherExpenses(otherExpenses.filter((item) => item._id !== id));
    } catch (error: any) {
      alert('Failed to delete expense')
      console.log(error)
    }
  };

  const handleAddCharge = async (newCharge: any, id?: string) => {
    try {
      if (!selected) {
        const expense = await handleAddExpense(newCharge)
        setOtherExpenses((prev) => [
          expense,
          ...prev
        ])
      } else {
        const expense = await handleEditExpense(newCharge, selected._id as string)
        setOtherExpenses((prev) => prev.map((item: any) => item._id === selected._id ? { ...item, ...expense } : item))
      }
    } catch (error: any) {
      console.log(error);
      alert(`Failed to ${selected ? 'edit' : 'add'} expense`)
    }
  };

  const renderedExpenses = useMemo(() => (
    otherExpenses.map((expense, index) => (
      <TableRow
        key={index}
        className="border-t hover:bg-slate-100"
      >
        <TableCell>
          <div className='flex items-center space-x-2'>
            <FaCalendarAlt className='text-bottomNavBarColor' />
            <span>{new Date(expense.date).toLocaleDateString()}</span>
          </div>
        </TableCell>

        <TableCell className="border p-4">{formatNumber(expense.amount)}</TableCell>
        <TableCell className="border p-4">
          <div className="flex items-center space-x-2">
            {icons[expense.expenseType as IconKey]}
            <span>{expense.expenseType}</span>
          </div>
        </TableCell>
        <TableCell className="border p-4">
          <div className="flex items-center space-x-2">
            <MdPayment className="text-green-500" />
            <span>{expense.paymentMode}</span>
          </div>
        </TableCell>
        <TableCell className="border p-4">{expense.notes || ''}</TableCell>
        <TableCell className="border p-4">{expense.driverName}</TableCell>
              <TableCell className="border p-4"><span>{expense.trip_id ? <span>{expense.tripRoute?.origin.split(',')[0]} &rarr; {expense.tripRoute?.destination.split(',')[0]}</span> : "NA"}</span></TableCell>
        <TableCell>
          <div className='flex items-center space-x-2'>
            <Button variant="outline" onClick={() => { setSelected(expense); setModelOpen(true); }}>
              <MdEdit />
            </Button>
            <Button variant="destructive" onClick={(e) => handleDelete(expense._id as string, e)}>
              <MdDelete />
            </Button>
          </div>

        </TableCell>
      </TableRow>
    ))
  ), [otherExpenses, handleDelete]);

  if (loading) return <Loading />;

  return (
    <div className="w-full h-full p-4">
      <div className="table-container">
        <Table className="custom-table">
          <TableHeader>
            <TableRow>
              <TableHead>Date</TableHead>
              <TableHead>Amount</TableHead>
              <TableHead>Expense Type</TableHead>
              <TableHead>Payment Mode</TableHead>
              <TableHead>Notes</TableHead>
              <TableHead>Driver</TableHead>
              <TableHead>Trip</TableHead>
              <TableHead>Action</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {renderedExpenses}
          </TableBody>
        </Table>
      </div>
      {modelOpen && (
        <AddExpenseModal
          isOpen={modelOpen}
          onClose={() => {
            setModelOpen(false);
            setSelected(null);
        }}
          onSave={handleAddCharge}
          driverId={selected?.driver || ''}
          selected={selected} categories={['Truck Expense', 'Trip Expense', 'Office Expense']} />
      )}
    </div>
  );
};

export default React.memo(OtherExpense);
</file>

<file path="src/app/user/trucks/[truckNo]/fuel/page.tsx">
'use client'
import React, { useCallback, useEffect, useState } from 'react';
import { useParams } from 'next/navigation';
import { FaCalendarAlt } from 'react-icons/fa';
import { MdDelete, MdEdit, MdPayment } from 'react-icons/md';
import DriverName from '@/components/driver/DriverName';
import TripRoute from '@/components/trip/TripRoute';
import { Button } from '@/components/ui/button';
import Loading from '../loading';
import { IExpense } from '@/utils/interface';
import { formatNumber } from '@/utils/utilArray';
import dynamic from 'next/dynamic';
import { DeleteExpense, handleAddExpense, handleEditExpense } from '@/helpers/ExpenseOperation';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';

interface TripDetails {
  [key: string]: string;
}

const TruckFuelBook: React.FC = () => {
  const { truckNo } = useParams();
  const [fuelBook, setFuelBook] = useState<IExpense[] | any[]>([]);
  const [loading, setLoading] = useState(true);
  const [tripDetails, setTripDetails] = useState<TripDetails>({});
  const [modelOpen, setModelOpen] = useState(false);
  const [selected, setSelected] = useState<IExpense | null>(null);

  const AddExpenseModal = dynamic(() => import('@/components/AddExpenseModal'), { ssr: false })

  const fetchFuel = useCallback(async () => {
    setLoading(true);
    try {
      const res = await fetch(`/api/trucks/${truckNo}/expense?type=fuel`);
      if (!res.ok) throw new Error('Failed to fetch fuel book');
      const data = await res.json();
      setFuelBook(data.expenses);
    } catch (error: any) {
      console.error(error);
      alert(error.message);
    } finally {
      setLoading(false);
    }
  }, [truckNo]);

  useEffect(() => {
    fetchFuel();
  }, [fetchFuel]);

  const handleDelete = async (id: string, e: React.FormEvent) => {
    e.stopPropagation();
    try {
      const expense = await DeleteExpense(id)
      setFuelBook(fuelBook.filter((item) => item._id !== id));
    } catch (error: any) {
      alert('Failed to delete expense')
      console.log(error)
    }
  };

  const handleAddCharge = async (newCharge: any, id?: string) => {
    try {
      if (!selected) {
        const expense = await handleAddExpense(newCharge)
        setFuelBook((prev) => [
          expense,
          ...prev
        ])
      } else {
        const expense = await handleEditExpense(newCharge, selected._id as string)
        setFuelBook((prev) => prev.map((item: any) => item._id === selected._id ? { ...item, expense } : item))
      }
    } catch (error: any) {
      console.log(error);
      alert(`Failed to ${selected ? 'edit' : 'add'} expense`)
    }
  };

  if (loading) return <Loading />;

  return (
    <div className="w-full h-full p-4">
      <div className="table-container">
      <Table >
          <TableHeader>
            <TableRow>
              <TableHead>Date</TableHead>
              <TableHead>Amount</TableHead>
              <TableHead>Payment Mode</TableHead>
              <TableHead>Notes</TableHead>
              <TableHead>Driver</TableHead>
              <TableHead>Trip</TableHead>
              <TableHead>Action</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {fuelBook?.map((expense, index) => (
              <TableRow
              key={index}
              className="border-t hover:bg-slate-100"
            >
              <TableCell>
                <div className='flex items-center space-x-2'>
                  <FaCalendarAlt className='text-bottomNavBarColor' />
                  <span>{new Date(expense.date).toLocaleDateString()}</span>
                </div>
              </TableCell>

              <TableCell className="border p-4">{formatNumber(expense.amount)}</TableCell>
              <TableCell className="border p-4">
                <div className="flex items-center space-x-2">
                  <MdPayment className="text-green-500" />
                  <span>{expense.paymentMode}</span>
                </div>
              </TableCell>
              <TableCell className="border p-4">{expense.notes || ''}</TableCell>
              <TableCell className="border p-4">{expense.driverName}</TableCell>
              <TableCell className="border p-4"><span>{expense.trip_id ? <span>{expense.tripRoute?.origin.split(',')[0]} &rarr; {expense.tripRoute?.destination.split(',')[0]}</span> : "NA"}</span></TableCell>
              <TableCell>
                <div className='flex items-center space-x-2'>
                  <Button variant="outline" onClick={() => { setSelected(expense); setModelOpen(true); }}>
                    <MdEdit />
                  </Button>
                  <Button variant="destructive" onClick={(e) => handleDelete(expense._id as string, e)}>
                    <MdDelete />
                  </Button>
                </div>

              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
      </div>
      <AddExpenseModal
        isOpen={modelOpen}
        onClose={() => {
          setModelOpen(false);
          setSelected(null);
      }}
        onSave={handleAddCharge}
        driverId={selected?.driver || ''}
        selected={selected} categories={['Truck Expense', 'Trip Expense', 'Office Expense']}      />
    </div>
  );
};

export default React.memo(TruckFuelBook);
</file>

<file path="src/app/user/trucks/[truckNo]/layout.tsx">
'use client';

import React, { useEffect, useState } from 'react';
import { useParams } from 'next/navigation';
import Loading from '../loading';
import TruckLayout from '@/components/layout/TruckLayout';
import { TruckProvider } from '@/context/truckContext';

interface PartyLayoutProps {
  children: React.ReactNode;
}

const Layout: React.FC<PartyLayoutProps> = ({ children }) => {
  const {truckNo} = useParams();

  useEffect(() => {
    if (!truckNo) return;

    const fetchPartyName = async () => {
      try {
        const res = await fetch(`/api/trucks/${truckNo}`);
        if (!res.ok) {
          throw new Error('Failed to fetch party name');
        }
        const data = await res.json();
      } catch (err: any) {
        console.error(err);
      }
    };

    fetchPartyName();
  }, [truckNo]);

  if (!truckNo) {
    return <Loading />
  }

  return (
    <TruckProvider truckNo={truckNo as string}>
    <TruckLayout>
      {children}
    </TruckLayout>
    </TruckProvider>
  );
};

export default Layout;
</file>

<file path="src/app/user/trucks/[truckNo]/loading.tsx">
import React from "react";

export default function Loading() {
  return (
    <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-5 z-50">
      
        <iframe 
          src="https://lottie.host/embed/3d45f054-61ac-4d4e-837c-2fa3006e28cc/MeZ8JDXVB5.json" 
        ></iframe>
    </div>
  );}
</file>

<file path="src/app/user/trucks/[truckNo]/maintainence/page.tsx">
'use client';
import React, { useEffect, useState } from 'react';
import { useParams } from 'next/navigation';
import Loading from '../loading';
import { IExpense } from '@/utils/interface';
import TripRoute from '@/components/trip/TripRoute';
import { Button } from '@/components/ui/button';
import { MdDelete, MdEdit, MdPayment } from 'react-icons/md';
import DriverName from '@/components/driver/DriverName';
import { FaCalendarAlt } from 'react-icons/fa';
import { IconKey, icons } from '@/utils/icons';
import { formatNumber } from '@/utils/utilArray';
import dynamic from 'next/dynamic';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { DeleteExpense, handleAddExpense, handleEditExpense } from '@/helpers/ExpenseOperation';
import { Item } from '@radix-ui/react-select';

const TruckMaintainenceBook = () => {
  const { truckNo } = useParams();
  const [loading, setLoading] = useState<boolean>(true);
  const [maintainenceBook, setMaintainenceBook] = useState<IExpense[] | any[]>([]);
  const [modelOpen, setModelOpen] = useState(false);
  const [selected, setSelected] = useState<IExpense | null>();
  const [error, setError] = useState<string | null>(null);

  const AddExpenseModal = dynamic(()=>import('@/components/AddExpenseModal'),{ssr : false})

  useEffect(() => {
    const fetchMaintenance = async () => {
      setLoading(true);
      try {
        const res = await fetch(`/api/trucks/${truckNo}/expense?type=maintenance`);
        if (!res.ok) {
          throw new Error('Failed to fetch maintenance book');
        }
        const data = await res.json();
        setMaintainenceBook(data.expenses);
      } catch (error: any) {
        setError(error.message);
      } finally {
        setLoading(false);
      }
    };
    fetchMaintenance();
  }, [truckNo]);

  const handleDelete = async (id: string, e: React.FormEvent) => {
    e.stopPropagation();
    try {
      const expense = await DeleteExpense(id)
      setMaintainenceBook(maintainenceBook.filter((item) => item._id !== id));
    } catch (error: any) {
      alert('Failed to delete expense')
      console.log(error)
    }
  };

  const handleAddCharge = async (newCharge: any, id?: string) => {
    try {
      if(!selected){
        const expense = await handleAddExpense(newCharge)
        setMaintainenceBook((prev)=>[
          expense,
          ...prev
        ])
      }else{
        const expense = await handleEditExpense(newCharge, selected._id as string)
        setMaintainenceBook((prev)=>prev.map((item : any)=> item._id === selected._id ? {...item,expense} : item))
      }
    } catch (error: any) {
      console.log(error);
      alert(`Failed to ${selected ? 'edit' : 'add'} expense`)
    }
  };

  if (loading) return <Loading />;

  return (
    <div className="w-full h-full p-4">
      {error && <div className="text-red-500">{error}</div>}
      <div className="table-container">
        <Table className="custom-table">
          <TableHeader>
            <TableRow>
              <TableHead>Date</TableHead>
              <TableHead>Amount</TableHead>
              <TableHead>Expense Type</TableHead>
              <TableHead>Payment Mode</TableHead>
              <TableHead>Notes</TableHead>
              <TableHead>Driver</TableHead>
              <TableHead>Trip</TableHead>
              <TableHead>Action</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {maintainenceBook.map((expense, index) => (
              <TableRow
                key={index}
                className="border-t hover:bg-slate-100"
              >
                <TableCell>
                  <div className='flex items-center space-x-2'>
                    <FaCalendarAlt className='text-bottomNavBarColor' />
                    <span>{new Date(expense.date).toLocaleDateString()}</span>
                  </div>
                </TableCell>

                <TableCell className="border p-4">{formatNumber(expense.amount)}</TableCell>
                <TableCell className="border p-4">
                  <div className="flex items-center space-x-2">
                    {icons[expense.expenseType as IconKey]}
                    <span>{expense.expenseType}</span>
                  </div>
                </TableCell>
                <TableCell className="border p-4">
                  <div className="flex items-center space-x-2">
                    <MdPayment className="text-green-500" />
                    <span>{expense.paymentMode}</span>
                  </div>
                </TableCell>
                <TableCell className="border p-4">{expense.notes || ''}</TableCell>
                <TableCell className="border p-4">{expense.driverName}</TableCell>
              <TableCell className="border p-4"><span>{expense.trip_id ? <span>{expense.tripRoute?.origin.split(',')[0]} &rarr; {expense.tripRoute?.destination.split(',')[0]}</span> : "NA"}</span></TableCell>
                <TableCell>
                  <div className='flex items-center space-x-2'>
                    <Button variant="outline" onClick={() => { setSelected(expense); setModelOpen(true); }}>
                      <MdEdit />
                    </Button>
                    <Button variant="destructive" onClick={(e) => handleDelete(expense._id as string, e)}>
                      <MdDelete />
                    </Button>
                  </div>

                </TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </div>
      <AddExpenseModal
        isOpen={modelOpen}
        onClose={() => {
          setModelOpen(false);
          setSelected(null);
      }}
        onSave={handleAddCharge}
        driverId={selected?.driver || ''}
        selected={selected} categories={['Truck Expense', 'Trip Expense', 'Office Expense']}      />
    </div>
  );
};

export default React.memo(TruckMaintainenceBook);
</file>

<file path="src/app/user/trucks/[truckNo]/page.tsx">
'use client';
import React, { useEffect, useState,  } from 'react';
import { IExpense, } from '@/utils/interface';
import { useParams, useRouter } from 'next/navigation';
import { statuses } from '@/utils/schema';
import dynamic from 'next/dynamic';
import { Button } from '@/components/ui/button';
import { MdDelete, MdEdit } from 'react-icons/md';
import Link from 'next/link';
import { FaCalendarAlt, } from 'react-icons/fa';
import { formatNumber } from '@/utils/utilArray';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { DeleteExpense, handleAddExpense, handleEditExpense } from '@/helpers/ExpenseOperation';
import { useTruck } from '@/context/truckContext';
import TripCard from '@/components/TripCard';
const Loading = dynamic(() => import('./loading'), {
  ssr: false,
  loading: () => <div>Loading...</div>,
});



const TruckPage = () => {
  const { truck, setTruck, loading } = useTruck()
  console.log(truck)
  const { truckNo } = useParams();
  const [revenue, setRevenue] = useState(0);
  const [totalExpense, setTotalExpense] = useState(0);
  const [modelOpen, setModelOpen] = useState(false);
  const [selected, setSelected] = useState<IExpense | null>(null);

  const AddExpenseModal = dynamic(() => import('@/components/AddExpenseModal'), { ssr: false })

  const handleExpense = async (editedExpense: IExpense) => {
    try {
      if (selected) {
        const expense: any = await handleEditExpense(editedExpense, selected._id as string);
        setTruck((prev: any) => ({
          ...prev,
          truckLedger: prev.truckLedger.map((item: any) => (item._id === expense._id ? expense : item)),
        }));
      } else {
        const expense: any = await handleAddExpense(editedExpense);
        setTruck((prev: any) => ({
          ...prev,
          truckLedger: [expense, ...prev.truckLedger], // Add new expense at the beginning
        }));
      }
    } catch (error) {
      alert('Failed to perform expense operation');
      console.log(error);
    }
  };

  const handleDeleteExpense = async (id: string) => {
    try {
      const expense = await DeleteExpense(id);
      if (expense) {
        setTruck((prev: any) => ({
          ...prev,
          truckLedger: prev.truckLedger.filter((item: any) => item._id !== expense._id),
        }));
      }
    } catch (error) {
      alert('Failed to Delete Expense');
      console.log(error);
    }
  };

  useEffect(() => {
    const fetchData = async () => {
      try {
        const [profitRes] = await Promise.all([
          fetch(`/api/trucks/${truckNo}/summary`)
        ]);

        const [profitData] = await Promise.all([
          profitRes.ok ? profitRes.json() : []
        ])



        setTotalExpense(profitData.truckExpense);
        setRevenue(profitData.tripRevenue);
      } catch (error: any) {
        console.error('Error fetching data:', error);
        alert(error.message);
      }
    };
    fetchData();
  }, [truckNo]);


  if (loading) return <Loading />;
  

  return (
    <div className="w-full h-full p-4">
      <div className="mb-4 flex justify-between items-center bg-gray-100 p-4 rounded-lg shadow-md">
        <h2 className="text-lg font-bold text-green-700">Total Revenue: <span className="text-black">{formatNumber(revenue)}</span></h2>
        <h2 className="text-lg font-bold text-red-700">Total Expense: <span className="text-black">{formatNumber(totalExpense)}</span></h2>
        <h2 className="text-lg font-bold text-blue-700">Profit: <span className="text-black">{formatNumber(revenue - totalExpense)}</span></h2>
      </div>

      <div className="table-container">
        <Table className="custom-table">
          <TableHeader>
            <TableRow>
              <TableHead>Date</TableHead>
              <TableHead>Reason</TableHead>
              <TableHead>Expense</TableHead>
              <TableHead>Revenue</TableHead>
              <TableHead>Action</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {truck.truckLedger.map((item: any, index: number) => (
              <TableRow key={index}>
                <TableCell>
                  <div className='flex items-center space-x-2'>
                    <FaCalendarAlt className='text-bottomNavBarColor' />
                    <span>{new Date(item.date || item.startDate).toLocaleDateString()}</span>
                  </div>
                </TableCell>
                <TableCell>
                  {item.expenseType ? (
                    <div className="flex items-center space-x-2 p-2">
                      <span className="font-semibold text-lg text-gray-800">{item.expenseType}</span>
                      {item.trip_id && (
                        <Button variant={"link"} className="text-red-500 pt-1 rounded-lg">
                          <Link href={`/user/trips/${item.trip_id}`}>from a trip</Link>
                        </Button>
                      )}
                    </div>
                  ) : (
                    <TripCard
                      key={item.trip_id}
                      tripId={item.trip_id}
                      route={item.route}
                      partyName={item.partyName}
                      status={item.status}
                      statuses={statuses}
                    />
                  )}
                </TableCell>

                <TableCell>
                  <span className='text-red-500 font-semibold'>{item.expenseType ? formatNumber(item.amount) : 0}</span>
                </TableCell>
                <TableCell><span className='text-green-500 font-semibold'>{!item.expenseType ? formatNumber(item.tripRevenue) : ''}</span></TableCell>
                <TableCell>
                  {item.expenseType ?
                    <div className='flex space-x-2 justify-center items-center w-full p-1'>
                      <Button variant="outline" onClick={() => {
                        setSelected(item);
                        setModelOpen(true);
                      }}><MdEdit /></Button>
                      <Button onClick={() => handleDeleteExpense(item._id)} variant={'destructive'} ><MdDelete /></Button>
                    </div> :
                    <div className='flex items-center justify-center'>
                      <Link href={`/user/trips/${item.trip_id}`}><Button variant={'outline'} >View Trip</Button></Link>
                    </div>

                  }
                </TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </div>
      <AddExpenseModal
        isOpen={modelOpen}
        onClose={() => {
          setModelOpen(false);
          setSelected(null);
      }}
        onSave={handleExpense}
        truckNo={truckNo as string}
        categories={['Truck Expense', 'Trip Expense', 'Office Expense']} driverId={''}
        selected={selected} />
    </div>
  );
};

export default TruckPage;
</file>

<file path="src/app/user/trucks/[truckNo]/trips/page.tsx">
'use client';
import React, { useEffect, useState, useMemo } from 'react';
import { useParams, useRouter } from 'next/navigation';
import dynamic from 'next/dynamic';
import { ITrip, IParty } from '@/utils/interface';
import { statuses } from '@/utils/schema';
import { FaCalendarAlt, FaTruck, FaRoute, FaFileInvoiceDollar, FaSort, FaSortDown, FaSortUp } from 'react-icons/fa';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { formatNumber } from '@/utils/utilArray';
import { useTruck } from '@/context/truckContext';
import Loading from '../loading'

// Dynamically import the Loading component


const TruckTripsPage = () => {
  const {truck, setTruck, loading} = useTruck()
  const router = useRouter();
  const { truckNo } = useParams();
  
  const [error, setError] = useState<string | null>(null);
  const [parties, setParties] = useState<IParty[]>([]);
  const [sortConfig, setSortConfig] = useState<any>({ key: null, direction: 'asc' })

  const trips = useMemo(()=>{
    let filteredTrips: any = []
    if (!truck?.truckLedger || truck?.truckLedger?.length === 0) return []; 
    truck.truckLedger.map((item : any)=>{
      if(item.type === 'trip') filteredTrips.push(item)
    })
    return filteredTrips
  },[truck])

  const sortedTrips = useMemo(() => {
    if (!truck?.truckLedger || truck?.truckLedger?.length === 0) return []; // This line ensures that trips is not null or empty
    let sortableTrips = [...trips as any];
    if (sortConfig.key !== null) {
      sortableTrips.sort((a, b) => {
        if (a[sortConfig.key!] < b[sortConfig.key!]) {
          return sortConfig.direction === 'asc' ? -1 : 1;
        }
        if (a[sortConfig.key!] > b[sortConfig.key!]) {
          return sortConfig.direction === 'asc' ? 1 : -1;
        }
        return 0;
      });
    }
    return sortableTrips;
  }, [trips, sortConfig]);


  const requestSort = (key: keyof ITrip) => {
    let direction: 'asc' | 'desc' = 'asc'
    if (sortConfig.key === key && sortConfig.direction === 'asc') {
      direction = 'desc'
    }
    setSortConfig({ key, direction })
  }

  const getSortIcon = (columnName: keyof ITrip) => {
    if (sortConfig.key === columnName) {
      return sortConfig.direction === 'asc' ? <FaSortUp /> : <FaSortDown />
    }
    return <FaSort />
  }

  // useEffect(() => {
  //   const fetchTrips = async () => {
  //     try {
  //       const res = await fetch(`/api/trips/truck/${truckNo}`);
  //       if (!res.ok) {
  //         throw new Error('Failed to fetch trips');
  //       }
  //       const data = await res.json();
  //       setTrips(data.trips);
  //     } catch (err) {
  //       setError((err as Error).message);
  //     } finally {
  //       setLoading(false);
  //     }
  //   };

  //   const fetchParties = async () => {
  //     setLoading(true);
  //     try {
  //       const res = await fetch('/api/parties');
  //       if (!res.ok) {
  //         throw new Error('Failed to fetch parties');
  //       }
  //       const data = await res.json();
  //       setParties(data.parties);
  //     } catch (err) {
  //       setError((err as Error).message);
  //     } finally {
  //       setLoading(false);
  //     }
  //   };

  //   fetchTrips();
  //   fetchParties();
  // }, [truckNo]);

  const renderedTrips = useMemo(() => (
    sortedTrips.map((trip, index) => (
      <TableRow
        key={trip.trip_id}
        className="border-t hover:bg-orange-100 cursor-pointer transition-colors"
        onClick={() => router.push(`/user/trips/${trip.trip_id}`)}
      >
        <TableCell className="border p-4 ">
          <div className='flex items-center space-x-2'>


            <FaCalendarAlt className="text-[rgb(247,132,50)]" />
            <span>{new Date(trip.startDate).toLocaleDateString()}</span>
          </div>
        </TableCell>
        <TableCell className="border p-4">{trip.LR}</TableCell>
        <TableCell className="border p-4">
          <div className='flex items-center space-x-2'>
            <span>{trip.partyName}</span>
          </div>
        </TableCell>
        <TableCell className="border p-4 ">
          <div className='flex items-center space-x-2'>
            <FaRoute className="text-[rgb(247,132,50)]" />
            <span>{trip.route.origin.split(',')[0]} -&gt; {trip.route.destination.split(',')[0]}</span>
          </div>

        </TableCell>
        <TableCell className="border p-4">
          <div className="flex flex-col items-center space-x-2">
            <span>{statuses[trip.status as number]}</span>
            <div className="relative w-full bg-gray-200 h-1 rounded">
              <div className={`absolute top-0 left-0 h-1 rounded transition-width duration-500 ${trip.status === 0 ? 'bg-red-500' : trip.status === 1 ? 'bg-yellow-500' : trip.status === 2 ? 'bg-blue-500' : trip.status === 3 ? 'bg-green-500' : 'bg-green-800'}`} style={{ width: `${(trip.status as number / 4) * 100}%` }}></div>
            </div>
          </div>
        </TableCell>
      </TableRow>
    ))
  ), [trips, parties, router]);

  if (loading) return <Loading />;

  return (
    <div className="w-full h-full p-4">
      {error && <div className="text-red-500">{error}</div>}
      <div className="table-container">
        <Table className="custom-table">
          <TableHeader>
            <TableRow>
              <TableHead onClick={() => requestSort('startDate')}>
                <div className='flex justify-between'>
                  Start Date {getSortIcon('startDate')}
                </div>

              </TableHead>
              <TableHead>LR Number</TableHead>
              <TableHead onClick={() => requestSort('partyName')}>
                <div className='flex justify-between'>
                  Party Name{getSortIcon('partyName')}
                </div>
              </TableHead>
              <TableHead>Route</TableHead>
              <TableHead onClick={()=>requestSort('status')}>
              <div className='flex justify-between'>
                  Status{getSortIcon('status')}
                </div>
              </TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {renderedTrips}
          </TableBody>
        </Table>
      </div>
    </div>
  );
};

export default React.memo(TruckTripsPage);
</file>

<file path="src/app/user/trucks/layout.tsx">
'use client'
import { Button } from "@/components/ui/button";

import { Inter } from "next/font/google";
import Link from 'next/link';
import { usePathname } from "next/navigation";

const inter = Inter({ subsets: ["latin"] });

const headings: any = {
  '/user/trucks': 'Lorries',
  '/user/trucks/create': 'New Lorry'
}

const TrucksLayout = ({ children }: { children: React.ReactNode }) => {
  const pathname = usePathname()
  return (
    <div className={`${inter.className} max-h-screen flex flex-col`}>
      <div className="container mx-auto p-2 flex flex-col bg-white">
        <div className="flex items-center justify-between mb-4 border-b-2 border-gray-300 pb-2">
          <h1 className="text-3xl font-bold text-black">{headings[pathname] || 'Lorry Details'}</h1>
          <div className="flex space-x-4">
            {!pathname.includes('create') &&
              <Link href="/user/trucks/create">
                <Button >

                  Add Lorry

                </Button>
              </Link>
            }
          </div>
        </div>
        <div className="flex-grow">
          {children}
        </div>
      </div>
    </div>
  );
};

export default TrucksLayout;
</file>

<file path="src/app/user/trucks/loading.tsx">
import React from "react";

export default function Loading() {
  return (
    <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-10 z-50">
      
        <iframe 
          src="https://lottie.host/embed/3d45f054-61ac-4d4e-837c-2fa3006e28cc/MeZ8JDXVB5.json" 
        ></iframe>
    </div>
  );}
</file>

<file path="src/app/user/trucks/page.tsx">
'use client'

import React, { useCallback, useEffect, useMemo, useState } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { FaSort, FaSortDown, FaSortUp } from 'react-icons/fa6';
import debounce from 'lodash.debounce';

import Loading from './loading';
import { truckTypesIcons } from '@/utils/utilArray';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { statuses } from '@/utils/schema';
import { Button } from '@/components/ui/button';
import TripCard from '@/components/TripCard';
import { Input } from '@/components/ui/input';

import type { TruckModel as ITruck } from '@/utils/interface';
import { useExpenseData } from '@/components/hooks/useExpenseData';
import { BsFiletypeXlsx } from 'react-icons/bs';
import { handleExportToExcel } from '@/utils/excelOperation';

type SortConfig = {
  key: keyof ITruck | any;
  direction: 'asc' | 'desc';
};

export default function TrucksPage() {

  const router = useRouter();
  const { trucks, isLoading, refetchTrucks } = useExpenseData();
  const [sortConfig, setSortConfig] = useState<SortConfig>({ key: null, direction: 'asc' });
  const [searchQuery, setSearchQuery] = useState('');


  useEffect(() => {
    refetchTrucks()
  }, [refetchTrucks])

  const debouncedSearch = useMemo(
    () => debounce((query: string) => setSearchQuery(query), 300),
    []
  );

  const handleSearch = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    debouncedSearch(e.target.value.toLowerCase());
  }, [debouncedSearch]);

  const sortedTrucks = useMemo(() => {
    if (!trucks || trucks.length === 0) return [];

    let filteredTrucks = [...trucks];

    if (searchQuery) {
      const lowercaseQuery = searchQuery.toLowerCase();
      filteredTrucks = filteredTrucks.filter((truck) =>
        Object.values(truck).some(value =>
          typeof value === 'string' && value.toLowerCase().includes(lowercaseQuery)
        ) ||
        truck.latestTrip?.partyName?.toLowerCase().includes(lowercaseQuery) ||
        truck.latestTrip?.route?.origin.toLowerCase().includes(lowercaseQuery) ||
        truck.latestTrip?.route?.destination.toLowerCase().includes(lowercaseQuery) ||
        new Date(truck.latestTrip?.startDate).toLocaleDateString().includes(lowercaseQuery)
      );
    }

    if (sortConfig.key) {
      filteredTrucks.sort((a, b) => {
        if (a[sortConfig.key!] < b[sortConfig.key!]) {
          return sortConfig.direction === 'asc' ? -1 : 1;
        }
        if (a[sortConfig.key!] > b[sortConfig.key!]) {
          return sortConfig.direction === 'asc' ? 1 : -1;
        }
        return 0;
      });
    }

    return filteredTrucks;
  }, [trucks, sortConfig, searchQuery]);

  const requestSort = useCallback((key: any) => {
    setSortConfig((prevConfig) => ({
      key,
      direction: prevConfig.key === key && prevConfig.direction === 'asc' ? 'desc' : 'asc',
    }));
  }, []);

  const getSortIcon = useCallback((columnName: any) => {
    if (sortConfig.key === columnName) {
      return sortConfig.direction === 'asc' ? <FaSortUp /> : <FaSortDown />;
    }
    return <FaSort />;
  }, [sortConfig]);

  const truncateText = (text: string, maxLength: number) => {
    return text?.length > maxLength ? text.substring(0, maxLength) + '...' : text;
  };

  const handleExport = ()=>{
    const selectedColumns = ["truckNo", "driverName", "truckType", "ownership", "status", "supplierName"]
    handleExportToExcel(sortedTrucks, selectedColumns, "trucks.xlsx")
  }

  if (isLoading) return <Loading />;

  if (!trucks || trucks.length === 0) {
    return <div className="text-gray-500 text-center py-8">No trucks found</div>;
  }

  return (
    <div className="w-full h-full p-4">
      <div className="flex items-center w-full px-60 mb-4 gap-2">
        <Input
          type="text"
          placeholder="Search..."
          onChange={handleSearch}
          className="w-full"
        />
        <div className='p-2 flex justify-end'>
          <Button onClick={() => handleExport()}>
            <BsFiletypeXlsx size={20} />
          </Button>
        </div>
      </div>
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>Truck Number</TableHead>
            <TableHead onClick={() => requestSort('truckType')} className="cursor-pointer">
              <div className="flex justify-between items-center">
                Truck Type {getSortIcon('truckType')}
              </div>
            </TableHead>
            <TableHead onClick={() => requestSort('ownership')} className="cursor-pointer">
              <div className="flex justify-between items-center">
                Ownership {getSortIcon('ownership')}
              </div>
            </TableHead>
            <TableHead onClick={() => requestSort('status')} className="cursor-pointer">
              <div className="flex justify-between items-center">
                Status {getSortIcon('status')}
              </div>
            </TableHead>
            <TableHead onClick={() => requestSort('supplierName')} className="cursor-pointer">
              <div className="flex justify-between items-center">
                Supplier Name {getSortIcon('supplierName')}
              </div>
            </TableHead>
            <TableHead>Latest Trip</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {sortedTrucks.map((truck, index) => {
            const Icon = truckTypesIcons.find(item => item.type === truck.truckType)?.Icon;
            return (
              <TableRow
                index={index + 1}
                key={truck.truckNo}
                className="border-t hover:bg-gray-100 transition-colors duration-200 cursor-pointer"
                onClick={() => router.push(`/user/trucks/${truck.truckNo}`)}
              >
                <TableCell className="text-gray-800 font-medium">
                  <div className="flex flex-col space-y-2">
                    {truck.truckNo}
                    {truck.driverName && (
                      <span className="text-gray-400 text-sm">
                        Driver:
                        <Button variant="link" asChild>
                          <Link
                            href={`/user/drivers/${truck.driver_id}`}
                            onClick={(e) => e.stopPropagation()}
                          >
                            {truck.driverName}
                          </Link>
                        </Button>
                      </span>
                    )}
                  </div>
                </TableCell>
                <TableCell>
                  <div className="flex items-center space-x-2 justify-between">
                    <span>{truck.truckType}</span>
                    {Icon && <Icon className="inline-block ml-2 h-6 w-6 text-bottomNavBarColor" />}
                  </div>
                </TableCell>
                <TableCell className="text-gray-700">{truck.ownership}</TableCell>
                <TableCell>
                  <span
                    className={`inline-block px-3 py-1 rounded-full text-sm font-semibold ${truck.status === 'Available' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                      }`}
                  >
                    {truck.status}
                  </span>
                </TableCell>
                <TableCell>
                  {truck.supplierName ? (
                    <Button variant="link" asChild>
                      <Link
                        href={`/user/suppliers/${truck.supplier}/trips`}
                        onClick={(e) => e.stopPropagation()}
                      >
                        {truncateText(truck.supplierName as string, 20)}
                      </Link>
                    </Button>
                  ) : (
                    'NA'
                  )}
                </TableCell>
                <TableCell>
                  {truck.latestTrip && Object.keys(truck.latestTrip).length > 0 ? (
                    <TripCard
                      key={truck.latestTrip.trip_id}
                      tripId={truck.latestTrip.trip_id}
                      route={truck.latestTrip.route}
                      partyName={truck.latestTrip.partyName}
                      status={truck.latestTrip.status}
                      statuses={statuses}
                      startDate={truck.latestTrip.startDate}
                    />
                  ) : (
                    'NA'
                  )}
                </TableCell>
              </TableRow>
            );
          })}
        </TableBody>
      </Table>
    </div>
  );
}
</file>

<file path="src/components/AdExpenseTypeModal.tsx">
'use client'
import { motion } from 'framer-motion'
import React, { useState } from 'react'
import { Button } from './ui/button'
import { useToast } from './hooks/use-toast'

type Props = {
    open: boolean
    setOpen: React.Dispatch<React.SetStateAction<boolean>>
    setExpenses: React.Dispatch<React.SetStateAction<string[]>>
}

const AdExpenseTypeModal: React.FC<Props> = ({ open, setOpen, setExpenses }) => {
    const [expense, setExpense] = useState('')
    const [loading, setLoading] = useState(false)
    const { toast } = useToast()
    const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault()
        setLoading(true)
        try {
            const res = await fetch('/api/expenses/expenseType', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ expenseType: expense })
            })
            if (!res.ok) {
                toast({
                    description: 'Failed to add expense type',
                    variant: 'destructive'
                })
                return
            }
            const data = await res.json()
            setExpenses(prev => {
                if (prev.length === 0) return [expense]
                else return [
                    expense,
                    ...prev
                ]
            })
            toast({
                description: 'Expense type added'
            })
            setOpen(false)
        } catch (error) {
            toast({
                description: 'Failed to add expense type',
                variant: 'destructive'
            })
        }
        setLoading(false)
    }
    if (!open) {
        return null
    }
    return (
        <div className='modal-class z-50'>
            <motion.div
                initial={{ opacity: 0, scale: 0.5 }}
                animate={{ opacity: 1, scale: 1 }}
                transition={{
                    duration: 0.5,
                    ease: [0, 0.71, 0.2, 1.01]
                }}
                className="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl max-h-[700px] overflow-y-auto thin-scrollbar"
            >
                <form onSubmit={handleSubmit}>
                    <div>
                        <h1 className='text-xl text-black font-semibold mb-2'>Add Own Expense Type</h1>
                        <label>Expense Type *</label>
                        <input type='text' placeholder="(Eg. Fuel Expense)" value={expense} onChange={(e) => setExpense(e.target.value)} />
                        <div className='flex items-center justify-between mt-2'>

                            <Button disabled={loading} variant={'outline'} type='button' onClick={() => setOpen(false)}>Cancel</Button>
                            <Button disabled={loading} type='submit'>Add Expense Type</Button>
                        </div>

                    </div>
                </form>
            </motion.div>
        </div>
    )
}

export default AdExpenseTypeModal
</file>

<file path="src/components/admin/Header.tsx">
import Image from "next/image"
import Link from "next/link"
import { Button } from "@/components/ui/button"

export default function Header() {
  return (
    <nav className="bg-white shadow-md">
      <div className="mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex items-center justify-between h-16">
          <div className="flex items-center">
            <Image src="/awajahi logo.png" height={40} width={40} alt="Awajahi Logo" className="mr-3" />
            <h1 className="text-xl font-semibold text-gray-800">Awajahi</h1>
          </div>
          <Link href="/user/home">
            <Button variant="outline">Back to User Home</Button>
          </Link>
        </div>
      </div>
    </nav>
  )
}
</file>

<file path="src/components/admin/Sidebar.tsx">
"use client"

import { useState } from "react"
import { Users, BarChart2, Settings } from "lucide-react"

const sidebarItems = [
  { label: "Users", icon: Users },
  { label: "Analytics", icon: BarChart2 },
  { label: "Settings", icon: Settings },
]

export default function Sidebar() {
  const [activeTab, setActiveTab] = useState("Users")

  return (
    <aside className="w-64 bg-white shadow-md h-[calc(100vh-4rem)] fixed">
      <ul className="py-4">
        {sidebarItems.map((item) => (
          <li
            key={item.label}
            className={`flex items-center px-6 py-3 cursor-pointer transition-colors duration-200 ${
              activeTab === item.label ? "bg-blue-100 text-blue-600" : "hover:bg-gray-100"
            }`}
            onClick={() => setActiveTab(item.label)}
          >
            <item.icon className="mr-3 h-5 w-5" />
            <span>{item.label}</span>
          </li>
        ))}
      </ul>
    </aside>
  )
}
</file>

<file path="src/components/AppDownload.tsx">
import Image from 'next/image'
import { Button } from "@/components/ui/button"
import mobile_img from '@/assets/mobile-img.png'
import appQr from '@/assets/qr code.png'
import playstore from '@/assets/playstore.png'

export default function AppDownload() {
  return (
    <section className="p-4 lg:p-16 bg-white">
      <div className="flex flex-col-reverse lg:flex-row items-center justify-between gap-6">
        <div className="w-full lg:w-auto flex justify-center items-end h-full mt-10 lg:mt-0">
          <Image 
            src={mobile_img}
            alt="Awajahi mobile app interface" 
            width={300} 
            height={380} 
            className="lg:w-auto w-full"
          />
        </div>

        <div className="flex flex-col items-center justify-center w-full lg:w-1/2 gap-4 lg:gap-8 text-center">
          <h2 className="text-3xl lg:text-5xl font-semibold">Download the App</h2>
          <Image 
            src={appQr}
            alt="QR code to download Awajahi app" 
            width={335} 
            height={124} 
            className="hidden sm:block"
          />
          
            <Image 
              src={playstore} 
              alt="Get it on Google Play" 
              width={250} 
              height={70} 
              className="w-full lg:w-auto"
              priority
            />
        </div>
      </div>
    </section>
  )
}
</file>

<file path="src/components/createParty.tsx">
'use client'

import React, { useState } from 'react';
import { IParty } from '@/utils/interface';
import { v4 as uuidv4 } from 'uuid';
import { Button } from './ui/button';

interface Props {
  onSubmit: (party: IParty) => void;
}

const PartyForm: React.FC<Props> = ({ onSubmit }) => {
  // State to hold form data
  const [formData, setFormData] = useState<Partial<IParty>>({
    name: '',
    contactPerson: '',
    contactNumber: '',
    address: '',
    gstNumber: '',
    balance: 0,
    pan : '',
    email : ''
  });

  const handleFocus = (e: React.FocusEvent<HTMLInputElement>) => {
    if (e.target.value === '0') {
      handleChange({ target: { name: e.target.name, value: '' } } as React.ChangeEvent<HTMLInputElement>);
    }
  };

  // Handle input changes and update the state
  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target;
    setFormData(prevState => ({
      ...prevState,
      [name]: value,
    }));
  };

  // Handle form submission
  const handleSubmit = (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    if(!formData.name || !formData.contactNumber){
      alert('!Fill in the required feilds')
      return
    }
    // Generate a unique party ID
    const partyId = 'party' + uuidv4();

    // Create a new party object
    const newParty: IParty = {
      ...formData,
      party_id: partyId,
      createdAt: new Date(),
      updatedAt: new Date(),
    } as IParty; // Type assertion to ensure newParty matches IParty
    // Call onSubmit with the new party object
    onSubmit(newParty);
  };

  return (
    <form onSubmit={handleSubmit} className="w-full max-w-md mx-auto p-4 bg-white shadow-md rounded-md text-black">
      <label className="block mb-2">
        Name*
        <input
          type="text"
          name="name"
          value={formData.name}
          onChange={handleChange}
          required
          className="block w-full p-2 mt-1 border border-gray-300 rounded-md"
        />
      </label>
      <label className="block mb-2">
        Contact Person
        <input
          type="text"
          name="contactPerson"
          value={formData.contactPerson}
          onChange={handleChange}
          className="block w-full p-2 mt-1 border border-gray-300 rounded-md"
        />
      </label>
      <label className="block mb-2">
        Contact Number*
        <input
          type="text"
          name="contactNumber"
          value={formData.contactNumber}
          onChange={handleChange}
          className="block w-full p-2 mt-1 border border-gray-300 rounded-md"
        />
      </label>
      <label className="block mb-2">
        Address
        <input
          type="text"
          name="address"
          value={formData.address}
          onChange={handleChange}
          className="block w-full p-2 mt-1 border border-gray-300 rounded-md"
        />
      </label>
      <label className="block mb-2">
        GST Number
        <input
          type="text"
          name="gstNumber"
          value={formData.gstNumber}
          onChange={handleChange}
          className="block w-full p-2 mt-1 border border-gray-300 rounded-md"
        />
      </label>
      <label className="block mb-2">
        Email
        <input
          type="email"
          name="email"
          value={formData.email}
          onChange={handleChange}
          className="block w-full p-2 mt-1 border border-gray-300 rounded-md"
        />
      </label>
      <label className="block mb-2">
        PAN (Permanent Account Number)
        <input
          type="text"
          name="pan"
          value={formData.pan}
          onChange={handleChange}
          className="block w-full p-2 mt-1 border border-gray-300 rounded-md"
        />
      </label>
      <Button type="submit" className='mt-2 w-full'>
        Submit
      </Button>
    </form>
  );
};

export default PartyForm;
</file>

<file path="src/components/createSupplier.tsx">
'use client'

import React, { useState } from 'react';
import { ISupplier } from '@/utils/interface';
import { v4 as uuidv4 } from 'uuid';
import { Button } from './ui/button';

interface Props {
  onSubmit: (supplier: ISupplier) => void;
}

const SupplierForm: React.FC<Props> = ({ onSubmit }) => {
  // State to hold form data
  const [formData, setFormData] = useState<Partial<ISupplier>>({
    name: '',
    contactNumber: '',
  });

  // Handle input changes and update the state
  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target;
    setFormData(prevState => ({
      ...prevState,
      [name]: value,
    }));
  };

  // Handle form submission
  const handleSubmit = (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    // Generate a unique party ID
    const partyId = 'party' + uuidv4();
    // Create a new party object
    const newSupplier: ISupplier = {
      ...formData,
      party_id: partyId,
      createdAt: new Date(),
      updatedAt: new Date(),
    } as ISupplier; // Type assertion to ensure newParty matches IParty
    // Call onSubmit with the new party object
    onSubmit(newSupplier);
    // Optionally, clear the form after submission
    setFormData({
      name: '',
      contactNumber: '',
    });
  };

  return (
    <form onSubmit={handleSubmit} className="w-full max-w-md mx-auto p-4 bg-white shadow-md rounded-md text-black">
      <label className="block mb-2">
        Name:
        <input
          type="text"
          name="name"
          value={formData.name}
          onChange={handleChange}
          required
          className="block w-full p-2 mt-1 border border-gray-300 rounded-md"
        />
      </label>
      <label className="block mb-2">
        Contact Number:
        <input
          type="text"
          name="contactNumber"
          value={formData.contactNumber}
          onChange={handleChange}
          className="block w-full p-2 mt-1 border border-gray-300 rounded-md"
        />
      </label>
      <Button type="submit" className='w-full'>
        Submit
      </Button>
    </form>
  );
};

export default SupplierForm;
</file>

<file path="src/components/documents/company-document-upload-modal.tsx">
'use client';

import React, { useState } from 'react';
import { Button } from '@/components/ui/button';
import CompanyDocumentUpload from '@/components/documents/CompanyDocumentUpload';
import { CloudUpload } from 'lucide-react';

type Props = {
  setDocs: React.Dispatch<React.SetStateAction<any>>;
};

const CompanyDocumentUploadModal: React.FC<Props> = ({ setDocs }) => {
  const [modalOpen, setModalOpen] = useState(false);

  return (
    <>
     <div className='flex justify-end my-2 fixed right-4 bottom-4'>
        <Button onClick={() => setModalOpen(true)} className='rounded-full h-full py-2'><CloudUpload size={40} /></Button>
      </div>
          <CompanyDocumentUpload open={modalOpen} setOpen={setModalOpen} setDocs={setDocs} />
        
    </>
  );
};

export default CompanyDocumentUploadModal;
</file>

<file path="src/components/documents/CompanyDocumentUpload.tsx">
'use client'

import { useState } from 'react';
import { Button } from '../ui/button';
import { motion } from 'framer-motion'
import { createWorker } from 'tesseract.js';
import { Loader2, X } from 'lucide-react';
import { useToast } from '../hooks/use-toast';
import FileUploader from '../FileUploader';
import { useSWRConfig } from 'swr';

interface DocumentForm {
    files: File[];
    filenames: string[];
}

type Props = {
    open: boolean;
    setOpen: (open: boolean) => void;
    setDocs?: any
};

const CompanyDocumentUpload: React.FC<Props> = ({ open, setOpen, setDocs }) => {
    const [formData, setFormData] = useState<DocumentForm>({
        files: [],
        filenames: [],
    });
    const {mutate} = useSWRConfig()
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');
    const [successMessage, setSuccessMessage] = useState('');
    const { toast } = useToast()

    // Handle input changes for filenames
    const handleFilenameChange = (index: number, value: string) => {
        setFormData(prevData => ({
            ...prevData,
            filenames: prevData.filenames.map((filename, i) => i === index ? value : filename),
        }));
    };

    const extractTextFromImage = async (file: File): Promise<string> => {
        const worker = await createWorker('eng');
        const { data: { text } } = await worker.recognize(file);
        await worker.terminate();
        return text;
    };

    // Handle file change
    const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
        e.preventDefault();

        if (e.target.files) {
            const newFiles = Array.from(e.target.files);
            setFormData(prevData => ({
                files: [...prevData.files, ...newFiles],
                filenames: [...prevData.filenames, ...newFiles.map(file => file.name)],
            }));
        }
    };

    const handleFilesChange = (files: File[]) => {
        setFormData(prevData => ({
            files: [...prevData.files, ...files],
            filenames: [...prevData.filenames, ...files.map(file => file.name)],
        }));
    };

    // Remove file
    const removeFile = (index: number) => {
        setFormData(prevData => ({
            files: prevData.files.filter((_, i) => i !== index),
            filenames: prevData.filenames.filter((_, i) => i !== index),
        }));
    };

    // Handle form submission
    const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
        setLoading(true)
        e.preventDefault();

        if (formData.files.length === 0) {
            setError('Please upload at least one document.');
            toast({
                description: 'Please upload at least one document.',
                variant: 'warning',
            });
            return;
        }

        const data = new FormData();

        formData.files.forEach((file, index) => {
            data.append(`file${index}`, file);
            // Ensure a filename is always provided
            data.append(`filename${index}`, formData.filenames[index] || file.name);
        });


        try {
            const response = await fetch(`/api/users`, {
                method: 'PATCH',
                body: data,
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Unknown error');
            }
            toast({
                description: 'Documents uploaded successfully!',
            })
            const responseData = await response.json();
            setSuccessMessage(responseData.message);
            setFormData({ files: [], filenames: [] });
            setOpen(false);
            if (setDocs)
                setDocs(responseData.user.documents);
            mutate('/api/documents/recent')
        } catch (err: any) {
            setError(err.message);
            toast({
                description: err.message,
                variant: 'destructive',
            });
        }
        setLoading(false)
    };



    if (!open) {
        return null;
    }

    return (
        <div className='modal-class'>
            <motion.div
                initial={{ opacity: 0, scale: 0.5 }}
                animate={{ opacity: 1, scale: 1 }}
                transition={{
                    duration: 0.5,
                    ease: [0, 0.71, 0.2, 1.01]
                }} className="w-full max-w-3xl mx-auto bg-white p-6 rounded-lg shadow-md flex flex-col z-50">
                <h1 className="text-2xl font-semibold mb-4 text-black">Upload Documents</h1>

                {error && <p className="text-red-500 mb-4">{error}</p>}
                {successMessage && <p className="text-green-500 mb-4">{successMessage}</p>}

                <form onSubmit={handleSubmit}>
                    {/* File upload input */}
                    <div className="mb-4">
                        <label className="block text-gray-700 mb-2">Upload Files (PDF or Image)*</label>
                        <FileUploader onFilesChange={handleFilesChange} />
                    </div>

                    {/* Display uploaded files */}
                    {formData.files.length > 0 && (
                        <div className="mb-4">
                            <h3 className="text-lg font-semibold mb-2">Uploaded Files:</h3>
                            <ul className="space-y-2">
                                {formData.files.map((file, index) => (
                                    <li key={index} className="flex items-center justify-between bg-gray-100 p-2 rounded">
                                        <input
                                            type="text"
                                            value={formData.filenames[index]}
                                            onChange={(e) => handleFilenameChange(index, e.target.value)}
                                            className="flex-grow mr-2 p-1 border rounded"
                                        />
                                        <Button
                                            type="button"
                                            variant="ghost"
                                            size="sm"
                                            onClick={() => removeFile(index)}
                                        >
                                            <X className="h-4 w-4" />
                                        </Button>
                                    </li>
                                ))}
                            </ul>
                        </div>
                    )}

                    {/* Submit button */}
                    <div className="flex items-center space-x-2 justify-end">
                        <Button type="submit" disabled={loading}>
                            {loading ? <Loader2 className='text-white animate-spin' /> : 'Submit'}
                        </Button>
                        <Button variant={'outline'} onClick={() => setOpen(false)} disabled={loading}>
                            Cancel
                        </Button>
                    </div>
                </form>
            </motion.div>
        </div>
    );
};

export default CompanyDocumentUpload;
</file>

<file path="src/components/documents/other-document-upload-modal.tsx">
'use client';

import React, { useState } from 'react';
import { Button } from '@/components/ui/button';
import OtherDocumentUpload from './OtherDocumentUpload';
import { CloudUpload } from 'lucide-react';

type Props = {
  setDocs: React.Dispatch<React.SetStateAction<any>>;
};

const OtherDocumentUploadModal: React.FC<Props> = ({ setDocs }) => {
  const [modalOpen, setModalOpen] = useState(false);

  return (
    <>
      <div className='flex justify-end my-2 fixed right-4 bottom-4'>
        <Button onClick={() => setModalOpen(true)} className='rounded-full h-full py-2'><CloudUpload size={40} /></Button>
      </div>

          <OtherDocumentUpload open={modalOpen} setOpen={setModalOpen} setUser={setDocs} />
        
    </>
  );
};

export default OtherDocumentUploadModal;
</file>

<file path="src/components/documents/OtherDocumentUpload.tsx">
'use client'

import { useState } from 'react';
import { Button } from '../ui/button';
import { motion } from 'framer-motion'
import { Loader2, X, Edit2 } from 'lucide-react';
import { useToast } from '../hooks/use-toast';
import FileUploader from '../FileUploader';
import { Input } from '../ui/input';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '../ui/dialog';
import { v4 as uuidV4 } from 'uuid'
import { useSWRConfig } from 'swr';

interface FileData {
  id: string;
  file: File;
  filename: string;
  validityDate: string;
}

interface DocumentForm {
  files: FileData[];
}

type Props = {
  open: boolean;
  setOpen: (open: boolean) => void;
  setUser?: any;
};

const OtherDocumentUpload: React.FC<Props> = ({ open, setOpen, setUser }) => {
  const [formData, setFormData] = useState<DocumentForm>({
    files: [],
  });

  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [successMessage, setSuccessMessage] = useState('');
  const { toast } = useToast();
  const { mutate } = useSWRConfig()

  const handleFilesChange = (files: File[]) => {
    const newFiles = files.map(file => ({
      id: uuidV4(),
      file,
      filename: file.name,
      validityDate: '',
    }));
    setFormData(prevData => ({
      ...prevData,
      files: [...prevData.files, ...newFiles],
    }));
  };

  const removeFile = (id: string) => {
    setFormData(prevData => ({
      ...prevData,
      files: prevData.files.filter(file => file.id !== id),
    }));
  };

  const updateFileData = (id: string, data: Partial<FileData>) => {
    setFormData(prevData => ({
      ...prevData,
      files: prevData.files.map(file =>
        file.id === id ? { ...file, ...data } : file
      ),
    }));
  };

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();

    if (formData.files.length === 0) {
      setError('Please upload at least one document.');
      toast({
        description: 'Please upload at least one document.',
        variant: 'warning'
      });
      return;
    }

    setLoading(true);
    setError('');
    setSuccessMessage('');

    const data = new FormData();
    formData.files.forEach((fileData) => {
      data.append(`file-${fileData.id}`, fileData.file);
    });
    data.append('filesData', JSON.stringify(formData.files.map(({ id, filename, validityDate }) => ({ id, filename, validityDate }))));

    try {
      const response = await fetch(`/api/documents`, {
        method: 'POST',
        body: data,
      });

      setLoading(false);

      if (response.ok) {
        toast({
          description: 'Documents uploaded successfully!',
        })
        const responseData = await response.json();
        setSuccessMessage('Documents uploaded successfully!');
        setError('');
        setFormData({ files: [] });
        setOpen(false);
        if (setUser)
          setUser((prev: any[]) => [
            ...responseData.documents,
            ...prev
          ]);
        mutate('/api/documents/recent')
      } else {
        const errorData = await response.json();
        setError(errorData.message || 'Something went wrong.');
        toast({
          description: 'Failed to upload documents',
          variant: 'destructive'
        });
      }
    } catch (err) {
      setLoading(false);
      setError('Failed to upload documents.');
      toast({
        description: 'Failed to upload documents',
        variant: 'destructive'
      });
    }
  };

  if (!open) {
    return null;
  }

  return (
    <div className='modal-class'>


      <motion.div
        initial={{ opacity: 0, scale: 0.5 }}
        animate={{ opacity: 1, scale: 1 }}
        transition={{
          duration: 0.5,
          ease: [0, 0.71, 0.2, 1.01]
        }}
        className="w-full max-w-3xl mx-auto bg-white p-6 rounded-lg shadow-md flex flex-col z-50"
      >
        <h1 className="text-2xl font-semibold mb-4 text-black">Upload Documents</h1>

        {error && <p className="text-red-500 mb-4">{error}</p>}
        {successMessage && <p className="text-green-500 mb-4">{successMessage}</p>}

        <form onSubmit={handleSubmit}>
          <div className="mb-4">
            <label className="block text-gray-700 mb-2">Upload Files (PDF or Image)*</label>
            <FileUploader onFilesChange={handleFilesChange} />
          </div>

          {formData.files.length > 0 && (
            <div className="mb-4 max-h-[400px] overflow-auto thin-scrollbar">
              <h3 className="text-lg font-semibold mb-2">Uploaded Files:</h3>
              <ul className="space-y-2">
                {formData.files.map((fileData) => (
                  <li key={fileData.id} className="flex items-center justify-between bg-gray-100 p-2 rounded">
                    <span>{fileData.filename}</span>
                    <div className="flex items-center space-x-2">
                      <Dialog>
                        <DialogTrigger asChild>
                          <Button variant="ghost" size="sm">
                            <Edit2 className="h-4 w-4" />
                          </Button>
                        </DialogTrigger>
                        <DialogContent>
                          <DialogHeader>
                            <DialogTitle>Edit File Details</DialogTitle>
                          </DialogHeader>
                          <div className="grid gap-4 py-4">
                            <div className="grid grid-cols-4 items-center gap-4">
                              <label htmlFor="filename" className="text-right">
                                Filename
                              </label>
                              <Input
                                id="filename"
                                value={fileData.filename}
                                onChange={(e) => updateFileData(fileData.id, { filename: e.target.value })}
                                className="col-span-3"
                              />
                            </div>
                            <div className="grid grid-cols-4 items-center gap-4">
                              <label htmlFor="validity" className="text-right">
                                Validity Date
                              </label>
                              <Input
                                id="validity"
                                type="date"
                                value={fileData.validityDate}
                                onChange={(e) => updateFileData(fileData.id, { validityDate: e.target.value })}
                                className="col-span-3"
                              />
                            </div>
                          </div>
                        </DialogContent>
                      </Dialog>
                      <Button
                        type="button"
                        variant="ghost"
                        size="sm"
                        onClick={() => removeFile(fileData.id)}
                      >
                        <X className="h-4 w-4" />
                      </Button>
                    </div>
                  </li>
                ))}
              </ul>
            </div>
          )}

          <div className="flex items-center space-x-2 justify-end">
            <Button type="submit" disabled={loading}>
              {loading ? <Loader2 className='text-white animate-spin' /> : 'Submit'}
            </Button>
            <Button variant={'outline'} onClick={() => setOpen(false)} disabled={loading}>
              Cancel
            </Button>
          </div>
        </form>
      </motion.div>
    </div>
  );
};

export default OtherDocumentUpload;
</file>

<file path="src/components/documents/PreviewDocument.tsx">
import React from 'react'
import Image from 'next/image';
import { Button } from '../ui/button';

type props = {
    isOpen : boolean
    documentUrl : string
    onClose : any
}

const isPdf = (fileName: string) => {
    return fileName?.toLowerCase().endsWith('.pdf');
};

const PreviewDocument: React.FC<props> = ({isOpen, documentUrl, onClose}) => {
    const handleDownload = async () => {
        try {
            const response = await fetch(documentUrl.split('.pdf')[0]);
            const blob = await response.blob();
            const blobUrl = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = blobUrl;
            link.setAttribute('download', documentUrl.split('/').pop() || 'file'); // Set file name or fallback to 'file'
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link); // Clean up link element
            window.URL.revokeObjectURL(blobUrl); // Revoke blob URL after download
        } catch (error) {
            console.error('Error downloading the file:', error);
        }
    };
    if(!isOpen) return null
    return (
        <div className="fixed inset-0 flex justify-center items-center z-50 bg-black bg-opacity-50">
            <div className="relative bg-white rounded-lg shadow-lg p-6 w-[80vw] max-w-3xl thin-scrollbar">
                {/* Close button */}
                <button
                    className="absolute top-3 right-3 text-gray-600 hover:text-gray-800 transition-colors"
                    onClick={onClose}
                >
                    &#x2715; {/* Close icon */}
                </button>

                {/* Document content */}
                <div className="h-[70vh] overflow-auto">
                    {isPdf(documentUrl) ? (
                        <iframe
                            src={documentUrl.split('.pdf')[0]}
                            className="w-full h-full"
                            title="Full PDF Preview"
                        />
                    ) : (
                        <Image
                            src={documentUrl}
                            alt='Full document preview'
                            className="rounded-md object-cover w-full h-auto"
                            height={600}
                            width={600}
                        />
                    )}
                </div>

                {/* Download Button */}
                <div className="mt-4 flex justify-end">
                    <Button

                        onClick={handleDownload}
                    >
                        Download
                    </Button>
                </div>
            </div>
        </div>
    )
}

export default PreviewDocument
</file>

<file path="src/components/documents/RecentDocuments.tsx">
'use client'
import React, { useState } from 'react'
import RenderDocument from '../RenderDocument'
import { usePathname } from 'next/navigation'
import { Button } from '../ui/button'
import { EllipsisVertical, Eye, Download, FolderInput, X } from 'lucide-react'
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuLabel,
    DropdownMenuSeparator,
    DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"
import Image from 'next/image'
import { useToast } from '../hooks/use-toast'
import { Dialog, DialogContent } from "@/components/ui/dialog"
import TripDocumentUpload from './TripDocumentUpload'
import TruckDocumentUpload from './TruckDocumentUpload'
import DriverDocumentUpload from './DriverDocumentUpload'

type props = {
    docs: any[]
    setDocs?: any
}

const isPdf = (fileName: string) => {
    return fileName?.toLowerCase().endsWith('.pdf');
};

const RecentDocuments: React.FC<props> = ({ docs, setDocs }) => {
    const isOtherpage = usePathname() === '/user/documents/otherDocuments'
    const [isModalOpen, setModalOpen] = useState(false)
    const [documentUrl, setDocumentUrl] = useState('')
    const [isMoveToTripModalOpen, setMoveToTripModalOpen] = useState(false)
    const [isMoveToTruckModalOpen, setMoveToTruckModalOpen] = useState(false)
    const [isMoveToDriverModalOpen, setMoveToDriverModalOpen] = useState(false)
    const [isMoveToCompanyModalOpen, setMoveToCompanyModalOpen] = useState(false)
    const [selectedDocId, setSelectedDocId] = useState('')
    const { toast } = useToast()

    const handlePreview = (url: string) => {
        setDocumentUrl(url)
        setModalOpen(true)
    }

    const handleMoveToTripDocument = (id: string) => {
        setSelectedDocId(id)
        setMoveToTripModalOpen(true)
    }
    const handleMoveToTruckDocument = (id: string) => {
        setSelectedDocId(id)
        setMoveToTruckModalOpen(true)
    }
    const handleMoveToDriverDocument = (id: string) => {
        setSelectedDocId(id)
        setMoveToDriverModalOpen(true)
    }
    const handleMoveToCompanyDocument = (id: string) => {
        setSelectedDocId(id)
        setMoveToCompanyModalOpen(true)
    }

    const handleDownload = async (documentUrl: string) => {
        try {
            const response = await fetch(documentUrl.split('.pdf')[0]);
            const blob = await response.blob();
            const blobUrl = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = blobUrl;
            link.setAttribute('download', documentUrl.split('/').pop() || 'file');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(blobUrl);
        } catch (error) {
            toast({
                description: 'Failed to download document',
                variant: 'destructive'
            })
            console.error('Error downloading the file:', error);
        }
    };

    const handleMove = (docId: string, destination: string) => {
        // Implement the logic to move the document
        console.log(`Moving document ${docId} to ${destination}`)
    }

    return (
        <div className="py-2 px-1 rounded-lg shadow-sm border-2 border-gray-300">
            <table className="min-w-full table-auto border-collapse border border-gray-200 rounded-xl">
                <thead>
                    <tr className="bg-gray-200">
                        <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600">Name</th>
                        <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600">Type</th>
                        <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600">Date Uploaded</th>
                        <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600">Validity Date</th>
                        <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600"></th>
                    </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-100">
                    {docs?.map((doc: any, index: number) => (
                        doc.url &&
                        <tr key={index} className="hover:bg-gray-50">
                            <td className="py-2 px-3 border-b border-gray-200 text-sm">
                                <div className="flex items-center space-x-3">
                                    <div className="flex-shrink-0"><RenderDocument documentUrl={doc.url} /></div>
                                    <div className="flex flex-col space-y-1 max-w-md">
                                        <p className="font-semibold text-gray-800">{doc.filename}</p>
                                        {doc.trip_id && (
                                            <div className="text-xs text-gray-600">
                                                <p><span className="font-medium">LR:</span> {doc.LR}</p>
                                                <p><span className="font-medium">Truck:</span> {doc.truck}</p>
                                                <p><span className="font-medium">Route:</span> {doc.route.origin} &rarr; {doc.route.destination}</p>
                                                <p><span className="font-medium">Start Date:</span> {new Date(doc.startDate).toLocaleDateString()}</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </td>
                            <td className="py-2 px-3 text-sm text-gray-500 border-b border-gray-200">{doc.type}</td>
                            <td className="py-2 px-3 text-sm text-gray-500 border-b border-gray-200">{new Date(doc.uploadedDate).toLocaleDateString('en-IN')}</td>
                            <td className="py-2 px-3 text-sm text-gray-500 border-b border-gray-200">
                                {doc.validityDate ? new Date(doc.validityDate).toLocaleDateString('en-IN') : 'NA'}
                            </td>
                            <td className="py-2 px-3 text-sm text-gray-500 border-b border-gray-200">
                                <DropdownMenu>
                                    <DropdownMenuTrigger asChild>
                                        <Button variant="ghost" className="h-8 w-8 p-0">
                                            <span className="sr-only">Open menu</span>
                                            <EllipsisVertical className="h-4 w-4" />
                                        </Button>
                                    </DropdownMenuTrigger>
                                    <DropdownMenuContent align="end">
                                        <DropdownMenuItem onClick={() => handlePreview(doc.url)}>
                                            <Eye className="mr-2 h-4 w-4" />
                                            <span>Preview</span>
                                        </DropdownMenuItem>
                                        <DropdownMenuItem onClick={() => handleDownload(doc.url)}>
                                            <Download className="mr-2 h-4 w-4" />
                                            <span>Download</span>
                                        </DropdownMenuItem>
                                        {isOtherpage && (
                                            <>
                                                <DropdownMenuSeparator />
                                                <DropdownMenuLabel>Move to</DropdownMenuLabel>
                                                <DropdownMenuItem onClick={() => handleMoveToTripDocument(doc._id)}>
                                                    <FolderInput className="mr-2 h-4 w-4" />
                                                    <span>Trip Document</span>
                                                </DropdownMenuItem>
                                                <DropdownMenuItem onClick={() => handleMoveToCompanyDocument(doc._id)}>
                                                    <FolderInput className="mr-2 h-4 w-4" />
                                                    <span>Company Document</span>
                                                </DropdownMenuItem>
                                                <DropdownMenuItem onClick={() => handleMoveToDriverDocument(doc._id)}>
                                                    <FolderInput className="mr-2 h-4 w-4" />
                                                    <span>Driver Document</span>
                                                </DropdownMenuItem>
                                                <DropdownMenuItem onClick={() => handleMoveToTruckDocument(doc._id)}>
                                                    <FolderInput className="mr-2 h-4 w-4" />
                                                    <span>Lorry Document</span>
                                                </DropdownMenuItem>
                                            </>
                                        )}
                                    </DropdownMenuContent>
                                </DropdownMenu>
                            </td>
                        </tr>
                    ))}
                </tbody>
            </table>

            <Dialog open={isModalOpen} onOpenChange={setModalOpen}>
                <DialogContent className="sm:max-w-[80vw]">
                    <div className="h-[70vh] overflow-auto">
                        {isPdf(documentUrl) ? (
                            <iframe
                                src={documentUrl.split('.pdf')[0]}
                                className="w-full h-full"
                                title="Full PDF Preview"
                            />
                        ) : (
                            <Image
                                src={documentUrl}
                                alt='Full document preview'
                                className="rounded-md object-cover w-full h-auto"
                                height={600}
                                width={600}
                            />
                        )}
                    </div>
                    <div className="mt-4 flex justify-end">
                        <Button onClick={() => handleDownload(documentUrl)}>
                            Download
                        </Button>
                    </div>
                </DialogContent>
            </Dialog>

            <Dialog open={isMoveToTripModalOpen} onOpenChange={setMoveToTripModalOpen}>
                <DialogContent className='p-0'>
                    <TripDocumentUpload open={isMoveToTripModalOpen} setOpen={setMoveToTripModalOpen} documentId={selectedDocId} setDocuments={setDocs} />
                </DialogContent>
            </Dialog>

            <Dialog open={isMoveToTruckModalOpen} onOpenChange={setMoveToTruckModalOpen}>
                <DialogContent className='p-0'>
                    <TruckDocumentUpload open={isMoveToTruckModalOpen} setOpen={setMoveToTruckModalOpen} documentId={selectedDocId} setDocuments={setDocs} />
                </DialogContent>
            </Dialog>

            <Dialog open={isMoveToDriverModalOpen} onOpenChange={setMoveToDriverModalOpen}>
                <DialogContent className='p-0'>
                    <DriverDocumentUpload open={isMoveToDriverModalOpen} setOpen={setMoveToDriverModalOpen} documentId={selectedDocId} setDocuments={setDocs} />
                </DialogContent>
            </Dialog>

        </div>
    )
}

export default RecentDocuments
</file>

<file path="src/components/documents/TripDocumentUpload.tsx">
import { useMemo, useState } from 'react';
import { Button } from '../ui/button';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '../ui/select';
import { motion } from 'framer-motion'
import { usePathname, useRouter } from 'next/navigation';
import { createWorker } from 'tesseract.js';
import { getDocType } from '@/helpers/ImageOperation';
import { extractLatestDate } from '@/helpers/ImageOperation';
import { mutate } from 'swr';
import { statuses } from '@/utils/schema';
import { Loader2 } from 'lucide-react';
import SingleFileUploader from '../SingleFileUploader';
import { useToast } from '../hooks/use-toast';
import { useExpenseData } from '../hooks/useExpenseData';

interface DocumentForm {
    filename: string;
    validityDate: string;  // ISO string for the date input
    docType: string;
    file: File | null;
    tripId: string;

}

type Props = {
    open: boolean;
    tripId?: string;
    setOpen: (open: boolean) => void;
    setTrip?: any
    documentId?: string
    setDocuments?: any
};

const TripDocumentUpload: React.FC<Props> = ({ open, setOpen, tripId, setTrip, documentId, setDocuments }) => {
    const { trips } = useExpenseData()
    const { toast } = useToast()
    const [formData, setFormData] = useState<DocumentForm>({
        filename: '',
        validityDate: new Date().toISOString().split('T')[0],
        docType: '',
        file: null,
        tripId: tripId || ''
    });

    const isOtherPage = usePathname() === '/user/documents/otherDocuments'
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');
    const [successMessage, setSuccessMessage] = useState('');
    const [searchTerm, setSearchTerm] = useState('');
    const router = useRouter()

    // Filter trucks based on search term
    const filteredTrips = useMemo(() => {
        if (!trips || trips.length === 0) return []
        let filtered = [...trips]
        if (searchTerm) {
            const lowercaseQuery = searchTerm.toLowerCase()
            filtered = trips.filter((trip) =>
                trip.LR.toLowerCase().includes(lowercaseQuery) ||
                trip.partyName.toLowerCase().includes(lowercaseQuery) ||
                trip.route.origin.toLowerCase().includes(lowercaseQuery) ||
                trip.route.destination.toLowerCase().includes(lowercaseQuery) ||
                new Date(trip.startDate).toLocaleDateString().includes(lowercaseQuery) ||
                trip.amount.toString().includes(lowercaseQuery) ||
                trip.truckHireCost.toString().includes(lowercaseQuery) ||
                trip.balance.toString().includes(lowercaseQuery) ||
                trip.truck.toLowerCase().includes(lowercaseQuery)
            )
        }
        return filtered
    }, [trips, searchTerm])


    // Handle option selection for lorry (trip)
    const handleOptionSelect = (value: string) => {
        setFormData((prev) => ({ ...prev, tripId: value }));
    };


    // Handle input changes
    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
        const { name, value } = e.target;
        setFormData((prevFormData) => ({
            ...prevFormData,
            [name]: value,
        }));
    };

    const extractTextFromImage = async (file: File): Promise<string> => {
        const worker = await createWorker('eng');
        const { data: { text } } = await worker.recognize(file);
        await worker.terminate();
        return text;
    };

    // Handle file change
    const handleFileChange = async (file: File) => {
        // e.preventDefault()
        const fileData = new FormData();
        const types = new Set(['E-Way Bill', 'POD', 'Bilty'])
        if (file) {
            setFormData({
                ...formData,
                file: file,
                filename : file.name
            });

            fileData.append('file', file as File);
            setLoading(true);
            try {
                if (file.type.includes('image/')) {
                    const text = await extractTextFromImage(file);
                    const type = getDocType(text)
                    const validity: string = extractLatestDate(text) as any
                    setFormData((prev) => ({
                        ...prev,
                        filename: file.name,
                        docType: types.has(type) ? type : 'Other',
                        validityDate: new Date(validity || Date.now()).toISOString().split('T')[0]
                    }))
                    setLoading(false)
                    return
                } else {
                    const res = await fetch(`/api/documents/validate`, {
                        method: 'POST',
                        body: fileData,
                    });

                    setLoading(false);

                    if (!res.ok) {
                        toast({
                            description: 'Failed to get validity and docType. Please enter manually',
                            variant: 'destructive'
                        })
                        setError('Failed to get validity and docType. Please enter manually.');
                        return;
                    }

                    const data = await res.json();
                    if (data.status === 402) {
                        setError(data.error)
                        return
                    }
                    setFormData({
                        ...formData,
                        file: file,
                        filename: file.name,
                        validityDate: new Date(data.validity).toISOString().split('T')[0],
                        docType: types.has(data.docType) ? data.docType : 'Other',
                    });
                }
            } catch (error) {
                setLoading(false);
                toast({
                    description: 'Error occured while validating document',
                    variant: 'destructive'
                })
                setError('Error occurred while validating document.');
            }
        }
    };

    // Handle form submission
    const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault();

        if (!formData.file) {
            setError('Please upload a document.');
            return;
        }

        setLoading(true);
        setError('');
        setSuccessMessage('');

        const data = new FormData();
        data.append('file', formData.file);
        data.append('filename', formData.filename);
        data.append('validityDate', formData.validityDate);
        data.append('docType', formData.docType);

        try {
            const response = await fetch(`/api/trips/${tripId || formData.tripId}/documents`, {
                method: 'PUT',
                body: data,
            });

            setLoading(false);

            if (response.ok) {
                toast({
                    description: 'Documents uploaded successfully!',
                })
                setSuccessMessage('Document uploaded successfully!');
                setError('');
                setFormData({
                    filename: '',
                    validityDate: new Date().toISOString().split('T')[0],
                    docType: '',
                    file: null,
                    tripId: ''
                });
                setOpen(false)
                mutate('/api/documents/recent')
                const data = await response.json();
                if (setTrip) {
                    setTrip((prev: any) => ({
                        ...prev,
                        documents: data.documents
                    }))
                }
                router.refresh()
            } else {
                const errorData = await response.json();
                setError(errorData.message || 'Something went wrong.');
            }
        } catch (err) {
            setLoading(false);
            toast({
                description: 'Error uploading document',
                variant: 'destructive'
            })
            setError('Failed to upload document.');
        }
    };

    const handleMove = async (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault()
        setLoading(true)
        try {
            const res = await fetch(`/api/documents/${documentId}?movingto=trip`, {
                method: 'PATCH',
                body: JSON.stringify({
                    tripId: formData.tripId,
                    filename: formData.filename,
                    validityDate: new Date(formData.validityDate),
                    docType: formData.docType
                })
            })
            if (res.ok) {
                toast({
                    description: 'Document moved successfully!',
                    variant: 'default'
                })
                const data = await res.json();
            } else {
                toast({
                    description: 'Failed to move document!',
                    variant: 'destructive'
                })
            }
        } catch (error) {
            toast({
                description: 'Internal Server Error',
                variant: 'destructive'
            })
        }
        setOpen(false)
        setLoading(false)
        setDocuments((prev: any) => prev.filter((doc: any) => doc._id !== documentId))
    }

    if (!open) {
        return null;
    }

    return (
        <div
            className="modal-class"
        >
            <motion.div
                initial={{ opacity: 0, scale: 0.5 }}
                animate={{ opacity: 1, scale: 1 }}
                transition={{
                    duration: 0.5,
                    ease: [0, 0.71, 0.2, 1.01]
                }} className="w-full max-w-3xl mx-auto bg-white p-6 rounded-lg shadow-md flex flex-col">
                <h1 className="text-2xl font-semibold mb-4 text-black">{isOtherPage ? 'Moving to Trip Document' : 'Upload Document'}</h1>

                {/* Loading indicator */}


                {error && <p className="text-red-500 mb-4">{error}</p>}
                {successMessage && <p className="text-green-500 mb-4">{successMessage}</p>}

                <form onSubmit={isOtherPage ? handleMove : handleSubmit}>

                    {!isOtherPage && <SingleFileUploader onFileChange={handleFileChange} />}
                    {/* Lorry (trip) select */}
                    <div className="mb-4">
                        <label className="block text-sm text-gray-700">Trip*</label>
                        <Select name="tripId" defaultValue={formData.tripId} onValueChange={handleOptionSelect}>
                            <SelectTrigger className="w-full">
                                <SelectValue placeholder="Select Trip" />
                            </SelectTrigger>
                            <SelectContent>
                                <div className="p-2">
                                    <input
                                        type="text"
                                        placeholder="Search..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                </div>
                                {filteredTrips && filteredTrips.length > 0 ? (
                                    filteredTrips.map((trip) => (
                                        <SelectItem key={trip.trip_id} value={trip.trip_id}>
                                            <div className="flex items-center justify-between w-full p-2 space-x-4">

                                                {/* Display route origin to destination */}
                                                <span className="font-semibold text-gray-700 whitespace-nowrap">
                                                    {trip.route.origin.split(',')[0]} &rarr; {trip.route.destination.split(',')[0]}
                                                </span>

                                                {/* Status indicator with progress bar */}
                                                <div className="flex flex-col w-1/2 space-y-1">
                                                    {/* Status label */}
                                                    <span className="text-sm text-gray-600">
                                                        {statuses[trip.status as number]}
                                                    </span>

                                                    {/* Progress bar for status */}
                                                    <div className="relative w-full h-1 bg-gray-200 rounded">
                                                        <div
                                                            className={`absolute top-0 left-0 h-1 rounded transition-width duration-500 ${trip.status === 0
                                                                ? 'bg-red-500'
                                                                : trip.status === 1
                                                                    ? 'bg-yellow-500'
                                                                    : trip.status === 2
                                                                        ? 'bg-blue-500'
                                                                        : trip.status === 3
                                                                            ? 'bg-green-500'
                                                                            : 'bg-green-800'
                                                                }`}
                                                            style={{ width: `${(trip.status as number / 4) * 100}%` }}
                                                        />
                                                    </div>
                                                </div>

                                                {/* LR number */}
                                                <span className="text-sm text-gray-600 whitespace-nowrap">
                                                    {trip.LR}
                                                </span>

                                                {/* Start date */}
                                                <span className="text-sm text-gray-600 whitespace-nowrap">
                                                    {new Date(trip.startDate).toISOString().split('T')[0]}
                                                </span>

                                            </div>
                                        </SelectItem>

                                    ))
                                ) : (
                                    <div className="p-2 text-gray-500">No Trips found</div>
                                )}
                            </SelectContent>
                        </Select>
                    </div>

                    {/* File upload input */}
                    {/* <div className="mb-4">
                    <label className="block text-gray-700">Upload File(pdf)*</label>
                    <input
                        type="file"
                        name="file"
                        onChange={handleFileChange}
                        className="w-full mt-1 p-2 border rounded"
                        accept="application/pdf, image/*"
                        required
                    />
                </div> */}


                    {/* Filename input */}
                    <div className="mb-4">
                        <label className="block text-gray-700">Filename</label>
                        <input
                            type="text"
                            name="filename"
                            value={formData.filename}
                            onChange={handleChange}
                            className="w-full mt-1 p-2 border rounded"
                            placeholder="(optional)"
                        />
                    </div>

                    {/* Document Type select */}
                    <div className="mb-4">
                        <label className="block text-gray-700">Document Type*</label>
                        <select
                            name="docType"
                            value={formData.docType}
                            onChange={handleChange}
                            required
                        >
                            <option value="">Select Document Type</option>
                            <option value="E-Way Bill">E-Way Bill</option>
                            <option value="POD">POD (Proof of Delivery)</option>
                            <option value="Bilty">Bilty</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    {/* Validity Date input */}
                    <div className="mb-4">
                        <label className="block text-gray-700">Validity Date*</label>
                        <input
                            type="date"
                            name="validityDate"
                            value={formData.validityDate}
                            onChange={handleChange}
                            className="w-full mt-1 p-2 border rounded"
                            required
                        />
                    </div>



                    {/* Submit button */}
                    <div className="flex items-center space-x-2 justify-end">
                        <Button type="submit" disabled={loading} >
                            {loading ? (
                                <div className="flex justify-center ">
                                    <Loader2 className='animate-spin text-white' />
                                </div>
                            ) : 'Submit'}
                        </Button>
                        <Button variant={'outline'} onClick={() => setOpen(false)} disabled={loading}>
                            Cancel
                        </Button>
                    </div>
                </form>
            </motion.div>
        </div>
    );
};

export default TripDocumentUpload;
</file>

<file path="src/components/documents/TruckDocumentUpload.tsx">
'use client'
import { useMemo, useState } from 'react';
import { Button } from '../ui/button';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '../ui/select';
import { motion } from 'framer-motion'
import { usePathname, useRouter } from 'next/navigation';
import { createWorker } from 'tesseract.js';
import { getDocType } from '@/helpers/ImageOperation';
import { extractLatestDate } from '@/helpers/ImageOperation';
import { Loader2 } from 'lucide-react';
import SingleFileUploader from '../SingleFileUploader';
import { useToast } from '../hooks/use-toast';
import { useExpenseData } from '../hooks/useExpenseData';

interface DocumentForm {
    filename: string;
    validityDate: string;  // ISO string for the date input
    docType: string;
    file: File | null;
    truckNo: string;
}

type Props = {
    open: boolean;
    truckNo?: string;
    setOpen: (open: boolean) => void;
    documentId?: string;
    setDocuments?: any
    setTruck?: any
};

const TruckDocumentUpload: React.FC<Props> = ({ open, setOpen, truckNo, documentId, setDocuments, setTruck }) => {
    const { trucks, refetchRecentDocuments } = useExpenseData()
    const [formData, setFormData] = useState<DocumentForm>({
        filename: '',
        validityDate: new Date().toISOString().split('T')[0],
        docType: '',
        file: null,
        truckNo: truckNo || ''
    });

    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');
    const [successMessage, setSuccessMessage] = useState('');
    const [searchTerm, setSearchTerm] = useState('');
    const router = useRouter()
    const { toast } = useToast();
    const isOtherPage = usePathname() === '/user/documents/otherDocuments'
    // Filter trucks based on search term

    const filteredTrucks = useMemo(() => {
        if (!trucks || trucks.length === 0) return []
        let filtered = [...trucks]
        if (searchTerm) {
            let lowercaseQuery = searchTerm.toLocaleLowerCase()
            filtered = trucks.filter((truck) =>
                truck.truckNo.toLowerCase().includes(lowercaseQuery) ||
                truck.truckType.toLowerCase().includes(lowercaseQuery) ||
                truck.status.toLowerCase().includes(lowercaseQuery) ||
                truck.ownership.toLowerCase().includes(lowercaseQuery)
            )

        }
        return filtered
    }, [trucks, searchTerm])



    // Handle option selection for lorry (trip)
    const handleOptionSelect = (value: string) => {
        setFormData((prev) => ({ ...prev, truckNo: value }));
    };


    // Handle input changes
    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
        const { name, value } = e.target;
        setFormData((prevFormData) => ({
            ...prevFormData,
            [name]: value,
        }));
    };

    const extractTextFromImage = async (file: File): Promise<string> => {
        const worker = await createWorker('eng');
        const { data: { text } } = await worker.recognize(file);
        await worker.terminate();
        return text;
    };

    // Handle file change
    const handleFileChange = async (file: File) => {
        // e.preventDefault(); // prevent any accidental form submission due to file input change

        const types = new Set(['License', 'Aadhar', 'PAN', 'Police Verification'])

        const fileData = new FormData();
        if (file) {
            setFormData({
                ...formData,
                filename: file.name,
                file: file,
            });

            fileData.append('file', file as File);
            setLoading(true);
            try {
                if (file.type.includes('image/')) {
                    const text = await extractTextFromImage(file);
                    const type = getDocType(text);
                    const validity: string = extractLatestDate(text) as any;
                    setFormData((prev) => ({
                        ...prev,
                        filename: file.name,
                        docType: types.has(type) ? type : 'Other',
                        validityDate: new Date(validity || Date.now()).toISOString().split('T')[0]
                    }));
                    setLoading(false);
                    return;
                } else {
                    const res = await fetch(`/api/documents/validate`, {
                        method: 'POST',
                        body: fileData,
                    });

                    setLoading(false);

                    if (!res.ok) {
                        toast({
                            description: 'Failed to get validity and docType. Please enter manually.',
                            variant: 'destructive'
                        })
                        setError('Failed to get validity and docType. Please enter manually.');
                        return;
                    }

                    const data = await res.json();
                    if (data.status === 402) {
                        setError(data.error);
                        return;
                    }
                    setFormData({
                        ...formData,
                        file: file,
                        validityDate: new Date(data.validity).toISOString().split('T')[0],
                        docType: types.has(data.docType) ? data.docType : 'Other',
                    });
                }
            } catch (error) {
                setLoading(false);
                toast({
                    description: 'Failed to get validity and docType. Please enter manually.',
                    variant: 'destructive'
                })
                setError('Error occurred while validating document. Please enter manually.');
            }
        }
    };

    // Handle form submission
    const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault();

        if (!formData.file) {
            setError('Please upload a document.');
            return;
        }

        setLoading(true);
        setError('');
        setSuccessMessage('');

        const data = new FormData();
        data.append('file', formData.file);
        data.append('filename', formData.filename);
        data.append('validityDate', formData.validityDate);
        data.append('docType', formData.docType);

        try {
            const response = await fetch(`/api/trucks/${truckNo || formData.truckNo}/documents`, {
                method: 'PUT',
                body: data,
            });

            setLoading(false);

            if (response.ok) {
                toast({
                    description: 'Documents uploaded successfully!',
                })
                setSuccessMessage('Document uploaded successfully!');
                setError('');
                setFormData({
                    filename: '',
                    validityDate: new Date().toISOString().split('T')[0],
                    docType: '',
                    file: null,
                    truckNo: ''
                });
                setOpen(false)
                refetchRecentDocuments()
                const data = await response.json()
                if (setDocuments) {
                    setDocuments((prev: any) => [data.document, ...prev])
                } else if (setTruck) {
                    setTruck((prev: any) => ({
                        ...prev,
                        documents: [data.document, ...prev.documents]
                    }))
                }
                toast({
                    description: 'Document uploaded successfully',
                    variant: 'default'
                })
            } else {
                const errorData = await response.json();
                toast({
                    description: 'Something went wrong.',
                    variant: 'destructive'
                })
                setError(errorData.message || 'Something went wrong.');
            }
        } catch (err) {
            setLoading(false);
            toast({
                description: 'Failed to upload document',
                variant: 'destructive'
            })
            setError('Failed to upload document.');
        }
    };

    const handleMove = async (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault()
        setLoading(true)
        try {
            const res = await fetch(`/api/documents/${documentId}?movingto=truck`, {
                method: 'PATCH',
                body: JSON.stringify({
                    truckNo: formData.truckNo,
                    filename: formData.filename,
                    validityDate: new Date(formData.validityDate),
                    docType: formData.docType
                })
            })
            if (res.ok) {
                toast({
                    description: 'Document moved successfully!',
                    variant: 'default'
                })
                const data = await res.json();
            } else {
                toast({
                    description: 'Failed to move document!',
                    variant: 'destructive'
                })
            }
        } catch (error) {
            toast({
                description: 'Internal Server Error',
                variant: 'destructive'
            })
        }
        setOpen(false)
        setLoading(false)
        setDocuments((prev: any) => prev.filter((doc: any) => doc._id !== documentId))
    }

    if (!open) {
        return null;
    }

    return (
        <div className='modal-class'>


            <motion.div
                initial={{ opacity: 0, scale: 0.5 }}
                animate={{ opacity: 1, scale: 1 }}
                transition={{
                    duration: 0.5,
                    ease: [0, 0.71, 0.2, 1.01]
                }} className="w-full max-w-3xl mx-auto bg-white p-6 rounded-lg shadow-md flex flex-col">
                <h1 className="text-2xl font-semibold mb-4 text-black">{isOtherPage ? 'Moving to Truck Document' : 'Upload Document'}</h1>

                {/* Loading indicator */}


                {error && <p className="text-red-500 mb-4">{error}</p>}
                {successMessage && <p className="text-green-500 mb-4">{successMessage}</p>}

                <form onSubmit={isOtherPage ? handleMove : handleSubmit}>
                    {!isOtherPage && <SingleFileUploader onFileChange={handleFileChange} />}
                    {/* Lorry (trip) select */}
                    <div className="mb-4">
                        <label className="block text-sm text-gray-700">Lorry*</label>
                        <Select name="truckNo" defaultValue={formData.truckNo} value={formData.truckNo} onValueChange={handleOptionSelect}>
                            <SelectTrigger className="w-full">
                                <SelectValue placeholder="Select Lorry" />
                            </SelectTrigger>
                            <SelectContent>
                                <div className="p-2">
                                    <input
                                        type="text"
                                        placeholder="Search..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                </div>
                                {filteredTrucks.length > 0 ? (
                                    filteredTrucks.map((truck) => (
                                        <SelectItem key={truck.truckNo} value={truck.truckNo}>
                                            <span>{truck.truckNo}</span>
                                            <span
                                                className={`ml-2 p-1 rounded ${truck.status === 'Available' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}
                                            >
                                                {truck.status}
                                            </span>
                                        </SelectItem>
                                    ))
                                ) : (
                                    <div className="p-2 text-gray-500">No lorries found</div>
                                )}
                            </SelectContent>
                        </Select>
                    </div>

                    {/* File upload input */}

                    {/* Filename input */}
                    <div className="mb-4">
                        <label className="block text-gray-700">Filename</label>
                        <input
                            type="text"
                            name="filename"
                            value={formData.filename}
                            onChange={handleChange}
                            className="w-full mt-1 p-2 border rounded"
                            placeholder="(optional)"
                        />
                    </div>

                    {/* Document Type select */}
                    <div className="mb-4">
                        <label className="block text-gray-700">Document Type*</label>
                        <select
                            name="docType"
                            value={formData.docType}
                            onChange={handleChange}
                            required
                        >
                            <option value="" disabled>Select Document Type</option>
                            <option value="Registration Certificate">Registration Certificate</option>
                            <option value="Permit">Permit</option>
                            <option value="Insurance">Insurance</option>
                            <option value="Pollution Certificate">Pollution Certificate</option>
                            <option value="Fitness Certificate">Fitness Certificate</option>
                            <option value="Tax">Tax</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    {/* Validity Date input */}
                    <div className="mb-4">
                        <label className="block text-gray-700">Validity Date*</label>
                        <input
                            type="date"
                            name="validityDate"
                            value={formData.validityDate}
                            onChange={handleChange}
                            className="w-full mt-1 p-2 border rounded"
                            required
                        />
                    </div>



                    {/* Submit button */}
                    <div className="flex items-center space-x-2 justify-end">
                        <Button type="submit" >
                            {loading ? (
                                <div className="flex justify-center ">
                                    <Loader2 className='animate-spin text-white' />
                                </div>
                            ) : 'Submit'}
                        </Button>
                        <Button variant={'outline'} onClick={() => setOpen(false)}>
                            Cancel
                        </Button>
                    </div>
                </form>
            </motion.div>
        </div>
    );
};

export default TruckDocumentUpload;
</file>

<file path="src/components/driver/driverActions.tsx">
import React from 'react';
import { Button } from '../ui/button';

interface DriverActionsProps {
  onGaveClick: () => void;
  onGotClick: () => void;
}

const DriverActions: React.FC<DriverActionsProps> = ({ onGaveClick, onGotClick }) => {
  return (
    <div className="mr-4 flex items-center gap-2">
      <Button
        variant={'destructive'}
        onClick={onGaveClick}
      >
        (-) Driver Gave
      </Button>
      <Button
        variant={'ghost'}
        onClick={onGotClick}
      >
        (+) Driver Got
      </Button>
    </div>
  );
};

export default DriverActions;
</file>

<file path="src/components/driver/DriverBalance.tsx">
import { formatNumber } from '@/utils/utilArray';
import React, { useState, useEffect } from 'react';
import { loadingIndicator } from '../ui/LoadingIndicator';

interface DriverNameProps {
    driverId: string;
}

const DriverBalance: React.FC<DriverNameProps> = ({ driverId }) => {
    const [loading, setLoading] = useState<boolean>(true);
    const [error, setError] = useState<boolean>(false);
    const [balance, setBalance] = useState<number>(0)

    useEffect(() => {
        const loadDriverBalance = async () => {
            try {
                const res = await fetch(`/api/drivers/${driverId}/calculateBalance`);
                const data = await res.json()
                const {total} = data
                setBalance(total);
            } catch (error: any) {
                setError(true);
            } finally {
                setLoading(false);
            }
        };
        loadDriverBalance();
    }, [driverId]);

    if (loading) return loadingIndicator;
    if (error || !balance) return <span>NA</span>;

    return <span className={balance > 0 ? 'text-green-500 p-2 font-semibold' : 'text-red-500 p-2 font-semibold'}>{formatNumber(balance) || ''}</span>;
};

export default DriverBalance;
</file>

<file path="src/components/driver/driverLayout.tsx">
"use client"

import type React from "react"
import { useState } from "react"
import { Calendar, FileText, Pencil, Truck, User } from "lucide-react"
import { usePathname, useRouter } from "next/navigation"
import { formatNumber } from "@/utils/utilArray"
import type { IDriver } from "@/utils/interface"

import { Button } from "@/components/ui/button"
import { Card, CardContent, CardHeader } from "@/components/ui/card"
import { Tabs, TabsList, TabsTrigger } from "@/components/ui/tabs"

import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from "@/components/ui/dropdown-menu"

import Loading from "@/app/user/loading"
import { useDriver } from "@/context/driverContext"
import dynamic from "next/dynamic"
import { useToast } from "../hooks/use-toast"

interface DriverLayoutProps {
  driverId: string
  onDriverUpdate: (driver: IDriver) => void
  children: React.ReactNode
}

const DriverModal = dynamic(() => import('@/components/driver/driverModal'), { ssr: false })
const EditDriverModal = dynamic(() => import('@/components/driver/editDriverModal'), { ssr: false })

export default function DriverLayout({ driverId, onDriverUpdate, children }: DriverLayoutProps) {
  const { driver, setDriver,loading } = useDriver()
  const [modalOpen, setModalOpen] = useState(false)
  const [modalType, setModalType] = useState<"gave" | "got" | null>(null)
  const [edit, setEdit] = useState(false)
  const {toast} = useToast()
  const router = useRouter()
  const pathname = usePathname()

  const closeModal = () => {
    setModalOpen(false);
    setModalType(null);
  };

  const handleConfirm = async (amount: number, reason: string, date: string) => {
    try {
      const response = await fetch(`/api/drivers/${driverId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          got: modalType === 'got' ? amount : 0,
          gave: modalType === 'gave' ? amount : 0,
          reason,
          date,
        }),
      });

      if (!response.ok) {
        throw new Error('Failed to update driver');
      }

      const data = await response.json();

      // Update the driver state
      setDriver((prev: any) => {
        const latestAccount = data.accounts[data.accounts.length - 1]; // Get the last account entry from the updated response
        const newBalance =
          prev.balance + (latestAccount.got || 0) - (latestAccount.gave || 0); // Update balance correctly

        return {
          ...prev,
          driverExpAccounts: [latestAccount, ...prev.driverExpAccounts], // Add the latest entry to the accounts
          balance: newBalance, // Set the updated balance
        };
      });

      closeModal(); // Close the modal after confirming
    } catch (error: any) {
      console.error('Failed to update driver:', error);
      // setError(error.message); // Set error message if something goes wrong
      toast({
        description: 'Internal Server Error',
        variant: 'destructive'
      })
    }
  };

  const handleEditDriver = async (updatedDriver: Partial<IDriver>) => {

    try {
      const response = await fetch(`/api/drivers/${driverId}`, {
        method: 'PATCH', // Use PATCH to partially update the driver
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(updatedDriver),
      });

      if (!response.ok) {
        throw new Error('Failed to update driver');
      }
      const data = await response.json();

      setDriver((prev : IDriver)=>({
        ...prev,
        ...data.driver
      }))
      setEdit(false);
      toast({
        description: 'Driver Updated Successfully',
      })
    } catch (error: any) {
      toast({
        description: 'Internal Server Error',
        variant: 'destructive'
      })
    }
  };

  const handleDeleteDriver = async () => {
    try {
      const response = await fetch(`/api/drivers/${driverId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
      });

      const data = await response.json();
      if (!response.ok) {
        if (response.status === 400) {
          alert(data.message);
          return;
        }
        throw new Error(data.message || 'Failed to delete driver');
      }

      alert('Driver Removed Successfully');
      router.push('/user/drivers');
    } catch (error: any) {
      console.error('Failed to delete driver:', error);
      toast({
        description: 'Internal Server Error',
        variant: 'destructive'
      })
      // setError(error.message);
    }
  };



  const tabs = [
    { icon: <Truck className="h-4 w-4" />, name: "Driver Accounts", path: `/user/drivers/${driverId}` },
    { icon: <Calendar className="h-4 w-4" />, name: "Trips", path: `/user/drivers/${driverId}/trips` },
    { icon: <FileText className="h-4 w-4" />, name: "Documents", path: `/user/drivers/${driverId}/documents` },
  ]

  if (loading) return <Loading />
  if (!driver) {
    return <div className="flex h-[50vh] items-center justify-center text-muted-foreground">Driver not found</div>
  }

  return (
    <div className="">
      <Card>
        <CardHeader className="pb-2">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <h1 className="text-xl font-semibold">{driver.name}</h1>
              <span className={`text-sm px-3 py-1 rounded-full ${driver.status === 'On Trip' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`}>{driver?.status}</span>
            </div>
            <div className="flex items-center gap-2">
              <Button
                variant="outline"
                size="sm"
                onClick={() => {
                  setModalOpen(true)
                  setModalType("got")
                }}
              >
                Got Money
              </Button>
              <Button
                variant="outline"
                size="sm"
                onClick={() => {
                  setModalOpen(true)
                  setModalType("gave")
                }}
              >
                Gave Money
              </Button>
              <Button variant={'ghost'} onClick={() => setEdit(true)}>
                <Pencil size={15} />
              </Button>
            </div>
          </div>
        </CardHeader>
        <CardContent>
          <div className="grid gap-2 text-sm text-muted-foreground">
            <div className="grid grid-cols-2 gap-4 sm:grid-cols-4">
              <div>
                <div className="font-medium text-foreground">Contact</div>
                {driver.contactNumber}
              </div>
              <div>
                <div className="font-medium text-foreground">License No</div>
                {driver.licenseNo}
              </div>
              <div>
                <div className="font-medium text-foreground">Aadhar No</div>
                {driver.aadharNo}
              </div>
              <div>
                <div className="font-medium text-foreground">Last Joining</div>
                {new Date(driver.lastJoiningDate).toLocaleDateString("en-IN")}
              </div>
            </div>
            <div className="mt-4 flex items-center gap-2 text-lg">
              <span className="font-medium">Balance:</span>
              <span className={driver.balance >= 0 ? "text-success" : "text-destructive"}>
                {formatNumber(Math.abs(driver.balance))}
              </span>
            </div>
          </div>
        </CardContent>
      </Card>

      <div className="flex border-b-2 border-lightOrange mb-4 mt-2 overflow-x-auto">
        {tabs.map((tab) => (
          <a
            key={tab.name}
            href={tab.path}
            className={`px-4 py-2 font-semibold rounded-t-md transition-all duration-300 ${pathname === tab.path ? 'border-b-2 border-lightOrange text-buttonTextColor bg-lightOrange' : 'hover:bg-lightOrangeButtonColor'}`}
          >
            <div className="flex items-center space-x-2">{tab.icon}<span>{tab.name}</span></div>
          </a>
        ))}
      </div>

      <div className="mt-4">{children}</div>

      <DriverModal
        open={modalOpen}
        onClose={() => setModalOpen(false)}
        type={modalType}
        onConfirm={handleConfirm}
      />

      {edit && (
        <EditDriverModal
          driverId={driverId}
          onCancel={() => setEdit(false)}
          handleEdit={handleEditDriver}
          name={driver.name}
          contactNumber={driver.contactNumber}
        />
      )}
    </div>
  )
}
</file>

<file path="src/components/driver/driverModal.tsx">
import React, { useEffect, useState } from 'react';
import { driverGave, driverGot } from '@/utils/utilArray';
import { Button } from '../ui/button';
import { useToast } from '@/components/hooks/use-toast';
import { motion } from 'framer-motion';

interface DriverModalProps {
  open: boolean;
  onClose: () => void;
  type: 'gave' | 'got' | null;
  onConfirm: any;
  selected?: any;
}

const DriverModal: React.FC<DriverModalProps> = ({ open, onClose, type, onConfirm, selected }) => {
  const [amount, setAmount] = useState<number>(0);
  const [reason, setReason] = useState<string>('');
  const [date, setDate] = useState<string>(new Date().toISOString().split('T')[0]); // Store date in ISO format
  const [otherReason, setOtherReason] = useState<string>('');
  const { toast } = useToast();

  useEffect(() => {
    if (selected) {
      setAmount(selected.gave ? selected.gave : selected.got || 0);
      setReason(selected.reason || '');
      setDate(selected.date ? new Date(selected.date).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]);
      setOtherReason('');
    }
  }, [selected]);

  const handleConfirm = () => {
    const finalReason = reason === 'Other' ? otherReason : reason;

    if (!amount || !finalReason || !date) {
      toast({
        'description': 'Please fill all the detials',
        variant: 'warning'
      })

      if (amount <= 0) {
        toast({
          description: 'Amount not acceptable',
          variant: 'warning'
        })
      }

      return;
    }

    if (selected) {
      onConfirm({
        gave: selected.gave ? amount : 0,
        got: selected.got ? amount : 0,
        reason: finalReason,
        date: date,
      });
    } else {
      onConfirm(amount, finalReason, date);
    }

    onClose();
    setAmount(0);
    setReason('');
    setOtherReason('');
    setDate(new Date().toISOString().split('T')[0]);
  };

  const handleCancel = () => {
    onClose();
  };

  const reasonOptions = type === 'gave' ? driverGave : driverGot;

  if (!open) {
    return null
  }

  return (
    <div className="modal-class">
      <motion.div
        initial={{ opacity: 0, scale: 0.5 }}
        animate={{ opacity: 1, scale: 1 }}
        transition={{
          duration: 0.5,
          ease: [0, 0.71, 0.2, 1.01]
        }}
        className="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl max-h-[700px] overflow-y-auto thin-scrollbar"
      >
    
          <h2 className="text-xl font-bold mb-4">{type === 'gave' ? 'Driver Gave' : 'Driver Got'}</h2>
          <form>
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700">Amount*</label>
              <input
                type="number"
                className="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50"
                value={amount}
                onChange={(e) => setAmount(Number(e.target.value))}
                required
              />
            </div>
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700">Reason*</label>
              <select
                className="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50"
                value={reason}
                onChange={(e) => setReason(e.target.value)}
                required
              >
                <option value="" disabled>Select a reason</option>
                {reasonOptions.map((option) => (
                  <option key={option} value={option}>
                    {option}
                  </option>
                ))}
              </select>
              {reason === 'Other' && (
                <input
                  type="text"
                  className="mt-2 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50"
                  placeholder="Enter other reason"
                  value={otherReason}
                  onChange={(e) => setOtherReason(e.target.value)}
                  required
                />
              )}
            </div>
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700">Date*</label>
              <input
                type="date"
                className="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50"
                value={date} // Ensure date is in ISO format 'YYYY-MM-DD'
                onChange={(e) => setDate(e.target.value)}
                required
              />
            </div>
            <div className="flex justify-end gap-2">
              <Button onClick={handleConfirm}>Confirm</Button>
              <Button
                variant={'outline'}
                onClick={handleCancel}
              >
                Cancel
              </Button>
            </div>
          </form>
      </motion.div>
    </div>
  )
};

export default DriverModal;
</file>

<file path="src/components/driver/DriverName.tsx">
import React, { useState, useEffect } from 'react';
import { fetchDriverName } from '@/helpers/driverOperations';

interface DriverNameProps {
    driverId: string;
}

const DriverName: React.FC<DriverNameProps> = ({ driverId }) => {
    const [loading, setLoading] = useState<boolean>(true);
    const [error, setError] = useState<boolean>(false);
    const [driverName, setDriverName] = useState<string>('')

    useEffect(() => {
        const LoadDriverName = async () => {
            try {
                const name = await fetchDriverName(driverId);
                console.log(name)
                if (!name) {
                    throw new Error('Name not found');
                }
                setDriverName(name);
            } catch (error: any) {
                setError(true);
            } finally {
                setLoading(false);
            }
        };
        LoadDriverName();
    }, [driverId]);

    if (loading) return <span>Loading...</span>;
    if (error || !driverName) return <span>NA</span>;

    return <span>{driverName}</span>;
};

export default DriverName;
</file>

<file path="src/components/driver/dropdownMenu.tsx">
import React from 'react';
import { MdDeleteForever, MdEdit } from "react-icons/md";
import { Button } from '../ui/button';
import { motion } from 'framer-motion';

interface DropdownMenuProps {
  onEditClick: () => void;
  onDeleteClick: () => void;
}

const DropdownMenu: React.FC<DropdownMenuProps> = ({ onEditClick, onDeleteClick }) => {
  const [dropdownOpen, setDropdownOpen] = React.useState(false);

  return (
    <div className="relative">
      <Button
        onClick={() => setDropdownOpen(!dropdownOpen)}
      >
        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path
            fillRule="evenodd"
            d="M10 12a2 2 0 100-4 2 2 0 000 4zM10 2a2 2 0 100 4 2 2 0 000-4zm0 16a2 2 0 100-4 2 2 0 000 4z"
            clipRule="evenodd"
          />
        </svg>
      </Button>
      {dropdownOpen && (
        <motion.div
        initial={{ opacity: 0, y: -10 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.2 }} className="absolute right-0 mt-2 w-48 bg-white shadow-lg rounded-md flex flex-col gap-2 p-2 z-10">
          <Button
            variant={'ghost'}
            onClick={onEditClick}
          >
            <MdEdit style={{ width: '20px', height: '20px' }} /> Edit
          </Button>
          {/* <Button
            variant={'destructive'}
            onClick={onDeleteClick}
          >
            <MdDeleteForever style={{ width: '20px', height: '20px' }} /> Delete
          </Button> */}
        </motion.div>
      )}
    </div>
  );
};

export default DropdownMenu;
</file>

<file path="src/components/driver/editDriverModal.tsx">
// components/EditDriverModal.tsx
import React, { useState } from 'react';
import { IDriver } from '@/utils/interface';
import { isValidPhone } from '@/utils/validate';
import { Button } from '../ui/button';
import { useDriver } from '@/context/driverContext';
import { motion } from 'framer-motion';
import { Loader2 } from 'lucide-react';

interface EditDriverModalProps {
  name: string;
  driverId: string;
  handleEdit: (data: Partial<IDriver>) => void;
  onCancel: () => void;
  contactNumber: string
}

const EditDriverModal: React.FC<EditDriverModalProps> = ({ name, driverId, handleEdit, onCancel, contactNumber }) => {
  const { driver, setDriver } = useDriver()
  const [formData, setFormData] = useState({
    name: driver.name || "",
    contactNumber: driver.contactNumber || "",
    licenseNo: driver.licenseNo || "",
    aadharNo: driver.aadharNo || '',
    lastJoiningDate: new Date(driver.lastJoiningDate || Date.now())
  })

  const [saving, setSaving]= useState(false)

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setFormData((prev) => ({
      ...prev,
      [e.target.name]: e.target.value
    }))
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault(); // Prevent default form submission
    if (!isValidPhone(formData.contactNumber)) {
      alert('Enter a Valid Phone')
      return
    }
    setSaving(true)
    handleEdit(formData);
  };

  return (
    <div className="modal-class">
      <motion.div
        initial={{ opacity: 0, scale: 0.5 }}
        animate={{ opacity: 1, scale: 1 }}
        transition={{
          duration: 0.5,
          ease: [0, 0.71, 0.2, 1.01]
        }}
        className="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl max-h-[700px] overflow-y-auto thin-scrollbar"
      >
          <h2 className="text-2xl mb-4">Edit Driver</h2>
          <form onSubmit={handleSubmit}>
            <div className="mb-4">
              <label className="block text-gray-700">Name</label>
              <input
                type="text"
                name='name'
                value={formData.name}
                onChange={handleChange}
              />
            </div>
            <div className="mb-4">
              <label className="block text-gray-700">Mobile Number</label>
              <input
                type="text"
                name='contactNumber'
                value={formData.contactNumber}
                onChange={handleChange}
              />
            </div>
            <label className="block mb-2">
              Aadhar Number
              <input
                type="text"
                name="aadharNo"
                value={formData.aadharNo}
                onChange={handleChange}
                className="block w-full p-2 mt-1 border border-gray-300 rounded-md"
              />
            </label>
            <label className="block mb-2">
              License Number
              <input
                type="text"
                name="licenseNo"
                value={formData.licenseNo}
                onChange={handleChange}
                className="block w-full p-2 mt-1 border border-gray-300 rounded-md"
              />
            </label>
            <label className="block mb-2">
              Last Joining Date
              <input
                type="date"
                name="lastJoiningDate"
                value={new Date(formData.lastJoiningDate).toISOString().split('T')[0]}
                onChange={handleChange}
                className="block w-full p-2 mt-1 border border-gray-300 rounded-md"
              />
            </label>
            <div className="flex justify-end space-x-2">
              <Button
                type="button"
                variant={'outline'}
                onClick={() => {
                  onCancel()
                }} // Reset name field to original value on cancel
              >
                Cancel
              </Button>
              <Button
                type="submit"
                disabled={saving}
              >
                {saving ? <Loader2 className='text-white animate-spin' /> : 'Save'}
              </Button>
            </div>
          </form>
      </motion.div>
    </div>
  );
};

export default EditDriverModal;
</file>

<file path="src/components/ExpenseFilterModal.tsx">
'use client'

import React, { useState, useMemo, useCallback, useEffect, useRef } from 'react'
import { usePathname } from 'next/navigation'
import { motion } from 'framer-motion'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Checkbox } from '@/components/ui/checkbox'
import { useExpenseCtx } from '@/context/context'
import { fuelAndDriverChargeTypes, maintenanceChargeTypes, officeExpenseTypes } from '@/utils/utilArray'
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from './ui/tooltip'
import { useToast } from './hooks/use-toast'

type Props = {
    monthYearOptions: string[]
    paymentModes: string[]
    onClose: () => void
    isOpen: boolean
    handleFilter: (filter: any) => void
}

const ExpenseFilterModal: React.FC<Props> = ({ onClose, isOpen, monthYearOptions, paymentModes, handleFilter }) => {
    const { trips, drivers, shops, trucks } = useExpenseCtx()
    const pathname = usePathname()
    const modalRef = useRef<HTMLDivElement | null>(null)
    const [userExpenseTypes, setUserExpenseTypes] = useState<string[]>([])
    const {toast} = useToast()

        const fetchUserExpenseTypes = async () => {
            try {
                const res = await fetch('/api/expenses/expenseType')
                const data = await res.json()
                setUserExpenseTypes(data.expenseTypes)
    
            } catch (error) {
                toast({
                    description: "Failed to fetch some expense types",
                    variant: "destructive"
                })
            }
        }
    
        useEffect(() => {
            fetchUserExpenseTypes()
        }, [])

    useEffect(() => {
        const handleClickOutside = (event: MouseEvent) => {
            if (modalRef.current && !modalRef.current.contains(event.target as Node)) {
                onClose(); // Close modal if clicked outside
            }
        };

        if (isOpen) {
            document.addEventListener('mousedown', handleClickOutside);
        }

        return () => {
            document.removeEventListener('mousedown', handleClickOutside);
        };
    }, [isOpen, onClose]);

    const [selectedFilters, setSelectedFilters] = useState({
        trucks: [] as string[],
        monthYear: [] as string[],
        paymentModes: [] as string[],
        drivers: [] as string[],
        shops: [] as string[],
        trips: [] as string[],
        expenseTypes: [] as string[]
    })

    const [searchQuery, setSearchQuery] = useState('')
    const [activeCategory, setActiveCategory] = useState('Month and Year')

    const filterCategories = useMemo(() => {
        let categories = ['Month and Year', 'Expense Type', 'Payment Mode', 'Shop']
        if (pathname !== '/user/expenses/officeExpense') {
            categories.unshift('Trucks', 'Driver')
        }
        if (pathname === '/user/expenses/tripExpense' || pathname === '/user/expenses') {
            categories.push('Trips')
        }
        return categories
    }, [pathname])

    const expenseTypes = useMemo(() => {
        if (pathname === '/user/expenses/tripExpense') {
            return Array.from(fuelAndDriverChargeTypes)
        } else if (pathname === '/user/expenses/truckExpense') {
            return Array.from(maintenanceChargeTypes)
        } else if (pathname === '/user/expenses/officeExpense') {
            return Array.from(officeExpenseTypes)
        } else {
            return [...fuelAndDriverChargeTypes, ...maintenanceChargeTypes, ...officeExpenseTypes,]
        }
    }, [pathname])

    const handleCheckboxChange = useCallback((category: string, value: string) => {
        setSelectedFilters(prev => ({
            ...prev,
            [category]: prev[category as keyof typeof selectedFilters].includes(value)
                ? prev[category as keyof typeof selectedFilters].filter(item => item !== value)
                : [...prev[category as keyof typeof selectedFilters], value]
        }))
    }, [])

    const filterItems = useCallback((items: any[], key: string) => {
        return items.filter(item =>
            item[key].toLowerCase().includes(searchQuery.toLowerCase())
        )
    }, [searchQuery])

    const handleSelectAll = useCallback((category: string, items: string[]) => {
        setSelectedFilters(prev => ({
            ...prev,
            [category]: prev[category as keyof typeof selectedFilters].length === items.length ? [] : items
        }))
    }, [])

    const isAllSelected = useCallback((category: string, items: string[]) => {
        return selectedFilters[category as keyof typeof selectedFilters].length === items.length
    }, [selectedFilters])

    if (!isOpen) return null

    return (
        <div className="modal-class">
            <motion.div
                initial={{ opacity: 0, scale: 0.5 }}
                animate={{ opacity: 1, scale: 1 }}
                transition={{ duration: 0.3, ease: [0, 0.71, 0.2, 1.01] }}
                className="bg-white rounded-lg shadow-lg p-6 w-full max-w-3xl max-h-[80vh] flex flex-col"
                ref={modalRef}
            >
                <div className="flex justify-between items-center border-b pb-2 mb-4">
                    <h2 className="text-lg font-semibold">Expense Filter</h2>
                    <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
                        &times;
                    </button>
                </div>

                <Input
                    type="text"
                    placeholder="Search..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="mb-4"
                />

                <div className="flex flex-col md:flex-row gap-4">
                    <div className="w-full md:w-1/4 space-y-2">
                        {filterCategories.map((category) => (
                            <Button
                                key={category}
                                variant={activeCategory === category ? "newyork" : "outline"}
                                className="w-full justify-start"
                                onClick={() => setActiveCategory(category)}
                            >
                                {category}
                            </Button>
                        ))}
                    </div>

                    <div className="w-full md:w-3/4 border rounded-lg p-4 max-h-[300px] overflow-y-auto thin-scrollbar">
                        {activeCategory === 'Trucks' && trucks && (
                            <>
                                <div className="flex items-center space-x-2 py-2 border-b mb-2">
                                    <Checkbox
                                        id="select-all-trucks"
                                        checked={isAllSelected('trucks', trucks.map(truck => truck.truckNo))}
                                        onCheckedChange={() => handleSelectAll('trucks', trucks.map(truck => truck.truckNo))}
                                    />
                                    <label htmlFor="select-all-trucks">Select All</label>
                                </div>
                                {filterItems(trucks, 'truckNo').map(truck => (
                                    <div key={truck.truckNo} className="flex items-center space-x-2 py-2">
                                        <Checkbox
                                            id={`truck-${truck.truckNo}`}
                                            checked={selectedFilters.trucks.includes(truck.truckNo)}
                                            onCheckedChange={() => handleCheckboxChange('trucks', truck.truckNo)}
                                        />
                                        <label htmlFor={`truck-${truck.truckNo}`}>{truck.truckNo}</label>
                                    </div>
                                ))}
                            </>
                        )}
                        {activeCategory === 'Month and Year' && (
                            <>
                                <div className="flex items-center space-x-2 py-2 border-b mb-2">
                                    <Checkbox
                                        id="select-all-month-year"
                                        checked={isAllSelected('monthYear', monthYearOptions)}
                                        onCheckedChange={() => handleSelectAll('monthYear', monthYearOptions)}
                                    />
                                    <label htmlFor="select-all-month-year">Select All</label>
                                </div>
                                {monthYearOptions.filter(monYear => monYear.toLowerCase().includes(searchQuery.toLowerCase())).map((monYear, index) => (
                                    <div key={index} className="flex items-center space-x-2 py-2">
                                        <Checkbox
                                            id={`month-year-${index}`}
                                            checked={selectedFilters.monthYear.includes(monYear)}
                                            onCheckedChange={() => handleCheckboxChange('monthYear', monYear)}
                                        />
                                        <label htmlFor={`month-year-${index}`}>{monYear}</label>
                                    </div>
                                ))}
                            </>
                        )}
                        {activeCategory === 'Payment Mode' && (
                            <>
                                <div className="flex items-center space-x-2 py-2 border-b mb-2">
                                    <Checkbox
                                        id="select-all-payment-modes"
                                        checked={isAllSelected('paymentModes', paymentModes)}
                                        onCheckedChange={() => handleSelectAll('paymentModes', paymentModes)}
                                    />
                                    <label htmlFor="select-all-payment-modes">Select All</label>
                                </div>
                                {paymentModes.filter(mode => mode.toLowerCase().includes(searchQuery.toLowerCase())).map((mode, index) => (
                                    <div key={index} className="flex items-center space-x-2 py-2">
                                        <Checkbox
                                            id={`payment-mode-${index}`}
                                            checked={selectedFilters.paymentModes.includes(mode)}
                                            onCheckedChange={() => handleCheckboxChange('paymentModes', mode)}
                                        />
                                        <label htmlFor={`payment-mode-${index}`}>{mode}</label>
                                    </div>
                                ))}
                            </>
                        )}
                        {activeCategory === 'Driver' && drivers && (
                            <>
                                <div className="flex items-center space-x-2 py-2 border-b mb-2">
                                    <Checkbox
                                        id="select-all-drivers"
                                        checked={isAllSelected('drivers', drivers.map(driver => driver.driver_id))}
                                        onCheckedChange={() => handleSelectAll('drivers', drivers.map(driver => driver.driver_id))}
                                    />
                                    <label htmlFor="select-all-drivers">Select All</label>
                                </div>
                                {filterItems(drivers, 'name').map(driver => (
                                    <div key={driver.driver_id} className="flex items-center space-x-2 py-2">
                                        <Checkbox
                                            id={`driver-${driver.driver_id}`}
                                            checked={selectedFilters.drivers.includes(driver.driver_id)}
                                            onCheckedChange={() => handleCheckboxChange('drivers', driver.driver_id)}
                                        />
                                        <label htmlFor={`driver-${driver.driver_id}`}>{driver.name}  {driver.contactNumber}</label>
                                    </div>
                                ))}
                            </>
                        )}
                        {activeCategory === 'Shop' && shops && (
                            <>
                                <div className="flex items-center space-x-2 py-2 border-b mb-2">
                                    <Checkbox
                                        id="select-all-shops"
                                        checked={isAllSelected('shops', shops.map(shop => shop.shop_id))}
                                        onCheckedChange={() => handleSelectAll('shops', shops.map(shop => shop.shop_id))}
                                    />
                                    <label htmlFor="select-all-shops">Select All</label>
                                </div>
                                {filterItems(shops, 'name').map(shop => (
                                    <div key={shop.shop_id} className="flex items-center space-x-2 py-2">
                                        <Checkbox
                                            id={`shop-${shop.shop_id}`}
                                            checked={selectedFilters.shops.includes(shop.shop_id)}
                                            onCheckedChange={() => handleCheckboxChange('shops', shop.shop_id)}
                                        />
                                        <label htmlFor={`shop-${shop.shop_id}`}>{shop.name}</label>
                                    </div>
                                ))}
                            </>
                        )}
                        {activeCategory === 'Trips' && trips && (
                            <>
                                <div className="flex items-center space-x-2 py-2 border-b mb-2">
                                    <Checkbox
                                        id="select-all-trips"
                                        checked={isAllSelected('trips', trips.map(trip => trip.trip_id))}
                                        onCheckedChange={() => handleSelectAll('trips', trips.map(trip => trip.trip_id))}
                                    />
                                    <label htmlFor="select-all-trips">Select All</label>
                                </div>
                                {filterItems(trips, 'LR').map(trip => (
                                    <div key={trip.trip_id} className="flex items-center space-x-2 py-2">
                                        <Checkbox
                                            id={`trip-${trip.trip_id}`}
                                            checked={selectedFilters.trips.includes(trip.trip_id)}
                                            onCheckedChange={() => handleCheckboxChange('trips', trip.trip_id)}
                                        />
                                        <label htmlFor={`trip-${trip.trip_id}`} className="flex-1 grid grid-cols-4 gap-2 items-center">
                                            <TooltipProvider>
                                                <Tooltip>
                                                    <TooltipTrigger asChild>
                                                        <p className="text-left truncate">{trip.LR}</p>
                                                    </TooltipTrigger>
                                                    <TooltipContent>
                                                        <p>{trip.LR}</p>
                                                    </TooltipContent>
                                                </Tooltip>
                                            </TooltipProvider>
                                            <TooltipProvider>
                                                <Tooltip>
                                                    <TooltipTrigger asChild>
                                                        <p className="text-left truncate">{trip.route.origin.split(',')[0]} &rarr; {trip.route.destination.split(',')[0]}</p>
                                                    </TooltipTrigger>
                                                    <TooltipContent>
                                                        <p>{trip.route.origin} &rarr; {trip.route.destination}</p>
                                                    </TooltipContent>
                                                </Tooltip>
                                            </TooltipProvider>
                                            <TooltipProvider>
                                                <Tooltip>
                                                    <TooltipTrigger asChild>
                                                        <p className="text-left truncate">{trip.truck}</p>
                                                    </TooltipTrigger>
                                                    <TooltipContent>
                                                        <p>{trip.truck}</p>
                                                    </TooltipContent>
                                                </Tooltip>
                                            </TooltipProvider>
                                            <TooltipProvider>
                                                <Tooltip>
                                                    <TooltipTrigger asChild>
                                                        <p className="text-left truncate">{new Date(trip.startDate).toLocaleDateString('en-IN')}</p>
                                                    </TooltipTrigger>
                                                    <TooltipContent>
                                                        <p>{new Date(trip.startDate).toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                                    </TooltipContent>
                                                </Tooltip>
                                            </TooltipProvider>
                                        </label>
                                    </div>
                                ))}
                            </>
                        )}

                        {activeCategory === 'Expense Type' && (
                            <>
                                <div className="flex items-center space-x-2 py-2 border-b mb-2">
                                    <Checkbox
                                        id="select-all-expense-types"
                                        checked={isAllSelected('expenseTypes', expenseTypes)}
                                        onCheckedChange={() => handleSelectAll('expenseTypes', expenseTypes)}
                                    />
                                    <label htmlFor="select-all-expense-types">Select All</label>
                                </div>
                                {userExpenseTypes.filter(type => type.toLowerCase().includes(searchQuery.toLowerCase())).map((expense, index) => (
                                    <div key={index} className="flex items-center space-x-2 py-2">
                                        <Checkbox
                                            id={`expense-type-${index}`}
                                            checked={selectedFilters.expenseTypes.includes(expense)}
                                            onCheckedChange={() => handleCheckboxChange('expenseTypes', expense)}
                                        />
                                        <label htmlFor={`expense-type-${index}`} className="whitespace-nowrap">{expense}</label>
                                    </div>
                                ))}
                                {expenseTypes.filter(type => type.toLowerCase().includes(searchQuery.toLowerCase())).map((expense, index) => (
                                    <div key={index} className="flex items-center space-x-2 py-2">
                                        <Checkbox
                                            id={`expense-type-${index}`}
                                            checked={selectedFilters.expenseTypes.includes(expense)}
                                            onCheckedChange={() => handleCheckboxChange('expenseTypes', expense)}
                                        />
                                        <label htmlFor={`expense-type-${index}`} className="whitespace-nowrap">{expense}</label>
                                    </div>
                                ))}
                            </>
                        )}
                    </div>
                </div>

                <div className="mt-6 flex justify-end space-x-4">
                    <Button variant="outline" onClick={onClose}>
                        Cancel
                    </Button>
                    <Button
                        onClick={() => {
                            handleFilter(selectedFilters)
                            onClose()
                        }}
                    >
                        Apply Filters
                    </Button>
                </div>
            </motion.div>
        </div>
    )
}

export default React.memo(ExpenseFilterModal)
</file>

<file path="src/components/ExpenseHeader.tsx">
import React from 'react'
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import {
  DropdownMenu,
  DropdownMenuCheckboxItem,
  DropdownMenuContent,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"
import { TbFilterSearch, TbPlus } from "react-icons/tb"

interface ExpenseHeaderProps {
  visibleColumns: Record<string, boolean>
  handleSelectAll: (checked: boolean) => void
  handleToggleColumn: (column: string | any) => void
  handleSearch: (event: React.ChangeEvent<HTMLInputElement>) => void
  sortedExpense: any[]
  setSelected: (value: any) => void
  setModalOpen: (value: boolean) => void
  setFilterModalOpen: (value: boolean) => void
}

export function ExpenseHeader({
  visibleColumns,
  handleSelectAll,
  handleToggleColumn,
  handleSearch,
  sortedExpense,
  setSelected,
  setModalOpen,
  setFilterModalOpen
}: ExpenseHeaderProps) {
  const totalAmount = sortedExpense.reduce((acc, exp) => acc + exp.amount, 0)
  return (
    <div className="flex items-center justify-between gap-4 bg-transparent p-4">
    <div className="flex items-center gap-4 flex-grow">
      <DropdownMenu>
        <DropdownMenuTrigger asChild>
          <Button variant="outline" size="sm">Columns</Button>
        </DropdownMenuTrigger>
        <DropdownMenuContent className="w-56">
          <DropdownMenuLabel>Visible Columns</DropdownMenuLabel>
          <DropdownMenuSeparator />
          <DropdownMenuCheckboxItem
            checked={Object.values(visibleColumns).every(Boolean)}
            onCheckedChange={handleSelectAll}
          >
            Select All
          </DropdownMenuCheckboxItem>
          {Object.entries(visibleColumns).map(([column, isVisible]) => (
            <DropdownMenuCheckboxItem
              key={column}
              checked={isVisible}
              onCheckedChange={() => handleToggleColumn(column as any)}
            >
              {column.charAt(0).toUpperCase() + column.slice(1)}
            </DropdownMenuCheckboxItem>
          ))}
        </DropdownMenuContent>
      </DropdownMenu>
      <input
        type="text"
        onChange={handleSearch}
        placeholder={`Search from ${sortedExpense.length} expenses...`}
        className="max-w-xs"
      />
      <div className="flex items-center gap-4 text-sm">
        <span className="font-medium text-lg">
          Total: <span className="text-red-600">{new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(totalAmount)}</span>
        </span>
      </div>
    </div>
    <div className="flex items-center gap-2">
      <Button
        size="sm"
        onClick={() => {
          setSelected(null)
          setModalOpen(true)
        }}
      >
        <TbPlus className="mr-2 h-4 w-4" /> Add
      </Button>
      <Button
        size="sm"
        variant="outline"
        onClick={() => setFilterModalOpen(true)}
      >
        <TbFilterSearch className="mr-2 h-4 w-4" /> Filter
      </Button>
    </div>
  </div>
  )
}
</file>

<file path="src/components/ExpenseProvider.tsx">
import React from 'react'
import { Provider } from 'react-redux'
import { store } from '../store/store'

type Props = {
  children: React.ReactNode
}

export const ExpenseProvider = ({ children }: Props) => {
  return <Provider store={store}>{children}</Provider>
}
</file>

<file path="src/components/ExpenseTable.tsx">
import React from 'react'
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from './ui/table';
import { IconKey } from '@/utils/icons';
import { formatNumber } from '@/utils/utilArray';
import { icons } from '@/utils/icons';
import { Button } from '@/components/ui/button';
import { FaCalendarAlt, FaTruck } from 'react-icons/fa';
import { MdEdit, MdDelete } from 'react-icons/md';
import { IExpense } from '@/utils/interface';
import { motion, AnimatePresence } from 'framer-motion';

type props = {
  expenses?: IExpense[] | any[],
  visibleColumns: { [key: string]: boolean },
  requestSort: (key: string) => void,
  getSortIcon: (key: string) => React.ReactNode,
  sortedExpense: IExpense[] | any[],
  setSelected: any
  setTruckExpenseBook: any
  setModalOpen: any
  handleDelete: any
}

const ExpenseTable: React.FC<props> = ({ expenses, visibleColumns, requestSort, getSortIcon, sortedExpense, setSelected, setModalOpen, setTruckExpenseBook, handleDelete }) => {
  return (

    <Table className="">
      <TableHeader>
        <TableRow className="">
          {visibleColumns.date && <TableHead onClick={() => requestSort('date')} className="">
            <div className='flex justify-between'>
              Date {getSortIcon('date')}
            </div>
          </TableHead>}
          {visibleColumns.amount && <TableHead onClick={() => requestSort('amount')} className="">
            <div className='flex justify-between'>
              Amount {getSortIcon('amount')}
            </div>
          </TableHead>}
          {visibleColumns.expenseType && <TableHead onClick={() => requestSort('expenseType')} className="">
            <div className='flex justify-between'>
              Expense Type {getSortIcon('expenseType')}
            </div>
          </TableHead>}
          {visibleColumns.ledger && <TableHead className="">
            <div className='flex justify-between'>
              Payment Mode
            </div>
          </TableHead>}
          {visibleColumns.notes && <TableHead onClick={() => requestSort('notes')} className="">
            <div className='flex justify-between'>
              Notes {getSortIcon('notes')}
            </div>
          </TableHead>}
          {visibleColumns.truck && <TableHead className="">
            <div className='flex justify-between'>
              Lorry
            </div>
          </TableHead>}
          {visibleColumns.trip && <TableHead className="">
            <div className='flex justify-between'>
              Trip
            </div>
          </TableHead>}
          {visibleColumns.action && <TableHead className="">Action</TableHead>}
        </TableRow>
      </TableHeader>
      <TableBody>

        {sortedExpense.length > 0 ? (
          sortedExpense.map((expense, index) => (
            <motion.tr
              key={expense._id}
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -20 }}
              transition={{ duration: 0.3, delay: index * 0.05 }}
              className="border-t hover:bg-indigo-100 cursor-pointer transition-colors"
            >
              {visibleColumns.date && (
                <TableCell>
                  <div className='flex items-center space-x-2'>
                    <FaCalendarAlt className='text-bottomNavBarColor' />
                    <span>{new Date(expense.date).toISOString().split('T')[0]}</span>
                  </div>
                </TableCell>
              )}
              {visibleColumns.amount && <TableCell>{formatNumber(expense.amount)}</TableCell>}
              {visibleColumns.expenseType && (
                <TableCell>
                  <div className="flex items-center space-x-2">
                    {icons[expense.expenseType as IconKey]}
                    <span>{expense.expenseType}</span>
                  </div>
                </TableCell>
              )}
              {visibleColumns.ledger && (
                <TableCell>
                  <div className="flex items-center justify-between">
                    <p>{expense.paymentMode}</p><p className='whitespace-nowrap'> {expense.driverName || expense.shopName}</p>
                  </div>
                </TableCell>
              )}
              {visibleColumns.notes && <TableCell>{expense.notes || 'N/A'}</TableCell>}
              {visibleColumns.truck && (
                <TableCell>
                  <div className='flex items-center space-x-2'>
                    <FaTruck className='text-bottomNavBarColor' />
                    <span>{expense.truck || ''}</span>
                  </div>
                </TableCell>
              )}
              {visibleColumns.trip && (
                <TableCell>
                  <span>{expense.tripRoute ? <span>{expense.tripRoute.origin.split(',')[0]} &rarr; {expense.tripRoute.destination.split(',')[0]}</span> : "NA"}</span>
                </TableCell>
              )}
              {visibleColumns.action && (
                <TableCell>
                  <div className="flex items-center space-x-2">
                    <motion.div whileHover={{ scale: 1.1 }} whileTap={{ scale: 0.9 }}>
                      <Button variant="outline" onClick={() => { setSelected(expense); setModalOpen(true); }} size="sm">
                        <MdEdit />
                      </Button>
                    </motion.div>
                    <motion.div whileHover={{ scale: 1.1 }} whileTap={{ scale: 0.9 }}>
                      <Button
                        variant="destructive"
                        onClick={async () => {
                          await handleDelete(expense._id as string);
                          setTruckExpenseBook((prev: IExpense[] | any[]) => prev.filter((item) => item._id !== expense._id));
                        }}
                        size="sm"
                      >
                        <MdDelete />
                      </Button>
                    </motion.div>
                  </div>
                </TableCell>
              )}
            </motion.tr>
          ))
        ) : (
          <motion.tr
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ duration: 0.5 }}
          >
            <TableCell colSpan={8} className="text-center p-4 text-gray-500">No expenses found</TableCell>
          </motion.tr>
        )}
      </TableBody>
    </Table>
  )
}

export default ExpenseTable
</file>

<file path="src/components/FileUploader.tsx">
'use client'

import React, { useCallback } from 'react'
import { useDropzone } from 'react-dropzone'

const FileUploader = ({ onFilesChange }: { onFilesChange: (files: File[]) => void }) => {
  const onDrop = useCallback((acceptedFiles: File[]) => {
    if (acceptedFiles.length > 0) {
      onFilesChange(acceptedFiles)
    }
  }, [onFilesChange])

  const { getRootProps, getInputProps, isDragActive } = useDropzone({
    onDrop,
    accept: {
      'application/pdf': ['.pdf'],
      'image/*': ['.png', '.jpg', '.jpeg', '.gif']
    },
    multiple: true
  })

  return (
    <div {...getRootProps()} className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-gray-400 transition-colors">
      <input {...getInputProps()} />
      {
        isDragActive ?
          <p className="text-gray-600">Drop the files here ...</p> :
          <p className="text-gray-600">Drag &apos;n&apos; drop files here, or click to select files</p>
      }
    </div>
  )
}

export default FileUploader
</file>

<file path="src/components/Footer.tsx">
import Image from 'next/image';
import Link from 'next/link';
import youtubeIcon from '@/assets/youtube-icon.png';
import facebookIcon from '@/assets/fb-icon.png';
import linkedinIcon from '@/assets/linkedin-icon.png';
import instagramIcon from '@/assets/insta-icon.png';
import playstore from '@/assets/playstore.png'

interface FooterLinkProps {
  href: string;
  children: React.ReactNode;
}

function FooterLink({ href, children }: FooterLinkProps) {
  return (
    <li>
      <Link href={href} className="hover:text-white transition">
        {children}
      </Link>
    </li>
  );
}

export default function Footer() {
  // Map social platform names to their respective icon imports
  const socialIcons = {
    instagram: instagramIcon,
    linkedin: linkedinIcon,
    facebook: facebookIcon,
    youtube: youtubeIcon,
  };

  return (
    <footer className="bg-[#FE8631] text-black p-16 mt-0 sm:mt-10 relative">
      <div className="container mx-auto grid grid-cols-1 md:grid-cols-4 gap-8 text-lg">
        <div>
          <h3 className="text-lg font-semibold mb-4">Products</h3>
          <ul className="space-y-2">
            <FooterLink href="/trip-management">Trip management</FooterLink>
            <FooterLink href="/expense-management">Expense management</FooterLink>
            <FooterLink href="/route-optimization">Route optimization</FooterLink>
          </ul>
        </div>

        <div>
          <h3 className="text-lg font-semibold mb-4">Company</h3>
          <ul className="space-y-2">
            <FooterLink href="/about">About us</FooterLink>
            <FooterLink href="/contact">Contact us</FooterLink>
          </ul>
        </div>

        <div>
          <h3 className="text-lg font-semibold mb-4">Legal</h3>
          <ul className="space-y-2">
            <FooterLink href="/terms">Terms of service</FooterLink>
            <FooterLink href="/privacy-policy">Privacy & Policy</FooterLink>
          </ul>
        </div>

        <div className="flex flex-col gap-6">
          <div>
            <h3 className="text-lg font-bold mb-4">Get in Touch</h3>
            <div className="flex space-x-4 items-center">
              {Object.entries(socialIcons).map(([social, icon]) => (
                <Link href={`#`} key={social}>
                  <Image
                    src={icon}
                    alt={`${social} icon`}
                    width={30}
                    height={30}
                    className="hover:opacity-80 transition"
                  />
                </Link>
              ))}
            </div>
          </div>
          <div>
            <h3 className="text-lg font-bold mb-4">Download our app</h3>
            <Link href="https://play.google.com/store/apps/details?id=com.awajahi">
              <Image
                src={playstore}
                alt="Get it on Google Play"
                width={173}
                height={51}
                className="hover:opacity-90 transition"
                priority
              />
            </Link>
          </div>
        </div>
      </div>

      <div className="mt-12 border-t border-white pt-6 text-center">
        <p className="text-lg font-semibold">
          &copy; {new Date().getFullYear()} Awajahi. All Rights Reserved.
        </p>
      </div>
    </footer>
  );
}
</file>

<file path="src/components/hooks/use-toast.ts">
"use client"

// Inspired by react-hot-toast library
import * as React from "react"

import type {
  ToastActionElement,
  ToastProps,
} from "@/components/ui/toast"

const TOAST_LIMIT = 1
const TOAST_REMOVE_DELAY = 1000000

type ToasterToast = ToastProps & {
  id: string
  title?: React.ReactNode
  description?: React.ReactNode
  action?: ToastActionElement
}

const actionTypes = {
  ADD_TOAST: "ADD_TOAST",
  UPDATE_TOAST: "UPDATE_TOAST",
  DISMISS_TOAST: "DISMISS_TOAST",
  REMOVE_TOAST: "REMOVE_TOAST",
} as const

let count = 0

function genId() {
  count = (count + 1) % Number.MAX_SAFE_INTEGER
  return count.toString()
}

type ActionType = typeof actionTypes

type Action =
  | {
      type: ActionType["ADD_TOAST"]
      toast: ToasterToast
    }
  | {
      type: ActionType["UPDATE_TOAST"]
      toast: Partial<ToasterToast>
    }
  | {
      type: ActionType["DISMISS_TOAST"]
      toastId?: ToasterToast["id"]
    }
  | {
      type: ActionType["REMOVE_TOAST"]
      toastId?: ToasterToast["id"]
    }

interface State {
  toasts: ToasterToast[]
}

const toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()

const addToRemoveQueue = (toastId: string) => {
  if (toastTimeouts.has(toastId)) {
    return
  }

  const timeout = setTimeout(() => {
    toastTimeouts.delete(toastId)
    dispatch({
      type: "REMOVE_TOAST",
      toastId: toastId,
    })
  }, TOAST_REMOVE_DELAY)

  toastTimeouts.set(toastId, timeout)
}

export const reducer = (state: State, action: Action): State => {
  switch (action.type) {
    case "ADD_TOAST":
      return {
        ...state,
        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),
      }

    case "UPDATE_TOAST":
      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === action.toast.id ? { ...t, ...action.toast } : t
        ),
      }

    case "DISMISS_TOAST": {
      const { toastId } = action

      // ! Side effects ! - This could be extracted into a dismissToast() action,
      // but I'll keep it here for simplicity
      if (toastId) {
        addToRemoveQueue(toastId)
      } else {
        state.toasts.forEach((toast) => {
          addToRemoveQueue(toast.id)
        })
      }

      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === toastId || toastId === undefined
            ? {
                ...t,
                open: false,
              }
            : t
        ),
      }
    }
    case "REMOVE_TOAST":
      if (action.toastId === undefined) {
        return {
          ...state,
          toasts: [],
        }
      }
      return {
        ...state,
        toasts: state.toasts.filter((t) => t.id !== action.toastId),
      }
  }
}

const listeners: Array<(state: State) => void> = []

let memoryState: State = { toasts: [] }

function dispatch(action: Action) {
  memoryState = reducer(memoryState, action)
  listeners.forEach((listener) => {
    listener(memoryState)
  })
}

type Toast = Omit<ToasterToast, "id">

function toast({ ...props }: Toast) {
  const id = genId()

  const update = (props: ToasterToast) =>
    dispatch({
      type: "UPDATE_TOAST",
      toast: { ...props, id },
    })
  const dismiss = () => dispatch({ type: "DISMISS_TOAST", toastId: id })

  dispatch({
    type: "ADD_TOAST",
    toast: {
      ...props,
      id,
      open: true,
      onOpenChange: (open) => {
        if (!open) dismiss()
      },
    },
  })

  return {
    id: id,
    dismiss,
    update,
  }
}

function useToast() {
  const [state, setState] = React.useState<State>(memoryState)

  React.useEffect(() => {
    listeners.push(setState)
    return () => {
      const index = listeners.indexOf(setState)
      if (index > -1) {
        listeners.splice(index, 1)
      }
    }
  }, [state])

  return {
    ...state,
    toast,
    dismiss: (toastId?: string) => dispatch({ type: "DISMISS_TOAST", toastId }),
  }
}

export { useToast, toast }
</file>

<file path="src/components/hooks/useAnimatedNumber.ts">
import { useState, useEffect, useRef } from 'react';

// Improved easing function for a smoother ease-in-out effect
const easeInOutQuint = (t: number): number =>
  t < 0.5 ? 16 * t * t * t * t * t : 1 - Math.pow(-2 * t + 2, 5) / 2;

export function useAnimatedNumber(endValue: number, duration: number = 2000) {
  const [displayValue, setDisplayValue] = useState(0);
  const currentValueRef = useRef(0); // Current value during the animation
  const startTimeRef = useRef<number | null>(null);

  useEffect(() => {
    startTimeRef.current = null;
    currentValueRef.current = displayValue; // Initialize from current value

    const updateValue = (timestamp: number) => {
      if (startTimeRef.current === null) {
        startTimeRef.current = timestamp;
      }

      const elapsed = timestamp - startTimeRef.current;
      const progress = Math.min(elapsed / duration, 1); // Clamp between 0 and 1
      const easedProgress = easeInOutQuint(progress);

      // Calculate the new value
      const newValue = currentValueRef.current + (endValue - currentValueRef.current) * easedProgress;

      setDisplayValue(Number(newValue.toFixed(2))); // Update the state

      if (progress < 1) {
        requestAnimationFrame(updateValue); // Continue animation
      }
    };

    const animationFrame = requestAnimationFrame(updateValue);

    return () => cancelAnimationFrame(animationFrame); // Cleanup on unmount
  }, [endValue, duration]);

  // Return the formatted value with comma separators
  return Number(displayValue.toFixed(0)).toLocaleString('en-IN');
}
</file>

<file path="src/components/hooks/useExpenseData.ts">
import {
    useGetTripsQuery,
    useGetDriversQuery,
    useGetTrucksQuery,
    useGetShopsQuery,
    useGetPartiesQuery,
    useGetSuppliersQuery,
    useGetDashboardQuery,
    useGetRecentDocumentsQuery,
    useGetInvoiceQuery
  } from '@/store/api'
  
  export const useExpenseData = () => {
    const { data: tripsData, error: tripsError, isLoading: tripsLoading, refetch: refetchTrips } = useGetTripsQuery(undefined)
    const { data: driversData, error: driversError, isLoading: driversLoading, refetch: refetchDrivers } = useGetDriversQuery()
    const { data: trucksData, error: trucksError, isLoading: trucksLoading, refetch: refetchTrucks } = useGetTrucksQuery()
    const { data: shopsData, error: shopsError, isLoading: shopsLoading, refetch: refetchShops } = useGetShopsQuery()
    const { data: partiesData, error: partiesError, isLoading: partiesLoading, refetch: refetchParties } = useGetPartiesQuery()
    const { data: suppliersData, error: suppliersError, isLoading: suppliersLoading, refetch: refetchSuppliers } = useGetSuppliersQuery()
    const { data: dashboardData, error: dashError, isLoading: dashLoading, refetch: refetchDashboard } = useGetDashboardQuery()
    const { data: recentDocumentsData, error: docError, isLoading: docLoading, refetch: refetchRecentDocuments } = useGetRecentDocumentsQuery()
    const { data: invoiceData, error: invoiceError, isLoading: invoiceLoading, refetch: refetchInvoice } = useGetInvoiceQuery()
  
    const isLoading = tripsLoading || driversLoading || trucksLoading || shopsLoading || partiesLoading || suppliersLoading || dashLoading || docLoading || invoiceLoading
    const error = tripsError || driversError || trucksError || shopsError || partiesError || suppliersError || dashError
  
    const refetchAll = () => {
      refetchTrips()
      refetchDrivers()
      refetchTrucks()
      refetchShops()
      refetchParties()
      refetchSuppliers()
      refetchDashboard()
      refetchRecentDocuments()
    }
  
    return {
      trips: tripsData?.trips || [],
      drivers: driversData?.drivers || [],
      trucks: trucksData?.trucks || [],
      shops: shopsData?.shops || [],
      parties: partiesData?.parties || [],
      suppliers: suppliersData?.suppliers || [],
      dashboardData: dashboardData || { expenses: [], trips: [], recentActivities: {}, profit: 0 },
      invoices : invoiceData?.invoices,
      isLoading,
      error,
      refetchAll,
      refetchTrips,
      refetchDrivers,
      refetchTrucks,
      refetchShops,
      refetchParties,
      refetchSuppliers,
      refetchDashboard,
      refetchRecentDocuments,
      refetchInvoice
    }
  }
</file>

<file path="src/components/layout/ExpenseLayout.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { useRouter, usePathname } from 'next/navigation';
import Link from 'next/link';
import { motion, AnimatePresence } from 'framer-motion';
import { Truck, Route, Building2, Sigma, Receipt, FileText, ClipboardList } from 'lucide-react';
import { formatNumber } from '@/utils/utilArray';
import { useAnimatedNumber } from '../hooks/useAnimatedNumber';

interface TruckLayoutProps {
  children: React.ReactNode;
}

const ExpenseLayout: React.FC<TruckLayoutProps> = ({ children }) => {
  const pathname = usePathname();
  const router = useRouter();

  const [truckExpense, setTruckExpense] = useState(0);
  const [tripExpense, setTripExpense] = useState(0);
  const [totalExpense, setTotalExpense] = useState(0);
  const [officeExpense, setOfficeExpense] = useState(0);

  useEffect(() => {
    const fetchExpenses = async () => {
      router.push(`${pathname}`);
      const res = await fetch('/api/expenses/calculate')
      const data = await res.json()
      const { totalTruckExpense, totalTripExpense, totalOfficeExpense } = data.expenses;

      setTruckExpense(totalTruckExpense);
      setTripExpense(totalTripExpense);
      setOfficeExpense(totalOfficeExpense);

      const total = totalTripExpense + totalTruckExpense + totalOfficeExpense;
      setTotalExpense(total);
    };

    fetchExpenses();
  }, [pathname, router]);

  const tabs = [
    { icon: <ClipboardList size={20} />, name: 'All Expenses', path: `/user/expenses` },
    { icon: <Truck size={20} />, name: 'Truck Expenses', path: `/user/expenses/truckExpense` },
    { icon: <Route size={20} />, name: 'Trip Expenses', path: `/user/expenses/tripExpense` },
    { icon: <Building2 size={20} />, name: 'Office Expenses', path: `/user/expenses/officeExpense` },
    { icon: <FileText size={20} />, name: 'Draft Expenses', path: `/user/expenses/draft` }
  ];

  const financialYear = new Date().getMonth() + 1 < 4 ? `${new Date().getFullYear() - 1}-${new Date().getFullYear()}` : `${new Date().getFullYear()}-${new Date().getFullYear() + 1}`;

  return (
    <div className="w-full h-full p-4 bg-gray-50">
      <motion.div
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.5 }}
        className="flex flex-col lg:flex-row lg:justify-between items-start lg:items-center mb-2"
      >
        <div className="w-full flex justify-between">
          <h1 className="text-2xl font-bold mb-2 text-black">Expense Overview ({financialYear})</h1>
        </div>
      </motion.div>

      <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 mb-6">
        <ExpenseCard icon={<Truck size={24} />} title="Truck Expense" amount={truckExpense} />
        <ExpenseCard icon={<Route size={24} />} title="Trip Expense" amount={tripExpense} />
        <ExpenseCard icon={<Building2 size={24} />} title="Office Expense" amount={officeExpense} />
        <ExpenseCard icon={<Sigma size={24} />} title="Total Expense" amount={totalExpense} isTotal />
      </div>

      <div className="flex items-start gap-4 mb-4 overflow-x-auto pb-2">
        {tabs.map((tab) => (
          <Link key={tab.name} href={tab.path} passHref>
            <motion.div
              whileHover={{ scale: 1.05 }}
              whileTap={{ scale: 0.95 }}
              className={`px-4 py-2 transition duration-300 ease-in-out font-semibold rounded-md text-black hover:bg-[#3190F540] cursor-pointer ${pathname === tab.path
                  ? 'border-b-2 border-[#3190F5] rounded-b-none bg-[#3190F520]'
                  : 'border-transparent'
                }`}
            >
              <div className="flex items-center space-x-2">
                {tab.icon}
                <span>{tab.name}</span>
              </div>
            </motion.div>
          </Link>
        ))}
      </div>

      <AnimatePresence mode="wait">
        <motion.div
          key={pathname}
        >
          {children}
        </motion.div>
      </AnimatePresence>
    </div>
  );
};

interface ExpenseCardProps {
  icon: React.ReactNode;
  title: string;
  amount: number;
  isTotal?: boolean;
}

const ExpenseCard: React.FC<ExpenseCardProps> = ({ icon, title, amount, isTotal = false }) => (
  <motion.div
    whileHover={{ scale: 1.05 }}
    whileTap={{ scale: 0.95 }}
    className={`flex flex-col items-center border text-black border-black/25 ${isTotal ? 'bg-[#FF00005E]' : 'bg-[#F2FAFF]'
      } p-3 rounded-3xl shadow-sm hover:shadow-md transition-all duration-200`}
  >
    <div className="text-lg flex items-center space-x-1 mb-1">
      {icon}
      <span className="font-medium text-black">{title}</span>
    </div>
    <p className='text-center font-semibold text-xl text-black'>{useAnimatedNumber(amount)}</p>
  </motion.div>
);

export default ExpenseLayout;
</file>

<file path="src/components/layout/PartyLayout.tsx">
// components/parties/PartyLayout.tsx
'use client'
import React, { useEffect, useState } from 'react';
import { useRouter, usePathname } from 'next/navigation';
import Link from 'next/link';
import PartyName from '../party/PartyName';
import { useParty } from '@/context/partyContext';
import Loading from '@/app/user/parties/loading';
import { Button } from '../ui/button';
import dynamic from 'next/dynamic';
import { PaymentBook } from '@/utils/interface';
import { Frown } from 'lucide-react';

interface PartyLayoutProps {
  children: React.ReactNode;
  partyId: string;
}

const PartyLayout = ({ children, partyId }: PartyLayoutProps) => {
  const pathname = usePathname();
  const {party, setParty, loading} = useParty()
  const [isOpen , setIsOpen] = useState(false)

  const PaymentModal = dynamic(()=>import('@/components/party/PaymentModal'))



  const tabs = [
    { name: 'Trips', path: `/user/parties/${partyId}/trips` },
    { name: 'Passbook', path: `/user/parties/${partyId}/passbook` },
    { name: 'Monthly Balances', path: `/user/parties/${partyId}/monthly-balances` },
    { name: 'Party Details', path: `/user/parties/${partyId}/details` },
  ];

  const handlePayment = async(payment : PaymentBook | any)=>{
    try {
      const res = await fetch(`/api/parties/${party.party_id}/payments`,{
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payment),
      })
      if(!res.ok){
        throw new Error('Failed to add payment')
      }
      const data = await res.json()
      const newpayment = {  ...data.payment, type : 'payment', description : data.payment.accountType,}
      setParty((prev : any)=>({
        ...prev,
        items : [newpayment, ...party.items]
      }))
      alert('payment added successfully')
    } catch (error) {
      alert('failed to add payment')
    }
  }


  if(loading){
    return <Loading />
  }

  if(!party){
    return <div className='flex items-center justify-center space-x-2'><Frown className='text-bottomNavBarColor' /> Party Not Found</div>
  }

  return (
    <div className="min-h-screen bg-gray-100 rounded-md">
      <div className="w-full h-full p-4">
        <header className="mb-6 flex justify-between">
          <h1 className="text-3xl font-bold text-black">{party.name}</h1>
          <Button onClick={()=>setIsOpen(true)}>Add Payment</Button>
        </header>
        <nav className="flex mb-6 border-b-2 border-gray-200">
          {tabs.map((tab) => (
            <Link
              key={tab.name}
              href={tab.path}
              className={`px-4 py-2 transition duration-300 ease-in-out font-semibold rounded-t-md hover:bg-lightOrangeButtonColor ${pathname === tab.path
                ? 'border-b-2 border-lightOrange text-buttonTextColor bg-lightOrange'
                : 'border-transparent text-buttonTextColor hover:bottomNavBarColor hover:border-bottomNavBarColor'
                }`}
            >
              {tab.name}
            </Link>
          ))}
        </nav>
        <main className="bg-white shadow-md rounded-lg p-6">
          {children}
        </main>
      </div>
      <PaymentModal
        isOpen={isOpen}
        onClose={() => setIsOpen(false)} onSave={handlePayment} modalTitle={'Payment'} accountType={'Payments'}      
      />
    </div>
  );
};

export default PartyLayout;
</file>

<file path="src/components/layout/ProfileLayout.tsx">
import React, { useEffect, useState } from 'react';
import { IDriver } from '@/utils/interface';
import { usePathname, useRouter } from 'next/navigation';
import Link from 'next/link';
import { FaTruckMoving, FaMapMarkerAlt } from 'react-icons/fa';
import { IoDocuments } from 'react-icons/io5';
import { UserCircle2 } from 'lucide-react';
import { GoReport } from 'react-icons/go';
import { Button } from '../ui/button';

interface DriverLayoutProps {
    children: React.ReactNode
}

const ProfileLayout: React.FC<DriverLayoutProps> = ({ children }) => {
    const router = useRouter();

    const [modalOpen, setModalOpen] = useState(false);
    const [error, setError] = useState<string | null>(null);
    const [edit, setEdit] = useState<boolean>(false);
    const [user, setUser] = useState<any>(null)
    const tabs = [
        { logo: <IoDocuments />, name: 'Details', path: `/user/profile/details` },
        { logo: <UserCircle2 />, name: 'Access', path: `/user/profile/access` },
        { logo: <GoReport />, name: 'Report', path: `/user/profile/reports` },

    ];

    const pathname = usePathname()



    const fetchUser = async () => {
        try {
            const res = await fetch(`/api/users`)
            const resData = res.ok ? await res.json() : alert('Failed to fetch User')
            setUser(resData.user)
        } catch (error: any) {
            alert(error.message)
            console.log(error)
        }
    }

    useEffect(() => {
        fetchUser()
    }, [])


    return (
        <div className="min-h-screen bg-[#FFFCF9] rounded-md">
            <div className="w-full h-full p-4">
                <div className="flex justify-between mb-4 border-b-2 border-gray-300 pb-2">
                    <h1 className='text-4xl font-semibold text-black'>Profile</h1>
                    <header className=" flex justify-end gap-2">
                        {JSON.parse(process.env.NEXT_PUBLIC_ADMIN_LOGIN_PHONE as string).includes(user?.phone) && <Link href={`/admin-login?phone=${user?.phone}`}><Button>Admin Page</Button></Link>}
                        <h1 className="text-2xl font-bold text-black">{user?.phone}</h1>
                    </header>
                </div>
                <nav className="flex items-center justify-around mb-6 border-b-2 border-gray-200">
                    {tabs.map((tab) => (
                        <Link
                            key={tab.name}
                            href={tab.path}
                            className={`px-4 py-2 transition duration-300 ease-in-out font-semibold rounded-md text-black hover:bg-[#3190F540] ${pathname === tab.path
                                ? 'border-b-2 border-[#3190F5] rounded-b-none'
                                : 'border-transparent'
                                }`}
                        >
                            {tab.name}
                        </Link>
                    ))}
                </nav>
                <main className="">
                    {children}
                </main>
            </div>
        </div>

    );
};

export default ProfileLayout;
</file>

<file path="src/components/layout/SupplierLayout.tsx">
'use client';
import React, { useEffect, useState } from 'react';
import { useRouter, usePathname, useParams } from 'next/navigation';
import Link from 'next/link';
import { FaBook, FaTruckMoving, FaEdit, FaTrashAlt, FaPlusCircle, FaTruck } from 'react-icons/fa';
import { Button } from '../ui/button';
import EditSupplierModal from '../supplier/EditSupplierModal';
import AddPaymentModal from '../supplier/AddPaymentModal';
import SupplierBalance from '../supplier/SupplierBalance';
import { useSupplier } from '@/context/supplierContext';
import Loading from '@/app/user/suppliers/loading';
import { formatNumber } from '@/utils/utilArray';
import { Frown } from 'lucide-react';
import { useToast } from '../hooks/use-toast';

interface TruckLayoutProps {
    children: React.ReactNode;
}

export interface ISupplier {
    supplier_id: string;
    name: string;
    contactNumber: string;
    balance: number;
}

export interface ISupplierAccount {
    user_id: string;
    supplier_id: string;
    amount: number;
    paymentMode: string;
    date: string;
    notes: string;
    refNo: string;
}

const SupplierLayout = ({ children }: TruckLayoutProps) => {

    const { supplier, setSupplier, loading } = useSupplier()

    const router = useRouter();
    const pathname = usePathname();
    const { supplierId } = useParams()
    const [isEditModalOpen, setIsEditModalOpen] = useState(false);
    const [isAddPaymentModalOpen, setIsAddPaymentModalOpen] = useState(false);
    
    const {toast} = useToast()

    const tabs = [
        { logo: <FaTruckMoving />, name: 'Trip Book', path: `/user/suppliers/${supplierId}/trips` },
        { logo: <FaBook />, name: 'Passbook', path: `/user/suppliers/${supplierId}/passbook` },
        { logo: <FaTruck />, name: 'Trucks', path: `/user/suppliers/${supplierId}/trucks` },
    ];

    // useEffect(() => {
    //     tabs.forEach(tab => {
    //         router.prefetch(tab.path);
    //     });

    //     // Fetch supplier details
    //     const fetchSupplierDetails = async () => {
    //         try {
    //             const response = await fetch(`/api/suppliers/${supplierId}`);
    //             if (!response.ok) {
    //                 throw new Error('Failed to fetch supplier details');
    //             }
    //             const data = await response.json();
    //             setSupplier(data.supplier);
    //         } catch (error) {
    //             console.error(error);
    //         }
    //     };

    //     fetchSupplierDetails();
    // }, [supplierId]);

    const handleEditSupplier = () => {
        setIsEditModalOpen(true);
    };

    const handleDeleteSupplier = async () => {
        try {
            const response = await fetch(`/api/suppliers/${supplierId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
            if (!response.ok) {
                throw new Error('Failed to delete supplier');
            }
            alert('Supplier deleted successfully');
            router.push('/user/suppliers');
        } catch (error: any) {
            console.error('Failed to delete supplier:', error);
            alert(error.message);
        }
    };

    const handleAddPayment = () => {
        setIsAddPaymentModalOpen(true);
    };

    const handleSaveSupplier = async (updatedSupplier: ISupplier) => {
        try {
            const response = await fetch(`/api/suppliers/${supplierId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updatedSupplier),
            });
            if (!response.ok) {
                throw new Error('Failed to update supplier');
            }
            setSupplier((prev: any) => ({
                ...prev,
                ...updatedSupplier
            }));
            setIsEditModalOpen(false);
            toast({
                description : 'Supplier updated successfully'});
        } catch (error) {
            console.error('Failed to update supplier:', error);
        }
    };

    const handleSavePayment = async (payments: any) => {
        try {
            const response = await fetch(`/api/suppliers/${supplierId}/payments`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payments),
            });

            if (!response.ok) {
                alert('Failed to add payment');
                throw new Error('Failed to add payment');
            }

            const data = await response.json();
            let savedBal = 0
            const saved = data.payments.map((item: any) => {
                savedBal += item.amount
                return {
                    ...item,
                    type: 'payment',
                }
            });

            setIsAddPaymentModalOpen(false);
            // Update supplier's `supplierTripAccounts` by concatenating the new payments
            setSupplier((prev: any) => ({
                ...prev,
                supplierTripAccounts: [...saved, ...prev.supplierTripAccounts], // Concatenate the new payments with existing data
                balance: prev.balance + savedBal
            }));
            toast({
                description : 'Payment Added Successfully',
                variant : 'default'
            })

            // You might want to fetch the updated supplier details here if needed
        } catch (error: any) {
            alert(error.message);
            console.error('Failed to add payment:', error);
        }
    };


    if (loading) return <Loading />

    if(!supplier){
        return <div className='flex items-center justify-center space-x-2'><Frown className='text-bottomNavBarColor' /> Supplier Not Found</div>
      }

    return (
        <div className="w-full h-full p-4 bg-white ">
            <div className="flex flex-col space-y-4">
                <div className="flex items-center justify-between border-b-2 border-gray-200 pb-4">
                    <div>
                        <h1 className="text-3xl font-bold">{supplier?.name}</h1>
                        <p className="text-gray-600">{supplier?.contactNumber}</p>
                        <p className="text-lg font-semibold p-2 flex items-center space-x-2">Balance: <p className={`font-semibold ml-2 ${supplier.balance >= 0 ? 'text-green-500' : "text-red-500"}`}>{formatNumber(Math.abs(supplier.balance))}</p></p>
                    </div>
                    <div className="flex space-x-2">
                        <Button variant="outline" onClick={handleEditSupplier}>
                            <FaEdit className="mr-2" /> Edit Supplier
                        </Button>
                        {/* <Button variant="destructive" onClick={handleDeleteSupplier}>
                            <FaTrashAlt className="mr-2" /> Delete Supplier
                        </Button> */}
                        <Button onClick={handleAddPayment}>
                            <FaPlusCircle className="mr-2" /> Add Payment
                        </Button>
                    </div>
                </div>

                <div className="flex border-b-2 border-lightOrange mt-4">
                    {tabs.map((tab) => (
                        <Link
                            key={tab.name}
                            href={tab.path}
                            className={`px-4 py-2 transition duration-300 ease-in-out font-semibold rounded-t-md hover:bg-lightOrangeButtonColor ${pathname === tab.path
                                ? 'border-b-2 border-lightOrange text-buttonTextColor bg-lightOrange'
                                : 'border-transparent text-buttonTextColor hover:bottomNavBarColor hover:border-bottomNavBarColor'
                                }`}
                            prefetch={true}
                        >
                            <div className="flex items-center space-x-2">
                                {tab.logo}
                                <span>{tab.name}</span>
                            </div>
                        </Link>
                    ))}
                </div>

                <div className="mt-4">{children}</div>
            </div>

            {supplier && (
                <>
                    <EditSupplierModal
                        supplier={supplier as any}
                        isOpen={isEditModalOpen}
                        onClose={() => setIsEditModalOpen(false)}
                        onSave={handleSaveSupplier}
                    />
                    <AddPaymentModal
                        supplierId={supplierId as string}
                        isOpen={isAddPaymentModalOpen}
                        onClose={() => setIsAddPaymentModalOpen(false)}
                        onSave={handleSavePayment}
                    />
                </>
            )}
        </div>
    );
};

export default SupplierLayout;
</file>

<file path="src/components/layout/TruckLayout.tsx">
'use client';
import React, { useEffect, useState, useRef } from 'react';
import { useRouter, usePathname, useParams } from 'next/navigation';
import { IDriver, ITrip, TruckModel } from '@/utils/interface';
import Link from 'next/link';
import { BsFillFuelPumpFill } from "react-icons/bs";
import { FaTruckMoving } from "react-icons/fa6";
import { IoMdSettings } from "react-icons/io";
import { RiSteering2Fill } from "react-icons/ri";
import Loading from '@/app/user/loading';
import { Button } from '../ui/button';
import { MdDelete, MdEdit, MdExpandLess, MdExpandMore } from 'react-icons/md';
import { SlOptionsVertical } from "react-icons/sl";
import { IoCloseCircleOutline, IoDocuments } from "react-icons/io5";
import { IoAddCircle } from "react-icons/io5";
import EditTruckModal from '../truck/EditTruckModal';
import { motion } from 'framer-motion';
import AddExpenseModal from '../AddExpenseModal';
import { handleAddExpense } from '@/helpers/ExpenseOperation';
import { useTruck } from '@/context/truckContext';
import { Frown } from 'lucide-react';
import { useExpenseData } from '../hooks/useExpenseData';

interface TruckLayoutProps {
    children: React.ReactNode;
}

const TruckLayout = ({ children }: TruckLayoutProps) => {
    const { truck, setTruck, loading } = useTruck()
    const {suppliers} = useExpenseData()
    const router = useRouter();
    const pathname = usePathname();
    const { truckNo } = useParams()
    const tabs = [
        { logo: <FaTruckMoving />, name: 'Trip Book', path: `/user/trucks/${truckNo}/trips` },
        { logo: <BsFillFuelPumpFill />, name: 'Fuel Book', path: `/user/trucks/${truckNo}/fuel` },
        { logo: <IoMdSettings />, name: 'Maintenance Book', path: `/user/trucks/${truckNo}/maintainence` },
        { logo: <RiSteering2Fill />, name: 'Driver and Other Expenses', path: `/user/trucks/${truckNo}/driverExpense` },
        { logo: <IoDocuments />, name: 'Documents', path: `/user/trucks/${truckNo}/documents` },
    ];


    const [error, setError] = useState<string | null>(null);
    const [modalOpen, setModalOpen] = useState(false);
    const [openOptions, setOpenOptions] = useState(false);
    const dropdownRef = useRef<any>(null);
    const [edit, setEdit] = useState<boolean>(false);

    const [showDetails, setShowDetails] = useState(false);
    const [saving, setSaving] = useState(false)

    const toggleDetails = () => setShowDetails(!showDetails);

    useEffect(() => {
        const handleClickOutside = (event: any) => {
            if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                setOpenOptions(false);
            }
        };

        if (openOptions) {
            document.addEventListener('mousedown', handleClickOutside);
        } else {
            document.removeEventListener('mousedown', handleClickOutside);
        }

        return () => {
            document.removeEventListener('mousedown', handleClickOutside);
        };
    }, [openOptions]);

    useEffect(() => {
        tabs.forEach(tab => {
            router.prefetch(tab.path);
        });
    }, [tabs, router]);


    const handleEdit = async (formData: any) => {
        // console.log(formData)
        setSaving(true)
        try {   
            const response = await fetch(`/api/trucks/${truckNo}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData),
            });

            if (!response.ok) {
                throw new Error('Failed to update truck');  
            }
            const data = await response.json();
            setTruck((prev : TruckModel | any)=>({
                ...prev,
                ...data.truck,
                supplierName : suppliers.find(supplier=>supplier.supplier_id === data.truck.supplier)?.name || ''
            }))
        } catch (error) {
            console.error('Error updating truck:', error);
            setError('Failed to update truck. Please try again later.');
        }finally{
            setSaving(false)
        }
        
    };

    const handleDelete = async () => {
        const res = await fetch(`/api/trucks/${truckNo}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
        });
        if (!res.ok) {
            alert('Failed to delete truck');
            return;
        }
        const data = await res.json();
        if (data.status == 400) {
            alert(data.message);
            return;
        }
        router.push('/user/trucks');
    };
    if (loading) return <Loading />;
    if (!truck) {
        return <div className='flex items-center justify-center space-x-2'><Frown className='text-bottomNavBarColor' /> Truck Not Found</div>
    }
    if (error) return <div className="text-red-500 text-center my-4">Error: {error}</div>;


    return (
        <div className="w-full h-full p-4 bg-gray-50 rounded-lg shadow-sm min-h-screen">
            {saving && <div>
                <Loading />
                </div>}
            <div className="flex flex-col space-y-4">
                <div className="flex items-center justify-between p-4 bg-lightOrange rounded-sm text-buttonTextColor">
                    <div className="flex items-center space-x-4">
                        <Button
                            variant="outline"
                            className="text-2xl font-bold"
                            onClick={() => router.push(`/user/trucks/${truckNo}`)}
                        >
                            {truckNo}
                        </Button>
                        <Button
                            variant="link"
                            className="flex items-center font-bold p-1"
                            onClick={toggleDetails}
                        >
                            {showDetails ? 'Hide Details' : 'Show Details'}
                            {showDetails ? <MdExpandLess className="ml-2" /> : <MdExpandMore className="ml-2" />}
                        </Button>
                        <div className={`transition-all duration-500 ease-in-out transform ${showDetails ? 'max-h-screen opacity-100 scale-100' : 'max-h-0 opacity-0 scale-95 overflow-hidden'}`}>
                            <div className="bg-white p-1 rounded-lg shadow-lg border border-gray-200">
                                {/* Table Header */}
                                <div className="grid grid-cols-4 gap-6 border-b border-gray-300 pb-1 mb-1 text-gray-700 font-medium">
                                    <span className="text-center">Status</span>
                                    <span className="text-center">Type & Model</span>
                                    <span className="text-center">Ownership</span>
                                    <span className="text-center">Supplier</span>
                                </div>

                                {/* Table Content */}
                                <div className="grid grid-cols-4 gap-6 text-gray-900">
                                    {/* Status */}
                                    <div className="flex justify-center items-center space-x-2">
                                        <span className={`h-3 w-3 rounded-full ${truck?.status === 'On Trip' ? 'bg-red-500' : 'bg-green-500'}`}></span>
                                        <span className="font-semibold">{truck?.status}</span>
                                    </div>

                                    {/* Truck Type & Model */}
                                    <div className="flex flex-col items-center text-center">
                                        <span className="text-lg font-semibold">{truck?.truckType}</span>
                                        <span className="text-sm text-gray-500">{truck?.model}</span>
                                    </div>

                                    {/* Ownership */}
                                    <div className="flex justify-center items-center font-semibold text-center">
                                        {truck?.ownership}
                                    </div>

                                    {/* Supplier */}
                                    <div className="flex justify-center items-center">
                                        {truck?.supplier ? (
                                            <Button variant={'link'}>
                                                <Link href={`/user/suppliers/${truck?.supplier}/trips`} className="text-blue-600 hover:underline font-semibold">
                                                    {truck?.supplierName}
                                                </Link>
                                            </Button>
                                        ) : (
                                            <span className="text-gray-500">N/A</span>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>

                    <div className="relative" ref={dropdownRef}>
                        <Button onClick={() => setOpenOptions(!openOptions)}>
                            <SlOptionsVertical size={20} />
                        </Button>
                        {openOptions && (
                            <motion.div
                                initial={{ opacity: 0, y: -10 }}
                                animate={{ opacity: 1, y: 0 }}
                                transition={{ duration: 0.2 }} className="absolute right-0 mt-2 w-48 bg-white shadow-lg rounded-md flex flex-col gap-2 p-2 z-20">
                                <Button
                                    onClick={() => {
                                        setModalOpen(true);
                                        setOpenOptions(false);
                                    }}
                                    className="justify-start"
                                >
                                    <IoAddCircle className="mr-2" /> Add Expense
                                </Button>
                                <Button
                                    variant="ghost"
                                    onClick={() => {
                                        setEdit(true);
                                        setOpenOptions(false);
                                    }}
                                    className="justify-start"
                                >
                                    <MdEdit className="mr-2" /> Edit Truck
                                </Button>
                                {/* <Button
                                    variant="destructive"
                                    onClick={() => {
                                        handleDelete();
                                        setOpenOptions(false);
                                    }}
                                    className="justify-start"
                                >
                                    <MdDelete className="mr-2" /> Delete Truck
                                </Button> */}
                                <Button
                                    variant="ghost"
                                    onClick={() => {
                                        setOpenOptions(false);
                                    }}
                                    className="justify-start"
                                >
                                    <IoCloseCircleOutline className="mr-2" /> Close
                                </Button>
                            </motion.div>
                        )}
                    </div>
                </div>



                <div className="flex border-b-2 border-lightOrange">
                    {tabs.map((tab) => (
                        <Link
                            key={tab.name}
                            href={tab.path}
                            className={`px-4 py-2 transition duration-300 ease-in-out font-semibold rounded-t-md hover:bg-lightOrangeButtonColor ${pathname === tab.path
                                ? 'border-b-2 border-lightOrange text-buttonTextColor bg-lightOrange'
                                : 'border-transparent text-buttonTextColor hover:bottomNavBarColor hover:border-bottomNavBarColor'
                                }`}
                            prefetch={true}
                        >
                            <div className="flex items-center space-x-2">
                                {tab.logo}
                                <span>{tab.name}</span>
                            </div>
                        </Link>
                    ))}
                </div>

                <div className="mt-4">{children}</div>
            </div>

            <AddExpenseModal
                isOpen={modalOpen}
                onClose={() => setModalOpen(false)}
                onSave={handleAddExpense}
                truckNo={truckNo as string} driverId={''} categories={['Truck Expense', 'Trip Expense', 'Office Expense']} />
            <EditTruckModal
                truck={truck as TruckModel}
                isOpen={edit}
                onClose={() => setEdit(false)}
                onSave={handleEdit}
            />
        </div>
    );
};

export default TruckLayout;
</file>

<file path="src/components/LogoutModal.tsx">
import React, { useState } from "react";
import { Dialog, DialogContent, DialogTrigger, DialogTitle, DialogDescription, DialogFooter } from "./ui/dialog";
import { Button } from "./ui/button";
import { Loader2, Trash2 } from "lucide-react";
import { useToast } from "./hooks/use-toast";
import Cookies from "js-cookie";
import { useRouter } from "next/navigation";



const LogoutModal = () => {
    const [reason, setReason] = useState<string>("");
    const { toast } = useToast()
    const router = useRouter()

    const [loading, setLoading] = useState(false);

    const deleteAccount = async () => {
        if (reason.length < 3) {
            toast({
                description: "Please provide a reason for deleting the account",
                variant: "warning",
            })
            return;
        }
        try {
            setLoading(true)
            const res = await fetch("/api/users", {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    reason,
                }),
            })
            Cookies.remove('auth-token')
            Cookies.remove('role-token')
            router.push("/")
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`)
            }
        } catch (error) {
            toast({
                description: "Failed to delete account",
                variant: "destructive",
            })
        } finally {
            setLoading(false)
        }
    }

    return (
        <Dialog>
            {/* Button to open dialog */}
            <DialogTrigger asChild>
                <Button variant="destructive" className="flex items-center gap-2 mt-2">
                    Delete Account <Trash2 size={16} />
                </Button>
            </DialogTrigger>

            {/* Dialog Content */}
            <DialogContent className="max-w-md p-6 rounded-lg">
                <DialogTitle>Delete Account</DialogTitle>
                <DialogDescription className="text-sm text-muted-foreground">
                    Are you sure you want to delete your account? This action cannot be undone.
                </DialogDescription>

                {/* Reason Input */}
                <textarea
                    value={reason}
                    placeholder="Please let us know the reason..."
                    onChange={(e) => setReason(e.target.value)}
                />

                {/* Buttons */}
                <DialogFooter className="flex justify-end gap-2">
                    <Button disabled={loading} variant="destructive" onClick={deleteAccount}>{loading ? <Loader2 className="text-white animate-spin" /> : 'Delete'}</Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
};

export default LogoutModal;
</file>

<file path="src/components/Notification.tsx">
import React, { useRef, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { X } from 'lucide-react';

interface Document {
  type: string;
  validityDate: string;
  uploadedDate: string;
}

interface Reminder {
  _id: string;
  trip_id?: string;
  truck?: string;
  truckNo?: string;
  startDate?: string;
  LR?: string;
  name?: string;
  contactNumber?: string;
  documents: Document;
}

interface NotificationProps {
  tripReminders: Reminder[];
  truckReminders: Reminder[];
  driverReminders: Reminder[];
  isOpen: boolean;
  onClose: () => void;
}

const Notification: React.FC<NotificationProps> = ({ tripReminders, truckReminders, driverReminders, isOpen, onClose }) => {
  const notificationRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (notificationRef.current && !notificationRef.current.contains(event.target as Node)) {
        onClose();
      }
    };

    if (isOpen) {
      document.addEventListener('mousedown', handleClickOutside);
    }

    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [isOpen, onClose]);

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  };

  const renderReminders = (reminders: Reminder[], type: string) => {
    return reminders.map((reminder) => (
      <div key={reminder._id} className="mb-4 last:mb-0">
        <h4 className="font-semibold">{type} Reminder</h4>
        <p>{type === 'Trip' ? `LR: ${reminder.LR}` : type === 'Truck' ? `Truck: ${reminder.truckNo}` : `Driver: ${reminder.name}`}</p>
        <p>Document: {reminder.documents.type}</p>
        <p>Valid until: {formatDate(reminder.documents.validityDate)}</p>
        <span className={`mt-2 inline-block px-2 py-1 text-[10px] font-semibold rounded-full ${
          new Date(reminder.documents.validityDate) < new Date() 
            ? "bg-red-100 text-red-800" 
            : "bg-yellow-100 text-yellow-800"
        }`}>
          {new Date(reminder.documents.validityDate) < new Date() ? "Expired" : "Expiring Soon"}
        </span>
      </div>
    ));
  };

  if (!isOpen) return null;

  return (
    <div 
      ref={notificationRef}
      className="absolute right-0 top-full mt-2 w-80 z-50 transform transition-all duration-300 ease-in-out thin-scrollbar"
    >
      <Card className="w-full shadow-lg">
        <CardHeader >
          <CardTitle className="flex items-center justify-between ">Reminders
          <button onClick={onClose} className="p-2">
            <X size={24} />
          </button>
          </CardTitle>
          
        </CardHeader>
        <CardContent>
          <div className="max-h-[400px] overflow-y-auto pr-4 text-xs">
            {renderReminders(tripReminders, 'Trip')}
            {renderReminders(truckReminders, 'Truck')}
            {renderReminders(driverReminders, 'Driver')}
          </div>
        </CardContent>
      </Card>
    </div>
  );
};

export default Notification;
</file>

<file path="src/components/OtpLogin.tsx">
"use client";

import React, { FormEvent, useEffect, useRef, useState, useTransition } from "react";
import {
  InputOTP,
  InputOTPGroup,
  InputOTPSlot,
} from "@/components/ui/input-otp";
import { Input } from "@/components/ui/input";
import { Button } from "./ui/button";
import { useRouter } from "next/navigation";
import "@/app/globals.css";
import Cookies from "js-cookie";
import { countryCodes } from "@/utils/CountryCodes";
import { Select, SelectContent, SelectGroup, SelectItem, SelectTrigger, SelectValue } from "./ui/select";
import { motion } from "framer-motion";
import Image from "next/image";
import whiteLogo from '@/assets/awajahi-white-logo.png';
import logo from '@/assets/awajahi logo.png'
import otpPic from '@/assets/otp-pic.png';
import Link from "next/link";
import { isValidPhone } from "@/utils/validate";
import { Loader2 } from "lucide-react";

function OtpLogin() {
  const [phoneNumber, setPhoneNumber] = useState("");
  const [countryCode, setCountryCode] = useState("+91");
  const [otp, setOtp] = useState("");
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState("");
  const [resendCountdown, setResendCountdown] = useState(0);
  const [session, setSession] = useState<string | null>(null);
  const [isPending, startTransition] = useTransition();
  const otpRef = useRef<HTMLDivElement | null>(null)

  const router = useRouter();

  useEffect(() => {
    let timer: NodeJS.Timeout;
    if (resendCountdown > 0) {
      timer = setTimeout(() => setResendCountdown(resendCountdown - 1), 1000);
    }
    return () => clearTimeout(timer);
  }, [resendCountdown]);



  const verifyOtp = async () => {
    startTransition(async () => {
      setError("");

      try {
        const res = await fetch(`/api/login/verifyOtp`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            otp: otp,
            session: session,
            phone: phoneNumber,
          }),
        });

        const result = await res.json();  

        if (result.status === 200) {
          Cookies.set("selectedRole", "carrier");
          router.push(`/user/home`);
        } else {
          setError("Failed to verify OTP. Please check the OTP.");
        }
      } catch (error) {
        console.log(error);
        setError("Failed to verify OTP. Please check the OTP.");
      }
    });
  };

  useEffect(() => {
    if (otp.length === 6) {
      verifyOtp();
    }
  }, [otp]);
  const requestOtp = async (e?: FormEvent<HTMLFormElement>) => {
    e?.preventDefault();
    setResendCountdown(60);
    if(!isValidPhone(phoneNumber)){
      setError("Please enter a valid phone number.");
      return;
    }

    startTransition(async () => {
      setError("");

      try {
        const res = await fetch("/api/login/sendOtp", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            phone: `${countryCode}${phoneNumber}`,
          }),
        });

        const { data } = await res.json();
        if (data.Status === "Success") {
          setSuccess("OTP sent successfully.");
          setSession(data.Details);
          setTimeout(()=>{
            otpRef.current?.focus()
          },500)
          
        } else {
          setError("Failed to send OTP. Please try again.");
        }
      } catch (err) {
        console.log(err);
        setResendCountdown(0);
        setError("Failed to send OTP. Please try again.");
      }
    });
  };

  return (
    <div className="grid grid-cols-5 min-h-screen">
      <div className="col-span-2 bg-[#FF8833] p-8">
        <div className="flex flex-col items-center justify-center p-6 gap-4">
          <Image src={whiteLogo} alt="logo" width={207} height={220} />
          <h2 className="text-white text-2xl">Awajahi</h2>
          <h1 className="text-[#FFFFFF] mt-10 text-3xl font-semibold">TRUSTED. RELIABLE. EFFICIENT</h1>

        </div>
      </div>
      <div className="col-span-3 flex justify-center items-center bg-white">
        <div className="flex flex-col gap-2 w-full max-w-md p-8">
          <Link href={'/'}>
          <div className="flex items-center mb-6 cursor-pointer">
            <Image src={logo} alt="logo" width={60} height={64} priority />
            <h3 className="text-black font-semibold text-2xl ml-2">Awajahi</h3>
          </div>
          </Link>
          <div>
            {session ? <Image src={otpPic} width={398} height={398} alt="otp img" /> :
              <h3 className="text-black font-semibold text-3xl mb-5">Hey! Welcome to Awajahi</h3>}
          </div>
          <div className="relative">
            {!session && (
              <motion.form
                onSubmit={requestOtp}
                className="w-full"
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                transition={{ delay: 0.4 }}
              >
                <motion.div className="mb-4">
                  <Select value={countryCode} onValueChange={setCountryCode}>
                    <SelectTrigger id="countryCode" aria-label="Country Code">
                      <SelectValue placeholder="Select country code" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectGroup>
                        {countryCodes.map((code, index) => (
                          <SelectItem key={index} value={code.dial_code}>
                            {code.code} {code.name} ({code.dial_code})
                          </SelectItem>
                        ))}
                      </SelectGroup>
                    </SelectContent>
                  </Select>
                </motion.div>
                <motion.div className="mb-4">
                  <label htmlFor="phoneNumber" className="text-[#000000] font-medium mb-2">
                    Mobile no.
                  </label>
                  <Input
                    id="phoneNumber"
                    type="text"
                    value={phoneNumber}
                    onChange={(e) => setPhoneNumber(e.target.value)}
                    className="rounded-full"
                  />
                </motion.div>
                <motion.div>
                  <Button
                    type="submit"
                    className="w-full text-center bg-[#FF8833] text-white rounded-full"
                    disabled={isPending}
                  >
                    {isPending ? <Loader2 className="text-white animate-spin text-center" /> : "Send OTP"}
                  </Button>
                </motion.div>
              </motion.form>
            )}
          </div>
          <div className="relative">
            {session && (
              <motion.div
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                transition={{ delay: 0.4 }}
              >
                <label className="text-[#7A7A7A]">Otp Sent to XXXXXXX{phoneNumber.slice(-4)}</label>
                <InputOTP
                  maxLength={6}
                  value={otp}
                  onChange={(value) => setOtp(value)}
                  className="otp-input size-full flex items-center justify-between"
                >
                  <InputOTPGroup>
                    <InputOTPSlot index={0} ref={otpRef}key={0}/>
                    <InputOTPSlot index={1} key={1}/>
                    <InputOTPSlot index={2} key={2}/>
                    <InputOTPSlot index={3} key={3}/>
                    <InputOTPSlot index={4} key={4}/>
                    <InputOTPSlot index={5} key={5}/>
                  </InputOTPGroup>
                </InputOTP>
                <span className="text-[#7A7A7A]">
                  Didn&apos;t recieve OTP? <Button variant={'link'} type="submit" disabled={resendCountdown > 0 || isPending} className="text-[#FF6A00]">Resend OTP</Button> {resendCountdown > 0 && `in ${resendCountdown}s`}
                </span>
                <Button
                  onClick={verifyOtp}
                  className="w-full text-center bg-[#FF8833] text-white mt-4 rounded-full text-md"
                  disabled={isPending}
                >
                  {isPending ?  <Loader2 className="text-white animate-spin text-center" /> : "Verify OTP"}
                </Button>
                {/* <Button
                  type="submit"
                  className="w-full text-center mt-4"
                  disabled={resendCountdown > 0 || isPending}
                >
                  Resend OTP 
                </Button> */}
              </motion.div>
            )}
          </div>
          {error && (
            <motion.div
              className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mt-6"
              role="alert"
              initial={{ opacity: 0, y: -10 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.3 }}
            >
              <span className="block sm:inline">{error}</span>
            </motion.div>
          )}

        </div>
      </div>
    </div>
  );
}

export default OtpLogin;
</file>

<file path="src/components/party/PartyName.tsx">
import React, { useState, useEffect } from 'react';
import { fetchPartyName } from '@/helpers/fetchPartyName';
import { loadingIndicator } from '../ui/LoadingIndicator';

interface DriverNameProps {
    partyId: string;
}

const PartyName: React.FC<DriverNameProps> = ({ partyId }) => {
    const [loading, setLoading] = useState<boolean>(true);
    const [error, setError] = useState<boolean>(false);
    const [driverName, setDriverName] = useState<string>('')

    useEffect(() => {
        const loadPartyName = async () => {
            try {
                const name = await fetchPartyName(partyId);
                console.log(name)
                if (!name) {
                    throw new Error('Name not found');
                }
                setDriverName(name);
            } catch (error: any) {
                setError(true);
            } finally {
                setLoading(false);
            }
        };
        loadPartyName();
    }, [partyId]);

    if (loading) return loadingIndicator;
    if (error || !driverName) return <span>NA</span>;

    return <span>{driverName || ''}</span>;
};

export default PartyName;
</file>

<file path="src/components/party/PaymentModal.tsx">
'use client'
import React, { useEffect, useState } from 'react';
import { ITrip, PaymentBook } from '@/utils/interface';
import { Button } from '@/components/ui/button';
import { motion } from 'framer-motion';
import { useParty } from '@/context/partyContext';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '../ui/select';
import { statuses } from '@/utils/schema';

interface ModalProps {
    isOpen: boolean;
    onClose: () => void;
    onSave: (data: {
        accountType: string;
        amount: number;
        paymentType: 'Cash' | 'Cheque' | 'Online Transfer';
        date: Date; // Ensure date is of type Date
        notes?: string;
        trip_id? : string
    }) => void;
    modalTitle: string;
    accountType: string;
    editData?: PaymentBook | any;

}

const PaymentModal: React.FC<ModalProps> = ({
    isOpen,
    onClose,
    onSave,
    modalTitle,
    accountType,
    editData,
}) => {
    const { party } = useParty()
    const [formState, setFormState] = useState({
        amount: editData?.amount || 0,
        paymentType: editData?.paymentType || 'Cash' as 'Cash' | 'Cheque' | 'Online Transfer',
        date: new Date(editData?.date || Date.now()).toISOString().split('T')[0],
        notes: editData?.notes || '',
        trip_id: editData?.trip_id || ''
    });

    useEffect(() => {
        if (editData) {
            const formattedDate = (editData.date instanceof Date)
                ? editData.date.toISOString().split('T')[0]
                : (editData.date && !isNaN(new Date(editData.date).getTime()))
                    ? new Date(editData.date).toISOString().split('T')[0]
                    : '';
            setFormState({
                amount: editData.amount,
                paymentType: editData.paymentType,
                date: formattedDate,
                notes: editData.notes || '',
                trip_id: editData?.trip_id || ''
            });
        }
    }, [editData]);

    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement | any>) => {
        const { name, value, type, checked } = e.target;
        setFormState(prevState => ({
            ...prevState,
            [name]: type === 'checkbox' ? checked : value
        }));
    };

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        onSave({
            accountType,
            amount: formState.amount,
            paymentType: formState.paymentType,
            date: new Date(formState.date), // Convert date string to Date object
            notes: formState.notes,
            trip_id : formState.trip_id
        });
        onClose();
    };

    const handleSelectChange = (name: string, value: string) => {
        setFormState((prevData) => {
            let updatedData = { ...prevData, [name]: value };

            return updatedData;
        });
    };

    if (!isOpen) return null;

    return (
        <>
            <div className="fixed inset-0 bg-black bg-opacity-50 z-40"></div>
            <motion.div
                initial={{ opacity: 0, scale: 0.5 }}
                animate={{ opacity: 1, scale: 1 }}
                transition={{
                    duration: 0.5,
                    ease: [0, 0.71, 0.2, 1.01]
                }} className="fixed inset-0 z-50 flex items-center justify-center">
                <div className="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
                    <h3 className="text-lg font-semibold mb-4">{modalTitle}</h3>
                    <form onSubmit={handleSubmit}>
                        <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700">Amount*</label>
                            <input
                                type="number"
                                name="amount"
                                value={formState.amount}
                                onChange={handleChange}
                                className="mt-1 p-2 w-full border border-gray-300 rounded-md"
                                onFocus={(e) => {
                                    if (e.target.value === '0') {
                                        e.target.value = '';
                                    }
                                }}
                                required
                            />
                        </div>
                        <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700">Payment Type*</label>
                            <select
                                name="paymentType"
                                value={formState.paymentType}
                                onChange={handleChange}
                                className="mt-1 p-2 w-full border border-gray-300 rounded-md"
                                required
                            >
                                <option value="Cash">Cash</option>
                                <option value="Cheque">Cheque</option>
                                <option value="Online Transfer">Online Transfer</option>
                            </select>
                        </div>
                        <div className='mb-4'>
                            <label className='text-sm text-gray-700'>Select Trip</label>
                            <Select value={formState.trip_id} defaultValue={formState.trip_id} onValueChange={(value) => handleSelectChange('trip_id', value)}>
                                <SelectTrigger className="w-full">
                                    <SelectValue placeholder='(optional)' />
                                </SelectTrigger>
                                <SelectContent>
                                    {party.items?.map((trip: any) => (
                                        trip.type === 'trip' &&
                                        <SelectItem key={trip.trip_id} value={trip.trip_id}>
                                            <div className='flex items-center space-x-2 w-full'>
                                                <span className='font-semibold w-1/2'>{trip.description.origin.split(',')[0]} &rarr; {trip.description.destination.split(',')[0]}</span>
                                                <div className="flex flex-col items-center space-x-2 w-1/2">
                                                    <span >{statuses[trip.status as number]}</span>
                                                    <div className="relative w-full bg-gray-200 h-1 rounded">
                                                        <div
                                                            className={`absolute top-0 left-0 h-1 rounded transition-width duration-500 ${trip.status === 0 ? 'bg-red-500' : trip.status === 1 ? 'bg-yellow-500' : trip.status === 2 ? 'bg-blue-500' : trip.status === 3 ? 'bg-green-500' : 'bg-green-800'}`}
                                                            style={{ width: `${(trip.status as number / 4) * 100}%` }}
                                                        ></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </SelectItem>
                                    ))}
                                </SelectContent>
                            </Select>
                        </div>

                        {/* <div className="mb-4 flex items-center">
                            <input
                                type="checkbox"
                                name="receivedByDriver"
                                checked={formState.receivedByDriver}
                                onChange={handleChange}
                                className="mr-2"
                            />
                            <label className="block text-sm font-medium text-gray-700">Received By Driver</label>
                        </div> */}
                        <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700">Payment Date*</label>
                            <input
                                type="date"
                                name="date"
                                value={formState.date}
                                onChange={handleChange}
                                className="mt-1 p-2 w-full border border-gray-300 rounded-md"
                                required
                            />
                        </div>
                        <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700">Notes</label>
                            <textarea
                                name="notes"
                                value={formState.notes}
                                onChange={handleChange}
                                className="mt-1 p-2 w-full border border-gray-300 rounded-md"
                            />
                        </div>
                        <div className="flex justify-end space-x-4">
                            <Button variant='outline' type="button" onClick={onClose}>
                                Cancel
                            </Button>
                            <Button type="submit">
                                Save
                            </Button>
                        </div>
                    </form>
                </div>
            </motion.div>
        </>
    );
};

export default PaymentModal;
</file>

<file path="src/components/percentageDonut.tsx">
import type React from "react"

interface SlimPercentageDonutProps {
  percentage: number
  size?: number
  strokeWidth?: number
  backgroundColor?: string
  foregroundColor?: string
}

export const PercentageDonut: React.FC<SlimPercentageDonutProps> = ({
  percentage,
  size = 100,
  strokeWidth = 4,
  backgroundColor = "#e5e7eb",
  foregroundColor = "#3b82f6",
}) => {
  const radius = (size - strokeWidth) / 5
  const circumference = radius * 2 * Math.PI
  const offset = circumference - (percentage / 100) * circumference

  return (
    <div className="relative inline-flex items-center justify-center">
      <svg width={size} height={size} className="transform -rotate-90">
        <circle cx={size / 2} cy={size / 2} r={radius} stroke={backgroundColor} strokeWidth={strokeWidth} fill="none" />
        <circle
          cx={size / 2}
          cy={size / 2}
          r={radius}
          stroke={foregroundColor}
          strokeWidth={strokeWidth}
          strokeDasharray={circumference}
          strokeDashoffset={offset}
          fill="none"
          strokeLinecap="round"
          className="transition-all duration-500 ease-in-out"
        />
      </svg>
      <div className="absolute text-xs font-medium">{Math.round(percentage)}%</div>
    </div>
  )
}
</file>

<file path="src/components/RecentActivites.tsx">
import { motion } from 'framer-motion';
import { RxActivityLog } from 'react-icons/rx'; // Ensure this is the correct import for your icons
import { recentIcons } from '@/utils/icons';

const RecentActivities = ({ data }: { data: any}) => {
  // Animation variants for list items
  const itemVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: { opacity: 1, y: 0, transition: { duration: 0.3 } },
  };

  // Animation container variants
  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: { staggerChildren: 0.1 }, // Stagger each child animation
    },
  };

  return (
    <div className='border-t-2 border-t-gray-300 pt-4'>
      {data?.recentActivities?.activities?.length > 0 ? (
        <motion.div
          className='space-y-4' // Add spacing between items
          variants={containerVariants}
          initial="hidden"
          animate="visible"
        >
          {data.recentActivities.activities.map((activity: any, index: number) => (
            <motion.div
              key={index}
              className='flex items-center justify-between mb-4 last:mb-0'
              variants={itemVariants}
            >
              <div className='flex items-center gap-2'>
                <div className="font-medium flex items-center gap-2">
                  {recentIcons[activity.type as string] || (
                    <RxActivityLog
                      size={40}
                      className='text-white bg-blue-500 rounded-lg p-2 border font-semibold'
                    />
                  )}
                  <div className='flex flex-col gap-1'>
                    {activity.type}
                    <p className='text-xs text-gray-400'>
                      {activity.date && new Date(activity.date).toLocaleDateString('en-IN')}
                    </p>
                  </div>
                </div>
              </div>
            </motion.div>
          ))}
        </motion.div>
      ) : (
        <motion.p
          className='text-center text-sm text-gray-500'
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ duration: 0.5 }}
        >
          No Recent Activities
        </motion.p>
      )}
    </div>
  );
};

export default RecentActivities;
</file>

<file path="src/components/RenderDocument.tsx">
'use client'

import { useState } from 'react';
import Link from "next/link";
import Image from "next/image";
import { Button } from './ui/button';

type props = {
    documentUrl : string
}

const isPdf = (fileName: string) => {
    return fileName?.toLowerCase().endsWith('.pdf');
};


const RenderDocument: React.FC<props> = ({documentUrl}) => {
    const [isModalOpen, setIsModalOpen] = useState(false);

    const handleDownload = async () => {
        try {
            const response = await fetch(documentUrl.split('.pdf')[0]);
            const blob = await response.blob();
            const blobUrl = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = blobUrl;
            link.setAttribute('download', documentUrl.split('/').pop() || 'file'); // Set file name or fallback to 'file'
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link); // Clean up link element
            window.URL.revokeObjectURL(blobUrl); // Revoke blob URL after download
        } catch (error) {
            console.error('Error downloading the file:', error);
        }
    };


    const openModal = () => setIsModalOpen(true);
    const closeModal = () => setIsModalOpen(false);

    return (
        <>
            {/* Document Preview Block */}
            <div onClick={openModal} className="relative overflow-hidden h-40 rounded-lg border border-gray-300 transition-shadow duration-200 group w-[200px] cursor-pointer">
                {isPdf(documentUrl) ? (
                    <div className="flex justify-center items-center h-full w-full group-hover:opacity-90 overflow-y-hidden overflow-x-hidden">
                        <iframe
                            src={documentUrl.split('.pdf')[0]}
                            className="w-full h-full"
                            title="PDF Preview"
                        />
                    </div>
                ) : (
                    <div className="flex justify-center items-center h-full w-full">
                        <Image
                            src={documentUrl}
                            alt='Document preview'
                            className="rounded-md object-cover w-full h-full"
                            height={160}
                            width={160}
                        />
                    </div>
                )}
                <div className="absolute inset-0 bg-black opacity-0 group-hover:opacity-20 transition-opacity duration-300 rounded-lg"></div>
            </div>

            {/* Modal */}
            {isModalOpen && (
                <div className="fixed inset-0 flex justify-center items-center z-50 bg-black bg-opacity-50">
                    <div className="relative bg-white rounded-lg shadow-lg p-6 w-[80vw] max-w-3xl">
                        {/* Close button */}
                        <button
                            className="absolute top-3 right-3 text-gray-600 hover:text-gray-800 transition-colors"
                            onClick={closeModal}
                        >
                            &#x2715; {/* Close icon */}
                        </button>

                        {/* Document content */}
                        <div className="h-[70vh] overflow-auto">
                            {isPdf(documentUrl) ? (
                                <iframe
                                    src={documentUrl.split('.pdf')[0]}
                                    className="w-full h-full"
                                    title="Full PDF Preview"
                                />
                            ) : (
                                <Image
                                    src={documentUrl}
                                    alt='Full document preview'
                                    className="rounded-md object-cover w-full h-auto"
                                    height={600}
                                    width={600}
                                />
                            )}
                        </div>

                        {/* Download Button */}
                        <div className="mt-4 flex justify-end">
                            <Button
                                
                                onClick={handleDownload}
                            >
                                Download
                            </Button>
                        </div>
                    </div>
                </div>
            )}
        </>
    );
};

export default RenderDocument
</file>

<file path="src/components/Report.tsx">
'use client'
import { AnimatePresence } from 'framer-motion'
import React, { useState } from 'react'
import { Button } from './ui/button'
import { Loader2, X } from 'lucide-react'
import 'jspdf/dist/polyfills.es.js';
import { jsPDF } from 'jspdf';
import html2canvas from 'html2canvas';

type props = {
    reportContent: string,
    setModalOpen: (isOpen: boolean) => void,
    reportRef : any,
    month : string,
    year : string
}

const Report: React.FC<props> = ({reportContent, setModalOpen, reportRef, month, year}) => {
    
  const [pdfDownloading, setPDFDownloading] = useState<boolean>(false);
    const handleDownloadPDF = async () => {
        try {
          const pdf = new jsPDF({
            orientation: 'landscape',
            unit: 'mm',
            format: 'a4'
          });
          if (reportRef.current) {
            setPDFDownloading(true);
            const canvas = await html2canvas(reportRef.current, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
    
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const imgWidth = canvas.width;
            const imgHeight = canvas.height;
            const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
    
            const imgX = (pdfWidth - imgWidth * ratio) / 2;
            const imgY = (pdfHeight - imgHeight * ratio) / 2;
    
            pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
    
          }
          pdf.save(`Report-${month}-${year}.pdf`);
          setPDFDownloading(false);
        } catch (error) {
          alert('Failed to download pdf')
        }
      };
  return (
    <AnimatePresence mode="wait">
            <div className="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50 overflow-hidden">
              <div className="bg-white max-w-4xl max-h-[700px] w-full p-6 rounded-lg shadow-lg overflow-auto thin-scrollbar">
                <div className="flex justify-between">
                  <h3 className="text-lg font-semibold mb-4">Generated Report</h3>
                  <Button variant='ghost' size='icon' onClick={() => setModalOpen(false)}><X /></Button>
                </div>

                <div id="report" ref={reportRef}
                  className="overflow-auto border border-gray-300 rounded-md p-4 thin-scrollbar"
                  dangerouslySetInnerHTML={{ __html: reportContent }}
                />
                <Button disabled={pdfDownloading} className="mt-4 w-full" onClick={handleDownloadPDF}>
                  {pdfDownloading ? <Loader2 className="text-white animate-spin" /> : "Download as PDF"}
                </Button>

              </div>
            </div>
          </AnimatePresence>
  )
}

export default Report
</file>

<file path="src/components/ScheduleDemo.tsx">
'use client'

import { useState } from 'react'
import { Button } from "@/components/ui/button"
import {
  Dialog,
  DialogContent,
  DialogTrigger,
} from "@/components/ui/dialog"
import { Toaster } from './ui/toaster'
import { useToast } from './hooks/use-toast'
import { loadingIndicator } from './ui/LoadingIndicator'
interface FormData {
  name: string
  phone: string
  email: string
  company: string
  notes: string
}

export default function ScheduleDemo() {
  const [isOpen, setIsOpen] = useState(false)
  const [loading, setLoading] = useState(false)
  const { toast } = useToast()
  const [formData, setFormData] = useState<FormData>({
    name: '',
    phone: '',
    email: '',
    company: '',
    notes: ''
  })

  const handleInputChange = (
    e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>
  ) => {
    const { name, value } = e.target
    setFormData(prev => ({ ...prev, [name]: value }))
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!formData.name || !formData.name) {
      toast({
        description: 'Please fill in the required fields',
        variant: 'warning',
      })
      return
    }
    try {
      // Here you would typically send the form data to your backend
      setLoading(true)
      const res = await fetch('/api/schedule-demo', {
        method: 'POST',
        body: JSON.stringify(formData)
      })
      if (!res.ok) {
        throw new Error('Failed to schedule demo')
      }
      const data = await res.json()
      if (data.status !== 200) {
        throw new Error('Failed to schedule demo')
      }
      setIsOpen(false)
      // Reset form
      setFormData({
        name: '',
        phone: '',
        email: '',
        company: '',
        notes: ''
      })
      toast({
        description: 'We have your details, we will get back to you shortly',
      })
    } catch (error) {
      console.error('Error submitting form:', error)
    }
    setLoading(false)
  }

  return (
    <Dialog open={isOpen} onOpenChange={setIsOpen}>
      <DialogTrigger asChild>
        <Button className="bg-[#CC5500] text-white px-6 py-3 rounded-full text-lg font-bold hover:bg-[#FF6A00] transition-colors duration-300">
          Schedule Demo
        </Button>
      </DialogTrigger>
      <DialogContent className="sm:max-w-[600px] w-full max-w-[95vw] p-0">
        <form onSubmit={handleSubmit} className="p-4 sm:p-6 space-y-4 sm:space-y-6 w-full">
          <div className="space-y-4">
            <div>
              <label htmlFor="name" className="text-base">
                Name <span className="text-red-500">*</span>
              </label>
              <input
                id="name"
                name="name"
                value={formData.name}
                onChange={handleInputChange}
                placeholder="Praveen Yadav"
                className="mt-1.5"
                required
              />
            </div>

            <div>
              <label htmlFor="phone" className="text-base">
                Phone No. <span className="text-red-500">*</span>
              </label>
              <input
                id="phone"
                name="phone"
                type="tel"
                value={formData.phone}
                onChange={handleInputChange}
                placeholder="+91 9876543210"
                className="mt-1.5"
                required
              />
            </div>

            <div>
              <label htmlFor="email" className="text-base">
                Email Id
              </label>
              <input
                id="email"
                name="email"
                type="email"
                value={formData.email}
                onChange={handleInputChange}
                placeholder="example@gmail.com"
                className="mt-1.5"
              />
            </div>

            <div>
              <label htmlFor="company" className="text-base">
                Company Name
              </label>
              <input
                id="company"
                name="company"
                value={formData.company}
                onChange={handleInputChange}
                placeholder="ABC pvt ltd."
                className="mt-1.5"
              />
            </div>

            <div>
              <label htmlFor="notes" className="text-base">
                Notes
              </label>
              <textarea
                id="notes"
                name="notes"
                value={formData.notes}
                onChange={handleInputChange}
                placeholder="How can we help you?"
                className="mt-1.5 resize-none"
                rows={3}
              />
            </div>
          </div>

          <Button
            type="submit"
            className="w-full bg-[#CC5500] hover:bg-[#FF6A00] text-white font-semibold py-3 rounded-lg text-lg"
            disabled={loading}
          >
            {loading ? loadingIndicator : 'Schedule Demo'}
          </Button>
        </form>
      </DialogContent>
      <Toaster />
    </Dialog>
  )
}
</file>

<file path="src/components/search/Driver.tsx">
import { IDriver } from '@/utils/interface'
import { motion } from 'framer-motion'
import { useRouter } from 'next/navigation'
import React from 'react'
import DriverBalance from '../driver/DriverBalance'
import { FaUser, FaPhone } from 'react-icons/fa'

interface props {
  drivers: IDriver[]
}

const Driver: React.FC<props> = ({ drivers }) => {
  const router = useRouter()

  return (
    <div className='flex flex-col space-y-4 w-full'>
      <h1 className='text-bottomNavBarColor text-2xl font-semibold'>Drivers</h1>
      <div className='grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4'>
        {drivers.map((driver, index) => (
          <motion.div
            key={index}
            onClick={() => router.push(`/user/drivers/${driver.driver_id}`)}
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.3 }}
          >
            <div
            className=" rounded-lg p-4 hover:shadow-lg cursor-pointer transition-transform transform duration-300 ease-out hover:scale-105 bg-lightOrangeButtonColor"
            onClick={() => router.push(`/user/drivers/${driver.driver_id}`)}>

            
            <div className='flex items-center gap-3'>
              <FaUser className="text-bottomNavBarColor" />
              <span className='font-semibold text-lg'>{driver.name}</span>
            </div>
            <div className='flex items-center gap-3 mt-2'>
              <FaPhone className="text-green-500" />
              <span>{driver.contactNumber || 'N/A'}</span>
            </div>
            <div className='mt-4'>
              <span
                className={`inline-block px-3 py-1 rounded-full text-sm font-semibold ${
                  driver.status === 'Available' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                }`}
              >
                {driver.status}
              </span>
            </div>
            <div className='mt-4 text-xl font-semibold'>
              <DriverBalance driverId={driver.driver_id} />
            </div>
            </div>
          </motion.div>
        ))}
      </div>
    </div>
  )
}

export default Driver
</file>

<file path="src/components/search/Expense.tsx">
import { IconKey, icons } from '@/utils/icons';
import { IExpense } from '@/utils/interface';
import { motion } from 'framer-motion';
import React from 'react';
import { FaCalendarAlt, FaTruck } from 'react-icons/fa';
import { MdPayment } from 'react-icons/md';

interface props {
  expenses: IExpense[]
}

const Expense: React.FC<props> = ({ expenses }) => {
  return (
    <div className='flex flex-col space-y-4 w-full'>
      <h1 className='text-bottomNavBarColor text-2xl font-semibold'>Expenses</h1>
      <div className='grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4'>
        {expenses.length > 0 && expenses.map((expense, index) => (
          <motion.div
            key={index}
            
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.3 }}
          >
            <div className="border border-gray-200 rounded-lg shadow-md p-4 bg-lightOrangeButtonColor text-buttonTextColor cursor-pointer transform transition-transform duration-300 ease-out hover:shadow-lg hover:scale-105">

            
            <div className='flex items-center space-x-2'>
              <FaCalendarAlt className='text-bottomNavBarColor' />
              <span>{new Date(expense.date).toLocaleDateString()}</span>
            </div>
            <div className='mt-2 text-xl font-semibold'>
              {expense.amount}
            </div>
            <div className="flex items-center space-x-2 mt-4">
              {icons[expense.expenseType as IconKey]}
              <span>{expense.expenseType}</span>
            </div>
            <div className="flex items-center space-x-2 mt-2">
              <MdPayment className="text-green-500" />
              <span>{expense.paymentMode}</span>
            </div>
            <div className='mt-2'>
              {expense.notes || 'N/A'}
            </div>
            <div className='flex items-center space-x-2 mt-4'>
              <FaTruck className='text-bottomNavBarColor' />
              <span>{expense.truck || 'N/A'}</span>
            </div>
            </div>
          </motion.div>
        ))}
      </div>
    </div>
  )
}

export default Expense
</file>

<file path="src/components/search/OfficeExpense.tsx">
import { handleDelete } from '@/helpers/ExpenseOperation';
import { IconKey, icons } from '@/utils/icons';
import { motion } from 'framer-motion';
import React from 'react';
import { FaCalendarAlt } from 'react-icons/fa';
import { FaNoteSticky } from 'react-icons/fa6';
import { MdPayment, MdEdit, MdDelete } from 'react-icons/md';

interface props {
  expenses: any[]
}

const OfficeExpense: React.FC<props> = ({ expenses }) => {
  return (
    <div className='flex flex-col space-y-4 w-full'>
      <h1 className='text-bottomNavBarColor text-2xl font-semibold'>Office Expenses</h1>
      <div className='grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4'>
        {expenses.length > 0 && expenses.map((expense: any, index: number) => (
          <motion.div
            key={index}
            
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.3 }}
          >
            <div className="border border-gray-200 rounded-lg shadow-md p-4 bg-lightOrangeButtonColor text-buttonTextColor cursor-pointer transform transition-transform duration-300 ease-out hover:shadow-lg hover:scale-105">

           
            <div className='flex items-center space-x-2'>
              <FaCalendarAlt className='text-bottomNavBarColor' />
              <span>{new Date(expense.date).toLocaleDateString()}</span>
            </div>
            <div className='mt-2 text-xl font-semibold'>
              {expense.amount}
            </div>
            <div className="flex items-center space-x-2 mt-4">
              {icons[expense.expenseType as IconKey]}
              <span>{expense.expenseType}</span>
            </div>
            <div className="flex items-center space-x-2 mt-2">
              <MdPayment className="text-green-500" />
              <span>{expense.paymentMode}</span>
            </div>
            <div className='flex items-center space-x-2 mt-2'>
                <FaNoteSticky className='text-bottomNavBarColor'/>
                <span>{expense.notes}</span>
            </div>
            </div>
          </motion.div>
        ))}
      </div>
    </div>
  )
}

export default OfficeExpense
</file>

<file path="src/components/search/Party.tsx">
import { IParty } from '@/utils/interface';
import { useRouter } from 'next/navigation';
import React from 'react';
import { FaUserTie, FaPhone, FaAddressBook } from 'react-icons/fa';
import { GoOrganization } from 'react-icons/go';
// import PartyBalance from '../party/PartyBalance';
import { motion } from 'framer-motion';

interface PartyProps {
    parties: IParty[];
}

const Party: React.FC<PartyProps> = ({ parties }) => {
    const router = useRouter();

    return (
        <div className='flex flex-col space-y-4 w-full'>
            <h1 className='text-bottomNavBarColor text-2xl font-semibold'>Parties</h1>
            <div className='grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4'>
                {parties.map((party) => (
                    <motion.div
                        key={party.party_id as string}
                        
                        onClick={() => router.push(`/user/parties/${party.party_id}/trips`)}
                        initial={{ opacity: 0, y: 10 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ duration: 0.3 }}
                    >
                        <div className="border border-gray-200 rounded-lg shadow-md p-4 bg-lightOrangeButtonColor text-buttonTextColor cursor-pointer transform transition-transform duration-300 ease-out hover:shadow-lg hover:scale-105">

                        
                        <div className='flex items-center gap-2'>
                            <GoOrganization className="text-bottomNavBarColor" />
                            <span className='font-semibold text-lg'>{party.name}</span>
                        </div>
                        <div className='flex items-center gap-2 mt-2'>
                            <FaUserTie className="text-bottomNavBarColor" />
                            <span>{party.contactPerson}</span>
                        </div>
                        <div className='flex items-center gap-2 mt-2'>
                            <FaPhone className="text-green-500" />
                            <span>{party.contactNumber}</span>
                        </div>
                        <div className='flex items-center gap-2 mt-2'>
                            <FaAddressBook className="text-bottomNavBarColor" />
                            <span>{party.address}</span>
                        </div>
                        <div className='mt-2 text-sm'>
                            GST: {party.gstNumber || 'N/A'}
                        </div>
                        <div className='mt-4 text-xl font-semibold'>
                            {/* <PartyBalance partyId={party.party_id} /> */}
                        </div>
                        </div>
                    </motion.div>
                ))}
            </div>
        </div>
    );
};

export default React.memo(Party);
</file>

<file path="src/components/search/Supplier.tsx">
import { ISupplier } from '@/utils/interface';
import { useRouter } from 'next/navigation';
import React from 'react';
import { FaUserTie, FaPhone } from 'react-icons/fa';
import { motion } from 'framer-motion';

interface props {
    suppliers: ISupplier[];
}

const Supplier: React.FC<props> = ({ suppliers }) => {
    const router = useRouter();

    return (
        <div className='flex flex-col space-y-4 w-full'>
            <h1 className='text-bottomNavBarColor text-2xl font-semibold'>Suppliers</h1>
            <div className='grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4'>
                {suppliers.map((supplier) => (
                    <motion.div
                        key={supplier.supplier_id as string}
                        
                        onClick={() => router.push(`suppliers/${supplier.supplier_id}/trips`)}
                        initial={{ opacity: 0, y: 10 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ duration: 0.3 }}
                    >
                        <div className="border border-gray-200 rounded-lg shadow-md p-4 bg-lightOrangeButtonColor text-buttonTextColor cursor-pointer transform transition-transform duration-300 ease-out hover:shadow-lg hover:scale-105">
                        <div className='flex items-center gap-2'>
                            <FaUserTie className="text-bottomNavBarColor" />
                            <span className='font-semibold text-lg'>{supplier.name}</span>
                        </div>
                        <div className='flex items-center gap-2 mt-2'>
                            <FaPhone className="text-green-500" />
                            <span>{supplier.contactNumber}</span>
                        </div>
                        </div>
                    </motion.div>
                ))}
            </div>
        </div>
    );
};

export default Supplier;
</file>

<file path="src/components/search/SupplierAccount.tsx">
import { ISupplierAccount } from '@/utils/interface';
import { motion } from 'framer-motion';
import React from 'react';
import { FaCalendarAlt, FaWallet, FaRoute } from 'react-icons/fa';
import TripRoute from '../trip/TripRoute';
import SupplierName from '../supplier/SupplierName';

interface props {
    accounts: ISupplierAccount[];
}

const SupplierAccount: React.FC<props> = ({ accounts }) => {
    return (
        <div className='flex flex-col space-y-4 w-full'>
            <h1 className='text-bottomNavBarColor text-2xl font-semibold'>Supplier Accounts</h1>
            <div className='grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4'>
                {accounts && accounts.map((acc: ISupplierAccount, index: number) => (
                    <motion.div
                        key={index}
                        
                        initial={{ opacity: 0, y: 10 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ duration: 0.3 }}
                    >
                      <div className="border border-gray-200 rounded-lg shadow-md p-4 bg-lightOrangeButtonColor text-buttonTextColor cursor-pointer transform transition-transform duration-300 ease-out hover:shadow-lg hover:scale-105">
                        <div className='flex items-center gap-2'>
                            <SupplierName supplierId={acc.supplier_id} />
                        </div>
                        <div className='flex items-center gap-2 mt-2'>
                            <FaCalendarAlt className="text-bottomNavBarColor" />
                            <span>{new Date(acc.date).toLocaleDateString()}</span>
                        </div>
                        <div className='flex flex-col space-y-2 mt-4'>
                            <div className='flex items-center gap-2'>
                                <FaWallet className="text-bottomNavBarColor" />
                                <span>Trip Payment</span>
                            </div>
                            <hr className='text-gray-200'/>
                            <div className='flex items-center gap-2'>
                                <FaRoute className="text-bottomNavBarColor" />
                                <TripRoute tripId={acc.trip_id} />
                            </div>
                        </div>
                        <div className='mt-4 text-green-600 font-semibold'>
                            {acc.amount}
                        </div>
                        </div>
                    </motion.div>
                ))}
            </div>
        </div>
    );
};

export default SupplierAccount;
</file>

<file path="src/components/search/Trip.tsx">
import { ITrip } from '@/utils/interface';
import { statuses } from '@/utils/schema';
import React from 'react';
import { FaCalendarAlt, FaTruck, FaRoute, FaFileInvoiceDollar } from 'react-icons/fa';
import { GoOrganization } from 'react-icons/go';
import PartyName from '../party/PartyName';
import { useRouter } from 'next/navigation';
import { motion } from 'framer-motion';
import { FaNoteSticky } from 'react-icons/fa6';

interface tripProps {
    trips: ITrip[];
}

const Trip: React.FC<tripProps> = ({ trips }) => {
    const router = useRouter();

    return (
        <div className='flex flex-col space-y-4 w-full'>
            <h1 className='text-bottomNavBarColor text-2xl font-semibold'>Trips</h1>

            <div className='grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6'>
                {trips.map((trip, index) => (
                    <motion.div
                        key={index}

                        onClick={() => router.push(`/user/trips/${trip.trip_id}`)}
                        initial={{ opacity: 0, y: 10 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ duration: 0.3 }}
                    >
                        <div className='border border-gray-200 rounded-lg shadow-md p-4 bg-lightOrangeButtonColor text-buttonTextColor cursor-pointer transform transition-transform duration-300 ease-out hover:shadow-lg hover:scale-105'>
                            <div className='flex items-center space-x-2 mb-2'>
                                <FaCalendarAlt className="text-bottomNavBarColor" />
                                <span>{new Date(trip.startDate).toLocaleDateString()}</span>
                            </div>
                            <div className='mb-2'>
                                <span className='font-medium'>LR: </span>{trip.LR}
                            </div>
                            <div className='flex items-center space-x-2 mb-2'>
                                <FaTruck className="text-bottomNavBarColor" />
                                <span>{trip.truck}</span>
                            </div>
                            <div className='flex items-center space-x-2 mb-2'>
                                <GoOrganization className="text-bottomNavBarColor" />
                                <span><PartyName partyId={trip.party} /></span>
                            </div>
                            <div className='flex items-center space-x-2 mb-2'>
                                <FaRoute className="text-bottomNavBarColor" />
                                <span>{trip.route.origin.split(',')[0]} -&gt; {trip.route.destination.split(',')[0]}</span>
                            </div>
                            <div className='mb-2'>
                                <span className='font-medium'>Status: </span>
                                <div className='relative w-full bg-gray-200 h-1 rounded'>
                                    <div className={`absolute top-0 left-0 h-1 rounded transition-width duration-500 ${trip.status === 0 ? 'bg-red-500' : trip.status === 1 ? 'bg-yellow-500' : trip.status === 2 ? 'bg-blue-500' : trip.status === 3 ? 'bg-green-500' : 'bg-green-800'}`} style={{ width: `${(trip.status as number / 4) * 100}%` }}></div>
                                </div>
                                <span className='text-sm ml-2'>{statuses[trip.status as number]}</span>
                            </div>
                            <div className='flex items-center space-x-2'>
                                <FaNoteSticky className="text-bottomNavBarColor" />
                                <span>{trip.notes}</span>
                            </div>
                            <div className="bg-lightOrange shadow-lg rounded-lg divide-y divide-gray-200 mt-4">
                                {trip.accounts.map((item, index) => (
                                    <div
                                        key={index}
                                        className="flex flex-col px-4 py-2 transition duration-300 ease-out transform hover:scale-105 rounded-lg cursor-pointer text-sm"
                                    >
                                        <div className="flex items-center justify-between">
                                            <div className="flex-1">
                                                <p className="font-medium text-buttonTextColor">{item.paymentType}</p>
                                                <p className="text-xs text-buttonTextColor">Amount: {item.amount}</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-xs text-buttonTextColor">Date: {new Date(item.date).toLocaleDateString()}</p>
                                            </div>
                                        </div>
                                        <div className="mt-2 bg-gray-100 p-2 rounded-md border border-gray-300 text-xs">
                                            <p className="text-gray-600">
                                                Received by Driver: {item.receivedByDriver ? 'Yes' : 'No'}
                                            </p>
                                            {item.notes && (
                                                <p className="text-gray-600 mb-2">Notes: {item.notes}</p>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </motion.div>
                ))}
            </div>
        </div>
    );
}

export default Trip;
</file>

<file path="src/components/search/TripCharges.tsx">
import React from 'react'

interface props {
    charges: any[]
}

const TripCharges: React.FC<props> = ({ charges }) => {
    return (
        <div className='flex flex-col space-y-4 w-full'>
            <h1 className='text-bottomNavBarColor text-2xl font-semibold'>Trip Charges</h1>
            <div className="bg-white shadow-lg rounded-lg divide-y divide-gray-200">
                {charges.map((charge: any, index: number) => (
                    <div
                        key={index}
                        className="flex flex-col px-4 py-4 w-1/2 bg-lightOrangeButtonColor transition duration-300 ease-out transform hover:scale-105 rounded-lg cursor-pointer"
                    >
                        <div className="flex items-center justify-between">
                            <div className="flex-1">
                                <p className="text-sm font-medium text-gray-900">Amount: {charge.amount}</p>
                                <p className="text-xs text-gray-600">Type: {charge.expenseType}</p>
                            </div>
                            <div className="text-right">
                                <p className="text-xs text-gray-600">Date: {new Date(charge.date).toLocaleDateString()}</p>
                                <p className={`text-xs font-semibold ${charge.partyBill ? 'text-green-600' : 'text-red-600'}`}>
                                    {charge.partyBill ? 'Added to Bill' : 'Reduced from Bill'}
                                </p>
                            </div>
                        </div>
                        <div className="mt-4 bg-gray-100 p-4 rounded-md border border-gray-300">
                            {charge.notes && (
                                <p className="text-xs text-gray-600 mb-2">Notes: {charge.notes}</p>
                            )}
                        </div>
                    </div>
                ))}
            </div>
        </div>
    )
}

export default TripCharges
</file>

<file path="src/components/search/Truck.tsx">
import { TruckModel } from '@/utils/interface';
import { motion } from 'framer-motion';
import { useRouter } from 'next/navigation';
import React from 'react';
import { truckTypesIcons } from '@/utils/utilArray';

interface props {
    trucks: TruckModel[];
}

const Truck: React.FC<props> = ({ trucks }) => {
    const router = useRouter();

    return (
        <div className='flex flex-col w-full space-y-4'>
            <h1 className='text-bottomNavBarColor text-2xl font-semibold'>Trucks</h1>
            <motion.div
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ duration: 0.3 }}
                className='grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6'
            >
                {trucks.map((truck, index) => {
                    const Icon = truckTypesIcons.find(item => item.type === truck.truckType)?.Icon;
                    return (
                        <div
                            key={index}
                            className="border border-gray-200 rounded-lg shadow-md p-4 bg-lightOrangeButtonColor text-buttonTextColor cursor-pointer transform transition-transform duration-300 ease-out hover:shadow-lg hover:scale-105"
                            onClick={() => router.push(`/user/trucks/${truck.truckNo}`)}
                        >
                            <div className="flex items-center justify-between mb-4">
                                <h2 className="text-xl font-semibold">{truck.truckNo}</h2>
                                {Icon && <Icon className="inline-block h-8 w-8 text-bottomNavBarColor" />}
                            </div>
                            <div className="mb-2">
                                <span className="font-medium">Type: </span>
                                <span>{truck.truckType}</span>
                            </div>
                            <div className="mb-2">
                                <span className="font-medium">Ownership: </span>
                                <span>{truck.ownership}</span>
                            </div>
                            <div>
                                <span
                                    className={`inline-block px-3 py-1 rounded-full text-sm font-semibold ${truck.status === 'Available' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                                        }`}
                                >
                                    {truck.status}
                                </span>
                            </div>
                        </div>
                    );
                })}
            </motion.div>
        </div>
    );
}

export default Truck;
</file>

<file path="src/components/shopkhata/dropDownMenu.tsx">
import React from 'react';
import { MdDeleteForever, MdEdit } from "react-icons/md";
import { Button } from '../ui/button';
import { motion } from 'framer-motion';

interface DropdownMenuProps {
  onEditClick: () => void;
  onDeleteClick: () => void;
}

const DropdownMenu: React.FC<DropdownMenuProps> = ({ onEditClick, onDeleteClick }) => {
  const [dropdownOpen, setDropdownOpen] = React.useState(false);

  return (
    <div className="relative">
      <Button
        onClick={() => setDropdownOpen(!dropdownOpen)}
      >
        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path
            fillRule="evenodd"
            d="M10 12a2 2 0 100-4 2 2 0 000 4zM10 2a2 2 0 100 4 2 2 0 000-4zm0 16a2 2 0 100-4 2 2 0 000 4z"
            clipRule="evenodd"
          />
        </svg>
      </Button>
      {dropdownOpen && (
        <motion.div
        initial={{ opacity: 0, y: -10 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.2 }} className="absolute right-0 mt-2 w-48 bg-white shadow-lg rounded-md flex flex-col gap-2 p-2 z-10">
          <Button
            variant={'ghost'}
            onClick={onEditClick}
          >
            <MdEdit style={{ width: '20px', height: '20px' }} /> Edit
          </Button>
          <Button
            variant={'destructive'}
            onClick={onDeleteClick}
          >
            <MdDeleteForever style={{ width: '20px', height: '20px' }} /> Delete
          </Button>
        </motion.div>
      )}
    </div>
  );
};

export default DropdownMenu;
</file>

<file path="src/components/shopkhata/EditShopModal.tsx">
// components/EditDriverModal.tsx
import React, { useState } from 'react';
import { IDriver } from '@/utils/interface';
import { isValidPhone } from '@/utils/validate';
import { Button } from '../ui/button';

interface EditDriverModalProps {
  name: string;
  shopId: string;
  handleEdit: (driverName: string, mobileNumber: string) => void;
  onCancel : () =>void;
  contactNumber : string
}

const EditShopModal: React.FC<EditDriverModalProps> = ({ name, shopId, handleEdit, onCancel, contactNumber }) => {
  const [driverName, setDriverName] = useState<string>(name);
  const [mobileNumber, setMobileNumber] = useState<string>(contactNumber); // Initialize mobileNumber with an empty string

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault(); // Prevent default form submission
    if (!isValidPhone(mobileNumber)) {
      alert('Enter a Valid Phone')
      return
    }
    handleEdit(driverName, mobileNumber);
  };

  return (
    <div className="modal-class">
      <div className="bg-white p-6 rounded-md w-full max-w-md">
        <h2 className="text-2xl mb-4">Edit Driver</h2>
        <form onSubmit={handleSubmit}>
          <div className="mb-4">
            <label className="block text-gray-700">Name</label>
            <input
              type="text"
              value={driverName}
              onChange={(e) => setDriverName(e.target.value)}
            />
          </div>
          <div className="mb-4">
            <label className="block text-gray-700">Mobile Number</label>
            <input
              type="text"
              value={mobileNumber}
              onChange={(e) => setMobileNumber(e.target.value)}
            />
          </div>
          <div className="flex justify-end space-x-2">
            <Button
              type="button"
              variant={'outline'}
              onClick={() => {setDriverName(name)
                onCancel()
              }} // Reset name field to original value on cancel
            >
              Cancel
            </Button>
            <Button
              type="submit"
            >
              Save
            </Button>
          </div>
        </form>
      </div>
    </div>
  );
};

export default EditShopModal;
</file>

<file path="src/components/shopkhata/shopActions.tsx">
import React from 'react';
import { Button } from '../ui/button';

interface ShopActionsProps {
  onCreditClick: () => void;
  onPaymentClick: () => void;
}

const ShopActions: React.FC<ShopActionsProps> = ({ onCreditClick, onPaymentClick }) => {
  return (
    <div className="mr-4 flex items-center gap-2">
      <Button
        variant={'destructive'}
        onClick={onPaymentClick}
      >
        (-) Shop Payment
      </Button>
      <Button
        variant={'ghost'}
        onClick={onCreditClick}
      >
        (+) Shop Credit
      </Button>
    </div>
  );
};

export default ShopActions;
</file>

<file path="src/components/shopkhata/ShopBalance.tsx">
import { formatNumber } from '@/utils/utilArray';
import React, { useEffect, useState } from 'react';

type Props = {
  shopId: string;
};

const ShopBalance: React.FC<Props> = ({ shopId }) => {
  const [balance, setBalance] = useState<number>(0);

  const fetchBalance = async () => {
    try {
      const res = await fetch(`/api/shopkhata/${shopId}/accounts/calculate`);
      const data = res.ok ? await res.json() : alert('Failed to calculate balance');
      setBalance(data.balance);
    } catch (error) {
      console.log(error);
      alert('Failed to calculate balance');
    }
  };

  useEffect(() => {
    if (shopId) {
      fetchBalance();
    }
  }, [shopId]);

  return (
    <div
      className={`text-xl font-bold ${
        balance < 0 ? 'text-red-500' : 'text-green-500'
      }`}
    >
      {balance < 0 ? `- ${formatNumber(Math.abs(balance))}` : `${formatNumber(balance)}`}
    </div>
  );
};

export default ShopBalance;
</file>

<file path="src/components/shopkhata/ShopKhataForm.tsx">
'use client'

import React, { useState } from 'react';
import { IParty } from '@/utils/interface';
import { v4 as uuidv4 } from 'uuid';
import { Button } from '../ui/button';

interface Props {
  onSubmit: (shop : any) => void;
}

const ShopKhataForm: React.FC<Props> = ({ onSubmit }) => {
  // State to hold form data
  const [formData, setFormData] = useState<Partial<any>>({
    name: '',
    contactNumber: '',
    address: '',
    gstNumber: '',
  });

  const handleFocus = (e: React.FocusEvent<HTMLInputElement>) => {
    if (e.target.value === '0') {
      handleChange({ target: { name: e.target.name, value: '' } } as React.ChangeEvent<HTMLInputElement>);
    }
  };

  // Handle input changes and update the state
  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target;
    setFormData(prevState => ({
      ...prevState,
      [name]: value,
    }));
  };

  // Handle form submission
  const handleSubmit = (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    // Generate a unique party ID
    // Create a new party object
   // Type assertion to ensure newParty matches IParty
    // Call onSubmit with the new party object
    const newShop = {
        ...formData
    }
    onSubmit(newShop);
    // Optionally, clear the form after submission
    setFormData({
      name: '',
      contactNumber: '',
      address: '',
      gstNumber: '',
      balance: 0,
    });
  };

  return (
    <form onSubmit={handleSubmit} className="w-full max-w-md mx-auto p-4 bg-white shadow-md rounded-md text-black">
      <label className="block mb-2">
        Name*
        <input
          type="text"
          name="name"
          value={formData.name}
          onChange={handleChange}
          required
          className="block w-full p-2 mt-1 border border-gray-300 rounded-md"
        />
      </label>
      
      <label className="block mb-2">
        Contact Number:
        <input
          type="text"
          name="contactNumber"
          value={formData.contactNumber}
          onChange={handleChange}
          className="block w-full p-2 mt-1 border border-gray-300 rounded-md"
        />
      </label>
      <label className="block mb-2">
        Address:
        <input
          type="text"
          name="address"
          value={formData.address}
          onChange={handleChange}
          className="block w-full p-2 mt-1 border border-gray-300 rounded-md"
        />
      </label>
      <label className="block mb-2">
        GST Number:
        <input
          type="text"
          name="gstNumber"
          value={formData.gstNumber}
          onChange={handleChange}
          className="block w-full p-2 mt-1 border border-gray-300 rounded-md"
        />
      </label>
      <Button type="submit" className='mt-2 w-full'>
        Submit
      </Button>
    </form>
  );
};

export default ShopKhataForm;
</file>

<file path="src/components/shopkhata/ShopLayout.tsx">
'use client';

import React, { useState } from 'react';
import { useRouter, usePathname } from 'next/navigation';
import DropdownMenu from './dropDownMenu'
import ShopActions from './shopActions';
import ShopModal from './ShopModal';
import EditShopModal from './EditShopModal';
import Link from 'next/link';
import { FaStore, FaMapMarkerAlt } from 'react-icons/fa';
import { IoDocuments } from 'react-icons/io5';
import ShopBalance from './ShopBalance';

interface ShopLayoutProps {
  name: string;
  shopId: string;
  onShopUpdate: (shop: any) => void;
  contactNumber: string;
  children: React.ReactNode;
}

const ShopLayout: React.FC<ShopLayoutProps> = ({ name, shopId, onShopUpdate, contactNumber, children }) => {
  const router = useRouter();
  const pathname = usePathname();

  const [modalOpen, setModalOpen] = useState(false);
  const [modalType, setModalType] = useState<'credit' | 'payment' | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [edit, setEdit] = useState<boolean>(false);
  const [showContact, setShowContact] = useState<boolean>(false);


  const openModal = (type: 'credit' | 'payment') => {
    setModalType(type);
    setModalOpen(true);
  };

  const closeModal = () => {
    setModalOpen(false);
    setModalType(null);
    setError(null);
  };

  const handleConfirm = async (amount: number, reason: string, date: string) => {
    try {
      const response = await fetch(`/api/shopkhata/${shopId}/accounts`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          credit: modalType === 'credit' ? amount : 0,
          payment: modalType === 'payment' ? amount : 0,
          reason,
          date,
        }),
      });

      if (!response.ok) {
        throw new Error('Failed to update shop');
      }

      const data = await response.json();
      onShopUpdate(data.shop);

      closeModal();
    } catch (error: any) {
      setError(error.message);
    }
  };

  const handleEditShop = async (shopName: string, mobileNumber: string) => {
    try {
      const response = await fetch(`/api/shopkhata/${shopId}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          name: shopName,
          contactNumber: mobileNumber,
        }),
      });

      if (!response.ok) {
        throw new Error('Failed to update shop');
      }

      const data = await response.json();
      onShopUpdate(data.shop);
      setEdit(false);
      router.push('/user/shops');
    } catch (error: any) {
      setError(error.message);
    }
  };

  const handleDeleteShop = async () => {
    try {
      const response = await fetch(`/api/shops/${shopId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
      });

      if (!response.ok) {
        throw new Error('Failed to delete shop');
      }

      alert('Shop Removed Successfully');
      router.push('/user/shops');
    } catch (error: any) {
      setError(error.message);
    }
  };

  return (
    <div className='flex flex-col gap-2 justify-start'>
      <div className="flex items-center justify-between p-4 bg-gray-200 rounded-sm">
        <div className="flex items-center gap-2">
          <h1 className="text-3xl font-bold mr-5 cursor-pointer" onClick={() => setShowContact(!showContact)}>
            {name}
          </h1>
          {showContact && <span className="ml-2 text-lg text-gray-700">{contactNumber}</span>}
          
        </div>
        <div className="flex items-center">
          <ShopActions onCreditClick={() => openModal('credit')} onPaymentClick={() => openModal('payment')} />
          <DropdownMenu onEditClick={() => setEdit(true)} onDeleteClick={handleDeleteShop} />
        </div>

        <ShopModal open={modalOpen} onClose={closeModal} type={modalType} onConfirm={handleConfirm} />
        {error && <div className="text-red-500 mt-2">{error}</div>}
        {edit && (
          <EditShopModal name={name} shopId={shopId} handleEdit={handleEditShop} onCancel={() => setEdit(false)} contactNumber={contactNumber} />
        )}
      </div>
      <div>
        <div className="flex items-center justify-between p-3 bg-gray-200 rounded-sm w-fit">
          <span className="text-2xl">Shop Balance: <ShopBalance shopId={shopId} /></span> {/* Display balance */}
        </div>
        <div className="mt-4">{children}</div>
      </div>
    </div>
  );
};

export default ShopLayout;
</file>

<file path="src/components/shopkhata/ShopSelect.tsx">
import React, { useState } from 'react';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { loadingIndicator } from '../ui/LoadingIndicator';

interface IShop {
  shop_id: string;
  name: string;
}

type Props = {
  shops: IShop[];
  formData: any;
  setFormData: any;
  handleChange: (e: React.ChangeEvent<HTMLSelectElement>) => void;
};

const ShopSelect: React.FC<Props> = ({ shops, formData, handleChange }) => {
  const [searchTerm, setSearchTerm] = useState<string>('');

  const handleOptionSelect = (value: string) => {
    const event = {
      target: {
        name: 'shop_id',
        value: value,
      },
    } as React.ChangeEvent<HTMLSelectElement>;
    handleChange(event);
  };

  const filteredShops = shops.filter(shop =>
    shop.name.toLowerCase().includes(searchTerm.toLowerCase())
  );

  return (
    <div>
      <label>Shop</label>
      <Select name="shop" value={formData.shop_id} onValueChange={handleOptionSelect}>
        <SelectTrigger className="w-full">
          <SelectValue placeholder="Select Shop" />
        </SelectTrigger>
        <SelectContent>
          <div className="p-2">
            <input
              type="text"
              placeholder="Search..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full p-2 border border-gray-300 rounded-md"
            />
          </div>
          {shops.length > 0 ?
            filteredShops.length > 0 ? (
              filteredShops.map((shop) => (
                <SelectItem key={shop.shop_id} value={shop.shop_id}>
                  {shop.name}
                </SelectItem>
              ))
            ) : (
              <div className="p-2 text-gray-500">No shops found</div>
            )
            : <p>fetching shops... {loadingIndicator}</p>}

        </SelectContent>
      </Select>
    </div>
  );
};

export default ShopSelect;
</file>

<file path="src/components/SingleFileUploader.tsx">
'use client'

import React, { useCallback, useState } from 'react'
import { useDropzone } from 'react-dropzone'
import { File } from 'lucide-react'

interface SingleFileUploaderProps {
  onFileChange: (file: File) => Promise<void>
}

const SingleFileUploader: React.FC<SingleFileUploaderProps> = ({ onFileChange }) => {
  const [selectedFile, setSelectedFile] = useState<File | null>(null)

  const onDrop = useCallback((acceptedFiles: File[]) => {
    if (acceptedFiles.length > 0) {
      const file = acceptedFiles[0]
      setSelectedFile(file)
      onFileChange(file)
    }
  }, [onFileChange])

  const { getRootProps, getInputProps, isDragActive } = useDropzone({
    onDrop,
    accept: {
      'application/pdf': ['.pdf'],
      'image/*': ['.png', '.jpg', '.jpeg', '.gif']
    },
    multiple: false
  })

  return (
    <div className="w-full max-w-md mx-auto">
      <div 
        {...getRootProps()} 
        className={`border-2 border-dashed rounded-lg p-6 text-center cursor-pointer transition-colors ${
          isDragActive ? 'border-primary bg-primary/10' : 'border-input hover:border-primary'
        }`}
      >
        <input {...getInputProps()} />
        {isDragActive ? (
          <p className="text-sm text-muted-foreground">Drop the file here ...</p>
        ) : (
          <p className="text-sm text-muted-foreground">Drag &apos;n&apos; drop a file here, or click to select a file</p>
        )}
      </div>
      {selectedFile && (
        <div className="mt-4 p-4 bg-muted rounded-lg flex items-center space-x-3">
          <File className="h-6 w-6 text-primary" />
          <div>
            <p className="text-sm font-medium">{selectedFile.name}</p>
            <p className="text-xs text-muted-foreground">
              {(selectedFile.size / 1024 / 1024).toFixed(2)} MB
            </p>
          </div>
        </div>
      )}
    </div>
  )
}

export default SingleFileUploader
</file>

<file path="src/components/supplier/EditSupplierModal.tsx">
import React, { useState } from 'react';
import { Button } from '../ui/button';
import { ISupplier } from '@/utils/interface';
import { Loader2 } from 'lucide-react';

interface EditSupplierModalProps {
    supplier: ISupplier;
    isOpen: boolean;
    onClose: () => void;
    onSave: (updatedSupplier: ISupplier) => void;
}

const EditSupplierModal = ({ supplier, isOpen, onClose, onSave }: EditSupplierModalProps) => {
    const [name, setName] = useState(supplier.name);
    const [contactNumber, setContactNumber] = useState(supplier.contactNumber);
    const [saving, setSaving] = useState(false);

    const handleSave = () => {
        setSaving(true);
        const updatedSupplier = { ...supplier, name, contactNumber };
        onSave(updatedSupplier as any);
        setSaving(false);
    };

    if (!isOpen) return null;

    return (
        <div className="modal-class">
            <div className="bg-white p-6 rounded shadow-lg w-96">
                <h2 className="text-xl font-bold mb-4">Edit Supplier</h2>
                <div className="mb-4">
                    <label className="block text-gray-700">Name</label>
                    <input
                        type="text"
                        value={name}
                        onChange={(e) => setName(e.target.value)}
                        className="mt-1 block w-full p-2 border rounded"
                    />
                </div>
                <div className="mb-4">
                    <label className="block text-gray-700">Contact Number</label>
                    <input
                        type="text"
                        value={contactNumber}
                        onChange={(e) => setContactNumber(e.target.value)}
                        className="mt-1 block w-full p-2 border rounded"
                    />
                </div>
                <div className="flex justify-end space-x-2">
                    <Button variant={'outline'} onClick={onClose}>Cancel</Button>
                    <Button  onClick={handleSave} disabled={saving}>{saving ? <Loader2 className='text-bottomNavBarColor animate-spin' /> : 'Save'}</Button>
                </div>
            </div>
        </div>
    );
};

export default EditSupplierModal;
</file>

<file path="src/components/supplier/SupplierBalance.tsx">
import { formatNumber } from '@/utils/utilArray';
import React, { useState, useEffect } from 'react';

interface DriverNameProps {
    supplierId: string;
}

const SupplierBalance: React.FC<DriverNameProps> = ({ supplierId }) => {
    const [loading, setLoading] = useState<boolean>(true);
    const [error, setError] = useState<boolean>(false);
    const [balance, setBalance] = useState<number>(0)

    useEffect(() => {
        const loadSupplierBalance = async () => {
            try {
                const res = await fetch(`/api/suppliers/${supplierId}/calculateBalance`);
                const data = await res.json()
                const {balance} = data
                setBalance(balance);
            } catch (error: any) {
                setError(true);
            } finally {
                setLoading(false);
            }
        };
        loadSupplierBalance();
    }, [supplierId]);

    if (loading) return <span>Loading...</span>;
    if (error || !balance) return <span>NA</span>;

    return <span className={balance < 0 ? 'text-red-600 p-2 font-semibold' : 'text-green-600 p-2 font-semibold'}>{formatNumber(balance) || ''}</span>;
};

export default SupplierBalance;
</file>

<file path="src/components/supplier/SupplierName.tsx">
import React, { useEffect, useState } from 'react'

interface props{
    supplierId : string
}

const SupplierName:React.FC<props> = ({supplierId}) => {
    const [name, setName] = useState('')
    const fetchSupplierName = async()=>{
        const supplier = await fetch(`/api/suppliers/${supplierId}`)
        const supplierData = await supplier.json()
        setName(supplierData.supplier.name)
    }
    useEffect(()=>{
        fetchSupplierName()
    },[supplierId])
  return (
    <div>{name}</div>
  )
}

export default SupplierName
</file>

<file path="src/components/supplier/TripAllocationModal.tsx">
import React, { useState } from 'react';
import { Button } from '../ui/button';
import { ITrip } from '@/utils/interface';

interface TripAllocationModalProps {
    isOpen: boolean;
    onClose: () => void;
    trips: ITrip[];
    truckHireCosts: Record<string, number>;
    totalAmount: number;
    onAllocate: (tripAllocations: Record<string, number>) => void;
}

const TripAllocationModal = ({ isOpen, onClose, trips, truckHireCosts, totalAmount, onAllocate }: TripAllocationModalProps) => {
    const [tripAllocations, setTripAllocations] = useState<Record<string, number>>({});

    const handleAllocationChange = (tripId: string, allocatedAmount: number) => {
        const trip = trips.find(trip => trip.trip_id === tripId);
        if (trip && allocatedAmount > truckHireCosts[tripId]) {
            alert(`Allocated amount cannot exceed the remaining truck hire cost of ${truckHireCosts[tripId]}`);
            return;
        }
        setTripAllocations(prev => ({ ...prev, [tripId]: allocatedAmount }));
    };

    const totalAllocatedAmount = Object.values(tripAllocations).reduce((sum, amount) => sum + (amount || 0), 0);

    const handleSave = () => {
        onAllocate(tripAllocations);
        onClose();
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 overflow-auto">
            <div className="bg-white p-6 rounded shadow-lg w-3/4 max-w-xl">
                <h2 className="text-xl font-bold mb-4">Allocate Amount to Trips</h2>
                {(totalAmount > Object.values(truckHireCosts).reduce((sum, cost) => sum + cost, 0)) ? (
                    <p className="text-red-500">The amount exceeds the total truck hire cost of all trips.</p>
                ) : (
                    <div className="space-y-2">
                        {trips.map((trip) => (
                            <div key={trip.trip_id} className="flex items-center justify-between bg-gray-100 p-2 rounded-md shadow-sm">
                                <span className="flex-1 text-gray-700">{trip.route.origin} &rarr; {trip.route.destination}</span>
                                <input
                                    type="number"
                                    value={tripAllocations[trip.trip_id] || ''}
                                    onChange={(e) => handleAllocationChange(trip.trip_id, Number(e.target.value))}
                                    className="w-28 p-2 border rounded"
                                    placeholder="Amount"
                                    disabled={totalAllocatedAmount >= totalAmount}
                                />
                                <span className="text-gray-700 font-semibold ml-1">/{truckHireCosts[trip.trip_id]}</span>
                            </div>
                        ))}
                    </div>
                )}
                <div className="flex justify-end space-x-2 mt-4">
                    <Button variant="outline" onClick={onClose}>Cancel</Button>
                    <Button onClick={handleSave} disabled={totalAllocatedAmount > totalAmount}>Save</Button>
                </div>
            </div>
        </div>
    );
};

export default TripAllocationModal;
</file>

<file path="src/components/trip/BillingInfo.tsx">
import { formatNumber } from "@/utils/utilArray";
import React, { useEffect } from "react";

interface BillingInfoProps {
  formData: any;
  handleChange: (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => void;
  setFormData: React.Dispatch<React.SetStateAction<any>>;
}

export const BillingInfo: React.FC<BillingInfoProps> = ({ formData, handleChange, setFormData }) => {
  useEffect(() => {
    // If billing type is not Fixed, calculate the new amount
    if (formData.billingType !== "Fixed") {
      const newAmount = (parseFloat(formData.perUnit) || 0) * (parseFloat(formData.totalUnits) || 0);
      setFormData((prevFormData: any) => ({
        ...prevFormData,
        amount: newAmount,
      }));
    }
  }, [formData.billingType, formData.perUnit, formData.totalUnits, setFormData]);

  const handleFocus = (e: React.FocusEvent<HTMLInputElement>) => {
    if (e.target.value === "0") {
      handleChange({
        target: { name: e.target.name, value: "" },
      } as React.ChangeEvent<HTMLInputElement>);
    }
  };



  return (
    <div className="billing-info">
      <h2 className=" font-semibold mb-2">Billing Information</h2>
      <div className="flex flex-wrap gap-2 mb-4">
        {["Fixed", "Per Tonne", "Per Kg", "Per Trip", "Per Day", "Per Hour", "Per Litre", "Per Bag"].map((type) => (
          <button
            key={type}
            type="button"
            className={`p-2 rounded-md ${
              formData.billingType === type ? "bg-bottomNavBarColor text-white" : "bg-lightOrange text-buttonTextColor"
            }`}
            onClick={() =>
              handleChange({
                target: { name: "billingType", value: type },
              } as React.ChangeEvent<HTMLInputElement | HTMLSelectElement>)
            }
          >
            {type}
          </button>
        ))}
      </div>
      {formData.billingType === "Fixed" ? (
        <label className="block">
          <span className="block text-xs font-medium text-gray-700 mb-1">Freight Amount*</span>
          <input
            className="w-full p-2 border border-gray-300 rounded-md mb-4"
            type="text"
            name="amount"
            value={formatNumber(formData.amount)}
            placeholder="Freight Amount"
            onChange={handleChange}
            onFocus={handleFocus}
            required
          />
        </label>
      ) : (
        <>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label className="block">
              <span className="text-gray-700">{formData.billingType}</span>
              <input
                className="w-full p-2 border border-gray-300 rounded-md mb-4"
                type="number"
                name="perUnit"
                value={formData.perUnit || ""}
                placeholder="Per Unit"
                onChange={handleChange}
                onFocus={handleFocus}
                required
              />
            </label>
            <label className="block">
              <span className="text-gray-700">Total {formData.billingType?.split(" ")[1]}s</span>
              <input
                className="w-full p-2 border border-gray-300 rounded-md mb-4"
                type="number"
                name="totalUnits"
                value={formData.totalUnits || ""}
                placeholder="Total Units"
                onChange={handleChange}
                onFocus={handleFocus}
                required
              />
            </label>
          </div>
          <label className="block">
            <span className="text-gray-700 text-sm">Freight Amount</span>
            <input
              className="w-full p-2 border border-gray-300 rounded-md mb-4"
              type="text"
              name="amount"
              value={formatNumber(formData.amount)}
              placeholder="Freight Amount"
              readOnly
            />
          </label>
        </>
      )}
    
    </div>
  );
};
</file>

<file path="src/components/trip/DriverSelect.tsx">
import React, { useState } from 'react';
import { IDriver } from '@/utils/interface';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Button } from '../ui/button';
import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { PiPlusBold } from 'react-icons/pi';

type Props = {
  drivers: IDriver[];
  formData: any; // Adjust type as per your formData structure
  setFormData : any
  handleChange: (e: React.ChangeEvent<HTMLSelectElement>) => void;
};

const DriverSelect: React.FC<Props> = ({ drivers, formData, handleChange }) => {
  const [searchTerm, setSearchTerm] = useState<string>('');
  const pathname = usePathname()

  const handleOptionSelect = (value: string) => {
    const event = {
      target: {
        name: 'driver',
        value: value,
      },
    } as React.ChangeEvent<HTMLSelectElement>;
    handleChange(event);
  };

  const filteredDrivers = drivers.filter(driver =>
    driver.name.toLowerCase().includes(searchTerm.toLowerCase())
  );

  return (
    <div>
      <label className="block text-xs font-medium text-gray-700 mb-1">Driver</label>
        <Select name="driver" defaultValue={formData.driver} value={formData.driver} onValueChange={handleOptionSelect}>
          <SelectTrigger className="w-full">
            <SelectValue placeholder="Select Driver" />
          </SelectTrigger>
          <SelectContent className='max-h-[300px]'>
            <div className="flex items-center justify-between gap-2 p-2">
              <input
                type="text"
                placeholder="Search..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full p-2 border border-gray-300 rounded-md"
              />
              <Button className="rounded-full w-8 h-8 p-0" onClick={()=>{
              localStorage.setItem('tripData',JSON.stringify(formData))
            }}>
            <Link href={{pathname : `/user/drivers/create`, query : {
              nextpath : pathname
            }}}><PiPlusBold /></Link>
            </Button>
            </div>
            {filteredDrivers.length > 0 ? (
              filteredDrivers.map((driver) => (
                <SelectItem key={driver.driver_id} value={driver.driver_id}>
                  <span>{driver.name}</span>
                  <span
                    className={`ml-2 p-1 rounded ${driver.status === 'Available' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}
                  >
                    {driver.status}
                  </span>
                </SelectItem>
              ))
            ) : (
              <div className="p-2 text-gray-500">No drivers found</div>
            )}
            
          </SelectContent>
        </Select>
    </div>
  );
};

export default DriverSelect;
</file>

<file path="src/components/trip/MaterialInput.tsx">
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Plus, Trash } from "lucide-react"

interface Material {
  name: string
  weight: string
}

interface MaterialInputProps {
  materials: Material[]
  onChange: (materials: Material[]) => void
  guaranteedWeight: string
  onGuaranteedWeightChange: (weight: string) => void
}

export function MaterialInput({ materials, onChange, guaranteedWeight, onGuaranteedWeightChange }: MaterialInputProps) {
  const addMaterial = () => {
    onChange([...materials, { name: "", weight: "" }])
  }

  

  const updateMaterial = (index: number, field: keyof Material, value: string) => {
    const updatedMaterials = materials.map((material, i) => {
      if (i === index) {
        return { ...material, [field]: field === "weight" ? value : value }
      }
      return material
    })
    onChange(updatedMaterials)
  }

  const removeMaterial = (index: number) => {
    onChange(materials.filter((_, i) => i !== index))
  }

  return (
    <div className="space-y-4">
      <div>
        <label className="block text-xs font-medium text-gray-700 mb-1">Guaranteed Weight (MT)</label>
        <Input
          type="text"
          value={guaranteedWeight}
          onChange={(e) => onGuaranteedWeightChange(e.target.value)}
          placeholder="Guaranteed Weight"
        />
      </div>
      {materials.map((material, index) => (
        <div key={index} className="flex items-center space-x-2">
          <Input
            placeholder="Material Name"
            value={material.name}
            onChange={(e) => updateMaterial(index, "name", e.target.value)}
          />
          <Input
            type="text"
            placeholder="Weight (MT)"
            value={material.weight}
            onChange={(e) => updateMaterial(index, "weight", e.target.value)}
          />
          <Button type="button" variant="ghost" size="icon" onClick={() => removeMaterial(index)}>
            <Trash className="h-4 w-4" />
          </Button>
        </div>
      ))}
      <Button type="button" variant="outline" size="sm" onClick={addMaterial}>
        <Plus className="h-4 w-4 mr-2" /> Add Material
      </Button>
    </div>
  )
}
</file>

<file path="src/components/trip/PartySelect.tsx">
import React, { useState } from "react";
import { IParty } from "@/utils/interface";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import Link from "next/link";
import { Button } from "../ui/button";
import { PiPlusBold } from "react-icons/pi";

interface PartySelectProps {
  parties: IParty[];
  formData: any;
  handleChange: (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => void;
}

const PartySelect: React.FC<PartySelectProps> = ({ parties, formData, handleChange }) => {
  const [searchTerm, setSearchTerm] = useState("");

  const handleSelectChange = (value: string) => {
    const event = {
      target: {
        name: 'party',
        value: value,
      },
    } as React.ChangeEvent<HTMLInputElement>;
    handleChange(event);
  };

  const filteredParties = parties.filter(party =>
    party.name.toLowerCase().includes(searchTerm.toLowerCase())
  );

  return (
    <div>
      <label className="block w-full">
        <label className="block text-xs font-medium text-gray-700 mb-1">Customer*</label>
        <Select name="party" defaultValue={formData.party} onValueChange={handleSelectChange}>
          <SelectTrigger className="w-full">
            <SelectValue placeholder="Select Customer" />
          </SelectTrigger>
          <SelectContent className="max-h-[300px]">
            <div className="sticky p-2 flex items-center justify-between gap-2">
              <input
                type="text"
                placeholder="Search..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full p-2 border border-gray-300 rounded-md"
              />
              
                <Link href={{
                  pathname: `/user/parties/create`, query: {
                    nextpath: `/user/trips/create`
                  }
                }}>
                  <Button  className="rounded-full w-8 h-8 p-0" onClick={() => {
                localStorage.setItem('tripData', JSON.stringify(formData))
              }}><PiPlusBold /></Button></Link>
            </div>
            {filteredParties.length > 0 ? (
              filteredParties.map((party) => (
                <SelectItem key={party.party_id} value={party.party_id}>{party.name}</SelectItem>
              ))
            ) : (
              <div className="p-2 text-gray-500">No customers found</div>
            )}


          </SelectContent>
        </Select>
      </label>
    </div>
  );
};

export { PartySelect };
</file>

<file path="src/components/trip/RouteInputs.tsx">
import React, { useState, useEffect, useCallback } from 'react';
import Autosuggest, { SuggestionsFetchRequestedParams, SuggestionSelectedEventData } from 'react-autosuggest';
import axios from 'axios';
import debounce from 'lodash.debounce';
import { indianStates } from '@/utils/utilArray';

interface RouteInputsProps {
    formData: {
        route: {
            origin: string;
            destination: string;
        };
    };
    handleChange: (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => void;
}

const cache: { [key: string]: string[] } = {};

const RouteInputs: React.FC<RouteInputsProps> = ({ formData, handleChange }) => {
    const [suggestionsOrigin, setSuggestionsOrigin] = useState<string[]>([]);
    const [suggestionsDestination, setSuggestionsDestination] = useState<string[]>([]);
    const [highlightedSuggestion, setHighlightedSuggestion] = useState<string | null>(null);

    const fetchSuggestions = useCallback(
        debounce(async (value: string, setSuggestions: React.Dispatch<React.SetStateAction<string[]>>) => {
            if (cache[value]) {
                setSuggestions(cache[value]);
                return;
            }
            try {
                const username = 'fragtos'; // Replace with your GeoNames username
                const response = await axios.get(`https://secure.geonames.org/searchJSON?name_startsWith=${value}&maxRows=7&country=IN&username=${username}`);
                const data = response.data;

                const uniqueSuggestions = Array.from(new Set(data.geonames.map((city: any) => city.name + ", " + indianStates[city.adminName1 as string] || city.adminName1)));
                cache[value] = uniqueSuggestions as string[];
                setSuggestions(uniqueSuggestions as []);
            } catch (error) {
                console.error('Error fetching suggestions:', error);
            }
        }, 300),
        []
    );

    useEffect(() => {
        if (formData.route?.origin?.trim().length > 0) {
            fetchSuggestions(formData.route.origin, setSuggestionsOrigin);
        }
    }, [formData.route?.origin, fetchSuggestions]);

    useEffect(() => {
        if (formData.route?.destination?.trim().length > 0) {
            fetchSuggestions(formData.route.destination, setSuggestionsDestination);
        }
    }, [formData.route?.destination, fetchSuggestions]);

    const handleOriginChange = (event: React.ChangeEvent<HTMLInputElement>, { newValue }: { newValue: string }) => {
        handleChange({ ...event, target: { ...event.target, name: 'route.origin', value: newValue } });
    };

    const handleDestinationChange = (event: React.ChangeEvent<HTMLInputElement>, { newValue }: { newValue: string }) => {
        handleChange({ ...event, target: { ...event.target, name: 'route.destination', value: newValue } });
    };

    const handleSuggestionSelected = (setSuggestions: React.Dispatch<React.SetStateAction<string[]>>, fieldName: 'route.origin' | 'route.destination') => (
        event: React.FormEvent<any>,
        { suggestion }: SuggestionSelectedEventData<string>
    ) => {
        handleChange({ target: { name: fieldName, value: suggestion } } as any);
        setSuggestions([]);
    };

    const renderSuggestion = (suggestion: string) => {
        const isHighlighted = suggestion === highlightedSuggestion;
        return (
            <div
                className={`p-2 cursor-pointer ${isHighlighted ? 'bg-gray-200' : ''}`}
                onMouseEnter={() => setHighlightedSuggestion(suggestion)}
                onMouseLeave={() => setHighlightedSuggestion(null)}
            >
                {suggestion}
            </div>
        );
    };

    const inputProps = (placeholder: string, value: string, onChange: (event: any, { newValue }: any) => void) => ({
        placeholder,
        value,
        onChange,
        className: 'w-full p-2 border border-gray-300 rounded-md'
    });

    return (
        <div className="flex flex-wrap justify-between">
            <div className="w-full md:w-1/2 mb-4 pr-1">
                <label className="block text-xs font-medium text-gray-700 mb-1">From*</label>
                <Autosuggest
                    suggestions={suggestionsOrigin}
                    onSuggestionsFetchRequested={(params: SuggestionsFetchRequestedParams) => fetchSuggestions(params.value, setSuggestionsOrigin)}
                    onSuggestionsClearRequested={() => setSuggestionsOrigin([])}
                    onSuggestionSelected={(event, data) => handleSuggestionSelected(setSuggestionsOrigin, 'route.origin')(event, data)}
                    getSuggestionValue={(suggestion) => suggestion}
                    renderSuggestion={renderSuggestion}
                    inputProps={inputProps("Enter city", formData.route.origin, handleOriginChange)}
                    shouldRenderSuggestions={(value) => value.trim().length > 0}
                    theme={{
                        container: 'relative',
                        suggestionsContainer: 'absolute mt-1 bg-white border border-gray-300 rounded-md shadow-lg z-50',
                        suggestion: 'p-2 cursor-pointer',
                        suggestionHighlighted: 'bg-gray-200',
                    }}
                />
            </div>
            <div className="w-full md:w-1/2 mb-4 pl-1">
                <label className="block text-xs font-medium text-gray-700 mb-1">To*</label>
                <Autosuggest
                    suggestions={suggestionsDestination}
                    onSuggestionsFetchRequested={(params: SuggestionsFetchRequestedParams) => fetchSuggestions(params.value, setSuggestionsDestination)}
                    onSuggestionsClearRequested={() => setSuggestionsDestination([])}
                    onSuggestionSelected={(event, data) => handleSuggestionSelected(setSuggestionsDestination, 'route.destination')(event, data)}
                    getSuggestionValue={(suggestion) => suggestion}
                    renderSuggestion={renderSuggestion}
                    inputProps={inputProps("Enter city", formData.route.destination, handleDestinationChange)}
                    shouldRenderSuggestions={(value) => value.trim().length > 0}
                    theme={{
                        container: 'relative',
                        suggestionsContainer: 'absolute mt-1 bg-white border border-gray-300 rounded-md shadow-lg z-50',
                        suggestion: 'p-2 cursor-pointer',
                        suggestionHighlighted: 'bg-gray-200',
                    }}
                />
            </div>
        </div>
    );
};

export default RouteInputs;
</file>

<file path="src/components/trip/tripDetail/Charges.tsx">
import React, { useState, useEffect } from 'react';
import ChargeModal from './ChargeModal';
import { ITrip, TripExpense } from '@/utils/interface';
import { MdDelete, MdEdit } from 'react-icons/md';
import EditChargeModal from './EditChargeModal';
import { Button } from '@/components/ui/button';
import { formatNumber } from '@/utils/utilArray';
import { PiPlusBold } from 'react-icons/pi';
import { useTrip } from '@/context/tripContext';

type props = {
  tripId : string
}

const Charges : React.FC<props> = ({tripId}) => {
  const {trip, setTrip} = useTrip()
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editModalOpen, setEditModalOpen] = useState(false);
  const [expandedItem, setExpandedItem] = useState<number | null>(null);
  const [sortedCharges, setSortedCharges] = useState<TripExpense[]>([]);
  const [selectedCharge, setSelectedCharge] = useState<TripExpense | null>(null);

  useEffect(() => {
    if (trip.tripCharges) {
      const sorted = [...trip.tripCharges].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
      setSortedCharges(sorted);
    }
  }, [trip.tripCharges]);

  const handleAddCharge = async (newCharge: TripExpense) => {
    try {
      const res = await fetch(`/api/trips/${tripId}/expenses`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(newCharge),
      });
      if(!res.ok){
        throw new Error('Failed to add Charge')
      }
      const data =  await res.json();
      setTrip((prev : ITrip | any) =>({
        ...prev,
        tripCharges : [
          data.newCharge,
          ...prev.tripCharges
        ],
        balance : newCharge.partyBill ? prev.balance + Number(newCharge.amount) : prev.balance - Number(newCharge.amount),
      }))
    } catch (error) {
      alert(error)
      console.error('Error adding charge:', error);
    }
    
  };

  const toggleItemExpansion = (index: number) => {
    setExpandedItem(expandedItem === index ? null : index);
  };

  const handleEditCharge = (index: number) => {
    setSelectedCharge(sortedCharges[index]);
    setEditModalOpen(true);
  };

  const handleDeleteCharge = async (index: number) => {
    const chargeToDelete = sortedCharges[index];
    const res = await fetch(`/api/trips/${tripId}/expenses/`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ id: chargeToDelete._id }),
    });
    if (res.ok) {
      
      setTrip((prev : ITrip | any) =>({
        ...prev,
        tripCharges : prev.tripCharges.filter((charge : any) => charge._id !== chargeToDelete._id),
        balance : chargeToDelete.partyBill ? prev.balance - chargeToDelete.amount : prev.balance + chargeToDelete .amount
      }))
      
    } else {
      console.error('Failed to delete charge:', chargeToDelete._id);
    }
  };

  return (
    <div className="mt-6">
      <div className="flex items-center justify-between mb-4">
        <h3 className="text-lg font-semibold text-gray-800">Charges</h3>
        <Button
          disabled={trip.status === 4}
          className="flex items-center justify-center w-8 h-8 rounded-full p-0 "
          onClick={() => setIsModalOpen(true)}
          aria-label="Add Charge"
        >
          <PiPlusBold color='white' size={20}/>
        </Button>
      </div>
      {!sortedCharges || sortedCharges.length === 0 ? (
        <p className="text-sm text-gray-500">No charges available.</p>
      ) : (
        <div className="bg-white shadow-lg rounded-lg divide-y divide-gray-200">
          {sortedCharges.map((charge : any, index : number) => (
            <div
              key={index}
              className="flex flex-col px-4 py-4 hover:bg-gray-50 transition duration-300 ease-in-out transform hover:scale-105 rounded-lg cursor-pointer"
              onClick={() => toggleItemExpansion(index)}
            >
              <div className="flex items-center justify-between">
                <div className="flex-1">
                  <p className="text-sm font-medium text-gray-900">Amount: {formatNumber(charge.amount)}</p>
                  <p className="text-xs text-gray-600">Type: {charge.expenseType}</p>
                </div>
                <div className="text-right">
                  <p className="text-xs text-gray-600">Date: {new Date(charge.date).toLocaleDateString()}</p>
                  <p className={`text-xs font-semibold ${charge.partyBill ? 'text-green-600' : 'text-red-600'}`}>
                    {charge.partyBill ? 'Added to Bill' : 'Reduced from Bill'}
                  </p>
                </div>
              </div>
              {expandedItem === index && (
                <div className="mt-4 bg-gray-100 p-4 rounded-md border border-gray-300">
                  {charge.notes && (
                    <p className="text-xs text-gray-600 mb-2">Notes: {charge.notes}</p>
                  )}
                  <div className="mt-2 flex justify-end space-x-2">
                    <Button
                      variant={'ghost'}
                      disabled={trip.status === 4}
                      onClick={() => handleEditCharge(index)}
                      className="flex items-center justify-center p-2 hover:bg-gray-200"
                    >
                      <MdEdit size={20} />
                    </Button>
                    <Button
                      variant={'ghost'}
                      disabled={trip.status === 4}
                      onClick={() => handleDeleteCharge(index)}
                      className="flex items-center justify-center p-2 hover:bg-gray-200"
                    >
                      <MdDelete size={20} />
                    </Button>
                  </div>
                </div>
              )}
            </div>
          ))}
        </div>
      )}
      <ChargeModal
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        onSave={handleAddCharge}
      />
      {editModalOpen && selectedCharge && (
        <EditChargeModal
          isOpen={editModalOpen}
          onClose={() => setEditModalOpen(false)}
          onSave={async (editedCharge: TripExpense) => {
            // Send PATCH request to update charge
            const res = await fetch(`/api/trips/${tripId}/expenses`, {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(editedCharge),
            });
            if (!res.ok) {
              console.error('Failed to update charge:', selectedCharge._id);
              return;
            }

            setTrip((prev : ITrip | any) =>({
              ...prev,
              tripCharges : prev.tripCharges.map((charge : any) =>
                charge._id === selectedCharge._id? editedCharge : charge
              ),
            }))
            setEditModalOpen(false);
          }}
          charge={selectedCharge}
        />
      )}
    </div>
  );
};

export default Charges;
</file>

<file path="src/components/trip/tripDetail/Payments.tsx">
import React from 'react';

interface PaymentItem {
  label: string;
  value: string;
}

interface PaymentsProps {
  payments: PaymentItem[];
  onAddPayment: () => void; // Function to handle adding payments
}

const Payments: React.FC<PaymentsProps> = ({ payments, onAddPayment }) => {
  return (
    <div className="mt-6">
      <div className="flex items-center justify-between mb-4">
        <h3 className="text-lg font-semibold text-gray-800">Payments</h3>
        <button
          className="flex items-center justify-center w-8 h-8 rounded-full bg-purple-500 text-white hover:bg-purple-600 focus:outline-none ml-4"
          onClick={onAddPayment}
          aria-label="Add Payment"
        >
          +
        </button>
      </div>
      <div className="bg-white shadow-md rounded-lg divide-y divide-gray-200">
        {payments.map((payment, index) => (
          <div key={index} className="flex items-center justify-between px-4 py-3 hover:bg-gray-50">
            <div className="flex-1">
              <p className="text-sm font-medium text-gray-900">{payment.label}</p>
              <p className="text-xs text-gray-600">{payment.value}</p>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

export default Payments;
</file>

<file path="src/components/trip/tripDetail/PODViewer.tsx">
import { Button } from '@/components/ui/button';
import Image from 'next/image';
import Link from 'next/link';
import React from 'react';

interface PODViewerProps {
  podUrl: string;
}

const PODViewer: React.FC<PODViewerProps> = ({ podUrl }) => {
  return (
    <div className="mt-6 bg-white p-4 rounded-md border border-lightOrange shadow-lg hover:shadow-lightOrangeButtonColor">
      <h3 className="text-lg font-semibold mb-2">POD </h3>
      <Button variant={'link'}><Link href={podUrl} target='_blank' rel='noopener noreferrer'>View Document</Link></Button>
      <Image src={podUrl} alt='pod' width={200} height={200}/>
    </div>
  );
};

export default PODViewer;
</file>

<file path="src/components/trip/tripDetail/Profit.tsx">
import React, { useEffect, useState, useCallback, useMemo } from 'react';
import { IExpense, ITrip, TripExpense } from '@/utils/interface';
import ProfitItem from './Profit/ProfitItem';
import { DeleteExpense, handleAddExpense, handleEditExpense } from '@/helpers/ExpenseOperation';
import { Button } from '@/components/ui/button';
import { FaChevronUp, FaChevronDown } from 'react-icons/fa';
import { formatNumber } from '@/utils/utilArray';
import dynamic from 'next/dynamic';
import { loadingIndicator } from '@/components/ui/LoadingIndicator';
import { useTrip } from '@/context/tripContext';
import { useToast } from '@/components/hooks/use-toast';

interface ProfitProps {
  charges: TripExpense[];
  amount: number;
  setCharges: React.Dispatch<React.SetStateAction<TripExpense[]>>;
  tripId: string;
  driverId: string;
  truckNo: string;
  truckCost?: number;
  tripExpense: IExpense[];
}

const AddExpenseModal = dynamic(() => import('@/components/AddExpenseModal'), { ssr: false, loading : ()=><div className='flex items-center justify-center'>{loadingIndicator}</div> });

const Profit: React.FC<ProfitProps> = ({ charges, amount, setCharges, tripId, driverId, truckNo, truckCost = 0, tripExpense }) => {
  const {trip, setTrip} = useTrip()
  const [showTotalCharges, setShowTotalCharges] = useState(false);
  const [showTotalDeductions, setShowTotalDeductions] = useState(false);
  const [showTruckExpenses, setShowTruckExpenses] = useState(false);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [selectedExpense, setSelectedExpense] = useState<IExpense | null>(null);
  const {toast} = useToast()



  // Memoize calculations to avoid unnecessary recalculations
  const totalChargesAmount = useMemo(
    () => trip.tripCharges.filter((charge : any) => charge.partyBill).reduce((total : number, charge : any) => total + Number(charge.amount || 0), 0),
    [charges]
  );

  const totalDeductionsAmount = useMemo(
    () => trip.tripCharges.filter((charge : any) => !charge.partyBill).reduce((total : number, charge : any) => total + Number(charge.amount || 0), 0),
    [charges]
  );

  const truckExpensesAmount = useMemo(
    () => trip.tripExpenses.reduce((total : number, expense : IExpense) => total + Number(expense.amount || 0), 0),
    [trip]
  );

  const netProfit = useMemo(() => {
    return Number(amount) + totalChargesAmount - totalDeductionsAmount - truckExpensesAmount - Number(truckCost || 0);
  }, [amount, totalChargesAmount, totalDeductionsAmount, truckExpensesAmount, truckCost]);

  // Handlers
  const handleExpense = useCallback(
    async (editedExpense: IExpense,id: string, file : File | null) => {
      try {
        if (selectedExpense) {
          const expense = await handleEditExpense(editedExpense, id as string, file);
          // console.log(expense)
          setTrip((prev: ITrip | any)=>({
            ...prev,
            tripExpenses: prev.tripExpenses.map((item : IExpense) => (item._id === id? {...expense} : item)),
          }))
          toast({
            description : 'Expense edited successfully'
          })
        } else {
          const expense = await handleAddExpense(editedExpense);
          setTrip((prev: ITrip | any)=>({
            ...prev,
            tripExpenses : [{...expense},...prev.tripExpenses]
          }))
          toast({
            description : 'Expense added successfully'
          })
        }
      } catch (error) {
        toast({
          description : `Failed to ${selectedExpense ? 'edit' : 'add'} expense`
        })
        // console.error(error);
      }
    },
    [selectedExpense]
  );

  const handleDeleteExpense = useCallback(async (id: string) => {
    try {
      const deletedExpense = await DeleteExpense(id);
      if (deletedExpense) {
        setTrip((prev: ITrip | any)=>({
         ...prev,
          tripExpenses: prev.tripExpenses.filter((item : IExpense) => item._id!== deletedExpense._id),
        }));
      }
    } catch (error) {
      alert('Failed to delete expense');
      console.error(error);
    }
  }, []);

  return (
    <div className="p-6 border rounded-lg border-lightOrange shadow-lg bg-white w-full hover:shadow-lightOrangeButtonColor transition-shadow duration-300 relative">
      <h3 className="text-2xl font-semibold mb-6 text-center text-gray-800">Profit Summary (Rs)</h3>

      <div className="flex flex-row w-full items-center justify-between">
        <span className="text-md font-bold text-gray-800">Freight Amount: </span>
        <span className="text-md font-semibold text-blue-700">{formatNumber(amount)}</span>
      </div>

      <div className="py-4 border-b border-gray-200 cursor-pointer flex justify-between items-center hover:bg-gray-100 transition-colors rounded-md" onClick={() => setShowTotalCharges(!showTotalCharges)}>
        <span className="font-medium text-gray-700">Total Charges</span>
        <span className="flex items-center text-green-600 font-semibold">
          +{formatNumber(totalChargesAmount)}
          {showTotalCharges ? <FaChevronUp className="ml-2 transition-transform" /> : <FaChevronDown className="ml-2 transition-transform" />}
        </span>
      </div>
      {showTotalCharges && charges.filter(charge => charge.partyBill).map((charge, index) => (
        <ProfitItem data={charge} index={index} key={charge.id as string} disabled={true} sign="+" />
      ))}

      <div className="py-4 border-b border-gray-200 cursor-pointer flex justify-between items-center hover:bg-gray-100 transition-colors rounded-md" onClick={() => setShowTotalDeductions(!showTotalDeductions)}>
        <span className="font-medium text-gray-700">Total Deductions</span>
        <span className="flex items-center text-red-600 font-semibold">
          -{formatNumber(totalDeductionsAmount)}
          {showTotalDeductions ? <FaChevronUp className="ml-2 transition-transform" /> : <FaChevronDown className="ml-2 transition-transform" />}
        </span>
      </div>
      {showTotalDeductions && charges.filter(charge => !charge.partyBill).map((charge, index) => (
        <ProfitItem data={charge} index={index} key={charge.id as string} disabled={true} sign="-" />
      ))}

      <div className="py-4 border-b border-gray-200 cursor-pointer flex justify-between items-center hover:bg-gray-100 transition-colors rounded-md" onClick={() => setShowTruckExpenses(!showTruckExpenses)}>
        <span className="font-medium text-gray-700">Expenses</span>
        <span className="flex items-center text-red-600 font-semibold">
          -{formatNumber(truckExpensesAmount)}
          {showTruckExpenses ? <FaChevronUp className="ml-2 transition-transform" /> : <FaChevronDown className="ml-2 transition-transform" />}
        </span>
      </div>
      {showTruckExpenses && trip.tripExpenses.map((expense : IExpense, index : number) => (
        <ProfitItem  data={expense} handleDelete={handleDeleteExpense} index={index} key={expense._id as string} setOpen={setIsModalOpen} setSelectedExpense={setSelectedExpense} sign="-" />
      ))}

      {truckCost > 0 && (
        <div className="py-4 mt-4 flex justify-between items-center">
          <span className="font-medium text-gray-800">Truck Hire Cost: </span>
          <span className="text-red-600 font-bold">-{formatNumber(truckCost)}</span>
        </div>
      )}

      <hr />
      <div className="py-4 mt-4 flex justify-between items-center">
        <span className="font-medium text-gray-800">Net Profit: </span>
        <span className="text-blue-700 font-bold">{formatNumber(netProfit)}</span>
      </div>

      <div className="flex justify-end mt-4">
        <Button
          onClick={() => setIsModalOpen(true)}
          className="flex items-center px-4 py-2 transition-all duration-300 ease-in-out transform hover:scale-105"
        >
          Add Expense
        </Button>
      </div>

      <AddExpenseModal
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        onSave={handleExpense}
        driverId={driverId}
        categories={['Truck Expense', 'Trip Expense', 'Office Expense']}
        tripId={tripId}
        truckNo={truckNo}
        selected={selectedExpense}
      />
    </div>
  );
};

export default Profit;
</file>

<file path="src/components/trip/tripDetail/Profit/ProfitItem.tsx">
'use client';
import React, { useState } from 'react';
import { MdDelete, MdEdit } from 'react-icons/md';
import { Button } from '@/components/ui/button';
import { formatNumber } from '@/utils/utilArray';

interface ProfitItemProps {
  data: any;
  index: number;
  setOpen?: any;
  setSelectedExpense?: any;
  disabled?: boolean;
  sign: string;
  handleDelete? : any
}

const ProfitItem: React.FC<ProfitItemProps> = ({ data, index, setOpen, setSelectedExpense, disabled, sign, handleDelete }) => {
  
  const [isHovered, setIsHovered] = useState<boolean>(false);

  return (
    <div
      className={`flex items-center justify-between py-2 px-4 bg-lightOrangeButtonColor rounded-lg my-2 cursor-pointer w-full relative transition-transform duration-200 ease-in-out transform ${!disabled ? 'hover:scale-105' : ''} ${isHovered ? 'bg-lightOrange bg-opacity-70' : ''}`}
      onMouseEnter={() => !disabled && setIsHovered(true)}
      onMouseLeave={() => !disabled && setIsHovered(false)}
    >
      <div className='flex flex-row items-center justify-between w-full'>
        <div className="flex flex-row justify-between w-full">
          <p className="text-sm font-medium text-gray-900">{data.expenseType}</p>
          <p className="text-sm font-semibold text-gray-600">{sign}{formatNumber(data.amount)}</p>
        </div>
        {isHovered && (
          <div className="flex space-x-2 transition-opacity duration-200 ease-in-out opacity-100">
            <Button
              variant={'ghost'}
              onClick={() => {
                setSelectedExpense(data);
                setOpen(true);
              }}
              className='p-2 transition-opacity duration-200 ease-in-out opacity-100 rounded-full'
            >
              <MdEdit size={20} />
            </Button>
            <Button
              onClick={()=>handleDelete(data._id)}
              className="p-2 bg-destructive text-white rounded-full transition-colors duration-200 ease-in-out hover:bg-red-600"
            >
              <MdDelete size={20} />
            </Button>
          </div>
        )}
      </div>
    </div>
  );
};

export default ProfitItem;
</file>

<file path="src/components/trip/tripDetail/Profit/TripRevenue.tsx">
import { loadingIndicator } from '@/components/ui/LoadingIndicator';
import { formatNumber } from '@/utils/utilArray';
import React, { useState, useEffect } from 'react';

interface DriverNameProps {
    tripId: string;
    amount : number
}

const TripRevenue: React.FC<DriverNameProps> = ({ tripId , amount}) => {
    const [loading, setLoading] = useState<boolean>(true);
    const [error, setError] = useState<boolean>(false);
    const [revenue, setRevenue] = useState<number>(amount)

    useEffect(() => {
        const calculateRevenue = async () => {
            try {
                const res = await fetch(`/api/trips/${tripId}/expenses`);
                const data = await res.json()
                const charges = data.charges
                const totalCharges = charges.reduce((acc : any, curr : any) => {
                    return curr.partyBill ? acc + curr.amount : acc - curr.amount;
                  }, 0);
                  

                setRevenue(revenue + parseInt(totalCharges))
            } catch (error: any) {
                setError(true);
            } finally {
                setLoading(false);
            }
        };
        calculateRevenue();
    }, [tripId]);

    if (loading) return loadingIndicator;
    if (error || !revenue) return <span>NA</span>;

    return <span className='text-green-500 font-semibold'>{formatNumber(revenue) || ''}</span>;
};

export default TripRevenue;
</file>

<file path="src/components/trip/tripDetail/TripFunctions/InvoiceForm.tsx">
import { useExpenseData } from "@/components/hooks/useExpenseData";
import { motion } from "framer-motion";
import type React from "react";
import { useMemo, useState, useEffect } from "react";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { statuses } from "@/utils/schema";
import { Button } from "@/components/ui/button";
import { ArrowRightIcon } from "lucide-react";
import Link from "next/link";
import { Checkbox } from "@/components/ui/checkbox";

type Props = {
    open: boolean;
    setOpen: React.Dispatch<React.SetStateAction<boolean>>;
    party?: string;
    route?: {
        origin: string;
        destination: string;
        trips: string[]; // Ensure this is an array of trip IDs
    };
    tripIds?: string[];
};


interface Route {
    origin: string;
    destination: string;
    trips: string[];
}

const InvoiceForm: React.FC<Props> = ({ open, setOpen, party, route, tripIds }) => {
    const { parties, trips } = useExpenseData();

    const [searchTerm, setSearchTerm] = useState("");
    const [selectedParty, setSelectedParty] = useState(party || "");
    const [selectedRoute, setSelectedRoute] = useState<Route | null>(
        route
            ? {
                origin: route.origin,
                destination: route.destination,
                trips: route.trips,
            }
            : null,
    );
    const [selectedTripIds, setSelectedTripIds] = useState<string[]>(tripIds || []);

    useEffect(() => {
        if (party) {
            setSelectedParty(party);
        }
        if (route) {
            setSelectedRoute({
                origin: route.origin,
                destination: route.destination,
                trips: route.trips,
            });
        }
        if (tripIds) {
            setSelectedTripIds(tripIds);
        }
    }, [party, route, tripIds]);

    const filteredParties = parties.filter((party) =>
        party.name.toLowerCase().includes(searchTerm.toLowerCase()),
    );

    const filteredRoutes = useMemo(() => {
        if (!trips || trips.length === 0) return [];

        const routeMap = new Map<string, Route>();

        trips.forEach((trip) => {
            if (selectedParty && trip.party !== selectedParty) {
                return;
            }

            const routeKey = `${trip.route.origin}|${trip.route.destination}`;
            if (!routeMap.has(routeKey)) {
                routeMap.set(routeKey, {
                    origin: trip.route.origin,
                    destination: trip.route.destination,
                    trips: [],
                });
            }
            routeMap.get(routeKey)!.trips.push(trip.trip_id);
        });

        return Array.from(routeMap.values()).filter((route) => {
            if (!searchTerm) return true;

            const lowercaseSearchTerm = searchTerm.toLowerCase();
            return (
                route.origin.toLowerCase().includes(lowercaseSearchTerm) ||
                route.destination.toLowerCase()?.includes(lowercaseSearchTerm)
            );
        });
    }, [trips, selectedParty, searchTerm]);

    const tripsForSelectedRoute = useMemo(() => {
        if (route) {
            return trips.filter(
                (trip) =>
                    trip.route.origin === route.origin &&
                    trip.route.destination === route.destination
            );
        }
        if (!selectedRoute) return [];

        return trips.filter((trip) => selectedRoute.trips.includes(trip.trip_id));
    }, [selectedRoute, trips, route]);


    const handleTripSelection = (tripId: string) => {
        setSelectedTripIds((prev) =>
            prev.includes(tripId) ? prev.filter((id) => id !== tripId) : [...prev, tripId],
        );
    };

    if (!open) {
        return null;
    }

    return (
        <div className="modal-class">
            <motion.div
                initial={{ opacity: 0, scale: 0.5 }}
                animate={{ opacity: 1, scale: 1 }}
                transition={{
                    duration: 0.5,
                    ease: [0, 0.71, 0.2, 1.01],
                }}
                className="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl max-h-[700px] overflow-y-auto thin-scrollbar"
            >
                <h2 className="text-black text-xl font-semibold">Invoice Generation</h2>
                <div className="my-2">
                    <label>Select Customer *</label>
                    <Select
                        name="party"
                        value={selectedParty}
                        onValueChange={(value) => {
                            setSelectedParty(value);
                            setSelectedRoute(null);
                            setSelectedTripIds([]);
                        }}
                    >
                        <SelectTrigger className="w-full">
                            <SelectValue placeholder="Select Customer" />
                        </SelectTrigger>
                        <SelectContent className="max-h-[300px]">
                            <div className="sticky p-2 flex items-center justify-between gap-2">
                                <input
                                    type="text"
                                    placeholder="Search..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="w-full p-2 border border-gray-300 rounded-md"
                                />
                            </div>
                            {filteredParties.length > 0 ? (
                                filteredParties.map((party) => (
                                    <SelectItem key={party.party_id} value={party.party_id}>
                                        {party.name}
                                    </SelectItem>
                                ))
                            ) : (
                                <div className="p-2 text-gray-500">No customers found</div>
                            )}
                        </SelectContent>
                    </Select>
                </div>

                {selectedParty && (
                    <div className="my-2">
                        <label>Select Route *</label>
                        <Select
                            name="route"
                            value={selectedRoute ? `${selectedRoute.origin}|${selectedRoute.destination}` : ""}
                            onValueChange={(value) => {
                                const [origin, destination] = value.split("|");
                                const route = filteredRoutes.find(
                                    (r) => r.origin === origin && r.destination === destination,
                                );
                                setSelectedRoute(route || null);
                                setSelectedTripIds([]);
                            }}
                        >
                            <SelectTrigger className="w-full">
                                <SelectValue placeholder="Select Route" />
                            </SelectTrigger>
                            <SelectContent className="max-h-[300px]">
                                <div className="sticky p-2 flex items-center justify-between gap-2">
                                    <input
                                        type="text"
                                        placeholder="Search..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        className="w-full p-2 border border-gray-300 rounded-md"
                                    />
                                </div>
                                {filteredRoutes.length > 0 ? (
                                    filteredRoutes.map((route) => (
                                        <SelectItem
                                            key={`${route.origin}|${route.destination}`}
                                            value={`${route.origin}|${route.destination}`}
                                        >
                                            <div className="flex items-center justify-between w-full p-2 space-x-4">
                                                <span className="font-semibold text-gray-700 whitespace-nowrap">
                                                    {route.origin.split(",")[0]} &rarr; {route.destination.split(",")[0]}
                                                </span>
                                                <span className="text-sm text-gray-600 whitespace-nowrap">
                                                    {route.trips.length} trip(s)
                                                </span>
                                            </div>
                                        </SelectItem>
                                    ))
                                ) : (
                                    <div className="p-2 text-gray-500">No routes found</div>
                                )}
                            </SelectContent>
                        </Select>
                    </div>
                )}

                {selectedRoute && (
                    <div className="my-4">
                        <h3 className="text-lg font-semibold mb-2">Select Trips</h3>
                        {tripsForSelectedRoute.map((trip) => (
                            <div key={trip.trip_id} className="flex items-center space-x-2 mb-2">
                                <Checkbox
                                    id={trip.trip_id}
                                    checked={selectedTripIds.includes(trip.trip_id)}
                                    onCheckedChange={() => handleTripSelection(trip.trip_id)}
                                    disabled={trip.invoice !== false}
                                />
                                <label
                                    htmlFor={trip.trip_id}
                                    className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
                                >
                                    LR: {trip.LR} | Date: {new Date(trip.startDate).toLocaleDateString()} | Status:{" "}
                                    {statuses[trip.status as number]}
                                    {trip.invoice !== false && " (Already Invoiced)"}
                                </label>
                            </div>
                        ))}
                    </div>
                )}

                <div className="flex items-center gap-2 justify-end">
                    <Button onClick={() => setOpen(false)} variant={"outline"}>
                        Cancel
                    </Button>
                    {selectedParty && selectedRoute && selectedTripIds.length > 0 && (
                        <Link
                            href={`/user/trips/invoice?party=${encodeURIComponent(
                                selectedParty,
                            )}&route=${encodeURIComponent(
                                JSON.stringify(selectedRoute),
                            )}&trips=${encodeURIComponent(JSON.stringify(selectedTripIds))}`}
                        >
                            <Button className="my-2">
                                <ArrowRightIcon />
                            </Button>
                        </Link>
                    )}
                </div>
            </motion.div>
        </div>
    );
};

export default InvoiceForm;
</file>

<file path="src/components/trip/tripDetail/TripFunctions/StatusButton.tsx">
import React, { useState, useEffect } from 'react';
import { FaCheck, FaTruck, FaFileInvoice, FaMoneyBill, FaCheckCircle } from 'react-icons/fa'; // Example icons
import StatusModal from './StatusModal';
import { Button } from '@/components/ui/button';

interface StatusButtonProps {
  status: number;
  amount: number;
  statusUpdate: (data: any) => void;
  dates: Date[];
}

const StatusButton: React.FC<StatusButtonProps> = ({ status, statusUpdate, dates, amount }) => {
  const statusConfig: any = {
    0: { label: 'Complete Trip', color: '#FF8C42', icon: <FaTruck /> }, // Darker orange
    1: { label: 'POD Received', color: '#FFA726', icon: <FaFileInvoice /> }, // Lighter orange
    2: { label: 'POD Submitted', color: '#FFB74D', icon: <FaCheck /> }, // Even lighter orange
    3: { label: 'Settle Amount', color: '#FFCA28', icon: <FaMoneyBill /> }, // Lightest orange
    4: { label: 'Settled', color: '#FFD54F', icon: <FaCheckCircle /> } // Light yellow-orange
  };

  const { label, color, icon } = statusConfig[status];
  const fillPercentage = (status / 4) * 100;

  const [modalOpen, setModalOpen] = useState<boolean>(false);
  const [currentFill, setCurrentFill] = useState<number>(0);

  useEffect(() => {
    setCurrentFill(fillPercentage);
  }, [status]);

  const openModal = () => setModalOpen(true);
  const closeModal = () => setModalOpen(false);
  const saveChanges = (data: any) => {
    statusUpdate(data);
    closeModal();
  };

  return (
    <div className="w-full">
      
      <Button
        onClick={openModal}
        className={`
    ${status === 4 ? 'pointer-events-none opacity-50' : ''}
    hover:scale-105 hover:shadow-md transition-transform duration-300 ease-in-out
  `}
        style={{
          backgroundColor: color,
          height: '45px',
          lineHeight: '45px',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          transition: 'background-color 0.3s ease, transform 0.3s ease',
        }}
      >
        <div
          className="absolute left-0 top-0 h-full bg-white transition-all duration-500 ease-in-out"
          style={{ width: `${currentFill}%`, opacity: 0.2 }}
        ></div>
        <div className="relative z-10 flex items-center justify-center space-x-2">
          {icon}
          <span>{label} - {fillPercentage}%</span>
        </div>
      </Button>


      <StatusModal
        status={status}
        isOpen={modalOpen}
        onClose={closeModal}
        onSave={saveChanges}
        dates={dates}
        amount={amount}
      />
    </div>
  );
};

export default StatusButton;
</file>

<file path="src/components/trip/tripDetail/TripFunctions/ViewBill.tsx">
'use client'

import { Button } from '@/components/ui/button'
import { ITrip } from '@/utils/interface'
import React, { useEffect, useState } from 'react'
import { useTrip } from '@/context/tripContext'
import Link from 'next/link'
import InvoiceForm from './InvoiceForm'
import { useToast } from '@/components/hooks/use-toast'

type Props = {
  trips: ITrip[] | any[]
}

type FormDataType = {
  logourl: string
  billNo: string
  date: string
  from: string
  to: string
  address: string
  branch: string
  material: string
  partyName: string
  frieghtCharges: {
    lr: string
    truckNo: string
    material: string
    weight: string
    charged: string
    rate: string
    amount: number
  }[]
  additonalCharges: {
    truckNo: string
    material: string
    remarks: string
    amount: number
  }[]
  partyDetails: {
    msmeNo: string
    gstNumber: string
    pan: string
    accNo: string
    ifscCode: string
    bankBranch: string
    bankName: string
  }[]
  paymentDetails: {
    date: string
    paymentMode: string
    notes: string
    amount: number
  }[]
}

const ViewBillButton: React.FC<Props> = () => {
  const { trip } = useTrip()

  const [open, setOpen] = useState(false)
  const [invoice, setInvoice] = useState<any>(null)
  const { toast } = useToast()


  const fetchInvoiceData = async (id: string) => {
    try {
      const res = await fetch(`/api/invoices/${id}`)
      if (res.status === 401) {
        await fetch(`/api/logout`)
      }
      if (!res.ok) {
        toast({
          description: 'Failed to Fetch Invoice',
          variant: 'destructive'
        })
        return
      }
      const data = await res.json()
      setInvoice(data.invoice)
    } catch (error) {
      toast({
        description: 'Failed to Fetch Invoice',
        variant: 'destructive'
      })
    }
  }

  useEffect(() => {
    if (trip.invoice_id) {
      fetchInvoiceData(trip.invoice_id)
    }
  }, [trip])


  return (
    <div>
      {
        trip.invoice_id ?
          <Link href={`/user/trips/invoice?party=${encodeURIComponent(invoice?.party_id)}&route=${encodeURIComponent(JSON.stringify(invoice?.route))}&trips=${encodeURIComponent(JSON.stringify(invoice?.trips))}&invoiceId=${encodeURIComponent(trip.invoice_id)}`}>
            <Button variant="outline" onClick={() => setOpen(true)}>
              <span className="truncate">Generate Bill/Invoice</span>
            </Button>
          </Link> :
          <Button variant="outline" onClick={() => setOpen(true)}>
            <span className="truncate">Generate Bill/Invoice</span>
          </Button>
      }


      <InvoiceForm open={open} setOpen={setOpen} party={trip.party} route={trip.route} tripIds={[trip.trip_id]} />

    </div>
  )
}

export default ViewBillButton
</file>

<file path="src/components/trip/tripDetail/TripInfo.tsx">
import type React from "react"
import { useState, useEffect } from "react"
import { Button } from "@/components/ui/button"
import { motion, AnimatePresence } from "framer-motion"
import { MdEdit } from "react-icons/md"
import Link from "next/link"
import { useTrip } from "@/context/tripContext"
import { ewbColor } from "@/utils/EwayBillColor"

interface Material {
  name: string
  weight: number
}

interface TripInfoProps {
  label: string
  value: string | Material[]
  tripId?: string
  startDate?: Date
  validityDate?: Date | null
  supplierId?: string
  supplierName?: string
  guaranteedWeight?: string
}

const TripInfo: React.FC<TripInfoProps> = ({
  label,
  value,
  tripId,
  startDate,
  validityDate,
  supplierId,
  supplierName,
  guaranteedWeight,
}) => {
  const { trip } = useTrip()
  const [notes, setNotes] = useState<string>("")
  const [isEditingNotes, setIsEditingNotes] = useState<boolean>(false)

  useEffect(() => {
    if (label === "Notes" && typeof value === "string") {
      setNotes(value)
    }
  }, [label, value])

  const handleSaveNotes = async () => {
    const res = await fetch(`/api/trips/${tripId}`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ data: { notes } }),
    })
    if (!res.ok) {
      console.error("Failed to save notes")
    }
    setIsEditingNotes(false)
  }

  const formatDate = (date: Date) => {
    return new Date(date).toLocaleDateString("en-IN")
  }

  const containerVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: {
      opacity: 1,
      y: 0,
      transition: {
        duration: 0.5,
        when: "beforeChildren",
        staggerChildren: 0.1,
      },
    },
  }

  const itemVariants = {
    hidden: { opacity: 0, y: 10 },
    visible: {
      opacity: 1,
      y: 0,
      transition: { duration: 0.3 },
    },
  }

  const renderValue = () => {
    if (label === "Material" && Array.isArray(value)) {
      return (
        <div className="space-y-2">
          {value.map((material, index) => (
            <div key={index} className="flex justify-between items-center gap-2">
              <span className="text-xs font-semibold text-gray-900">{material.name} : </span>
              <span className="text-xs text-gray-600">{material.weight} MT</span>
            </div>
          ))}
          {guaranteedWeight !== undefined && (
            <div className="mt-2 pt-2 border-t border-gray-200 flex items-center gap-2">
              <span className="text-xs font-semibold text-gray-900">Guaranteed Weight: </span>
              <span className="text-xs text-gray-600">{guaranteedWeight.toLowerCase() === 'ftl' ? 'FTL' : guaranteedWeight + 'MT'} </span>
            </div>
          )}
        </div>
      )
    } else if (label === "Notes" && !isEditingNotes) {
      return (
        <div className="w-full pr-4" style={{ scrollbarWidth: "thin" }}>
          <textarea
            disabled
            className="w-full text-lg font-semibold text-gray-900 overflow-auto thin-scrollbar resize-none bg-transparent"
            value={notes}
          />
        </div>
      )
    } else {
      return (
        <div className="flex flex-col">
          <p className="text-xl font-semibold text-gray-900">{value as string}</p>
          {supplierId && supplierName && (
            <Link
              onClick={(e) => e.stopPropagation()}
              href={`/user/suppliers/${supplierId}/trips`}
              className="text-xs text-gray-800 hover:scale-105 hover:underline transition-all duration-300 ease-in-out"
            >
              {supplierName}
            </Link>
          )}
        </div>
      )
    }
  }

  return (
    <motion.div
      variants={containerVariants}
      initial="hidden"
      animate="visible"
      className={`p-4 border border-lightOrange rounded-lg shadow-lg bg-white w-full hover:shadow-lightOrangeButtonColor transition-all duration-300 relative ${label === "Driver" || label === "Material" ? "h-full" : ""}`}
    >
      <motion.div className="flex flex-col space-y-2" variants={itemVariants}>
        <div className="flex items-center justify-between">
          <motion.p variants={itemVariants} className="text-sm font-medium text-gray-600 tracking-wide uppercase">
            {label}
          </motion.p>
          {(startDate || validityDate) && (
            <motion.div variants={itemVariants} className="flex flex-col items-end text-xs text-gray-500">
              {startDate && <span>START DATE: {formatDate(startDate)}</span>}
              {validityDate && <span className="flex gap-1">E-WAY BILL VALIDITY: {ewbColor(trip)}</span>}
            </motion.div>
          )}
        </div>
        <div className="flex items-center justify-between">
          {renderValue()}
          {label === "Notes" && !isEditingNotes && (
            <motion.div whileHover={{ scale: 1.1 }} whileTap={{ scale: 0.9 }}>
              <Button onClick={() => setIsEditingNotes(true)} size="sm" variant="ghost">
                <MdEdit />
              </Button>
            </motion.div>
          )}
        </div>
      </motion.div>

      <AnimatePresence>
        {isEditingNotes && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50"
          >
            <motion.div
              initial={{ opacity: 0, scale: 0.9, y: 20 }}
              animate={{
                opacity: 1,
                scale: 1,
                y: 0,
                transition: {
                  type: "spring",
                  stiffness: 300,
                  damping: 30,
                },
              }}
              exit={{
                opacity: 0,
                scale: 0.9,
                y: 20,
                transition: {
                  duration: 0.2,
                },
              }}
              className="bg-white p-6 rounded-lg shadow-lg w-[90%] max-w-lg"
            >
              <h2 className="text-xl font-bold mb-4">Edit Notes</h2>
              <textarea
                className="w-full p-2 border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-lightOrange transition-all duration-300"
                value={notes}
                onChange={(e) => setNotes(e.target.value)}
                placeholder="Enter notes..."
                rows={4}
              />
              <div className="flex justify-end mt-4 space-x-4">
                <motion.div whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }}>
                  <Button onClick={handleSaveNotes}>Save</Button>
                </motion.div>
                <motion.div whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }}>
                  <Button variant="outline" onClick={() => setIsEditingNotes(false)}>
                    Cancel
                  </Button>
                </motion.div>
              </div>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>
    </motion.div>
  )
}

export default TripInfo
</file>

<file path="src/components/trip/tripDetail/TripStatus.tsx">
'use client'

import React from 'react'
import { motion } from 'framer-motion'
import { format } from 'date-fns'
import { CheckCircle } from 'lucide-react'
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip'

interface TripStatusProps {
  status: number
  dates: (Date | null)[]
}

const TripStatus: React.FC<TripStatusProps> = ({ status, dates }) => {
  const statuses = ['Started', 'Completed', 'POD Received', 'POD Submitted', 'Settled']

  return (
    <div className="mt-6 p-4 w-full max-w-4xl mx-auto">
      <div className="relative">
        <div className="flex items-center justify-between md:mx-12">
          {statuses.map((s, index) => (
            <TooltipProvider key={s}>
              <Tooltip>
                <TooltipTrigger asChild>
                  <div
                    className="flex flex-col items-center z-10"
                    aria-label={`${s} ${index <= status ? 'completed' : 'pending'}`}
                  >
                    
                    <motion.div
                      initial={{ scale: 0 }}
                      animate={{ scale: 1 }}
                      transition={{ delay: index * 0.2 }}
                      className={`w-8 h-8 md:w-12 md:h-12 rounded-full flex items-center justify-center ${index <= status ? 'bg-green-500' : 'bg-gray-300'
                        }`}
                    >
                      
                      {index <= status && <CheckCircle className="text-white" />}
                      
                    </motion.div>
                    
                    
                    <div className="mt-2 text-xs md:text-sm text-center hidden md:block">
                      {s}
                      
                      <div className="text-xs text-gray-500">
                        {dates[index] ? format(new Date(dates[index]!), 'MMM d, yyyy') : '-'}
                        
                      </div>
                    </div>
                  </div>
                </TooltipTrigger>
                <TooltipContent>
                  <p>{s}</p>
                  <p className="text-xs text-gray-500">
                    {dates[index] ? format(new Date(dates[index]!), 'MMMM d, yyyy') : 'Date not set'}
                  </p>
                </TooltipContent>
              </Tooltip>
            </TooltipProvider>
          ))}
        </div>
        <div
          className="absolute top-4 md:top-6 left-0 right-0 h-1 bg-gray-300 -z-10"
          aria-hidden="true"
        >
          <motion.div
            className="h-full bg-green-500"
            initial={{ width: 0 }}
            animate={{ width: `${(status / (statuses.length - 1)) * 100}%` }}
            transition={{ duration: 0.5 }}
          />
        </div>
      </div>
      <div className="mt-4 flex justify-between md:hidden">
        {statuses.map((s, index) => (
          <div key={s} className="text-xs text-center">
            {s}
            <div className="text-xs text-gray-500">
              {dates[index] ? format(new Date(dates[index]!), 'MMM d') : '-'}
            </div>
          </div>
        ))}
      </div>
    </div>
  )
}

export default TripStatus

// {index < statuses.length - 1 && (
//   <div className={`flex-1 h-1 ${index < status ? 'bg-green-500' : 'bg-gray-300'}`} />
// )}
</file>

<file path="src/components/trip/TripDocuments.tsx">
'use client';

import React from 'react';
import { FaArrowRight } from 'react-icons/fa';
import dynamic from 'next/dynamic';


interface TripDocumentProps {
    ewbValidityDate: Date;
    route: {
        origin: string;
        destination: string;
    };
    startDate: Date;
    documents : any[]
}

const TripDocuments: React.FC<TripDocumentProps> = ({ documents, ewbValidityDate, route, startDate }) => {
    const RecentDocuments = dynamic(()=>import('@/components/documents/RecentDocuments'), {ssr : false})
    // Helper function to check validity of e-way bill
    const isValid = (ewbValidityDate: Date) => {
        const today = new Date();
        return ewbValidityDate >= today;
    };


    return (
        <div className="p-6 min-h-screen">
            
            <div className="flex items-center space-x-2 text-gray-600 mb-2 text-md">
                <span className="font-semibold">{route.origin.split(',')[0]}</span>
                <FaArrowRight className="text-sm text-gray-500" />
                <span className="font-semibold">{route.destination.split(',')[0]}</span>
            </div>

            <p className="text-gray-500">Start Date: {new Date(startDate).toLocaleDateString()}</p>
            <p className={`text-gray-500 ${isValid(ewbValidityDate) ? 'text-green-600' : 'text-red-600'}`}>
                Validity Date: {new Date(ewbValidityDate).toLocaleDateString()}
            </p>

            {/* Grid Layout for E-way Bill and POD */}
            <RecentDocuments docs={documents} />

        </div>
    );
};

export default TripDocuments;
</file>

<file path="src/components/trip/TripRoute.tsx">
import React, { useState, useEffect } from 'react';
import { fetchTripRoute } from '@/helpers/TripOperation';
import { FaArrowRight } from 'react-icons/fa';

interface TripRouteProps {
  tripId: string;
}

const TripRoute: React.FC<TripRouteProps> = ({ tripId }) => {
  const [tripRoute, setTripRoute] = useState<any>(null);
  const [loading, setLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchRoute = async () => {
      try {
        const tripData = await fetchTripRoute(tripId);
        if (tripData) {
          setTripRoute(<div className="flex items-center space-x-2">
            <span>{tripData.origin.split(',')[0]}</span>
            <FaArrowRight className='text-xs'/>
            <span>{tripData.destination.split(',')[0]}</span>
          </div>);
        } else {
          setError('Failed to fetch trip route');
          setTripRoute('NA')
        }
      } catch (err) {
        setError('Failed to fetch trip route');
      } finally {
        setLoading(false);
      }
    };

    fetchRoute();
  }, [tripId]);

  if (loading) return <span>Loading...</span>;
  if (error) return <span>NA</span>;

  return <span>{tripRoute}</span>;
};

export default TripRoute;
</file>

<file path="src/components/TripCard.tsx">
import React from 'react';
import Link from 'next/link';
import { FaRoute } from 'react-icons/fa';
import { GoOrganization } from 'react-icons/go';

interface TripCardProps {
    tripId: string;
    route: {
        origin: string;
        destination: string;
    };
    partyName: string;
    status: number;
    statuses: string[];
    startDate?: Date
}

const TripCard: React.FC<TripCardProps> = ({ tripId, route, partyName, status, statuses, startDate }) => {
    const calculateStatusWidth = (status: number) => {
        // Define the width for each status level in percentage
        const widths = [20, 40, 60, 80, 100]; // Each step increases by 20%
        return `${widths[status]}%`; // Based on the current status, return the corresponding width
    };


    return (
        <Link href={`/user/trips/${tripId}`}>
            <div className="grid grid-cols-3 gap-4 p-2 bg-white rounded-lg w-full">
                <div className="col-span-2 flex flex-col justify-center space-y-1  pr-4">
                    <div className="flex items-center space-x-2">
                        <FaRoute className="text-bottomNavBarColor text-base" />
                        <span className="font-semibold text-sm text-gray-800">
                            {route?.origin.split(',')[0]} &rarr; {route?.destination.split(',')[0]}
                        </span>
                    </div>
                    <div className='flex justify-between'>
                        <div className="flex items-center space-x-2">
                            <GoOrganization className="text-bottomNavBarColor text-base" />
                            <span className="text-xs text-gray-600">{partyName}</span>

                        </div>
                        <p className='text-gray-400 text-xs ml-2'>
                            {startDate && new Date(startDate).toLocaleDateString('en-IN')}
                        </p>
                    </div>
                </div>

                <div className="col-span-1 flex flex-col justify-between items-start pl-4 w-[100px] border-l border-gray-300">
                    <span className="font-semibold text-sm text-gray-600">{statuses[status]}</span>
                    <div className="w-full bg-gray-200 h-2 rounded overflow-hidden mt-1">
                        <div
                            className={`h-full transition-width duration-500 rounded ${status === 0
                                ? "bg-red-500"
                                : status === 1
                                    ? "bg-yellow-500"
                                    : status === 2
                                        ? "bg-blue-500"
                                        : status === 3
                                            ? "bg-green-500"
                                            : "bg-green-800"
                                }`}
                            style={{ width: calculateStatusWidth(status) }}
                        ></div>
                    </div>
                </div>
            </div>
        </Link>
    );
};

export default TripCard;
</file>

<file path="src/components/truck/AdditionalDetails.tsx">
// AdditionalDetails.tsx

import React from 'react';
import {
    Select,
    SelectTrigger,
    SelectContent,
    SelectItem,
    SelectLabel,
    SelectValue
} from '@/components/ui/select'; // Adjust the import path as necessary

type Props = {
    formdata: {
        truckType: string;
        model: string;
        bodyLength: number | null;
        capacity: string;
    };
    renderModelOptions: () => string[];
    handleInputChange: (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => void;
};

const AdditionalDetails: React.FC<Props> = ({ formdata, renderModelOptions, handleInputChange }) => (
    <>
        <div>
            <label>Model</label>
            <Select defaultValue={formdata.model} onValueChange={(value) => handleInputChange({ target: { name: 'model', value } } as React.ChangeEvent<HTMLSelectElement>)}>
                <SelectTrigger >
                    <SelectValue placeholder="Select Model" />
                </SelectTrigger>
                <SelectContent>
                    {renderModelOptions().map((model, index) => (
                        <SelectItem key={index} value={model}>{model}</SelectItem>
                    ))}
                </SelectContent>
            </Select>
        </div>

        {formdata.truckType !== 'Tanker' && (
            <div>
                <label>Body Length</label>
                <input
                    className="w-full p-2 border border-gray-300 rounded-md"
                    type='text'
                    name='bodyLength'
                    value={formdata.bodyLength || ''}
                    placeholder='Enter the Body Length(ft)'
                    onChange={handleInputChange}
                />
            </div>

        )}
        <div>
            <label>Capacity</label>
            <input
                className="w-full p-2 border border-gray-300 rounded-md"
                type='text'
                name='capacity'
                value={formdata.capacity}
                placeholder='Enter the Capacity'
                onChange={handleInputChange}
            />
        </div>

    </>
);

export default AdditionalDetails;
</file>

<file path="src/components/truck/EditTruckModal.tsx">
// components/CreateTruck.tsx
'use client';

import React, { useState, useEffect } from 'react';
import { minitruck, openBody, closedContainer, trailer, truckTypes, truckTypesIcons } from '@/utils/utilArray';
import { validateTruckNo } from '@/utils/validate';
import { IDriver, ISupplier, TruckModel } from '@/utils/interface';
import SupplierSelect from '@/components/truck/SupplierSelect';
import AdditionalDetails from '@/components/truck/AdditionalDetails';
import Loading from '@/app/user/trucks/loading';
import { Button } from '../ui/button';
import DriverSelect from '../trip/DriverSelect';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '../ui/select';
import { useExpenseCtx } from '@/context/context';
import { useExpenseData } from '../hooks/useExpenseData';
import { Loader2 } from 'lucide-react';

type FormData = {
    truckNo: string;
    truckType: string;
    model: string;
    capacity: string;
    bodyLength: number | null;
    ownership: string;
    supplier: string;
    driver_id: string
}

interface EditTruckModalProps {
    truck: TruckModel;
    isOpen: boolean;
    onClose: () => void;
    onSave: (data: any) => void;
}

const EditTruckModal: React.FC<EditTruckModalProps> = ({ truck, isOpen, onClose, onSave }) => {
    const {drivers, suppliers} = useExpenseData()
    const [saving, setSaving] = useState(false);
    const [formdata, setFormdata] = useState<FormData>({
        truckNo: truck?.truckNo || '',
        truckType: truck?.truckType || '',
        model: truck?.model || '',
        capacity: truck?.capacity || '',
        bodyLength: truck?.bodyLength as any || '',
        ownership: truck?.ownership || '',
        supplier: truck?.supplier || '',
        driver_id: truck?.driver_id || ''
    });

    const [showDetails, setShowDetails] = useState<boolean>(false);
    const [error, setError] = useState<string | null>(null);
    const [loading, setLoading] = useState(true);

    // useEffect(() => {
    //     const fetchSuppliers = async () => {
    //         try {
    //             const [supplierRes] = await Promise.all([fetch('/api/suppliers')]);

    //             // Correct the condition to check if either request failed
    //             if (!supplierRes.ok) {
    //                 throw new Error('Failed to fetch data');
    //             }

    //             const [supplierData] = await Promise.all([supplierRes.json()]);
    //             setSuppliers(supplierData.suppliers);
    //         } catch (err) {
    //             setError((err as Error).message);
    //         } finally {
    //             setLoading(false);
    //         }
    //     };

    //     fetchSuppliers();
    // }, []);


    const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
        const { name, value } = e.target;
        setFormdata({
            ...formdata,
            [name]: value
        });
    }

    const handleSelectChange = (name: string, value: string) => {
        setFormdata({
            ...formdata,
            [name]: value
        });
    }

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();

        if (!formdata.truckNo) {
            setError('Enter Truck Number');
            return;
        }

        if (!validateTruckNo(formdata.truckNo)) {
            setError("Please enter a valid Indian truck number.");
            return;
        }

        if (!formdata.ownership) {
            setError('Select Ownership');
            return;
        }

        if (formdata.ownership === 'Market' && !formdata.supplier) {
            setError('Select Supplier');
            return;
        }

        setError(null);
        setSaving(true);

        onSave(formdata)
        onClose()
        setSaving(false)
    };

    const renderModelOptions = () => {
        switch (formdata.truckType) {
            case 'Mini Truck / LCV':
                return minitruck;
            case 'Open Body Truck':
                return openBody;
            case 'Closed Container':
                return closedContainer;
            case 'Trailer':
                return trailer;
            default:
                return [];
        }
    }

    if (!isOpen) return null;

    return (
        <>
            <div className="modal-class"></div>
            <div className="fixed inset-0 flex items-center justify-center z-50">
                <div className="bg-white text-black p-4 max-w-md w-full mx-auto shadow-md rounded-md relative">
                    {saving && (
                        <div className='absolute inset-0 bg-black bg-opacity-10 flex justify-center items-center z-50'>
                            <Loading />
                        </div>
                    )}
                    <form className="space-y-2" onSubmit={handleSubmit}>
                        <div>
                            <label>Lorry No</label>
                            <input
                                className="w-full p-2 border border-gray-300 rounded-md"
                                type='text'
                                name='truckNo'
                                value={formdata.truckNo}
                                placeholder='Enter the Truck Number'
                                onChange={handleInputChange}
                            />
                        </div>

                        <div>
                            <label>Lorry Type</label>
                            <Select defaultValue={formdata.truckType} onValueChange={(value) => setFormdata({ ...formdata, truckType: value })}>
                                <SelectTrigger>
                                    <SelectValue placeholder="Select Truck Type" />
                                </SelectTrigger>
                                <SelectContent>
                                    {truckTypesIcons.map(({ type, Icon }) => (
                                        <SelectItem key={type} value={type}>
                                            <Icon className="inline-block mr-2" /> {type}
                                        </SelectItem>
                                    ))}
                                </SelectContent>
                            </Select>
                        </div>

                        <div>
                            <label>Ownership</label>
                            <Select defaultValue={formdata.ownership} onValueChange={(value) => setFormdata({ ...formdata, ownership: value })}>
                                <SelectTrigger >
                                    <SelectValue placeholder="Select Ownership*" />
                                </SelectTrigger>
                                <SelectContent>
                                    <SelectItem value='Self'>Self</SelectItem>
                                    <SelectItem value='Market'>Market</SelectItem>
                                </SelectContent>
                            </Select>
                        </div>

                        <div>
                            <label>Driver</label>
                            <Select name="driver_id" value={formdata.driver_id} onValueChange={(value) => setFormdata({ ...formdata, driver_id: value })}>
                                <SelectTrigger className="w-full">
                                    <SelectValue placeholder="Select Driver" />
                                </SelectTrigger>
                                <SelectContent>
                                    {drivers.map((driver) => (
                                        <SelectItem key={driver.driver_id} value={driver.driver_id}>
                                            <span>{driver.name}</span>
                                            <span
                                                className={`ml-2 p-1 rounded ${driver.status === 'Available' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}
                                            >
                                                {driver.status}
                                            </span>
                                        </SelectItem>
                                    ))}
                                </SelectContent>
                            </Select>
                        </div>


                        {formdata.ownership === 'Market' && (
                            <div>
                                <label>Supplier</label>
                                <SupplierSelect
                                    suppliers={suppliers}
                                    value={formdata.supplier}
                                    onChange={handleSelectChange}
                                />
                            </div>

                        )}
                        {showDetails && formdata.truckType !== 'Other' && (
                            <AdditionalDetails
                                formdata={formdata}
                                renderModelOptions={renderModelOptions}
                                handleInputChange={handleInputChange}
                            />
                        )}
                        {formdata.truckType !== 'Other' && (
                            <Button
                                className='hover:scale-100 w-full'
                                type="button"
                                onClick={() => setShowDetails((prev) => !prev)}
                            >
                                {showDetails ? 'Hide Details' : 'Add More Details'}
                            </Button>
                        )}

                        {error && <div className="text-red-500">{error}</div>}
                        <div className='flex flex-row w-full justify-end gap-2'>
                            <Button
                                type="submit"
                                disabled={saving}
                            >
                                {saving ? <><Loader2 className='animate-spin'/></> : "Submit"}
                            </Button>
                            <Button
                                variant={'ghost'}
                                onClick={() => onClose()}
                            >
                                Cancel
                            </Button>
                        </div>
                    </form>
                </div>
            </div>
        </>
    );
}

export default EditTruckModal;
</file>

<file path="src/components/truck/FuelInput.tsx">
import { useEffect, useState } from "react";

interface FuelModalProps {
    isOpen: boolean;
    onClose: () => void;
    onSave: (data: { liters: number; rate: number; total: number }) => void;
  }
  
 export  const FuelModal: React.FC<FuelModalProps> = ({ isOpen, onClose, onSave }) => {
    const [fuelData, setFuelData] = useState({
      liters: 0,
      rate: 0,
      total: 0,
    });
  
    useEffect(() => {
      setFuelData((prev) => ({
        ...prev,
        total: prev.liters * prev.rate,
      }));
    }, [fuelData.liters, fuelData.rate]);
  
    const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
      const { name, value } = e.target;
      setFuelData({ ...fuelData, [name]: parseFloat(value) });
    };
  
    const handleSave = () => {
      onSave(fuelData);
      onClose();
    };
  
    if (!isOpen) return null;
  
    return (
      <>
        <div className="fixed inset-0 bg-black bg-opacity-50 z-40"></div>
        <div className="fixed inset-0 flex items-center justify-center z-50">
          <div className="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
            <h2 className="text-xl font-semibold mb-4">Add Fuel Expense</h2>
  
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700">Liters</label>
              <input
                type="number"
                name="liters"
                value={fuelData.liters}
                onChange={handleChange}
                className="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
  
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700">Rate per Liter</label>
              <input
                type="number"
                name="rate"
                value={fuelData.rate}
                onChange={handleChange}
                className="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
  
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700">Total Amount</label>
              <input
                type="number"
                name="total"
                value={fuelData.total}
                readOnly
                className="w-full p-2 border border-gray-300 rounded-md bg-gray-100"
              />
            </div>
  
            <div className="flex justify-end">
              <button onClick={onClose} className="mr-2 p-2 bg-gray-300 rounded-md">
                Cancel
              </button>
              <button onClick={handleSave} className="p-2 bg-blue-500 text-white rounded-md">
                Save
              </button>
            </div>
          </div>
        </div>
      </>
    );
  };
</file>

<file path="src/components/truck/TruckDocument.tsx">
'use client';

import React, { useEffect, useState } from 'react';
import { Button } from '../ui/button';
import RecentDocuments from '../documents/RecentDocuments';
import Link from 'next/link';
import TruckDocumentUpload from '../documents/TruckDocumentUpload';
import { FaChevronRight } from 'react-icons/fa6';
import { CloudUpload, Loader2 } from 'lucide-react';
import { useToast } from '../hooks/use-toast';


interface TruckDocumentProps {
    truckNo: string;
}

const TruckDocuments: React.FC<TruckDocumentProps> = ({ truckNo }) => {

    const [documents, setDocuments] = useState<any>([]);
    const [modalOpen, setModalOpen] = useState(false)
    const [loading, setLoading] = useState(true)
    const { toast } = useToast()

    useEffect(() => {
        const fetchTruck = async () => {
            try {
                const response = await fetch(`/api/trucks/${truckNo}`);
                const data = response.ok ? await response.json() : alert('Failed to load documents');
                setDocuments(data.truck.documents);
            } catch (error) {
                console.log(error)
                toast({
                    description: 'Failed to load documents',
                    variant: 'destructive'
                })
            }
            setLoading(false)
        };

        fetchTruck();
    }, [truckNo]);



    return (
        <div className="p-6 bg-gray-100 min-h-screen">
            <div className="flex items-center justify-between mb-4 border-b-2 border-gray-300 pb-2">
                <h1 className="text-2xl font-semibold text-black flex items-center space-x-2">
                    <Button variant={'link'}>
                        <Link href="/user/documents" className="text-2xl font-semibold hover:underline">
                            Docs
                        </Link>
                    </Button>
                    <FaChevronRight className="text-lg text-gray-500" />
                    <Button variant={'link'}>
                        <Link href="/user/documents/truckDocuments" className="text-2xl font-semibold hover:underline">
                            Lorry Docs
                        </Link>
                    </Button>

                    <FaChevronRight className="text-lg text-gray-500" />
                    <span className="text-black">{truckNo}</span>
                </h1>
                <div className='flex justify-end my-2 fixed right-4 bottom-4'>
                    <Button onClick={() => setModalOpen(true)} className='rounded-full h-full py-2'><CloudUpload size={40} /></Button>
                </div>
            </div>
            {loading ?
                <div className='flex flex-col items-center justify-center'><Loader2 className='text-bottomNavBarColor animate-spin' /><p className='text-black'>fetching documents...</p></div> :
                <RecentDocuments docs={documents} />
            }


                    <TruckDocumentUpload open={modalOpen} setOpen={setModalOpen} truckNo={truckNo} setDocuments={setDocuments} />
               
        </div>
    );
};

export default TruckDocuments;
</file>

<file path="src/components/ui/alert.tsx">
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",
  {
    variants: {
      variant: {
        default: "bg-background text-foreground",
        destructive:
          "border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Alert = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>
>(({ className, variant, ...props }, ref) => (
  <div
    ref={ref}
    role="alert"
    className={cn(alertVariants({ variant }), className)}
    {...props}
  />
))
Alert.displayName = "Alert"

const AlertTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h5
    ref={ref}
    className={cn("mb-1 font-medium leading-none tracking-tight", className)}
    {...props}
  />
))
AlertTitle.displayName = "AlertTitle"

const AlertDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm [&_p]:leading-relaxed", className)}
    {...props}
  />
))
AlertDescription.displayName = "AlertDescription"

export { Alert, AlertTitle, AlertDescription }
</file>

<file path="src/components/ui/button.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 transition-all duration-300 ease-in-out transform hover:scale-105 ",
  {
    variants: {
      variant: {
        default: "bg-[#FFA500] text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-white hover:bg-lightOrangeButtonColor+90",
        outline:
          "border border-lightOrange text-buttonTextColor bg-background hover:bg-accent transition-all duration-300 ease-in-out transform hover:scale-105",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost: "hover:bg-lightOrangeButtonColor hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
        newyork: "bg-[#FFA500] text-white hover:bg-bottomNavBarColor hover:text-white focus:outline-none focus:ring-2 focus:ring-gray-600 focus:ring-opacity-50", // Add this line
      },
      size: {
        default: "h-10 px-4 py-2",
        sm: "h-9 rounded-md px-3",
        lg: "h-11 rounded-md px-8",
        icon: "h-10 w-10",
      },
    },
    defaultVariants: {
      variant: "newyork",
      size: "sm",
    },
  }
);


export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button"
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }
</file>

<file path="src/components/ui/calendar.tsx">
"use client"

import * as React from "react"
import { ChevronLeft, ChevronRight } from "lucide-react"
import { DayPicker } from "react-day-picker"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

export type CalendarProps = React.ComponentProps<typeof DayPicker>

function Calendar({
  className,
  classNames,
  showOutsideDays = true,
  ...props
}: CalendarProps) {
  return (
    <DayPicker
      showOutsideDays={showOutsideDays}
      className={cn("p-3", className)}
      classNames={{
        months: "flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",
        month: "space-y-4",
        caption: "flex justify-center pt-1 relative items-center",
        caption_label: "text-sm font-medium",
        nav: "space-x-1 flex items-center",
        nav_button: cn(
          buttonVariants({ variant: "outline" }),
          "h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100"
        ),
        nav_button_previous: "absolute left-1",
        nav_button_next: "absolute right-1",
        table: "w-full border-collapse space-y-1",
        head_row: "flex",
        head_cell:
          "text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]",
        row: "flex w-full mt-2",
        cell: "h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",
        day: cn(
          buttonVariants({ variant: "ghost" }),
          "h-9 w-9 p-0 font-normal aria-selected:opacity-100"
        ),
        day_range_end: "day-range-end",
        day_selected:
          "bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",
        day_today: "bg-accent text-accent-foreground",
        day_outside:
          "day-outside text-muted-foreground opacity-50 aria-selected:bg-accent/50 aria-selected:text-muted-foreground aria-selected:opacity-30",
        day_disabled: "text-muted-foreground opacity-50",
        day_range_middle:
          "aria-selected:bg-accent aria-selected:text-accent-foreground",
        day_hidden: "invisible",
        ...classNames,
      }}
      components={{
        IconLeft: ({ ...props }) => <ChevronLeft className="h-4 w-4" />,
        IconRight: ({ ...props }) => <ChevronRight className="h-4 w-4" />,
      }}
      {...props}
    />
  )
}
Calendar.displayName = "Calendar"

export { Calendar }
</file>

<file path="src/components/ui/card.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-lg border bg-card text-card-foreground shadow-sm",
      className
    )}
    {...props}
  />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "text-2xl font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }
</file>

<file path="src/components/ui/carousel.tsx">
"use client"

import * as React from "react"
import useEmblaCarousel, {
  type UseEmblaCarouselType,
} from "embla-carousel-react"
import { ArrowLeft, ArrowRight } from "lucide-react"

import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"

type CarouselApi = UseEmblaCarouselType[1]
type UseCarouselParameters = Parameters<typeof useEmblaCarousel>
type CarouselOptions = UseCarouselParameters[0]
type CarouselPlugin = UseCarouselParameters[1]

type CarouselProps = {
  opts?: CarouselOptions
  plugins?: CarouselPlugin
  orientation?: "horizontal" | "vertical"
  setApi?: (api: CarouselApi) => void
}

type CarouselContextProps = {
  carouselRef: ReturnType<typeof useEmblaCarousel>[0]
  api: ReturnType<typeof useEmblaCarousel>[1]
  scrollPrev: () => void
  scrollNext: () => void
  canScrollPrev: boolean
  canScrollNext: boolean
} & CarouselProps

const CarouselContext = React.createContext<CarouselContextProps | null>(null)

function useCarousel() {
  const context = React.useContext(CarouselContext)

  if (!context) {
    throw new Error("useCarousel must be used within a <Carousel />")
  }

  return context
}

const Carousel = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & CarouselProps
>(
  (
    {
      orientation = "horizontal",
      opts,
      setApi,
      plugins,
      className,
      children,
      ...props
    },
    ref
  ) => {
    const [carouselRef, api] = useEmblaCarousel(
      {
        ...opts,
        axis: orientation === "horizontal" ? "x" : "y",
      },
      plugins
    )
    const [canScrollPrev, setCanScrollPrev] = React.useState(false)
    const [canScrollNext, setCanScrollNext] = React.useState(false)

    const onSelect = React.useCallback((api: CarouselApi) => {
      if (!api) {
        return
      }

      setCanScrollPrev(api.canScrollPrev())
      setCanScrollNext(api.canScrollNext())
    }, [])

    const scrollPrev = React.useCallback(() => {
      api?.scrollPrev()
    }, [api])

    const scrollNext = React.useCallback(() => {
      api?.scrollNext()
    }, [api])

    const handleKeyDown = React.useCallback(
      (event: React.KeyboardEvent<HTMLDivElement>) => {
        if (event.key === "ArrowLeft") {
          event.preventDefault()
          scrollPrev()
        } else if (event.key === "ArrowRight") {
          event.preventDefault()
          scrollNext()
        }
      },
      [scrollPrev, scrollNext]
    )

    React.useEffect(() => {
      if (!api || !setApi) {
        return
      }

      setApi(api)
    }, [api, setApi])

    React.useEffect(() => {
      if (!api) {
        return
      }

      onSelect(api)
      api.on("reInit", onSelect)
      api.on("select", onSelect)

      return () => {
        api?.off("select", onSelect)
      }
    }, [api, onSelect])

    return (
      <CarouselContext.Provider
        value={{
          carouselRef,
          api: api,
          opts,
          orientation:
            orientation || (opts?.axis === "y" ? "vertical" : "horizontal"),
          scrollPrev,
          scrollNext,
          canScrollPrev,
          canScrollNext,
        }}
      >
        <div
          ref={ref}
          onKeyDownCapture={handleKeyDown}
          className={cn("relative", className)}
          role="region"
          aria-roledescription="carousel"
          {...props}
        >
          {children}
        </div>
      </CarouselContext.Provider>
    )
  }
)
Carousel.displayName = "Carousel"

const CarouselContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const { carouselRef, orientation } = useCarousel()

  return (
    <div ref={carouselRef} className="overflow-hidden">
      <div
        ref={ref}
        className={cn(
          "flex",
          orientation === "horizontal" ? "-ml-4" : "-mt-4 flex-col",
          className
        )}
        {...props}
      />
    </div>
  )
})
CarouselContent.displayName = "CarouselContent"

const CarouselItem = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const { orientation } = useCarousel()

  return (
    <div
      ref={ref}
      role="group"
      aria-roledescription="slide"
      className={cn(
        "min-w-0 shrink-0 grow-0 basis-full",
        orientation === "horizontal" ? "pl-4" : "pt-4",
        className
      )}
      {...props}
    />
  )
})
CarouselItem.displayName = "CarouselItem"

const CarouselPrevious = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<typeof Button>
>(({ className, variant = "outline", size = "icon", ...props }, ref) => {
  const { orientation, scrollPrev, canScrollPrev } = useCarousel()

  return (
    <Button
      ref={ref}
      variant={variant}
      size={size}
      className={cn(
        "absolute  h-8 w-8 rounded-full",
        orientation === "horizontal"
          ? "-left-12 top-1/2 -translate-y-1/2"
          : "-top-12 left-1/2 -translate-x-1/2 rotate-90",
        className
      )}
      disabled={!canScrollPrev}
      onClick={scrollPrev}
      {...props}
    >
      <ArrowLeft className="h-4 w-4" />
      <span className="sr-only">Previous slide</span>
    </Button>
  )
})
CarouselPrevious.displayName = "CarouselPrevious"

const CarouselNext = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<typeof Button>
>(({ className, variant = "outline", size = "icon", ...props }, ref) => {
  const { orientation, scrollNext, canScrollNext } = useCarousel()

  return (
    <Button
      ref={ref}
      variant={variant}
      size={size}
      className={cn(
        "absolute h-8 w-8 rounded-full",
        orientation === "horizontal"
          ? "-right-12 top-1/2 -translate-y-1/2"
          : "-bottom-12 left-1/2 -translate-x-1/2 rotate-90",
        className
      )}
      disabled={!canScrollNext}
      onClick={scrollNext}
      {...props}
    >
      <ArrowRight className="h-4 w-4" />
      <span className="sr-only">Next slide</span>
    </Button>
  )
})
CarouselNext.displayName = "CarouselNext"

export {
  type CarouselApi,
  Carousel,
  CarouselContent,
  CarouselItem,
  CarouselPrevious,
  CarouselNext,
}
</file>

<file path="src/components/ui/chart.tsx">
"use client"

import * as React from "react"
import * as RechartsPrimitive from "recharts"

import { cn } from "@/lib/utils"

// Format: { THEME_NAME: CSS_SELECTOR }
const THEMES = { light: "", dark: ".dark" } as const

export type ChartConfig = {
  [k in string]: {
    label?: React.ReactNode
    icon?: React.ComponentType
  } & (
    | { color?: string; theme?: never }
    | { color?: never; theme: Record<keyof typeof THEMES, string> }
  )
}

type ChartContextProps = {
  config: ChartConfig
}

const ChartContext = React.createContext<ChartContextProps | null>(null)

function useChart() {
  const context = React.useContext(ChartContext)

  if (!context) {
    throw new Error("useChart must be used within a <ChartContainer />")
  }

  return context
}

const ChartContainer = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    config: ChartConfig
    children: React.ComponentProps<
      typeof RechartsPrimitive.ResponsiveContainer
    >["children"]
  }
>(({ id, className, children, config, ...props }, ref) => {
  const uniqueId = React.useId()
  const chartId = `chart-${id || uniqueId.replace(/:/g, "")}`

  return (
    <ChartContext.Provider value={{ config }}>
      <div
        data-chart={chartId}
        ref={ref}
        className={cn(
          "flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none",
          className
        )}
        {...props}
      >
        <ChartStyle id={chartId} config={config} />
        <RechartsPrimitive.ResponsiveContainer>
          {children}
        </RechartsPrimitive.ResponsiveContainer>
      </div>
    </ChartContext.Provider>
  )
})
ChartContainer.displayName = "Chart"

const ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {
  const colorConfig = Object.entries(config).filter(
    ([_, config]) => config.theme || config.color
  )

  if (!colorConfig.length) {
    return null
  }

  return (
    <style
      dangerouslySetInnerHTML={{
        __html: Object.entries(THEMES)
          .map(
            ([theme, prefix]) => `
${prefix} [data-chart=${id}] {
${colorConfig
  .map(([key, itemConfig]) => {
    const color =
      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||
      itemConfig.color
    return color ? `  --color-${key}: ${color};` : null
  })
  .join("\n")}
}
`
          )
          .join("\n"),
      }}
    />
  )
}

const ChartTooltip = RechartsPrimitive.Tooltip

const ChartTooltipContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &
    React.ComponentProps<"div"> & {
      hideLabel?: boolean
      hideIndicator?: boolean
      indicator?: "line" | "dot" | "dashed"
      nameKey?: string
      labelKey?: string
    }
>(
  (
    {
      active,
      payload,
      className,
      indicator = "dot",
      hideLabel = false,
      hideIndicator = false,
      label,
      labelFormatter,
      labelClassName,
      formatter,
      color,
      nameKey,
      labelKey,
    },
    ref
  ) => {
    const { config } = useChart()

    const tooltipLabel = React.useMemo(() => {
      if (hideLabel || !payload?.length) {
        return null
      }

      const [item] = payload
      const key = `${labelKey || item.dataKey || item.name || "value"}`
      const itemConfig = getPayloadConfigFromPayload(config, item, key)
      const value =
        !labelKey && typeof label === "string"
          ? config[label as keyof typeof config]?.label || label
          : itemConfig?.label

      if (labelFormatter) {
        return (
          <div className={cn("font-medium", labelClassName)}>
            {labelFormatter(value, payload)}
          </div>
        )
      }

      if (!value) {
        return null
      }

      return <div className={cn("font-medium", labelClassName)}>{value}</div>
    }, [
      label,
      labelFormatter,
      payload,
      hideLabel,
      labelClassName,
      config,
      labelKey,
    ])

    if (!active || !payload?.length) {
      return null
    }

    const nestLabel = payload.length === 1 && indicator !== "dot"

    return (
      <div
        ref={ref}
        className={cn(
          "grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-white px-2.5 py-1.5 text-xs shadow-xl",
          className
        )}
      >
        {!nestLabel ? tooltipLabel : null}
        <div className="grid gap-1.5">
          {payload.map((item, index) => {
            const key = `${nameKey || item.name || item.dataKey || "value"}`
            const itemConfig = getPayloadConfigFromPayload(config, item, key)
            const indicatorColor = color || item.payload.fill || item.color

            return (
              <div
                key={item.dataKey}
                className={cn(
                  "flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground",
                  indicator === "dot" && "items-center"
                )}
              >
                {formatter && item?.value !== undefined && item.name ? (
                  formatter(item.value, item.name, item, index, item.payload)
                ) : (
                  <>
                    {itemConfig?.icon ? (
                      <itemConfig.icon />
                    ) : (
                      !hideIndicator && (
                        <div
                          className={cn(
                            "shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]",
                            {
                              "h-2.5 w-2.5": indicator === "dot",
                              "w-1": indicator === "line",
                              "w-0 border-[1.5px] border-dashed bg-transparent":
                                indicator === "dashed",
                              "my-0.5": nestLabel && indicator === "dashed",
                            }
                          )}
                          style={
                            {
                              "--color-bg": indicatorColor,
                              "--color-border": indicatorColor,
                            } as React.CSSProperties
                          }
                        />
                      )
                    )}
                    <div
                      className={cn(
                        "flex flex-1 justify-between leading-none",
                        nestLabel ? "items-end" : "items-center"
                      )}
                    >
                      <div className="grid gap-1.5">
                        {nestLabel ? tooltipLabel : null}
                        <span className="text-muted-foreground">
                          {itemConfig?.label || item.name}
                        </span>
                      </div>
                      {item.value && (
                        <span className="font-mono font-medium tabular-nums text-foreground">
                          {item.value.toLocaleString()}
                        </span>
                      )}
                    </div>
                  </>
                )}
              </div>
            )
          })}
        </div>
      </div>
    )
  }
)
ChartTooltipContent.displayName = "ChartTooltip"

const ChartLegend = RechartsPrimitive.Legend

const ChartLegendContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> &
    Pick<RechartsPrimitive.LegendProps, "payload" | "verticalAlign"> & {
      hideIcon?: boolean
      nameKey?: string
    }
>(
  (
    { className, hideIcon = false, payload, verticalAlign = "bottom", nameKey },
    ref
  ) => {
    const { config } = useChart()

    if (!payload?.length) {
      return null
    }

    return (
      <div
        ref={ref}
        className={cn(
          "flex items-center justify-center gap-4",
          verticalAlign === "top" ? "pb-3" : "pt-3",
          className
        )}
      >
        {payload.map((item) => {
          const key = `${nameKey || item.dataKey || "value"}`
          const itemConfig = getPayloadConfigFromPayload(config, item, key)

          return (
            <div
              key={item.value}
              className={cn(
                "flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground"
              )}
            >
              {itemConfig?.icon && !hideIcon ? (
                <itemConfig.icon />
              ) : (
                <div
                  className="h-3 w-3 shrink-0 rounded-[2px]"
                  style={{
                    backgroundColor: item.color,
                  }}
                />
              )}
              {itemConfig?.label}
            </div>
          )
        })}
      </div>
    )
  }
)
ChartLegendContent.displayName = "ChartLegend"

// Helper to extract item config from a payload.
function getPayloadConfigFromPayload(
  config: ChartConfig,
  payload: unknown,
  key: string
) {
  if (typeof payload !== "object" || payload === null) {
    return undefined
  }

  const payloadPayload =
    "payload" in payload &&
    typeof payload.payload === "object" &&
    payload.payload !== null
      ? payload.payload
      : undefined

  let configLabelKey: string = key

  if (
    key in payload &&
    typeof payload[key as keyof typeof payload] === "string"
  ) {
    configLabelKey = payload[key as keyof typeof payload] as string
  } else if (
    payloadPayload &&
    key in payloadPayload &&
    typeof payloadPayload[key as keyof typeof payloadPayload] === "string"
  ) {
    configLabelKey = payloadPayload[
      key as keyof typeof payloadPayload
    ] as string
  }

  return configLabelKey in config
    ? config[configLabelKey]
    : config[key as keyof typeof config]
}

export {
  ChartContainer,
  ChartTooltip,
  ChartTooltipContent,
  ChartLegend,
  ChartLegendContent,
  ChartStyle,
}
</file>

<file path="src/components/ui/checkbox.tsx">
"use client"

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { Check } from "lucide-react"

import { cn } from "@/lib/utils"

const Checkbox = React.forwardRef<
  React.ElementRef<typeof CheckboxPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>
>(({ className, ...props }, ref) => (
  <CheckboxPrimitive.Root
    ref={ref}
    className={cn(
      "peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",
      className
    )}
    {...props}
  >
    <CheckboxPrimitive.Indicator
      className={cn("flex items-center justify-center text-current")}
    >
      <Check className="h-4 w-4" />
    </CheckboxPrimitive.Indicator>
  </CheckboxPrimitive.Root>
))
Checkbox.displayName = CheckboxPrimitive.Root.displayName

export { Checkbox }
</file>

<file path="src/components/ui/dialog.tsx">
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Dialog = DialogPrimitive.Root

const DialogTrigger = DialogPrimitive.Trigger

const DialogPortal = DialogPrimitive.Portal

const DialogClose = DialogPrimitive.Close

const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      "fixed inset-0 z-50 bg-black/40 backdrop-blur-sm data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
  />
))
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-white p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    >
      {children}
      <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </DialogPrimitive.Close>
    </DialogPrimitive.Content>
  </DialogPortal>
))
DialogContent.displayName = DialogPrimitive.Content.displayName

const DialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-1.5 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
DialogHeader.displayName = "DialogHeader"

const DialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
DialogFooter.displayName = "DialogFooter"

const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
DialogTitle.displayName = DialogPrimitive.Title.displayName

const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
DialogDescription.displayName = DialogPrimitive.Description.displayName

export {
  Dialog,
  DialogPortal,
  DialogOverlay,
  DialogClose,
  DialogTrigger,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
}
</file>

<file path="src/components/ui/dropdown-menu.tsx">
"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const DropdownMenu = DropdownMenuPrimitive.Root

const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger

const DropdownMenuGroup = DropdownMenuPrimitive.Group

const DropdownMenuPortal = DropdownMenuPrimitive.Portal

const DropdownMenuSub = DropdownMenuPrimitive.Sub

const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup

const DropdownMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
    inset?: boolean
  }
>(({ className, inset, children, ...props }, ref) => (
  <DropdownMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-white",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </DropdownMenuPrimitive.SubTrigger>
))
DropdownMenuSubTrigger.displayName =
  DropdownMenuPrimitive.SubTrigger.displayName

const DropdownMenuSubContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
DropdownMenuSubContent.displayName =
  DropdownMenuPrimitive.SubContent.displayName

const DropdownMenuContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <DropdownMenuPrimitive.Portal>
    <DropdownMenuPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-white p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </DropdownMenuPrimitive.Portal>
))
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName

const DropdownMenuItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Item
    ref={ref}
    className={cn(
      "text-gray-700 relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName

const DropdownMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <DropdownMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.CheckboxItem>
))
DropdownMenuCheckboxItem.displayName =
  DropdownMenuPrimitive.CheckboxItem.displayName

const DropdownMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <DropdownMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.RadioItem>
))
DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName

const DropdownMenuLabel = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName

const DropdownMenuSeparator = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName

const DropdownMenuShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn("ml-auto text-xs tracking-widest opacity-60", className)}
      {...props}
    />
  )
}
DropdownMenuShortcut.displayName = "DropdownMenuShortcut"

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuGroup,
  DropdownMenuPortal,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuRadioGroup,
}
</file>

<file path="src/components/ui/input-otp.tsx">
"use client"

import * as React from "react"
import { OTPInput, OTPInputContext } from "input-otp"
import { Dot } from "lucide-react"

import { cn } from "@/lib/utils"

const InputOTP = React.forwardRef<
  React.ElementRef<typeof OTPInput>,
  React.ComponentPropsWithoutRef<typeof OTPInput>
>(({ className, containerClassName, ...props }, ref) => (
  <OTPInput
    ref={ref}
    containerClassName={cn(
      "flex items-center gap-2",
      "disabled:opacity-50 disabled:cursor-not-allowed",
      containerClassName
    )}
    className={cn("outline-none", className)}
    {...props}
  />
))
InputOTP.displayName = "InputOTP"

const InputOTPGroup = React.forwardRef<
  React.ElementRef<"div">,
  React.ComponentPropsWithoutRef<"div">
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "flex items-center justify-center",
      "gap-2",
      className
    )}
    {...props}
  />
))
InputOTPGroup.displayName = "InputOTPGroup"

const InputOTPSlot = React.forwardRef<
  React.ElementRef<"div">,
  React.ComponentPropsWithoutRef<"div"> & { index: number }
>(({ index, className, ...props }, ref) => {
  const inputOTPContext = React.useContext(OTPInputContext)
  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]

  return (
    <div
      ref={ref}
      className={cn(
        "relative flex h-12 w-12 items-center justify-center",
        "border border-lightOrange rounded-xl",
        "bg-white text-lg font-medium text-center text-black",
        "transition-all duration-200 ease-in-out",
        isActive ? "ring-2 ring-lightOrange ring-offset-2" : "border-gray-300",
        "focus:ring-lightOrange focus:border-lightOrange",
        "hover:bg-gray-50",
        className
      )}
      aria-label={`OTP Slot ${index + 1}`}
      {...props}
    >
      {char || (hasFakeCaret && (
        <div className="pointer-events-none absolute inset-0 flex items-center justify-center">
          <div className="h-6 w-px bg-blue-500 animate-blink" />
        </div>
      ))}
    </div>
  )
})
InputOTPSlot.displayName = "InputOTPSlot"

const InputOTPSeparator = React.forwardRef<
  React.ElementRef<"div">,
  React.ComponentPropsWithoutRef<"div">
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    role="separator"
    aria-hidden="true"
    className={cn("flex items-center justify-center text-gray-500", className)}
    {...props}
  >
    <Dot />
  </div>
))
InputOTPSeparator.displayName = "InputOTPSeparator"

export { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }
</file>

<file path="src/components/ui/input.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

export interface InputProps
  extends React.InputHTMLAttributes<HTMLInputElement> {}

const Input = React.forwardRef<HTMLInputElement, InputProps>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "text-black flex h-10 w-full rounded-full border border-input bg-white px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }
</file>

<file path="src/components/ui/label.tsx">
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const labelVariants = cva(
  "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
)

const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
    VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root
    ref={ref}
    className={cn(labelVariants(), className)}
    {...props}
  />
))
Label.displayName = LabelPrimitive.Root.displayName

export { Label }
</file>

<file path="src/components/ui/LoadingIndicator.tsx">
import { Loader2 } from "lucide-react";

export const loadingIndicator = (
  <div role="status" className="flex items-center justify-center screen">
    {/* <svg
        aria-hidden="true"
        className="w-8 h-8 text-gray-200 animate-spin dark:text-gray-600 fill-bottomNavBarColor"
        viewBox="0 0 100 101"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z"
          fill="currentColor"
        />
        <path
          d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z"
          fill="currentFill"
        />
      </svg> */}
    <Loader2 className="text-bottomNavBarColor animate-spin" />
    <span className="sr-only">Loading...</span>
  </div>
);
</file>

<file path="src/components/ui/popover.tsx">
"use client"

import * as React from "react"
import * as PopoverPrimitive from "@radix-ui/react-popover"

import { cn } from "@/lib/utils"

const Popover = PopoverPrimitive.Root

const PopoverTrigger = PopoverPrimitive.Trigger

const PopoverContent = React.forwardRef<
  React.ElementRef<typeof PopoverPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <PopoverPrimitive.Portal>
    <PopoverPrimitive.Content
      ref={ref}
      align={align}
      sideOffset={sideOffset}
      className={cn(
        "z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        className
      )}
      {...props}
    />
  </PopoverPrimitive.Portal>
))
PopoverContent.displayName = PopoverPrimitive.Content.displayName

export { Popover, PopoverTrigger, PopoverContent }
</file>

<file path="src/components/ui/radio-group.tsx">
"use client"

import * as React from "react"
import * as RadioGroupPrimitive from "@radix-ui/react-radio-group"
import { Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const RadioGroup = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>
>(({ className, ...props }, ref) => {
  return (
    <RadioGroupPrimitive.Root
      className={cn("grid gap-2", className)}
      {...props}
      ref={ref}
    />
  )
})
RadioGroup.displayName = RadioGroupPrimitive.Root.displayName

const RadioGroupItem = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>
>(({ className, ...props }, ref) => {
  return (
    <RadioGroupPrimitive.Item
      ref={ref}
      className={cn(
        "aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <RadioGroupPrimitive.Indicator className="flex items-center justify-center">
        <Circle className="h-2.5 w-2.5 fill-current text-current" />
      </RadioGroupPrimitive.Indicator>
    </RadioGroupPrimitive.Item>
  )
})
RadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName

export { RadioGroup, RadioGroupItem }
</file>

<file path="src/components/ui/resizable.tsx">
"use client"

import { GripVertical } from "lucide-react"
import * as ResizablePrimitive from "react-resizable-panels"

import { cn } from "@/lib/utils"

const ResizablePanelGroup = ({
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (
  <ResizablePrimitive.PanelGroup
    className={cn(
      "flex h-full w-full data-[panel-group-direction=vertical]:flex-col",
      className
    )}
    {...props}
  />
)

const ResizablePanel = ResizablePrimitive.Panel

const ResizableHandle = ({
  withHandle,
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
  withHandle?: boolean
}) => (
  <ResizablePrimitive.PanelResizeHandle
    className={cn(
      "relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90",
      className
    )}
    {...props}
  >
    {withHandle && (
      <div className="z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border">
        <GripVertical className="h-2.5 w-2.5" />
      </div>
    )}
  </ResizablePrimitive.PanelResizeHandle>
)

export { ResizablePanelGroup, ResizablePanel, ResizableHandle }
</file>

<file path="src/components/ui/select.tsx">
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { Check, ChevronDown, ChevronUp, X } from "lucide-react"

import { cn } from "@/lib/utils"

const Select = SelectPrimitive.Root

const SelectGroup = SelectPrimitive.Group

const SelectValue = SelectPrimitive.Value

const SelectTrigger = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Trigger
    ref={ref}
    className={cn(
      "text-gray-700 flex h-10 w-full items-center justify-between rounded-full border-black/25 border-2 bg-white px-3 py-2 text-sm ring-lightOrange placeholder:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring focus:ring-gray-300 disabled:cursor-not-allowed disabled:opacity-50",
      className
    )}
    {...props}
  >
    {children}
    <SelectPrimitive.Icon asChild>
      <ChevronDown className="h-4 w-4 opacity-50" />
    </SelectPrimitive.Icon>
  </SelectPrimitive.Trigger>
))
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName

const SelectScrollUpButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollUpButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronUp className="h-4 w-4" />
  </SelectPrimitive.ScrollUpButton>
))
SelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName

const SelectScrollDownButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollDownButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronDown className="h-4 w-4" />
  </SelectPrimitive.ScrollDownButton>
))
SelectScrollDownButton.displayName =
  SelectPrimitive.ScrollDownButton.displayName

const SelectContent = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = "popper", ...props }, ref) => (
  <SelectPrimitive.Portal>
    <SelectPrimitive.Content
      ref={ref}
      className={cn(
        "text-gray-700 relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border-2 border-black/25 bg-white text-popover-foreground shadow-md",
        position === "popper" &&
          "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
        className
      )}
      position={position}
      {...props}
    >
      <SelectScrollUpButton />
      <SelectPrimitive.Viewport
        className={cn(
          "p-1",
          position === "popper" &&
            "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
        )}
      >
        {children}
      </SelectPrimitive.Viewport>
      <SelectScrollDownButton />
    </SelectPrimitive.Content>
  </SelectPrimitive.Portal>
))
SelectContent.displayName = SelectPrimitive.Content.displayName

const SelectLabel = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Label
    ref={ref}
    className={cn("py-1.5 pl-8 pr-2 text-sm font-semibold", className)}
    {...props}
  />
))
SelectLabel.displayName = SelectPrimitive.Label.displayName

const SelectItem = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none text-black transition-all duration-200 ease-in-out transform hover:cursor-pointer focus:bg-bottomNavBarColor focus:bg-opacity-80 focus:rounded-xl focus:text-white focus:scale-105 focus:font-semibold ",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <SelectPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </SelectPrimitive.ItemIndicator>
    </span>

    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
  </SelectPrimitive.Item>
))
SelectItem.displayName = SelectPrimitive.Item.displayName

const SelectSeparator = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
SelectSeparator.displayName = SelectPrimitive.Separator.displayName

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
  SelectScrollUpButton,
  SelectScrollDownButton,
}
</file>

<file path="src/components/ui/table.tsx">
import * as React from "react"
import { cn } from "@/lib/utils"
import { AnimatePresence, HTMLMotionProps, motion } from "framer-motion"

const Table = React.forwardRef<
  HTMLTableElement,
  React.HTMLAttributes<HTMLTableElement> & { maxHeight?: string }
>(({ className, maxHeight = "100vh", ...props }, ref) => (
  <motion.div
    initial={{ opacity: 0 }}
    animate={{ opacity: 1 }}
    transition={{ duration: 0.5 }}
  >
    <div className="relative border border-gray-300 rounded-md overflow-hidden">
      <div
        className="overflow-auto scrollbar-hide thin-scrollbar"
        style={{
          maxHeight,
          scrollbarWidth: 'thin',
        }}
      >
        <table
          ref={ref}
          className={cn("w-full custom-table", className)}
          {...props}
        />
      </div>
    </div>
  </motion.div>
))
Table.displayName = "Table"

const TableHeader = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <thead
    ref={ref}
    className={cn("sticky top-0 z-10 bg-white shadow-sm", className)}
    {...props}
  />
))
TableHeader.displayName = "TableHeader"

const TableBody = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <AnimatePresence>
  <tbody
    ref={ref}
    className={cn("", className)}
    {...props}
  />
  </AnimatePresence>
))
TableBody.displayName = "TableBody"

const TableFooter = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tfoot
    ref={ref}
    className={cn(
      "border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",
      className
    )}
    {...props}
  />
))
TableFooter.displayName = "TableFooter"

type TableRowProps = HTMLMotionProps<"tr"> & React.HTMLAttributes<HTMLTableRowElement> & {
  index?: number
}

const TableRow = React.forwardRef<HTMLTableRowElement, TableRowProps>(
  ({ className, index = 0, ...props }, ref) => (
    <motion.tr
      ref={ref}
      className={cn(
        "transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",
        className
      )}
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      exit={{ opacity: 0, y: -20 }}
      transition={{ duration: 0.3, delay: index * 0.05 }}
      {...props}
    />
  )
)
TableRow.displayName = "TableRow"

const TableHead = React.forwardRef<
  HTMLTableCellElement,
  React.ThHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <th
    ref={ref}
    className={cn(
      "h-12 px-4 text-left align-middle font-medium [&:has([role=checkbox])]:pr-0",
      className
    )}
    {...props}
  />
))
TableHead.displayName = "TableHead"

const TableCell = React.forwardRef<
  HTMLTableCellElement,
  React.TdHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <td
    ref={ref}
    className={cn("p-4 align-middle [&:has([role=checkbox])]:pr-0", className)}
    {...props}
  />
))
TableCell.displayName = "TableCell"

const TableCaption = React.forwardRef<
  HTMLTableCaptionElement,
  React.HTMLAttributes<HTMLTableCaptionElement>
>(({ className, ...props }, ref) => (
  <caption
    ref={ref}
    className={cn("mt-4 text-sm text-muted-foreground", className)}
    {...props}
  />
))
TableCaption.displayName = "TableCaption"

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}
</file>

<file path="src/components/ui/tabs.tsx">
"use client"

import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils"

const Tabs = TabsPrimitive.Root

const TabsList = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",
      className
    )}
    {...props}
  />
))
TabsList.displayName = TabsPrimitive.List.displayName

const TabsTrigger = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",
      className
    )}
    {...props}
  />
))
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName

const TabsContent = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn(
      "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
      className
    )}
    {...props}
  />
))
TabsContent.displayName = TabsPrimitive.Content.displayName

export { Tabs, TabsList, TabsTrigger, TabsContent }
</file>

<file path="src/components/ui/toast.tsx">
"use client"

import * as React from "react"
import * as ToastPrimitives from "@radix-ui/react-toast"
import { cva, type VariantProps } from "class-variance-authority"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const ToastProvider = ToastPrimitives.Provider

const ToastViewport = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Viewport>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Viewport
    ref={ref}
    className={cn(
      "fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]",
      className
    )}
    {...props}
  />
))
ToastViewport.displayName = ToastPrimitives.Viewport.displayName

const toastVariants = cva(
  "group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full z-[60]",
  {
    variants: {
      variant: {
        default: "border border-green-500 bg-green-500 text-red-50", // Green success styling
        warning: "border border-yellow-400 bg-yellow-400 text-yellow-900", // Yellow warning styling
        reminder : "border border-yellow-400 bg-yellow-400 text-yellow-900",
        destructive: "border border-red-500 bg-red-500 text-red-50", // Red destructive styling
        featureUpdate:
          "border-[#FE8631] bg-[#FE8631] text-white", // Custom feature update styling
      },
    },
    defaultVariants: {
      variant: "default", // Default to success variant
    },
  }
);



const Toast = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &
  VariantProps<typeof toastVariants>
>(({ className, variant, ...props }, ref) => {
  return (
    <ToastPrimitives.Root
      ref={ref}
      className={cn(toastVariants({ variant }), className)}
      {...props}
    />
  )
})
Toast.displayName = ToastPrimitives.Root.displayName

const ToastAction = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Action>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Action
    ref={ref}
    className={cn(
      "inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive",
      className
    )}
    {...props}
  />
))
ToastAction.displayName = ToastPrimitives.Action.displayName

const ToastClose = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Close>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Close
    ref={ref}
    className={cn(
      "absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600",
      className
    )}
    toast-close=""
    {...props}
  >
    <X className="h-4 w-4" />
  </ToastPrimitives.Close>
))
ToastClose.displayName = ToastPrimitives.Close.displayName

const ToastTitle = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Title>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Title
    ref={ref}
    className={cn("text-sm font-semibold", className)}
    {...props}
  />
))
ToastTitle.displayName = ToastPrimitives.Title.displayName

const ToastDescription = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Description>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Description
    ref={ref}
    className={cn("text-sm opacity-90", className)}
    {...props}
  />
))
ToastDescription.displayName = ToastPrimitives.Description.displayName

type ToastProps = React.ComponentPropsWithoutRef<typeof Toast>

type ToastActionElement = React.ReactElement<typeof ToastAction>

export {
  type ToastProps,
  type ToastActionElement,
  ToastProvider,
  ToastViewport,
  Toast,
  ToastTitle,
  ToastDescription,
  ToastClose,
  ToastAction,
}
</file>

<file path="src/components/ui/toaster.tsx">
"use client"

import { useToast } from "@/components/hooks/use-toast"
import {
  Toast,
  ToastClose,
  ToastDescription,
  ToastProvider,
  ToastTitle,
  ToastViewport,
} from "@/components/ui/toast"
import { BellRing } from "lucide-react"
import { ReactElement } from "react"
import { HiThumbUp } from "react-icons/hi"
import { IoWarning } from "react-icons/io5"
import { MdError } from "react-icons/md"



export function Toaster() {
  const { toasts } = useToast()
  const variantIcons: Record<string, ReactElement> = {
    warning: <IoWarning size={20}/>,
    destructive: <MdError size={20}/>,
    default: <HiThumbUp size={20}/>,
    reminder : <BellRing size={20}/>
  }

  return (
    <ToastProvider>
      {toasts.map(function ({ id, title, description, action, ...props }) {
        return (
          <Toast key={id} {...props} className="rounded-3xl p-5">
            <div className="flex gap-2 items-center">
              
              <div className="grid gap-1">
                {title && <ToastTitle>{title}</ToastTitle>}
                {description && (
                  <ToastDescription className="flex items-center gap-2">{props.variant ? variantIcons[props.variant] : variantIcons['default']}{description}</ToastDescription>
                )}
              </div>
            </div>

            {action}
            <ToastClose />
          </Toast>
        )
      })}
      <ToastViewport />
    </ToastProvider>
  )
}
</file>

<file path="src/components/ui/tooltip.tsx">
"use client"

import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"

import { cn } from "@/lib/utils"

const TooltipProvider = TooltipPrimitive.Provider

const Tooltip = TooltipPrimitive.Root

const TooltipTrigger = TooltipPrimitive.Trigger

const TooltipContent = React.forwardRef<
  React.ElementRef<typeof TooltipPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <TooltipPrimitive.Content
    ref={ref}
    sideOffset={sideOffset}
    className={cn(
      "z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
      className
    )}
    {...props}
  />
))
TooltipContent.displayName = TooltipPrimitive.Content.displayName

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }
</file>

<file path="src/context/AdvanceContext.tsx">
'use client'
import React, { createContext, useContext, useState, ReactNode } from 'react';

type AdvanceContextType = {
  advanceTotal: number;
  setAdvanceTotal: React.Dispatch<React.SetStateAction<number>>;
};

const AdvanceContext = createContext<AdvanceContextType | undefined>(undefined);

export const AdvanceProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const [advanceTotal, setAdvanceTotal] = useState(0);

  return (
    <AdvanceContext.Provider value={{ advanceTotal, setAdvanceTotal }}>
      {children}
    </AdvanceContext.Provider>
  );
};

export const useAdvance = (): AdvanceContextType => {
  const context = useContext(AdvanceContext);
  if (!context) throw new Error('useAdvance must be used within AdvanceProvider');
  return context;
};
</file>

<file path="src/context/context.tsx">
import { createContext, useContext, useState } from "react";
import useSWR from "swr";
import { ITrip, IDriver, TruckModel, IParty, ISupplier, IExpense } from "@/utils/interface";

interface DashboardData {
    expenses: ExpenseData[] | [];
    trips: TripData[] | [];
    recentActivities: ITrip | IExpense | TruckModel | IDriver | ISupplier | any | {}
    profit : number
  }


  interface ExpenseData {
    _id: string;
    totalExpenses: number;
    totalAmount: number;
   
  }
  
  interface TripData {
    _id: number;
    count: number;
    month: string;
  }

const ExpenseCtx = createContext<{
    trips: ITrip[];
    drivers: IDriver[] | any[];
    shops: any[];
    trucks: TruckModel[] | any[];
    suppliers: ISupplier[] | any[];
    parties: IParty[] | any[];
    dashboardData: DashboardData;
    isLoading: boolean;
    error: any;
}>({
    trips: [],
    drivers: [],
    shops: [],
    trucks: [],
    suppliers: [],
    parties: [],
    dashboardData: {
        expenses: [],
        trips: [],
        recentActivities: {},
        profit: 0, // Add your dashboard data here
    },  // Add your dashboard data here
    isLoading: false,
    error: null,
});

export const useExpenseCtx = () => useContext(ExpenseCtx);

const fetcher = (url: string) => fetch(url).then((res) => res.json());

type Props = {
    children: React.ReactNode;
};

const config = {
    revalidateOnFocus: false,
    refreshInterval: 0, 
}

export const ExpenseProvider = ({ children }: Props) => {

    const { data: tripsData, error: tripsError, isLoading: tripsLoading } = useSWR("/api/trips", fetcher, config);
    const { data: driversData, error: driversError, isLoading: driversLoading } = useSWR("/api/drivers", fetcher, config);
    const { data: trucksData, error: trucksError, isLoading: trucksLoading } = useSWR("/api/trucks", fetcher, config);
    const { data: shopsData, error: shopsError, isLoading: shopsLoading } = useSWR("/api/shopkhata", fetcher, config);
    const { data: partiesData, error: partiesError, isLoading: partiesLoading } = useSWR("/api/parties", fetcher, config);
    const { data: suppliersData, error: suppliersError, isLoading: suppliersLoading } = useSWR("/api/suppliers", fetcher, config);
    const { data: dashData, error: dashError, isLoading: dashLoading } = useSWR('/api/dashboard', fetcher, config);
    

    const isLoading = tripsLoading || driversLoading || trucksLoading || shopsLoading || partiesLoading || suppliersLoading || dashLoading;
    const error = tripsError || driversError || trucksError || shopsError || partiesError || suppliersError || dashError;

    const trips = tripsData?.trips || [];
    const drivers = driversData?.drivers || [];
    const trucks = trucksData?.trucks || [];
    const shops = shopsData?.shops || [];
    const parties = partiesData?.parties || [];
    const suppliers = suppliersData?.suppliers || [];
    const dashboardData = dashData || {};

    return (
        <ExpenseCtx.Provider
            value={{
                trips,
                drivers,
                shops,
                trucks,
                parties,
                suppliers,
                dashboardData,
                isLoading,
                error,
            }}
        >
            {children}
        </ExpenseCtx.Provider>
    );
};
</file>

<file path="src/context/driverContext.tsx">
import React, { createContext, useContext, useEffect, useState } from 'react';

const DriverContext = createContext<any>(null);

export const useDriver = () => useContext(DriverContext);

export const DriverProvider: React.FC<{ driverId: string; children: React.ReactNode }> = ({ driverId, children }) => {
  const [driver, setDriver] = useState<any>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Fetch driver data
    async function fetchDriver() {
      try {
        const response = await fetch(`/api/drivers/${driverId}`);
        const data = await response.json();
        setDriver(data.driver);
      } catch (error) {
        console.error('Error fetching driver:', error);
      } finally {
        setLoading(false);
      }
    }

    fetchDriver();
  }, [driverId]);

  return (
    <DriverContext.Provider value={{ driver, setDriver, loading }}>
      {children}
    </DriverContext.Provider>
  );
};
</file>

<file path="src/context/expenseContext.tsx">
'use client';
import { IExpense } from '@/utils/interface';
import React, { createContext, useContext, useEffect, useState } from 'react';

const ExpenseContext = createContext<any>(null);

export const useExpense = () => useContext(ExpenseContext);

export const ExpenseProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [sum, setSum] = useState<any>(null);
  const [allExpense, setAllExpense] = useState<IExpense[]>([]);
  const [truckExpense, setTruckExpense] = useState<IExpense[]>([]);
  const [tripExpense, setTripExpense] = useState<IExpense[]>([]);
  const [officeExpense, setOfficeExpense] = useState<IExpense[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Check if data already exists in state
    const isDataLoaded =
      allExpense.length > 0 &&
      truckExpense.length > 0 &&
      tripExpense.length > 0 &&
      officeExpense.length > 0 &&
      sum !== null;

    if (isDataLoaded) {
      // If data is already present, don't fetch
      setLoading(false);
      return;
    }

    // Fetch expenses data if not already present
    async function fetchExpense() {
      try {
        const [allRes, truckRes, tripRes, officeRes, summaryRes] = await Promise.all([
          fetch(`/api/expenses`),
          fetch(`/api/expenses/truckExpense`),
          fetch(`/api/expenses/tripExpense`),
          fetch(`/api/expenses/officeExpense`),
          fetch(`/api/expenses/calculate`),
        ]);

        if (!allRes.ok || !truckRes.ok || !tripRes.ok || !officeRes.ok) return;

        const [allData, truckData, tripData, officeData, summaryData] = await Promise.all([
          allRes.json(),
          truckRes.json(),
          tripRes.json(),
          officeRes.json(),
          summaryRes.json(),
        ]);

        // Set data to state
        setAllExpense(allData.expenses);
        setTruckExpense(truckData.truckExpense);
        setTripExpense(tripData.tripExpense);
        setOfficeExpense(officeData.expenses);
        setSum(summaryData.expenses);
      } catch (error) {
        console.error('Error fetching expenses:', error);
      } finally {
        setLoading(false);
      }
    }

    fetchExpense();
  }, [allExpense, truckExpense, tripExpense, officeExpense, sum]);

  return (
    <ExpenseContext.Provider
      value={{
        allExpense,
        setAllExpense,
        truckExpense,
        setTruckExpense,
        tripExpense,
        setTripExpense,
        officeExpense,
        setOfficeExpense,
        sum,
        setSum,
        loading,
      }}
    >
      {children}
    </ExpenseContext.Provider>
  );
};
</file>

<file path="src/context/partyContext.tsx">
import React, { createContext, useContext, useEffect, useState } from 'react';

const PartyContext = createContext<any>(null);

export const useParty = () => useContext(PartyContext);

export const PartyProvider: React.FC<{ partyId: string; children: React.ReactNode }> = ({ partyId, children }) => {
  const [party, setParty] = useState<any>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Fetch party data
    async function fetchParty() {
      try {
        const response = await fetch(`/api/parties/${partyId}`);
        const data = await response.json();
        setParty(data.party);
      } catch (error) {
        console.error('Error fetching party:', error);
      } finally {
        setLoading(false);
      }
    }

    fetchParty();
  }, [partyId]);

  return (
    <PartyContext.Provider value={{ party, setParty, loading }}>
      {children}
    </PartyContext.Provider>
  );
};
</file>

<file path="src/context/recentDocs.tsx">
import { createContext, useContext } from "react";
import useSWR from "swr";

// Define the RecentDocsCtx context
const RecentDocsCtx = createContext<{
    documents: any[],
    counts: {
        tripDocuments: number,
        driverDocuments: number,
        truckDocuments: number,
        companyDocuments: 0,
        otherDocuments: 0,
    },
    error: any,
    docsLoading: boolean
}>({
    documents: [],
    counts: {
        tripDocuments: 0,
        driverDocuments: 0,
        truckDocuments: 0,
        companyDocuments: 0,
        otherDocuments: 0,
    },
    docsLoading: false,
    error: null,
});

// Hook to use the RecentDocsCtx
export const useRecentDocsCtx = () => useContext(RecentDocsCtx);

// Fetcher function for SWR
const fetcher = (url: string) => fetch(url).then((res) => res.json());

// Type definition for props
type Props = {
    children: React.ReactNode;
};

// RecentDocumentsProvider component to provide the context
export const RecentDocumentsProvider = ({ children }: Props) => {
    const { data, error, isLoading } = useSWR("/api/documents/recent", fetcher);

    // Handle case where data is still loading or unavailable
    const documents = data?.documents || [];
    const counts = data?.counts || {
        tripDocuments: 0,
        driverDocuments: 0,
        truckDocuments: 0,
        companyDocuments : 0,
        otherDocuments: 0,
    };

    return (
        <RecentDocsCtx.Provider
            value={{
                documents,
                counts,
                docsLoading: isLoading,
                error,
            }}
        >
            {children}
        </RecentDocsCtx.Provider>
    );
};
</file>

<file path="src/context/reminderContext.tsx">
import { useToast } from '@/components/hooks/use-toast';
import { useRouter } from 'next/navigation';
import React, { createContext, useContext, useEffect, useState } from 'react';
import Cookies from 'js-cookie';

const ReminderContext = createContext<any>(null);

export const useReminder = () => useContext(ReminderContext);

export const ReminderProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [reminders, setReminders] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const { toast } = useToast();
  const router = useRouter()

  useEffect(() => {
    let intervalId: NodeJS.Timeout;

    // Function to fetch reminders
    async function fetchReminders() {
      try {
        const response = await fetch(`/api/documents/reminders`);
        const data = await response.json();

        if (response.status === 401 || data.status === 401) {
          toast({
            description: 'Session Expired, Please log in again.',
            variant: 'warning',
          })
          await fetch('/api/logout')
          router.push('/login')
          return
        }

        // Check if the new data is different from the current data
        if ((JSON.stringify(data) !== JSON.stringify(reminders) && data?.tripReminders?.length + data?.truckReminders?.length + data?.driverReminders?.length > 0)) {
          setReminders(data);

          // Show toast notification for new reminders
          toast({
            description: 'Please check your reminders',
            variant: 'reminder',
          });
        }
      } catch (error) {
        console.error('Error fetching reminders:', error);
      } finally {
        setLoading(false);
      }
    }

    // Fetch reminders immediately and set interval
    fetchReminders();
    intervalId = setInterval(fetchReminders, 4 * 60 * 60 * 1000); // 8 hours = 8 * 60 * 60 * 1000 ms

    // Cleanup interval on unmount
    return () => clearInterval(intervalId);
  }, [reminders, toast]);

  return (
    <ReminderContext.Provider value={{ reminders, setReminders, loading }}>
      {children}
    </ReminderContext.Provider>
  );
};
</file>

<file path="src/context/supplierContext.tsx">
import React, { createContext, useContext, useEffect, useState } from 'react';

const SupplierContext = createContext<any>(null);

export const useSupplier = () => useContext(SupplierContext);

export const SupplierProvider: React.FC<{ supplierId: string; children: React.ReactNode }> = ({ supplierId, children }) => {
  const [supplier, setSupplier] = useState<any>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Fetch supplier data
    async function fetchSupplier() {
      try {
        const response = await fetch(`/api/suppliers/${supplierId}`);
        const data = await response.json();
        setSupplier(data.supplier);
      } catch (error) {
        console.error('Error fetching supplier:', error);
      } finally {
        setLoading(false);
      }
    }

    fetchSupplier();
  }, [supplierId]);

  return (
    <SupplierContext.Provider value={{ supplier, setSupplier, loading }}>
      {children}
    </SupplierContext.Provider>
  );
};
</file>

<file path="src/context/tripContext.tsx">
import React, { createContext, useContext, useEffect, useState } from 'react';

const TripContext = createContext<any>(null);

export const useTrip = () => useContext(TripContext);

export const TripProvider: React.FC<{ tripId: string; children: React.ReactNode }> = ({ tripId, children }) => {
  const [trip, setTrip] = useState<any>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Fetch trip data
    async function fetchTrip() {
      try {
        const response = await fetch(`/api/trips/${tripId}`);
        const data = await response.json();
        setTrip(data.trip);
      } catch (error) {
        console.error('Error fetching trip:', error);
      } finally {
        setLoading(false);
      }
    }

    fetchTrip();
  }, [tripId]);

  return (
    <TripContext.Provider value={{ trip, setTrip, loading }}>
      {children}
    </TripContext.Provider>
  );
};
</file>

<file path="src/context/truckContext.tsx">
import React, { createContext, useContext, useEffect, useState } from 'react';

const TruckContext = createContext<any>(null);

export const useTruck = () => useContext(TruckContext);

export const TruckProvider: React.FC<{ truckNo: string; children: React.ReactNode }> = ({ truckNo, children }) => {
  const [truck, setTruck] = useState<any>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Fetch truck data
    async function fetchTruck() {
      try {
        const response = await fetch(`/api/trucks/${truckNo}`);
        const data = await response.json();
        setTruck(data.truck);
      } catch (error) {
        console.error('Error fetching truck:', error);
      } finally {
        setLoading(false);
      }
    }

    fetchTruck();
  }, [truckNo]);

  return (
    <TruckContext.Provider value={{ truck, setTruck, loading }}>
      {children}
    </TruckContext.Provider>
  );
};
</file>

<file path="src/firebase/firbaseConfig.ts">
// Import the functions you need from the SDKs you need
import { getApp, getApps, initializeApp } from "firebase/app";
import { getAuth } from "firebase/auth";

const firebaseConfig = {
  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,
  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,
  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID,
  measurementId: process.env.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID,
};

// Initialize Firebase

const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApp();
const auth = getAuth(app);
auth.useDeviceLanguage();

export { auth };
</file>

<file path="src/helpers/DeleteAccount.ts">
import { PaymentBook } from "@/utils/interface";

export const handleDeleteItem = async (tripId : string, item: PaymentBook) => {
    try {
      const res = await fetch(`/api/trips/${tripId}/accounts/${item._id}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ data: { account: item, delete: true } }),
      });
      if (!res.ok) {
        throw new Error('Failed to delete item');
      }
      const resData = await res.json();
      return resData.trip.accounts;
    } catch (error) {
      console.log(error);
    }
  };
</file>

<file path="src/helpers/driverOperations.ts">
export const fetchDriverName = async (driver: string) => {
    try {
        const response = await fetch(`/api/drivers/${driver}/name`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        });

        if (!response.ok) {
            return 'NA'
        }

        const result = await response.json();
        return result.name
    } catch (err: any) {
        return {error : err}
    }
};

export const deleteDriverAccount = async (driverId: string, accountId: string) => {
    try {
        const response = await fetch(`/api/drivers/${driverId}/accounts/${accountId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
            },
        });
        const data = await response.json();
        return data
    } catch (error) {
        console.log(error);
        return error
    }

}

export const EditDriverAccount = async (driverId : string, account : any, id : string) => {
    try {
      const response = await fetch(`/api/drivers/${driverId}/accounts/${id}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            gave : account.gave,
            got : account.got,
          reason : account.reason,
          date : account.date,
        }),
      });

      if (!response.ok) {
        throw new Error('Failed to update driver');
      }

      const data = await response.json();
      return data.driver.accounts.filter((acc : any)=>acc.account_id == id)[0]

    } catch (error: any) {
      console.error('Failed to update driver:', error);
      return error
    }
  };
</file>

<file path="src/helpers/ExpenseOperation.ts">
import { IExpense } from "@/utils/interface";


export const handleAddExpense = async (expense: IExpense, file?: File | null, toast? : any) => {
  try {
    const formdata = new FormData()
    formdata.append('expense', JSON.stringify(expense))
    if (file) formdata.append('file', file)
    const res = await fetch('/api/expenses', {
      method: 'POST',
      body: formdata
    })
    if (!res.ok) {
      toast && toast({
        description: `error adding expense`,
        variant: 'destructive'
    });
    }
    const data = await res.json()
    toast({
      description : "Expense added successfully"
    })
    return data.expense
  } catch (error: any) {
    toast && toast({
      description: `Failed to add expense`,
      variant: 'destructive'
  });
  }
}

export const handleEditExpense = async (expense: IExpense, id: string, file?: File | null, toast? : any) => {
  try {
    const formdata = new FormData()
    formdata.append('expense', JSON.stringify(expense))
    if (file) formdata.append('file', file)
    const res = await fetch(`/api/expenses/${id}`, {
      method: 'PUT',
      body: formdata
    })
    if (!res.ok) {
      throw new Error("Failed to add Expense")
    }
    const data = await res.json()
    // toast({
    //   description : "Expense edited successfully"
    // })
    return data.expense
  } catch (error: any) {
    return error
  }
}

export const DeleteExpense = async (id: string) => {
  try {
    const res = await fetch(`/api/expenses/${id}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      },
    });
    if (!res.ok) {
      alert('Failed to delete expense');
      return;
    }
    const data = await res.json()
    return data.expense
  } catch (error: any) {
    alert(error.message)
    console.log(error)
  }
}

export const handleDelete = async (id: string, e?: React.MouseEvent) => {
  e?.stopPropagation(); // Prevent the row's click event from being triggered
  const res = await fetch(`/api/expenses/${id}`, {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json',
    },
  });
  if (!res.ok) {
    alert('Failed to delete expense');
    return;
  }
  const data = await res.json()
  return data
};

export const handleAddCharge = async (newCharge: any, id?: string, truckNo?: string) => {
  const truckExpenseData = {
    ...newCharge,
    truck: truckNo,
    transaction_id: newCharge.transactionId || '',
    driver: newCharge.paymentMode == 'Paid By Driver' ? newCharge.driver : '',
    notes: newCharge.notes || '',
  };

  const method = id ? 'PUT' : 'POST';
  const url = id ? `/api/expenses/${id}` : `/api/trucks/${truckNo}/expense`;

  const res = await fetch(url, {
    method: method,
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(truckExpenseData),
  });

  if (!res.ok) {
    alert('Failed to add charge');
    return;
  }

  const data = await res.json();
  return data
};

export const ExpenseforDriver = async (driver: string) => {
  try {
    const res = await fetch(`/api/drivers/${driver}/expense`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    const data = await res.json()
    return data.driverExpenses
  } catch (err) {
    alert(err)
    console.log(err)
  }

}

export const fetchTruckExpense = async (month: any, year: any) => {
  try {
    let res
    if (month === null || year === null) {
      res = await fetch(`/api/expenses/truckExpense`)
    } else {
      res = await fetch(`/api/expenses/truckExpense?month=${month}&year=${year}`);
    }

    if (!res.ok) {
      throw new Error('Failed to fetch truck expenses');
    }
    const data = await res.json();
    return data.truckExpense;
  } catch (error) {
    console.error('Error fetching truck expenses:', error);
    return [];
  }
};

export const fetchTripExpense = async () => {
  try {
    const res = await fetch(`/api/expenses/tripExpense`)
    if (!res.ok) {
      throw new Error('Failed to fetch truck expenses');
    }
    const data = await res.json();
    return data.tripExpense;
  } catch (error) {
    console.error('Error fetching trip expenses:', error);
    return [];
  }
};
</file>

<file path="src/helpers/fetchPartyName.ts">
export const fetchPartyName = async (party : string) => {
    try {
      const partyRes = await fetch(`/api/parties/${party}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      });
      if (!partyRes.ok) {
        return ''
      }
      const partyData = await partyRes.json();
      return partyData.party.name
    } catch (error) {
      console.log('Error fetching party name:', error);
      return ''
    }
  };
</file>

<file path="src/helpers/fetchTripBalance.ts">
import { ITrip, TripExpense } from "@/utils/interface";


  export const fetchBalanceBack = async(trip : ITrip, charges : TripExpense[])=>{
    const accountBalance = trip.accounts.reduce((total, account) => total + account.amount, 0);
      let chargeToBill = 0
      let chargeNotToBill = 0
      if (charges){
        chargeToBill = charges.filter(charge => charge.partyBill).reduce((total, charge) => total + charge.amount, 0);
        chargeNotToBill = charges.filter(charge =>!charge.partyBill).reduce((total, charge) => total + charge.amount, 0);
      }
      const pending = trip.amount - accountBalance - chargeNotToBill + chargeToBill
      return pending
}
</file>

<file path="src/helpers/fileOperation.ts">
import { S3Client, PutObjectCommand, DeleteObjectCommand } from "@aws-sdk/client-s3";
import pdf from 'pdf-parse-new';
import sharp from 'sharp'
import tesseract from 'node-tesseract-ocr';
import { PDFDocument } from 'pdf-lib';

const s3Client = new S3Client({
    region: process.env.AWS_S3_REGION,
    credentials: {
        accessKeyId: process.env.AWS_S3_ACCESS_KEY_ID!,
        secretAccessKey: process.env.AWS_S3_SECRET_ACCESS_KEY!,
    },
});
 // Assume S3 client is initialized

// Function to compress PDF files
async function compressPDF(pdfBuffer: Buffer): Promise<Buffer> {
    const pdfDoc = await PDFDocument.load(pdfBuffer as any);

    // Compress PDF by removing object streams, or you can apply other optimizations here
    const optimizedPdfBuffer = await pdfDoc.save({
        useObjectStreams: false, // This can slightly reduce the size
    });

    return Buffer.from(optimizedPdfBuffer);
}

// Function to handle image or PDF compression and upload to S3
export async function uploadFileToS3(
    fileBuffer: Buffer,
    fileName: string,
    contentType: string
): Promise<string> {
    let optimizedBuffer = fileBuffer;

    // Compress image if the content type is image
    if (contentType.startsWith('image/')) {
        optimizedBuffer = await sharp(fileBuffer)
            .resize({
                width: 1200, // Resize image to a maximum width of 1200px (optional)
                fit: sharp.fit.inside, // Maintain aspect ratio
            })
            .toBuffer();
    }

    // Compress PDF if the content type is a PDF
    if (contentType === 'application/pdf') {
        optimizedBuffer = await compressPDF(fileBuffer);
    }

    const params = {
        Bucket: process.env.AWS_S3_BUCKET_NAME!,
        Key: fileName,
        Body: optimizedBuffer,
        ContentType: contentType,
    };

    const command = new PutObjectCommand(params);
    await s3Client.send(command);

    return fileName;
}

export const deleteFileFromS3 = async (fileUrl: string) => {
    try {
      const bucketName = process.env.AWS_S3_BUCKET_NAME!;
      
      // Extract file key from URL
      const fileKey = fileUrl.split(`https://${bucketName}.s3.${process.env.AWS_S3_REGION}.amazonaws.com/`)[1];
      
      if (!fileKey) {
        throw new Error("Invalid S3 file URL");
      }
  
      const command = new DeleteObjectCommand({
        Bucket: bucketName,
        Key: fileKey,
      });
  
      await s3Client.send(command);
      console.log(`File deleted successfully: ${fileKey}`);
    } catch (error) {
      console.error("Error deleting file from S3:", error);
      throw new Error("Failed to delete file from S3");
    }
  };


export async function extractValidityDate(text: string): Promise<Date | null> {
    const regex = /(?:valid|vahd)?\s*upto\s*[:\-]?\s*(\d{2})\/(\d{2})\/(\d{4})/i

    const match = text.match(regex);

    if (match) {
        const [_, day, month, year] = match;
        return new Date(`${year}-${month}-${day}`);
    }

    return null;
}

// Function to extract text from a PDF using pdf-parse
export async function extractTextFromPdf(buffer: Buffer): Promise<string> {
    try {
        const data = await pdf(buffer);
        return data.text;
    } catch (error) {
        console.error("Error extracting text from PDF:", error);
        throw new Error("Failed to extract text from PDF");
    }
}

async function preprocessImage(buffer: Buffer): Promise<Buffer> {
    const preprocessedBuffer = await sharp(buffer)
        .resize({ width: 1500 })  // Resize for better OCR accuracy
        .grayscale()  // Convert to grayscale
        .normalize()  // Normalize to enhance contrast
        .sharpen({
            sigma: 1,  // Controls the amount of blur applied before calculating the difference (higher values mean less sharpening)
            m1: 1,     // Controls the level of sharpening (mid-tone)
            m2: 0.5,   // Controls the level of sharpening (shadow area)
            x1: 2,     // Threshold below which the pixels are left unchanged
            y2: 10,    // Controls the range of sharpening applied (upper bound for adjustment)
            y3: 2      // Controls the range of sharpening applied (lower bound for adjustment)
        })
        .median(3)  // Apply median filter to reduce noise
        .threshold(180)  // Binarize the image
        .removeAlpha()  // Remove alpha channel if present
        .toBuffer();

    return preprocessedBuffer;
}

// Function to extract text from an image using node-tesseract-ocr
export async function extractTextFromImage(buffer: Buffer): Promise<string> {
    const preprocessedBuffer = await preprocessImage(buffer);
    const text = await tesseract.recognize(preprocessedBuffer, {
        lang: "eng",
        psm: 3,  // Try different PSM values
        oem: 3,  // Use the best OCR Engine mode
        tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789/:', // Whitelist for known characters
    });
    return text;
}
</file>

<file path="src/helpers/ImageOperation.ts">
export function getDocType(text: string): string {
    const docTypes = [
        { keywords: ['National Permit Authorization Number', 'AUTHORIZATION CERTIFICATE OF N.P.'], type: 'Permit' },
        { keywords: ['CERTIFICATE OF REGISTRATION', 'Form 23A'], type: 'Registration Certificate' },
        { keywords: ['INSURANCE COMPANY', 'Period of Insurance'], type: 'Insurance' },
        { keywords: ['TAX RECEIPT', 'Transport Department'], type: 'Tax Receipt' },
        { keywords: ['E-Way Bill', 'EWB'], type: 'E-Way Bill' },
        { keywords: ['Bilty'], type: 'Bilty' },
        { keywords: ['Proof of Delivery', 'POD'], type: 'POD' },
        { keywords: ['Expense Receipt', 'Receipt'], type: 'Expense Receipt' },
        { keywords: ['PAN', 'Permanent Account Number'], type: 'PAN' },
        { keywords: ['Police Verification'], type: 'Police Verification' },
        { keywords: ['Aadhar', 'Aadhaar', 'Unique Identification Number'], type: 'Aadhar Card' },
        { keywords: ['License', 'Driving License','DLNo.'], type: 'License' },
        { keywords: ['Pollution Certificate', 'Pollution Under Control'], type: 'Pollution Certificate' },
        { keywords: ['fitness', 'Fitness','Certificate of Fitness'], type : 'Fitness Certificate'}
    ];

    // Normalize text to lowercase for case-insensitive matching
    const lowerCaseText = text.toLowerCase();

    for (const doc of docTypes) {
        // Check if any of the keywords are present in the text (flexible matching)
        if (doc.keywords.some(keyword => lowerCaseText.includes(keyword.toLowerCase()))) {
            return doc.type;
        }
    }

    return 'Other';
}


export const extractLatestDate = (text: string) => {
    // Regular expression to match dates in formats: dd/MM/yyyy, dd-MM-yyyy, dd-MMM-yyyy
    const dateRegex = /\b\d{2}[\/-]\w{3,}[\/-]\d{2,4}\b|\b\d{2}[\/-]\d{2}[\/-]\d{2,4}\b/g;

    let latestDate: Date | null = null;

    // Find all matches
    const matches = text.match(dateRegex);

    if (!matches) return null;

    matches.forEach(dateStr => {
        let parsedDate = null;

        try {
            // Handle date parsing based on format
            if (dateStr.includes('/')) {
                parsedDate = parseDate(dateStr, 'dd/MM/yyyy');
            } else if (dateStr.includes('-')) {
                if (dateStr.split('-')[1].length === 3) {
                    parsedDate = parseDate(dateStr, 'dd-MMM-yyyy');
                } else {
                    parsedDate = parseDate(dateStr, 'dd-MM-yyyy');
                }
            }

            // Update latestDate if parsedDate is more recent
            if (parsedDate && (!latestDate || parsedDate > latestDate)) {
                latestDate = parsedDate;
            }
        } catch (e) {
            console.error(`Error parsing date: ${dateStr}`, e);
        }
    });

    return latestDate ? latestDate : null;
};

// Helper function to parse date according to format
export const parseDate = (dateStr: string, format: string) => {
    const parts = dateStr.split(/[\/-]/);
    let day, month, year;

    switch (format) {
        case 'dd/MM/yyyy':
        case 'dd-MM-yyyy':
            day = parseInt(parts[0], 10);
            month = parseInt(parts[1], 10) - 1; // Month is zero-indexed in JS Date
            year = parseInt(parts[2], 10);
            break;
        case 'dd-MMM-yyyy':
            day = parseInt(parts[0], 10);
            month = parseMonth(parts[1]); // Custom month parsing function for short month names
            year = parseInt(parts[2], 10);
            break;
        default:
            return null;
    }

    // Adjust for 2-digit years
    if (year < 100) {
        year += year < 50 ? 2000 : 1900;
    }

    return new Date(year, month, day);
};

// Helper function to parse month from "MMM" format (e.g., "Jan", "Feb")
export const parseMonth = (monthStr: string) => {
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return months.indexOf(monthStr);
};
</file>

<file path="src/helpers/modifyInvoice.ts">
import { tripSchema, InvoiceSchema } from "@/utils/schema";
import { models, model } from "mongoose";

export async function AddtoInvoice(tripId: string, userId: string, amount: number) {

    const Trip = models.Trip || model('Trip', tripSchema)
    const Invoice = models.Invoice || model('Invoice', InvoiceSchema)

    try {
        // Validate inputs

        // console.log(tripId, amount, userId)
        // console.log(typeof(amount))

        if (!tripId || !userId || typeof amount !== "number") {
            throw new Error("Invalid input parameters");
        }

        // Find the trip
        const trip = await Trip.findOne({ user_id: userId, trip_id: tripId });
        if (!trip) {
            throw new Error("Trip not found");
        }

        // If the trip already has an invoice_id, update the existing invoice
        if (trip.invoice_id) {
            const invoice = await Invoice.findByIdAndUpdate(
                trip.invoice_id,
                {
                    $inc: { advance: amount, balance: -amount }, // Use $inc to increment/decrement
                },
                { new: true } // Return the updated document
            );

            if (!invoice) {
                throw new Error("Invoice not found");
            }
        }
    } catch (error) {
        console.error("Error in AddtoInvoice:", error);
        // Re-throw the error for the caller to handle
    }
}
</file>

<file path="src/helpers/recentActivity.ts">
import { RecentActivitiesSchema } from '@/utils/schema';
import {models, model} from 'mongoose'

const RecentActivities = models.RecentActivities || model('RecentActivities', RecentActivitiesSchema);
export async function recentActivity(type : string, activity : any, user : string){
    delete activity['user_id']
    let recentActivity = await RecentActivities.findOne({user_id : user})
        if (!recentActivity){
            recentActivity = new RecentActivities({
                user_id : user,
                activities : [{
                    type : type,
                    data : activity,
                    date : new Date(Date.now())
                }]
            })
        }else{
            if(recentActivity.activities.length == 4){
                recentActivity.activities.pop()
            }
            recentActivity.activities.unshift({
                type : type,
                data : activity,
                date : new Date(Date.now())
            })
        }
        await recentActivity.save()
}
</file>

<file path="src/helpers/removebg.ts">
export function removeBackgroundFromImage(
  imageElement: HTMLImageElement,
  canvasElement: HTMLCanvasElement,
  options = {
    localWindowSize: 15,          // Size of local analysis window
    sensitivityThreshold: 0.15,   // Threshold for considering pixels as foreground
    contrastBoost: 1.3,          // Contrast enhancement factor
    denoiseLevel: 2,             // Level of noise reduction
    inkSpreadCompensation: 1.2,   // Compensation for ink spread
    adaptiveThresholdOffset: 10,  // Offset for adaptive thresholding
    edgeRefinementPasses: 2       // Number of edge refinement passes
  }
) {
  const ctx = canvasElement.getContext('2d');
  if (!ctx) return;

  // Set canvas size to match the image
  canvasElement.width = imageElement.width;
  canvasElement.height = imageElement.height;

  // Draw the image on the canvas
  ctx.drawImage(imageElement, 0, 0);

  // Get image data
  const imageData = ctx.getImageData(0, 0, canvasElement.width, canvasElement.height);
  const data = imageData.data;
  const width = canvasElement.width;
  const height = canvasElement.height;

  // Create arrays for processing
  const luminance = new Float32Array(width * height);
  const background = new Float32Array(width * height);
  const mask = new Uint8ClampedArray(width * height);

  // Step 1: Convert to luminance with ink spread compensation
  for (let i = 0; i < data.length; i += 4) {
    const r = data[i];
    const g = data[i + 1];
    const b = data[i + 2];
    // Enhanced luminance conversion for signature detection
    const lum = Math.pow(1 - (0.299 * r + 0.587 * g + 0.114 * b) / 255, options.inkSpreadCompensation);
    luminance[i / 4] = lum;
  }

  // Step 2: Estimate local background intensity
  estimateBackground(luminance, background, width, height, options.localWindowSize);

  // Step 3: Apply adaptive thresholding with local contrast analysis
  applyAdaptiveThreshold(
    luminance,
    background,
    mask,
    width,
    height,
    options.sensitivityThreshold,
    options.adaptiveThresholdOffset
  );

  // Step 4: Refine edges and remove noise
  refineEdges(mask, luminance, width, height, options.edgeRefinementPasses);

  // Step 5: Apply the mask to the original image
  applyProcessedMask(data, mask, width, height, options.contrastBoost);

  // Put the processed image data back
  ctx.putImageData(imageData, 0, 0);
  return canvasElement.toDataURL();
}

// Estimate background intensity using local windows
function estimateBackground(
  luminance: Float32Array,
  background: Float32Array,
  width: number,
  height: number,
  windowSize: number
): void {
  const halfWindow = Math.floor(windowSize / 2);

  for (let y = 0; y < height; y++) {
    for (let x = 0; x < width; x++) {
      let sum = 0;
      let count = 0;
      let max = -Infinity;
      let min = Infinity;

      // Analyze local window
      for (let dy = -halfWindow; dy <= halfWindow; dy++) {
        for (let dx = -halfWindow; dx <= halfWindow; dx++) {
          const nx = x + dx;
          const ny = y + dy;

          if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
            const value = luminance[ny * width + nx];
            sum += value;
            count++;
            max = Math.max(max, value);
            min = Math.min(min, value);
          }
        }
      }

      // Calculate local statistics
      const mean = sum / count;
      const range = max - min;
      
      // Use weighted combination of mean and max for background estimation
      background[y * width + x] = range < 0.1 ? mean : (mean * 0.7 + max * 0.3);
    }
  }
}

// Apply adaptive thresholding with local contrast analysis
function applyAdaptiveThreshold(
  luminance: Float32Array,
  background: Float32Array,
  mask: Uint8ClampedArray,
  width: number,
  height: number,
  sensitivityThreshold: number,
  offset: number
): void {
  for (let y = 0; y < height; y++) {
    for (let x = 0; x < width; x++) {
      const idx = y * width + x;
      const localContrast = calculateLocalContrast(luminance, width, height, x, y, 3);
      
      // Adaptive threshold based on local contrast and background
      const threshold = background[idx] + 
        (offset / 255) * (1 + localContrast) +
        sensitivityThreshold * (1 - background[idx]);

      mask[idx] = luminance[idx] > threshold ? 255 : 0;
    }
  }
}

// Calculate local contrast in a small window
function calculateLocalContrast(
  luminance: Float32Array,
  width: number,
  height: number,
  x: number,
  y: number,
  radius: number
): number {
  let min = Infinity;
  let max = -Infinity;

  for (let dy = -radius; dy <= radius; dy++) {
    for (let dx = -radius; dx <= radius; dx++) {
      const nx = x + dx;
      const ny = y + dy;

      if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
        const value = luminance[ny * width + nx];
        min = Math.min(min, value);
        max = Math.max(max, value);
      }
    }
  }

  return max - min;
}

// Refine edges using morphological operations and connectivity analysis
function refineEdges(
  mask: Uint8ClampedArray,
  luminance: Float32Array,
  width: number,
  height: number,
  passes: number
): void {
  const temp = new Uint8ClampedArray(mask.length);
  
  for (let pass = 0; pass < passes; pass++) {
    // Copy current mask
    temp.set(mask);

    for (let y = 1; y < height - 1; y++) {
      for (let x = 1; x < width - 1; x++) {
        const idx = y * width + x;
        let connectedComponents = 0;

        // Check 8-connectivity
        for (let dy = -1; dy <= 1; dy++) {
          for (let dx = -1; dx <= 1; dx++) {
            if (dx === 0 && dy === 0) continue;
            const nidx = (y + dy) * width + (x + dx);
            if (mask[nidx] > 127) connectedComponents++;
          }
        }

        // Analyze local structure
        const isEdge = connectedComponents > 0 && connectedComponents < 7;
        const lumGradient = calculateLocalContrast(luminance, width, height, x, y, 1);

        // Refine edge pixels based on local structure and gradient
        if (isEdge) {
          temp[idx] = lumGradient > 0.1 ? 255 : 0;
        }
      }
    }

    // Update mask
    mask.set(temp);
  }
}

// Apply the processed mask to the image data
function applyProcessedMask(
  data: Uint8ClampedArray,
  mask: Uint8ClampedArray,
  width: number,
  height: number,
  contrastBoost: number
): void {
  for (let i = 0; i < mask.length; i++) {
    const idx = i * 4;
    const isForeground = mask[i] > 127;

    if (!isForeground) {
      // Make background transparent
      data[idx + 3] = 0;
    } else {
      // Enhance foreground
      for (let c = 0; c < 3; c++) {
        data[idx + c] = Math.min(255, Math.round(data[idx + c] * contrastBoost));
      }
      // Ensure foreground is fully opaque
      data[idx + 3] = 255;
    }
  }
}
</file>

<file path="src/helpers/SupplierOperation.ts">
export const supplierTripCount = async (supplierId: string) => {
    try {
        const res = await fetch(`/api/suppliers/${supplierId}/tripCount`)
        if (!res.ok) {
            alert('Failed to Count Trips')
            return 0
        }
        const data = await res.json()
        return data.tripCount
    } catch (error) {
        alert(error)
        return 0
    }
}
</file>

<file path="src/helpers/TripOperation.ts">
export const DeleteAccount = async (accountId: string, tripId: string, partyId : string) => {
  try {
    const res = await fetch(`/api/parties/${partyId}/payments/${accountId}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      }
    })
    const data = await res.json()
    return data.payment
  } catch (error) {
    console.log(error)
    return error
  }

}

export const fetchTripRoute = async (tripId: string) => {
  if (tripId != '') {
    const tripRes = await fetch(`/api/trips/${tripId}`);
    const data = await tripRes.json();
    const trip = data.trip;
    return trip.route;
  }
}

export const handleEditAccount = async (editedItem: any, tripId: string, partyId : string) => {
  try {
    const res = await fetch(`/api/parties/${tripId}/payments/${editedItem.id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(editedItem),
    });
    if (!res.ok) {
      throw new Error('Failed to edit item');
    }

    const resData = await res.json();
    if (resData.status == 400) {
      alert(resData.message);
      return;
    }
    return resData.payment
  } catch (error) {
    console.log(error);
    return { error: error }
  }
};


export async function extractEWayBillDetails(text: string) {
  const prompt = `
  This is extracted text from pdf extract these details from it i.e origin, destination, freight amount (total invoice amount), start date(the generation date of the document), truckNo, validity date. Give all this in JSON format

  Extracted Text:
  ${text}

  Response format :
  {
      startDate : '',
      origin : '',
      destination : '',
      validity : '',
      truckNo : '',
  }
`;

  // Send the prompt and extracted text to the Gemini API
  const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${process.env.GEMINI_API_KEY}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      "contents": [{
        "parts": [{
          "text": prompt
        }]
      }]
    })
  });
  const responseData = await res.json();
  let responseText = responseData.candidates[0].content.parts[0].text;

  // Remove extraneous characters (e.g., triple backticks, other non-JSON text)
  // console.log(responseText.split('```')[1].split('json')[1])
  // responseText = responseText.replace(/```json/g, '').replace(/```/g, '').trim();

  // Parse the cleaned string into a JSON object
  const jsonObject = JSON.parse(responseText.split('```')[1].split('json')[1]);
  return jsonObject
}
</file>

<file path="src/helpers/truckOperations.ts">
export const fetchTruckName = async (truck_id : string)=>{
    const res = await fetch(`/api/trucks/${truck_id}`,{
        method : 'GET',
        headers :{
            'Content-Type': 'application/json',
        }
    })

    if(!res.ok){
        alert('Failed to Fetch Truck Number')
        throw new Error('Failed to fetch truck name')
    }
    const data = await res.json()
    const truckNo = data.truck.truckNo
    return truckNo

}
</file>

<file path="src/lib/analytics.tsx">
"use client";

import { useEffect } from "react";
import { usePathname, useSearchParams } from "next/navigation";

// Extend the Window interface for gtag
declare global {
  interface Window {
    gtag: (
      command: "config" | "event",
      targetId: string,
      config?: Record<string, any>
    ) => void;
  }
}

const Analytics: React.FC = () => {
  const pathname = usePathname();
  const searchParams = useSearchParams();

  useEffect(() => {
    if (typeof window.gtag === "function") {
      const utmParams: Record<string, string> = {};

      // Extract UTM parameters from search params
      ["utm_source", "utm_medium", "utm_campaign", "utm_term", "utm_content"].forEach((param) => {
        const value = searchParams.get(param);
        if (value) {
          utmParams[param] = value;
        }
      });

      // Send page view with UTM parameters
      window.gtag("config", "G-BMXWP592W0", {
        page_path: pathname,
        ...utmParams, // Include UTM parameters if available
      });
    }
  }, [pathname, searchParams]);

  return null;
};

export default Analytics;
</file>

<file path="src/lib/utils.ts">
import { type ClassValue, clsx } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}
</file>

<file path="src/middleware.ts">
import { NextResponse } from 'next/server'
import { NextRequest, userAgent } from 'next/server'
import jwt from 'jsonwebtoken'

// This function can be marked `async` if using `await` inside
export async function middleware(request: NextRequest) {
  const token = request.cookies.get('auth_token')?.value
  const roleToken = request.cookies.get('role_token')?.value



  const { device, os } = userAgent(request)

  if (request.nextUrl.pathname != '/' && device.type == 'mobile') {
    return NextResponse.redirect(new URL('/', request.url))
  }


  const loggedInUserNotAccessPaths = request.nextUrl.pathname === '/login' || request.nextUrl.pathname == '/'

  if (roleToken) {
    const decodedToken: any = jwt.decode(roleToken as string)
    if (decodedToken?.role.name == 'driver' && !request.nextUrl.pathname.includes(`/user/drivers/${decodedToken.role.driver_id}`)) {
      return NextResponse.redirect(new URL(`/user/drivers/${decodedToken.role.driver_id}`, request.url))
    }
  }

  if (loggedInUserNotAccessPaths) {
    if (token) {
      return NextResponse.redirect(new URL('/user/home', request.url))
    }
  } else {
    if (!token) {
      return NextResponse.redirect(new URL('/login', request.url))
    }
  }

  const newUpdateCount = request.cookies.get('updateVisit')
  const response = NextResponse.next()

  if (!newUpdateCount) {
    // If the cookie doesn't exist, create it and set it to 1
    response.cookies.set('updateVisit', '1', {
      maxAge: 60 * 60 * 24 * 7, // 1 week
      path: '/',
    })
  }else{
    response.cookies.set('updateVisit','2')
  }

  return response
}

export const config = {
  matcher: [
    '/',
    '/login',
    '/user/parties',
    '/user/:path',
    '/user/:path*',
    '/user/parties/:path/party-details',
    '/user/parties/:path/passbook',
    '/user/parties/:path/trips',
    '/user/:path',
    '/user/:path/:path',
    '/user/:path/:path/:path'
  ]
}
// See "Matching Paths" below to learn more
</file>

<file path="src/services/notificationService.ts">
// services/notificationService.ts

import { messaging } from '@/firebase/firebaseAdmin';
import { connectToDatabase, fcmTokenSchema } from '@/utils/schema'; // Your Mongoose model
import { model, models } from 'mongoose';
const FcmToken = models.fcmToken || model('fcmToken', fcmTokenSchema);

interface NotificationPayload {
  title: string;
  body: string;
  data?: { [key: string]: string }; // Optional data payload
}

/**
 * Sends a push notification to all devices of a specific user.
 * @param userId - The ID of the user to send the notification to.
 * @param payload - The notification title, body, and optional data.
 */
export async function sendNotificationToUser(userId: string, payload: NotificationPayload) {
  await connectToDatabase();

  // 1. Find all FCM tokens for the given user
  const tokensDocs = await FcmToken.find({ user_id: userId });

  if (tokensDocs.length === 0) {
    console.log(`No FCM tokens found for user: ${userId}`);
    return;
  }

  const tokens = tokensDocs.map(doc => doc.fcm_token);

  // 2. Construct the multicast message
  const message = {
    notification: {
      title: payload.title,
      body: payload.body,
    },
    data: payload.data, // Attach optional data
    tokens: tokens, // Array of tokens
  };

  console.log(`Sending notification to ${tokens.length} device(s) for user ${userId}`);

  try {
    // 3. Send the message to all tokens
    const batchResponse = await messaging.sendEachForMulticast(message);
console.log(batchResponse)
    // 4. Handle responses and clean up invalid tokens
    const tokensToDelete: string[] = [];
    batchResponse.responses.forEach((response, idx) => {
      const token = tokens[idx];
      if (!response.success) {
        console.error(`Failed to send to token: ${token}`, response.error);
        // Check for errors indicating an invalid or unregistered token
        if (
          response.error &&
          (response.error.code === 'messaging/invalid-registration-token' ||
            response.error.code === 'messaging/registration-token-not-registered')
        ) {
          tokensToDelete.push(token);
        }
      }
    });

    if (tokensToDelete.length > 0) {
      console.log(`Deleting ${tokensToDelete.length} stale tokens.`);
      await FcmToken.deleteMany({ fcm_token: { $in: tokensToDelete } });
    }

    console.log(`${batchResponse.successCount} messages were sent successfully.`);

  } catch (error) {
    console.error('Error sending push notification:', error);
  }
}
</file>

<file path="src/store/api.ts">
import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react'
import { ITrip, IDriver, TruckModel, IParty, ISupplier, IExpense, invData } from "@/utils/interface"

export interface DashboardData {
    expenses: ExpenseData[]
    trips: TripData[]
    recentActivities: ITrip | IExpense | TruckModel | IDriver | ISupplier | any
    profit: number
}

export interface ExpenseData {
    _id: string
    totalExpenses: number
    totalAmount: number
}

export interface TripData {
    _id: number
    count: number
    month: string
}

export const api = createApi({
    baseQuery: fetchBaseQuery({ baseUrl: '/api' }),
    tagTypes: ['Trips'],
    endpoints: (builder) => ({
        getTrips: builder.query<{ trips: ITrip[] }, number | undefined>({
            query: (status) => status !== undefined ? `trips?status=${status}` : 'trips',
            providesTags: ['Trips'],
        }),
        getDrivers: builder.query<{ drivers: IDriver[] | any[] }, void>({
            query: () => 'drivers',
        }),
        getInvoice: builder.query<{ invoices: invData[] | any[] }, void>({
            query: () => 'invoices',
        }),
        getTrucks: builder.query<{ trucks: TruckModel[] | any[] }, void>({
            query: () => 'trucks',
        }),
        getShops: builder.query<{ shops: any[] | any[] }, void>({
            query: () => 'shopkhata',
        }),
        getParties: builder.query<{ parties: IParty[] | any[] }, void>({
            query: () => 'parties',
        }),
        getSuppliers: builder.query<{ suppliers: ISupplier[] | any[] }, void>({
            query: () => 'suppliers',
        }),
        getDashboard: builder.query<DashboardData, void>({
            query: () => 'dashboard',
        }),
        getRecentDocuments: builder.query<DashboardData, void>({
            query: () => 'documents/recent',
        }),
        // New trip methods
        updateTripStatus: builder.mutation<ITrip, {
            tripId: string;
            podImage?: string;
            status: number;
            dates: (string | null)[];
            notes?: string
        }>({
            query: ({ tripId, ...data }) => ({
                url: `trips/${tripId}`,
                method: 'PATCH',
                body: {data},
            }),
            invalidatesTags: ['Trips'],
        }),
        updateTrip: builder.mutation<ITrip, { tripId: string; tripData: Partial<ITrip> }>({
            query: ({ tripId, tripData }) => ({
                url: `trips/${tripId}`,
                method: 'PUT',
                body: tripData,
            }),
            invalidatesTags: ['Trips'],
        }),
        deleteTrip: builder.mutation<void, string>({
            query: (tripId) => ({
                url: `trips/${tripId}`,
                method: 'DELETE',
            }),
            invalidatesTags: ['Trips'],
        }),
        editTrip: builder.mutation<ITrip, { tripId: string; tripData: Partial<ITrip> }>({
            query: ({ tripId, tripData }) => ({
                url: `trips/${tripId}`,
                method: 'PUT',
                body: {data : tripData},
            }),
            invalidatesTags: ['Trips'],
        }),
    }),
})

export const {
    useGetTripsQuery,
    useGetDriversQuery,
    useGetTrucksQuery,
    useGetShopsQuery,
    useGetPartiesQuery,
    useGetSuppliersQuery,
    useGetDashboardQuery,
    useUpdateTripStatusMutation,
    useUpdateTripMutation,
    useDeleteTripMutation,
    useEditTripMutation,
    useGetRecentDocumentsQuery,
    useGetInvoiceQuery
} = api
</file>

<file path="src/store/hooks.ts">
import { TypedUseSelectorHook, useDispatch, useSelector } from 'react-redux'
import type { RootState, AppDispatch } from './store'

export const useAppDispatch = () => useDispatch<AppDispatch>()
export const useAppSelector: TypedUseSelectorHook<RootState> = useSelector
</file>

<file path="src/store/store.ts">
import { configureStore } from '@reduxjs/toolkit'
import { api } from './api'

export const store = configureStore({
  reducer: {
    [api.reducerPath]: api.reducer,
  },
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware().concat(api.middleware),
})

export type RootState = ReturnType<typeof store.getState>
export type AppDispatch = typeof store.dispatch
</file>

<file path="src/store/tripsSlice.ts">
import { createSlice, PayloadAction } from '@reduxjs/toolkit'
import { ITrip } from '@/utils/interface'

interface TripsState {
  visibleColumns: string[]
  sortConfig: {
    key: keyof ITrip | null
    direction: 'asc' | 'desc'
  }
  searchQuery: string
  selectedStatus: number | undefined
}

const initialState: TripsState = {
  visibleColumns: ['Start Date', 'LR Number', 'Truck Number', 'Party Name', 'Route', 'Status', 'Invoice Amt', 'Truck Hire Cost'],
  sortConfig: { key: null, direction: 'asc' },
  searchQuery: '',
  selectedStatus: undefined,
}

const tripsSlice = createSlice({
  name: 'trips',
  initialState,
  reducers: {
    setVisibleColumns: (state, action: PayloadAction<string[]>) => {
      state.visibleColumns = action.payload
    },
    setSortConfig: (state, action: PayloadAction<{ key: keyof ITrip | null; direction: 'asc' | 'desc' }>) => {
      state.sortConfig = action.payload
    },
    setSearchQuery: (state, action: PayloadAction<string>) => {
      state.searchQuery = action.payload
    },
    setSelectedStatus: (state, action: PayloadAction<number | undefined>) => {
      state.selectedStatus = action.payload
    },
  },
})

export const { setVisibleColumns, setSortConfig, setSearchQuery, setSelectedStatus } = tripsSlice.actions
export default tripsSlice.reducer
</file>

<file path="src/utils/animation.ts">
export const pageVariants = {
    initial: { opacity: 0, y: 20 },
    in: { opacity: 1, y: 0 },
    out: { opacity: 0, y: -20 },
  };
  
  export const pageTransition = {
    type: "tween",
    ease: "anticipate",
    duration: 0.3,
  };
  
  export const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: {
        delayChildren: 0.3,
        staggerChildren: 0.2
      }
    }
  };
  
  export const itemVariants = {
    hidden: { y: 20, opacity: 0 },
    visible: {
      y: 0,
      opacity: 1
    }
  };
</file>

<file path="src/utils/auth.ts">
// utils/auth.ts
import jwt, { JwtPayload } from 'jsonwebtoken';
import { NextRequest } from 'next/server';
import { connectToDatabase, TokenBlacklistSchema, userSchema } from '@/utils/schema'; // Import your schema
import { model, models } from 'mongoose';
import crypto from 'crypto';

// Define the TokenBlackList model
const TokenBlackList = models.TokenBlackList || model('TokenBlackList', TokenBlacklistSchema);
const User = models.User || model('User', userSchema)

export async function verifyToken(req: Request) {
  const token = fetchCookie(req as NextRequest);
  
  
  if (!token) {
    return { error: 'Unauthorized: No token provided' };
  }

  try {
    // Connect to the database to check the blacklist
    await connectToDatabase();
    
    // Check if the token is blacklisted
    const blacklistedToken = await TokenBlackList.findOne({ token });
    if (blacklistedToken) {
      return { error: 'Unauthorized: Token is blacklisted' };
    }

    // Verify the token
    const decodedToken = jwt.verify(token, process.env.JWT_SECRET as string) as JwtPayload;
    const existingUser = await User.findOne({user_id : decodedToken.user_id})
    if(!existingUser){
      return {error : 'Unauthorized User'}
    }

    // Optionally, you can add more checks for the token payload
    if (decodedToken.role) return {user : decodedToken.role.user}

      
    else return { user: decodedToken.user_id };
    
  } catch (err) {
    return { error: 'Unauthorized: Invalid token' };
  }
}

export function fetchCookie(req: NextRequest) {
  const token = req.cookies.get('auth_token');
  return token?.value
}

export function generateUserId(phoneNumber: string): string {
  // Remove any non-digit characters from the phone number
  const sanitizedPhone = phoneNumber.replace(/\D/g, '');

  // Generate a SHA-256 hash of the sanitized phone number
  const hash = crypto.createHash('sha256').update(sanitizedPhone).digest('hex');

  // Truncate the hash to create a user_id
  return hash.substring(0, 16);
}
</file>

<file path="src/utils/cities.ts">
export const cities = ['Achanta', 'Adoni', 'Allur', 'Amadalavalasa', 'Amalapuram', 'Anakapalle', 'Anantapalli', 'Anantapur', 'Anaparthy', 'Annavaram', 'Araku', 'Atchutapuram APSEZ', 'Atmakur', 'Atmakur Sri Potti', 'Sriramulu Nellore', 'District', 'Attilli', 'Badampudi', 'Badvel', 'Banaganapalle', 'BandarulankaBakultala', 'Bambooflat', 'Car Nicobar', 'Garacharma', 'Hut Bay', 'Kamorta', 'Malacca', 'Mayabunder', 'Port Blair', 'Prothrapur', 'Rangat', 'Tarasa Island Banumukkala', 'Bapatla', 'Bestawaripeta', 'Bethamcherla', 'Bheemunipatnam', 'Bhimadole', 'Bhimavaram', 'Bobbili', 'Bowluvada', 'Bugganipalle', 'Chagallu', 'Chebrole Khandrika', 'Chebrolu', 'Chennamukkapalle', 'Chennur', 'Chilakaluripet', 'Chimakurthy', 'Chintalavalasa', 'Chintapalle', 'Chippada Pharma SEZ', 'Chirala', 'Chittoor', 'Chodavaram', 'Cumbum', 'Denduluru', 'Devarapalli', 'Dharmavaram', 'Dhone', 'Dommara Nandyala', 'Dondapadu Kakathiya', 'Cement Factory', 'Dondapadu KCP Cement Factory', 'Dowleswaram', 'Draksharamam', 'Dwaraka Tirumala', 'Edlapadu', 'Ekambarakuppam Eluru', 'Gajapathinagaram', 'Gajulamandhyam', 'Industrial Area', 'Gajularega', 'Ganapavaram', 'Gangapatnam', 'Gavaravaram', 'Giddaluru', 'Golugonda', 'Gooty', 'Gopalapuram', 'Gopavaram', 'Gudilova', 'Gudivada', 'Gudur', 'Gundugolanu', 'Guntakal', 'Guntur', 'Gurzala', 'Hanuman Junction', 'Hindupur', 'Hiramandalam', 'Horseley Hills', 'Hukumpeta', 'Ibrahimpatnam', 'Ichchapuram', 'India Cement Factory', 'Chilamakuru', 'Indukurpet', 'Industrial Growth Centre', 'Thimmanapalem', 'Jaggaiahpet', 'Jammalamadugu', 'Jangareddigudem', 'Jarjapupeta', 'Jaypee Cement Factory Budawada', 'Kadapa', 'Kadiri', 'Kaikaram', 'Kakinada', 'Kakkalapalle', 'Kallur', 'Kallur Anantapur', 'District', 'Kaluvaya', 'Kalyandurg', 'Kanapaka', 'Kandukur', 'Kanigiri', 'Kankipadu', 'Kantabamsuguda', 'Kathipudi', 'Kavali', 'Kavali Industrial Area', 'Kodumur', 'Kodur', 'Koikuntla', 'Komarolu', 'Kondapalle', 'Kota', 'Kotabammal', 'Kothapatnam', 'Kothavalasa', 'Kovurpalle', 'Kovvur', 'Kudithipalem', 'Kuppam', 'Kurnool', 'Macherla', 'Machilipatnam', 'Madanapalle', 'Madhurawada Mandapeta', 'Mangalagiri', 'Mangampeta', 'Mangasamudram', 'Markapur', 'Maruteru', 'Medarametla', 'Medikonduru', 'Meliaputti', 'Moragudi', 'Morampudi', 'Muddanur', 'Mulaguntapadu', 'Mulakuddu', 'Mummidivaram', 'Murakambattu', 'Muttukuru', 'Mydukur', 'Mylavaram', 'Nadim Tiruvuru', 'Nagaram', 'Nagari', 'Nagireddipalle', 'Nakkapalle', 'Nallajerla', 'Nandigama', 'Nandyal', 'Narasannapeta', 'Narasapur', 'Narasapuram', 'Narasaraopet', 'Narayanapuram', 'Vizianagaram District', 'Narayanavanam', 'Narsipatnam', 'Nayudupeta', 'Nellimarla Nellore', 'Nidadavole', 'NTPC Simhadri', 'Nuzvid', 'Ongole', 'Paderu', 'Palacole', 'Palakonda', 'Palamaner', 'Palasa Kasibugga', 'Pamidi', 'Pamur', 'Paravada Industrial Area', 'Parvathipuram', 'Pathapatnam', 'Payakaraopeta', 'Peda Boddepalle', 'Pedana', 'Pedatadepalli', 'Peddapuram', 'Pentapadu', 'Perecherla', 'Phirangipuram', 'Piduguralla', 'Pileru', 'Pippara', 'Pithapuram', 'Podalakur', 'Podili', 'Pondura', 'Ponnekallu', 'Ponnur', 'Porumamilla', 'Prattipadu', 'Proddatur', 'Pulivendula', 'Pulla Punganur', 'Puttaparthi', 'Puttur', 'Rajahmundry', 'Rajam', 'Rajampet', 'Ramabhadrapuram', 'Ramachandrapuram', 'Ramapuram', 'Ramathirtham', 'RAMCO Cement', 'Factory', 'Dharmavarappadu', 'Rameswaram', 'Rampachodavaram', 'Rayachoti', 'Rayadurg', 'Razole', 'Repalle', 'Rushikonda APIIC', 'Salur Samalkot', 'Sanivarapupeta', 'Santhanuthalapadu', 'Satrampadu', 'Sattenapalle', 'Singarayakonda', 'Somandepalle', 'Sompeta', 'Sricity', 'Srikakulam', 'Srikalahasti', 'Sriramnagar', 'Srisailam', 'Srungavarapukota', 'Sulluru', 'Sunnipenta', 'Tada Tadepalle', 'Tadepalligudem', 'Tadpatri', 'Tangellamudi', 'Tanuku', 'Tekkali', 'Tenali', 'Thagarapuvalasa', 'Thatipaka', 'Thullur', 'Thumakunta', 'Industrial Area', 'Tiruchanur', 'Tirumala', 'Tirupati', 'Tummikapalle', 'Tuni', 'Unguturu', 'Uppada', 'Upper Sileru', 'Project Site Camp', 'Uravakonda', 'Vaddeswaram', 'Vavilla', 'Velvadam', 'Venkatachalam', 'Industrial Area', 'Venkatagiri', 'Veparala', 'Vetapalem', 'Vijayapuri South', 'Vijayawada', 'Vinnamala', 'Vinukonda', 'Visakhapatnam', 'Vissannapet', 'Vizianagaram', 'VSP Township', 'Vuyyuru', 'Yanam', 'Yelamanchili', 'Yemmiganur', 'Yenumalapalle', 'Yernagudem', 'Yerraguntla', 'Along', 'AninI', 'Basar', 'Boleng', 'Bomdila', 'Changlang', 'Daporijo', 'Deomali', 'Dirang', 'Hawai', 'Itanagar', 'Jairampur', 'Khonsa', 'Koloriang', 'Longding', 'Miao', 'Naharlagun', 'Namsai', 'Pasighat', 'Roing', 'Rupa', 'Sagalee', 'Seppa', 'Tawang', 'Tezu', 'Yingkiong', 'YupiaArunachal Pradesh Ziro', 'Abhayapuri', 'Amguri', 'Anand Nagar', 'Asudubi', 'Azara', 'Badarpur', 'Badarpur Rly Town', 'Bamun Sualkuchi', 'Bandardewa IID', 'Bangaon', 'Barpathar', 'Barpeta', 'Barpeta Road', 'Basugaon', 'BCPL Township', 'Behiating AIDC', 'Belsor', 'Bhomoraguri AIDC', 'Bhuragaon', 'Bihpuria', 'Bijni', 'Bilasipara', 'Biswanath Chariali', 'Bohari', 'Bokajan', 'Bokakhat', 'Bongaigaon', 'Bongaigaon RPCL', 'Township', 'Borgolai Gt 11', 'Borpukhuri', 'Chabua', 'Chalantapara Pt IV', 'Chandrapur BagichaAssam Changsari', 'Chapakhowa Town', 'Chapar', 'Charingia Gaon', 'Chekonidhara', 'Dahali', 'Dalgaon', 'Damara Patpara', 'Dergaon', 'Dhakuakhana', 'Dharapur', 'Dhekiajuli', 'Dhekorgorha', 'Dhemaji', 'Dhing', 'Dhubri', 'Dibrugarh', 'Digaru Gaon', 'Digboi', 'Diphu', 'Dispur', 'Doboka', 'Dokmoka', 'Donkamokam', 'Doom Dooma', 'Dudhpatil Pt V', 'Dudhpatil Pt VI', 'Duliajan', 'Duliajan No 1', 'Durga Nagar Part-V', 'Garal', 'Gauripur', 'Goalpara', 'Gohpur', 'Golaghat', 'Golokganj', 'Goreswar Gossaigaon', 'Guwahati', 'Haflong', 'Hailakandi', 'Hamren', 'Hindustan Paper', 'Corporation Ltd Township', 'Panchgram', 'Hojai', 'Howli', 'Howraghat', 'Irongmara', 'Jagiroad', 'Jamunamukh', 'Jhagra Pt III', 'Jonai Bazar', 'Jorhat', 'Kakaya', 'Kalaigaon Town Part', 'Kamalabaria NC', 'Kampur Town', 'Kanisail Pt I', 'Karimganj', 'Khaira Bari', 'Kharijapikon', 'Kharupatia', 'Kochpara', 'Kokrajhar', 'Kumar Kaibarta Gaon', 'Lakhipur', 'Lakhipur, Cachar District', 'Lala', 'Lanka', 'Lido Tikok', 'Lido Town', 'Lumding', 'Lumding Rly Colony Mahur', 'Maibong', 'Majgaon', 'Makum', 'Mangaldoi', 'Mankachar', 'Margherita', 'Mariani', 'Marigaon', 'Marowa', 'Moran Town', 'Moranhat', 'Mornoi Industrial Area', 'Mushalpur', 'Nagaon', 'Naharkatiya', 'Nahira', 'Nalbari', 'Namrup', 'Narayanpur', 'Naubaisa Gaon', 'Nazira', 'New Bongaigaon', 'Railway Colony', 'Niz Bahjani', 'Niz Hajo', 'Niz Katigorah Pt III', 'Niz Mankata', 'North Guwahati', 'North Lakhimpur', 'Numaligarh', 'Refinery Township', 'Palasbari', 'Pathsala', 'Pub Dhaniram Pather', 'Raha', 'Rangapara Rangia', 'Rangia IIDC', 'Rani', 'Rupahi Town', 'Rupiabathan', 'Salakati', 'Salpara Molandubi Pt I', 'Sanpara', 'Sapatgram', 'Sarbhog', 'Sarthebari', 'Sarupathar', 'Sarupathar Bengali', 'Sepon', 'Sibsagar', 'Silapathar', 'Silchar', 'Sonapur Gaon', 'Sonari', 'Sualkuchi', 'Takhlibilar Pathar', 'Tangla', 'Tegheria', 'Teok', 'Tezpur', 'Thekashu Pt I', 'Thekashu Pt II', 'Tihu', 'Tinsukia', 'Titabor Town', 'Udalguri', 'Umrangso', 'Bihar', 'Amarpur', 'Anwari', 'Araria Areraj', 'Arrah', 'Arwal', 'Asarganj', 'Aurangabad', 'Bagaha', 'Bahadurganj', 'Bahadurpur', 'Bairgania', 'Bakhri', 'Bakhtiarpur', 'Balia', 'Banka', 'Banmankhi Bazar', 'Bara', 'Barahiya', 'Barauli', 'Barauni IOC Township', 'Barbigha', 'Barh', 'Baruni', 'Baruni Thremal', 'Power Station Township', 'Begusarai', 'Behea', 'Belsand', 'Benipur', 'Bettiah', 'Bhabua', 'Bhagalpur', 'Bhagirathpur', 'Biharsharif', 'Bihta', 'Bihta Patna District', 'Bikram', 'Bikramganj', 'Birpur Bodh Gaya', 'Buxar', 'Chakia', 'Chanari', 'Chand Chaur', 'Chanpatia', 'Chapra', 'Dalsinghsarai', 'Darbhanga', 'Dariapur', 'Daudnagar', 'Dehri', 'Dhaka', 'Dighwara', 'Dumari', 'Dumraon', 'Ekangar Sarai', 'Fatwah', 'Forbesganj', 'Gaya', 'Gazipur', 'Ghoghardiha', 'Gogri Jamalpur', 'Gopalganj', 'Habibpur', 'Hajipur', 'Hanspura', 'Harnaut', 'Hathua', 'Hilsa', 'Hisua', 'Islampur', 'Jagdishpur', 'Jainagar', 'Jamalpur', 'Jamhaur', 'Jamui', 'Janakpur Road', 'Janpur', 'Jehanabad', 'Jhajha', 'Jhanjharpur', 'Jogabani', 'Kahalgaon', 'Kanti', 'Kargahia Purab', 'Kasba', 'Kataiya', 'Katihar', 'Kesaria', 'Khagaria', 'Kharagpur', 'Khusrupur', 'Kishanganj', 'Koath', 'Koilwar', 'Kumarbagh', 'Lakhisarai', 'Lalganj', 'Laruara', 'Madhepura', 'Madhuban', 'Madhubani', 'Maharajganj', 'Mahnar Bazar', 'Mairwa', 'Makhdumpur', 'Malhipur', 'Maner', 'Manihari', 'Mansur Chak', 'Marhaura', 'Masaurhi', 'Mathurapur Mehsi', 'Mirganj', 'Mohiuddinagar', 'Mokameh', 'Motihari', 'Motipur', 'Munger', 'Murliganj', 'Muzaffarpur', 'Nabinagar', 'Narkatiaganj', 'Nasrigagnj', 'Naubatpur', 'Naugachhia', 'Nawada', 'Nirmali', 'Nokha', 'NTPC Barh', 'Obra', 'Padri', 'Pakri Dayal', 'Pandual', 'Pareo', 'Paria', 'Patna', 'Piro', 'Puraini', 'Purnia', 'Rafiganj', 'Raghunathpur', 'Rajauli', 'Rajgir', 'Ramgarh', 'Ramnagar', 'Raxaul Bazar', 'Revelganj', 'Rosera Saharsa', 'Sahebganj', 'Sahebganj Banka District', 'Saidpura', 'Samastipur', 'Saraiya', 'Sasaram', 'Satghara', 'Shahpur', 'Sheikhpura', 'Sheohar', 'Sherghati', 'Silao', 'Singhesar Asthan', 'Sitamarhi', 'Siwan', 'Sonepur', 'Sugauli', 'Sultanganj', 'Supaul', 'Teghra', 'Telkap', 'Thakurganj', 'Tikari', 'Tola Baliadih', 'Tola Chain', 'Tola Mansaraut', 'Tola Pairamatihana', 'Vaishali', 'Warisaliganj', 'Chandigarh', 'Mohali', 'PanchkulaChandigarh MetroChhattisgarh', 'Aamdi', 'Abhanpur', 'Adawal', 'Adbhar', 'Ahiwara', 'Akaltara', 'Ambagarh Chowki', 'Ambikapur', 'Antagarh', 'Arang', 'Arjunda', 'Bade Bacheli', 'Badla', 'Bagbahara', 'Bagicha', 'Baikunthpur', 'Balod', 'Baloda', 'Baloda Bazar', 'Balrampur', 'Banarsi', 'Banki Mongra', 'Baramkela', 'Barsur', 'Basna', 'Bastar', 'Bemetra', 'Berla', 'Bhairamgarh', 'Bhakhara', 'Bhanupratappur', 'Bhatapara', 'Bhatgaon', 'Bhilai', 'Bhopalpattanam', 'Bijapur Bilaigarh', 'Bilaspur', 'Bilha', 'Birkoni IIDC', 'Bodri', 'Borai CSIDC', 'Century Cement Baikunth', 'Champa', 'Chandrapur', 'Charama', 'Chharchha', 'Chhuikhadan', 'Chhura', 'Chhurikala', 'Chhuriya kalan', 'Chikhal Kasa', 'Chirmiri', 'Dabhra', 'Dalli Rajhara', 'Dantewada', 'Daundi Lohara', 'Deori', 'Devkar', 'Dhamdha', 'Dhamtari', 'Dharamjaigarh', 'Dipka', 'Dongargaon', 'Dongargarh', 'Dornapal', 'Doundi', 'Durg', 'Farasgaon', 'Fingeshwar', 'Gandai', 'Gariaband', 'Gaurela Gharghoda', 'Gidam', 'Girwarganj IIDC', 'Gobra Nawapara', 'Govindapur', 'Gunderdehi', 'Gurur', 'Hatkachora', 'Hirmi', 'Jagdalpur', 'Jaijepur', 'Janjgir', 'Jarhi', 'Jarwe', 'Jashpurnagar', 'Jhagrakhand', 'Kanker', 'Kasdol', 'Katghora', 'Katkona', 'Kawardha', 'Keskal', 'Khairagarh', 'Khamharia', 'Kharod', 'Kharora', 'Kharsia', 'Khongapani', 'Kirandul', 'Kondagaon', 'Koni', 'Konta', 'Korba', 'Kota', 'Kotba', 'Kumhari', 'Kunkuri Kurasia', 'Kurud', 'Kusmi', 'Lafarge Cement Factory', 'Arasmeta', 'Lafarge Cement Factory', 'Sonadhi', 'Lailunga', 'Lakhnapur', 'Lawan', 'Lormi', 'Magarlod', 'Mahasamund', 'Mahendragarh', 'Malhar', 'Mandhar Industrial Area', 'Mandir Hasaud', 'Maro', 'Mehmand', 'Mungeli', 'Nagari', 'Nai Ledri', 'Namna Kalan', 'Narayanpur', 'Narharpur', 'Nawagarh', 'Nawagarh Janjgir -', 'Champa District', 'Naya Baradwar', 'New Raipur', 'NTPC Sipat', 'Pakhanjur', 'Palari', 'Pali', 'Pandaria', 'Pandatarai', 'Paratappur Parpodi', 'Patan', 'Pathalgaon', 'Patharia', 'Pathariya', 'Pendra', 'Phunderdihari', 'Pipariya', 'Pithora', 'Pusaur', 'Rahaud', 'Raigarh', 'Raipur', 'Rajgamar', 'Rajnandgaon', 'Rajpur', 'Ramanujganj', 'Rani Durgavati', 'Industrial Area Anjani', 'Ratanpur', 'Rawan Ambuja', 'Cement Plant', 'Sahaspur Lohara', 'Saja', 'Sakari', 'Sakti', 'Saragaon', 'Saraipali', 'Sarangarh', 'Sargaon', 'Sariya', 'Sheorinarayan', 'Silpahari Industrial Area', 'Simga', 'Sirgitti', 'Sitapur', 'Sukma', 'Surajpur', 'Takhatpur', 'Telgaon', 'Tendua IID', 'Tifra', 'Tilda', 'Tumgaon', 'Tundra', 'Ultratech Cement Plant', 'Rawan', 'Utai', 'Vishrampur', 'Vishrampuri', 'Wadrafnagar', 'Alok City', 'Amli', 'Dungra', 'Masat Industrial Area', 'Naroli', 'Silvassa', 'Surangi', 'Aldona', 'AnjunaDadra & Nagar Haveli', 'Delhi', 'Daman & Diu', 'GoaNew Delhi', 'Dadhel', 'Daman', 'Diu', 'Ghoghla', 'Kachigam Aquem', 'Arambol', 'Bambolim', 'Bandora', 'Benaulim', 'Bicholim', 'Borim', 'Calangute', 'Calapor', 'Canacona', 'Candola', 'Candolim', 'Carapur', 'Chicalim', 'Chimbel', 'Chinchinim', 'Colva', 'Colvale', 'Cumbarjua', 'Cuncolim', 'Curchorem', 'Curti', 'Curtorim', 'Davorlim', 'Guirim', 'Jua', 'Mandrem', 'Mapusa', 'Marcaim', 'Margao', 'Mercurim', 'Moira', 'Morjim', 'Navelim', 'Nerul', 'Nuvem', 'Old Goa Onda', 'Orgao', 'Pale', 'Panaji', 'Parcem', 'Penha De Franca', 'Pernem', 'Ponda', 'Porvorim', 'Priol', 'Quepem', 'Queula', 'Raia', 'Reis Magos', 'Saligao', 'Sancoale', 'Sanguem', 'Sanquelim', 'Sanvordem', 'Sao Jose de Areal', 'Siolim', 'Usgao', 'Valpoi', 'Varca', 'Vasco Da Gama', 'Xeldem', 'Abrama', 'Adalaj', 'Adityana', 'Ahmedabad', 'Ahwa', 'Alang', 'Alikherva', 'Ambaji', 'AmbaliyasanGujarat Amboli', 'Amod', 'Amreli', 'Anand', 'Anandpar', 'Anandpar Jamnagar', 'District', 'Andada', 'Anjar', 'Anklav', 'Ankleshwar', 'Antaliya', 'Arambhada', 'Arsodiya', 'Atul', 'Baben', 'Babra', 'Bagasara', 'Balasinor', 'Baliyasan', 'Bansda', 'Bantwa', 'Bardoli', 'Bareja', 'Barwala', 'Bavla', 'Bayad', 'Bechar Alias Becharaji', 'Bedi', 'Bhabhar', 'Bhachau', 'Bhadkodara', 'Bhagal', 'Bhagal Valsad District', 'Bhalpara', 'Bhanvad', 'Bharuch Bhat', 'Bhavnagar', 'Bhayavadar', 'Bhilad', 'Bhiloda', 'Bhuj', 'Bhurivel', 'Bilimora', 'Bodeli', 'Boriavi', 'Borsad', 'Botad', 'Chaklasi', 'Chalala', 'Chalthan', 'Chanasma', 'Changodar GIDC', 'Chanod', 'Chhapi', 'Chhapra', 'Chhatral', 'Chhiri', 'Chhota Udaipur', 'Chikhli', 'Chorwad', 'Chotila', 'Dabhoi', 'Dahej SIR', 'Dakor', 'Damnagar', 'Dediapada', 'Deesa', 'Dehari', 'Dehgam', 'Deodar', 'Devgadbaria', 'Devsar Dhandhuka', 'Dhanera', 'Dharampur', 'Dhasa Vishi', 'Dhola', 'Dholka', 'Dhoraji', 'Dhrangadhra', 'Dhrol', 'Digvijaygram', 'Dohad', 'Dungarpur', 'Dungarpur Bhavnagar', 'District', 'Dwarka', 'Gadhada', 'Gamdi', 'Gandevi', 'Gandhidham', 'Gandhinagar', 'Gariadhar', 'Ghogha', 'GIDC Antaliya', 'GIDC Panoli', 'GIDC Por', 'GIDC Savli', 'Godhra', 'Gondal', 'GSFC Motikhavdi', 'Sikka INA', 'GSFC Reliance Complex', 'GWC Township Kovaya', 'Hajira', 'Halol', 'Halvad', 'Hansalpur', 'Harij Himmatnagar', 'Ichchhapor', 'Ichhapor', 'Idar', 'Jafrabad', 'Jalalpore', 'Jamavala', 'Jambusar', 'Jamjodhpur', 'Jamnagar', 'Jarod', 'Jasdan', 'Jetalsar', 'Jetpur', 'Jetpur Navagadh', 'Jhalod', 'Joshipura', 'Junagadh', 'Kadi', 'Kadodara', 'Kakoshi', 'Kalavad', 'Kalol', 'Kalol, Panch', 'Mahals District', 'Kandla', 'Kanjari', 'Kanodar', 'Kapadvanj', 'Karamsad', 'Karjan', 'Kathlal', 'Katpar', 'Kavant', 'Keshod', 'Kevadiya', 'Khambhalia Khambhat', 'khapat', 'Kharach', 'Kharaghoda', 'Kheda', 'Khedbrahma', 'Kheralu', 'Kim', 'Kodinar', 'Kosamba', 'Kothria', 'Kutiyana', 'Lathi', 'Lavachha', 'Lilia', 'Limbdi', 'Limkheda', 'Limla', 'Lodhikas', 'Lunawada', 'Madhapar', 'Mahesana', 'Mahudha', 'Mahuva', 'Mahuvar', 'Malanka', 'Maliya', 'Malpur', 'Manavadar', 'Mandvi', 'Mandvi Surat District', 'Mangrol', 'Mankuva', 'Mansa', 'Meghraj', 'Mehmedabad', 'Mithapur', 'Modasa', 'Modhera', 'Morbi', 'Mundra', 'Nadiad', 'Nalsarovar', 'Nandej', 'Nari', 'Nasvadi', 'Nava Bhildi', 'Navlakhi SIR', 'Navsari', 'Ode', 'Okha Port', 'Orvad', 'Paddhari', 'Padra', 'Palaj', 'Palanpur', 'Palej', 'Palitana', 'Panoli INA', 'Parabada', 'Pardi', 'Parnera', 'Patan', 'Patdi', 'Pethapur', 'Petlad', 'Porbandar', 'Prantij', 'Radhanpur', 'Rajkot', 'Rajpipla', 'Rajula', 'Ranavav', 'Ranpur Rapar', 'Raval', 'Ravapara', 'Sagbara', 'Salaya', 'Salvav', 'Sanand', 'Sanand GIDC', 'Sanjan', 'Sanjeli', 'Santrampur', 'Saputara', 'Sarigam', 'Sathamba', 'Savarkundla', 'Savli', 'Sayan', 'Selamba', 'Shapur', 'Shapur Rajkot District', 'Shehera', 'Sidhpur', 'Sidsar', 'Sihor', 'Sikka', 'Simar SIR', 'Sojitra', 'Somnath', 'Songadh', 'Songadh Bhavnagar', 'District', 'Sukhpar', 'Surajkaradi', 'Surat', 'Surendranagar', 'Sutrapada', 'Talaja Talala', 'Talod', 'Tarsadi', 'Thangadh', 'Thara', 'Tharad', 'Thasra', 'Ukai', 'Umbergaon', 'Umrala', 'Umreth', 'Una', 'Undach', 'Unjha', 'Upleta', 'Vadali', 'Vadia', 'Vadnagar', 'Vadodara', 'Vaghodia', 'Valia', 'Vallabhipur', 'Valsad', 'Vanthali', 'Vapi', 'Vartej', 'Vasna', 'Veraval', 'Veraval Rajkot District', 'Vijalpor', 'Vijapur', 'Vijaynagar', 'Vilayat GIDC', 'Viramgam', 'Virpur', 'Virpur Rajkot District', 'Visavadar Visnagar', 'Vyara', 'Wadhwan', 'Waghai', 'Wankaner', 'Adampur', 'Ambala', 'Asankhurd', 'Assandh', 'Ateli', 'Badh Malak', 'Badli', 'Baghola', 'Bahadurgarh', 'Barara', 'Barhi Industrial Area', 'Barwala', 'Bawal', 'Bawani Khera', 'Beri', 'Bhakali', 'Bhiwani', 'Bhondsi', 'Bhuran', 'Bilaspur', 'Binola Industrial Area', 'Boh', 'Buria', 'Chandi Mandir', 'Chandimandir Bir', 'Ghaggar', 'Charkhi Dadri', 'Cheeka', 'Chhachhrauli', 'DharuheraHaryana Ellenabad', 'Farakhpur', 'Faridabad', 'Farrukhnagar', 'Fatehabad', 'Ferozepur Jhirka', 'Ganaur', 'Gangwa', 'Garhi Harsaru', 'Gharaunda', 'Gohana', 'Gurgaon', 'Haileymandi', 'Hansi', 'Hassanpur', 'Hathin', 'Hisar', 'Hodal', 'HSIIDC Dudhola Industrial', 'Area', 'HSIIDC Manakpur', 'Industrial Area', 'Indri', 'Industrial Estate Barwala', 'Ismailabad', 'Jakhalmandi', 'Jhajjar', 'Jind', 'Julana', 'Kabri', 'Kachrauli', 'Kaithal', 'Kakar Majra', 'Kalanaur', 'Kalanwali', 'Kalayat', 'Kalka Kanina', 'Karnal', 'Kharkhoda', 'Khori Kalan', 'Kundli', 'Kundli Industrial Area', 'Kurukshetra', 'Ladrawan', 'Ladwa', 'Loharu', 'Maham', 'Mahendragarh', 'Majra', 'Mandi Dabwali', 'Manesar', 'Manethi', 'Mayyer', 'Mustafabad', 'Nagal Chaudhry', 'Nagina', 'Naraingarh', 'Narnaul', 'Narnaund', 'Narwana', 'Nilokheri', 'Nissing', 'Nuh', 'Palwal', 'Panchkula', 'Panipat', 'Panipat Refinery', 'Township', 'Pataudi', 'Pehowa', 'Piala', 'Pinagwan', 'Pinjore Punahana', 'Pundri', 'Radaur', 'Rai Industrial Area', 'Raipur Rani', 'Ram Garh', 'Rania', 'Ratia', 'Rewari', 'Rohtak', 'Roz Ka Meo', 'Industrial Area', 'Sadaura', 'Safidon', 'Saha', 'Salamba', 'Samalkha', 'Sampla', 'Sankhol', 'Shahbad', 'Sikri Industrial Area', 'Sirsa', 'Siwani', 'Sohna', 'Sonipat', 'Sunari Kalan', 'Taoru', 'Taraori', 'Tohana', 'Tosham', 'Uchana', 'Ugra Kheri', 'Uklanamandi', 'Uncha Siwana', 'Yamunanagar', 'Himachal Pradesh Amb Industrial Area', 'Arki', 'Baddi', 'Baddi Industrial Area', 'Badhal Industrial Area', 'Bagbania Industrial Area', 'Bain Attarian Industrial', 'Area', 'Bakloh', 'Banjar', 'Barotiwala Industrial Area', 'Bhambla Industrial Area', 'Bhota', 'Bhuntar', 'Bilaspur', 'Chail', 'Chamba', 'Chaupal', 'Chuari Khas', 'Dagshai', 'Dalhousie', 'Daulatpur', 'Dera Gopipur', 'Dharampur Industrial', 'Estate', 'Dharmsala', 'Gagret', 'Gagret Industrial Area', 'Garnota Industrial Area', 'Ghumarwin', 'Golthai Industrial Area', 'Gondpur Industrial Area', 'Hamirpur', 'Hatil Industrial Area', 'Hill Top Industrial Estate', 'Indora', 'Jais Industrial Area', 'Jawalamukhi', 'Jhakhri', 'Jharmajri EPIP Phase 1', 'Jogindarnagar', 'Jubbal', 'Jutogh', 'Kala Amb Industrial Area', 'Kangra', 'Kasauli', 'Kasol', 'Keylong', 'Keylong Industrial Estate', 'Khajjiar', 'Kinnaur', 'Kotkhai', 'Kullu', 'Lodhi Majra Industrial', 'Area', 'Manali', 'Mandi', 'Manikaran', 'Mehatpur', 'Moginand Industrial Area', 'Nadaun', 'Nagri Industrial Area', 'Nagrota Bagwan', 'Nahan', 'Naina Devi', 'Nalagarh', 'Narkanda', 'Nurpur', 'Palampur', 'Paonta Sahib', 'Parel Industrial Estate', 'Parwanoo', 'Pragpur', 'Raja Ka Bagh Industrial', 'Area', 'Rajgarh', 'Rampur', 'Ratti Industrial Area Rawalsar', 'Reckong Peo', 'Renuka', 'Rohru', 'Sabathu', 'Sansarpur Terrace Growth', 'Centre Industrial Area', 'Santokhgarh', 'Sarkaghat', 'Sauli Khad Industrial Area', 'Seoni', 'Shamshi Industrial Area', 'Shimla', 'Shivnagari Holi Industrial', 'Estate', 'Shoghi', 'Shoghi Industrial Area', 'Solan', 'Solang', 'Sundarnagar', 'Tahliwala Industrial Area', 'Talai', 'Theog', 'Tira Sujanpur', 'Una', 'Achabal', 'Akhnoor', 'Anantnag', 'Arnia', 'Arwani', 'Ashmuji Khalsa', 'Awantipora', 'Bandipore', 'Banihal', 'BaramulaJammu & Kashmir Bari Brahmana EPIP', 'Industrial Estate', 'Bashohli', 'Batote', 'Beerwah', 'Bhaderwah', 'Bijbehara', 'Billawar', 'Bishna', 'Chenani', 'Choglamsar', 'Dachigam', 'Doda', 'Dras', 'Duru Verinag', 'Ganderbal', 'Gho Manhasan', 'Gorah Salathian', 'Gulmarg', 'Hajan', 'Handwara', 'Hanle', 'Hiranagar', 'Jammu', 'Jourian', 'Kargil', 'Kathua', 'Katra', 'Khan Sahib', 'Khilanmarg', 'Khour', 'Khrew', 'Kishtwar', 'Kud', 'Kukernag', 'Kulgam', 'Kunzer Kupwara', 'Leh', 'Magam', 'Mattan', 'Mohmmad Pora', 'Nowgam', 'Nowshehra', 'Pahalgam', 'Parole', 'Patnitop', 'Pattan', 'Pulwama', 'Punch', 'Qaimoh', 'Qazigund', 'Rajauri', 'Ramban', 'Ramgarh', 'Ramnagar', 'Ranbirsinghpora', 'Reasi', 'Rehambal', 'Samba', 'Seer Hamdan', 'Shangus', 'Shopian', 'Soolkoot', 'Sopore', 'Srinagar', 'Sumbal', 'Sunderbani', 'Talwara', 'Thanamandi', 'Tral', 'Udhampur', 'Uri', 'Vijay PoreJharkhand', 'AEC Complex', 'Akdoni Khurd', 'Alagdiha', 'Amlabad', 'Angarpathar', 'Ara', 'Bachra', 'Baharagora', 'Baliapur', 'Baliari', 'Balkundra', 'Barajamda', 'Bardubhi', 'Barharwa', 'Barhi', 'Barkakana', 'Barki Saraiya', 'Barora', 'Barughutu', 'Barwadih', 'Basaria', 'Basukinath', 'Baua Kalan', 'Bekobar', 'Berhait Bazar', 'Bermo', 'Bhagatdih', 'Bhandra', 'Bhandra Bokaro District', 'Bhim Kanari', 'Bhojudih', 'Bhowrah', 'Bhuli', 'Bishnugarh', 'Bishrampur', 'Bishrampur Latehar District', 'Bokaro Steel City', 'Bokaro Thermal', 'Bongabar', 'Borio', 'Bundu', 'Bursera', 'Chaibasa', 'Chain Pur', 'Chakradharpur', 'Chakulia', 'Chandaur', 'Chandil', 'Chandrapura', 'Chandwa', 'Charhi', 'Chatra', 'Chauparan', 'Chhatatanr', 'Chhotaputki', 'Chiria', 'Chirkunda', 'Churi', 'Daltonganj', 'Danguwapasi', 'Dari', 'Deoghar', 'Deorikalan', 'Dhanbad', 'Dhanwar', 'Dhaunsar', 'Domchanch', 'Dugda', 'Dumarkunda', 'Dumka', 'Egarkunr', 'Garhwa Ghagra', 'Ghatshila', 'Gidi', 'Giridih', 'Gobindpur', 'Godda', 'Godhar', 'Gomoh', 'Gua', 'Gumia', 'Gumla', 'Haludpukhur', 'Hariharpur', 'Harina', 'Hasir', 'Hazaribagh', 'Hesla', 'Hussainabad', 'Irba', 'Isri', 'Jadugora', 'Jagannathpur', 'Jai Nagar', 'Jamadoba', 'Jamshedpur', 'Jamtara', 'Jangalpur', 'Jaridih Bazar', 'Jasidih', 'Jena', 'Jharia', 'Jharia Khas', 'Jhinghipahari', 'Jhinkpani', 'Jhumri Tilaiya', 'Jorapokhar', 'Kailudih Kalikapur', 'Kandra', 'Kanke', 'Karma', 'Karma Chatra District', 'Karma Tanr', 'Karmatanr', 'Kathhara', 'Katras', 'Kedla', 'Kenduadih', 'Kharkhari', 'Kharsawan', 'Khelari', 'Khunti', 'Kiriburu', 'Kodarma', 'Kuju', 'Kumarpur', 'Kumarpur Sahibganj', 'District', 'Kurpania', 'Kustai', 'Lakarka', 'Lalpania', 'Lapanga', 'Latehar', 'Lohardaga', 'Loyabad', 'Madhuban', 'Madhupur', 'Mahagma', 'Mahesh Mundi', 'Mahuda', 'Maithon', 'Majhion', 'Makoli', 'Malkera', 'Mandu', 'Manohar Pur', 'Marar', 'Marma', 'Matigara', 'Mera', 'Meru', 'Mihijam', 'Mugma', 'Muraidih', 'Muri', 'Musabani', 'Nagri Kalan', 'Narra', 'Netarhat', 'Nirsa', 'Noamundi', 'Okni No 2', 'Orla', 'Pakaur', 'Palawa', 'Panchet', 'Panrra', 'Paratdih', 'Pathardih', 'Patra', 'Patratu', 'Phusro', 'Pondarkanali', 'Rajbhita', 'Rajmahal', 'Ramgarh Cantonment', 'Ranchi', 'Ratu', 'Rehla', 'Religara Rohraband', 'Sahibganj', 'Sahnidih', 'Sanri', 'Saraidhela', 'Saram', 'Sarauni', 'Satgawan', 'Saunda', 'Seraikela', 'Sewai', 'Shahpur', 'Sijhua', 'Sijua', 'Simdega', 'Sindri', 'Sinduria', 'Sini', 'Sirka', 'Siuliban', 'Suranga', 'Tapin', 'Tati', 'Telo', 'Telodih', 'Tenu', 'Tin Pahar', 'Tisra', 'Topa', 'Topchanchi', 'Torpa', 'Toto', 'Tundiul', 'Urimari', 'AddurKarnataka Adityapatna', 'Adyar', 'Afzalpur', 'Agumbe', 'Aland', 'Alevoor', 'Allipura', 'Alnavar', 'Alur', 'Amaravathi', 'Ambikanagara', 'Amble Industrial Area', 'Aminagad', 'Ankola', 'Annigeri', 'Arasinakunte', 'Arkalgud', 'Arkula', 'Arsikere', 'Athni', 'Aurad', 'Aversa', 'Bada', 'Badagaulipady', 'Badami', 'Bagalkot', 'Bagepalli', 'Bail Hongal', 'Bandipur', 'Bangarapet', 'Bangarpet Industrial Area', 'Bankapura', 'Bannur', 'Bantval', 'Basavakalyan', 'Basavana Bagevadi', 'Belgaum Bellary', 'Beltangadi', 'Belur', 'Belur Industrial Area', 'Benakanahalli', 'Bengaluru', 'Bethamangala', 'Bhadravati', 'Bhalki', 'Bhatkal', 'Bhimarayanagudi', 'Bidadi', 'Bidadi Industrial Area', 'Bidar', 'Bijapur', 'Bilgi', 'Birur', 'Bobruwada', 'Byadgi', 'Challakere', 'Chamarajanagar', 'Channagiri', 'Channapatna', 'Channarayapatna', 'Chelur', 'Chik Ballapur', 'Chikballapur Industrial', 'Area', 'Chikkajajur', 'Chikmagalur', 'Chiknayakanhalli', 'Chikodi', 'Chincholi', 'Chintamani', 'Chitapur', 'Chitgoppa', 'Chitradurga Dandeli', 'Dargajogihalli', 'Davanagere', 'Devadurga', 'Devanahalli', 'Dharwad', 'Dobaspet Industrial Area', 'Dod Ballapur', 'Doddaballapur Industrial', 'Area', 'Doddaballapura Apparel', 'Park', 'Donimalai Township', 'Elwala', 'Gadag Betigeri', 'Gajendragarh', 'Gangawati', 'Ganjimutt', 'Gargeswari', 'Gauribidanur', 'Gejjalagere Industrial Area', 'Gogipeth', 'Gokak', 'Gokak Falls', 'Gonikoppal', 'Gubbi', 'Gudibanda', 'Gudur', 'Gulbarga', 'Guledgudda', 'Gundlupet', 'Gurmatkal', 'Halga', 'Haliyal', 'Hampi', 'Hangal', 'Hanur Haralahalli', 'Haralapura', 'Harapanahalli', 'Harihar', 'Harohalli Industrial Area', 'Hassan', 'Hatti', 'Hatti Gold Mines', 'Haveri', 'HD Kote', 'Heroor', 'Hirehally Industrial Area', 'Hirekerur', 'Hiriyur', 'Holalkere', 'Hole Narsipur', 'Homnabad', 'Honaga Industrial Area', 'Honavar', 'Honnali', 'Hoovina Hadagalli', 'Hosanagara', 'Hosdurga', 'Hoskote', 'Hoskote Industrial Area', 'Hospet', 'Hubli', 'Hukeri', 'Huliyar', 'Humnabad Industrial Area', 'Hungund', 'Hunsur', 'Ilkal', 'Indi', 'Jagalur', 'Jamkhandi', 'Jevargi Jog Falls', 'JSW Steel Plant', 'Kadakola', 'Kadur', 'Kadwad', 'Kairangala', 'Kakati Industrial Area', 'Kalghatgi', 'Kamalapuram', 'Kamalnagar', 'Kamatgi', 'Kampli', 'Kanakapura', 'Kariyangala', 'Karkal', 'Karwar', 'Kemmannugundi', 'Kerur', 'Khanapur', 'Khangaon', 'Kodiyal', 'Kolambe', 'Kolar', 'Kollegal', 'Kollur', 'Konnur', 'Koppa', 'Koppal', 'Koratagere', 'Koteshwar', 'Kotturu', 'Krishnaraja Sagara', 'Krishnarajanagara', 'Krishnarajpet', 'Kudchi', 'Kudligi', 'Kudremukh Kudur', 'Kumta', 'Kundapura', 'Kundgol', 'Kunigal', 'Kunigal Industrial Area', 'Kurekuppa', 'Kurgunta', 'Kushalanagara', 'Kushtagi', 'Kuvettu', 'Lakshmeshwar', 'Lingsugur', 'Londa', 'Machche', 'Maddur', 'Madhugiri', 'Madikeri', 'Magadi', 'Mahalingpur', 'Malavalli', 'Mallar', 'Malur', 'Malur Industrial Area', 'Mandya', 'Mandya Industrial Area', 'Mangalore', 'Manipura', 'Manjanady', 'Manjunath Township', 'Basavkalyan', 'Manvi', 'Manvi Industrial Area', 'Mellahalli', 'Molakalmuru', 'Moodabettu', 'Mouje Nandgad', 'Mudalgi', 'Mudbidri', 'Muddebihal', 'Mudgal', 'Mudhol', 'Mudigere', 'Muduperar', 'Mulbagal', 'Mulgund', 'Mulki', 'Mulur', 'Mundargi', 'Mundargi Industrial Area', 'Mundgod', 'Munirabad Project Area', 'Munnuru', 'Mutga', 'Mutga Gulbarga District', 'Mysore', 'Nadsal', 'Nagamangala', 'Nandi', 'Nandur Kesartigi Industrial', 'Area', 'Nanjangud', 'Narasapura Industrial', 'Area', 'Narasimharajapura', 'Naregal', 'Nargund', 'Narikombu', 'Navalgund', 'Navoor', 'Nelamangala', 'Nipani', 'Pandavapura', 'Pattadakal Pavagada', 'Periyapatna', 'Pudu', 'Puttur', 'Rabkavi-Banhatti', 'Raichur', 'Raichur Growth Centre', 'Industrial Area', 'Ramanagara', 'Ramdurg', 'Ranebennur', 'Raybag', 'Robertsonpet', 'Ron', 'Sadalgi', 'Sagagur', 'Sagar', 'Sajipanadu', 'Sakleshpur', 'Saligram', 'Sambra', 'Sandur', 'Sankeshwar', 'Sanoor', 'Sathyamangala', 'Sattur', 'Saundatti-Yellamma', 'Savanur', 'Sedam', 'Shahabad', 'Shahabad ACC', 'Shahpur', 'Shaktinagar', 'Shiggaon', 'Shikarpur', 'Shimoga', 'Shirawad Industrial Area Shirhatti', 'Shorapur', 'Shravanabelgola', 'Siddapur', 'Sidlaghatta', 'Sindgi', 'Sindhnur', 'Sira', 'Siralkoppa', 'Sirsi', 'Siruguppa', 'Solebhavi', 'Somanahalli Industrial', 'Area', 'Somvarpet', 'Sorab', 'Sringeri', 'Srinivaspur', 'Srirampura', 'Srirangapatna', 'Sulya', 'T Narsipura', 'Talikota', 'Talipady', 'Tarikere', 'Tattilli', 'Tekkalakote', 'Terdal', 'Thandya Industrial Estate', 'Thimmenahalli Industrial', 'Area', 'Thumbe', 'Tiptur', 'Tirthahalli', 'Tumkur', 'Turuvekere', 'Udupi Ullal', 'Uppinangady', 'Vaddu', 'Varamballi', 'Vasantha Narasapura', 'Industrial Area', 'Venkatapura', 'Vijayapura', 'Virajpete', 'Vittal', 'Wadi', 'Yadgir', 'Yelandur', 'Yelbarga', 'Yellapur', 'Yellur', 'Abdu Rahiman Nagar', 'Adat', 'Adichanalloor', 'Adinad', 'Adoor', 'Aimanam', 'Ajanur', 'Akathiyoor', 'Ala', 'Alamcode', 'Alamcode', 'Thiruvananthapuram', 'District', 'Alappuzha', 'Alathur', 'Alur', 'Aluva', 'Amballur', 'AncharakandyKerala Angadipuram', 'Angamaly', 'Anthicad', 'Ariyallur', 'Arookutty', 'Aroor', 'Athirampuzha', 'Athiyannur', 'Atholi', 'Attingal', 'Avanur', 'Avinissery', 'Avittathur', 'Ayancheri', 'Ayanivelikulangara', 'Azhikode', 'Azhiyur', 'Azhoor', 'Balusseri', 'Bangramanjeshwar', 'Beypore', 'Bharanikkavu', 'Brahmakulam', 'Chala', 'Chalakudy', 'Changanacherry', 'Chavakkad', 'Chavara', 'Chekkiad', 'Chelakkara', 'Chelannur', 'Cheleri', 'Chelora', 'Chemancheri', 'Chendamangalam', 'Chendrappini', 'Chengala Chengamanad', 'Chengannur', 'Chennithala', 'Cheppad', 'Cheranallur', 'Cheriyamundam', 'Cherthala', 'Cherukavu', 'Cheruthazham', 'Cheruthuruthi', 'Chevvoor', 'Chingoli', 'Chirakkal', 'Chiramanangad', 'Chiranellur', 'Chittanda', 'Chittur-Thathamangalam', 'Chockli', 'Choolissery', 'Choondal', 'Choornikkara', 'Chowwara', 'Desamangalam', 'Dharmadom', 'Edacheri', 'Edakkode', 'Edappal', 'Edathala', 'Edathirinji', 'Edathiruthy', 'Edavilangu', 'Elampalloor', 'Elayavoor', 'Eloor', 'Enkakkad', 'Eramala', 'Eramalloor Eranellur', 'Eranholi', 'Erattupetta', 'Eravattur', 'Eravu', 'Ernakulam', 'Eruvatti', 'Ettumanoor', 'Eyyal', 'Feroke', 'Guruvayur', 'Haripad', 'Hosabettu', 'Idukki Township', 'Irikkur', 'Irimbiliyam', 'Iringal', 'Iringaprom', 'Irinjalakuda', 'Iriveri', 'Iroopara', 'Kadachira', 'Kadamakkudy', 'Kadannappalli', 'Kadavallur', 'Kadikkad', 'Kadirur', 'Kadungalloor', 'Kaipamangalam', 'Kalady', 'Kalady Ernakulam District', 'Kalamassery', 'Kallelibhagom', 'Kallettumkara', 'Kalliasseri', 'Kalliyoor', 'Kallur- Thekkummuri Kalpetta', 'Kandamkunnu', 'Kandanassery', 'Kanhangad', 'Kanhirode', 'Kaniyarkode', 'Kanjikkuzhi', 'Kanjikode Industrial Area', 'Kanjiramkulam', 'Kannadiparamba', 'Kannamangalam', 'Kannamangalam', 'Alappuzha District', 'Kannapuram', 'Kannur', 'Karamuck', 'Karikkad', 'Karivellur', 'Kariyannur', 'Karthikappally', 'Karunagappally', 'Karuvanthuruthy', 'Kasaragod', 'Kattakampal', 'Kattanam', 'Kattappana', 'Kattipparuthi', 'Kattur', 'Kayamkulam', 'Keekan', 'Keerikkad', 'Keezhallur', 'Keezhariyur', 'Kinfra Small Industries', 'Park', 'Kizhakkummuri', 'Kizhuparamba', 'Kizhuppillikkara', 'Kizhuvalam -Koonthalloor', 'Kochi', 'Kodungallur', 'Kodur', 'Koipady', 'Kolacherry', 'Kolavelloor', 'Kolazhy', 'Kollam', 'Komalapuram', 'Kondotty', 'Koodali', 'Koothali', 'Koothuparamba', 'Koottilangadi', 'Koratty', 'Kothamangalam', 'Kottakal', 'Kottamkara', 'Kottappally', 'Kottappuram', 'Kottarakkara', 'Kottayam', 'Kottayam-Malabar', 'Kottuvally', 'Kovalam', 'Kozhenchery', 'Kozhikode', 'Kozhukkallur', 'Kozhukkully', 'Krishnapuram', 'Kudlu', 'Kulasekharapuram', 'Kulathummal', 'Kumarakom', 'Kumaranellur Kumarapuram', 'Kumbalangy', 'Kumily', 'Kunjathur', 'Kunnamkulam', 'Kunnathunad', 'Kunnummal', 'Kurattissery', 'Kureekkad', 'Kurumathur', 'Kurumpilavu', 'Kuruvattur', 'Kuthiathode', 'Kuttiattoor', 'Kuttippuram', 'Madhur', 'Malappuram', 'Manakkody', 'Manakunnam', 'Manalur', 'Manantheri', 'Manavalassery', 'Mangalpady', 'Mangattidam', 'Maniyat', 'Maniyoor', 'Maniyur', 'Manjeri', 'Manjeshwar', 'Mannanchery', 'Mannar', 'Mannarkad-I', 'Marampilly', 'Marancheri', 'Marathakkara', 'Mattannur', 'Mavelikkara Mavilayi', 'Mavoor', 'Mayyanad', 'Mayyil', 'Meenad', 'Menhaniam', 'Meppayyur', 'Mokeri', 'Moonniyur', 'Muhamma', 'Mulamthuruthy', 'Mulavukad', 'Mullassery', 'Mundathikode', 'Munderi', 'Munnar', 'Muthukulam', 'Muthuthala', 'Muvattupuzha', 'Muzhappilangad', 'Nadapuram', 'Nadathara', 'Naduvannur', 'Naduvattom', 'Nanmanda', 'Nannambra', 'Narath', 'Nattakam', 'Nedumangad', 'Nedumpana', 'Nedumpura', 'Neduva', 'Nelluwaya', 'Nenmenikkara', 'New Mahe', 'Neyyattinkara', 'Nilambur Njarackal', 'North -Thrikkaripur', 'Oachira', 'Olavanna', 'Ongallur- I', 'Ongallur- II', 'Othukkungal', 'Ottappalam', 'Padiyam', 'Padiyur', 'Paduvilayi', 'Palai', 'Palakkad', 'Palayad', 'Palissery', 'Pallichal', 'Pallikkal', 'Pallikkara', 'Pallikkunnu', 'Pallippuram', 'Pallippuram', 'Thiruvananthapuram', 'District', 'Pallippuram Thrissur', 'District', 'Paluvai', 'Panachikkad', 'Panangad', 'Panangad Kozhikode', 'District', 'Panayam', 'Panmana', 'Panniyannur', 'Panoor', 'Pantheeramkavu', 'Pappinisseri', 'Pappinivattom Parakkad', 'Parappukkara', 'Parappur', 'Parassala', 'Parasuvaikkal', 'Paravoor', 'Paravur', 'Pariyaram', 'Pathanamthitta', 'Pathirappally', 'Pathiriyad', 'Pathiyoor', 'Pattiom', 'Pavaratty', 'Payyannur', 'Pazhanji', 'Peermade', 'Perakam', 'Peralasseri', 'Perinad', 'Peringathur', 'Perinjanam', 'Perinthalmanna', 'Perole', 'Perumanna', 'Perumbaikad', 'Perumbavoor', 'Peruvallur', 'Pilicode', 'Pinarayi', 'Ponmundam', 'Ponnani', 'Poomangalam', 'Poothakkulam', 'Porathissery', 'Pottore', 'Pudussery Central Pudussery West', 'Pullur', 'Punalur', 'Punnayur', 'Punnayurkulam', 'Puranattukara', 'Puthencruz', 'Puthukkad', 'Puthunagaram', 'Puthuppally', 'Puthur', 'Puzhathi', 'Quilandy', 'Ramanattukara', 'Shiriya', 'Shoranur', 'South - Thrikkaripur', 'Talakkad', 'Talikkulam', 'Taliparamba', 'Tanalur', 'Thaikattussery', 'Thaikkad', 'Thalakkulathur', 'Thalassery', 'Thangalur', 'Thanniyam', 'Thazhakara', 'Thazhecode', 'Thazhuthala', 'Thekkumkara', 'Thennala', 'Thikkody', 'Thirumittacode-II', 'Thirunavaya', 'Thiruvalla', 'Thiruvananthapuram Thiruvankulam', 'Thodiyoor', 'Thodupuzha', 'Thottada', 'Thrikkadavoor', 'Thrikkaruva', 'Thrikkovilvattom', 'Thrippunithura', 'Thrissur', 'Thrithala', 'Thuneri', 'Thurayur', 'Tirur', 'Tirurangadi', 'Trikkur', 'Triprangode', 'Udma', 'Uliyazhathura', 'Ulliyeri', 'Uppala', 'Urakam', 'Vadakara', 'Vadakkekad', 'Vadakkumkara', 'Vadakkummuri', 'Vadakkumthala', 'Vadama', 'Vadanappally', 'Vaikom', 'Vakkom', 'Valapattanam', 'Valayam', 'Vallachira', 'Vandiperiyar', 'Vaniyamkulam-II', 'Varam', 'Varappuzha Varkala', 'Vattappara', 'Vayalar', 'Vazhakkala', 'Vazhakulam', 'Vazhayur', 'Veiloor', 'Vellanikkara', 'Velur', 'Veluthur', 'Venganoor', 'Vengara', 'Vengola', 'Venkitangu', 'Venmanad', 'Vilappil', 'Villiappally', 'Vylathur', 'Vythiri', 'Wadakkanchery', 'Agatti', 'Amini', 'Kavaratti', 'Minicoy', 'Agar', 'Ahirkhedi', 'Ahirkhedi, Indore District', 'Ajaygarh', 'Akoda', 'Akodia', 'Alampur', 'Alirajpur', 'AlotLakshadweep', 'Madhya Pradesh', 'Amanganj', 'Amarkantak', 'Amarpatan', 'Amarwara', 'Ambada', 'Ambah', 'Amkhera', 'Amla', 'Amlai', 'Anjad', 'Antari', 'Anuppur', 'Aron', 'Ashoknagar', 'Ashta', 'Athner', 'Babai', 'Bada-Malhera', 'Badarwas', 'Badi', 'Badkuhi', 'Badnagar', 'Badnawar', 'Badod', 'Badoni', 'Badra', 'Bagh', 'Bagli', 'Baihar', 'Baikunthpur', 'Balaghat', 'Baldeogarh', 'Bamhani', 'Bamor', 'Bamor Morena', 'Bamora', 'Banda Bandhawagarh', 'Bangarda Bada', 'Bangawan', 'Bank', 'Bansatar Kheda', 'Baragaon', 'Baragaon Shajapur', 'Barauda', 'Barela', 'Bareli', 'Barghat', 'Bargi', 'Barhi', 'Barigarh', 'Barman Kalan', 'Baroda', 'Barwaha', 'Barwaha Kasba', 'Barwani', 'Basoda', 'Begamganj', 'Beohari', 'Berasia', 'Betma', 'Betul', 'Betul Bazar', 'Bhainsa', 'Bhainsdehi', 'Bhander', 'Bhanpura', 'Bharveli', 'Bhavra', 'Bhedaghat', 'Bhicholi Hapsi', 'Bhikangaon', 'Bhilakhedi', 'Bhind Bhitarwar', 'Bhonrasa', 'Bhopal', 'Biaora', 'Bichhiya', 'Bichhiya Vidisha District', 'Bijawar', 'Bijuri', 'Bilaua', 'Bina', 'Birsinghpur', 'Boda', 'Borgaon', 'Budni', 'Burhanpur', 'Burhar', 'Buxwaha', 'Chachaura-Binaganj', 'Chakghat', 'Chandameta Butaria', 'Chanderi', 'Chandia', 'Chandla', 'Chaurai Khas', 'Chhapiheda', 'Chhatarpur', 'Chhattarpur', 'Chhindwara', 'Chhipabad', 'Chhota Chhindwara', 'Chichli', 'Chicholi', 'Chitrakoot', 'Churhat', 'Daboh', 'Dabra', 'Dahi Damoh', 'Damua', 'Datia', 'Dehrisaray', 'Deodara', 'Deohara', 'Deori', 'Deori, Shahdol District', 'Depalpur', 'Devendranagar', 'Dewas', 'Dhamnod', 'Dhamnod Ratlam District', 'Dhana', 'Dhanpuri Nargada Hari', 'Dafai', 'Dhar', 'Dharampuri', 'Dhodaramohar Alias', 'Bhoura', 'Dighawani', 'Diken', 'Dindori', 'Dola', 'Dongar Parasia', 'Dumar Kachhar', 'Dungariya Chhapara', 'Emlikheda Industrial Area', 'Gadarwara', 'Gairatganj', 'Gamiria Sagar', 'Gandhi Sagar Haidel', 'Garhakota', 'Garhi -Malhara', 'Garoth', 'Garra', 'Gautampura Ghansaur', 'Ghoda Dongri Ryt', 'Ghuwara', 'Gogapur', 'Gohad', 'Gormi', 'Govindgarh', 'Guna', 'Gurh', 'Gwalior', 'Hanumana', 'Harda', 'Harduli', 'Harpalpur', 'Harrai', 'Harsud', 'Hat Piplia', 'Hatod', 'Hatpiplya', 'Hatta', 'Hindoria', 'Hirapur', 'Hirdepur', 'Hoshangabad', 'Ichhawar', 'Iklehra', 'Indergarh', 'Indore', 'Industrial Area Jagakhedi', 'Isagarh', 'Itarsi', 'Jabalpur', 'Jabera', 'Jaisinghnagar', 'Jaithari', 'Jaitpur', 'Jaitpur Chhatarpur District Jaitwara', 'Jamai', 'Jaora', 'Jata Chhapar', 'Jatara', 'Jawad', 'Jawar', 'Jaypee Nagar', 'Jeron Khalsa', 'Jhabua', 'Jhundpura', 'Jiran', 'Jirapur', 'Jobat', 'Joura', 'Kailaras', 'Kakarhati', 'Kali Chhapar', 'Kanad', 'Kannod', 'Kantaphod', 'Kareli', 'Karera', 'Kari', 'Karnawad', 'Karrapur', 'Kasrawad', 'Katangi', 'Katangi, Jabalpur District', 'Kelhauri', 'Keolari', 'Khacharod', 'Khairi', 'Khajuraho', 'Khand', 'Khandwa', 'Khaniyadhana Khargapur', 'Khargone', 'Khategaon', 'Khetia', 'Khilchipur', 'Khirkiya', 'Khor', 'Khujner', 'Khurai', 'Kirnapur', 'Kolar', 'Kolaras', 'Kosmi', 'Kotar', 'Kothi', 'Kothri', 'Kotma', 'Kukdeshwar', 'Kukshi', 'Kumbhraj', 'Kundam', 'Kurwai', 'Kymore', 'Ladhaura', 'Lahar', 'Lakhnadon', 'Lanji', 'Lateri', 'Laundi', 'Lodhikheda', 'Loharda', 'Machalpur', 'Madai', 'Madhawgdha', 'Maharajpur', 'Maheshwar', 'Mahidpur Mahura', 'Maihar', 'Maihar Cement Factory', 'Sarlanagar', 'Majhgawan', 'Majhgawan Jabalpur', 'District', 'Majhgawan Township', 'Majholi', 'Makdon', 'Makronia Buzurg', 'Maksi', 'Malajkhand', 'Malanpur Industrial Area', 'Malhargarh', 'Maliya Guda', 'Manasa', 'Manawar', 'Mandideep', 'Mandla', 'Mandleshwar', 'Mandsaur', 'Mandu', 'Maneri Industrial Growth', 'Centre', 'Mangalya', 'Mangawan', 'Manpur', 'Mau', 'Mauganj', 'Meghnagar', 'Mehgaon', 'Mhow', 'Mihona', 'Mohgaon', 'Morar Cantt', 'Morena', 'Multai', 'Mundi', 'Mungaoli', 'Murwara Katni', 'Nagda', 'Nagod', 'Nagri', 'Nai-Garhi', 'Nainpur', 'Nalkheda', 'Namli', 'Nanpur', 'Narayangarh', 'Narsimhapur', 'Narsingarh', 'Narsinghgarh', 'Narwar', 'Nasrullaganj', 'Naudhia', 'Neemuch', 'Nepanagar', 'New Harsud', 'Newton Chikhli Kalan', 'Niwari', 'Niwas', 'Nowgong', 'Nowrozabad', 'Omkareshwar', 'Orchha', 'Ordnance Factory Itarsi', 'Pachmarhi', 'Pachore', 'Pal Chaurai', 'Palera', 'Palsud', 'Panagar', 'Panara Pandhana', 'Pandhurna', 'Pandhurna Industrial Area', 'Pankhedi', 'Panna', 'Pansemal', 'Pasan', 'Patan', 'Patharia', 'Pawai', 'Petlawad', 'Phuphkalan', 'Pichhore', 'Pichhore, Gwalior District', 'Pindrai', 'Pipalrawan', 'Pipariya', 'Pipariya Jabalpur District', 'Pipariya, Jabalpur District', 'Piplanarayanwar', 'Piploda', 'Piplya Mandi', 'Pipri', 'Pithampur', 'Pithampur Industrial Hub', 'Polaykalan', 'Porsa', 'Prithvipur', 'Purena', 'Raghogarh', 'Rahatgarh', 'Raisen', 'Rajakhedi', 'Rajgarh', 'Rajgarh, Dhar District', 'Rajnagar', 'Rajpur Rampur', 'Rampur Baghelan', 'Rampura', 'Ranapur', 'Ranipur', 'Ratangarh', 'Ratlam', 'Rau', 'Raymond Chhindwara', 'Raymond Colony Vijay', 'Gram', 'Rehli', 'Rehti', 'Rewa', 'Rosera', 'Sabalgarh', 'Sabo', 'Sagar', 'Sailana', 'Sanawad', 'Sanchi', 'Sangvi', 'Sanjay Gandhi Thermal', 'Power Station', 'Sanwer', 'Sarangpur', 'Sardarpur', 'Sarni', 'Satai', 'Satna', 'Satwas', 'Sausar', 'Sehore', 'Semaria', 'Sendhwa', 'Seondha', 'Seoni Seoni-Malwa', 'Sethiya', 'Shahdol', 'Shahgarh', 'Shahpur', 'Shahpur, Betul District', 'Shahpur, Sagar District', 'Shahpura', 'Shahpura, Jabalpur', 'District', 'Shajapur', 'Shamgarh', 'Shamshabad', 'Sheopur', 'Shivpuri', 'Shujalpur', 'Sidgunwa Industrial Area', 'Sidhi', 'Sihora', 'Silwani', 'Singoli', 'Singrauli', 'Sinhasa', 'Sirgora', 'Sirmaur', 'Sironj', 'Sitamau', 'Siya Industrial Area', 'Sohagi', 'Sohagpur', 'Sonkatch', 'Soyatkalan', 'Sultanpur', 'Susner', 'Suswasara', 'Suthaliya', 'Tal Talen', 'Tarana', 'Taricharkalan', 'Tekanpur', 'Tendukheda', 'Tendukheda Damoh', 'District', 'Teonthar', 'Thandla', 'Tikamgarh', 'Timarni', 'Tirodi', 'Tonk Khurd', 'Ubaidullahganj', 'Udaipura', 'Udaypur', 'Ujjain', 'Ukwa', 'Umaria', 'Unchahara', 'Unhel', 'Vidisha', 'Vijaypur Sheopur District', 'Vijayraghavgarh', 'Vindhya Nagar NTPC', 'Waraseoni', 'Aamby Valley', 'Achalpur', 'Achalpur MIDC', 'Additional Chandrapur', 'Aheri', 'Ahmadnagar', 'Ahmadpur', 'Ahmadpur MIDCMaharashtra Ajanta', 'Ajara', 'Ajara MIDC', 'Akkalkot', 'Akkalkuwa', 'Akluj', 'Akola', 'Akot', 'Alandi', 'Alibag', 'Allapalli', 'Amalner', 'Amalner MIDC', 'Ambad', 'Ambarnath', 'Ambejogai', 'Ambepur', 'Ambivali Tarf Wankhal', 'Amboli', 'Amgaon', 'Amravati', 'Anjangaon', 'Anjarle', 'Arvi', 'Asangaon', 'Asangaon Industrial Area', 'Ashta', 'Ashti', 'Ashti Gadchiroli District', 'Ashti MIDC', 'Ashti Wardha District', 'Atgaon Industrial Complex', 'Aurangabad', 'Ausa', 'Awalpur', 'Babhaleshwar', 'Babhulgaon Badlapur', 'Balapur', 'Balapur Akola District', 'Balapur MIDC', 'Ballarpur', 'Banda', 'Baramati', 'Barshi', 'Basmat MIDC', 'Basmath', 'Bela', 'Bhabale MIDC', 'Bhadgaon', 'Bhadravati', 'Bhadravati MIDC', 'Bhalar Township', 'Bhandara', 'Bhandara MIDC', 'Bhatkuli', 'Bhatkuli MIDC', 'Bhiwandi', 'Bhiwapur', 'Bhiwapur MIDC', 'Bhokar', 'Bhokardan', 'Bhor', 'Bhum', 'Bhusawal', 'Bhusawal MIDC', 'Bid', 'Biloli', 'Birwadi', 'Bisur', 'Boisar', 'Borgaon', 'Bori', 'Borivali Tarf Rahur Borkhedi', 'Borli Panchtan', 'Brahmanvel MIDC', 'Brahmapuri', 'Budhagon', 'Budhgaon', 'Buldana', 'Butibori', 'Butibori MIDC', 'Chakan', 'Chalisgaon', 'Chandgad', 'Chandrapur', 'Chandrapur CGGC', 'Chandrapur MIDC', 'Chandur', 'Chandur Amravati District', 'Chandurbazar', 'Chandvad', 'Chicholi', 'Chikhala', 'Chikhaldara', 'Chikhli', 'Chimur', 'Chinchani', 'Chincholi MIDC', 'Chiplun', 'Chitegaon', 'Chopda', 'Chowk', 'Dabhol', 'Dadar', 'Dahanu', 'Dahivadi', 'Dandi', 'Dapoli', 'Dapoli Camp', 'Darwha', 'Daryapur Banosa', 'Dattapur Dhamangaon', 'Daund', 'Deglur', 'Deglur MIDC', 'Dehu', 'Dehu Cantt', 'Deogiri', 'Deola', 'Deolali Pravara', 'Deoli', 'Deoni', 'Deori', 'Desaiganj', 'Deulgaon Raja', 'Deulgaon Raja MIDC', 'Devgad', 'Devrukh', 'Dharangaon', 'Dharmabad', 'Dharni', 'Dharni MIDC', 'Dharur', 'Dharur MIDC', 'Dhopatala', 'Dhule', 'Digras', 'Dindori', 'Dindori MIDC', 'Dodamarg', 'Dondaicha Warwade', 'Dudhani', 'Durgapur', 'Eklahare', 'Elephanta Caves', 'Ellora Erandol', 'Etapalli', 'Faizpur', 'Gadchiroli', 'Gadhinglaj', 'Gadhinglaj MIDC', 'Gane MIDC', 'Ganeshpur', 'Gangakhed', 'Gangapur', 'Ganpatipule', 'Gargoti', 'Genesis Industrial', 'Township', 'Georai', 'Ghansawangi', 'Ghatanji', 'Ghoti', 'Ghugus', 'Ghulewadi', 'Gokunda', 'Gondia MIDC', 'Gondiya', 'Gondpipri', 'Goregaon', 'Goregaon Gondiya District', 'Goregaon MIDC', 'Guhagar', 'Hadgaon', 'Hajarmachi', 'Halkarni MIDC', 'Harihareshwar', 'Harsul', 'Hatkanangle', 'Himayatnagar', 'Hindnagar', 'Hinganghat Hinganghat MIDC', 'Hingna', 'Hingoli', 'Hingoli MIDC', 'Honad Industrial Area', 'Hudkeshwar', 'Hupari', 'Ichalkaranji', 'Igatpuri', 'Indapur', 'Indapur MIDC', 'Jafrabad', 'Jafrabad MIDC', 'Jalgaon', 'Jalgaon Jamod', 'Jalkot', 'Jalna', 'Jalochi', 'Jamkhed', 'Jamner', 'Jath', 'Jawhar', 'Jawharnagar', 'Jaysingpur', 'Jejuri', 'Jejuri MIDC', 'Jintur', 'Jintur MIDC', 'Jiwati', 'Junnar', 'Kabnur', 'Kadegaon', 'Kadegaon MIDC', 'Kagal', 'Kagal MIDC', 'Kaij', 'Kalamb Kalameshwar', 'Kalameshwar MIDC', 'Kalamnuri', 'Kallam', 'Kalmath', 'Kalwan', 'Kalyan', 'Kamalapur MIDC', 'Kambe', 'Kamptee', 'Kamptee Cantt', 'Kamshet', 'Kandari', 'Kandhar', 'Kandhar MIDC', 'Kandri', 'Kandri Mines', 'Kandri Nagpur', 'Kanhan', 'Kanhe Industrial Area', 'Kanholibara', 'Kankavli', 'Kannad', 'Karad', 'Karalewadi', 'Karanja', 'Karjat', 'Karjat Ahmadnagar', 'District', 'Karmala', 'Kasara', 'Katangi Kala', 'Katol', 'Katol MIDC', 'Kavalapur', 'Kavathe Mahankal', 'Kelapur Khamari', 'Khamgaon', 'Khanapur', 'Khandala', 'Khandala Satara', 'Khandbara', 'Khapa', 'Khapar', 'Kharbav', 'Khardi', 'Khatav', 'Khed', 'Kherdi', 'Khopoli', 'Kinwat', 'Kolhapur', 'Kolki', 'Kondumal', 'Kopargaon', 'Koradi', 'Korchi', 'Koregaon', 'Koregaon Bhima', 'Korochi', 'Krushnoor MIDC', 'Kudal', 'Kudal MIDC', 'Kudus', 'Kuhi', 'Kumbhari', 'Kundalwadi', 'Kurduwadi', 'Kurduwadi MIDC', 'Kurkheda', 'Kurkumbh MIDC', 'Kurul', 'Kurundvad Kusgaon Budruk', 'Lakhamapur MIDC', 'Lakhandhur', 'Lakshmi Cooperative', 'Industrial Estate', 'Lanja', 'Lasalgaon', 'Lat', 'Latur', 'Latur Industrial Area', 'Additional', 'Lavasa', 'Loha', 'Lohara', 'Lohara Osmanabad', 'Lonand', 'Lonar', 'Lonavala', 'Loni', 'Loni kalbhor', 'Lote Parshuram MIDC', 'Madangad', 'Madha', 'Madhavnagar', 'Mahabaleshwar', 'Mahad', 'Mahad MIDC', 'Mahad MIDC Additional', 'Mahadula', 'Mahagaon', 'Mahagaon MIDC', 'Mahapoli', 'Mahoor', 'Maindargi', 'Majgaon', 'Makranifali', 'Malde Malegaon', 'Malegaon Jahangir', 'Malegaon MIDC', 'Malkapur', 'Malkapur Buldana District', 'Malkapur MIDC', 'Malshiras', 'Malwan', 'Manchar', 'Mandur', 'Mangalvedha', 'Mangrulpir', 'Mangrulpir MIDC', 'Manjlegaon', 'Manmad', 'Manor', 'Manora', 'Mansar', 'Mantha', 'Manwath', 'Maregaon', 'Matheran', 'Mauda', 'Medha', 'Mehkar', 'Mehkar MIDC', 'Mhasla', 'Mhaswad', 'Mohadi', 'Mohadi MIDC', 'Mohol', 'Mohol MIDC', 'Mohpa', 'Mohpada Alias Wasambe', 'Mokhada', 'Morshi', 'Morshi MIDC', 'Motala', 'Mouje Anjanvel', 'Mowad', 'Mudkhed', 'Mukhed', 'Muktainagar', 'Mul', 'Mul MIDC', 'Mulchera', 'Mumbai', 'Murbad', 'Murbad MIDC', 'Murgud', 'Murmadi', 'Murtajapur', 'Murud', 'Murum', 'Musalgaon MIDC', 'Nagbhid MIDC', 'Nagbhind', 'Nagothana', 'Nagpur', 'Naigaon', 'Nakoda', 'Naldurg', 'Nampur', 'Nanda', 'Nanded Waghala', 'Nandgaon', 'Nandgaon Khandeshwar', 'Nandgaon Pode', 'Nandgaon Tarf Birwadi', 'Nandgaonpeth MIDC', 'Nandura', 'Nandurbar', 'Narkher', 'Nashik', 'Natepute', 'Navapur', 'Navi Mumbai', 'Ner', 'Neral', 'Newasa', 'Nijampur', 'Nilanga', 'Nimbhore Budruk', 'Niphad', 'Nira', 'Ordnance Factory', 'Bhadravati', 'Osmanabad', 'Ozar', 'Pachora', 'Padagha', 'Padoli', 'Paithan', 'Palam', 'Palghar', 'Pali', 'Palus', 'Palus MIDC', 'Pampalner', 'Panchgani', 'Pandare MIDC', 'Pandharkaoda', 'Pandharpur', 'Panhala', 'Paranda', 'Paratwada', 'Parbhani', 'Parli', 'Parner', 'Parola Parshioni', 'Partur', 'Partur MIDC', 'Patalganga MIDC', 'Patan', 'Patan MIDC', 'Pathan MIDC', 'Pathardi', 'Pathri', 'Patoda', 'Patur', 'Pauni', 'Peint', 'Peint MIDC', 'Pen', 'Phaltan', 'Pimpalgaon Baswant', 'Pimpri Chinchwad', 'Pipri', 'Pirangut', 'Poladpur', 'Pombhurna', 'Pulgaon', 'Pune', 'Purna', 'Purushottamnagar', 'Pusad', 'Pusad MIDC', 'Radhanagari', 'Rahata', 'Rahimatpur', 'Rahuri', 'Rajapur', 'Rajgurunagar', 'Rajur', 'Rajur Ahmadnagar District', 'Rajura Ralegaon', 'Ramtek', 'Ranjangaon', 'Ranjangaon MIDC', 'Rasal Industrial Area', 'Ratnagiri', 'Raver', 'Rees', 'Renapur', 'RIL Township', 'Risod', 'Roha Ashtami', 'Roha MIDC', 'Sadak Arjuni', 'Sadavali MIDC', 'Saidapur', 'Sakoli', 'Sakri', 'Salekasa', 'Samudrapur', 'Samudrapur MIDC', 'Sanaswadi', 'Sangameshwar', 'Sangamner', 'Sangamner MIDC', 'Sangli Miraj Kupwad', 'Sangole', 'Saoner MIDC', 'Sasti', 'Sasvad', 'Satana', 'Satara', 'Savda', 'Savner', 'Sawali', 'Sawangi Megh', 'Sawantwadi Seloo', 'Selu', 'Sengaon', 'Shahada', 'Shahapur', 'Shahapur Bhandara', 'District', 'Shani Shingnapur', 'Shegaon', 'Shendra MIDC', 'Shendurjana', 'Shevgaon', 'Shikrapur', 'Shinde MIDC', 'Shirala', 'Shirala MIDC', 'Shirdi', 'Shirgaon', 'Shirgaon Industrial Area', 'Shirol', 'Shirpur', 'Shirur', 'Shirur Anantpal', 'Shirur Kasar', 'Shirwal', 'Shivaji Nagar', 'Shrigonda', 'Shrirampur', 'Shrivardhan', 'Sillewara', 'Sillod', 'Sindewahi', 'Sindewahi MIDC', 'Sindi', 'Sindkhed Raja', 'Sindkheda', 'Singnapur Kopargaon Sinnar', 'Sinnar MIDC', 'Sironcha', 'Solapur', 'Sonai', 'Sonegaon', 'Songirwadi', 'Sonpeth', 'Supa MIDC', 'Surgana', 'Tadali', 'Takalghat', 'Takwe Industrial Area', 'Tala', 'Talasari', 'Talegaon Dabhade', 'Talegaon MIDC', 'Taloda', 'Tarapur', 'Tarapur Textile Park', 'Tasawade MIDC', 'Tasgaon', 'Tekadi', 'Telhara', 'Tembhurni MIDC', 'Thana', 'Thane', 'Tirora', 'Tirora MIDC', 'Toranmal', 'Totaladoh', 'Trimbak', 'Tuljapur', 'Tumsar', 'Tumsar Road', 'Udgir', 'Umarga Umarga MIDC', 'Umarkhed', 'Umarsara', 'Umbar Pada Nandade', 'Umred', 'Umred MIDC', 'Umri', 'Uran Islampur', 'Urjagram', 'Usar MIDC', 'Utekhol', 'Vada', 'Vadgaon', 'Vaduj', 'Vaibhawadi', 'Vaijapur', 'Vaijapur MIDC', 'Vangani', 'Vanvadi', 'Varangaon', 'Vasai Virar', 'Vasantnagar', 'Vashind', 'Velhe', 'Vengurla', 'Vijay Durg', 'Vikramgad', 'Vile Bhagad MIDC', 'Vinchur', 'Vinchur MIDC', 'Visapur', 'Vita', 'Vita MIDC', 'Wada', 'Wadgaon', 'Wadi Ratnagiri', 'Wadwani Waghapur', 'Waghoda', 'Wai', 'Wai MIDC', 'Walani', 'Waluj MIDC', 'Walwa', 'Wani', 'Wardha', 'Warora', 'Warora MIDC', 'Warthi', 'Warud', 'Warud MIDC', 'Washi', 'Washim', 'WCL Umred', 'Yavatmal', 'Yavatmal Industrial Area', 'Yawal', 'Yeola', 'Yerkheda', 'Andro', 'Bishnupur', 'Heirok', 'Imphal', 'Jiribam', 'Kakching', 'Kakching Khunou', 'Kangpokpi', 'Kumbi', 'Kwakta', 'Lamlai', 'Lamsang', 'LilongManipur Lilong Imphal West', 'Lilong Thoubal', 'Mayang Imphal', 'Moirang', 'Moreh', 'Nambol', 'Ningthoukhong', 'Oinam', 'Samurou', 'Samurou, Imphal West', 'District', 'Sekmai Bazar', 'Senapati', 'Sikhong Sekmai', 'Sugnu', 'Tamenglong', 'Thongkhong Laxmi Bazar', 'Thoubal', 'Torban', 'Ukhrul', 'Wangjing', 'Wangoi', 'Yairipok', 'Zenhang Lamka', 'Baghmara', 'Cherrapunjee', 'Jowai', 'Mairang', 'Mawlai', 'Nongpoh', 'Nongstoin', 'Resubelpara', 'Shillong', 'Tura', 'UmroiMeghalaya', 'Williamnagar', 'Aizawl', 'Bairabi', 'Biate', 'Champhai', 'Darlawn', 'Hnahthial', 'Khawhai', 'Khawzawl', 'Kolasib', 'Lawngtlai', 'Lengpui', 'Lunglei', 'Mamit', 'N Kawnpui', 'N Vanlaiphai', 'Saiha', 'Sairang', 'Saitual', 'Serchhip', 'Thenzawl', 'Tlabung', 'Vairengte', 'Zawlnuam', 'Changtongya', 'Chumukedima', 'Dimapur', 'Jalukie', 'Kiphire', 'Kohima', 'Longleng', 'Medziphema', 'MokokchungMizoram', 'Nagaland Mon Town', 'Naginimora', 'Peren', 'Pfutsero', 'Phek', 'Satakha', 'Tseminyu', 'Tuensang', 'Tuli', 'Tzudikong', 'Wokha', 'Zunheboto', 'Agastinuagan', 'Anandapur', 'Anandpur', 'Anjira', 'Anjira Jagatsinghapur', 'District', 'Anugul', 'Arjyapalli', 'Asika', 'Athagad', 'Athmallik', 'Badagada', 'Badakodanda', 'Badamba', 'Badmal', 'Balagoda', 'Balakati', 'Balangir', 'Baleshwar', 'Baliguda', 'Balimela', 'Balipatapur', 'BalugaonOrissa Banapur', 'Bandhbahal', 'Bangomunda', 'Bangura', 'Banki', 'Barapali', 'Barbil', 'Bardol', 'Bargarh', 'Baripada', 'Basudebpur', 'Baudhgarh', 'Belagachhia', 'Bellaguntha', 'Belpahar', 'Berhampur', 'Bhadrak', 'Bhakarsahi', 'Bhanjanagar', 'Bhapur', 'Bhatli', 'Bhawanipatna', 'Bhuban', 'Bhubaneswar', 'Bhushan Steel Plant', 'Jharsuguda', 'Bhushan Steel Plant', 'Meramandali', 'Bijepur', 'Binika', 'Biramitrapur', 'Birapratappur', 'Bishama Katak', 'Bonaigarh', 'Borigam', 'Boriguma', 'Brahmabarada Brajarajnagar', 'Budhapanka', 'Buguda', 'Bundia', 'Burla', 'Byasanagar', 'Champua', 'Chandapur', 'Chandili', 'Charibatia', 'Chhatrapur', 'Chikiti', 'Chitrakonda', 'Choudwar', 'Cuttack', 'Dadhapatna', 'Daitari', 'Damanjodi', 'Danara', 'Daringbadi', 'Debagarh', 'Dera Colliery Township', 'Dhamanagar', 'Dhenkanal', 'Digapahandi', 'Dungamal', 'FCI Township', 'G Udayagiri', 'Ganjam', 'Ghantapada', 'Ghatagaon', 'GMR Power Plant', 'Kmalanga', 'Godiputamatiapara', 'Golabandha', 'Gopalpur', 'Gotamara Gourdanda', 'Gudari', 'Gunupur', 'Hinjilicut', 'Hirakud', 'IB Themal Power Plant', 'Banharpali', 'IMFA Therubali', 'Indipur', 'Itamati', 'Jagatsinghapur', 'Jajanga', 'Jajapur', 'Jaleswar', 'Jashipur', 'Jatani', 'Jeypur', 'Jharsuguda', 'Jhumpura', 'Joda', 'JSPL Town Anugul', 'Junagarh', 'Kabatabandha', 'Kaipadar', 'Kalarangiata', 'Kaliapani', 'Kalinga Nagar Industrial', 'Area', 'Kalyanasingpur', 'Kamakshyanagar', 'Kanheipur', 'Kansbahal', 'Kantabanji', 'Kantilo', 'Karanjia', 'Kashinagara', 'Kavisurjyanagar Kendrapara', 'Kendujhar', 'Kesinga', 'Khaliapali', 'Khalikote', 'Khandapada', 'Khariar', 'Khariar Road', 'Khatiguda', 'Khordha', 'Kochinda', 'Kodala', 'Koida', 'Konark', 'Koraput', 'Kotpad', 'Krushnanandapur', 'Kuanrmunda', 'Kukudakhandi', 'Kullada', 'Kunjabangarh', 'L And T Cement Plant', 'Jharsuguda', 'Lanjigarh', 'Lathikata', 'Lochapada', 'Loisinga', 'Madanpur Rampur', 'Majhihara', 'Makundapur', 'Malkangiri', 'Meghahatuburu', 'Mohana', 'Mukhiguda', 'Mundamarai', 'Nabarangapur', 'Nalco Nayagarh', 'New Lalsingi', 'Nilagiri', 'Nimapada', 'NTPC Kaniha', 'Nuahata', 'Nuapatna', 'OCL Industrial Township', 'Odagaon', 'Padmapur', 'Palalahada', 'Palurgada', 'Papadahandi', 'Paradip', 'Parlakhemundi', 'Pathar', 'Patnagarh', 'Patrapur', 'Pattamundai', 'Phulabani', 'Pipili', 'Pitala', 'Polasara', 'Puri', 'Purusottampur', 'R Udayagiri', 'Raighar', 'Rairangpur', 'Rajagangapur', 'Rajasunakhala', 'Rambha', 'Ranapurgada', 'Rayagada', 'Redhakhol', 'Remuna', 'Rengali', 'Rengali Dam Project Township', 'Rourkela', 'Sambalpur', 'Saranga', 'Sayadpur', 'Sheragada', 'Sohela', 'Sonapur', 'Soro', 'Subalaya', 'Sunabeda', 'Sundargarh', 'Surada', 'Surala', 'Suvani', 'Talcher', 'Talcher Thermal Power', 'Station Township', 'Tangi', 'Tarbha', 'Tensa', 'Tikarpada', 'Tikarpada Ganjam District', 'Tipo', 'Titlagarh', 'Tusura', 'Udala', 'Umarkote', 'Vedanta Jharsuguda', 'Venketraipur', 'Karaikal', 'Mahe', 'Puducherry', 'Thirumalairayan Pattinam', 'YanamPondicherry', 'Punjab', 'Abohar', 'Adampur', 'Ahmedgarh', 'Ajnala', 'Akalgarh', 'Alawalpur', 'Amargarh', 'Amloh', 'Amritsar', 'Anandpur Sahib', 'Apra', 'Aur', 'Baba Bakala', 'Baddowal', 'Badhni Kalan', 'Balachaur', 'Banga', 'Banur', 'Bareta', 'Bariwala', 'Barnala', 'Baryar', 'Bassi Pathana', 'Batala', 'Bathinda', 'Beas', 'Begowal', 'Beharnpur', 'Behrampur', 'Bhabat', 'Bhadaur', 'Bhadson', 'Bhagha Purana', 'Bhagta BhaiKa', 'Bhankarpur', 'Bhattian Bhawanigarh', 'Bhikhi', 'Bhikhiwind', 'Bhisiana', 'Bhogpur', 'Bhucho Mandi', 'Bhulath', 'Budha Theh', 'Budhlada', 'Bungal', 'Chamkaur Sahib', 'Cheema', 'Chogawan', 'Chohal', 'Daper', 'Dasuya', 'Dera Baba Nanak', 'Dera Bassi', 'Dera Bassi Industrial Area', 'Dhanaula', 'Dharamkot', 'Dhariwal', 'Dhilwan', 'Dhuri', 'Dinanagar', 'Dirba', 'Doraha', 'Faridkot', 'Fatehgarh Churian', 'Fazilka', 'Firozpur', 'Gardhiwala', 'Garhshankar', 'Ghagga', 'Ghanaur', 'Ghoh', 'Giddarbaha Goindwal', 'Goniana', 'Goraya', 'Gurdaspur', 'Guru Har Sahai', 'Hajipur', 'Halwara', 'Handiaya', 'Hariana', 'Hoshiarpur', 'Hussainpur', 'Jagraon', 'Jaitu', 'Jalalabad', 'Jalandhar', 'Jandiala', 'Jandiala, Jalandhar', 'District', 'Jodhan', 'Jugial', 'Kalan', 'Kalanaur', 'Kapurthala', 'Karoran', 'Kartarpur', 'Kathanian', 'Khamanon', 'Khambra', 'Khanauri', 'Khanna', 'Kharar', 'Khemkaran', 'Khilchian', 'Korianwali', 'Kot Fatta', 'Kot Ise Khan', 'Kotkapura Kotla Nihang', 'Kurali', 'Lalru', 'Leather Complex', 'Industrial Area', 'Lehragaga', 'Lohian Khas', 'Longowal', 'Ludhiana', 'Machhiwara', 'Mahilpur', 'Majitha', 'Makhu', 'Malaut', 'Malerkotla', 'Mallanwala Khass', 'Maloud', 'Mamun', 'Mandi Govindgarh', 'Mansa', 'Manwal', 'Maur', 'Mirpur', 'Moga', 'Mohali', 'Moonak', 'Morinda', 'Mubarakpur', 'Mudal', 'Mudki', 'Mukerian', 'Muktsar', 'Mullanpur Dakha', 'Mullanpur Garib Dass', 'Nabha', 'Nag Kalan Industrial Area', 'Nakodar Nangal', 'Nangli', 'Narot Mehra', 'Nawanshahr', 'Nehon', 'Nurmahal', 'Pathankot', 'Patiala', 'Patran', 'Patti', 'Payal', 'Phagwara', 'Phillaur', 'Qadian', 'Rahon', 'Raikot', 'Rail', 'Raipur Rasulpur', 'Raja Sansi', 'Rajpura', 'Rakri', 'Raman', 'Ramdas', 'Rampura Phul', 'Rayya', 'Rupnagar', 'Rurki Kasba', 'Sahnewal', 'Saloh', 'Samana', 'Samrala', 'Sanaur', 'Sangat', 'Sangrur', 'Sansarpur', 'Sarai Khas', 'Sardulgarh Satyewala', 'Shahkot', 'Sham ChaurasI', 'Shikar', 'Sirhind Fatehgarh Sahib', 'Sri Hargobindpur', 'Sujanpur', 'Sultanpur', 'Sunam', 'Talwandi Bhai', 'Talwandi Sabo', 'Talwara', 'Tapa', 'Tarantaran', 'Tharial', 'Tibri', 'Tungaheri', 'Urmar Tanda', 'Zira', 'Zirakpur', 'Abu Road', 'Ahore', 'Ajeetgarh', 'Ajmer', 'Ajolion Ka Khera Industrial', 'Area', 'Aklera', 'Aligarh', 'Alwar', 'Amet', 'Antah', 'Anupgarh', 'AsindRajasthan Atru', 'Babai', 'Baggar', 'Bagru', 'Bakani', 'Bali', 'Balotra', 'Banasthali', 'Bandikui', 'Banera', 'Bangur Nagar', 'Banswara', 'Bar', 'Baral', 'Baran', 'Bari', 'Bari Sadri', 'Barmer', 'Baskhoh', 'Basni Belima', 'Bassi', 'Bay', 'Bayana', 'Beawar', 'Beejoliya Kalan', 'Begun', 'Behror', 'Bewanja Industrial Area', 'Bhadra', 'Bhalariya', 'Bharatpur', 'Bhavri', 'Bhawani Mandi', 'Bhilwara', 'Bhim', 'Bhinder', 'Bhinmal Bhiwadi', 'Bhusawar', 'Bicciwara Industrial Area', 'Bichhiwara', 'Bichhri', 'Bidasar', 'Bigod', 'Bikaner', 'Bilara', 'Bishangarh', 'Bissau', 'BITS Pilani Campus', 'Boranada Special', 'Economic Zone', 'Borawar', 'Budhpura', 'Bundi', 'Chaksu', 'Chawand', 'Chechat', 'Chhabra', 'Chhapar', 'Chhipabarod', 'Chhoti Sadri', 'Chirawa', 'Chittaurgarh', 'Chomu', 'Churu', 'Danta', 'Dariba', 'Dausa', 'Deeg', 'Delwara', 'Deogarh', 'Deoli', 'Deshnoke', 'Dewrighata Industrial Area', 'Dhariawad', 'Dhaulpur', 'Dhorimanna', 'Didwana', 'Dudu', 'Dungargarh', 'Dungarpur', 'Emri', 'Falna', 'Fatehnagar', 'Fatehpur', 'Gajsinghpur', 'Galiakot', 'Gangapur', 'Gangapur City', 'Garhi', 'Gharsana', 'Gogunda', 'Goredi Chancha', 'Gothan', 'Gothra', 'Govindgarh, Alwar District', 'Govindgarh, Jaipur District', 'Govindpur Baori Industrial', 'Area', 'Goyli', 'Guhala', 'Gulabpura', 'Hamirgarh', 'Hamirgarh Growth Centre', 'Hanumangarh', 'Hindaun', 'Hindaun City Industrial', 'Area', 'Indragarh', 'Industrial Area Bidiyad Industrial Area Bigod', 'Industrial Area Deoli', 'Industrial Area Gegal', 'Industrial Area Hathipura', 'Industrial Area Kaladera', 'Industrial Area Kanya', 'Kheri', 'Industrial Area Karauli', 'Industrial Area Mathania', 'Industrial Area Napasar', 'Industrial Area Narbad', 'Khera', 'Industrial Area Sangaria', 'Industrial Area', 'Swaroopganj', 'Islampur', 'Jahazpur', 'Jahazpur Industrial Area', 'Jaipur', 'Jaisalmer', 'Jaitaran', 'Jalor', 'Jalore Industrial Area', 'Jamwa Ramgarh', 'Jhagarwas', 'Jhalawar', 'Jhalrapatan', 'Jhunjhunun', 'Jobner', 'Jodhpur', 'Jodhpur Stone Park', 'Industrial Area', 'Kaithoon', 'Kaladwas Industrial Area', 'Kaman', 'Kanor', 'Kanwat Kapasan', 'Kaprain', 'Karanpur', 'Karauli', 'Kasba Bonli', 'Kawai', 'Kekri', 'Kelwa', 'Keshoraipatan', 'Kesrisinghpur', 'Khairabad', 'Khairthal', 'Khajuwala', 'Khandela, Baran District', 'Khandela, Sikar District', 'Khanpur', 'Khara', 'Khatu', 'Kherli', 'Kherliganj', 'Kherwara Chhaoni', 'Khetri', 'Kinchan', 'Kishangarh', 'Kishangarh Renwal', 'Kishangarh, Alwar District', 'Kolayat', 'Kolvi Mandi Rajendrapur', 'Kota', 'Kotputli', 'Kuchaman City', 'Kuchera', 'Kumbhkot', 'Kumher', 'Kushalgarh', 'Lachhmangarh', 'Ladnu Lakheri', 'Lalsot', 'Losal', 'Lunkaransar', 'Mahu Kalan', 'Mahwa', 'Makrana', 'Malpura', 'Malsisar', 'Mandalgarh', 'Mandawa', 'Mandawar', 'Mandpiya', 'Mangrol', 'Manoharpur', 'Manoharthana', 'Marwar Junction', 'Mathania', 'Mavli', 'Mehandipur', 'Merta City', 'Merta Road', 'Modak', 'Mokalsar', 'Mount Abu', 'Mukandgarh', 'Mundwa', 'Nadbai', 'Nagar', 'Nagaur', 'Nagaur Industrial Area', 'Nainwa', 'Nandri', 'Napasar', 'Nasirabad', 'Nathdwara', 'Nawa Nawalgarh', 'Neem Ka Thana Industrial', 'Area', 'Neem-Ka-Thana', 'Neemrana', 'Newa Talai', 'Nimbahera', 'Niwai', 'Niwai Industrial Area', 'Nohar', 'Nokha', 'Nooan', 'Padampur', 'Pali', 'Parbatsar', 'Partapur', 'Partapur Industrial Area', 'Phalodi', 'Phalodi Industrial Area', 'Phulera', 'Pilani Town', 'Pilibanga', 'Pindwara', 'Pipar City', 'Pirawa', 'Pokaran', 'Pratapgarh', 'Pushkar', 'Raila', 'Raisinghnagar', 'Rajakhera', 'Rajaldesar', 'Rajgarh', 'Rajgarh, Churu District', 'Rajsamand', 'Ramganj Mandi', 'Ramgarh Ramgarh, Alwar District', 'Ramgarh, Sikar District', 'Rani', 'Rani Sagar RIICO', 'Ranthambore', 'Ratangarh', 'Ratannagar', 'Rawatbhata', 'Rawatsar', 'Reengus', 'Renwal', 'Reodar', 'RIICO Industrial Area', 'Bassi', 'RIICO Industrial Area', 'Bidasar', 'RIICO Industrial Area', 'Bikasar', 'RIICO Industrial Area', 'Chopanki', 'RIICO Industrial Area', 'Gudli', 'RIICO Industrial Area', 'Kharani', 'RIICO Industrial Area', 'Khushkhera', 'RIICO Industrial Area', 'Naya Gaon', 'RIICO Industrial Area', 'Neemrana', 'RIICO Industrial Area', 'Palsana', 'RIICO Industrial Area', 'Rajgarh', 'RIICO Industrial Area', 'Sanchore', 'RIICO Institutional Area Ranpur', 'RIICO Industrial Area', 'Rupangarh', 'Rikhabdeo', 'Sadri', 'Sadulshahar', 'Sagwara', 'Salasar', 'Salumbar', 'Sambhar', 'Samdari', 'Sanchore', 'Sanderao', 'Sangaria', 'Sangod', 'Sapotra', 'Saradhana RIICO', 'Sardargarh', 'Sardarshahar', 'Sarekhurd Industrial Area', 'Sariska', 'Sarmathura', 'Sarwar', 'Satalkheri', 'Sawa', 'Sawai Madhopur', 'Seemalwara', 'Semari', 'Shahjahanpur', 'Shahjahanpur Industrial', 'Area', 'Shahpura', 'Shahpura, Bhilwara', 'District', 'Sheoganj', 'Shiwar Sikar', 'Silora Industrial Area', 'Singhana', 'Sirohi', 'Sirohi Industrial Area', 'Siwana', 'Sojat', 'Sojat Road', 'Sri Ganganagar', 'Sri Madhopur', 'Sri Madhopur Indusrtial', 'Area', 'Sudarshanpura RIICO', 'Sujangarh', 'Suket', 'Suket Industrail Area', 'Sumerganj Mandi', 'Sumerpur', 'Sumerpur Industrial Area', 'Sundlak RIICO Baran', 'Surajgarh', 'Suratgarh', 'Swaroopganj', 'Takhatgarh', 'Talera', 'Tapookra', 'Taranagar', 'Thana Gazi RIICO', 'Tijara', 'Todabhim', 'Todaraisingh', 'Todra', 'Tonk', 'Tonk Industrial Area', 'Udaipur', 'Udaipurwati', 'Udpura', 'Uniara', 'Utarlai', 'Vijainagar', 'Vijainagar, Ganganagar', 'District', 'Viratnagar', 'Weir', 'Gangtok', 'Gyalshing', 'Jorethang', 'Mangan', 'Meli', 'Namchi', 'Nayabazar', 'Pelling', 'Rangpo', 'Rhenock', 'Singtam', 'Upper Tadong', 'VA Vellalapatti', 'Abiramam', 'Achampudur', 'Acharapakkam', 'Achipatti', 'Adikaratti', 'Adiramapattinam', 'Adiyanuthu', 'Aduthurai', 'Agaram', 'Agastheeswaram', 'Alagappapuram', 'Alanganallur', 'AlangayamSikkim', 'Tamil Nadu Alangudi', 'Alangulam', 'Alangulam, Virudhunagar', 'District', 'Alanthurai', 'Alathur, Chengalpattu', 'Taluka', 'Aliyar', 'Alur', 'Alwarkurichi', 'Alwarthirunagiri', 'Amathur', 'Ambasamudram', 'Ambur', 'Ammainaickanur', 'Ammanur', 'Ammapattinam', 'Ammapettai', 'Ammapettai, Erode', 'District', 'Ammavarikuppam', 'Ammoor', 'AMRL Sez Vaigaikulam', 'Anaimalai', 'Anaiyur', 'Ananthapuram', 'Andipalayam', 'Andipatti Jakkampatti', 'Anjugrammam', 'Annamalai Nagar', 'Annanji', 'Annavasal', 'Annur', 'Anthiyur', 'Anuppankulam', 'Appakudal', 'Arachalur Arakandanallur', 'Arakonam', 'Aralvaimozhi', 'Arani', 'Arani, Thiruvallur District', 'Aranthangi', 'Arasiramani', 'Arasur', 'Aravakurichi', 'Arcot', 'Arimalam', 'Ariyalur', 'Ariyappampalayam', 'Ariyur', 'Arumanai', 'Arumbanur', 'Arumbavur', 'Arumuganeri', 'Aruppukkottai', 'Asaripallam', 'Athani', 'Athanur', 'Athimarapatti', 'Athipatti', 'Athur', 'Athur, Thoothukkudi', 'District', 'Attayampatti', 'Attur', 'Avadattur', 'Avalapalli', 'Avalpoondurai', 'Avanashi', 'Avaniapuram', 'Ayakudi', 'Aygudi', 'Ayothiapattinam Ayyalur', 'Ayyampalayam', 'Ayyampettai', 'Ayyampettai, Thanjavur', 'District', 'Azhagiapandipuram', 'B Mallapuram', 'B Meenakshipuram', 'Balakrishnampatti', 'Balakrishnapuram', 'Balapallam', 'Balasamudram', 'Bargur', 'Batlagundu', 'Belur', 'Bharathi Nagar', 'Bhavani', 'Bhavanisagar', 'Bhuvanagiri', 'Bikketti', 'Bodinayakanur', 'Boothapandi', 'Boothipuram', 'Chakkarapalli', 'Chathirareddipatti', 'Chatrapatti', 'Chenbagaramanputhur', 'Chengalpattu', 'Chengam', 'Chengappalli', 'Chennagiri', 'Chennai', 'Chennasamudram', 'Chennimalai', 'Cheranmadevi', 'Chetpet', 'Chettiarpatti Chettipalayam', 'Chettipalayam,', 'Coimbatore District', 'Chettithangal', 'Chidambaram', 'Chinnakalayamputhur', 'Chinnakkampalayam', 'Chinnalapatti', 'Chinnamanur', 'Chinnampalayam', 'Chinnasalem', 'Chinnathadagam', 'Chinniampalayam, Erode', 'District', 'Chinthamani', 'Chithode', 'Chockampatti', 'Cholapuram', 'Coimbatore', 'Coonoor', 'Courtalam', 'Cuddalore', 'Damalerimuthur', 'Dasanaickenpatti', 'Denkanikottai', 'Desur', 'Devadanapatti', 'Devakottai', 'Devanangurichi', 'Devarshola', 'Devasthanam', 'Devikapuram', 'Devipattinam', 'Dhalavoipuram', 'Dhali', 'Dhaliyur', 'Dharamapuram Dharapadavedu', 'Dharapuram', 'Dharmapuri', 'Dindigul', 'Doramangalam', 'Dusi', 'Edaganasalai', 'Edaikodu', 'Edakalinadu', 'Edappadi', 'Elathur', 'Elayirampannai', 'ELCOT Gangaikodan IT', 'Park', 'Ellandaikuttai', 'Elumalai', 'Eral', 'Eranapuram', 'Eraniel', 'Eriodu', 'Erode', 'Erumaipatti', 'Eruvadi', 'Ethapur', 'Ettayapuram', 'Ettimadai', 'Ezhudesam', 'Frontier Mediville SEZ', 'Ganapathipuram', 'Gandhi Nagar', 'Gangaikondan', 'Gangavalli', 'Ganguvarpatti', 'Gingee', 'GK Industrial Park', 'Gobichettipalayam', 'Gopalasamudram Gudalur', 'Gudalur, The Nilgiris', 'District', 'Gudalur, Theni District', 'Gudiyatham', 'Gummidipoondi', 'Hale Dharmapuri', 'Hanumanthampatti', 'Harur', 'Harveypatti', 'Highways', 'Hosur', 'Hubbathala', 'Huligal', 'Idikarai', 'Iduvai', 'Ilampillai', 'Ilanji', 'Ilayangudi', 'Iluppaiyurani', 'Iluppur', 'Irugur', 'Jaffrabad', 'Jalakandapuram', 'Jambai', 'Jayankondam', 'Jeyamangalam', 'Jolarpet', 'K Madapur', 'Kadambathur', 'Kadambur', 'Kadathur', 'Kadayal', 'Kadayam', 'Kadayampatti', 'Kadayanallur', 'Kailasagiri Kakkalur', 'Kalakad', 'Kalakattupular', 'Kalambur', 'Kalappanaickenpatti', 'Kalavai', 'Kaliyakkavilai', 'Kaliyapuram', 'Kalladaikurichi', 'Kallakkurichi', 'Kallakudi', 'Kallangudy', 'Kallipalaym', 'Kallukoottam', 'Kalparapatti', 'Kalugumalai', 'Kamalakannanji SIDCO', 'Industrial Estate', 'Kamayagoundanpatti', 'Kambainallur', 'Kambam', 'Kamuthi', 'Kanadukathan', 'Kanakkampalayam', 'Kanakkanpatti', 'Kanam', 'Kancheepuram', 'Kandanur', 'Kangayampalayam', 'Kangeyam', 'Kaniyambadi', 'Kaniyampoondl', 'Kaniyur', 'Kaniyur,Coimbatore', 'District', 'Kanjikoil', 'Kannamangalam', 'Kannampalayam', 'Kannanendal', 'Kannanoor', 'Kannivadi', 'Kannivadi, Dindigul', 'District', 'Kanniyakumari', 'Kappalur SIDCO', 'Industrial Estate', 'Kappiyarai', 'Karadipatti', 'Karaikkudi', 'Karaikudi SIDCO', 'Industrial Estate', 'Karamadai', 'Karambakkudi', 'Kariamangalam', 'Kariapatti', 'Karugampattur', 'Karukkalvadi', 'Karumandi Chellipalayam', 'Karumathampatti', 'Karungal', 'Karunguzhi', 'Karuppur', 'Karur', 'Kasipalayam', 'Kathujuganapalli', 'Kattathurai', 'Kattumannarkoil', 'Kattupakkam', 'Kattuputhur', 'Kaveripakkam', 'Kaveripattinam', 'Kavindapadi', 'Kayalpattinam', 'Kayatharu Keelakarai', 'Keeramangalam', 'Keeranur', 'Keeranur, Pudukkottai', 'District', 'Keeripatti', 'Keezhkulam', 'Kelamangalam', 'Kembainaickenpalayam', 'Kethi', 'Kila Ambur', 'Kilampadi', 'Kilapavoor', 'Kilkunda', 'Killai', 'Killiyoor', 'Kilpennathur', 'Kilvaithinankuppam', 'Kilvelur', 'Kinathukadavu', 'Kodaikanal', 'Kodavasal', 'Kodivalasa', 'Kodumudi', 'Koil Palayam', 'Kolachal', 'Kolappalur', 'Kolathupalayam', 'Kolathur', 'Kollancode', 'Kollankoil', 'Komaralingam', 'Kombai', 'Kondur', 'Konganapuram', 'Koonavelampatti', 'Kooraikundu Koothappar', 'Koradacheri', 'Kotagiri', 'Kothanallur', 'Kottaiyur', 'Kottakuppam', 'Kottaram', 'Kottur', 'Kovalam', 'Kovilpatti', 'Krishnagiri', 'Krishnarayapuram', 'Kuchanur', 'Kuchipulayam', 'Kuhalur', 'Kulappuram', 'Kulasekaram', 'Kulasekarapuram', 'Kulathur', 'Kulithalai', 'Kullursandai', 'Kumaragiri', 'Kumarapalayam', 'Kumarapuram', 'Kumbakonam', 'Kunnathur', 'Kurinjipadi', 'Kurudampalayam', 'Kurukkupatti', 'Kurumbalur', 'Kurumbapatti', 'Kuruppanaickenpalayam', 'Kuthalam', 'Kuthanallur', 'Kuzhithurai', 'Labbaikudikadu', 'Lakkampatti Lakshmi Puram', 'Lalgudi', 'Lalpet', 'Lampalayam', 'Madaharpakkam', 'Madathukulam', 'Madukkarai', 'Madukkur', 'Madurai', 'Maduranthakam', 'Mahindra World City', 'Makkinampatti', 'Mallankinaru', 'Mallasamudram', 'Mallur', 'Malumichampatti', 'Mamallapuram', 'Mamsapuram', 'Manachanallur', 'Manalikarai', 'Manalmedu', 'Manalurpet', 'Manamadurai', 'Manapparai', 'Manavalakurichi', 'Mancad', 'Mandaikadu', 'Mandapam', 'Mangalam', 'Mangalampet', 'Manimutharu', 'Mannargudi', 'Manthithoppu', 'Maraimalainagar', 'Marakkanam', 'Maramangalathupatti', 'Marandahalli Markayankottai', 'Marthandam', 'Marudur', 'Marungur', 'Maruthancode', 'Masinaickenpatty', 'Mathicode', 'Mathigiri', 'Mathur', 'Mayiladuthurai', 'Mecheri', 'Melacheval', 'Melachokkanathapuram', 'Melagaram', 'Melaparthibanur', 'Melathiruppanthuruthi', 'Melattur', 'Melmangalam', 'Melpattampakkam', 'Melur', 'Melvisharam', 'Methukummal', 'Mettamalai', 'Mettunasuvanpalayam', 'Mettupalayam', 'Mettupalayam,', 'Tiruchirappalli District', 'Mettur', 'Mevalurkuppam', 'Milavittan', 'Minampalli-Pachamadevi', 'Modakurichi', 'Mohamed Bundur', 'Mohanur', 'Moolakaraipatti', 'Mopperipalayam', 'Morattupalayam Industrial Estate', 'Nanjikottai', 'Nannilam', 'Naranammalpuram', 'Naranapuram', 'Narasimhanaickenpalayam', 'Narasingapuram', 'Narasingapuram, Salem', 'District', 'Nasiyanur', 'Natchiarkoil', 'Natham', 'Nathampannai', 'Natrampalli', 'Nattalam', 'Nattapettai', 'Nattarasankottai', 'Nazerath', 'Needamangalam', 'Neelagiri', 'Neikkarapatti', 'Nellikuppam', 'Nelliyalam', 'Nemili', 'Neripperichal', 'Nerkuppai', 'Nerunjipettai', 'Neyveli', 'Neyyoor', 'Nilaiyur', 'Nilakkottai', "O' Valley", 'Odaipatti', 'Odaiyakulam', 'Oddanchatram', 'Odugathur', 'Olagadam Mudalipalayam SIDCO', 'Mudukulathur', 'Mudumalai', 'Mukasipidariyur', 'Mukkudal', 'Mulagumudu', 'Mulanur', 'Mullipattu', 'Muruganpalayam', 'Musiri', 'Muthanampalayam', 'Muthukadu', 'Muthupet', 'Muthur', 'Muttayyapuram', 'Muzhucode', 'Mylaudy', 'Nadaikavu', 'Naduvaneri', 'Naduvattam', 'Nagamalaipudukottai', 'Nagamangalam', 'Nagapattinam', 'Nagercoil', 'Nagojanahalli', 'Nallampatti', 'Nallipalayam', 'Nallur', 'Namagiripettai', 'Namakkal', 'Nambiyur', 'Nandivaram-', 'Guduvancheri', 'Nangavalli', 'Nangavaram', 'Nanguneri', 'Nanjaiuthukuli Omalur', 'Ooty', 'Periyamanali', 'Periyanaickenpalayam', 'Pernampattu', 'Perumagalur', 'Perumagoundampatti', 'Perumanallur', 'Perumandi', 'Perundurai', 'Perungulam', 'Pethampalayam', 'Pethanaickenpalayam', 'Pettai', 'Pillanallur', 'PJ Cholapuram', 'Pollachi', 'Polur', 'Pongaliyur', 'Ponmanai', 'Ponnamaravathi', 'Ponnampatti', 'Ponneri', 'Poolambadi', 'Poolampatti', 'Poolankinar', 'Pooluvapatti', 'Porayar', 'Pothanur', 'Pothatturpettai', 'Pudiyamputhur', 'Pudukkottai', 'Pudupalayam', 'Pudupalayam Agraharam', 'Pudupatti', 'Pudupattinam', 'Pudur', 'Puduvayal', 'Puliankudi Puliyur', 'Pullampadi', 'Punjai Thottakurichi', 'Punjaipugalur', 'Punjaipuliampatti', 'Puthalam', 'Putheri', 'Puthukkadai', 'Puvalur', 'R Pudupatti', 'Rajapalayam', 'Rajapalayam, Salem', 'District', 'Rakkiya Palayam', 'Ramalingapuram', 'Ramanathapuram', 'Rameswaram', 'Ranipettai', 'Rasipuram', 'Rayagiri', 'RS Mangalam', 'Rudravathi', 'S Kannanur', 'S Kodikulam', 'S Nallur', 'Sakkimangalam', 'Salangapalayam', 'Salem', 'Samalapuram', 'Samanatham', 'Samathur', 'Sambavar Vadagarai', 'Sankaramanallur', 'Sankarankoil', 'Sankaraperi', 'Sankarapuram', 'Sankari Sankarnagar', 'Sarcarsamakulam', 'Sathankulam', 'Sathiyavijayanagaram', 'Sathyamangalam', 'Sattur', 'Sayalgudi', 'Sayapuram', 'Seerapalli', 'Seevur', 'Seithur', 'Semmipalayam', 'Senthamangalam', 'Sentharapatti', 'Senur', 'Sethiathoppu', 'Sevilimedu', 'Sevugampatti', 'Sevur', 'Shenkottai', 'Sholavandan', 'Sholingur', 'Sholur', 'SIDCO Bargur', 'Singampuneri', 'Singaperumalkoil', 'Singilipatti', 'SIPCOT Cheyyar', 'SIPCOT Industrial', 'Complex Pillaipakkam', 'SIPCOT Industrial Park', 'Sriprumbudur', 'SIPCOT Perundurai', 'SIPCOT Thervoy Kandigal', 'SIPCOT Thoothukudi', 'Sircar Periapalayam', 'Sirkali Sirugamani', 'Sirumugai', 'Sithayankottai', 'Sithurajapuram', 'Sivaganga', 'Sivagiri', 'Sivagiri, Erode District', 'Sivagiripatti', 'Sivagnanapuram', 'Sivakasi', 'Sivanthipatti', 'Sivanthipuram', 'Srikalikapuram', 'Srimushnam', 'Sriperumbudur', 'Sriramapuram', 'Srivaikuntam', 'Srivilliputhur', 'Suchindrum', 'Suleeswaranpatti', 'Sulur', 'Sundarapandiam', 'Sundarapandianpattinam', 'Sundarapandiapuram', 'Surandai', 'Suriyampalayam', 'Swamimalai', 'T Kallipatti', 'T Kallupatti', 'Tajpura', 'Tayilupatti', 'Tenkasi', 'Terkukallikulam', 'Thadikarankonam', 'Thadikombu', 'Thakkolam', 'Thalainayar Thamaraikulam', 'Thammampatti', 'Thanjavur', 'Thanthoni', 'Thappakuttai', 'Tharamangalam', 'Tharangambadi', 'Thathaiyangarpet', 'Thathankuttai', 'Thazhakudy', 'Thedavur', 'Thenambakkam', 'Thengampudur', 'Theni Allinagaram', 'Thenkarai', 'Thenkarai, Coimbatore', 'District', 'Thenthamaraikulam', 'Thenthiruperai', 'Therur', 'Thevaram', 'Thevarappan Patti', 'Thevur', 'Thiagadurgam', 'Thikkanamcode', 'Thimmaiyanpettai', 'Thingalnagar', 'Thirikoodapuram', 'Thirukarungavur', 'Thirukarungudi', 'Thirukkadaiyur', 'Thirukkattupalli', 'Thirumalayampalayam', 'Thirumalpur', 'Thirumangalam', 'Thirumuruganpoondi', 'Thirunageswaram Tirukkoyilur', 'Tirumalaigiri', 'Tirunelveli', 'Tirupathur', 'Tirupathur, Vellore District', 'Tiruppur', 'Tiruttani', 'Tiruvannamalai', 'Tiruvethipuram', 'Tittacheri', 'Tittakudi', 'TNPL Pugalur', 'Tuticorin', 'TVS Plant Hosur', 'Udangudi', 'Udayarpalayam', 'Udumalaipettai', 'Ullur', 'Ulundurpet', 'Unjalur', 'Unnamalaikadai', 'Uppidamangalam', 'Uppiliapuram', 'Usilampatti', 'Uthamapalayam', 'Uthangarai', 'Uthayendram', 'Uthiramerur', 'Uthukkottai', 'Uthukuli', 'V Pudupatti', 'V Pudur', 'Vadakarai Keezhpadugai', 'Vadakkanandal', 'Vadakkuvalliyur', 'Vadalur', 'Vadamadurai Thiruparankundram', 'Thiruparappu', 'Thiruporur', 'Thiruppalai', 'Thiruppanandal', 'Thirupuvanam', 'Thirupuvanam, Thanjavur', 'District', 'Thiruthangal', 'Thiruthuraipoondi', 'Thiruvaiyaru', 'Thiruvalam', 'Thiruvallur', 'Thiruvarur', 'Thiruvattar', 'Thiruvenkadam', 'Thiruvennainallur', 'Thiruverumbur', 'Thiruvidaimarudur', 'Thiruvithancode', 'Thisayanvilai', 'Thondamuthur', 'Thondi', 'Thookkanaikampalayam', 'Thorapadi', 'Thorapadi,Cuddalore', 'District', 'Thottiyam', 'Thuraiyur', 'Thuthipattu', 'Thuvakudi', 'Timiri', 'Tindivanam', 'Tiruchendur', 'Tiruchengode', 'Tiruchirappalli', 'Tirukalukundram Vadapudupatti', 'Vaddakkankulam', 'Yercaud', 'Zamin Uthukuli', 'Achampet', 'Adilabad', 'Alampur', 'Allipur', 'Ananthapuram', 'Anjani Portland Cement', 'Factory', 'APIIC Polepally SEZ', 'Armur', 'Ashwaraopet', 'Asifabad', 'Atmakur Mahbubnagar', 'District', 'Ballepalle', 'Banswada', 'Bellampalle', 'Bhadrachalam', 'Bhainsa', 'Bheema Cements Limited', 'Ramapuram', 'Bhimaram', 'Bhimaram Warangal', 'District', 'Bhongir', 'Bhupalpalle', 'Bibinagar', 'Bodhan', 'Boyapalle', 'Chandur', 'Chanukya Cement', 'Factory', 'Chatakonda', 'CheguntaTelangana Chelpur', 'Chennur Adilabad District', 'Chinnachitakunta', 'Chitkul', 'Chityala', 'Choppadandi', 'Choutuppal', 'Chunchupalle', 'Dasnapur', 'Deccan Cement Factory', 'Devapur', 'Devarakonda', 'Devarkadra', 'Dharmapuri', 'Dharmaram', 'Dharmaram Karimnagar', 'District', 'Dharmaram Warangal', 'District', 'Dornakal', 'Eddumailaram', 'Farooqnagar', 'Gadwal', 'Gajwel', 'Ghanpur', 'Ghanpur Warangal District', 'Gorrekunta', 'Gurralapadu Industrial', 'Area', 'Haliya', 'Hanwada', 'Husnabad', 'Huzur Nagar', 'Huzurabad', 'Hyderabad', 'Ibrahimpatnam', 'Rangareddy District Ichoda', 'Ieeja', 'Isnapur', 'Jadcherla', 'Jagtial', 'Jainoor', 'Jallaram', 'Jammikunta', 'Jangaon', 'Jannaram', 'Jogipet', 'Kaddam Peddur', 'Kadipikonda', 'Kagaznagar', 'Kalwakurthy', 'Kamalapuram', 'Kamalapuram Karimnagar', 'District', 'Kamareddy', 'Karimnagar', 'Kasipet', 'Khammam', 'Khanapur', 'Kisan Nagar Industrial', 'Area', 'Kodad', 'Kodangal', 'Kondamallapalle', 'Koratla', 'Kosigi', 'Kothagudem', 'Kothakota', 'Kothur', 'Kyathampalle', 'Laxmidevipalle', 'Luxettipet', 'Madaram Madhira', 'Madikonda', 'Mahabubabad', 'Mahbubnagar', 'Maheswaram Industrial', 'Area', 'Mamda', 'Mamnoor', 'Mancherial', 'Mandamarri', 'Manugur', 'Medak', 'Medipalle', 'Metapally', 'Miryalaguda', 'Muhammadabad', 'Mulugu', 'Nagarjuna Sagar', 'Nagarkurnool', 'Nakrekal', 'Nalgonda', 'Narayanapuram', 'Narayankhed', 'Narayanpet', 'Narsampet', 'Narsapur', 'Naspur', 'Navandgi', 'Nirmal', 'Nizamabad', 'Palakurthy', 'Palwancha', 'Pargi', 'Peddapalle', 'Perur', 'Pochampalle', 'Pothreddipalle Raasi Cement Factory', 'Wazirabad', 'Raghunathpur', 'Ramagundam', 'Ramannapeta', 'Ratnapur', 'Ratnapur Medak District', 'Rudraram', 'Rudraram Industrial Area', 'Sadasivpet', 'Sangareddy', 'Sarangapur', 'Sarapaka', 'Sathupally', 'Secunderabad', 'Shamshabad', 'Shankarampet', 'Shivunipalle', 'Siddipet', 'Singapuram', 'Sircilla', 'Soanpet', 'Sri Vishnu Cement', 'Limited Dondapadu', 'Suryapet', 'Tallada', 'Tandur', 'Teegalpahad', 'Thallapalle', 'Thimmapur', 'Thorrur', 'Turkapally', 'Utnur', 'Vatwarlapalle', 'Vemulawada', 'Vicarabad', 'Wanaparthy Warangal', 'Warangal Industrial Area', 'Yadagirigutta', 'Yellandu', 'Yellareddy', 'Yenugonda', 'Yerrabalem', 'Zahirabad', 'Agartala', 'Amarpur', 'Ambassa', 'Anandanagar', 'Badharghat', 'Belonia', 'Briddhanagar', 'Dharmanagar', 'Fatikroy', 'Gakulnagar', 'Gakulpur', 'Gandhigram', 'Indranagar', 'Jogendranagar', 'Kailasahar', 'Kalachhari', 'Kamalpur', 'Kanchanpur', 'Khowai', 'Kumarghat', 'Kunjaban', 'Madhupur', 'Manu', 'Matarbari', 'Narsingarh', 'Panisagar', 'RanirbazarTripura Sabroom', 'Santirbazar', 'Sonamura', 'Taranagar', 'Teliamura', 'Udaipur', 'Abupur', 'Achalganj', 'Achhalda', 'Achhnera', 'Adari', 'Afzalgarh', 'Agarwal Mandi', 'Agra', 'Agro Park Karkhiyon', 'Ahraura', 'Ailum', 'Air Force Area', 'Ajhuwa', 'Akbarpur', 'Akbarpur Near Kanpur', 'Aliganj', 'Aligarh', 'Allahabad', 'Allahganj', 'Allapur', 'Amanpur', 'Ambehta', 'Amethi', 'Amethi Sultanpur District', 'Amila', 'Amilo', 'Aminagar Sarai', 'Amraudha', 'AmrohaUttar Pradesh Anandnagar', 'Anpara', 'Antu', 'Anupshahr', 'Anurudhpur Purab Patti', 'Aonla', 'Artauni', 'Ashrafpur Kichhauchha', 'Atarra', 'Atasu', 'Atrauli', 'Atraulia', 'Auraiya', 'Aurangabad', 'Auras', 'Awagarh', 'Ayodhya', 'Azamgarh', 'Azmatgarh', 'Babarpur Ajitmal', 'Baberu', 'Babina', 'Babrala', 'Babugarh', 'Bachhgaon', 'Bachhraon', 'Bachhrawan', 'Bad', 'Badaun Industrial Area', 'Baghpat', 'Bah', 'Bahadurganj', 'Baheri', 'Bahjoi', 'Bahraich', 'Bahsuma', 'Bahuwa', 'Bela Pratapgarh', 'Belthara Road', 'Beniganj', 'Benipur', 'Beswan', 'Bewar', 'Bhabnan Bazar', 'Bhadarsa', 'Bhadohi', 'Bhadohi Industrial Area', 'Bhagwant Nagar', 'Bharatganj', 'Bhargain', 'Bharthana', 'Bharuhana', 'Bharwari', 'Bhatni Bazar', 'Bhatpar Rani', 'Bhawan Bahadur Nagar', 'Bhinga', 'Bhogaon', 'Bhojpur Dharampur', 'Bhokarhedi', 'Bhulepur', 'Bidhuna', 'Bighapur', 'Bihka', 'Bijauli Industrial Area', 'Bijnor', 'Bijpur', 'Bikapur', 'Bilari', 'Bilariaganj', 'Bilaspur', 'Bilaspur, Gautam Buddha', 'Nagar District', 'Bilgram Bajna', 'Bakewar', 'Bakiabad', 'Baksar', 'Bakshi Ka Talab', 'Baldeo', 'Ballia', 'Balrampur', 'Banat', 'Banda', 'Bangarmau', 'Banguwan Kalan', 'Banjarepur', 'Bansdih', 'Bansgaon', 'Bansi', 'Bara Gaon', 'Barabanki', 'Barabanki Industrial Area', 'Baragaon', 'Barahatir Jagdishpur', 'Baraut', 'Bareilly', 'Barhalganj', 'Barhani Bazar', 'Barkhera', 'Baroun', 'Barsana', 'Barua Sagar', 'Barwar', 'Barwara Mazra', 'Basantpur Saitli', 'Basta', 'Basti', 'Beelna', 'Behat', 'Behta Hajipur Bilhaur', 'Bilram', 'Bilsanda', 'Bilsi', 'Bindki', 'Birbhanpur', 'Bisalpur', 'Bisanda Buzurg', 'Bisauli', 'Bisharatganj', 'Bishunipur', 'Biswan', 'Bithoor', 'Budaun', 'Budhana', 'Bugrasi', 'Bulandshahr', 'Chail', 'Chakia', 'Chakmano', 'Chandauli', 'Chandausi', 'Chandpur', 'Charkhari', 'Charthaval', 'Chaumuhan', 'Chaurhat', 'Chhaprauli', 'Chharra Rafatpur', 'Chhata', 'Chhatari', 'Chhibramau', 'Chhitauni', 'Chhutmalpur', 'Chilkana Sultanpur', 'Chirgaon', 'Chitbara Gaon Chitrakoot', 'Chopan', 'Choubepur Kalan', 'Chunar', 'Churk Ghurma', 'Colonelganj', 'Dadri', 'Dalmau', 'Dankaur', 'Dariyabad', 'Dasna', 'Dataganj', 'Daurala', 'Debai', 'Deoband', 'Deoranian', 'Deori Singhpura', 'Deoria', 'Deosaini', 'Derapur', 'Devinagar', 'Dewa', 'Dhakauli', 'Dhampur', 'Dhanauha', 'Dhanaura', 'Dharoti Khurd', 'Dhaura Tanda', 'Dhaurahara', 'Dibiyapur', 'Dildarnagar Fatehpur', 'Bazar', 'Dindaspur', 'Dindaspur Chandauli', 'District', 'Doghat', 'Dohrighat Domariyaganj', 'Dostpur', 'Dudhi', 'Dulhipur', 'Ekdil', 'Erich', 'Etah', 'Etah Indutrial Area', 'Etawah', 'Etmadpur', 'Faizabad', 'Faizganj', 'Farah', 'Faridnagar', 'Faridpur, Bareilly District', 'Fariha', 'Farrukhabad', 'Fatehabad', 'Fatehganj Pashchimi', 'Fatehganj Purvi', 'Fatehgarh', 'Fatehpur', 'Fatehpur Chaurasi', 'Fatehpur Sikri', 'Fatehpur, Barabanki', 'District', 'Fazi Nagar', 'Firozabad', 'Firozabad UPSIDC', 'Gabhana', 'Gadhi', 'Gagalhedi Must', 'Gajraula', 'Gangapur', 'Gangiri', 'Gangoh', 'Ganj Dundwara Ganj Muradabad', 'Ganwaria Tulsipur', 'Garauri', 'Garautha', 'Garhi Pukhta', 'Garhmukteshwar', 'Gaura', 'Gaura Barhaj', 'Gaura Kala', 'Gauri Bazar', 'Gausganj', 'Gawan', 'Ghatampur', 'Ghaziabad', 'Ghazipur', 'Ghiraur', 'Ghorawal', 'Ghosi', 'Ghosia Bazar', 'Ghughuli', 'GIDA Gorakhpur', 'Gird Baragaon', 'Gohand', 'Gokul', 'Gola Bazar', 'Gola Gokarannath', 'Gonda', 'Gopamau', 'Gopi Ganj', 'Gorakhpur', 'Gosainganj', 'Gosainganj, Lucknow', 'District', 'Got', 'Govardhan', 'Greater Noida', 'Gulaothi Gulariya', 'Gunnaur', 'Gursahaiganj', 'Gursarai', 'Gyanpur', 'Hafiz Ganj', 'Haidergarh', 'Haldaur', 'Hallaur', 'Hamirpur', 'Handia', 'Hapur', 'Haqiqatpur', 'Hardoi', 'Harduaganj', 'Hargaon', 'Hariharpur', 'Hariyawan', 'Harraiya', 'Hasanpur', 'Hasayan', 'Hastinapur', 'Hata', 'Hathgram', 'Hathras', 'Hyderabad', 'Ibrahimpur', 'Iglas', 'Ikauna', 'Iltifatganj Bazar', 'Indian Tehephone Industry', 'Mankapur', 'Indian Telephone Industry', 'Islamnagar', 'Itaunja', 'Itwa', 'Jafarabad Jagner', 'Jahanabad', 'Jahangirabad', 'Jahangirpur', 'Jais', 'Jaithara', 'Jalalabad', 'Jalalabad, Bijnor District', 'Jalalabad, Muzaffarnagar', 'District', 'Jalali', 'Jalalpur', 'Jalaun', 'Jalesar', 'Jamshila', 'Jamuhan', 'Jangipur', 'Jansath', 'Jarwal', 'Jasra', 'Jasrana', 'Jaswantnagar', 'Jatari', 'Jaunpur', 'Jewar', 'Jhalu', 'Jhansi', 'Jhinjhak', 'Jhinjhana', 'Jiyanpur', 'Joya', 'Jugauli', 'Jyoti Khuria', 'Kabrai', 'Kachhauna Patseni', 'Kachhla', 'Kachhwa', 'Kachnar', 'Kadaura', 'Kadipur', 'Kailashpur', 'Kaimganj', 'Kairana', 'Kakari', 'Kakod', 'Kakori', 'Kakrala', 'Kalinagar', 'Kalpi', 'Kamalganj', 'Kampil', 'Kanaudia Chamical &', 'Industries Ltd', 'Kandharpur', 'Kandhla', 'Kannauj', 'Kanpur', 'Kanth', 'Kanth, Shahjahanpur', 'District', 'Kaptanganj', 'Karari', 'Karhal', 'Karnawal', 'Karwi', 'Kasba Khanpur', 'Kasganj', 'Kasiya', 'Kataka', 'Kataria', 'Katghar Lalganj', 'Kathaura', 'Kathera', 'Katra Katra Medniganj', 'Katra, Gonda District', 'Kaulakha', 'Kauria ganj', 'Kemri', 'Kerakat', 'Kewalpur', 'Khadda', 'Khaga', 'Khailar', 'Khair', 'Khairabad', 'Khairabad, Mau District', 'Khalilabad', 'Khamaria', 'Khandauli', 'Khanpur', 'Kharela', 'Khargupur', 'Khariya', 'Kharkhoda', 'Khatauli', 'Khekada', 'Kheragarh', 'Kheri', 'Kheta Sarai', 'Khudaganj', 'Khurja', 'Khutar', 'Kiraoli', 'Kiratpur', 'Kishni', 'Kishunpur', 'Kithaur', 'Koeripur', 'Konch', 'Kopaganj Kora Jahanabad', 'Koraon', 'Korwa', 'Kosi Kalan', 'Kota', 'Kota, Sonbhadra District', 'Kotra', 'Kotwa', 'Kotwali', 'Kulpahar', 'Kunda', 'Kundarki', 'Kunwargaon', 'Kuraoli', 'Kurara', 'Kursath', 'Kursath, Hardoi District', 'Kursi Road Industrial Area', 'Kurthi Jafarpur', 'Kushinagar', 'Kusmara', 'Laharpur', 'Lakhimpur', 'Lakhna', 'Lal Gopalganj Nindaura', 'Lalganj', 'Lalitpur', 'Lar', 'Lawar', 'Leather Park Banthar', 'Ledwa Mahua', 'Loni', 'Lucknow', 'Machhlishahr', 'Madhoganj', 'Madhogarh', 'Madiya Maghar', 'Mahaban', 'Maharajganj', 'Mahimapur', 'Mahmudabad', 'Mahoba', 'Maholi', 'Mahona', 'Mahrajganj', 'Mahrajganj, Azamgarh', 'District', 'Mahroni', 'Mahul Khas', 'Maigal Ganj', 'Mailani', 'Maina Maujpur', 'Mainpuri', 'Majhauliraj', 'Makhanpur', 'Malhipur', 'Malihabad', 'Mallawan', 'Mandawar', 'Manikpur', 'Manikpur Sarhat', 'Maniyar', 'Manjhanpur', 'Mankapur', 'Marehra', 'Mariahu', 'Maswasi', 'Mataundh', 'Mathura', 'Mau Aima', 'Maudaha', 'Maunath Bhanjan', 'Maurawan Mawana', 'Meerut', 'Mehdawal', 'Mehnagar', 'Mendu', 'Middha', 'Milak', 'Miranpur', 'Mirganj', 'Mirzapur cum Vindhyachal', 'Misrikh Cum Neemsar', 'Modinagar', 'Mogra Badshahpur', 'Mohammadabad', 'Mohammadabad,', 'Farrukhabad District', 'Mohammadi', 'Mohan', 'Mohanpur', 'Mohiuddinpur', 'Moradabad', 'Moth', 'Mubarakpur', 'Mughalsarai', 'Muhammadabad', 'Mundera Bazar', 'Mundia', 'Muradnagar', 'Mursan', 'Musafirkhana', 'Muzaffarnagar', 'Nadigaon', 'Nagina', 'Nagram', 'Nai Bazar', 'Naini Industrial Area', 'Najibabad Nakur', 'Nanauta', 'Nandgaon', 'Nanpara', 'Naraini', 'Narauli', 'Naraura', 'Naugarh', 'Naugawan Sadat', 'Nautanwa', 'Nawabganj', 'Nawabganj, Bareilly', 'District', 'Nawabganj, Unnao', 'District', 'Nehtaur', 'Nichlaul', 'Nidhauli Kalan', 'Nihal Garh Chak Jangla', 'Nivi', 'Niwari', 'Nizamabad', 'Noida', 'Noorpur', 'Nyoria Husainpur', 'Nyotini', 'Obra', 'Oel Dhakwa', 'Orai', 'Orai Industrial Area', 'Orai Jalaun District', 'Oran', 'Pachperwa', 'Padarathpur', 'Padrauna', 'Pahar Ganj', 'Pahasu Paintepur', 'Pakbara', 'Pali', 'Pali, Hardoi District', 'Palia Kalan', 'Palpur', 'Parasi', 'Parichha', 'Parikshitgarh', 'Parsadepur', 'Parsakhera Industrial Area', 'Parsona', 'Patadi', 'Patala', 'Patiyali', 'Patti', 'Pavi Sadakpur', 'Phalauda', 'Phaphund', 'Phulpur', 'Phulpur, Allahabad District', 'Pihani', 'Pilibhit', 'Pilkhana', 'Pilkhuwa', 'Pinahat', 'Pipalsana Chaudhari', 'Pipara Dand', 'Pipiganj', 'Pipraich', 'Piprayli Bujurg', 'Pipri', 'Powayan', 'Pratapgarh City', 'Pukhrayan', 'Puranpur', 'Purdilnagar Pure Tiwari', 'Purquazi', 'Purwa', 'Qasimpur Power House', 'Colony', 'Rabupura', 'Radhakund', 'Rae Bareli', 'Raja ka Rampur', 'Rajapur', 'Ram Nagar Industrial Area', 'Ramdaspur Urf Nagal', 'Ramkola', 'Ramnagar', 'Rampur', 'Rampur Bhawanipur', 'Rampur Karkhana', 'Rampur Maniharan', 'Rampura', 'Ranipur', 'Raniyan', 'Rasra', 'Rasulabad', 'Rasulabad Unnao District', 'Ratanpura', 'Rath', 'Rati Ka Nagla Industrial', 'Area', 'Raya', 'Renukoot', 'Reoti', 'Richha', 'Risia Bazar', 'Rithora', 'Robertsganj', 'Rori', 'Rudauli', 'Rudayan', 'Rudrapur', 'Runkata', 'Rura', 'Rustamnagar Sahaspur', 'Sadabad', 'Sadat', 'Sadatmasaura', 'Sadruddin Nagar', 'Safipur', 'Sahanpur', 'Saharanpur', 'Sahaspur', 'Sahaswan', 'Sahatwar', 'Sahawar', 'Sahjanwan', 'Sahpau', 'Saidpur', 'Saidpur Khajuria', 'Saidpur, Budaun District', 'Sainthal', 'Saiyad Raja', 'Sakaldiha', 'Sakhanu', 'Sakit', 'Salarpur', 'Salempur', 'Salon', 'Sambhal', 'Samdhan', 'Samthar', 'Sandi', 'Sandila', 'Sandilla', 'Sapur Banger', 'Sarai Abdulmalik Sarai Aquil', 'Sarai Lahur', 'Sarai mir', 'Sarai Mohana', 'Saraon', 'Sardhana', 'Sarila', 'Sarnath', 'Sarsawan', 'Sarsual', 'Sasni', 'Satiyava', 'Satrikh', 'Saunkh', 'Saurikh', 'Seohara', 'Sewalkhas', 'Sewarhi', 'Shahabad', 'Shahabad, Rampur', 'District', 'Shahganj', 'Shahi', 'Shahjahanpur', 'Shahpur', 'Shamli', 'Shamsabad', 'Shamsabad, Agra District', 'Shankargarh', 'Shaoron', 'Shergarh', 'Sherkot', 'Shikarpur', 'Shikohabad', 'Shishgarh', 'Shivli', 'Shivrajpur Shohratgarh', 'Siana', 'Siddhaur', 'Sidhauli', 'Sidhpura', 'Sikandarabad Industrial', 'Area', 'Sikanderpur', 'Sikanderpur, Kannauj', 'District', 'Sikandra', 'Sikandra Rao', 'Sikandrabad', 'Sikindra', 'Sikri Kalan', 'Singahi Bhiraura', 'Sirathu', 'Sirauli', 'Sirsa', 'Sirsaganj', 'Sirsi', 'Sisauli', 'Siswa Bazar', 'Sitapur', 'Soron', 'Suar', 'Subeha', 'Sultanpur', 'Sumerpur', 'Suriyawan', 'Suthana Barsola', 'Suzabad', 'Talbehat', 'Talgram', 'Tambaur Cum', 'Ahmadabad Tanda', 'Tanda, Rampur District', 'Tatarpur Lallu', 'Thakurdwara', 'Thana Bhawan', 'Thiriya Nizamat Khan', 'Tikait Nagar', 'Tikri', 'Tikuniya', 'Tilhar', 'Tilthi', 'Tindwari', 'Tirwaganj', 'Titron', 'Tondi Fatehpur', 'Tronica City', 'Tulsipur', 'Tundla', 'Tundla Kham', 'Tundla Rly Colony', 'Ugu', 'Ujhani', 'Ujhari', 'Umarha', 'Umri', 'Umri Kalan', 'Un', 'Unchahar', 'Unnao', 'Usawan', 'Usehat', 'Uska Bazar', 'Utraula', 'Varanasi', 'Vijaigarh', 'Vrindavan', 'Walidpur Warhapur', 'Wazirganj', 'Zaidpur', 'Zamania', 'Almora', 'Auli', 'Badrinath', 'Bageshwar', 'Bahadarabad', 'Banbasa', 'Bandia', 'Bandiya', 'Barkot', 'Bazpur', 'Begumpur', 'Berinag', 'Bhagwanpur', 'Bhimtaal', 'Bhowali', 'Chakrata', 'Chamba', 'Chamoli', 'Champawat', 'Chaukori', 'Corbett', 'Dehradun', 'Devaprayag', 'Devaprayag, Garhwal', 'District', 'Dhanaulti', 'Dharchula', 'Dharchula Dehat', 'Didihat', 'Dineshpur', 'DogaddaUttarakhand Doiwala', 'Dwarahat', 'Gadarpur', 'Gangolihat', 'Gangotri', 'Gochar', 'Gopeshwar', 'Haldwani', 'Haridwar', 'Herbertpur', 'Jaspur', 'Jhabrera', 'Joshimath', 'Kachnal Gosain', 'Kaladhungi', 'Karnaprayag', 'Kashipur', 'Kathgodam', 'Kausani', 'Kela Khera', 'Khatima', 'Kichha', 'Kirtinagar', 'Kotdwara', 'Laksar', 'Lalkuan', 'Landaur', 'Landhaura', 'Lansdowne', 'Lohaghat', 'Mahua Dabra Haripura', 'Mahua Kheraganj', 'Manglaur', 'Mehwar Kalan', 'Mohanpur Mohammadpur', 'Mukteshwar', 'Mussoorie Nagala Imarti', 'Nagla', 'Nainital', 'Nandprayag', 'Narendranagar', 'Natthuwa Wala', 'New Tehri', 'Pantnagar', 'Pauri', 'Piran Kaliyar', 'Pithoragarh', 'Pratitnagar', 'Raipur', 'Ramnagar', 'Ranikhet', 'Rishikesh', 'Roorkee', 'Rudraprayag', 'Rudrapur', 'Saidpura', 'Sara Industrial Estate', 'Selaqui', 'Shaktigarh', 'SIDCUL Haridwar', 'SIDCUL Kotadwara', 'Sitarganj', 'Srinagar', 'Sultanpur', 'Tanakpur', 'Tehri', 'Uttarkashi', 'Vikasnagar', 'Adra', 'Ahmadpur', 'AihoWest Bengal Ajodhyanagar', 'Alipukur', 'Alipurduar', 'Alipurduar Rly Jnc', 'Amarshi Kasba', 'Ambhua', 'Amlagora', 'Amlajora', 'Amta', 'Amtala', 'Anantabati', 'Andal', 'Andul', 'Ankurhati', 'Anup Nagar', 'Arambag', 'Argari', 'Arjunpur', 'Arra', 'Asansol', 'Ashadtalya', 'Aurangabad', 'Badamtam Tea Garden', 'Badkulla', 'Baduria', 'Bagnan', 'Bagula', 'Bahirgram', 'Bahula', 'Baidyabati', 'Bakreshwar Thermal', 'Power Township', 'Baksa', 'Balarampota', 'Balarampur', 'Balarampur, South Twenty', 'Four Parganas District', 'Balichak', 'Balihati', 'Bally', 'Baluhati', 'Balurghat', 'Bamangram', 'Bamanpukur', 'Bamna', 'Bamunari', 'Ban Harishpur', 'Banarhat Tea Garden', 'Bandhail', 'Bandipur', 'Bandoan', 'Baneshwarpur', 'Baneshwarpur Haora', 'District', 'Baneswar', 'Bangalpur', 'Bangaon', 'Baniban', 'Baniban Jagadishpur', 'Bankra', 'Bankra North Twenty Four', 'Parganas District', 'Bankul', 'Bankura', 'Bansberia', 'Banshra', 'Banupur', 'Bara', 'Bara Jumla', 'Bara Suzapur', 'Barabazar', 'Barasat', 'Barda', 'Bargachhia Bargachhia Hugli District', 'Barijhati', 'Barijpur', 'Barjora', 'Barkalikapur', 'Barrackpur', 'Barrackpur Cantonment', 'Barua Gopalpur', 'Baruipara', 'Baruipur', 'Barunda', 'Basantapur', 'Basanti', 'Basantia', 'Basirhat', 'Baska', 'Basudebpur', 'Basudebpur Purba', 'Medinipur District', 'Batika', 'Batul', 'Bayarsing', 'Begampur', 'Begun Kodar', 'Beldanga', 'Beldubi', 'Beliatore', 'Belumilki', 'Benudia', 'Berhampore', 'Betpuli', 'Bhabki', 'Bhadreswar', 'Bhagabatipur', 'Bhandar Gachha', 'Bhandardaha', 'Bhangar Raghunathpur Bhangri Pratham Khanda', 'Bhasa', 'Bhasaipaikar', 'Bhatpara', 'Bhimram', 'Bholar Dabri', 'Bidhan Nagar', 'Bikihakola', 'Bilandapur', 'Bilpahari', 'Bipra Noapara', 'Bira', 'Birlapur', 'Birnagar', 'Birodhi', 'Birpara', 'Birpara, Jalpaiguri District', 'Bishnupur', 'Bishnupur Birbhum', 'District', 'Bishnupur Industrial', 'Growth Centre', 'Bishnupur, South Twenty', 'Four Parganas District', 'Bolpur', 'Bora Gagangohalia', 'Borai', 'Bowali', 'Brindabanpur', 'Budge Budge', 'Buita', 'Burdwan', 'Cart Road', 'Chachanda', 'Chak Alampur', 'Chak Bankola', 'Chak Baria Chak Bhrigu', 'Chak Enayetnagar', 'Chak Kanthalia', 'Chak Kashipur', 'Chakapara', 'Chakdaha', 'Chakiabhita', 'Chakmeghoan', 'Chalsa Mahabari', 'Champahati', 'Champdani', 'Chamrail', 'Chanchal', 'Chandannagar', 'Chandapur', 'Champagachhi', 'Chanddandaha', 'Chandipur', 'Chandipur Haora District', 'Chandpala Anantapathpur', 'Chandpur', 'Chandpur South Twenty', 'Four Parganas District', 'Chandrakona', 'Chandrapur', 'Chapari', 'Chapra', 'Chaspara', 'Chaulia', 'Chechakhata', 'Chekya', 'Chhekati', 'Chhora', 'Chhota Laukuthi', 'Chhota Suzapur', 'Chikanpara', 'Chikrand Chinchuria', 'Chittaranjan', 'Chong Ghurali', 'Chongtong Tea Garden', 'Chopra', 'Contai', 'Dafahat', 'Dakhin Rampur', 'Dakshin Baguan', 'Dakshin Chatra', 'Dakshin Jhapardaha', 'Dakshin Odlabari', 'Dakshin Rajyadharpur', 'Dakshin Raypur', 'Dakshin Santoshpur', 'Dalkhola', 'Dalurband', 'Danga', 'Dankuni', 'Darappur', 'Darjeeling', 'Daulatpur', 'Deara', 'Debipur', 'Deora', 'Deulgram', 'Deuli', 'Deulia', 'Dhakuria', 'Dhaliabari', 'Dhamua', 'Dhandadihi', 'Dhania', 'Dhanyakuria', 'Dharmapur', 'Dhatrigram', 'Dhola Dhuilya', 'Dhulasimla', 'Dhulian', 'Dhunki', 'Dhupguri', 'Dhusaripara', 'Diamond Harbour', 'Digha', 'Dighirpar', 'Dignala', 'Dihimandalghat', 'Dinga Khola', 'Dinhata', 'Dogachhia', 'Dogachhia Barddhaman', 'District', 'Domjur', 'Dubra', 'Dubrajpur', 'Dudhkalmi', 'Durgapur', 'Durllabhganj', 'Egra', 'Ekabbarpur', 'Eksara', 'Erashal', 'Falakata', 'Falta Industrial Growth', 'Centre', 'Farakka Barrage', 'Township', 'Farakka PTS Township', 'Fatehpur', 'Fatellapur', 'Fatepur', 'Gabberia', 'Gairkata Gangadharpur', 'Gangarampur', 'Gangi', 'Gangnapur', 'Gangni', 'Garalgachha', 'Garbeta', 'Garh Kamalpur', 'Garshyamnagar', 'Garulia', 'Gaur Daha', 'Geni', 'Ghatal', 'Ghola Noapara', 'Ghoraberia', 'Ghutgarya', 'Ging Tea Garden', 'Giria', 'Goasafat', 'Gobardanga', 'Gobindapur', 'Gopalpur', 'Guskara', 'Habra', 'Haldia', 'Haldibari', 'Halisahar', 'Halyan', 'Hanskunda', 'Hanspukuria', 'Haora', 'Harharia Chak', 'Harinadibhastsala', 'Harindanga', 'Haringhata Farm', 'Haripur', 'Harirampur Harishpur', 'Hasimnagar', 'Hatgachha', 'Hatsimla', 'Hijuli', 'Hincha Gerya', 'Hindusthan Cables Town', 'Hingalganj', 'Hirapur', 'Hugli-Chinsurah', 'Hutmura', 'Ichhapur Defence Estate', 'Ichhlampur', 'Ilambazar', 'Islampur', 'Itahar', 'Itinda', 'Jadupur', 'Jafarpur', 'Jagadanandapur', 'Jagadishpur', 'Jagatballavpur', 'Jagatnagar', 'Jagijhora Barabak', 'Jagtaj', 'Jala Kendua', 'Jallabad', 'Jalpaiguri', 'Jaluidanga', 'Jamuria', 'Janai', 'Jangalpara', 'Jangalpara, Hugli District', 'Jangipur', 'Jateshwar', 'Jaygaon', 'Jaykrishnapur', 'Jaynagar Mazilpur', 'Jaypur', 'Jemari', 'Jetia', 'Jhalda', 'Jhanti Pahari', 'Jhargram', 'Jhorhat', 'Jiaganj Azimganj', 'Jirat', 'Joka', 'Joypul', 'Jujarsaha', 'Kachu Pukur', 'Kaijuri', 'Kajora', 'Kakdihi', 'Kakramari', 'Kalara', 'Kalaria', 'Kalas North', 'Kaliaganj', 'Kalikapota', 'Kalikapur', 'Kalimpong', 'Kalipur', 'Kalipur Barddhaman', 'District', 'Kalna', 'Kalyani', 'Kalyanpur', 'Kamalapur', 'Kamat Phulbari', 'Kanaipur', 'Kanaipur Haora District', 'Kanchrapara', 'Kandi Kanganbaria', 'Kanki', 'Kankuria', 'Kanpur', 'Kantaberia', 'Kantlia', 'Kanyanagar', 'Kapashanria', 'Karari Chandpur', 'Karia', 'Karidhya', 'Karimpur', 'Kashimnagar', 'Katwa', 'Kaugachhi', 'Kenda', 'Kendra Khottamdi', 'Kendua', 'Kesabpur', 'Khajutti', 'Khalia', 'Khalor', 'Khandra', 'Khanpur', 'Khantora', 'Kharagpur', 'Kharar', 'Khardaha', 'Khardaha Haora District', 'Kharibari', 'Kharsarai', 'Khatra', 'Khidirpur', 'Khidirpur, Murshidabad', 'District', 'Khorddabamonia', 'Koch Bihar Kodalia', 'Kokapur', 'Kolaghat', 'Kolkata', 'Komarhat', 'Konardihi', 'Konnagar', 'Kotbar', 'Kotulpur', 'Koyra', 'Kriparampur', 'Krishna Sali', 'Krishnanagar', 'Krishnapur', 'Krishnapur Maldah', 'District', 'Kshidirpur', 'Kshirpai', 'Kulia', 'Kulihanda', 'Kulitapara', 'Kulti', 'Kurseong', 'Labhpur', 'Lagda', 'Lalpur', 'Lapara', 'Laskarpara', 'Lataguri', 'Madhyamgram', 'Madna', 'Mahadeb Nagar', 'Mahal', 'Mahiari', 'Mahira', 'Mahishrekha', 'Mainaguri Makardaha', 'Makhal Tala', 'Malbazar', 'Malda', 'Mamrejpur', 'Manbazar', 'Mandarbani', 'Mangalbari', 'Mangarjung Tea Garden', 'Manikpur', 'Manirampur', 'Mansinhapur', 'Manushpur', 'Masat', 'Masat South Twenty Four', 'Parganas District', 'Maslandapur', 'Mathabhanga', 'Matialihat', 'Matiari', 'Matla', 'Medinipur', 'Mejia Thermal', 'PowerTownship', 'Mekliganj', 'Memari', 'Milki', 'Minakhan', 'Mira', 'Mirdhanga', 'Mirik', 'Mirzapur', 'Mohanpur', 'Mugkalyan', 'Muragachha', 'Murarai', 'Murshidabad Murulia', 'Nababpur', 'Nabadwip', 'Nabaghanapur', 'Nabagram', 'Nabagram Colony', 'Nabgram', 'Nadabhanga', 'Nagar Changrabandha', 'Nagdaha', 'Nahazari', 'Naihati', 'Nainan', 'Naiti', 'Nalahati', 'Naldanga', 'Nalpur', 'Nandigram', 'Naridana', 'Nasaratpur', 'Nasibpur', 'Natibpur', 'Naul', 'Naupala', 'Nawapara', 'Nayabahadurpur', 'Nebadhai Duttapukur', 'New Barrackpur', 'New Town', 'Nibra', 'Nischintapur', 'Nischintapur Paschim', 'Medinipur District', 'Nokpul', 'North Barrackpur', 'Nrisinghapur', 'Odlabari Pairagachha', 'Palashban', 'Palashi', 'Panchghara', 'Panchla', 'Panchpara', 'Pandua', 'Paniara', 'Panihati', 'Panuria', 'Par Patiram', 'Para', 'Parangarpar', 'Paranpara', 'Parashkol', 'Parasia', 'Parota', 'Paschim Bainan', 'Paschim Gazipur', 'Paschim Jitpur', 'Paschim Panchla', 'Paschim Punropara', 'Pashchim Khalna', 'Patdaha', 'Patharberia', 'Patihal', 'Patuli', 'Patulia', 'Phulia', 'Poali', 'Podara', 'Prayagpur', 'Pujali', 'Purba Bishnupur', 'Purbba Narayanpur', 'Purbba Tajpur', 'Puruliya Radhapur', 'Raghudebbati', 'Raghunathpur', 'Raghunathpur, Puruliya', 'District', 'Raichak', 'Raigachhi', 'Raiganj', 'Raipur', 'Rajbalhat', 'Rajnagar', 'Rajpur Bazar', 'Rajpur Sonarpur', 'Ramakantapur', 'Ramanathpur', 'Ramchandrapur', 'Rameswarpur', 'Ramjibanpur', 'Ramkrishnapur', 'Ramnagar', 'Rampurhat', 'Ranaghat', 'Rangabhita', 'Raniganj', 'Raninagar Industrial', 'Growth Centre', 'Raynagar', 'Rishra', 'Rongmook Ceder Tea', 'Garden', 'Ruiya', 'Sadigachhi', 'Sahapur', 'Sahebganj', 'Sahebpur', 'Sainthia', 'Salap Salar', 'Samali', 'Samudragarh', 'Samuktola', 'Sangrampur', 'Sankarpur', 'Sankrail', 'Santaldih', 'Santipur', 'Santoshpur', 'Sarenga', 'Sarpi', 'Sehara', 'Serampore', 'Serpur', 'Shankara', 'Shashati', 'Shilda', 'Shimulpur', 'Shyamdhan', 'Shyampur', 'Sibnagar', 'Siduli', 'Silampur', 'Siliguri', 'Simhat', 'Simla', 'Simlapal', 'Singtam Tea Garden', 'Singur', 'Sirakol', 'Sirsha', 'Sisha-Jumrha', 'Sobhaganj', 'Solgohalia', 'Sonada Khasmahal', 'Sonamukhi', 'Sonatikiri', 'Srimantapur', 'Sripur', 'Subarnapur', 'Sukdal', 'Sukhiapokhri', 'Suri', 'Taki', 'Talbandha', 'Taldi', 'Tamluk', 'Tarakeswar', 'Tehatta', 'Tehatta Nadia District', 'Teleni Para', 'Telipara Tea Garden', 'Tentulkuli', 'Tisa', 'Titagarh', 'Tufanganj', 'Udang', 'Ukhra', 'Uluberia', 'Uluberia Near Kolkata', 'Usthi', 'Uttar Bagdogra', 'Uttar Bishnupur', 'Uttar Jhapardaha', 'Uttar Kamakhyaguri', 'Uttar Kusum', 'Uttar Latabari', 'Uttar Madarihat', 'Uttar Mahammadpur', 'Uttar Pirpur', 'Uttar Raypur', 'Uttar Satali', 'Uttarpara Kotrung WBIIDC Growth Centre', 'Uluberia', 'Travel Destinations', 'Agra', 'Ahmedabad', 'Ajanta', 'Ajmer', 'Alappuzha', 'Alibaug', 'Allahabad', 'Almora', 'Alwar', 'Amarkantak', 'Amritsar', 'Auli', 'Aurangabad', 'Badrinath', 'Bageshwar', 'Bandhawagarh', 'Belgaum', 'Bharatpur', 'Bhopal', 'Bikaner', 'Bodh Gaya', 'Bundi', 'Chail', 'Chamba', 'Chamoli', 'Chittaurgarh', 'Coimbatore', 'Corbett', 'Dalhousie', 'Darjiling', 'Dehradun', 'Dhanaulti', 'Dwarka ', 'Ernakulam', 'Fatehpur Sikri', 'Gandhinagar', 'Gangotri', 'Gangtok', 'Gorakhpur', 'Gulmarg', 'Guntur', 'Guwahati', 'Gwalior', 'Hampi', 'Hardwar', 'Hassan', 'Hazaribagh', 'Hospet', 'Indore', 'Jaipur', 'Jaisalmer', 'Jalandhar', 'Jamshedpur', 'Jhansi', 'Jodhpur', 'Joshimath', 'Kangra', 'Kanniyakumari', 'Kanpur', 'Kasauli', 'Kausani', 'Khajuraho', 'Kochi', 'Kolkata', 'Kollam', 'Kottayam', 'Kovalam', 'Kozhikode', 'Kullu', 'Kumarakom ', 'Kumbakonam', 'Lucknow', 'Ludhiana', 'Madurai', 'Mamallapuram', 'Manali', 'Mangalore', 'Mathura', 'Mount Abu', 'Mussoorie', 'Mysore', 'Nainital', 'Nalsarovar', 'Nangal', 'Nellore', 'Pachmarhi', 'Pahalgam', 'Palakkad', 'Panaji', 'Pathankot', 'Patna', 'Patnitop', 'Pauri', 'Pondicherry', 'Porbandar', 'Puri', 'Pushkar', 'Rajgir', 'Rajkot', 'Ranikhet', 'Rishikesh', 'Rudraprayag', 'Sanchi', 'Sariska', 'Sarnath', 'Shillong', 'Shimla ', 'Shirdi', 'Siliguri', 'Surat', 'Thalassery', 'Thiruvananthapuram', 'Thrissur', 'Tiruchirappalli', 'Tirupati', 'Udaipur', 'Vadodara', 'Varanasi', 'Vijayawada', 'Visakhapatnam', 'Vrindavan', 'Warangal', 'Ahmedabad', 'Allahabad', 'Auraiya', 'Azamgarh', 'Belgaum', 'Bengaluru', 'Bettiah', 'Bhagalpur', 'Bhavnagar', 'Bhopal', 'Bhubaneswar', 'Bidhan Nagar', 'Chandigarh', 'Chennai', 'Cheranallur', 'Coimbatore', 'Darbhanga', 'Dehradun', 'DeoriaCities with House', 'Addresses* Eloor', 'Ernakulam', 'Etawah', 'Faridabad', 'Ghaziabad', 'Gorakhpur', 'Greater Noida', 'Gurgaon', 'Hyderabad', 'Indore', 'Jaipur', 'Jalandhar', 'Jamalpur', 'Jammu', 'Jamnagar', 'Kadungalloor', 'Kalamassery', 'Kalyan', 'Kanpur', 'Kishanganj', 'Kochi', 'Kolkata', 'Kollam', 'Latur', 'Lucknow', 'Ludhiana', 'Madurai', 'Mainpuri', 'Manesar', 'Mohali', 'Moradabad', 'Motihari', 'Mumbai', 'Munger', 'Muradnagar', 'Muzaffarpur Mysore', 'Nagpur', 'Nashik', 'Navi Mumbai', 'New Delhi', 'New Town', 'Noida', 'Padrauna', 'Panchkula', 'Pimpri Chinchwad', 'Puducherry', 'Pune', 'Rajkot', 'Saharanpur', 'Saharsa', 'Salem', 'Sangli Miraj Kupwad', 'Secunderabad', 'Sitamarhi', 'Srinagar', 'Surat', 'Thane', 'Thiruvananthapuram', 'Thiruvankulam', 'Thrippunithura', 'Tronica City', 'Vadodara', 'Varanasi', 'Vazhakkala', 'Vijayawada']
</file>

<file path="src/utils/CountryCodes.ts">
export const countryCodes = [
    {
    "name": "Afghanistan",
    "dial_code": "+93",
    "code": "AF"
    },
    {
    "name": "Aland Islands",
    "dial_code": "+358",
    "code": "AX"
    },
    {
    "name": "Albania",
    "dial_code": "+355",
    "code": "AL"
    },
    {
    "name": "Algeria",
    "dial_code": "+213",
    "code": "DZ"
    },
    {
    "name": "AmericanSamoa",
    "dial_code": "+1684",
    "code": "AS"
    },
    {
    "name": "Andorra",
    "dial_code": "+376",
    "code": "AD"
    },
    {
    "name": "Angola",
    "dial_code": "+244",
    "code": "AO"
    },
    {
    "name": "Anguilla",
    "dial_code": "+1264",
    "code": "AI"
    },
    {
    "name": "Antarctica",
    "dial_code": "+672",
    "code": "AQ"
    },
    {
    "name": "Antigua and Barbuda",
    "dial_code": "+1268",
    "code": "AG"
    },
    {
    "name": "Argentina",
    "dial_code": "+54",
    "code": "AR"
    },
    {
    "name": "Armenia",
    "dial_code": "+374",
    "code": "AM"
    },
    {
    "name": "Aruba",
    "dial_code": "+297",
    "code": "AW"
    },
    {
    "name": "Australia",
    "dial_code": "+61",
    "code": "AU"
    },
    {
    "name": "Austria",
    "dial_code": "+43",
    "code": "AT"
    },
    {
    "name": "Azerbaijan",
    "dial_code": "+994",
    "code": "AZ"
    },
    {
    "name": "Bahamas",
    "dial_code": "+1242",
    "code": "BS"
    },
    {
    "name": "Bahrain",
    "dial_code": "+973",
    "code": "BH"
    },
    {
    "name": "Bangladesh",
    "dial_code": "+880",
    "code": "BD"
    },
    {
    "name": "Barbados",
    "dial_code": "+1246",
    "code": "BB"
    },
    {
    "name": "Belarus",
    "dial_code": "+375",
    "code": "BY"
    },
    {
    "name": "Belgium",
    "dial_code": "+32",
    "code": "BE"
    },
    {
    "name": "Belize",
    "dial_code": "+501",
    "code": "BZ"
    },
    {
    "name": "Benin",
    "dial_code": "+229",
    "code": "BJ"
    },
    {
    "name": "Bermuda",
    "dial_code": "+1441",
    "code": "BM"
    },
    {
    "name": "Bhutan",
    "dial_code": "+975",
    "code": "BT"
    },
    {
    "name": "Bolivia, Plurinational State of",
    "dial_code": "+591",
    "code": "BO"
    },
    {
    "name": "Bosnia and Herzegovina",
    "dial_code": "+387",
    "code": "BA"
    },
    {
    "name": "Botswana",
    "dial_code": "+267",
    "code": "BW"
    },
    {
    "name": "Brazil",
    "dial_code": "+55",
    "code": "BR"
    },
    {
    "name": "British Indian Ocean Territory",
    "dial_code": "+246",
    "code": "IO"
    },
    {
    "name": "Brunei Darussalam",
    "dial_code": "+673",
    "code": "BN"
    },
    {
    "name": "Bulgaria",
    "dial_code": "+359",
    "code": "BG"
    },
    {
    "name": "Burkina Faso",
    "dial_code": "+226",
    "code": "BF"
    },
    {
    "name": "Burundi",
    "dial_code": "+257",
    "code": "BI"
    },
    {
    "name": "Cambodia",
    "dial_code": "+855",
    "code": "KH"
    },
    {
    "name": "Cameroon",
    "dial_code": "+237",
    "code": "CM"
    },
    {
    "name": "Canada",
    "dial_code": "+1",
    "code": "CA"
    },
    {
    "name": "Cape Verde",
    "dial_code": "+238",
    "code": "CV"
    },
    {
    "name": "Cayman Islands",
    "dial_code": "+ 345",
    "code": "KY"
    },
    {
    "name": "Central African Republic",
    "dial_code": "+236",
    "code": "CF"
    },
    {
    "name": "Chad",
    "dial_code": "+235",
    "code": "TD"
    },
    {
    "name": "Chile",
    "dial_code": "+56",
    "code": "CL"
    },
    {
    "name": "China",
    "dial_code": "+86",
    "code": "CN"
    },
    {
    "name": "Christmas Island",
    "dial_code": "+61",
    "code": "CX"
    },
    {
    "name": "Cocos (Keeling) Islands",
    "dial_code": "+61",
    "code": "CC"
    },
    {
    "name": "Colombia",
    "dial_code": "+57",
    "code": "CO"
    },
    {
    "name": "Comoros",
    "dial_code": "+269",
    "code": "KM"
    },
    {
    "name": "Congo",
    "dial_code": "+242",
    "code": "CG"
    },
    {
    "name": "Congo, The Democratic Republic of the Congo",
    "dial_code": "+243",
    "code": "CD"
    },
    {
    "name": "Cook Islands",
    "dial_code": "+682",
    "code": "CK"
    },
    {
    "name": "Costa Rica",
    "dial_code": "+506",
    "code": "CR"
    },
    {
    "name": "Cote d'Ivoire",
    "dial_code": "+225",
    "code": "CI"
    },
    {
    "name": "Croatia",
    "dial_code": "+385",
    "code": "HR"
    },
    {
    "name": "Cuba",
    "dial_code": "+53",
    "code": "CU"
    },
    {
    "name": "Cyprus",
    "dial_code": "+357",
    "code": "CY"
    },
    {
    "name": "Czech Republic",
    "dial_code": "+420",
    "code": "CZ"
    },
    {
    "name": "Denmark",
    "dial_code": "+45",
    "code": "DK"
    },
    {
    "name": "Djibouti",
    "dial_code": "+253",
    "code": "DJ"
    },
    {
    "name": "Dominica",
    "dial_code": "+1767",
    "code": "DM"
    },
    {
    "name": "Dominican Republic",
    "dial_code": "+1849",
    "code": "DO"
    },
    {
    "name": "Ecuador",
    "dial_code": "+593",
    "code": "EC"
    },
    {
    "name": "Egypt",
    "dial_code": "+20",
    "code": "EG"
    },
    {
    "name": "El Salvador",
    "dial_code": "+503",
    "code": "SV"
    },
    {
    "name": "Equatorial Guinea",
    "dial_code": "+240",
    "code": "GQ"
    },
    {
    "name": "Eritrea",
    "dial_code": "+291",
    "code": "ER"
    },
    {
    "name": "Estonia",
    "dial_code": "+372",
    "code": "EE"
    },
    {
    "name": "Ethiopia",
    "dial_code": "+251",
    "code": "ET"
    },
    {
    "name": "Falkland Islands (Malvinas)",
    "dial_code": "+500",
    "code": "FK"
    },
    {
    "name": "Faroe Islands",
    "dial_code": "+298",
    "code": "FO"
    },
    {
    "name": "Fiji",
    "dial_code": "+679",
    "code": "FJ"
    },
    {
    "name": "Finland",
    "dial_code": "+358",
    "code": "FI"
    },
    {
    "name": "France",
    "dial_code": "+33",
    "code": "FR"
    },
    {
    "name": "French Guiana",
    "dial_code": "+594",
    "code": "GF"
    },
    {
    "name": "French Polynesia",
    "dial_code": "+689",
    "code": "PF"
    },
    {
    "name": "Gabon",
    "dial_code": "+241",
    "code": "GA"
    },
    {
    "name": "Gambia",
    "dial_code": "+220",
    "code": "GM"
    },
    {
    "name": "Georgia",
    "dial_code": "+995",
    "code": "GE"
    },
    {
    "name": "Germany",
    "dial_code": "+49",
    "code": "DE"
    },
    {
    "name": "Ghana",
    "dial_code": "+233",
    "code": "GH"
    },
    {
    "name": "Gibraltar",
    "dial_code": "+350",
    "code": "GI"
    },
    {
    "name": "Greece",
    "dial_code": "+30",
    "code": "GR"
    },
    {
    "name": "Greenland",
    "dial_code": "+299",
    "code": "GL"
    },
    {
    "name": "Grenada",
    "dial_code": "+1473",
    "code": "GD"
    },
    {
    "name": "Guadeloupe",
    "dial_code": "+590",
    "code": "GP"
    },
    {
    "name": "Guam",
    "dial_code": "+1671",
    "code": "GU"
    },
    {
    "name": "Guatemala",
    "dial_code": "+502",
    "code": "GT"
    },
    {
    "name": "Guernsey",
    "dial_code": "+44",
    "code": "GG"
    },
    {
    "name": "Guinea",
    "dial_code": "+224",
    "code": "GN"
    },
    {
    "name": "Guinea-Bissau",
    "dial_code": "+245",
    "code": "GW"
    },
    {
    "name": "Guyana",
    "dial_code": "+595",
    "code": "GY"
    },
    {
    "name": "Haiti",
    "dial_code": "+509",
    "code": "HT"
    },
    {
    "name": "Holy See (Vatican City State)",
    "dial_code": "+379",
    "code": "VA"
    },
    {
    "name": "Honduras",
    "dial_code": "+504",
    "code": "HN"
    },
    {
    "name": "Hong Kong",
    "dial_code": "+852",
    "code": "HK"
    },
    {
    "name": "Hungary",
    "dial_code": "+36",
    "code": "HU"
    },
    {
    "name": "Iceland",
    "dial_code": "+354",
    "code": "IS"
    },
    {
    "name": "India",
    "dial_code": "+91",
    "code": "IN"
    },
    {
    "name": "Indonesia",
    "dial_code": "+62",
    "code": "ID"
    },
    {
    "name": "Iran, Islamic Republic of Persian Gulf",
    "dial_code": "+98",
    "code": "IR"
    },
    {
    "name": "Iraq",
    "dial_code": "+964",
    "code": "IQ"
    },
    {
    "name": "Ireland",
    "dial_code": "+353",
    "code": "IE"
    },
    {
    "name": "Isle of Man",
    "dial_code": "+44",
    "code": "IM"
    },
    {
    "name": "Israel",
    "dial_code": "+972",
    "code": "IL"
    },
    {
    "name": "Italy",
    "dial_code": "+39",
    "code": "IT"
    },
    {
    "name": "Jamaica",
    "dial_code": "+1876",
    "code": "JM"
    },
    {
    "name": "Japan",
    "dial_code": "+81",
    "code": "JP"
    },
    {
    "name": "Jersey",
    "dial_code": "+44",
    "code": "JE"
    },
    {
    "name": "Jordan",
    "dial_code": "+962",
    "code": "JO"
    },
    {
    "name": "Kazakhstan",
    "dial_code": "+77",
    "code": "KZ"
    },
    {
    "name": "Kenya",
    "dial_code": "+254",
    "code": "KE"
    },
    {
    "name": "Kiribati",
    "dial_code": "+686",
    "code": "KI"
    },
    {
    "name": "Korea, Democratic People's Republic of Korea",
    "dial_code": "+850",
    "code": "KP"
    },
    {
    "name": "Korea, Republic of South Korea",
    "dial_code": "+82",
    "code": "KR"
    },
    {
    "name": "Kuwait",
    "dial_code": "+965",
    "code": "KW"
    },
    {
    "name": "Kyrgyzstan",
    "dial_code": "+996",
    "code": "KG"
    },
    {
    "name": "Laos",
    "dial_code": "+856",
    "code": "LA"
    },
    {
    "name": "Latvia",
    "dial_code": "+371",
    "code": "LV"
    },
    {
    "name": "Lebanon",
    "dial_code": "+961",
    "code": "LB"
    },
    {
    "name": "Lesotho",
    "dial_code": "+266",
    "code": "LS"
    },
    {
    "name": "Liberia",
    "dial_code": "+231",
    "code": "LR"
    },
    {
    "name": "Libyan Arab Jamahiriya",
    "dial_code": "+218",
    "code": "LY"
    },
    {
    "name": "Liechtenstein",
    "dial_code": "+423",
    "code": "LI"
    },
    {
    "name": "Lithuania",
    "dial_code": "+370",
    "code": "LT"
    },
    {
    "name": "Luxembourg",
    "dial_code": "+352",
    "code": "LU"
    },
    {
    "name": "Macao",
    "dial_code": "+853",
    "code": "MO"
    },
    {
    "name": "Macedonia",
    "dial_code": "+389",
    "code": "MK"
    },
    {
    "name": "Madagascar",
    "dial_code": "+261",
    "code": "MG"
    },
    {
    "name": "Malawi",
    "dial_code": "+265",
    "code": "MW"
    },
    {
    "name": "Malaysia",
    "dial_code": "+60",
    "code": "MY"
    },
    {
    "name": "Maldives",
    "dial_code": "+960",
    "code": "MV"
    },
    {
    "name": "Mali",
    "dial_code": "+223",
    "code": "ML"
    },
    {
    "name": "Malta",
    "dial_code": "+356",
    "code": "MT"
    },
    {
    "name": "Marshall Islands",
    "dial_code": "+692",
    "code": "MH"
    },
    {
    "name": "Martinique",
    "dial_code": "+596",
    "code": "MQ"
    },
    {
    "name": "Mauritania",
    "dial_code": "+222",
    "code": "MR"
    },
    {
    "name": "Mauritius",
    "dial_code": "+230",
    "code": "MU"
    },
    {
    "name": "Mayotte",
    "dial_code": "+262",
    "code": "YT"
    },
    {
    "name": "Mexico",
    "dial_code": "+52",
    "code": "MX"
    },
    {
    "name": "Micronesia, Federated States of Micronesia",
    "dial_code": "+691",
    "code": "FM"
    },
    {
    "name": "Moldova",
    "dial_code": "+373",
    "code": "MD"
    },
    {
    "name": "Monaco",
    "dial_code": "+377",
    "code": "MC"
    },
    {
    "name": "Mongolia",
    "dial_code": "+976",
    "code": "MN"
    },
    {
    "name": "Montenegro",
    "dial_code": "+382",
    "code": "ME"
    },
    {
    "name": "Montserrat",
    "dial_code": "+1664",
    "code": "MS"
    },
    {
    "name": "Morocco",
    "dial_code": "+212",
    "code": "MA"
    },
    {
    "name": "Mozambique",
    "dial_code": "+258",
    "code": "MZ"
    },
    {
    "name": "Myanmar",
    "dial_code": "+95",
    "code": "MM"
    },
    {
    "name": "Namibia",
    "dial_code": "+264",
    "code": "NA"
    },
    {
    "name": "Nauru",
    "dial_code": "+674",
    "code": "NR"
    },
    {
    "name": "Nepal",
    "dial_code": "+977",
    "code": "NP"
    },
    {
    "name": "Netherlands",
    "dial_code": "+31",
    "code": "NL"
    },
    {
    "name": "Netherlands Antilles",
    "dial_code": "+599",
    "code": "AN"
    },
    {
    "name": "New Caledonia",
    "dial_code": "+687",
    "code": "NC"
    },
    {
    "name": "New Zealand",
    "dial_code": "+64",
    "code": "NZ"
    },
    {
    "name": "Nicaragua",
    "dial_code": "+505",
    "code": "NI"
    },
    {
    "name": "Niger",
    "dial_code": "+227",
    "code": "NE"
    },
    {
    "name": "Nigeria",
    "dial_code": "+234",
    "code": "NG"
    },
    {
    "name": "Niue",
    "dial_code": "+683",
    "code": "NU"
    },
    {
    "name": "Norfolk Island",
    "dial_code": "+672",
    "code": "NF"
    },
    {
    "name": "Northern Mariana Islands",
    "dial_code": "+1670",
    "code": "MP"
    },
    {
    "name": "Norway",
    "dial_code": "+47",
    "code": "NO"
    },
    {
    "name": "Oman",
    "dial_code": "+968",
    "code": "OM"
    },
    {
    "name": "Pakistan",
    "dial_code": "+92",
    "code": "PK"
    },
    {
    "name": "Palau",
    "dial_code": "+680",
    "code": "PW"
    },
    {
    "name": "Palestinian Territory, Occupied",
    "dial_code": "+970",
    "code": "PS"
    },
    {
    "name": "Panama",
    "dial_code": "+507",
    "code": "PA"
    },
    {
    "name": "Papua New Guinea",
    "dial_code": "+675",
    "code": "PG"
    },
    {
    "name": "Paraguay",
    "dial_code": "+595",
    "code": "PY"
    },
    {
    "name": "Peru",
    "dial_code": "+51",
    "code": "PE"
    },
    {
    "name": "Philippines",
    "dial_code": "+63",
    "code": "PH"
    },
    {
    "name": "Pitcairn",
    "dial_code": "+872",
    "code": "PN"
    },
    {
    "name": "Poland",
    "dial_code": "+48",
    "code": "PL"
    },
    {
    "name": "Portugal",
    "dial_code": "+351",
    "code": "PT"
    },
    {
    "name": "Puerto Rico",
    "dial_code": "+1939",
    "code": "PR"
    },
    {
    "name": "Qatar",
    "dial_code": "+974",
    "code": "QA"
    },
    {
    "name": "Romania",
    "dial_code": "+40",
    "code": "RO"
    },
    {
    "name": "Russia",
    "dial_code": "+7",
    "code": "RU"
    },
    {
    "name": "Rwanda",
    "dial_code": "+250",
    "code": "RW"
    },
    {
    "name": "Reunion",
    "dial_code": "+262",
    "code": "RE"
    },
    {
    "name": "Saint Barthelemy",
    "dial_code": "+590",
    "code": "BL"
    },
    {
    "name": "Saint Helena, Ascension and Tristan Da Cunha",
    "dial_code": "+290",
    "code": "SH"
    },
    {
    "name": "Saint Kitts and Nevis",
    "dial_code": "+1869",
    "code": "KN"
    },
    {
    "name": "Saint Lucia",
    "dial_code": "+1758",
    "code": "LC"
    },
    {
    "name": "Saint Martin",
    "dial_code": "+590",
    "code": "MF"
    },
    {
    "name": "Saint Pierre and Miquelon",
    "dial_code": "+508",
    "code": "PM"
    },
    {
    "name": "Saint Vincent and the Grenadines",
    "dial_code": "+1784",
    "code": "VC"
    },
    {
    "name": "Samoa",
    "dial_code": "+685",
    "code": "WS"
    },
    {
    "name": "San Marino",
    "dial_code": "+378",
    "code": "SM"
    },
    {
    "name": "Sao Tome and Principe",
    "dial_code": "+239",
    "code": "ST"
    },
    {
    "name": "Saudi Arabia",
    "dial_code": "+966",
    "code": "SA"
    },
    {
    "name": "Senegal",
    "dial_code": "+221",
    "code": "SN"
    },
    {
    "name": "Serbia",
    "dial_code": "+381",
    "code": "RS"
    },
    {
    "name": "Seychelles",
    "dial_code": "+248",
    "code": "SC"
    },
    {
    "name": "Sierra Leone",
    "dial_code": "+232",
    "code": "SL"
    },
    {
    "name": "Singapore",
    "dial_code": "+65",
    "code": "SG"
    },
    {
    "name": "Slovakia",
    "dial_code": "+421",
    "code": "SK"
    },
    {
    "name": "Slovenia",
    "dial_code": "+386",
    "code": "SI"
    },
    {
    "name": "Solomon Islands",
    "dial_code": "+677",
    "code": "SB"
    },
    {
    "name": "Somalia",
    "dial_code": "+252",
    "code": "SO"
    },
    {
    "name": "South Africa",
    "dial_code": "+27",
    "code": "ZA"
    },
    {
    "name": "South Sudan",
    "dial_code": "+211",
    "code": "SS"
    },
    {
    "name": "South Georgia and the South Sandwich Islands",
    "dial_code": "+500",
    "code": "GS"
    },
    {
    "name": "Spain",
    "dial_code": "+34",
    "code": "ES"
    },
    {
    "name": "Sri Lanka",
    "dial_code": "+94",
    "code": "LK"
    },
    {
    "name": "Sudan",
    "dial_code": "+249",
    "code": "SD"
    },
    {
    "name": "Suriname",
    "dial_code": "+597",
    "code": "SR"
    },
    {
    "name": "Svalbard and Jan Mayen",
    "dial_code": "+47",
    "code": "SJ"
    },
    {
    "name": "Swaziland",
    "dial_code": "+268",
    "code": "SZ"
    },
    {
    "name": "Sweden",
    "dial_code": "+46",
    "code": "SE"
    },
    {
    "name": "Switzerland",
    "dial_code": "+41",
    "code": "CH"
    },
    {
    "name": "Syrian Arab Republic",
    "dial_code": "+963",
    "code": "SY"
    },
    {
    "name": "Taiwan",
    "dial_code": "+886",
    "code": "TW"
    },
    {
    "name": "Tajikistan",
    "dial_code": "+992",
    "code": "TJ"
    },
    {
    "name": "Tanzania, United Republic of Tanzania",
    "dial_code": "+255",
    "code": "TZ"
    },
    {
    "name": "Thailand",
    "dial_code": "+66",
    "code": "TH"
    },
    {
    "name": "Timor-Leste",
    "dial_code": "+670",
    "code": "TL"
    },
    {
    "name": "Togo",
    "dial_code": "+228",
    "code": "TG"
    },
    {
    "name": "Tokelau",
    "dial_code": "+690",
    "code": "TK"
    },
    {
    "name": "Tonga",
    "dial_code": "+676",
    "code": "TO"
    },
    {
    "name": "Trinidad and Tobago",
    "dial_code": "+1868",
    "code": "TT"
    },
    {
    "name": "Tunisia",
    "dial_code": "+216",
    "code": "TN"
    },
    {
    "name": "Turkey",
    "dial_code": "+90",
    "code": "TR"
    },
    {
    "name": "Turkmenistan",
    "dial_code": "+993",
    "code": "TM"
    },
    {
    "name": "Turks and Caicos Islands",
    "dial_code": "+1649",
    "code": "TC"
    },
    {
    "name": "Tuvalu",
    "dial_code": "+688",
    "code": "TV"
    },
    {
    "name": "Uganda",
    "dial_code": "+256",
    "code": "UG"
    },
    {
    "name": "Ukraine",
    "dial_code": "+380",
    "code": "UA"
    },
    {
    "name": "United Arab Emirates",
    "dial_code": "+971",
    "code": "AE"
    },
    {
    "name": "United Kingdom",
    "dial_code": "+44",
    "code": "GB"
    },
    {
    "name": "United States",
    "dial_code": "+1",
    "code": "US"
    },
    {
    "name": "Uruguay",
    "dial_code": "+598",
    "code": "UY"
    },
    {
    "name": "Uzbekistan",
    "dial_code": "+998",
    "code": "UZ"
    },
    {
    "name": "Vanuatu",
    "dial_code": "+678",
    "code": "VU"
    },
    {
    "name": "Venezuela, Bolivarian Republic of Venezuela",
    "dial_code": "+58",
    "code": "VE"
    },
    {
    "name": "Vietnam",
    "dial_code": "+84",
    "code": "VN"
    },
    {
    "name": "Virgin Islands, British",
    "dial_code": "+1284",
    "code": "VG"
    },
    {
    "name": "Virgin Islands, U.S.",
    "dial_code": "+1340",
    "code": "VI"
    },
    {
    "name": "Wallis and Futuna",
    "dial_code": "+681",
    "code": "WF"
    },
    {
    "name": "Yemen",
    "dial_code": "+967",
    "code": "YE"
    },
    {
    "name": "Zambia",
    "dial_code": "+260",
    "code": "ZM"
    },
    {
    "name": "Zimbabwe",
    "dial_code": "+263",
    "code": "ZW"
    }
    ]
</file>

<file path="src/utils/encryption.ts">
import CryptoJS from 'crypto-js';

// Replace this with your secret key. It should be stored securely (e.g., in environment variables)
const SECRET_KEY = 'thisislittlesecret';

export function encryptData(data : string) {
    return CryptoJS.AES.encrypt(data, SECRET_KEY).toString();
}

export function decryptData(ciphertext : string) {
    const bytes = CryptoJS.AES.decrypt(ciphertext, SECRET_KEY);
    const originalText = bytes.toString(CryptoJS.enc.Utf8);
    console.log(originalText)
    return originalText;
}
</file>

<file path="src/utils/EwayBillColor.tsx">
import { Idoc, ITrip } from "./interface";

export function ewbColor(trip : ITrip | any) {
    const eWayBillDoc = trip.documents?.find((doc : Idoc) => doc.type === 'E-Way Bill');
    if (!eWayBillDoc?.validityDate) {
      return 'N/A';
    }

    const validityDate = new Date(eWayBillDoc.validityDate);
    const currentDate = new Date(Date.now());
    const timeDifference = validityDate.getTime() - currentDate.getTime(); // Difference in milliseconds
    const daysRemaining = timeDifference / (1000 * 60 * 60 * 24); // Convert to days

    let textColorClass = ''; // Class for text color
    if(trip.status >= 1){
      textColorClass = 'text-gray-500'
    }
    else if (daysRemaining < 0) {
      textColorClass = 'text-red-500'; // Expired
    } else if (daysRemaining <= 2) {
      textColorClass = 'text-yellow-500'; // Near expiry
    } else {
      textColorClass = 'text-green-500'; // Valid
    }

    return (
      <p className={textColorClass}>
        {validityDate.toLocaleDateString('en-IN', {
          day: '2-digit',
          month: '2-digit',
          year: '2-digit',
        })}
      </p>
    );
  }
</file>

<file path="src/utils/excelOperation.ts">
import * as XLSX from 'xlsx'
import { saveAs } from 'file-saver'
import { IDriver, IParty, ITrip, TruckModel } from './interface';

type excelData = ITrip | IDriver | IParty | TruckModel

export const handleExportToExcel = (arr: excelData[], selectedColumns: string[], fileName: string) => {

    // Map the sortedTrips data to include only the selected columns
    const filteredData = arr.map(item =>
        Object.fromEntries(
            selectedColumns.map(col => [col, item[col as keyof excelData] || ""]) // Ensure missing values are empty
        )
    );

    const worksheet = XLSX.utils.json_to_sheet(filteredData);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Trips");

    const excelBuffer = XLSX.write(workbook, { bookType: "xlsx", type: "array" });
    const data = new Blob([excelBuffer], {
        type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    });

    saveAs(data, fileName);
};
</file>

<file path="src/utils/icons.tsx">
import { BsFillPauseCircleFill } from 'react-icons/bs';
import {
    FaTools, // for maintenance and repair
    FaTruckLoading, // for loading
    FaTruckMoving, // for unloading
    FaBalanceScale, // for weight
    FaExclamationCircle, // for other
    FaMoneyCheckAlt, // for payment and expenses
    FaGasPump, // for fuel
    FaWrench, // for repairs
    FaUserTie, // for union charges
  } from 'react-icons/fa';
import { FaLocationDot } from 'react-icons/fa6';
import { GiExpense } from 'react-icons/gi';
import { IoMdDocument } from 'react-icons/io';
import { IoPerson } from 'react-icons/io5';
import { PiSteeringWheel } from 'react-icons/pi';
  
  export const icons = {
    'Detention/Halting Charges': <FaBalanceScale className="text-bottomNavBarColor"/>,
    'Repair Expense': <FaWrench className="text-bottomNavBarColor"/>,
    'Loading Charges': <FaTruckLoading className="text-bottomNavBarColor"/>,
    'Unloading Charges': <FaTruckMoving className="text-bottomNavBarColor"/>,
    'Union Charges': <FaUserTie className="text-bottomNavBarColor"/>,
    'Weight Charges': <FaBalanceScale className="text-bottomNavBarColor"/>,
    'Other Charges': <FaExclamationCircle className="text-bottomNavBarColor"/>,
    'Material Loss': <FaExclamationCircle className="text-bottomNavBarColor"/>,
    'Brokerage': <FaMoneyCheckAlt className="text-bottomNavBarColor"/>,
    'Late Fees': <FaExclamationCircle className="text-bottomNavBarColor"/>,
    'TDS': <FaMoneyCheckAlt className="text-bottomNavBarColor"/>,
    'Mamul': <FaMoneyCheckAlt className="text-bottomNavBarColor"/>,
    'Driver bhatta': <FaMoneyCheckAlt className="text-bottomNavBarColor"/>,
    'Driver payment': <FaMoneyCheckAlt className="text-bottomNavBarColor"/>,
    'Fuel Expense': <FaGasPump className="text-bottomNavBarColor"/>,
    'Police Expense': <FaExclamationCircle className="text-bottomNavBarColor"/>,
    'RTO Expense': <FaExclamationCircle className="text-bottomNavBarColor"/>,
    'Toll Expense': <FaMoneyCheckAlt className="text-bottomNavBarColor"/>,
    'Union Expense': <FaUserTie className="text-bottomNavBarColor"/>,
    'Tyre Puncture': <FaWrench className="text-bottomNavBarColor"/>,
    'Tyre Retread': <FaWrench className="text-bottomNavBarColor"/>,
    'Tyre Purchase': <FaWrench className="text-bottomNavBarColor"/>,
    'Roof Top Repair': <FaWrench className="text-bottomNavBarColor"/>,
    'Showroom Service': <FaTools className="text-bottomNavBarColor"/>,
    'Regular Service': <FaTools className="text-bottomNavBarColor"/>,
    'Minor Repair': <FaTools className="text-bottomNavBarColor"/>,
    'Gear Maintenance': <FaWrench className="text-bottomNavBarColor"/>,
    'Brake Oil Change': <FaTools className="text-bottomNavBarColor"/>,
    'Grease Oil Change': <FaTools className="text-bottomNavBarColor"/>,
    'Spare Parts Purchase': <FaTools className="text-bottomNavBarColor"/>,
    'Air Filter Change': <FaTools className="text-bottomNavBarColor"/>,
    'Detention' : <BsFillPauseCircleFill className="text-bottomNavBarColor"/>, // for detention

  };
  
export const recentIcons : Record<string,React.ReactNode> = {
  'Created New Trip' :  <FaLocationDot size={40} className='text-white bg-blue-500 rounded-lg p-2 border font-semibold' />,
  'Added New Customer' : <IoPerson size={40} className='text-white bg-blue-500 rounded-lg p-2 border font-semibold' />,
  'Added New Driver' : <PiSteeringWheel size={40} className='text-white bg-blue-500 rounded-lg p-2 border font-semibold' />,
  'Updated Driver Details' : <PiSteeringWheel size={40} className='text-white bg-blue-500 rounded-lg p-2 border font-semibold' />,
  'Added Driver Document' : <IoMdDocument size={40} className='text-white bg-blue-500 rounded-lg p-2 border font-semibold' />,
  'Added Trip Document' : <IoMdDocument size={40} className='text-white bg-blue-500 rounded-lg p-2 border font-semibold' />,
  'Added Lorry Document' : <IoMdDocument size={40} className='text-white bg-blue-500 rounded-lg p-2 border font-semibold' />,
  'Added New Expense' : <GiExpense size={40} className='text-white bg-blue-500 rounded-lg p-2 border font-semibold' />,
  'Edited Expense' : <GiExpense size={40} className='text-white bg-blue-500 rounded-lg p-2 border font-semibold' />,
  'Deleted Expense' : <GiExpense size={40} className='text-white bg-blue-500 rounded-lg p-2 border font-semibold' />,
  'Edited Trip Details' :  <FaLocationDot size={40} className='text-white bg-blue-500 rounded-lg p-2 border font-semibold' />,
}

  // Define the type for the keys of the icons object
export type IconKey = 'Detention/Halting Charges' | 'Repair Expense' | 'Loading Charges' | 'Unloading Charges' | 'Union Charges' | 'Weight Charges' | 'Other Charges' | 'Material Loss' | 'Brokerage' | 'Late Fees' | 'TDS' | 'Mamul' | 'Driver bhatta' | 'Driver payment' | 'Fuel Expense' | 'Police Expense' | 'RTO Expense' | 'Toll Expense' | 'Union Expense' | 'Tyre Puncture' | 'Tyre Retread' | 'Tyre Purchase' | 'Roof Top Repair' | 'Showroom Service' | 'Regular Service' | 'Minor Repair' | 'Gear Maintenance' | 'Brake Oil Change' | 'Grease Oil Change' | 'Spare Parts Purchase' | 'Air Filter Change';
</file>

<file path="src/utils/imgColor.ts">
export function getBestLogoColor(imageSrc: string): Promise<string> {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "Anonymous"; // Allow cross-origin image processing
        img.src = imageSrc;

        img.onload = function () {
            // Create a canvas
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");

            if (!ctx) {
                reject(new Error("Unable to get canvas context."));
                return;
            }

            // Scale down the image for faster processing
            const scaledWidth = 50;
            const scaledHeight = (img.height / img.width) * scaledWidth;
            canvas.width = scaledWidth;
            canvas.height = scaledHeight;

            // Draw the scaled image onto the canvas
            ctx.drawImage(img, 0, 0, scaledWidth, scaledHeight);

            // Get the pixel data
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

            // Calculate the best logo color
            const color = calculateAccurateDominantColor(imageData);
            resolve(color);
        };

        img.onerror = function () {
            reject(new Error("Error loading image."));
        };
    });
}

function calculateAccurateDominantColor(data: Uint8ClampedArray): string {
    const colorCounts: { [key: string]: number } = {};
    let maxWeight = 0;
    let bestColor: string | null = null;

    // Helper to convert RGB to HSL
    const rgbToHsl = (r: number, g: number, b: number) => {
        r /= 255;
        g /= 255;
        b /= 255;
        const max = Math.max(r, g, b);
        const min = Math.min(r, g, b);
        let h = 0,
            s = 0,
            l = (max + min) / 2;

        if (max !== min) {
            const delta = max - min;
            s = l > 0.5 ? delta / (2 - max - min) : delta / (max + min);
            if (max === r) h = (g - b) / delta + (g < b ? 6 : 0);
            else if (max === g) h = (b - r) / delta + 2;
            else h = (r - g) / delta + 4;
            h /= 6;
        }

        return { h, s, l }; // h: [0,1], s: [0,1], l: [0,1]
    };

    // Helper to check if a color is suitable
    const isColorSuitable = (r: number, g: number, b: number) => {
        const { s, l } = rgbToHsl(r, g, b);
        return s > 0.2 && l > 0.2 && l < 0.8; // Exclude low saturation and very bright/dark colors
    };

    // Loop through pixel data (RGBA format)
    for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        const a = data[i + 3]; // Alpha channel

        // Skip fully transparent pixels
        if (a === 0) continue;

        // Skip unsuitable colors
        if (!isColorSuitable(r, g, b)) continue;

        const color = `${r},${g},${b}`; // Combine RGB values as a string

        // Weight color based on brightness and saturation
        const { s, l } = rgbToHsl(r, g, b);
        const weight = s * 100 + l * 50; // Adjust weights as needed

        colorCounts[color] = (colorCounts[color] || 0) + weight;

        // Update the best color
        if (colorCounts[color] > maxWeight) {
            maxWeight = colorCounts[color];
            bestColor = color;
        }
    }

    // Fallback to a neutral gray if no valid color is found
    return bestColor ? `rgb(${bestColor})` : "rgb(128,128,128)";
}
</file>

<file path="src/utils/renderTripCell.tsx">
import { FaCalendarAlt, FaTruck } from "react-icons/fa";
import { ITrip } from "./interface";
import { statuses } from "./schema";
import { formatNumber } from "./utilArray";

export function renderCellContent(columnValue: string, trip: ITrip | any) {
    switch (columnValue) {
        case 'startDate':
            return (
                <div className="flex items-center space-x-2">
                    <FaCalendarAlt className="text-orange-600" />
                    <span>{new Date(trip?.startDate).toLocaleDateString()}</span>
                </div>
            );
        case 'date':
            return (
                <div className="flex items-center space-x-2">
                    <FaCalendarAlt className="text-orange-600" />
                    <span>{new Date(trip?.date).toLocaleDateString('en-IN')}</span>
                </div>
            );
        case 'LR':
            return trip?.LR;
        case 'truck':
            return (
                <div className="flex items-center space-x-2">
                    <FaTruck className="text-orange-600" />
                    <span>{trip?.truck}</span>
                </div>
            );
        case 'party':
            return trip?.partyName;
        case 'route':
            return `${trip?.route.origin.split(',')[0]}  ${trip?.route.destination.split(',')[0]}`;
        case 'description':
            return `${trip?.description.origin.split(',')[0]}  ${trip?.description.destination.split(',')[0]}`;
        case 'status':
            return (
                <div className="flex flex-col items-center space-x-2">
                    <span>{statuses[trip?.status as number]}</span>
                    <div className="relative w-full bg-gray-200 h-1 rounded">
                        <div
                            className={`absolute top-0 left-0 h-1 rounded transition-width duration-500 ${trip?.status === 0 ? 'bg-red-500' :
                                trip?.status === 1 ? 'bg-yellow-500' :
                                    trip?.status === 2 ? 'bg-blue-500' :
                                        trip?.status === 3 ? 'bg-green-500' :
                                            'bg-green-800'
                                }`}
                            style={{ width: `${trip?.status as number * 25}%` }}
                        />
                    </div>
                </div>
            );
        case 'invoice':
            return <p className='text-green-600 font-semibold'>{formatNumber(trip?.amount)}</p>;
        case 'truckCost':
            return (
                <p className='text-red-500 font-semibold'>
                    {trip?.truckHireCost ? '' + formatNumber(trip?.truckHireCost) : 'NA'}
                </p>
            );
        default:
            return null;
    }
}
</file>

<file path="src/utils/saveTripDocs.ts">
import jsPDF from "jspdf";
import { invData, ITrip } from "./interface";

export const savePDFToBackend = async (pdf: jsPDF, filename: string, docType: string, trip: ITrip | any, date: string | Date) => {
  const pdfBlob = pdf.output('blob');
  const file = new File([pdfBlob], `Bilty-${trip.LR}-${trip.truck}.pdf`, {
    type: 'application/pdf',
  });

  const formdata = new FormData();
  formdata.append('file', file);
  formdata.append('docType', docType);
  formdata.append('validityDate', new Date(date)?.toISOString().split('T')[0]);
  formdata.append('filename', filename);

  const response = await fetch(`/api/trips/${trip.trip_id}/documents`, {
    method: 'PUT',
    body: formdata,
  });

  if (!response.ok) {
    throw new Error('Failed to save bilty to documents');
  }

  const data = await response.json();
  return data

};


export const saveInvoice = async (invData: Partial<invData>, invoiceId?: string) => {
  try {

    let response
    if (invoiceId) {
      delete invData['invoiceNo']
      delete invData['dueDate']
      delete invData['date']
      response = await fetch(`/api/invoices/${invoiceId.toString()}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(invData)
      })
    } else {
      response = await fetch(`/api/invoices`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(invData)
      });
    }



    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`Failed to save invoice: ${errorText}`);
    }

    // Parse and return the response data
    const data = await response.json();
    return data;
  } catch (error) {
    console.error("Error in saveInvoice:", error);
    throw error; // Rethrow to be handled by the calling function
  }
};
</file>

<file path="src/utils/schema.ts">
import mongoose, { ConnectOptions } from "mongoose";
import { Schema } from "mongoose";

const documentSchema = new Schema({
  filename: String,
  type: String,
  validityDate: Date,
  uploadedDate: Date,
  url: String
})

const truckDataSchema = new Schema({
  regNo: { type: String, default: null },
  chassis: { type: String, default: null },
  engine: { type: String, default: null },
  vehicleManufacturerName: { type: String, default: null },
  model: { type: String, default: null },
  vehicleColour: { type: String, default: null },
  type: { type: String, default: null },
  normsType: { type: String, default: null },
  bodyType: { type: String, default: null },
  ownerCount: { type: String, default: null },
  owner: { type: String, default: null },
  ownerFatherName: { type: String, default: null },
  mobileNumber: { type: String, default: null },
  status: { type: String, default: null },
  statusAsOn: { type: String, default: null },
  regAuthority: { type: String, default: null },
  regDate: { type: String, default: null },
  vehicleManufacturingMonthYear: { type: String, default: null },
  rcExpiryDate: { type: String, default: null },
  vehicleTaxUpto: { type: String, default: null },
  vehicleInsuranceCompanyName: { type: String, default: null },
  vehicleInsuranceUpto: { type: String, default: null },
  vehicleInsurancePolicyNumber: { type: String, default: null },
  rcFinancer: { type: String, default: null },
  presentAddress: { type: String, default: null },
  permanentAddress: { type: String, default: null },
  vehicleCubicCapacity: { type: String, default: null },
  grossVehicleWeight: { type: String, default: null },
  unladenWeight: { type: String, default: null },
  vehicleCategory: { type: String, default: null },
  rcStandardCap: { type: String, default: null },
  vehicleCylindersNo: { type: String, default: null },
  vehicleSeatCapacity: { type: String, default: null },
  vehicleSleeperCapacity: { type: String, default: null },
  vehicleStandingCapacity: { type: String, default: null },
  wheelbase: { type: String, default: null },
  vehicleNumber: { type: String, default: null },
  puccNumber: { type: String, default: null },
  puccUpto: { type: String, default: null },
  blacklistStatus: { type: String, default: null },
  blacklistDetails: { type: [String], default: [] },
  permitIssueDate: { type: String, default: null },
  permitNumber: { type: String, default: null },
  permitType: { type: String, default: null },
  permitValidFrom: { type: String, default: null },
  permitValidUpto: { type: String, default: null },
  nonUseStatus: { type: String, default: null },
  nonUseFrom: { type: String, default: null },
  nonUseTo: { type: String, default: null },
  nationalPermitNumber: { type: String, default: null },
  nationalPermitUpto: { type: String, default: null },
  nationalPermitIssuedBy: { type: String, default: null },
  isCommercial: { type: Boolean, default: false },
  nocDetails: { type: String, default: null },
  dbResult: { type: Boolean, default: null },
  partialData: { type: Boolean, default: null },
  mmvResponse: { type: String, default: null },
  financed: { type: String, default: null },
  class: { type: String, default: null },
}, {
  timestamps: true // Automatically adds createdAt and updatedAt timestamps
})

export const partySchema = new Schema({
  user_id: {
    type: String,
    required: true
  },
  party_id: {
    type: String,
    required: true
  },
  name: {
    type: String,
    required: true
  },
  contactPerson: {
    type: String,
  },
  contactNumber: {
    required: true,
    type: String,
  },
  address: {
    type: String,
  },
  gstNumber: {
    type: String,
  },
  email : {
    type : String
  },
  pan : String,

});


export const PartyPaymentSchema = new Schema({
  user_id: {
    type: String,
    required: true
  },
  party_id: {
    type: String,
    required: true
  },
  trip_id: {
    type: String,
  },
  accountType: {
    type: String,
    enum: ['Payments', 'Advances'],
    default: 'Payments'
  },
  amount: {
    type: Number,
    required: true
  },
  paymentType: {
    type: String,
    enum: ['Cash', 'Cheque', 'Online Transfer', 'Bank Transfer', 'UPI', 'Fuel', 'Others'],
    required: true
  },
  driver_id: {
    type: String
  },
  date: {
    type: Date,
    required: true
  },
  notes: {
    type: String,
  }

})


export const PaymentBookSchema = {
  paymentBook_id: String,
  accountType: {
    type: String,
    enum: ['Payments', 'Advances']
  },
  amount: {
    type: Number,
    required: true
  },
  paymentType: {
    type: String,
    enum: ['Cash', 'Cheque', 'Online Transfer', 'Bank Transfer', 'UPI', 'Fuel', 'Others'],
    required: true
  },
  receivedByDriver: {
    type: Boolean,
    required: true
  },
  paymentDate: {
    type: Date,
    required: true
  },
  notes: {
    type: String
  },
}





export const tripSchema = new Schema({
  user_id: {
    type: String,
    required: true
  },
  trip_id: {
    type: String,
    required: true,
    unique: true
  },
  party: {
    type: String,
    required: true
  },
  truck: {
    type: String,
    required: true
  },
  driver: {
    type: String,
  },
  supplier: {
    type: String,
    default: ''
  },
  route: {
    origin: { type: String, required: true },
    destination: { type: String, required: true }
  },
  billingType: {
    type: String,
    enum: ['Fixed', 'Per Tonne', 'Per Kg', 'Per Trip', 'Per Day', 'Per Hour', 'Per Litre', 'Per Bag'],
    required: true
  },
  units: {
    type: Number,
  },
  rate: {
    type: Number
  },
  amount: {
    type: Number,
    required: true
  },
  startDate: {
    type: Date,
    default: Date.now(),
    required: true
  },
  truckHireCost: {
    type: Number
  },
  LR: {
    type: String,
    required: true
  },
  fmNo: {
    type : String,
  },
  status: {
    type: Number,
    enum: [0, 1, 2, 3, 4]
  },
  POD: {
    type: String,
  },
  ewayBill: {
    type: String,
    default: ''
  },
  ewbValidityDate: {
    type: Date,
    default: null
  },
  dates: [
    Date
  ],
  guaranteedWeight : String,
  material : [
    {
      name : String,
      weight : String
    }
  ],
  notes: {
    type: String
  },
  invoice : {
    type : Boolean,
    default: false
  },
  invoice_id : String,
  accounts: [
    PaymentBookSchema,
  ],
  documents: [
    documentSchema
  ],
  loadingSlipDetails : {
    balance : Number || undefined,
    advance : Number || undefined,
    charges : Number || undefined,
    haltingCharges : Number || undefined
  }
});



const driverAccountSchema = {
  account_id: String,
  date: Date,
  reason: String,
  gave: Number,
  got: Number,
}
export const driverSchema = new mongoose.Schema({
  user_id: {
    type: String,
    required: true
  },
  driver_id: {
    type: String,
    required: true,
    unique: true
  },
  name: {
    type: String,
    required: true
  },
  contactNumber: {
    type: String,
  },
  licenseNo : String,
  aadharNo : String,
  lastJoiningDate : Date,
  status: {
    type: String,
    enum: ['Available', 'On Trip'],
    default: 'Active'
  },
  accounts: [{
    type: driverAccountSchema
  }],
  documents: [documentSchema]
});



export const truckSchema: Schema = new Schema({
  user_id: {
    type: String,
    required: true
  },
  truck_id: { type: String, required: true, unique: true },
  truckNo: { type: String, required: true },
  truckType: { type: String },
  model: { type: String },
  capacity: { type: String },
  bodyLength: { type: String },
  ownership: { type: String, enum: ['Market', 'Self'] },
  supplier: { type: String },
  status: { type: String, enum: ['Available', 'On Trip'] },
  trip_id: { type: String, default: '' },
  driver_id: { type: String, default: '' },
  documents: [documentSchema],
  data : {type : truckDataSchema, default : {}},
  updatedAt: { type: Date, default: Date.now }
});
export const supplierSchema: Schema = new Schema({
  user_id: {
    type: String,
    required: true
  },
  supplier_id: {
    type: String,
    required: true
  },
  name: {
    type: String,
    required: true
  },
  contactNumber: {
    type: String
  },
  balance: {
    type: Number,
    default: 0
  }
})

export const userSchema = new Schema({
  user_id: { type: String, required: true, unique: true },
  phone: { type: String, required: true, unique: true },
  altPhone : String,
  name: { type: String },
  role: {
    name: String,
    user: String
  },
  gstNumber: String,
  address: String,
  company: String,
  city: String,
  pincode: String,
  panNumber: String,
  email: String,
  bankDetails: {
    msmeNo: String,
    accountNo: String,
    ifscCode: String,
    bankName: String,
    bankBranch: String,
  },
  logoUrl: String,
  stampUrl: String,
  signatureUrl: String,
  deviceType : {type : String, default : ''},
  documents: [{
    filename: String,
    url: String,
    uploadedDate: String
  }],
  lastLogin : {type : Date, default : Date.now()},
  createdAt: { type: Date, default: Date.now }
});



export const tripChargesSchema = new Schema({
  user_id: {
    type: String,
    required: true
  },
  trip_id: {
    type: String,
    required: true
  },
  partyBill: {
    type: Boolean,
    required: true
  },
  amount: {
    type: Number,
    required: true
  },
  date: {
    type: Date,
    required: true
  },
  expenseType: {
    type: String,
    required: true
  },
  notes: {
    type: String,
  }
})

export const
  ExpenseSchema = new Schema({
    user_id: {
      type: String,
      required: true
    },
    trip_id: {
      type: String
    },
    truck: {
      type: String,
      default: ''
    },
    expenseType: {
      type: String,
      required: true
    },
    paymentMode: {
      type: String,
      required: true
    },
    transaction_id: String,
    driver: String,
    amount: {
      type: Number,
      required: true
    },
    shop_id: String,
    date: {
      type: Date,
      required: true
    },
    notes: String,
    url: String
  })

export const draftExpenseSchema = new Schema({
  user_id: {
    type: String,
    required: true
  },
  trip_id: {
    type: String
  },
  truck: {
    type: String,
    default: ''
  },
  expenseType: {
    type: String
  },
  paymentMode: {
    type: String,
  },
  transaction_id: String,
  driver: String,
  amount: {
    type: Number,
  },
  shop_id: String,
  date: {
    type: Date,
    default: () => new Date(Date.now()),

  },
  notes: String,
  url: String
})

export const fcmTokenSchema = new Schema({
user_id:{
  type: String,
      required: true

},
fcm_token:{
  type: String,
  required: true

}

})

export const supplierAccountSchema = new Schema({
  user_id: {
    type: String,
    required: true
  },
  trip_id: {
    type: String,
  },
  supplier_id: {
    type: String,
    required: true
  },
  amount: {
    type: Number,
    required: true
  },
  paymentMode: {
    type: String,
    default: 'Cash'
  },
  date: {
    type: Date,
    required: true
  },
  notes: String,
  refNo: String
})

export const OfficeExpenseSchema = new Schema({
  user_id: {
    type: String,
    required: true
  },
  expenseType: {
    type: String,
    required: true
  },
  amount: {
    type: Number,
    required: true
  },
  paymentMode: String,
  shop_id: String,
  date: {
    type: Date,
    required: true
  },
  transactionId: String,
  notes: String
})

export const TokenBlacklistSchema = new Schema({
  token: { type: String, required: true },
  expiresAt: { type: Date, required: true },
});

export const ShopKhataSchema = new Schema({
  user_id: { type: String, required: true },
  shop_id: {
    type: String,
    required: true,
    unique: true
  },
  name: {
    type: String,
    required: true
  },
  contactNumber: String,
  address: String,
  gstNumber: String,

})

export const ShopKhataAccountsSchema = new Schema({
  user_id: { type: String, required: true },
  shop_id: {
    type: String,
    required: true
  },
  reason: String,
  payment: Number,
  credit: Number,
  date: { type: Date, required: true }
})

export const RecentActivitiesSchema = new Schema({
  user_id: { type: String, required: true },
  activities: []
})

export const otherDocumentsSchema = new Schema({
  user_id: { type: String, required: true },
  filename: String,
  url: String,
  uploadedDate: Date,
  validityDate: Date
})

export const userExpenseTypesSchema = new Schema({
  user_id: {
    type: String,
    required: true,
    unique: true,
  },
  expenseTypes: {
    type: [String],
    default: []
  }
})

export const InvoiceSchema = new Schema({
  user_id : {
    type : String,
    required : true
  },
  invoiceNo : {
    type : Number,
    required : true,
  },
  gst : Number,
  route : {
    origin : String,
    destination : String
  },
  date : {type : Date, required : true},
  dueDate : {type : Date, required : true},
  balance : {type : Number, required : true},
  total : {type : Number, required : true},
  party_id : {type : String, required : true},
  advance : {type : Number, required : true},
  trips : {type : [String]},
  invoiceStatus : {type : String, required : true, enum : ['Paid', 'Due'], default : 'Due'},
})

export const DeletedAccountSchema = new Schema({
  user_id : {
    type : String,
    required : true
  },
  phone : { type : String, required : true},
  reason : String
})


const connectString: any = process.env.NEXT_PUBLIC_MONGO_URL

export async function connectToDatabase() {
  if (!mongoose.connection.readyState) {
    await mongoose.connect(connectString);
  }
}

export const statuses = ['Started', 'Completed', 'POD Recieved', 'POD Submitted', 'Settled'];
</file>

<file path="src/utils/utilArray.ts">
import { HiMiniTruck } from "react-icons/hi2"

export const driverGave = [
  'Fuel Expense',
  'Loading Charges',
  'Unloading Charges',
  'Detension Charges',
  'Union Charges',
  'Toll Expense',
  'Police Expense',
  'Brokerage',
  'Other'
]

export const driverGot = [
  'Trip Advance',
  'Trip Payment',
  'Party Advance',
  'Party Payment',
  'Driver Pay'
]

export const minitruck = ['3 Wheel Ape', 'Omni Van', 'Tata Zip', 'Maximo', 'Super Ace', 'Dost', 'Bolero Pickup', 'Isuzu Pickup', 'Tata 407', 'Tata Intra', 'Other']
export const openBody = ['Tata - 12 Feet - 3MT',
  'Canter / 709 14ft - 14 MT',
  'Canter / LPT 17 ft - 5 MT',
  '1109 - 19 ft -7 MT',
  '6 Wheel LP - 9 MT',
  '10 Wheel Taurus 15 MT',
  '10 Wheel Taurus 16 MT',
  '12 Wheel Taurus 20 MT',
  '12 Wheel Taurus 21 MT',
  '14 Wheel Taurus 25 MT',
  '14 Wheel Taurus 26 MT',
  '16 Wheeler',
  '18 Wheeler',
  '22 Wheeler']

export const closedContainer = [
  "Canter / 709 14 ft - 3.5 MT",
  "Canter 17 ft - 5 MT",
  "19 ft - 6 Wheeler - 7 MT",
  "19 ft - 6 Wheeler - 8 MT",
  "20 ft - SXL - 6.5 MT",
  "20 ft - SXL - 7 MT",
  "21 ft - 6 W container",
  "22 ft - 6W container",
  "24 ft SXL Container",
  "24 ft MXL container",
  "28 ft SXL Container",
  "28 ft MXL container",
  "30 ft Container",
  "32 ft SXL Container",
  "32 ft MXL Container",
  "32 ft MXL HQ Container",
  "32 ft triple axle - 20 MT",
  "34 ft Container",
  "40 ft Container",
  "Other"
];

export const trailer = [
  "20 ft platform",
  "22 ft platform",
  "24 ft platform",
  "28 ft platform(JCB) - 8 MT",
  "32 ft platform(JCB) - 13 MT",
  "32 ft Flat bed - 25 MT",
  "20 ft Double - Axle - 22 MT",
  "20 ft Triple - Axle - 28 MT",
  "20 ft double crown - 33 MT",
  "20 ft Tuskar",
  "28 ft Tripple - Axle Sidebody",
  "40 ft Flat bed",
  "40 ft Double - Axle - 20 MT",
  "40 ft Triple - Axle - 28 MT",
  "40 ft Double Crown Triple Axle - 32 MT",
  "40 ft Tripple - Axle Sidebody",
  "50 ft Flat bed",
  "50 ft Double - Axle - 20 MT",
  "50 ft Triple - Axle - 28 MT",
  "50 ft Double Crown Triple Axle - 32 MT",
  "50 ft Tripple - Axle Sidebody",
  "42 ft High Bed",
  "42 ft Semi low Bed",
  "42 ft Low Bed",
  "55 ft Triple - Axle",
  "60 ft Triple -Axle",
  "70 ft Triple - Axle",
  "80 ft Triple - Axle",
  "Hydraulic axle trailer(ODC)",
  "Other"
];



export const truckTypes = [
  'Mini Truck / LCV',
  'Open Body Truck',
  'Closed Container',
  'Trailer',
  'Tanker',
  'Tipper',
  'Other'
]

export const indianStates : {[key : string] : string} = {
  "Andhra Pradesh": "AP",
  "Arunachal Pradesh": "AR",
  "Assam": "AS",
  "Bihar": "BR",
  "Chhattisgarh": "CG",
  "Goa": "GA",
  "Gujarat": "GJ",
  "Haryana": "HR",
  "Himachal Pradesh": "HP",
  "Jharkhand": "JH",
  "Karnataka": "KA",
  "Kerala": "KL",
  "Madhya Pradesh": "MP",
  "Maharashtra": "MH",
  "Manipur": "MN",
  "Meghalaya": "ML",
  "Mizoram": "MZ",
  "Nagaland": "NL",
  "Odisha": "OR",
  "Punjab": "PB",
  "Rajasthan": "RJ",
  "Sikkim": "SK",
  "Tamil Nadu": "TN",
  "Telangana": "TG",
  "Tripura": "TR",
  "Uttar Pradesh": "UP",
  "Uttarakhand": "UK",
  "West Bengal": "WB",
  "Andaman and Nicobar Islands": "AN",
  "Chandigarh": "CH",
  "Dadra and Nagar Haveli and Daman and Diu": "DN",
  "Lakshadweep": "LD",
  "Delhi": "DL",
  "Puducherry": "PY",
  "Ladakh": "LA",
  "Jammu and Kashmir": "JK"
};



import { FaTruckPickup, FaTruckLoading, FaTruckMoving, FaGasPump, FaEllipsisH } from "react-icons/fa";
import { MdLocalShipping, MdOutlineLocalShipping, MdOutlineConstruction } from "react-icons/md";
import { FaTrailer } from "react-icons/fa6"

// Define the truck types and their corresponding icons
export const truckTypesIcons = [
  { type: 'Mini Truck / LCV', Icon: FaTruckPickup },
  { type: 'Open Body Truck', Icon: MdOutlineLocalShipping },
  { type: 'Closed Container', Icon: FaTruckMoving },
  { type: 'Trailer', Icon: FaTrailer },
  { type: 'Tanker', Icon: FaGasPump },
  { type: 'Tipper', Icon: MdOutlineConstruction },
  { type: 'Other', Icon: FaEllipsisH }
];

export const chargeType = [
  'Detention/Halting Charges',
  'Repair Expense',
  'Loading Charges',
  'Unloading Charges',
  'Union Charges',
  'Weight Charges',
  'Other Charges'
];

export const deductionType = [
  'Material Loss',
  'Brokerage',
  'Late Fees',
  'TDS',
  'Mamul',
  'Other'
];

export const fuelAndDriverChargeTypes = new Set([
  'Brokerage',
  'Detention',
  'Driver bhatta',
  'Driver payment',
  'Loading Charges',
  'Fuel Expense',
  'Other',
  'Police Expense',
  'RTO Expense',
  'Toll Expense',
  'Union Expense',
  'Weight Charges',
  'Unloading Charges',
]);

export const maintenanceChargeTypes = new Set([
  'Repair Expense',
  'Showroom Service',
  'Regular Service',
  'Minor Repair',
  'Gear Maintenance',
  'Brake Oil Change',
  'Grease Oil Change',
  'Spare Parts Purchase',
  'Air Filter Change',
  'Tyre Puncture',
  'Tyre Retread',
  'Tyre Purchase',
  'Roof Top Repair'
]);

export const officeExpenseTypes = [
  'Audit Fees',
  'Courier Expenses',
  'Electricity',
  'Rent',
  'Labour',
  'Legal Expenses',
  'Mess Expenses',
  'Telephone Expenses',
  'Pooja Expenses',
  'Salary and Wages',
  'Stationary Expenses',
  'Tea Expenses',
  'Travelling Expenses'
]

export const monthMap: { [key: string]: number } = {
  January: 0,
  February: 1,
  March: 2,
  April: 3,
  May: 4,
  June: 5,
  July: 6,
  August: 7,
  September: 8,
  October: 9,
  November: 10,
  December: 11
};

export const formatNumber = (num: number | string) => {
  if (num === null || num === undefined || num === "") return ""; // Handle null, undefined, or empty string

  // Convert the input to a string and remove commas (if any)
  const cleanNum = num.toString().replace(/,/g, "");

  // Convert the cleaned string to a number
  const numericValue = Number(cleanNum);
  if (isNaN(numericValue)) return ""; // Handle invalid number conversion

  // Format the cleaned number in Indian numbering system
  return new Intl.NumberFormat('en-IN').format(numericValue);
};

export const generateMonthYearOptions = () => {
  const options = [];
  const startDate = new Date(2023, 0, 1);
  const currentDate = new Date();

  for (let year = startDate.getFullYear(); year <= currentDate.getFullYear(); year++) {
    const startMonth = (year === startDate.getFullYear()) ? startDate.getMonth() : 0;
    const endMonth = (year === currentDate.getFullYear()) ? currentDate.getMonth() : 11;

    for (let month = startMonth; month <= endMonth; month++) {
      const date = new Date(year, month, 1);
      const monthYear = date.toLocaleString('default', { month: 'long', year: 'numeric' });
      options.push(monthYear);
    }
  }


  return options;
};
</file>

<file path="src/utils/validate.ts">
export const isValidGSTNumber = (gstNumber: string): boolean => {
    // GST number format validation logic (client-side)
    return /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/.test(gstNumber);
};

export const isValidPhone = (phone: string): boolean => {
    return /^[6789]\d{9}$/.test(phone); // Phone number validation logic for India
};

export const validateTruckNo = (truckNo: string): boolean => {
    // Regular expression to validate Indian truck number format
    const truckNoPattern = /^[A-Z]{2}\d{2}[A-Z]{0,2}\d{4}$/;
    return truckNoPattern.test(truckNo);
}
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "target": "ES2020",
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts", "src/app/user/trucks/[truckNo]/maintainence", "src/app/api/schedule-demo"],
  "exclude": ["node_modules"]
}
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.js
.yarn/install-state.gz

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# local env files
.env*.local

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts

certificates
.env
TODO.md
</file>

<file path="package.json">
{
  "name": "transportbook",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@aws-sdk/client-s3": "^3.631.0",
    "@fortawesome/free-solid-svg-icons": "^6.6.0",
    "@fortawesome/react-fontawesome": "^0.2.2",
    "@mui/icons-material": "^5.16.6",
    "@radix-ui/react-checkbox": "^1.1.3",
    "@radix-ui/react-dialog": "^1.1.1",
    "@radix-ui/react-dropdown-menu": "^2.1.1",
    "@radix-ui/react-icons": "^1.3.0",
    "@radix-ui/react-label": "^2.1.0",
    "@radix-ui/react-popover": "^1.1.1",
    "@radix-ui/react-radio-group": "^1.2.1",
    "@radix-ui/react-select": "^2.1.1",
    "@radix-ui/react-slot": "^1.1.0",
    "@radix-ui/react-tabs": "^1.1.1",
    "@radix-ui/react-toast": "^1.2.2",
    "@radix-ui/react-tooltip": "^1.1.4",
    "@react-pdf/renderer": "^3.4.5",
    "@reduxjs/toolkit": "^2.5.0",
    "@tanstack/react-table": "^8.20.5",
    "@types/nodemailer": "^6.4.17",
    "@vercel/analytics": "^1.3.1",
    "@vercel/speed-insights": "^1.1.0",
    "axios": "^1.7.7",
    "bcrypt": "^5.1.1",
    "class-variance-authority": "^0.7.0",
    "clsx": "^2.1.1",
    "cookie": "^0.6.0",
    "crypto-js": "^4.2.0",
    "date-fns": "^3.6.0",
    "downshift": "^9.0.6",
    "embla-carousel-react": "^8.3.0",
    "exceljs": "^4.4.0",
    "file-saver": "^2.0.5",
    "firebase": "^10.12.4",
    "firebase-admin": "^12.2.0",
    "firebaseui": "^6.1.0",
    "flatted": "^3.3.1",
    "framer-motion": "^11.3.24",
    "geonames.js": "^1.0.5",
    "html2canvas": "^1.4.1",
    "input-otp": "^1.2.4",
    "js-cookie": "^3.0.5",
    "jsonwebtoken": "^9.0.2",
    "jspdf": "^2.5.2",
    "lodash.debounce": "^4.0.8",
    "lucide-react": "^0.407.0",
    "mongoose": "^8.4.5",
    "next": "^14.2.13",
    "next-themes": "^0.3.0",
    "node-tesseract-ocr": "^2.2.1",
    "nodemailer": "^6.9.16",
    "onnxruntime-web": "^1.21.0-dev.20250114-228dd16893",
    "pdf-lib": "^1.17.1",
    "pdf-parse-new": "^1.1.4",
    "react": "^18",
    "react-autosuggest": "^10.1.0",
    "react-day-picker": "^8.10.1",
    "react-dom": "^18",
    "react-dropzone": "^14.3.5",
    "react-icons": "^5.2.1",
    "react-loading-indicators": "^1.0.0",
    "react-redux": "^9.2.0",
    "react-resizable-panels": "^2.1.7",
    "recharts": "^2.13.3",
    "sharp": "^0.33.5",
    "sonner": "^1.5.0",
    "swr": "^2.2.5",
    "tailwind-merge": "^2.4.0",
    "tailwindcss-animate": "^1.0.7",
    "tesseract.js": "^5.1.1",
    "use-debounce": "^10.0.2",
    "uuid": "^10.0.0",
    "xlsx": "^0.18.5"
  },
  "devDependencies": {
    "@types/bcrypt": "^5.0.2",
    "@types/cookie": "^0.6.0",
    "@types/crypto-js": "^4.2.2",
    "@types/file-saver": "^2.0.7",
    "@types/js-cookie": "^3.0.6",
    "@types/jsonwebtoken": "^9.0.6",
    "@types/lodash.debounce": "^4.0.9",
    "@types/node": "^20",
    "@types/pdf-parse": "^1.1.4",
    "@types/react": "^18",
    "@types/react-autosuggest": "^10.1.11",
    "@types/react-dom": "^18",
    "@types/sharp": "^0.32.0",
    "@types/uuid": "^9.0.8",
    "concurrently": "^7.0.0",
    "eslint": "^8",
    "eslint-config-next": "14.2.4",
    "node-loader": "^2.1.0",
    "postcss": "^8",
    "tailwindcss": "^3.4.1",
    "typescript": "^5"
  }
}
</file>

<file path="src/app/about/page.tsx">
import Navigation from '@/components/Navigation';
import Footer from '@/components/Footer';
import Image from 'next/image';
import logo from '@/assets/awajahi logo.png';

export default function About() {
  return (
    <div className="w-full overflow-x-hidden text-black">
      <Navigation />

      <main className="container mx-auto px-4 py-16">
        <div className="max-w-4xl mx-auto text-center">
          <div className="mb-8">
            <Image
              src={logo}
              alt="Awajahi Logo"
              width={150}
              height={150}
              className="mx-auto mb-6"
            />
            <h1 className="text-4xl font-bold mb-4 text-[#FE8631]">About Awajahi</h1>
            <p className="text-xl text-gray-600 mb-8">
              Revolutionizing logistics and transportation management for businesses across India.
            </p>
          </div>

          <div className="grid md:grid-cols-2 gap-8 text-left mb-12">
            <div className="bg-white p-6 rounded-lg shadow-md">
              <h2 className="text-2xl font-semibold mb-4 text-[#FE8631]">Our Mission</h2>
              <p className="text-gray-700 mb-4">
                To empower transportation businesses with cutting-edge technology that simplifies operations,
                reduces costs, and enhances efficiency. We believe in making logistics accessible to every
                business, from small fleet operators to large enterprises.
              </p>
              <p className="text-gray-700">
                Our platform integrates trip management, expense tracking, route optimization, and document
                management into a single, user-friendly solution.
              </p>
            </div>

            <div className="bg-white p-6 rounded-lg shadow-md">
              <h2 className="text-2xl font-semibold mb-4 text-[#FE8631]">Our Vision</h2>
              <p className="text-gray-700 mb-4">
                To be the leading digital transformation partner for the Indian logistics industry,
                driving innovation and sustainability in transportation operations.
              </p>
              <p className="text-gray-700">
                We envision a future where every logistics operation is optimized, transparent,
                and environmentally conscious, contributing to India&apos;s economic growth.
              </p>
            </div>
          </div>

          <div className="bg-white p-8 rounded-lg shadow-md mb-12">
            <h2 className="text-3xl font-bold mb-6 text-[#FE8631]">What We Offer</h2>
            <div className="grid md:grid-cols-3 gap-6">
              <div className="text-center">
                <h3 className="text-xl font-semibold mb-3">Trip Management</h3>
                <p className="text-gray-600">
                  Comprehensive trip tracking, driver management, and real-time monitoring
                  to ensure smooth operations.
                </p>
              </div>
              <div className="text-center">
                <h3 className="text-xl font-semibold mb-3">Expense Management</h3>
                <p className="text-gray-600">
                  Automated expense categorization, receipt scanning, and budget tracking
                  for better financial control.
                </p>
              </div>
              <div className="text-center">
                <h3 className="text-xl font-semibold mb-3">Route Optimization</h3>
                <p className="text-gray-600">
                  AI-powered route planning that reduces fuel costs, delivery times,
                  and environmental impact.
                </p>
              </div>
            </div>
          </div>

          <div className="bg-gradient-to-r from-[#FE8631] to-[#FFC499] p-8 rounded-lg text-white">
            <h2 className="text-3xl font-bold mb-4">Join the Awajahi Revolution</h2>
            <p className="text-lg mb-6">
              Experience the future of logistics management. Transform your operations with Awajahi today.
            </p>
            <a href="/login" className="bg-white text-[#FE8631] px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 transition inline-block">
              Get Started
            </a>
          </div>
        </div>
      </main>

      <Footer />
    </div>
  );
}
</file>

<file path="src/app/api/contact/route.ts">
import { NextResponse } from 'next/server';
import nodemailer from 'nodemailer';

// Create a transporter using SMTP
const transporter = nodemailer.createTransport({
  host: process.env.EMAIL_HOST,
  port: parseInt(process.env.EMAIL_PORT || '587'),
  secure: process.env.EMAIL_SECURE === 'true',
  auth: {
    user: process.env.EMAIL_USER,
    pass: process.env.EMAIL_PASS,
  },
});

export async function POST(request: Request) {
  const body = await request.json();
  const { name, email, message } = body;

  try {
    // Send email
    await transporter.sendMail({
      from: process.env.EMAIL_FROM,
      to: process.env.EMAIL_TO,
      subject: 'New Contact Form Message',
      html: `
        <h1>New Contact Form Message</h1>
        <p><strong>Name:</strong> ${name}</p>
        <p><strong>Email:</strong> ${email}</p>
        <p><strong>Message:</strong></p>
        <p>${message}</p>
      `,
    });

    return NextResponse.json({ message: 'Message sent successfully', status: 200 });
  } catch (error) {
    console.error('Failed to send message:', error);
    return NextResponse.json({ message: 'Failed to send message' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/trips/route.ts">
import { NextResponse } from 'next/server';
import mongoose, { model, models } from 'mongoose';
import { driverSchema, tripChargesSchema, tripSchema, truckSchema } from '@/utils/schema';
import { connectToDatabase } from '@/utils/schema';
import { ITrip } from '@/utils/interface';
import { v4 as uuidv4 } from 'uuid'
import { partySchema } from '@/utils/schema';
import { verifyToken } from '@/utils/auth';
import { uploadFileToS3 } from '@/helpers/fileOperation';
import { recentActivity } from '@/helpers/recentActivity';

const Trip = models.Trip || model('Trip', tripSchema);
const Driver = models.Driver || model('Driver', driverSchema)
const Truck = models.Truck || model('Truck', truckSchema)
const TripCharges = models.TripCharges || model('TripCharges', tripChargesSchema)
// Assuming you have this schema defined

export async function GET(req: Request) {
  const { user, error } = await verifyToken(req);
  if (error) {
    return NextResponse.json({ error });
  }

  try {
    await connectToDatabase();

    const url = new URL(req.url);
    const status = url.searchParams.get('status')

    // Prepare query with user_id and optional statuses filter
    const query: any = { user_id: user };
    if (status !== null) {
      query.status = parseInt(status)
    }

    // Use an aggregation pipeline to fetch the required data, calculate balance, and join with Party collection
    const trips = await Trip.aggregate([
      { $match: query },  // Filter trips based on user_id and optional statuses
      {
        $lookup: {
          from: 'parties',  // Join with the Party collection
          localField: 'party',
          foreignField: 'party_id',
          as: 'partyDetails'
        }
      },
      { $unwind: '$partyDetails' },  // Unwind partyDetails array
      {
        $lookup: {
          from: 'drivers',  // Join with the Party collection
          localField: 'driver',
          foreignField: 'driver_id',
          as: 'driverDetails'
        }
      },
      { $unwind: '$partyDetails' },  // Unwind partyDetails array
      {
        $lookup: {
          from: 'tripcharges',  // Join with the TripExpense collection
          localField: 'trip_id',
          foreignField: 'trip_id',
          as: 'tripExpenses'
        }
      },
      {
        $lookup: {
          from: 'partypayments',
          localField: 'trip_id',
          foreignField: 'trip_id',
          as: 'tripAccounts'
        }
      },
      {
        $addFields: {
          // Calculate the final balance based on the fetchBalance logic
          balance: {
            $let: {
              vars: {
                accountBalance: {
                  $sum: {
                    $map: {
                      input: '$tripAccounts',
                      as: 'account',
                      in: '$$account.amount'
                    }
                  }
                },
                chargeToBill: {
                  $sum: {
                    $map: {
                      input: {
                        $filter: {
                          input: '$tripExpenses',
                          as: 'expense',
                          cond: { $eq: ['$$expense.partyBill', true] }
                        }
                      },
                      as: 'filteredExpense',
                      in: '$$filteredExpense.amount'
                    }
                  }
                },
                chargeNotToBill: {
                  $sum: {
                    $map: {
                      input: {
                        $filter: {
                          input: '$tripExpenses',
                          as: 'expense',
                          cond: { $eq: ['$$expense.partyBill', false] }
                        }
                      },
                      as: 'filteredExpense',
                      in: '$$filteredExpense.amount'
                    }
                  }
                }
              },
              in: {
                $subtract: [
                  { $add: ['$amount', '$$chargeToBill'] },  // Add trip amount and chargeToBill
                  { $add: ['$$accountBalance', '$$chargeNotToBill'] }  // Subtract accountBalance and chargeNotToBill
                ]
              }
            }
          },
          // Include the party name from the joined partyDetails
          partyName: '$partyDetails.name',
          driverName: '$driverDetails.name'
        }
      }, // Sort by startDate in descending order
      // Exclude unnecessary fields including accountBalance, chargeToBill, and chargeNotToBill
      { $project: { partyDetails: 0, tripExpenses: 0, accounts: 0, chargeToBill: 0, chargeNotToBill: 0, accountBalance: 0, user_id: 0 } }
    ]);

    return NextResponse.json({ trips });
  } catch (err) {
    console.error(err);
    return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 });
  }
}


export async function POST(req: Request) {
  const { user, error } = await verifyToken(req);
  if (error) return NextResponse.json({ error }, { status: 401 });

  try {
    await connectToDatabase();

    const formData = await req.formData();
    const tripId = `trip${uuidv4()}`;

    // Handle file upload
    const file = formData.get("file") as File | null;
    let fileUrl = "";
    if (file) {
      const fileBuffer = Buffer.from(await file.arrayBuffer());
      const fileName = `trips/ewaybill-${tripId}`;
      fileUrl = await uploadFileToS3(fileBuffer, fileName, file.type);
      fileUrl += file.type === "application/pdf" ? ".pdf" : "";
    }

    // Handle pre-dated trip start date safely
    // Handle pre-dated trip start date safely for both `startDate` and `dates`
const rawDate = formData.get("startDate") as string;
let startDate: Date;

if (rawDate) {
  // Parse user date string (YYYY-MM-DD) accurately as local date
  const [year, month, day] = rawDate.split("-").map(Number);
  startDate = new Date(year, month - 1, day);
} else {
  startDate = new Date();
}

// Create new trip object and explicitly set both fields
const newTrip = new Trip({
  user_id: user,
  trip_id: tripId,
  party: formData.get("party"),
  truck: formData.get("truck"),
  driver: formData.get("driver"),
  supplier: formData.get("supplierId") || "",
  route: {
    origin: formData.get("origin"),
    destination: formData.get("destination"),
  },
  billingType: formData.get("billingType"),
  amount: Number(formData.get("amount")) || 0,
  balance: Number(formData.get("amount")) || 0,

  // Fix: set startDate & dates array both to user-selected date
  startDate: startDate,
  dates: [startDate, null, null, null, null],

  truckHireCost: Number(formData.get("truckHireCost")) || 0,
  fmNo: formData.get("fmNo"),
  LR: formData.get("LR"),
  status: 0,
  material: JSON.parse(formData.get("material") as string) || [],
  loadingSlipDetails: JSON.parse(formData.get("loadingSlipDetails") as string),
  notes: formData.get("notes") || "",
  accounts: [],
  documents: [],
});



    // Handle E-Way Bill upload
    const validity = formData.get("ewbValidity");
    if (validity) {
      newTrip.ewbValidityDate = new Date(validity as string);
      newTrip.documents.push({
        filename: file?.name || "",
        type: "E-Way Bill",
        validityDate: new Date(validity as string),
        uploadedDate: new Date(),
        url: fileUrl || "",
      });
    }

    // Validate non-fixed billing type
    if (newTrip.billingType !== "Fixed") {
      const units = formData.get("units");
      const rate = formData.get("rate");
      if (!units || !rate) {
        return NextResponse.json(
          { message: "Units and Rate must be specified", status: 400 },
          { status: 400 }
        );
      }
      newTrip.units = Number(units);
      newTrip.rate = Number(rate);
    }

    // Save trip and update recent activity in parallel
    const [savedTrip] = await Promise.all([
      newTrip.save(),
      recentActivity("Created New Trip", newTrip, user),
    ]);

    // Update driver and truck statuses
    await Promise.all([
      Driver.findOneAndUpdate({ user_id: user, driver_id: newTrip.driver }, { status: "On Trip" }),
      Truck.findOneAndUpdate({ user_id: user, truckNo: newTrip.truck }, { status: "On Trip" }),
    ]);

    return NextResponse.json({ message: "Saved Successfully", data: savedTrip }, { status: 200 });

  } catch (error: any) {
    console.error("Error saving trip:", error);

    const errorMapping: Record<string, { message: string; status: number }> = {
      ValidationError: { message: "Validation Error", status: 400 },
      MongoError: error.code === 11000 ? { message: "Duplicate Key Error", status: 409 } : { message: 'Mongo Error', status: 409 },
    };

    const { message, status } = errorMapping[error.name] || { message: "Internal Server Error", status: 500 };

    return NextResponse.json({ message, details: error.message }, { status });
  }
}
</file>

<file path="src/app/expense-management/page.tsx">
import Navigation from '@/components/Navigation';
import Footer from '@/components/Footer';
import Image from 'next/image';
import expenseIcon from '@/assets/expense management icon.png';

export default function ExpenseManagement() {
  return (
    <div className="w-full overflow-x-hidden text-black">
      <Navigation />

      <main className="container mx-auto px-4 py-16">
        <div className="max-w-4xl mx-auto text-center">
          <div className="mb-8">
            <Image
              src={expenseIcon}
              alt="Expense Management Icon"
              width={100}
              height={100}
              className="mx-auto mb-6"
            />
            <h1 className="text-4xl font-bold mb-4 text-[#FE8631]">Expense Management</h1>
            <p className="text-xl text-gray-600 mb-8">
              Take control of your business expenses with our intelligent expense tracking and management system.
            </p>
          </div>

          <div className="grid md:grid-cols-2 gap-8 text-left">
            <div className="bg-white p-6 rounded-lg shadow-md">
              <h2 className="text-2xl font-semibold mb-4 text-[#FE8631]">Key Features</h2>
              <ul className="space-y-3 text-gray-700">
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Automated expense categorization
                </li>
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Receipt scanning and OCR processing
                </li>
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Real-time expense tracking
                </li>
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Budget monitoring and alerts
                </li>
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Multi-currency support
                </li>
              </ul>
            </div>

            <div className="bg-white p-6 rounded-lg shadow-md">
              <h2 className="text-2xl font-semibold mb-4 text-[#FE8631]">Benefits</h2>
              <ul className="space-y-3 text-gray-700">
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Reduced administrative overhead
                </li>
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Improved financial visibility
                </li>
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Faster expense approvals
                </li>
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Better compliance with tax regulations
                </li>
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Cost savings through better tracking
                </li>
              </ul>
            </div>
          </div>

          <div className="mt-12 bg-gradient-to-r from-[#FE8631] to-[#FFC499] p-8 rounded-lg text-white">
            <h2 className="text-3xl font-bold mb-4">Streamline Your Expenses Today</h2>
            <p className="text-lg mb-6">
              Experience hassle-free expense management with Awajahi&apos;s advanced platform.
            </p>
            <button className="bg-white text-[#FE8631] px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 transition">
              Schedule a Demo
            </button>
          </div>
        </div>
      </main>

      <Footer />
    </div>
  );
}
</file>

<file path="src/app/globals.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer utilities {
  /* Hide scrollbar for Chrome, Safari and Opera */
  .no-scrollbar::-webkit-scrollbar {
      display: none;
  }
 /* Hide scrollbar for IE, Edge and Firefox */
  .no-scrollbar {
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
}

}

@layer base {
  :root {
    --background: 250, 250, 250;
    --foreground: 0, 0, 0;
    --card: 255, 255, 255;
    --card-foreground: 0, 0, 0;
    --popover: 255, 255, 255;
    --popover-foreground: 0, 0, 0;
    --primary: 255, 106, 0;
    --primary-foreground: 255, 255, 255;
    --secondary: 90, 90, 90;
    --secondary-foreground: 255, 255, 255;
    --muted: 195, 195, 195;
    --muted-foreground: 90, 90, 90;
    --accent: 255, 106, 0;
    --accent-foreground: 255, 255, 255;
    --destructive: 204, 85, 0; /* Updated to a rusty orange tone */
    --destructive-foreground: 255, 255, 255;
    --border: 195, 195, 195;
    --input: 195, 195, 195;
    --ring: 0, 0, 0;
    --radius: 0.5rem;
    --splash: rgba(255, 255, 255, 0.3);
    --light-orange: #ffa666;
    --light-orange-button: #ffcaa4;
    --bottom-nav-bar: #FE8631;
  }

  .dark {
    --background: 222.2 84% 4.9%;
    --foreground: 210 40% 98%;
    --card: 222.2 84% 4.9%;
    --card-foreground: 210 40% 98%;
    --popover: 222.2 84% 4.9%;
    --popover-foreground: 210 40% 98%;
    --primary: 210 40% 98%;
    --primary-foreground: 222.2 47.4% 11.2%;
    --secondary: 217.2 32.6% 17.5%;
    --secondary-foreground: 210 40% 98%;
    --muted: 217.2 32.6% 17.5%;
    --muted-foreground: 215 20.2% 65.1%;
    --accent: 217.2 32.6% 17.5%;
    --accent-foreground: 210 40% 98%;
    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 210 40% 98%;
    --border: 217.2 32.6% 17.5%;
    --input: 217.2 32.6% 17.5%;
    --ring: 212.7 26.8% 83.9%;
    --chart-1: 220 70% 50%;
    --chart-2: 160 60% 45%;
    --chart-3: 30 80% 55%;
    --chart-4: 280 65% 60%;
    --chart-5: 340 75% 55%;
  }
}

@layer base {
  * {
    @apply border-border;
  }
  body {
    @apply bg-background text-foreground;
  }
}

:root {
  --foreground-rgb: 0, 0, 0;
  --background-start-rgb: 214, 219, 220;
  --background-end-rgb: 255, 255, 255;
}

@media (prefers-color-scheme: light) {
  :root {
    --foreground-rgb: 255, 255, 255;
    --background-start-rgb: 0, 0, 0;
    --background-end-rgb: 0, 0, 0;
  }
}

body {
  color: rgb(var(--foreground-rgb));
  background: linear-gradient(
      to bottom,
      transparent,
      rgb(var(--background-end-rgb))
    )
    rgb(var(--background-start-rgb));
}

@layer utilities {
  .text-balance {
    text-wrap: balance;
  }
  .bg-gradient-radial-home {
    background: radial-gradient(ellipse at 80% 50%, #FFC499 0%, #FFFFFF 80%);
  }
  .bg-gradient-radial-home2 {
    background: radial-gradient(ellipse at 80% 50%, #FFFFFF 0%, #FFC499 80%);
  }
  .bg-gradient-radial {
    background: radial-gradient(#FFC499, white);
  }
}

/* For Firefox */
/* For Firefox */
.thin-scrollbar {
  scrollbar-width: thin; /* Makes scrollbar thin */
  scrollbar-color: #FE8631 transparent; /* Thumb color and track color */
  
}

/* For WebKit-based browsers (Chrome, Safari, Edge) */
.thin-scrollbar::-webkit-scrollbar {
  width: 8px; /* Adjust the width of the scrollbar */
  height: 8px;
  border-radius: 20px; /* Adjust the height of the scrollbar (for horizontal scroll) */
}

.thin-scrollbar::-webkit-scrollbar-track {
  background: transparent; /* Track color (background behind the thumb) */
}

.thin-scrollbar::-webkit-scrollbar-thumb {
  background-color: #FE8631; /* Scrollbar thumb color */
  border-radius: 10px; /* Round the corners of the scrollbar thumb */
  border: 2px solid transparent; /* Optional: Adds padding inside thumb */
}

/* Hover effect for WebKit-based browsers */
.thin-scrollbar::-webkit-scrollbar-thumb:hover {
  background-color: #FE6E00; /* Darken thumb on hover */
}

/* Active effect for WebKit-based browsers */
.thin-scrollbar::-webkit-scrollbar-thumb:active {
  background-color: #FE5200; /* Darken thumb when active */
}

/* Firefox scrollbar track (for better rounding) */
.thin-scrollbar {
  scrollbar-width: thin;
  scrollbar-color: #FE8631 transparent; /* Thumb color and track color */
  scrollbar-track-border-radius: 10px; /* Rounded scrollbar for Firefox */
}



/* Custom table styling specifically targeting tables with class "custom-table" */

.table-container {
  overflow-x: auto;
  margin: 20px 0;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  background-color: #ffffff;
}

.custom-table {
  width: 100%;
  border-collapse: separate; /* Allows for rounded corners */
  border-spacing: 0;
  font-size: 16px; /* Default font size */
  table-layout: auto;
  border-radius: 12px;
  overflow-x: auto; /* Enable horizontal scrolling for smaller screens */
}

/* Add a wrapper around the table for horizontal scrolling */
.custom-table-wrapper {
  overflow-x: auto; /* Ensures responsiveness */
  -webkit-overflow-scrolling: touch; /* Smooth scrolling on touch devices */
}

.custom-table th,
.custom-table td {
  padding: 16px 16px; /* Improved padding */
  text-align: left;
  border: 1px solid #00000040; /* Added border */
  transition: background-color 0.3s ease; /* Smooth transition */
}

.custom-table th {
  background-color: var(--bottom-nav-bar); /* Darker, more modern header background */
  color: #ffffff;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 14px; /* Adjust font size */
}

.custom-table tbody tr:nth-child(even) {
  background-color: #f9fafb; /* Light grey for even rows */
}

.custom-table tbody tr:hover {
  background-color: #ffe4c4; /* Feedback color on hover */
  cursor: pointer; /* Pointer cursor on hover */
}

.custom-table tbody td {
  color: #2d3748;
  vertical-align: top; /* Align the text to the top */
}

.custom-table tbody tr:active {
  background-color: #e2e8f0; /* Feedback color on click */
}

.custom-table tbody tr.selected {
  background-color: #4a5568; /* Highlight selected row */
  color: #ffffff;
}

.custom-table tbody tr.selected td {
  color: #ffffff; /* Ensure text is readable on selected row */
}

.custom-table tfoot td {
  padding: 16px 24px;
  background-color: #edf2f7; /* Footer background color */
  font-weight: bold;
  border-top: 2px solid #4a5568;
}

.custom-table tfoot td:first-child {
  border-left: none;
}

.custom-table tfoot td:last-child {
  border-right: none;
}

.custom-table caption {
  caption-side: bottom;
  padding: 10px;
  font-size: 14px;
  color: #4a5568;
}

.custom-table caption a {
  color: #4a5568;
  text-decoration: none;
}

.custom-table caption a:hover {
  text-decoration: underline;
}

/* Responsive Design */

/* For smaller laptops (1024px or less) */
@media (max-width: 1260px) {
  .custom-table th,
  .custom-table td {
    font-size: 14px; /* Reduce font size */
    padding: 12px; /* Reduce padding */
  }

  .custom-table th {
    font-size: 13px; /* Smaller header font size */
  }
}

/* For very small laptops (768px or less) */
@media (max-width: 768px) {
  .custom-table {
    font-size: 12px; /* Smaller font size for the table */
    table-layout: fixed; /* Fix table layout for smaller screens */
  }

  .custom-table th,
  .custom-table td {
    padding: 8px; /* Compact padding */
  }

  .custom-table caption {
    font-size: 12px; /* Smaller caption text */
  }
}

/* Ensure scrollability on smaller screens */
.custom-table-wrapper {
  overflow-x: auto; /* Horizontal scrolling */
  -webkit-overflow-scrolling: touch; /* Smooth scrolling on touch devices */
}


.modal-class{
  @apply fixed inset-0 bg-black/40 backdrop-blur-sm z-40 flex items-center justify-center
}

input:not([type="checkbox"]) {
  @apply w-full px-3 py-2 border-2 border-black/25 focus:outline-none focus:ring-1 focus:ring-gray-300 rounded-full text-sm text-gray-700 file:bg-lightOrangeButtonColor file:border-none file:rounded-lg file:px-2 file:py-1 file:cursor-pointer hover:file:bg-bottomNavBarColor hover:file:text-white;
}


textarea {
  @apply w-full px-3 py-2 border border-lightOrange rounded-lg focus:outline-none focus:ring focus:ring-lightOrange;
}

label {
  @apply block text-xs font-medium text-gray-700 mb-1
}

select {
  @apply cursor-pointer
  w-full
  mt-1
  p-2
  border
  rounded
  border-black/25
  focus:ring-1 focus:ring-gray-300 
  transition-all
  duration-200
  ease-in-out
  bg-white
  text-gray-800
  shadow-sm
  focus:shadow-md
  outline-none
}

.hide-scrollbar {
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* Internet Explorer 10+ */
}

.hide-scrollbar::-webkit-scrollbar {
  display: none; /* WebKit */
}

.hide-scrollbar:hover,
.hide-scrollbar:focus,
.hide-scrollbar:focus-within {
  scrollbar-width: auto;
  -ms-overflow-style: auto;
}

.hide-scrollbar:hover::-webkit-scrollbar,
.hide-scrollbar:focus::-webkit-scrollbar,
.hide-scrollbar:focus-within::-webkit-scrollbar {
  display: block;
}
</file>

<file path="src/app/page.tsx">
import { Suspense } from 'react';
import Navigation from '@/components/Navigation';
import HeroSection from '@/components/HeroSection';
import FeatureSection from '@/components/FeatureSection';
import WhyChooseUs from '@/components/WhyChooseUs';
import Footer from '@/components/Footer';
import AppDownload from '@/components/AppDownload';




export default function Home() {

  return (
    <div className="w-full overflow-x-hidden text-black">
      {/* First background split */}
      <div className="bg-gradient-radial-home">
        <Navigation />
        <main>
          <HeroSection />
          <Suspense fallback={<div>Loading...</div>}>
            <AppDownload />
          </Suspense>
        </main>
      </div>

      {/* Second background split */}
      <div className="bg-gradient-radial-home2">
        <main>
          <Suspense fallback={<div>Loading...</div>}>
            <FeatureSection />
          </Suspense>
          <Suspense fallback={<div>Loading...</div>}>
            <WhyChooseUs />
          </Suspense>
        </main>
      </div>

      {/* Footer */}
      <Footer />
    </div>
  );
}
</file>

<file path="src/app/route-optimization/page.tsx">
import Navigation from '@/components/Navigation';
import Footer from '@/components/Footer';
import Image from 'next/image';
import routeIcon from '@/assets/route management icon.png';

export default function RouteOptimization() {
  return (
    <div className="w-full overflow-x-hidden text-black">
      <Navigation />

      <main className="container mx-auto px-4 py-16">
        <div className="max-w-4xl mx-auto text-center">
          <div className="mb-8">
            <Image
              src={routeIcon}
              alt="Route Optimization Icon"
              width={100}
              height={100}
              className="mx-auto mb-6"
            />
            <h1 className="text-4xl font-bold mb-4 text-[#FE8631]">Route Optimization</h1>
            <p className="text-xl text-gray-600 mb-8">
              Maximize efficiency and minimize costs with our advanced route optimization technology.
            </p>
          </div>

          <div className="grid md:grid-cols-2 gap-8 text-left">
            <div className="bg-white p-6 rounded-lg shadow-md">
              <h2 className="text-2xl font-semibold mb-4 text-[#FE8631]">Key Features</h2>
              <ul className="space-y-3 text-gray-700">
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  AI-powered route planning
                </li>
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Real-time traffic integration
                </li>
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Multi-stop optimization
                </li>
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Fuel efficiency calculations
                </li>
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Delivery time predictions
                </li>
              </ul>
            </div>

            <div className="bg-white p-6 rounded-lg shadow-md">
              <h2 className="text-2xl font-semibold mb-4 text-[#FE8631]">Benefits</h2>
              <ul className="space-y-3 text-gray-700">
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Significant reduction in fuel costs
                </li>
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Improved delivery times and customer satisfaction
                </li>
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Lower vehicle wear and maintenance costs
                </li>
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Reduced carbon footprint
                </li>
                <li className="flex items-start">
                  <span className="text-[#FE8631] mr-2"></span>
                  Increased fleet utilization
                </li>
              </ul>
            </div>
          </div>

          <div className="mt-12 bg-gradient-to-r from-[#FE8631] to-[#FFC499] p-8 rounded-lg text-white">
            <h2 className="text-3xl font-bold mb-4">Optimize Your Routes Now</h2>
            <p className="text-lg mb-6">
              Discover how Awajahi&apos;s route optimization can transform your logistics operations.
            </p>
            <button className="bg-white text-[#FE8631] px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 transition">
              Schedule a Demo
            </button>
          </div>
        </div>
      </main>

      <Footer />
    </div>
  );
}
</file>

<file path="src/app/user/documents/driverDocuments/page.tsx">
'use client';

import Link from 'next/link';
import React, { useCallback, useEffect, useState } from 'react';
import { FaChevronRight, FaFolderOpen, FaRegIdCard, FaIdCard, FaPassport, FaRegCheckCircle, FaThLarge, FaList } from 'react-icons/fa';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import DriverDocumentUpload from '@/components/documents/DriverDocumentUpload';
import folderIcon from '@/assets/folder-icon.png';
import dynamic from 'next/dynamic';
import { loadingIndicator } from '@/components/ui/LoadingIndicator';
import Image from 'next/image';
import { CloudUpload } from 'lucide-react';
import { motion } from 'framer-motion';

const RecentDocuments = dynamic(() => import('@/components/documents/RecentDocuments'), { ssr: false });

const DriverDocuments = () => {
  const [drivers, setDrivers] = useState<any[]>([]);
  const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid');
  const [searchTerm, setSearchTerm] = useState<string>('');
  const [modalOpen, setModalOpen] = useState(false);
  const [documents, setDocuments] = useState<any[]>([]);
  const [message, setMessage] = useState('');
  const [loading, setLoading] = useState(false);
  const [type, setType] = useState<string>('');

  const DriverDocArray = [
    { title: 'License', icon: <FaRegIdCard className="text-bottomNavBarColor" size={70} /> },
    { title: 'Aadhar', icon: <FaIdCard className="text-bottomNavBarColor" size={70} /> },
    { title: 'PAN', icon: <FaPassport className="text-bottomNavBarColor" size={70} /> },
    { title: 'Police Verification', icon: <FaRegCheckCircle className="text-bottomNavBarColor" size={70} /> },
    { title: 'Other', icon: <FaFolderOpen className="text-bottomNavBarColor" size={70} /> },
  ];

  useEffect(() => {
    async function fetchDrivers() {
      setLoading(true);
      try {
        const res = await fetch('/api/drivers');
        if (!res.ok) {
          setMessage('Failed to load drivers');
          setDrivers([]);
          return;
        }
        const data = await res.json();
        setDrivers(data.drivers || []);
        setMessage('');
      } catch (error) {
        setMessage('Failed to load drivers');
      } finally {
        setLoading(false);
      }
    }
    fetchDrivers();
  }, []);

  const fetchDocuments = useCallback(async () => {
    if (!type) {
      setDocuments([]);
      return;
    }
    setLoading(true);
    try {
      const res = await fetch(`/api/drivers/documents?type=${encodeURIComponent(type)}`);
      if (!res.ok) {
        setMessage('Failed to fetch documents');
        setDocuments([]);
        return;
      }
      const data = await res.json();
      setDocuments(data.documents || []);
      setMessage(data.documents.length === 0 ? 'No documents found' : '');
    } catch (error) {
      setMessage('Failed to fetch documents');
      setDocuments([]);
    } finally {
      setLoading(false);
    }
  }, [type]);

  useEffect(() => {
    fetchDocuments();
  }, [fetchDocuments]);

  const filteredDrivers = drivers.filter(
    (driver) =>
      driver.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
      driver.contactNumber?.toLowerCase().includes(searchTerm.toLowerCase()),
  );

  const filteredDocuments = documents.filter(
    (doc) =>
      doc.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
      doc.contactNumber?.toLowerCase().includes(searchTerm.toLowerCase()),
  );

  return (
    <div className="p-6 bg-gray-100 min-h-screen">
      <div className="flex items-center justify-between mb-4 border-b-2 border-gray-300 pb-2">
        <h1 className="text-2xl font-semibold text-black flex items-center space-x-2">
          <Button variant="link" className="p-0 m-0">
            <Link href={`/user/documents`} className="text-2xl font-semibold hover:underline">
              Docs
            </Link>
          </Button>
          <FaChevronRight className="text-lg text-gray-500" />
          <span>Driver Docs</span>
        </h1>
        <div className="flex items-center space-x-4">
          <Input
            type="text"
            placeholder="Search"
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="px-4 py-2 rounded-md border border-gray-300"
          />
          {!type && (
            <Button onClick={() => setViewMode(viewMode === 'grid' ? 'list' : 'grid')}>
              {viewMode === 'grid' ? <FaList className="text-xl" /> : <FaThLarge className="text-xl" />}
            </Button>
          )}
          <div className="flex justify-end my-2 fixed right-4 bottom-4">
            <Button onClick={() => setModalOpen(true)} className="rounded-full h-full py-2">
              <CloudUpload size={40} />
            </Button>
          </div>
        </div>
      </div>

      <div className="my-4">
        <h1 className="text-lg font-semibold text-black my-4">Select Document Type</h1>
        <div className="grid grid-cols-5 gap-4">
          {DriverDocArray.map((item, index) => (
            <motion.div
              key={index}
              onClick={() => setType((prev) => (prev === item.title ? '' : item.title))}
              initial={{ opacity: 0, scale: 0.9 }}
              animate={{ opacity: 1, scale: 1 }}
              whileHover={{ scale: 1.1, boxShadow: '0px 4px 10px rgba(0, 0, 0, 0.1)' }}
              transition={{ duration: 0.3, ease: 'easeInOut' }}
              className="col-span-1 max-h-[200px]"
            >
              <div
                className={`flex flex-col items-center justify-center border border-gray-300 gap-4 bg-[#FBFBFB] rounded-lg p-6 transition-all hover:shadow-md transform hover:scale-105 cursor-pointer ${
                  type === item.title ? 'bg-lightOrange' : ''
                }`}
              >
                {item.icon}
                <h2 className="text-xl font-semibold text-black text-center">{item.title}</h2>
                {/* File count under each document type */}
                {type === item.title && filteredDocuments.length > 0 && (
                  <p className="text-sm text-gray-500">{filteredDocuments.length} files</p>
                )}
              </div>
            </motion.div>
          ))}
        </div>
      </div>

      {!type ? (
        <div>
          <h1 className="text-lg font-semibold text-black py-4 mt-4">Or Select Driver</h1>
          <div className={viewMode === 'grid' ? 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6' : 'flex flex-col space-y-4'}>
            {filteredDrivers.length > 0 ? (
              filteredDrivers.map((driver) => (
                <Link
                  href={{
                    pathname: `/user/documents/driverDocuments/${driver.driver_id}`,
                  }}
                  key={driver.driver_id}
                >
                  <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    transition={{ duration: 1 }}
                    className={`bg-white p-6 rounded-xl hover:shadow-lg border border-gray-300 transition-all duration-300 ease-in-out hover:bg-gray-50 cursor-pointer ${
                      viewMode === 'grid' ? 'h-full flex justify-between items-center space-x-4' : 'flex items-center space-x-6 w-full px-8 py-6'
                    }`}
                  >
                    <div className="flex-shrink-0">
                      <Image
                        src={folderIcon}
                        alt="folder icon"
                        width={48}
                        height={48}
                        className="object-contain"
                        priority
                      />
                    </div>

                    <div className="flex flex-col flex-grow">
                      <span className="font-semibold text-black">{driver.name}</span>
                      <span className="text-gray-500">{driver.contactNumber || 'No Contact Number'}</span>
                      {/* Count of files under each driver folder */}
                      <span className="text-gray-400 text-sm mt-1">{driver.documents?.length || 0} files</span>
                    </div>
                  </motion.div>
                </Link>
              ))
            ) : (
              <span className="text-center col-span-3 text-gray-500">{(loading && loadingIndicator) || message}</span>
            )}
          </div>
        </div>
      ) : (
        <div className="py-4">
          {loading ? (
            <p className="text-center">
              {loadingIndicator} {message}
            </p>
          ) : filteredDocuments.length > 0 ? (
            <RecentDocuments docs={filteredDocuments} />
          ) : (
            <p>No documents found</p>
          )}
        </div>
      )}

      <DriverDocumentUpload open={modalOpen} setOpen={setModalOpen} />
    </div>
  );
};

export default DriverDocuments;
</file>

<file path="src/components/driver/DriverDocument.tsx">
// src/components/driver/DriverDocuments.tsx
'use client';

import React, { useEffect, useState } from 'react';
import { Button } from '../ui/button';
import dynamic from 'next/dynamic';
import Link from 'next/link';
import { IDriver } from '@/utils/interface';
import { loadingIndicator } from '../ui/LoadingIndicator';
import { FaChevronRight } from 'react-icons/fa6';
import { useToast } from '../hooks/use-toast';
import { CloudUpload } from 'lucide-react';

interface TripDocumentProps {
  driverId: string;
}

const DriverDocuments: React.FC<TripDocumentProps> = ({ driverId }) => {
  const DriverDocumentUpload = dynamic(() => import('@/components/documents/DriverDocumentUpload'), { ssr: false });
  const RecentDocuments = dynamic(() => import('@/components/documents/RecentDocuments'));

  const [documents, setDocuments] = useState<any[]>([]);
  const [modalOpen, setModalOpen] = useState(false);
  const [driver, setDriver] = useState<IDriver>();
  const [loading, setLoading] = useState(true);
  const { toast } = useToast();

  useEffect(() => {
    const fetchDriver = async () => {
      try {
        const response = await fetch(`/api/drivers/${driverId}`);
        if (!response.ok) {
          toast({
            description: 'Failed to load documents',
            variant: 'destructive',
          });
          return;
        }
        const data = await response.json();
        setDocuments(data.driver.documents);
        setDriver(data.driver);
      } catch (error) {
        toast({
          description: 'Failed to load documents',
          variant: 'destructive',
        });
      } finally {
        setLoading(false);
      }
    };

    fetchDriver();
  }, [driverId]);

  return (
    <div className="p-6 bg-gray-100 min-h-screen">
      <div className="flex items-center justify-between mb-4 border-b-2 border-gray-300 pb-2">
        <h1 className="text-2xl font-semibold text-black flex items-center space-x-2">
          <Button variant={'link'}>
            <Link href="/user/documents" className="text-2xl font-semibold hover:underline">
              Docs
            </Link>
          </Button>

          <FaChevronRight className="text-lg text-gray-500" />
          <Button variant={'link'}>
            <Link href="/user/documents/driverDocuments" className="text-2xl font-semibold hover:underline">
              Driver Docs
            </Link>
          </Button>

          <FaChevronRight className="text-lg text-gray-500" />
          <span className="text-2xl font-semibold hover:underline flex items-center">
            {driver?.name}
            <span className="ml-2 text-sm text-gray-500">({documents.length} files)</span>
          </span>
        </h1>
        <div className="flex justify-end my-2 fixed right-4 bottom-4">
          <Button onClick={() => setModalOpen(true)} className="rounded-full h-full py-2">
            <CloudUpload size={40} />
          </Button>
        </div>
      </div>
      {loading && loadingIndicator}
      <RecentDocuments docs={documents} />

      <DriverDocumentUpload open={modalOpen} setOpen={setModalOpen} driverId={driverId} setDocuments={setDocuments} />
    </div>
  );
};

export default DriverDocuments;
</file>

<file path="src/components/FeatureSection.tsx">
import Image from 'next/image'
import section3Img from '@/assets/section3-img.png'
import expenseMgmtIcon from '@/assets/expense management icon.png'
import tripMgntIcon from '@/assets/trip management icon.png'
import aiIcon from '@/assets/ai icon.png'
import routeIcon from '@/assets/route management icon.png'
import commingSoon from '@/assets/comming-soon.png'

interface FeatureProps {
  icon: string | any
  title: string
  description: string
  comingSoon?: boolean
}

function Feature({ icon, title, description, comingSoon = false }: FeatureProps) {
  return (
    <div className="flex items-center gap-2 w-full sm:w-auto">
      <Image src={icon} alt={`${title} icon`} width={48} height={48} />
      <div className="flex flex-col">
        <h3 className="text-xl sm:text-2xl font-semibold text-[#FF6A00] flex items-center gap-2">
          <span>{title}</span>
          {comingSoon && (
            <Image src={commingSoon} alt="coming soon" width={116} height={20} />
          )}
        </h3>
        <p className="text-base sm:text-lg leading-tight text-[#666666]" style={{ maxWidth: '300px', lineHeight: '1.4em' }}>
          {description}
        </p>
      </div>
    </div>
  )
}

export default function FeatureSection() {
  return (
    <section className="p-8 sm:p-16 bg-gradient-radial-home">
      <div className="flex flex-col gap-8 sm:gap-16">
        <h2 className="text-center font-semibold text-3xl sm:text-5xl text-black">Features</h2>

        <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 sm:gap-8">
          <Feature
            icon={expenseMgmtIcon}
            title="Expense Management"
            description="Simplify expense tracking and manage costs effortlessly."
          />
          <Feature
            icon={tripMgntIcon}
            title="Trip Management"
            description="Efficiently plan, track, and manage every trip with real-time insights."
          />
        </div>

        <div className="hidden sm:flex justify-center">
          <Image src={section3Img} alt="Fleet management features illustration" width={1000} height={613} />
        </div>

        <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 sm:gap-8 px-4 sm:px-8">
          <Feature
            icon={aiIcon}
            title="AI Fleet Management"
            description="Optimize vehicle performance and reduce downtime with AI-powered insights."
            comingSoon={true}
          />
          <Feature
            icon={routeIcon}
            title="Route Optimization"
            description="Find the fastest, most cost-effective routes with AI-driven optimization."
            comingSoon={true}
          />
        </div>
      </div>
    </section>
  )
}
</file>

<file path="src/components/HeroSection.tsx">
import Image from 'next/image'
import ScheduleDemo from '@/components/ScheduleDemo'
import heroImg from '@/assets/hero section illustration.png'

export default function HeroSection() {
  return (
    <section className="bg-gradient-radial-home px-4 sm:px-8 lg:px-16 py-6 sm:py-10">
      <div className="flex flex-wrap items-center justify-between">
        <div className="flex flex-col justify-evenly w-full lg:w-1/2 gap-4 sm:gap-6">
          <h1 className="text-2xl sm:text-4xl lg:text-6xl font-semibold leading-tight text-[#333333]">
            Manage <span className="text-[#FF6A00]">Fleet Operations</span> with Ease: Increase <span className="text-[#FF6A00]">Efficiency</span> and <span className="text-[#FF6A00]">Visibility</span> Across Every Mile
          </h1>
          <p className="text-sm sm:text-md lg:text-lg font-medium text-[#666666]">
            Streamline operations, optimize routes, and drive efficiency with our AI-powered tools and IoT solutions.
          </p>
          <div className="hidden sm:flex items-end h-full">
            <ScheduleDemo />
          </div>
        </div>

        <div className="relative w-full lg:w-auto flex justify-center lg:justify-end items-end h-full mt-6 sm:mt-10 lg:mt-0">
          <Image
            src={heroImg}
            alt="Fleet management illustration"
            width={500}
            height={600}
            className="rounded-lg"
            priority
          />
        </div>

        <div className="flex items-end h-full w-full sm:hidden mt-6">
          <ScheduleDemo />
        </div>
      </div>
    </section>
  )
}
</file>

<file path="src/components/layout/MainLayout.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import Link from 'next/link';
import { useParams, usePathname, useRouter } from 'next/navigation';
import { IoDocumentsOutline, IoLogOutOutline, IoWalletOutline } from 'react-icons/io5';
import Cookies from 'js-cookie';
import Image from 'next/image';
import logo from '@/assets/awajahi logo.png';
import jwt from 'jsonwebtoken';
import { TfiHome, TfiWorld } from "react-icons/tfi";
import { PiSteeringWheelLight, PiTruck, PiBank } from "react-icons/pi";
import { TbUsersGroup } from "react-icons/tb";
import { HiOutlineUser } from "react-icons/hi";
import { ExpenseProvider } from '@/context/context';
import { useToast } from '../hooks/use-toast';
import { ExpenseProvider as RedExpense } from '../ExpenseProvider';
import { ReminderProvider } from '@/context/reminderContext';
import { Button } from '../ui/button';
import { AnimatePresence, motion } from 'framer-motion';
import { X } from 'lucide-react';
import Loading from '@/app/user/loading';
import { loadingIndicator } from '../ui/LoadingIndicator';
import { TbFileInvoice } from 'react-icons/tb';

interface MainLayoutProps {
  children: React.ReactNode;
}

const MainLayout = ({ children }: MainLayoutProps) => {
  const { tripId } = useParams()
  const pathname = usePathname();
  const router = useRouter();
  const [selected, setSelected] = useState<string | null>(null);
  const [logoutModal, setLogoutModal] = useState(false)
  const [loggingOut, setLoggingOut] = useState(false)
  const { toast } = useToast()

  // useEffect(() => {
  //   const fetchPhone = async () => {
  //     const response = await fetch('/api/login');
  //     const data = await response.json();
  //     setUser(data.user);
  //     setPhone(data.user.phone);
  //   };
  //   fetchPhone();
  // }, []);



  useEffect(() => {
    const updateVisit = Cookies.get('updateVisit') as string;
    if (updateVisit == '1') {
      toast({
        title: 'Welcome Back!',
        description: 'New Feature to generate Frieght Memo has been added',
        variant: 'featureUpdate'
      })
    }
  }, [])

  useEffect(() => {
    const initialSelected = primaryMenuItems.find(item => pathname.startsWith(item.href));
    if (initialSelected) {
      setSelected(initialSelected.label);
    }
  }, [pathname]);

  const roleToken = Cookies.get('role_token');
  const decodedToken: any = jwt.decode(roleToken as string);

  const primaryMenuItems = [
    { href: '/user/home', label: 'Home', icon: TfiHome },
    { href: '/user/trips', label: 'Trips', icon: TfiWorld },
    { href: `/user/expenses`, label: 'Expenses', icon: IoWalletOutline },
    { href: '/user/documents', label: 'Docs', icon: IoDocumentsOutline },
    { href: '/user/invoice', label: 'Invoices', icon: TbFileInvoice },
  ];

  const secondaryMenuItems = [
    { href: '/user/drivers', label: 'Drivers', icon: PiSteeringWheelLight },
    { href: '/user/trucks', label: 'Lorries', icon: PiTruck },
    { href: '/user/parties', label: 'Customers', icon: TbUsersGroup },
    { href: '/user/suppliers', label: 'Suppliers', icon: HiOutlineUser },
    { href: '/user/shopkhata', label: 'Shop Khata', icon: PiBank },
  ];

  const handleSignOut = async () => {
    try {
      setLogoutModal(false)
      setLoggingOut(true);
      await fetch(`/api/logout`);
      Cookies.remove('auth_token');
      router.push('/login');
    } catch (error) {
      console.error('Error signing out: ', error);
    }
  };

  return (
    <div className="flex h-screen overflow-hidden bg-[#FFFCF9]">
      {
        loggingOut &&
        <div className='modal-class'>
          <div>
            {loadingIndicator}
            <p className='text-center text-white'>Logging Out...</p>
          </div>

        </div>
      }
      {/* Primary Sidebar - fixed width, fixed position */}
      <div className="w-16 xl:w-20 bg-bottomNavBarColor text-white h-full flex flex-col justify-between shadow-md shadow-black rounded-r-xl fixed">
        <div>
          {/* Primary Menu */}
          <ul className="list-none p-0 m-0 flex flex-col gap-4 py-6">
            {primaryMenuItems.map((item) => (
              <li key={item.href} className="mb-2">
                <Link href={item.href}>
                  <div
                    className={`flex flex-col space-y-2 items-center p-4 text-lg font-semibold transition duration-300 ease-in-out rounded-md 
                      ${pathname === (item.href) ? 'bg-white text-black' : 'hover:bg-lightOrange'}`}
                    onClick={() => setSelected(item.label)}
                  >
                    <item.icon className="mx-auto" size={28} />
                    <span className='text-sm text-center font-normal'>{item.label}</span>
                  </div>
                </Link>
              </li>
            ))}
          </ul>
        </div>

        {/* Sign Out */}
        <button className="py-4 cursor-pointer flex flex-col space-y-2 items-center justify-center hover:bg-lightOrange" onClick={() => setLogoutModal(true)}>
          <IoLogOutOutline size={28} />
          <span className='text-sm text-white text-center font-normal'>Log Out</span>
        </button>
      </div>

      {logoutModal &&
        <AnimatePresence>
          <motion.div
            className="modal-class"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
          >
            <motion.div
              className="bg-white rounded-lg shadow-xl p-4 w-full max-w-sm mx-4"
              initial={{ scale: 0.9, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.9, opacity: 0 }}
              transition={{ type: 'spring', damping: 15, stiffness: 300 }}
            >
              <div className="flex justify-between items-center mb-3">
                <h3 className="text-lg font-semibold">Confirm Logout</h3>
                <Button variant="ghost" size="sm" onClick={() => setLogoutModal(false)} className='px-2 py-0'>
                  <X className="h-4 w-4" />
                  <span className="sr-only">Close</span>
                </Button>
              </div>
              <p className="text-gray-600 mb-6">Are you sure you want to logout?</p>
              <div className="flex justify-end space-x-4">
                <Button variant="outline" onClick={() => setLogoutModal(false)}>
                  Cancel
                </Button>
                <Button onClick={() => handleSignOut()}>
                  Logout
                </Button>
              </div>
            </motion.div>
          </motion.div>
        </AnimatePresence>
      }

      {/* Secondary Sidebar */}
      <div className="ml-16 xl:ml-20 w-56 xl:w-60 bg-[#FFFCF9] text-black h-screen overflow-y-auto flex flex-col justify-between"> {/* Adjusted width and overflow */}
        <div className="flex items-center justify-center py-6">
          <Image src={logo} alt="logo" width={51} height={60} priority />
          <span className="ml-2 text-lg hidden font-semibold md:block text-black">Awajahi</span>
        </div>
        <ul className="flex-grow list-none p-0 m-0 flex-col gap-4">
          {secondaryMenuItems.map((item) => (
            <li key={item.href} className="my-1 border-b-2 border-gray-300">
              <div
                className={`p-2 `}
              >
                <Link href={item.href}>
                  <div
                    className={`flex items-center p-3 text-sm xl:text-lg font-semibold transition duration-300 ease-in-out rounded-xl
                    ${pathname === (item.href) ? 'bg-[#FF6A00] text-white' : 'hover:bg-[#FFC49980]'}`}
                    onClick={() => setSelected(item.label)}
                  >
                    <item.icon className="mr-3" size={25} />
                    <span className="text-lg flex items-center gap-2">
  {item.label}
  {item.label === 'Shop Khata' && (
    <span
      className="ml-2 px-2 py-0.5 bg-yellow-100 text-yellow-800 rounded font-bold text-xs"
      style={{ letterSpacing: '.5px' }}
      title="This feature is in beta and may change"
    >
      Beta
    </span>
  )}
</span>

                  </div>
                </Link>
              </div>
            </li>
          ))}
        </ul>
      </div>

      {/* Main Content Area */}
      <div className={`w-full min-h-screen overflow-y-auto pb-4 rounded-3xl bg-white shadow-black shadow-xl my-2 ${pathname.startsWith('/user/trips/trip') ? 'thin-scrollbar' : 'no-scrollbar'} `}>

        {/* Render dynamic content here */}
        <RedExpense>
          <ReminderProvider>
            {children}
          </ReminderProvider>
        </RedExpense>
      </div>
    </div >
  );
};

export default MainLayout;
</file>

<file path="src/components/Navigation.tsx">
import Image from 'next/image'
import Link from 'next/link'
import { Button } from '@/components/ui/button'
import logo_img from '@/assets/awajahi logo.png'
import loginIcon from '@/assets/login icon.png'

export default function Navigation() {
  return (
    <nav className="bg-gradient-radial-home px-4 sm:px-8 lg:px-16 py-4 sm:py-6">
      <div className="flex flex-wrap justify-between items-center w-full">
        <Link href="/" className="flex items-center space-x-2 sm:space-x-4">
          <Image
            src={logo_img}
            alt="Awajahi Logo"
            width={60}
            height={60}
            className="w-[25px] h-[27px] sm:w-[60px] sm:h-[60px]"
            priority
          />
          <span className="text-lg sm:text-2xl font-bold text-black">Awajahi</span>
        </Link>

        <ul className="hidden sm:flex items-center space-x-4 sm:space-x-8 md:space-x-16 text-lg sm:text-xl md:text-2xl font-semibold text-[#333333]">
          <li>
            <Link href="/about" className="hover:text-[#FF6A00] transition-colors duration-300">About Us</Link>
          </li>
          <li>
            <Link href="/login" className="hover:text-[#FF6A00] transition-colors duration-300 flex items-center">
              <span>Login</span>
              <Image src={loginIcon} width={24} height={24} className="sm:w-6 sm:h-6 ml-2" alt="login" />
            </Link>
          </li>
          <li>
            <Link href="/login">
              <Button className="rounded-full bg-[#CC5500] text-white px-4 sm:px-6 py-2 sm:py-3 font-bold text-md sm:text-lg">
                Sign Up
              </Button>
            </Link>
          </li>
        </ul>
      </div>
    </nav>
  )
}
</file>

<file path="src/components/WhyChooseUs.tsx">
import Image from 'next/image'
import mainIllustrationImg from '@/assets/Group 427320428.png'

interface ReasonProps {
  title: string
  description: string
  className?: string
}

function Reason({ title, description, className = '' }: ReasonProps) {
  return (
    <div className={`flex flex-col gap-4 ${className}`}>
      <h3 className="text-xl sm:text-2xl font-semibold">{title}</h3>
      <p className="leading-tight font-semibold">{description}</p>
    </div>
  )
}

export default function WhyChooseUs() {
  return (
    <section className="p-8 sm:p-16 bg-gradient-radial-home text-black">
      <h2 className="mt-10 text-3xl sm:text-5xl font-semibold text-center mb-10 sm:mb-20">Why Choose Us?</h2>

      <div className="flex flex-col sm:flex-row items-center justify-evenly mt-10 gap-10 sm:gap-0">
        <div className="w-full sm:w-1/4 flex flex-col items-start justify-between h-full space-y-10 sm:space-y-16">
          <Reason
            title="AI-Driven Optimization"
            description="Leverage cutting-edge AI technology to enhance fleet performance, minimize costs, and maximize productivity."
            className="ml-0 sm:transform sm:translate-x-64 -translate-y-0 sm:-translate-y-20"
          />
          <Reason
            title="Dedicated Support"
            description="Our expert team is available 24/7 to assist you, ensuring you get the most out of Awajahi's features and capabilities."
            className="sm:transform sm:translate-x-32 translate-y-0 sm:translate-y-5"
          />
        </div>

        <div className="w-full sm:w-auto">
          <Image 
            src={mainIllustrationImg}
            alt='Awajahi fleet management illustration' 
            width={538} 
            height={569} 
            className="mx-auto sm:mx-0" 
            priority
          />
        </div>

        <div className="w-full sm:w-1/4 flex flex-col items-start justify-between h-full space-y-10 sm:space-y-16">
          <Reason
            title="Boost Efficiency"
            description="Save time and reduce costs with automated processes."
            className="sm:transform sm:-translate-x-5 translate-y-0 sm:translate-y-20"
          />
          <Reason
            title="Real-Time Visibility"
            description="Stay in control with real-time data and insights, ensuring you're always informed and ready to make quick, informed decisions."
            className="sm:transform sm:-translate-x-40 translate-y-0 sm:translate-y-48"
          />
        </div>
      </div>
    </section>
  )
}
</file>

<file path="src/firebase/firebaseAdmin.ts">
// utils/firebaseAdmin.ts
import * as admin from 'firebase-admin';

// Check if the environment variable exists
if (!process.env.FIREBASE_SERVICE_ACCOUNT_JSON) {
  throw new Error('The FIREBASE_SERVICE_ACCOUNT_JSON environment variable is not set.');
}

// Parse the environment variable as a JSON object
const serviceAccount = JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT_JSON);

// Initialize the app if it's not already initialized
if (!admin.apps.length) {
  admin.initializeApp({
    credential: admin.credential.cert(serviceAccount)
  });
}

// Export the services you need
export const auth = admin.auth();
export const messaging = admin.messaging();
</file>

<file path="tailwind.config.ts">
import { Config } from 'tailwindcss'

const config: Config = {
  darkMode: ["class"],
  content: [
    './pages/**/*.{ts,tsx}',
    './components/**/*.{ts,tsx}',
    './app/**/*.{ts,tsx}',
    './src/**/*.{ts,tsx}',
  ],
  screens : {
    lg : '1026px'
  },
  theme: {
    container: {
      center: true,
      padding: "2rem",
      screens: {
        "2xl": "1400px",
      },
    },
    extend: {
      colors: {
        white: '#ffffff',
        warning: {
          DEFAULT: '#ffcc00',
          foreground: '#FFFFFF',
        },
        featureUpdate: {
          DEFAULT: '#4caf50',
          foreground: '#ffffff',
        },
        gray: {
          100: '#f5f5f5',
        },
        // Custom Colors
        whiteColor: '#ffffff',
        primaryColor: '#FF6A00',
        backgroundColor: '#FFFFFFFa',
        primaryTextColor: '#000000',
        secondaryTextColor: '#5a5a5a',
        splashColor: 'rgba(255, 255, 255, 0.3)',
        cardColor: '#ffffff',
        cardSecondaryColor: '#cecece',
        buttonColor: '#000000',
        borderColor: '#c3c3c3',
        bottomNavBarColor: '#FE8631', 
        primaryOrange: '#ff6a00',
        lightOrange: '#ffa666',
        lightOrangeButtonColor: '#ffcaA4',
        destructive: '#D95C2B',
        buttonTextColor: '#6F2718',
        hoverColor: '#FFC49980',

        // Replaced HSL-based Colors with example color codes
        border: "#e2e8f0",
        input: "#e2e8f0",
        ring: "#93c5fd",
        background: "#ffffff",
        foreground: "#020617",
        primary: {
          DEFAULT: "#3b82f6",
          foreground: "#ffffff",
        },
        secondary: {
          DEFAULT: "#64748b",
          foreground: "#ffffff",
        },
        muted: {
          DEFAULT: "#f1f5f9",
          foreground: "#64748b",
        },
        accent: {
          DEFAULT: "#f59e0b",
          foreground: "#ffffff",
        },
        popover: {
          DEFAULT: "#ffffff",
          foreground: "#020617",
        },
        card: {
          DEFAULT: "#ffffff",
          foreground: "#020617",
        },
      },
      borderRadius: {
        lg: "0.5rem",
        md: "0.375rem",
        sm: "0.25rem",
      },
      keyframes: {
        "accordion-down": {
          from: { height: "0" },
          to: { height: "var(--radix-accordion-content-height)" },
        },
        "accordion-up": {
          from: { height: "var(--radix-accordion-content-height)" },
          to: { height: "0" },
        },
      },
      animation: {
        "accordion-down": "accordion-down 0.2s ease-out",
        "accordion-up": "accordion-up 0.2s ease-out",
      },
      fontFamily: {
        roboto: ['Roboto', 'sans-serif'],
      },
      backgroundImage: {
        'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
        'gradient-radial-home': 'radial-gradient(ellipse_at_80%_50%,_#FFC499_0%,_#FFFFFF_80%)',
        'gradient-radial-home2': 'radial-gradient(ellipse_at_80%_50%,_#FFFFFF_0%,_#FFC499_80%)',
      },
    },
  },
  plugins: [require("tailwindcss-animate")],
}

export default config
</file>

<file path="vercel.json">
{
    "regions": ["sin1"],
    "crons": [
    {
      "path": "/api/cron/send-expiry-notifications?cron_secret=aK4gH9sLpW2bVzF5nQ9xR7jG",
      "schedule": "0 5 * * *"
    }
  ]
  }
</file>

<file path="src/app/user/suppliers/create/page.tsx">
'use client'

import React, { useEffect, useState } from 'react';
import SupplierForm from '@/components/createSupplier';
import { ISupplier } from '@/utils/interface';
import { useRouter, useSearchParams } from 'next/navigation';
import { isValidPhone } from '@/utils/validate';
import Loading from '../loading';


const CreateSupplierPage: React.FC = () => {
    const [saving, setSaving] = useState(false)
    const router = useRouter();
    const params = useSearchParams()
    const nextpath = params.get('nextpath')


    const handlePartySubmit = async (supplier: ISupplier) => {
        setSaving(true)


        if ( supplier.contactNumber && !isValidPhone(supplier.contactNumber)) {
            alert('Invalid phone number. Please enter a 10-digit phone number.');
            setSaving(false)
            return;
        }

        try {

            const res = await fetch('/api/suppliers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(supplier),
            });

            if (!res.ok) {
                if (res.status === 400) {
                    const errorData = await res.json();
                    alert(`Error: ${errorData.message}`);
                    return;
                } else {
                    alert('An unexpected error occurred. Please try again.');
                    return;
                }
            }

            const data = await res.json();
            console.log(data);
            if (nextpath) {
                router.push(nextpath);
            } else {
                router.push('/user/suppliers');
            }
        } catch (error) {
            console.error('Error saving supplier:', error);
            alert('An error occurred while adding the supplier. Please try again.');
        }finally{
            setSaving(false)
        }
    };

    return (
        <>
            {saving && (
                <div className='absolute inset-0 bg-black bg-opacity-10 flex justify-center items-center z-50'>
                    <Loading />
                </div>
            )}
            <div className='w-full h-full'>
                <SupplierForm onSubmit={handlePartySubmit} />
            </div>
        </>

    );
};

export default CreateSupplierPage;
</file>

<file path="src/components/createDriver.tsx">
'use client'

import React, { useState } from 'react';
import { IDriver } from '@/utils/interface';
import { v4 as uuidv4 } from 'uuid';
import { Button } from './ui/button';

interface Props {
  onSubmit: (driver: IDriver) => void;
}

const DriverForm: React.FC<Props> = ({ onSubmit }) => {
  // State to hold form data
  const [formData, setFormData] = useState<Partial<IDriver>>({
    name: '',
    contactNumber: '',
    licenseNo: '',
    aadharNo: '',
    lastJoiningDate: new Date(Date.now())
  });

  const handleFocus = (e: React.FocusEvent<HTMLInputElement>) => {
    if (e.target.value === '0') {
      handleChange({ target: { name: e.target.name, value: '' } } as React.ChangeEvent<HTMLInputElement>);
    }
  };

  // Handle input changes and update the state
  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setFormData(prev => ({
      ...prev,
      [e.target.name]: e.target.value,
    }))
  };

  // Handle form submission
  const handleSubmit = (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    // Generate a unique driver ID
    const driverId = 'driver' + uuidv4();
    // Create a new driver object
    const newDriver: IDriver = {
      ...formData,
      status: 'Available',
      driver_id: driverId,
      createdAt: new Date(),
      updatedAt: new Date(),
    } as IDriver; // Type assertion to ensure newDriver matches IDriver
    // Call onSubmit with the new driver object
    onSubmit(newDriver);
    // Optionally, clear the form after submission
    setFormData({
      name: '',
      contactNumber: '',
      balance: 0,
    });
  };

  return (
    <form onSubmit={handleSubmit} className="w-full max-w-md mx-auto p-4 bg-white shadow-md rounded-md text-black">
      <label className="block mb-2">
        Name*
        <input
          type="text"
          name="name"
          value={formData.name}
          onChange={handleChange}
          required
          className="block w-full p-2 mt-1 border border-gray-300 rounded-md"
        />
      </label>
      <label className="block mb-2">
        Contact Number
        <input
          type="text"
          name="contactNumber"
          value={formData.contactNumber}
          onChange={handleChange}
          className="block w-full p-2 mt-1 border border-gray-300 rounded-md"
        />
      </label>
      <label className="block mb-2">
        Aadhar Number
        <input
          type="text"
          name="aadharNo"
          value={formData.aadharNo}
          onChange={handleChange}
          className="block w-full p-2 mt-1 border border-gray-300 rounded-md"
        />
      </label>
      <label className="block mb-2">
        License Number
        <input
          type="text"
          name="licenseNo"
          value={formData.licenseNo}
          onChange={handleChange}
          className="block w-full p-2 mt-1 border border-gray-300 rounded-md"
        />
      </label>
      <label className="block mb-2">
        Last Joining Date
        <input
          type="date"
          name="lastJoiningDate"
          value={formData.lastJoiningDate ? new Date(formData.lastJoiningDate).toISOString().split('T')[0] : ''}
          onChange={handleChange}
          onClick={(e) => (e.target as HTMLInputElement).showPicker()}
          className="block w-full p-2 mt-1 border border-gray-300 rounded-md"
        />
      </label>
      <Button type="submit" className='w-full justify-center'>
        Submit
      </Button>
    </form>
  );
};

export default DriverForm;
</file>

<file path="src/components/documents/DriverDocumentUpload.tsx">
import { useMemo, useState } from 'react';
import { Button } from '../ui/button';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '../ui/select';
import { motion } from 'framer-motion'
import { usePathname, useRouter } from 'next/navigation';
import { getDocType } from '@/helpers/ImageOperation';
import { createWorker } from 'tesseract.js';
import { extractLatestDate } from '@/helpers/ImageOperation';
import { mutate } from 'swr';
import { Loader2 } from 'lucide-react';
import SingleFileUploader from '../SingleFileUploader';
import { useToast } from '../hooks/use-toast';
import { useExpenseData } from '../hooks/useExpenseData';

interface DocumentForm {
    filename: string;
    validityDate: string;  // ISO string for the date input
    docType: string;
    file: File | null;
    driverId: string;

}

type Props = {
    open: boolean;
    driverId?: string;
    setOpen: (open: boolean) => void;
    documentId?: string;
    setDocuments?: any
    setDriver?: any
};

const DriverDocumentUpload: React.FC<Props> = ({ open, setOpen, driverId, documentId, setDocuments, setDriver }) => {
    const { drivers } = useExpenseData()
    const [formData, setFormData] = useState<DocumentForm>({
        filename: '',
        validityDate: new Date().toISOString().split('T')[0],
        docType: '',
        file: null,
        driverId: driverId || ''
    });

    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');
    const [successMessage, setSuccessMessage] = useState('');
    const [searchTerm, setSearchTerm] = useState('');
    const { toast } = useToast()
    const isOtherPage = usePathname() === '/user/documents/otherDocuments'



    // Filter drivers based on search term

    const filteredDrivers = useMemo(() => {
        if (!drivers || drivers.length === 0) return []
        let filtered = [...drivers]
        if (searchTerm) {
            const lowercaseQuery = searchTerm.toLowerCase()
            filtered = drivers.filter((driver) =>
                driver.name.toLowerCase().includes(lowercaseQuery) ||
                driver.contactNumber.toLowerCase().includes(lowercaseQuery)
            )
        }
        return filtered
    }, [drivers, searchTerm])


    // Handle option selection for lorry (driver)
    const handleOptionSelect = (value: string) => {
        setFormData((prev) => ({ ...prev, driverId: value }));
    };

    // Handle input changes
    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
        const { name, value } = e.target;
        setFormData({
            ...formData,
            [name]: value,
        });
    };

    const extractTextFromImage = async (file: File): Promise<string> => {
        const worker = await createWorker('eng');
        const { data: { text } } = await worker.recognize(file);
        await worker.terminate();
        return text;
    };

    // Handle file change
    // Handle file change
    const handleFileChange = async (file: File) => {
        // e.preventDefault(); // prevent any accidental form submission due to file input change

        const types = new Set(['License', 'Aadhar', 'PAN', 'Police Verification'])

        const fileData = new FormData();
        if (file) {
            setFormData({
                ...formData,
                filename: file.name,
                file: file,
            });

            fileData.append('file', file as File);
            setLoading(true);
            try {
                if (file.type.includes('image/')) {
                    const text = await extractTextFromImage(file);
                    const type = getDocType(text);
                    const validity: string = extractLatestDate(text) as any;
                    setFormData((prev) => ({
                        ...prev,
                        docType: types.has(type) ? type : 'Other',
                        validityDate: new Date(validity || Date.now()).toISOString().split('T')[0]
                    }));
                    setLoading(false);
                    return;
                } else {
                    const res = await fetch(`/api/documents/validate`, {
                        method: 'POST',
                        body: fileData,
                    });

                    setLoading(false);

                    if (!res.ok) {
                        toast({
                            description: 'Failed to get validity and docType. Please enter manually.',
                            variant: 'destructive'
                        })
                        setError('Failed to get validity and docType. Please enter manually.');
                        return;
                    }

                    const data = await res.json();
                    if (data.status === 402) {
                        setError(data.error);
                        return;
                    }
                    setFormData({
                        ...formData,
                        file: file,
                        filename: file.name,
                        validityDate: new Date(data.validity).toISOString().split('T')[0],
                        docType: types.has(data.docType) ? data.docType : 'Other',
                    });
                }
            } catch (error) {
                setLoading(false);
                toast({
                    description: 'Failed to get validity and docType. Please enter manually.',
                    variant: 'destructive'
                })
                setError('Error occurred while validating document. Please enter manually.');
            }
        }
    };


    // Handle form submission
    const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault();

        if (!formData.file) {
            setError('Please upload a document.');
            return;
        }
        if (!formData.docType || !formData.validityDate) {
            setError('Please fill out all fields')
            toast({
                description: 'Please fill out all fields',
                variant: 'warning'
            })
            setLoading(false)
            return;
        }

        setLoading(true);
        setError('');
        setSuccessMessage('');

        const data = new FormData();
        data.append('file', formData.file);
        data.append('filename', formData.filename);
        data.append('validityDate', formData.validityDate);
        data.append('docType', formData.docType);

        try {
            const response = await fetch(`/api/drivers/${driverId || formData.driverId}/documents`, {
                method: 'PUT',
                body: data,
            });

            setLoading(false);

            if (response.ok) {
                toast({
                    description: 'Documents uploaded successfully!',
                })
                setSuccessMessage('Document uploaded successfully!');
                setError('');
                setFormData({
                    filename: '',
                    validityDate: new Date().toISOString().split('T')[0],
                    docType: '',
                    file: null,
                    driverId: ''
                });
                setOpen(false);
                const data = await response.json()
                mutate('/api/documents/recent')
                if (setDocuments) {
                    setDocuments((prev: any) => [
                        { ...data.document },
                        ...prev
                    ])
                } else if (setDriver) {
                    setDriver((prev: any) => ({
                        ...prev,
                        documents: [data.document, ...prev.documents]
                    }))
                }
                toast({
                    description: 'Document uploaded successfully',
                    variant: 'default'
                })
            } else {
                const errorData = await response.json();
                toast({
                    description: 'Something went wrong',
                    variant: 'destructive'
                })
                setError(errorData.message || 'Something went wrong.');
            }
        } catch (err) {
            setLoading(false);
            toast({
                description: 'Something went wrong',
                variant: 'destructive'
            })
            setError('Failed to upload document.');
        }
    };

    const handleMove = async (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault()
        setLoading(true)
        if (!formData.docType || !formData.validityDate) {
            setError('Please fill out all fields')
            toast({
                description: 'Please fill out all fields',
                variant: 'warning'
            })
            setLoading(false)
            return;
        }
        try {
            const res = await fetch(`/api/documents/${documentId}?movingto=driver`, {
                method: 'PATCH',
                body: JSON.stringify({
                    driverId: formData.driverId,
                    filename: formData.filename,
                    validityDate: new Date(formData.validityDate),
                    docType: formData.docType
                })
            })
            if (res.ok) {
                toast({
                    description: 'Document moved successfully!',
                    variant: 'default'
                })
                const data = await res.json();
            } else {
                toast({
                    description: 'Failed to move document!',
                    variant: 'destructive'
                })
            }
        } catch (error) {
            toast({
                description: 'Internal Server Error',
                variant: 'destructive'
            })
        }
        setOpen(false)
        setLoading(false)
        setDocuments((prev: any) => prev.filter((doc: any) => doc._id !== documentId))
    }

    if (!open) {
        return null;
    }

    return (
        <div className='modal-class'>
            <motion.div
                initial={{ opacity: 0, scale: 0.5 }}
                animate={{ opacity: 1, scale: 1 }}
                transition={{
                    duration: 0.5,
                    ease: [0, 0.71, 0.2, 1.01]
                }} className="w-full max-w-3xl mx-auto bg-white p-6 rounded-lg shadow-md flex flex-col">
                <h1 className="text-2xl font-semibold mb-4 text-black">{isOtherPage ? 'Moving to Driver Document' : "Upload Document"}</h1>

                {/* Loading indicator */}


                {error && <p className="text-red-500 mb-4">{error}</p>}
                {successMessage && <p className="text-green-500 mb-4">{successMessage}</p>}

                <form onSubmit={isOtherPage ? handleMove : handleSubmit}>

                    {!isOtherPage && <SingleFileUploader onFileChange={handleFileChange} />}
                    {/* Lorry (driver) select */}
                    <div className="mb-4">
                        <label className="block text-sm text-gray-700">Driver*</label>
                        <Select name="driver" defaultValue={formData.driverId} onValueChange={handleOptionSelect}>
                            <SelectTrigger className="w-full">
                                <SelectValue placeholder="Select Driver" />
                            </SelectTrigger>
                            <SelectContent>
                                <div className="p-2">
                                    <input
                                        type="text"
                                        placeholder="Search..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        className="w-full p-2 border border-gray-300 rounded-md"
                                    />
                                </div>
                                {filteredDrivers.length > 0 ? (
                                    filteredDrivers.map((driver) => (
                                        <SelectItem key={driver.driver_id} value={driver.driver_id} >
                                            <div className='grid grid-cols-3 text-left w-full gap-4'>
                                                <p className='col-span-1'>{driver.name}</p>
                                                <p className='col-span-1'>{driver.contactNumber}</p>
                                                <p
                                                    className={`col-span-1 p-1 rounded ${driver.status === 'Available' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}
                                                >
                                                    {driver.status}
                                                </p>
                                            </div>


                                        </SelectItem>
                                    ))
                                ) : (
                                    <div className="p-2 text-gray-500">No drivers found</div>
                                )}
                            </SelectContent>
                        </Select>
                    </div>



                    {/* Filename input */}
                    <div className="mb-4">
                        <label className="block text-gray-700">Filename</label>
                        <input
                            type="text"
                            name="filename"
                            value={formData.filename}
                            onChange={handleChange}
                            className="w-full mt-1 p-2 border rounded"
                            placeholder="(optional)"
                        />
                    </div>

                    {/* Document Type select */}
                    <div className="mb-4">
                        <label className="block text-gray-700">Document Type*</label>
                        <select
                            name="docType"
                            value={formData.docType}
                            onChange={handleChange}
                            required
                        >
                            <option value="" disabled>Select Document Type</option>
                            <option value="License">License</option>
                            <option value="Aadhar">Aadhar</option>
                            <option value="PAN">PAN (Permanent Account Number)</option>
                            <option value="Police Verification">Police Verification</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    {/* Validity Date input */}
                    <div className="mb-4">
                        <label className="block text-gray-700">Validity Date*</label>
                        <input
                            type="date"
                            name="validityDate"
                            value={formData.validityDate}
                            onChange={handleChange}
                            onClick={(e) => (e.target as HTMLInputElement).showPicker()}
                            className="w-full mt-1 p-2 border rounded"
                            required
                        />
                    </div>



                    {/* Submit button */}
                    <div className="flex items-center space-x-2 justify-end">
                        <Button type="submit" disabled={loading}>
                            {loading ? (
                                <div className="flex items-center justify-center ">
                                    <Loader2 className='animate-spin text-white' />
                                </div>
                            ) : 'Submit'}
                        </Button>
                        <Button variant={'outline'} onClick={() => setOpen(false)}>
                            Cancel
                        </Button>
                    </div>
                </form>
            </motion.div>
        </div>


    );
};

export default DriverDocumentUpload;
</file>

<file path="src/components/shopkhata/ShopModal.tsx">
import React, { useEffect, useState } from 'react';
import { driverGave, driverGot } from '@/utils/utilArray';
import { Button } from '../ui/button';

interface DriverModalProps {
  open: boolean;
  onClose: () => void;
  type: 'payment' | 'credit' | null;
  onConfirm: any
  selected?: any;
}

const ShopModal: React.FC<DriverModalProps> = ({ open, onClose, type, onConfirm, selected }) => {
  const [amount, setAmount] = useState<number>(0);
  const [reason, setReason] = useState<string>('');
  const [date, setDate] = useState<string>('');
  const [otherReason, setOtherReason] = useState<string>('');

  useEffect(() => {
    if (selected) {
      setAmount(selected.gave ? selected.gave : selected.got || 0);
      setReason(selected.reason || '');
      setDate(selected.date ? new Date(selected.date).toISOString().split('T')[0] : '');
      setOtherReason('');
    }
  }, [selected]);

  const handleConfirm = () => {
    const finalReason = reason === 'Other' ? otherReason : reason;
    if(selected){
      onConfirm({
        gave : selected.gave ? amount : 0,
        got : selected.got ? amount : 0,
        reason : finalReason,
        date : date
      })
    }else{
      onConfirm(amount, finalReason, date);
    }
    
    onClose()
    setAmount(0);
    setReason('');
    setOtherReason('');
    setDate('');
  };

  const handleCancel = () => {
    onClose();
  };


  return (
    <>
      {open && (
        <div className="modal-class">
          <div className="absolute inset-0 bg-gray-900 opacity-50 backdrop-blur-lg"></div>
          <div className="relative bg-white p-8 rounded-lg shadow-lg w-96">
            <h2 className="text-xl font-bold mb-4">{type === 'credit' ? 'Credit' : 'Payment'}</h2>
            <form>
              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700">Amount</label>
                <input
                  type="number"
                  className="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50"
                  value={amount}
                  onChange={(e) => setAmount(Number(e.target.value))}
                  required
                />
              </div>
              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700">Reason</label>
                
                  <input
                    type="text"
                    className="mt-2 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50"
                    placeholder="Enter other reason"
                    value={reason}
                    onChange={(e) => setReason(e.target.value)}
                    required
                  />
              </div>
              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700">Date</label>
                <input
                  type="date"
                  onClick={(e) => (e.target as HTMLInputElement).showPicker()}
                  className="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50"
                  value={date}
                  onChange={(e) => setDate(e.target.value)}
                  required
                />
              </div>
              <div className="flex justify-end gap-2">
                <Button onClick={handleConfirm}>Confirm</Button>
                <Button
                  variant={'ghost'}
                  
                  onClick={handleCancel}
                >
                  Cancel
                </Button>
              </div>
            </form>
          </div>
        </div>
      )}
    </>
  );
};

export default ShopModal;
</file>

<file path="src/components/supplier/AddPaymentModal.tsx">
import React, { useEffect, useState } from 'react';
import { Button } from '../ui/button';
import TripAllocationModal from './TripAllocationModal';
import { ISupplierAccount, ITrip } from '@/utils/interface';
import { Loader2 } from 'lucide-react';

interface AddPaymentModalProps {
    isOpen: boolean;
    onClose: () => void;
    onSave: (payment: ISupplierAccount[]) => void;
    supplierId: string;
}

const AddPaymentModal = ({ isOpen, onClose, onSave, supplierId }: AddPaymentModalProps) => {
    const [amount, setAmount] = useState<number | ''>('');
    const [paymentMode, setPaymentMode] = useState('cash');
    const [date, setDate] = useState<string>(new Date().toISOString().split('T')[0]);
    const [notes, setNotes] = useState('');
    const [refNo, setRefNo] = useState('');
    const [trips, setTrips] = useState<ITrip[]>([]);
    const [tripAllocations, setTripAllocations] = useState<Record<string, number>>({});
    const [totalTruckHireCost, setTotalTruckHireCost] = useState<number>(0);
    const [truckHireCosts, setTruckHireCosts] = useState<Record<string, number>>({});
    const [isTripAllocationModalOpen, setIsTripAllocationModalOpen] = useState(false);
    const [saving, setSaving] = useState(false);

    useEffect(() => {
        const fetchTrips = async () => {
            try {
                const response = await fetch(`/api/suppliers/${supplierId}/payments/trips`);
                if (!response.ok) {
                    throw new Error('Failed to fetch trips');
                }
                const data = await response.json();
                setTrips(data.trips);
                const totalCost = data.trips.reduce((sum: number, trip: ITrip) => trip.truckHireCost ? sum + trip.truckHireCost : sum + 0, 0);
                setTotalTruckHireCost(totalCost);

                // Fetch the truck hire cost for each trip
                const costs: Record<string, number> = {};
                for (const trip of data.trips) {
                    const res = await fetch(`/api/suppliers/${supplierId}/payments/trips/${trip.trip_id}`);
                    const costData = await res.json();
                    costs[trip.trip_id] = trip.truckHireCost - costData.totalAmount;
                }
                setTruckHireCosts(costs);
            } catch (error) {
                console.error(error);
            }
        };

        if (isOpen) {
            fetchTrips();
        }
    }, [isOpen, supplierId]);

    const handleSave = () => {
        // If tripAllocations is empty, create a single payment entry without trip_id
        setSaving(true)
        const payments = Object.entries(tripAllocations).length > 0
            ? Object.entries(tripAllocations).map(([tripId, allocatedAmount]) => ({
                supplier_id: supplierId, // Assign the appropriate supplier_id
                amount: allocatedAmount,
                paymentMode,
                date,
                notes,
                refNo,
                trip_id: tripId || '', // Include trip_id if available
            }))
            : [{
                supplier_id: supplierId, // Assign the appropriate supplier_id
                amount: typeof amount === 'number' ? amount : 0, // Use the entered amount
                paymentMode,
                date,
                notes,
                refNo,
            }];

        // Call onSave with the constructed payments array
        onSave(payments as any);
        setSaving(false)
    };


    const getRefNoLabel = () => {
        switch (paymentMode) {
            case 'online':
                return 'Transaction ID';
            case 'bank transfer':
                return 'Bank Reference Number';
            case 'cheque':
                return 'Cheque Number';
            default:
                return 'Reference Number';
        }
    };

    const openTripAllocationModal = () => {
        if (!amount) return alert('Enter Amount')
        setIsTripAllocationModalOpen(true);
    };

    const handleAllocate = (allocations: Record<string, number>) => {
        setTripAllocations(allocations);
    };

    if (!isOpen) return null;

    return (
        <>
            <div className="modal-class overflow-auto">
                <div className="bg-white p-6 rounded shadow-lg w-3/4 max-w-xl">
                    <h2 className="text-xl font-bold mb-4">Add Payment</h2>
                    <div className="mb-4">
                        <label className="block text-gray-700">Amount</label>
                        <input
                            type="number"
                            value={amount}
                            onChange={(e) => {
                                const value = e.target.value;
                                setAmount(value === '' ? '' : Number(value));
                            }}
                            placeholder='Amount'
                        />
                    </div>
                    <div className="mb-4">
                        <label className="block text-gray-700">Payment Mode</label>
                        <select
                            value={paymentMode}
                            onChange={(e) => setPaymentMode(e.target.value)}
                            className="mt-1 block w-full p-2 border rounded border-lightOrange focus:ring focus:ring-lightOrangeButtonColor focus:border-lightOrange focus:outline-none"
                        >
                            <option value="cash">Cash</option>
                            <option value="online">Online</option>
                            <option value="bank transfer">Bank Transfer</option>
                            <option value="cheque">Cheque</option>
                        </select>
                    </div>
                    <div className="mb-4">
                        <label className="block text-gray-700">Date</label>
                <input
                            type="date"
                            value={date}
                            onClick={(e) => (e.target as HTMLInputElement).showPicker()}
                            onChange={(e) => setDate(e.target.value)}
                            className="mt-1 block w-full p-2 border rounded"
                        />
                    </div>
                    <div className="mb-4">
                        <label className="block text-gray-700">Notes</label>
                        <textarea
                            value={notes}
                            onChange={(e) => setNotes(e.target.value)}
                            className="mt-1 block w-full p-2 border rounded"
                            placeholder='Notes'
                        />
                    </div>
                    {paymentMode !== 'cash' && (
                        <div className="mb-4">
                            <label className="block text-gray-700">{getRefNoLabel()}</label>
                            <input
                                type="text"
                                value={refNo}
                                onChange={(e) => setRefNo(e.target.value)}
                                placeholder={getRefNoLabel()}
                            />
                        </div>
                    )}
                    <div className="mb-4">
                        <Button onClick={openTripAllocationModal}>Allocate to Trips</Button>
                    </div>
                    <div className="flex justify-end space-x-2 mt-4">
                        <Button variant="outline" onClick={onClose}>Cancel</Button>
                        <Button onClick={handleSave} disabled={saving}>{saving ? <Loader2 className='text-bottomNavBarColor animate-spin' /> : 'Save'}</Button>
                    </div>
                </div>
            </div>

            <TripAllocationModal
                isOpen={isTripAllocationModalOpen}
                onClose={() => setIsTripAllocationModalOpen(false)}
                trips={trips}
                truckHireCosts={truckHireCosts}
                totalAmount={typeof amount === 'number' ? amount : 0}
                onAllocate={handleAllocate}
            />
        </>
    );
};

export default AddPaymentModal;
</file>

<file path="src/components/trip/BiltyForm.tsx">
"use client"

import type React from "react"
import { useEffect, useRef, useState } from "react"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group"
import { Loader2, X } from "lucide-react"
import { motion, AnimatePresence } from "framer-motion"
import type { ConsignerConsigneeType, EWBFormDataType, ITrip } from "@/utils/interface"
import { Bilty } from "@/utils/DocGeneration"
import "jspdf/dist/polyfills.es.js"
import { jsPDF } from "jspdf"
import html2canvas from "html2canvas"
import { useToast } from "../hooks/use-toast"
import { savePDFToBackend } from "@/utils/saveTripDocs"

type Props = {
  isOpen: boolean
  onClose: () => void
  trip: ITrip | any
  setTrip: React.Dispatch<React.SetStateAction<any>>
}

const placeholders: { [key: string]: string } = {
  gstNumber: "Enter GST Number",
  pan: "Enter PAN",
  companyName: "Enter Company Name",
  address: "Enter Address",
  city: "Enter City",
  pincode: "Enter Pincode",
  contactNumber: "Enter Contact Number",
  email: "Enter Email Address",
  date: "Select Date",
  LR: "Enter LR Number",
  from: 'Enter origin',
  to: 'Enter destination',
  consigner: "Enter Consigner Details",
  consignee: "Enter Consignee Details",
  material: "Enter Material Name",
  weight: "Enter Weight",
  unit: "Enter Unit",
  paidBy: "Enter Payment Responsible Party",
  ewayBillNo: "Enter E-Way Bill Number",
  invoiceNo: "Enter Invoice Number",
  name: "Enter Name",
  value: "Value",
}

const steps = [
  {
    title: "Company Details",
    fields: ["gstNumber", "pan", "companyName", "address", "city", "pincode", "contactNumber", "email"],
  },
  {
    title: "Consigner/Consignee Details",
    fields: ["from", "to", "date", "LR", "consigner", "consignee"],
  },
  {
    title: "Trip Details",
    fields: ["material", "weight", "unit", "paidBy"],
  },
  {
    title: "E-Way Bill Details",
    fields: ["ewayBillNo", "invoiceNo"],
  },
]

const tabs = ["Consigner", "Consignee", "Office", "Driver"]

export default function BiltyForm({ isOpen, onClose, trip, setTrip }: Props) {
  const { toast } = useToast()
  const [currentStep, setCurrentStep] = useState(0)
  const [showBill, setShowBill] = useState(false)
  const [user, setUser] = useState<any>()
  const [pdfDownloading, setPDFDownloading] = useState(false)
  const [formData, setFormData] = useState<EWBFormDataType>({
    gstNumber: "",
    pan: "",
    companyName: "",
    address: "",
    city: "",
    pincode: "",
    contactNumber: "",
    email: "",
    from: trip.route.origin || '',
    to: trip.route.destination || "",
    date: new Date(trip.startDate),
    LR: trip.LR || "",
    consigner: {
      gstNumber: "",
      name: "",
      address: '',
      city: trip.route.origin,
      pincode: "",
      contactNumber: "",
    },
    consignee: {
      gstNumber: "",
      name: "",
      address: '',
      city: trip.route.destination,
      pincode: "",
      contactNumber: "",
    },
    weight: "",
    unit: "",
    paidBy: "consigner",
    ewayBillNo: "",
    invoiceNo: "",
    value: "",
    truckNo: trip.truck || "",
    logo: "",
    signature: "",
    materials: trip.material || [],
    grtdWeight: trip.guaranteedWeight || '',
    altPhone : ""
  })
  const billRef = useRef<HTMLDivElement>(null)

  const fetchUser = async () => {
    try {
      const res = await fetch("/api/users")
      if (!res.ok) {
        alert("Failed to fetch details")
        return
      }
      const data = await res.json()
      const user = data.user
      setUser(user)
      setFormData((prev) => ({
        ...prev,
        companyName: user.company,
        address: user.address,
        contactNumber: user.phone,
        gstNumber: user.gstNumber,
        logo: user.logoUrl,
        signature: user.signatureUrl,
        pincode: user.pincode,
        pan: user.panNumber,
        city: user.city,
        email: user.email,
        altPhone : user.altPhone || ""
      }))
    } catch (error) {
      alert("Failed to fetch User Details")
    }
  }

  useEffect(() => {
    if (isOpen) fetchUser()
  }, [isOpen])

  const biltyColor = (copy: string) => {
    switch (copy) {
      case "Consigner":
        return "bg-red-100"
      case "Consignee":
        return "bg-blue-100"
      case "Driver":
        return "bg-yellow-100"
      case "Office":
        return "bg-green-100"

      default:
        break
    }
  }

  const downloadAllPDFs = async () => {
    const pdf = new jsPDF({
      orientation: "landscape",
      unit: "mm",
      format: "a4",
    })

    setPDFDownloading(true)

    try {
      // Remove the initial blank page
      pdf.deletePage(1)

      // Generate PDF pages for all tabs
      for (const tab of tabs) {
        const element = document.getElementById(`pdf-bilty-${tab}`)
        if (element) {
          const canvas = await html2canvas(element, { scale: 2 })
          const imgData = canvas.toDataURL("image/jpeg")

          const padding = 10 // 10mm padding on each side
          const imgWidth = canvas.width / 2 // Divide by 2 because of scale: 2
          const imgHeight = canvas.height / 2

          // Set the PDF page size to match the image size plus padding
          pdf.addPage([imgWidth + padding * 2, imgHeight + padding * 2], "landscape")
          pdf.addImage(imgData, "JPEG", padding, padding, imgWidth, imgHeight)
        }
      }

      // Save the generated PDF to the user's local device
      pdf.save(`Bilty-${trip.LR}-${formData.truckNo}.pdf`)

      // Update user details if necessary
      if (
        (!user.companyName && formData.companyName) ||
        (!user.address && formData.address) ||
        (!user.gstNumber && formData.gstNumber) ||
        (!user.panNumber && formData.pan) ||
        (!user.pincode && formData.pincode) ||
        (!user.city && formData.city) ||
        (!user.email && formData.email)
      ) {
        await updateUserDetails()
      }

      // Save the PDF file to the backend
      const filename = `Bilty-${trip.LR}-${trip.truck}.pdf`
      const docData = await savePDFToBackend(pdf, filename, "Bilty", trip, formData.date)

      setTrip((prev: ITrip | any) => ({
        ...prev,
        documents: docData.documents,
      }))

      toast({
        description: "Bilty saved successfully to documents",
      })
    } catch (error) {
      console.error("Error processing PDF:", error)
      toast({
        description: "An error occurred while saving bilty",
        variant: "destructive",
      })
    } finally {
      setPDFDownloading(false)
    }
  }

  const updateUserDetails = async () => {
    const formdata = new FormData()
    formdata.append(
      "data",
      JSON.stringify({
        companyName: user.companyName || formData.companyName,
        address: user.address || formData.address,
        gstNumber: user.gstNumber || formData.gstNumber,
        panNumber: user.panNumber || formData.pan,
        pincode: user.pincode || formData.pincode,
        city: user.city || formData.city,
        email: user.email || formData.email,
      }),
    )

    const response = await fetch("/api/users", {
      method: "PUT",
      body: formdata,
    })

    if (!response.ok) {
      throw new Error("Failed to update user details")
    }
  }

  if (!isOpen) return null

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target
    setFormData((prev: any) => {
      if (name.includes(".")) {
        const [parent, child] = name.split(".")
        return { ...prev, [parent]: { ...prev[parent], [child]: value } }
      }
      return { ...prev, [name]: value }
    })
  }

  const handleNext = () => setCurrentStep((prev) => Math.min(prev + 1, steps.length - 1))
  const handleBack = () => setCurrentStep((prev) => Math.max(prev - 1, 0))

  const progressPercentage = ((currentStep + 1) / steps.length) * 100

  const handleMaterialChange = (index: number, field: "name" | "weight", value: string | number) => {
    setFormData((prev) => {
      const newMaterials = [...prev.materials]
      newMaterials[index] = { ...newMaterials[index], [field]: value }
      return { ...prev, materials: newMaterials }
    })
  }

  const addMaterial = () => {
    setFormData((prev) => ({
      ...prev,
      materials: [...prev.materials, { name: "", weight: "" }],
    }))
  }

  const removeMaterial = (index: number) => {
    setFormData((prev) => ({
      ...prev,
      materials: prev.materials.filter((_, i) => i !== index),
    }))
  }

  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      exit={{ opacity: 0 }}
      className="fixed inset-0 bg-black bg-opacity-70 z-40 flex items-center justify-center"
    >
      <motion.div
        initial={{ scale: 0.9, y: 20 }}
        animate={{ scale: 1, y: 0 }}
        exit={{ scale: 0.9, y: 20 }}
        transition={{ type: "spring", damping: 15 }}
        className={`bg-white p-6 rounded-lg shadow-lg ${!showBill ? "max-w-5xl" : "max-w-7xl"} w-full max-h-[700px] overflow-y-auto thin-scrollbar`}
      >
        <div className="flex justify-between items-center mb-4">
          <h1 className="font-semibold text-xl text-black">Bilty Details</h1>
          <Button variant="ghost" size="icon" onClick={onClose}>
            <X />
          </Button>
        </div>

        {!showBill ? (
          <div className="w-full bg-gray-200 rounded-full h-2.5 mb-4">
            <motion.div
              className="bg-lightOrange h-2.5 rounded-full"
              initial={{ width: 0 }}
              animate={{ width: `${progressPercentage}%` }}
              transition={{ duration: 0.3 }}
            />
          </div>
        ) : (
          <div className="flex items-start gap-16 mb-4"></div>
        )}
        {!showBill ? (
          <form onSubmit={(e) => e.preventDefault()}>
            <AnimatePresence mode="wait">
              <motion.div
                key={currentStep}
                initial={{ x: 300, opacity: 0 }}
                animate={{ x: 0, opacity: 1 }}
                exit={{ x: -300, opacity: 0 }}
                transition={{ type: "spring", stiffness: 300, damping: 30 }}
              >
                <h2 className="text-lg font-semibold text-black mt-2 mb-4">{steps[currentStep].title}</h2>

                {currentStep === 0 && (
                  <>
                    <div className="grid grid-cols-2 gap-2">
                      {(steps[currentStep].fields as (keyof EWBFormDataType)[]).map((field) => (
                        <div key={field} className="mb-1">
                          <label htmlFor={field} className="text-xs text-gray-500">
                            {placeholders[field]}
                          </label>
                          <Input
                            id={field}
                            name={field}
                            value={formData[field] as string}
                            onChange={handleInputChange}
                            className="mt-[1px]"
                          />
                        </div>
                      ))}
                    </div>
                  </>
                )}

                {currentStep === 1 && (
                  <>
                    <div className="mb-4">
                      <Label htmlFor="date">Date</Label>
                      <input
                        id="date"
                        name="date"
                        type="date"
                        value={new Date(formData.date).toISOString().split("T")[0]}
                        onClick={(e) => (e.target as HTMLInputElement).showPicker()}
                        onChange={handleInputChange}
                        className="mt-1"
                      />
                    </div>
                    <div className="mb-4">
                      <Label htmlFor="LR">LR</Label>
                      <Input
                        id="LR"
                        name="LR"
                        value={formData.LR}
                        onChange={handleInputChange}
                        className="mt-1"
                        placeholder="LR"
                      />
                    </div>
                    {/* Add From and To fields */}
                    <div className="grid grid-cols-2 gap-4 mb-4">
                      <div>
                        <Label htmlFor="from">From</Label>
                        <Input
                          id="from"
                          name="from"
                          value={formData.from}
                          onChange={handleInputChange}
                          className="mt-1"
                          placeholder={placeholders["from"]}
                        />
                      </div>
                      <div>
                        <Label htmlFor="to">To</Label>
                        <Input
                          id="to"
                          name="to"
                          value={formData.to}
                          onChange={handleInputChange}
                          className="mt-1"
                          placeholder={placeholders["to"]}
                        />
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <h3 className="font-semibold mb-2">Consigner Details</h3>
                        {Object.keys(formData.consigner).map((field) => (
                          <div key={field} className="mb-1">
                            <label htmlFor={`consigner.${field}`} className="text-xs text-gray-500">
                              {placeholders[field]}
                            </label>
                            <Input
                              id={`consigner.${field}`}
                              name={`consigner.${field}`}
                              value={formData.consigner[field as keyof ConsignerConsigneeType]}
                              onChange={handleInputChange}
                              className="mt-[1px]"
                            />
                          </div>
                        ))}
                      </div>
                      <div>
                        <h3 className="font-semibold mb-2">Consignee Details</h3>
                        {Object.keys(formData.consignee).map((field) => (
                          <div key={field} className="mb-1">
                            <label htmlFor={`consignee.${field}`} className="text-xs text-gray-500">
                              {placeholders[field]}
                            </label>
                            <Input
                              id={`consignee.${field}`}
                              name={`consignee.${field}`}
                              value={formData.consignee[field as keyof ConsignerConsigneeType]}
                              onChange={handleInputChange}
                              className="mt-[1px]"
                            />
                          </div>
                        ))}
                      </div>
                    </div>
                  </>
                )}

                {currentStep === 2 && (
                  <>
                    <div className="mb-4">
                      <Label>Materials</Label>
                      {formData.materials.map((material, index) => (
                        <div key={index} className="flex items-center space-x-2 mb-2">
                          <Input
                            name={`materials[${index}].name`}
                            value={material.name}
                            onChange={(e) => handleMaterialChange(index, "name", e.target.value)}
                            placeholder="Material name"
                          />
                          <Input
                            type="text"
                            name={`materials[${index}].weight`}
                            value={material.weight}
                            onChange={(e) => handleMaterialChange(index, "weight", e.target.value)}
                            placeholder="Weight"
                          />
                          <Button type="button" variant="outline" size="sm" onClick={() => removeMaterial(index)}>
                            Remove
                          </Button>
                        </div>
                      ))}
                      <Button type="button" variant="outline" onClick={addMaterial} className="mt-2">
                        Add Material
                      </Button>
                    </div>
                    <div className="mb-4">
                      <Label htmlFor="guaranteedWeight">Guaranteed Weight</Label>
                      <Input
                        id="guaranteedWeight"
                        name="grtdWeight"
                        type="text"
                        value={formData.grtdWeight}
                        onChange={handleInputChange}
                        className="mt-1"
                        placeholder="Guaranteed Weight"
                      />
                    </div>
                    <div>
                      <Label htmlFor="unit">Unit</Label>
                      <Input
                        id="unit"
                        name="unit"
                        type="number"
                        value={formData.unit}
                        onChange={handleInputChange}
                        className="mt-1"
                        placeholder="Unit"
                      />
                    </div>
                    <div className="my-4">
                      <Label>Freight Amount paid by</Label>
                      <RadioGroup
                        value={formData.paidBy}
                        onValueChange={(value) =>
                          setFormData((prev) => ({ ...prev, paidBy: value as "consigner" | "consignee" | "agent" }))
                        }
                        className="flex space-x-4 mt-2"
                      >
                        <div className="flex items-center space-x-2">
                          <RadioGroupItem value="consigner" id="consigner" />
                          <Label htmlFor="consigner">Consigner</Label>
                        </div>
                        <div className="flex items-center space-x-2">
                          <RadioGroupItem value="consignee" id="consignee" />
                          <Label htmlFor="consignee">Consignee</Label>
                        </div>
                        <div className="flex items-center space-x-2">
                          <RadioGroupItem value="agent" id="agent" />
                          <Label htmlFor="agent">Agent</Label>
                        </div>
                      </RadioGroup>
                    </div>
                  </>
                )}

                {currentStep === 3 && (
                  <>
                    <div className="mb-4">
                      <label htmlFor="ewayBillNo">E-Way Bill No.</label>
                      <Input
                        id="ewayBillNo"
                        name="ewayBillNo"
                        value={formData.ewayBillNo}
                        onChange={handleInputChange}
                        className="mt-1"
                        placeholder={placeholders["ewayBillNo"]}
                      />
                    </div>
                    <div className="mb-4">
                      <label htmlFor="invoiceNo">Goods Invoice No.</label>
                      <Input
                        id="invoiceNo"
                        name="invoiceNo"
                        value={formData.invoiceNo}
                        onChange={handleInputChange}
                        className="mt-1"
                        placeholder={placeholders["invoiceNo"]}
                      />
                    </div>
                    <div className="mb-4">
                      <label htmlFor="value">Value</label>
                      <Input
                        id="value"
                        name="value"
                        value={formData.value}
                        placeholder="As Per Invoice"
                        className="mt-1"
                        onChange={handleInputChange}
                      />
                    </div>
                  </>
                )}

                <div className="flex justify-between mt-6">
                  {currentStep > 0 && (
                    <Button variant="outline" onClick={handleBack}>
                      Back
                    </Button>
                  )}
                  {currentStep < steps.length - 1 ? (
                    <Button onClick={handleNext}>Next</Button>
                  ) : (
                    <Button onClick={() => setShowBill(true)}>Generate</Button>
                  )}
                </div>
              </motion.div>
            </AnimatePresence>
          </form>
        ) : (
          <div className="w-full">
            {showBill && (
              <div className="sticky bottom-0 left-0 right-0 bg-white p-4 border-b border-gray-200">
                <div className="flex justify-between max-w-5xl mx-auto">
                  <Button variant="outline" onClick={() => setShowBill(false)}>
                    Edit Form
                  </Button>
                  <Button disabled={pdfDownloading} onClick={() => downloadAllPDFs()}>
                    {pdfDownloading ? <Loader2 className="text-white animate-spin" /> : "Download as PDF"}
                  </Button>
                </div>
              </div>
            )}
            {/* Visible preview for users */}
<div ref={billRef} className="pb-4">
  {tabs.map((tab) => (
    <div key={tab} id={`bilty-${tab}`} className="my-10">
      <Bilty formData={formData} color={biltyColor(tab) as string} selectedCopy={tab} />
    </div>
  ))}
</div>

{/* Hidden container for PDF generation */}
<div style={{ position: 'fixed', top: '-10000px', left: '-10000px', height: 0, overflow: 'hidden' }}>
  {tabs.map((tab) => (
    <div key={tab} id={`pdf-bilty-${tab}`} className="my-10">
      <Bilty
        formData={formData}
        color={biltyColor(tab) as string}
        selectedCopy={tab}
        isPdfExport={true}
      />
    </div>
  ))}
</div>

          </div>
        )}
      </motion.div>
    </motion.div>
  )
}
</file>

<file path="src/components/trip/tripDetail/ChargeModal.tsx">
import { Button } from '@/components/ui/button';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { ITrip } from '@/utils/interface';
import { statuses } from '@/utils/schema';
import { motion } from 'framer-motion';
import React, { useState, useMemo, useEffect } from 'react';

interface ChargeModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSave: any;
  trips?: ITrip[]
}

const chargeType = [
  'Detention/Halting Charges',
  'Repair Expense',
  'Loading Charges',
  'Unloading Charges',
  'Union Charges',
  'Weight Charges',
  'Other Charges'
];

const deductionType = [
  'Material Loss',
  'Brokerage',
  'Late Fees',
  'TDS',
  'Mamul',
  'Other'
];

interface TripExpense {
  trip_id: string;
  partyBill: boolean;
  amount: number;
  date: string;
  expenseType: string;
  notes?: string;
}

const ChargeModal: React.FC<ChargeModalProps> = ({ isOpen, onClose, onSave, trips }) => {
  const [formData, setFormData] = useState<TripExpense>({
    trip_id: '',
    partyBill: true,
    amount: 0,
    date: new Date(Date.now()).toISOString(),
    expenseType: '',
    notes: '',
  });


  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement> | string, selectName?: string) => {
    if (typeof e === 'string' && selectName) {
      setFormData({ ...formData, [selectName]: e });
    } else if (typeof e !== 'string') {
      const { name, value, type } = e.target;
      setFormData({ ...formData, [name]: type === 'checkbox' ? !formData.partyBill : value });
    }
  };

  const handleSave = () => {
    onSave(formData);
    onClose();
  };

  const handleFocus = (e: React.FocusEvent<HTMLInputElement>) => {
    if (e.target.value === '0') {
      handleChange({ target: { name: e.target.name, value: '' } } as React.ChangeEvent<HTMLInputElement>);
    }
  };

  if (!isOpen) return null;

  return (
    <>
      <div className="modal-class"></div>
      <motion.div
        initial={{ opacity: 0, scale: 0.5 }}
        animate={{ opacity: 1, scale: 1 }}
        transition={{
          duration: 0.5,
          ease: [0, 0.71, 0.2, 1.01]
        }} className="fixed inset-0 flex items-center justify-center z-50">
        <div className="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl">
          <h2 className="text-xl font-semibold mb-4">Add New Charge</h2>
          {trips && trips?.length > 0 &&
            <div className="mb-4">
              <label className="block text-sm text-gray-700">Trip*</label>
              <Select 
                name="trip_id" 
                value={formData.trip_id} 
                onValueChange={(value) => handleChange(value, 'trip_id')}
              >
                <SelectTrigger className="w-full">
                  <SelectValue placeholder="Select Trip" />
                </SelectTrigger>
                <SelectContent>
                  {trips.map((trip) => (
                    <SelectItem key={trip.trip_id} value={trip.trip_id}>
                      <div className="flex items-center justify-between w-full p-2 space-x-4">

                        {/* Display route origin to destination */}
                        <span className="font-semibold text-gray-700 whitespace-nowrap">
                          {trip.route.origin.split(',')[0]} &rarr; {trip.route.destination.split(',')[0]}
                        </span>

                        {/* Status indicator with progress bar */}
                        <div className="flex flex-col w-1/2 space-y-1">
                          {/* Status label */}
                          <span className="text-sm text-gray-600">
                            {statuses[trip.status as number]}
                          </span>

                          {/* Progress bar for status */}
                          <div className="relative w-full h-1 bg-gray-200 rounded">
                            <div
                              className={`absolute top-0 left-0 h-1 rounded transition-width duration-500 ${trip.status === 0
                                ? 'bg-red-500'
                                : trip.status === 1
                                  ? 'bg-yellow-500'
                                  : trip.status === 2
                                    ? 'bg-blue-500'
                                    : trip.status === 3
                                      ? 'bg-green-500'
                                      : 'bg-green-800'
                                }`}
                              style={{ width: `${(trip.status as number / 4) * 100}%` }}
                            />
                          </div>
                        </div>

                        {/* LR number */}
                        <span className="text-sm text-gray-600 whitespace-nowrap">
                          {trip.LR}
                        </span>

                        {/* Start date */}
                        <span className="text-sm text-gray-600 whitespace-nowrap">
                          {new Date(trip.startDate).toISOString().split('T')[0]}
                        </span>

                      </div>
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          }

          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700">Add to Party Bill</label>
            <input
              type="checkbox"
              name="partyBill"
              checked={formData.partyBill}
              onChange={handleChange}
              className="p-2 border border-gray-300 rounded-md"
            />
          </div>
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700">Expense Type</label>
            <div className="relative">
              <select
                name="expenseType"
                value={formData.expenseType}
                onChange={handleChange}
                className="w-full p-2 border border-gray-300 rounded-md appearance-none"
              >
                <option value="">Select Expense Type</option>
                {formData.partyBill
                  ? chargeType.map((type) => (
                    <option key={type} value={type}>
                      {type}
                    </option>
                  ))
                  : deductionType.map((type) => (
                    <option key={type} value={type}>
                      {type}
                    </option>
                  ))}
              </select>
              <div className="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                <svg
                  className="h-4 w-4 fill-current text-gray-400"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 20 20"
                >
                  <path d="M10 12a2 2 0 1 0 0-4 2 2 0 0 0 0 4zM2 10a8 8 0 1 1 16 0 8 8 0 0 1-16 0z" />
                </svg>
              </div>
            </div>
          </div>
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700">Amount</label>
            <input
              type="number"
              name="amount"
              value={formData.amount}
              onChange={handleChange}
              onFocus={handleFocus}
              className="w-full p-2 border border-gray-300 rounded-md"
            />
          </div>
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700">Date</label>
    <input
              type="date"
              name="date"
              onClick={(e) => (e.target as HTMLInputElement).showPicker()}
              value={new Date(formData.date).toISOString().split('T')[0]}
              onChange={handleChange}
              className="w-full p-2 border border-gray-300 rounded-md"
            />
          </div>
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700">Notes</label>
            <textarea
              name="notes"
              value={formData.notes}
              onChange={handleChange}
              className="w-full p-2 border border-gray-300 rounded-md"
            />
          </div>
          <div className="flex justify-end gap-2">
            <Button variant='outline' onClick={onClose} >
              Cancel
            </Button>
            <Button onClick={handleSave} >
              Save
            </Button>
          </div>
        </div>
      </motion.div>
    </>
  );
};

export default ChargeModal;
</file>

<file path="src/components/trip/tripDetail/EwayBillUpload.tsx">
import { Button } from '@/components/ui/button';
import Image from 'next/image';
import Link from 'next/link';
import React, { useState, useRef, useEffect } from 'react';
import { Page, Text, View, Document, StyleSheet } from '@react-pdf/renderer';

interface EWayBillUploadProps {
  tripId: string;
  ewayBillUrl?: string;
  validity?: Date | null;
  setEwayBillUrl: (url: string) => void;
}

const EWayBillUpload: React.FC<EWayBillUploadProps> = ({ tripId, ewayBillUrl, setEwayBillUrl, validity }) => {
  const [isUploading, setIsUploading] = useState(false);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [selectedFile, setSelectedFile] = useState<File | null>(null);
  const [ewbValidityDate, setEwbValidityDate] = useState<string | null>(null);
  const [showManualDateInput, setShowManualDateInput] = useState(false);
  const fileInputRef = useRef<HTMLInputElement | null>(null);

  useEffect(() => {
    if (validity) {
      setEwbValidityDate(new Date(validity).toISOString().split('T')[0]);
    }
  }, [validity]);

  const handleFileChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (file) {
      setSelectedFile(file);
      setShowManualDateInput(false); // Reset manual date input if a new file is selected
    }
  };

  const handleSubmit = async () => {
    if (selectedFile || ewbValidityDate) {
      setIsUploading(true);
      try {
        const formData = new FormData();
        if (selectedFile) {
          formData.append('file', selectedFile);
        }
        formData.append('tripId', tripId);
        if (ewbValidityDate) {
          formData.append('ewbValidityDate', ewbValidityDate);
        }

        const response = await fetch(`/api/s3Upload`, {
          method: 'POST',
          body: formData,
        });

        const data = await response.json();

        if (response.ok) {
          setEwayBillUrl(data.fileUrl);

          if (data.ewbValidityDate) {
            setEwbValidityDate(data.ewbValidityDate);
            setShowManualDateInput(false); // No need for manual input if date is extracted
          } else if (!ewbValidityDate) {
            setShowManualDateInput(true);
            alert(data.message || 'Failed to extract validity date. Please enter it manually.');
          }
        } else {
          alert('Failed to upload e-way bill');
        }
      } catch (error) {
        console.error('Error uploading e-way bill:', error);
        alert('Error uploading e-way bill');
      } finally {
        setIsUploading(false);
        setSelectedFile(null);
      }
    }
  };

  const handleImageClick = () => {
    setIsModalOpen(true);
  };

  const handleCloseModal = () => {
    setIsModalOpen(false);
  };

  return (
    <div className="p-6 border rounded-lg border-lightOrange shadow-lg bg-white w-full hover:shadow-lightOrangeButtonColor transition-shadow duration-300 relative">
      <h3 className="text-lg font-semibold">E-Way Bill</h3>
      {ewayBillUrl ? (
        <div className="mt-4">
          <div className="relative flex-col space-y-2">
            {ewayBillUrl.endsWith('.pdf') ?
              <Button variant={'link'}><Link href={ewayBillUrl.split('.pdf')[0]} >View PDF</Link></Button> :
              <>
                <Image
                  src={ewayBillUrl}
                  alt="e-way bill"
                  height={100}
                  width={100}
                  className="cursor-pointer transition-transform transform duration-300 ease-out hover:scale-105"
                  onClick={handleImageClick}
                />
              </>}
            <input
              type="file"
              accept=".pdf,.jpg,.png"
              onChange={handleFileChange}
              disabled={isUploading}
              className="w-full text-sm text-gray-700 file:bg-lightOrangeButtonColor file:border-none file:rounded-lg file:px-4 file:py-2 file:cursor-pointer hover:file:bg-darkOrangeButtonColor mt-2"
            />



          </div>
        </div>
      ) : (
        <div className="mt-4">
          <input
            type="file"
            accept=".pdf,.jpg,.png"
            onChange={handleFileChange}
            disabled={isUploading}
          />
        </div>
      )}

      {ewbValidityDate && !showManualDateInput && (
        <div className="mt-4">
          <label htmlFor="ewbValidityDate" className="block text-sm font-medium text-gray-700">
            Validity Date:
          </label>
          <input
            type="text"
            id="ewbValidityDate"
            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
            value={ewbValidityDate}
            readOnly
          />
        </div>
      )}

      {showManualDateInput && (
        <div className="mt-4">
          <label htmlFor="ewbValidityDate" className="block text-sm font-medium text-gray-700">
            Enter Validity Date (YYYY-MM-DD):
          </label>
          <input
            type="date"
            id="ewbValidityDate"
            onClick={(e) => (e.target as HTMLInputElement).showPicker()}
            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
            value={ewbValidityDate || ''}
            onChange={(e) => setEwbValidityDate(e.target.value)}
          />
        </div>
      )}
      <Button
        onClick={handleSubmit}
        disabled={isUploading || (!selectedFile && !ewbValidityDate)}
        className="mt-4"
      >
        {isUploading ? 'Uploading...' : 'Submit E-Way Bill'}
      </Button>

      {isModalOpen && (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-50">
          <div className="p-4 rounded-lg shadow-lg flex-col space-y-1 bg-lightOrangeButtonColor">

            <Image
              src={ewayBillUrl || ""}
              alt="E-Way Bill Large View"
              height={500}
              width={500}
              className="max-w-full h-auto"
            />
            <Button
              onClick={handleCloseModal}
              className='w-full'
            >
              Close
            </Button>
          </div>
        </div>
      )}
    </div>
  );
};

export default EWayBillUpload;
</file>

<file path="src/components/trip/tripDetail/ExpenseModal.tsx">
'use client'
import React, { useEffect, useState } from 'react';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Button } from '@/components/ui/button';
import { fuelAndDriverChargeTypes, maintenanceChargeTypes } from '@/utils/utilArray';
import { IDriver, IExpense, ITrip, TruckModel } from '@/utils/interface';
import DriverSelect from '../DriverSelect';
import { motion } from 'framer-motion';
import { usePathname } from 'next/navigation';
import { statuses } from '@/utils/schema';
import ShopSelect from '@/components/shopkhata/ShopSelect';

interface ChargeModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSave: any;
  driverId: string;
  selected?: any;
  truckPage?: boolean;
}

interface TripExpense {
  id?: string;
  trip: string;
  partyBill: boolean;
  amount: number;
  date: Date;
  expenseType: string;
  notes?: string;
  partyAmount: number;
  paymentMode: string;
  transactionId: string;
  driver: string;
  truck?: string
  shop_id?: string
}

const ExpenseModal: React.FC<ChargeModalProps> = ({ isOpen, onClose, onSave, driverId, selected, truckPage }) => {
  const [formData, setFormData] = useState<TripExpense>({
    id: selected?._id || undefined,
    trip: selected?.trip_id || '',
    partyBill: false,
    amount: selected?.amount || 0,
    date: selected?.date ? new Date(selected.date) : new Date(),
    expenseType: selected?.expenseType || '',
    notes: selected?.notes || '',
    partyAmount: 0,
    paymentMode: selected?.paymentMode || 'Cash',
    transactionId: selected?.transaction_id || '',
    driver: driverId || '',
    truck: selected?.truck || '',
    shop_id: selected?.shop_id || ''
  });

  const pathname = usePathname()

  const [driverName, setDriverName] = useState('');
  const [selectedCategory, setSelectedCategory] = useState('Fuel & Driver');
  const [drivers, setDrivers] = useState<IDriver[]>([]);
  const [trucks, setTrucks] = useState<TruckModel[]>([])
  const [trips, setTrips] = useState<ITrip[]>([])
  const [trip, setTrip] = useState<ITrip>()
  const [shops, setShops] = useState<any[]>([])
  const modalRef = React.useRef<HTMLDivElement>(null);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (modalRef.current && !modalRef.current.contains(event.target as Node)) {
        onClose(); // Close modal if clicked outside
      }
    };

    if (isOpen) {
      document.addEventListener('mousedown', handleClickOutside);
    }

    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [isOpen, onClose]);


  useEffect(() => {
    if (!selected) return;
    setFormData({
      id: selected?._id || undefined,
      trip: selected?.trip_id || '',
      partyBill: false,
      amount: selected?.amount || 0,
      date: selected?.date ? new Date(selected.date) : new Date(),
      expenseType: selected?.expenseType || '',
      notes: selected?.notes || '',
      partyAmount: 0,
      paymentMode: selected?.paymentMode || 'Cash',
      transactionId: selected?.transaction_id || '',
      driver: selected?.driver || '',
      truck: selected?.truck || '',
      shop_id: selected?.shop_id || ''
    });
  }, [selected]);

  const fetchshops = async () => {
    const res = await fetch(`/api/shopkhata`)
    const data = await res.json()
    setShops(data.shops)
  }

  useEffect(() => {
    if (formData.paymentMode === 'Credit') {
      fetchshops()
    }
  }, [formData.paymentMode])

  useEffect(() => {
    const fetchDriverName = async () => {
      const result = await fetch(`/api/drivers/${driverId || trip?.driver}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
      });
      const data = await result.json();
      setDriverName(data.name || 'Driver Not Found');
    };
    if (formData.paymentMode === 'Paid By Driver') fetchDriverName();

    const fetchDrivers = async () => {
      const res = await fetch(`/api/drivers`);
      const data = await res.json();
      setDrivers(data.drivers);
    };

    fetchDrivers();
  }, [formData.paymentMode, driverId]);

  const fetchTripsTrucks = async () => {
    try {
      const [tripRes, truckRes] = await Promise.all([
        fetch(`/api/trips/expenses`),
        fetch(`/api/trucks/create`)
      ])

      const [tripData, truckData] = await Promise.all([
        tripRes.ok ? tripRes.json() : [],
        truckRes.ok ? truckRes.json() : []
      ])
      setTrips(tripData.trips)
      setTrucks(truckData.trucks)

    } catch (error: any) {
      console.error('Error fetching data:', error);
      alert(error.message);
    }
  }

  useEffect(() => {
    if (pathname.includes('/expenses')) {
      fetchTripsTrucks()
    }
  }, [pathname])

  useEffect(() => {
    if (formData.paymentMode === 'Paid By Driver' && trip) {
      setFormData((prevData) => ({ ...prevData, driver: trip.driver }));
    }
  }, [trip, formData.paymentMode])

  const handleSelectChange = (name: string, value: string) => {
    setFormData((prevData) => {
      let updatedData = { ...prevData, [name]: value };

      if (name === 'trip') {
        const selectedTrip = trips.find(trip => trip.trip_id === value);
        if (selectedTrip) {
          setTrip(selectedTrip)
          updatedData = { ...updatedData, truck: selectedTrip.truck };
        }
      }

      return updatedData;
    });
  };


  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => {
    const { name, value, type } = e.target;
    setFormData({ ...formData, [name]: type === 'checkbox' ? !formData.partyBill : value });
  };

  const handleSave = () => {
    if (formData.paymentMode === 'Paid By Driver') {
      setFormData((prev) => ({ ...prev, driver: driverId }));
    }
    if (selected) {
      onSave(formData, selected._id);
    } else {
      onSave(formData);
    }

    onClose();
  };

  const handleFocus = (e: React.FocusEvent<HTMLInputElement>) => {
    if (e.target.value === '0') {
      handleChange({ target: { name: e.target.name, value: '' } } as React.ChangeEvent<HTMLInputElement>);
    }
  };

  const chargeTypes = selectedCategory === 'Fuel & Driver' ? Array.from(fuelAndDriverChargeTypes) : Array.from(maintenanceChargeTypes);

  if (!isOpen) return null;

  return (
    <div
      className="fixed inset-0 bg-black bg-opacity-50 z-40"
    >
      <div className="fixed inset-0 flex items-center justify-center z-50">
        <motion.div
          initial={{ opacity: 0, scale: 0.5 }}
          animate={{ opacity: 1, scale: 1 }}
          transition={{
            duration: 0.5,
            ease: [0, 0.71, 0.2, 1.01]
          }}
          className="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl"
          ref={modalRef}
        >
          <h2 className="text-xl font-semibold mb-4">Add New Charge</h2>

          <div className="flex space-x-4 mb-4 border-b-2 border-gray-200">
            <Button
              variant="link"
              onClick={() => setSelectedCategory('Fuel & Driver')}
              className={`px-4 py-2 transition duration-300 ease-in-out ${selectedCategory === 'Fuel & Driver'
                ? 'border-b-2 border-bottomNavBarColor text-bottomNavBarColor'
                : 'border-transparent text-gray-600 hover:text-bottomNavBarColor hover:border-bottomNavBarColor'
                }`}
            >
              Fuel & Driver
            </Button>
            {truckPage || pathname.includes('/expenses') && (
              <Button
                variant="link"
                onClick={() => setSelectedCategory('Maintenance')}
                className={`px-4 py-2 transition duration-300 ease-in-out ${selectedCategory === 'Maintenance'
                  ? 'border-b-2 border-bottomNavBarColor text-bottomNavBarColor'
                  : 'border-transparent text-gray-600 hover:text-bottomNavBarColor hover:border-bottomNavBarColor'
                  }`}
              >
                Maintenance
              </Button>
            )}
          </div>

          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700">Expense Type</label>
            <Select value={formData.expenseType} onValueChange={(value) => handleSelectChange('expenseType', value)}>
              <SelectTrigger className="w-full">
                <SelectValue>{formData.expenseType || 'Select Expense Type'}</SelectValue>
              </SelectTrigger>
              <SelectContent>
                {chargeTypes.map((type) => (
                  <SelectItem key={type} value={type}>{type}</SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
          <div className='flex items-center space-x-2 '>
            <div className="mb-4 w-1/2">
              <label className="block text-sm font-medium text-gray-700">Amount</label>
              <input
                type="number"
                name="amount"
                value={formData.amount}
                onChange={handleChange}
                onFocus={handleFocus}
                className="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>

            <div className="mb-4 w-1/2">
              <label className="block text-sm font-medium text-gray-700">Date</label>
              <input
                type="date"
                name="date"
                onClick={(e) => (e.target as HTMLInputElement).showPicker()}
                value={formData.date.toISOString().split('T')[0]}
                onChange={handleChange}
                className="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
          </div>

          {pathname.includes('/expenses') && !selected && <div className='flex items-center space-x-2 '>
            <div className="mb-4 w-1/2">
              <label className="block text-sm font-medium text-gray-700">Select Trip</label>
              <Select value={formData.trip} onValueChange={(value) => handleSelectChange('trip', value)}>
                <SelectTrigger className="w-full">
                  <SelectValue placeholder='Select Trip' />
                </SelectTrigger>
                <SelectContent>
                  {trips.map((trip: ITrip) => (
                    <SelectItem key={trip.trip_id} value={trip.trip_id}>
                      <div className='flex items-center space-x-2 w-full'>
                        <span className='font-semibold w-1/2'>{trip.route.origin.split(',')[0]} &rarr; {trip.route.destination.split(',')[0]}</span>
                        <div className="flex flex-col items-center space-x-2 w-1/2">
                          <span>{statuses[trip.status as number]}</span>
                          <div className="relative w-full bg-gray-200 h-1 rounded">
                            <div
                              className={`absolute top-0 left-0 h-1 rounded transition-width duration-500 ${trip.status === 0 ? 'bg-red-500' : trip.status === 1 ? 'bg-yellow-500' : trip.status === 2 ? 'bg-blue-500' : trip.status === 3 ? 'bg-green-500' : 'bg-green-800'}`}
                              style={{ width: `${(trip.status as number / 4) * 100}%` }}
                            ></div>
                          </div>
                        </div>
                      </div>
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <div className="mb-4 w-1/2">
              <label className="block text-sm font-medium text-gray-700">Select Truck</label>
              <Select value={formData.truck} onValueChange={(value) => handleSelectChange('truck', value)}>
                <SelectTrigger className="w-full text-black" value={formData.truck}>
                  <SelectValue placeholder='Select Truck' />
                </SelectTrigger>
                <SelectContent>
                  {trucks.map((truck) => (
                    <SelectItem key={truck.truckNo} value={truck.truckNo}>
                      <span>{truck.truckNo}</span>
                      <span
                        className={`ml-2 p-1 rounded ${truck.status === 'Available' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}
                      >
                        {truck.status}
                      </span>
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          </div>}

          <label className="block text-sm font-medium text-gray-700">Payment Mode</label>
          <div className="flex flex-row w-full justify-start gap-3 mb-3">
            {['Cash', 'Paid By Driver', 'Online', 'Credit'].map((type) => (
              <button
                key={type}
                type="button"
                className={`p-2 rounded-md ${formData.paymentMode === type ? 'bg-bottomNavBarColor text-white' : 'bg-lightOrangeButtonColor text-black'}`}
                onClick={() => handleChange({ target: { name: 'paymentMode', value: type } } as React.ChangeEvent<HTMLInputElement | HTMLSelectElement>)}
              >
                {type}
              </button>
            ))}
          </div>

          {formData.paymentMode === 'Paid By Driver' && !truckPage && (
            <div className="mb-4">
              <button disabled className="block text-sm font-medium text-gray-700 border border-black rounded-md p-2 w-1/3">
                {driverName}
              </button>
            </div>
          )}

          {formData.paymentMode === 'Paid By Driver' && truckPage && (
            <DriverSelect
              drivers={drivers}
              formData={formData}
              handleChange={handleChange}
              setFormData={setFormData}
            />
          )}

          {formData.paymentMode === 'Online' && (
            <div className="mb-4">
              <input
                type="text"
                name="transactionId"
                value={formData.transactionId}
                onChange={handleChange}
                className="w-full p-2 border border-gray-300 rounded-md"
                placeholder="Transaction ID"
              />
            </div>
          )}

          {formData.paymentMode === 'Credit' && (
            <ShopSelect
              shops={shops} // Pass the shops array as a prop
              formData={formData}
              handleChange={handleChange}
              setFormData={setFormData}
            />
          )}

          {(formData.expenseType !== 'Fuel Expense' && !selected && !truckPage && !pathname.includes('expenses')) && (
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700">Add to Party Bill</label>
              <input
                type="checkbox"
                name="partyBill"
                checked={formData.partyBill}
                onChange={handleChange}
                className="p-2 border border-gray-300 rounded-md"
              />
            </div>
          )}

          {formData.partyBill && (
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700">Party Amount</label>
              <input
                type="number"
                name="partyAmount"
                value={formData.partyAmount}
                onChange={handleChange}
                onFocus={handleFocus}
                className="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
          )}

          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700">Notes</label>
            <textarea
              name="notes"
              value={formData.notes}
              onChange={handleChange}
              className="w-full p-2 border border-gray-300 rounded-md"
            />
          </div>

          <div className="flex justify-end gap-2">
            <Button variant="outline" onClick={onClose}>
              Cancel
            </Button>
            <Button onClick={handleSave}>
              Save
            </Button>
          </div>
        </motion.div>
      </div>
    </div>
  );
};

export default ExpenseModal;
</file>

<file path="src/components/trip/tripDetail/Modal.tsx">
import React, { useEffect, useState } from 'react';
import { PaymentBook } from '@/utils/interface';
import { Button } from '@/components/ui/button';
import { motion } from 'framer-motion';
import { useTrip } from '@/context/tripContext';
import { useToast } from '@/components/hooks/use-toast';

interface ModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSave: (data: {
    id: string | undefined
    accountType: string;
    amount: number;
    paymentType: 'Cash' | 'Cheque' | 'Online Transfer';
    receivedByDriver: boolean;
    date: Date; // Ensure date is of type Date
    notes?: string;
  }) => void;
  modalTitle: string;
  accountType: string;
  editData?: PaymentBook | any;
}

const paymentTypes = ['Cash', 'Cheque', 'Online Transfer', 'Bank Transfer', 'UPI', 'Fuel', 'Others']

const Modal: React.FC<ModalProps> = ({
  isOpen,
  onClose,
  onSave,
  modalTitle,
  accountType,
  editData,
}) => {
  const [formState, setFormState] = useState({
    amount: editData?.amount || 0,
    paymentType: editData?.paymentType || 'Cash' as string,
    receivedByDriver: editData?.driver_id ? true : false,
    date: new Date(editData?.date || Date.now()).toISOString().split('T')[0],
    notes: editData?.notes || ''
  });

  const {trip, setTrip} = useTrip()
  const {toast} = useToast()

  useEffect(() => {
    if (editData) {
      const formattedDate = (editData.date instanceof Date)
        ? editData.date.toISOString().split('T')[0]
        : (editData.date && !isNaN(new Date(editData.date).getTime()))
          ? new Date(editData.date).toISOString().split('T')[0]
          : '';
      setFormState({
        amount: editData.amount,
        paymentType: editData.paymentType,
        receivedByDriver: editData.driver_id ? true : false,
        date: formattedDate,
        notes: editData.notes || ''
      });
    }
  }, [editData]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement | any>) => {
    const { name, value, type, checked } = e.target;
    setFormState(prevState => ({
      ...prevState,
      [name]: type === 'checkbox' ? checked : value
    }));
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    let pending = trip.balance
    if (editData){
      pending = pending + editData.amount
    }
    if (!formState.amount || formState.amount <=0) {
      toast({
        description : 'Enter Valid Amount',
        variant : 'warning'
      })
      return;
    }
    if(editData && (pending - formState.amount < 0)){
      toast({
        description : 'Payment amount exceeds pending balance',
        variant : 'warning'
      })
      return;
    }
    if(!editData && (formState.amount > trip.balance)){
      toast({
        description : 'Payment amount exceeds pending balance',
        variant : 'warning'
      })
      return;
    }
    onSave({
      id: editData?._id.toString(),
      accountType,
      amount: formState.amount,
      paymentType: formState.paymentType,
      receivedByDriver: formState.receivedByDriver,
      date: new Date(formState.date), // Convert date string to Date object
      notes: formState.notes,
    });
    onClose();
  };

  if (!isOpen) return null;

  return (
    <>
      <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-40 flex items-center justify-center"></div>
      <motion.div
        initial={{ opacity: 0, scale: 0.5 }}
        animate={{ opacity: 1, scale: 1 }}
        transition={{
          duration: 0.5,
          ease: [0, 0.71, 0.2, 1.01]
        }} className="fixed inset-0 z-50 flex items-center justify-center">
        <div className="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
          <h3 className="text-lg font-semibold mb-4">{modalTitle}</h3>
          <form onSubmit={handleSubmit}>
            <div className="mb-4">
              <label className="">Amount</label>
              <input
                type="number"
                name="amount"
                value={formState.amount}
                onChange={handleChange}
                className="mt-1 p-2 w-full border border-gray-300 rounded-md"
                onFocus={(e) => {
                  if (e.target.value === '0') {
                    e.target.value = '';
                  }
                }}
                required
              />
            </div>
            <div className="mb-4">
              <label className="">Payment Type*</label>
              <select
                name="paymentType"
                value={formState.paymentType}
                onChange={handleChange}
                className="mt-1 p-2 w-full border border-gray-300 rounded-md"
                required
              >
                {paymentTypes.map(type=>(
                  <option key={type} value={type}>{type}</option>
                ))}
              </select>
            </div>
            <div className="mb-4 flex items-center">
              <input
                type="checkbox"
                name="receivedByDriver"
                checked={formState.receivedByDriver}
                onChange={handleChange}
                className="mr-2"
              />
              <label className="block text-sm font-medium text-gray-700">Received By Driver</label>
            </div>
            <div className="mb-4">
              <label className="">Payment Date*</label>
              <input
                type="date"
                name="date"
                onClick={(e) => (e.target as HTMLInputElement).showPicker()}
                value={formState.date}
                onChange={handleChange}
                className="mt-1 p-2 w-full border border-gray-300 rounded-md"
                required
              />
            </div>
            <div className="mb-4">
              <label className="">Notes</label>
              <textarea
                name="notes"
                value={formState.notes}
                onChange={handleChange}
                className="mt-1 p-2 w-full border border-gray-300 rounded-md"
              />
            </div>
            <div className="flex justify-end space-x-4">
              <Button variant='outline' type="button" onClick={onClose}>
                Cancel
              </Button>
              <Button type="submit">
                Save
              </Button>
            </div>
          </form>
        </div>
      </motion.div>
    </>
  );
};

export default Modal;
</file>

<file path="src/components/trip/tripDetail/TripFunctions/InvoicePaymentModal.tsx">
import React, { useEffect, useState } from 'react';
import { PaymentBook } from '@/utils/interface';
import { Button } from '@/components/ui/button';
import { motion } from 'framer-motion';
import { useTrip } from '@/context/tripContext';
import { useToast } from '@/components/hooks/use-toast';
import {v4 as uuidV4} from 'uuid'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { statuses } from '@/utils/schema';
import { formatNumber } from '@/utils/utilArray';

interface ModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSave: (data: {
    id: string | undefined
    trip_id : string
    amount: number;
    party_id : string
    paymentType: string;
    receivedByDriver: boolean;
    date: string; // Ensure date is of type Date
    notes?: string;
  }) => void;
  trips : any[]
}

const InvoicePaymentModal: React.FC<ModalProps> = ({
  isOpen,
  onClose,
  onSave,
  trips
}) => {
  const [formState, setFormState] = useState({
    amount:  0,
    trip_id : '',
    paymentType: 'Cash',
    receivedByDriver: false,
    date: new Date(Date.now()).toISOString().split('T')[0],
    notes: ''
  });
  const {toast} = useToast()

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement | any>) => {
    const { name, value, type, checked } = e.target;
    setFormState(prevState => ({
      ...prevState,
      [name]: type === 'checkbox' ? checked : value
    }));
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (!formState.amount || formState.amount <=0) {
      toast({
        description : 'Enter Valid Amount',
        variant : 'warning'
      })

      return;
    }

    if(trips.find(trip=>trip.trip_id === formState.trip_id).balance - formState.amount < 0){
      
      toast({
        description : 'Payment amount exceeds pending balance',
        variant : 'warning'
      })
      return;
    }

    // if(formState.amount > trip.balance){
    //   toast({
    //     description : 'Payment amount exceeds pending balance',
    //     variant : 'warning'
    //   })
    //   return;
    // }
    onSave({
      id: uuidV4(),
      trip_id : formState.trip_id,
      party_id : trips.find((trip)=>trip.trip_id === formState.trip_id).party,
      amount: formState.amount,
      paymentType: formState.paymentType,
      receivedByDriver: formState.receivedByDriver,
      date: new Date(formState.date).toISOString().split('T')[0], // Convert date string to Date object
      notes: formState.notes,
    });
    onClose();
  };

  if (!isOpen) return null;

  return (
    <>
      <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-40 flex items-center justify-center"></div>
      <motion.div
        initial={{ opacity: 0, scale: 0.5 }}
        animate={{ opacity: 1, scale: 1 }}
        transition={{
          duration: 0.5,
          ease: [0, 0.71, 0.2, 1.01]
        }} className="fixed inset-0 z-50 flex items-center justify-center">
        <div className="bg-white p-6 rounded-lg shadow-lg w-full max-w-xl">
          <h3 className="text-lg font-semibold mb-4">Payment</h3>
          <form onSubmit={handleSubmit}>
          {trips && trips?.length > 0 &&
            <div className="mb-4">
              <label className="block text-sm text-gray-700">Trip*</label>
              <Select 
                name="trip_id" 
                value={formState.trip_id} 
                onValueChange={(value) => setFormState((prev)=>({
                    ...prev,
                    trip_id : value
                }))}
              >
                <SelectTrigger className="w-full">
                  <SelectValue placeholder="Select Trip" />
                </SelectTrigger>
                <SelectContent>
                  {trips.map((trip) => (
                    <SelectItem key={trip.trip_id} value={trip.trip_id}>
                      <div className="flex items-center justify-between w-full p-2 space-x-4">

                        {/* Display route origin to destination */}
                        <span className="font-semibold text-gray-700 whitespace-nowrap">
                          {trip.route.origin.split(',')[0]} &rarr; {trip.route.destination.split(',')[0]}
                        </span>

                        {/* Status indicator with progress bar */}
                        <div className="flex flex-col w-1/2 space-y-1">
                          {/* Status label */}
                          <span className="text-sm text-gray-600">
                            {statuses[trip.status as number]}
                          </span>

                          {/* Progress bar for status */}
                          <div className="relative w-full h-1 bg-gray-200 rounded">
                            <div
                              className={`absolute top-0 left-0 h-1 rounded transition-width duration-500 ${trip.status === 0
                                ? 'bg-red-500'
                                : trip.status === 1
                                  ? 'bg-yellow-500'
                                  : trip.status === 2
                                    ? 'bg-blue-500'
                                    : trip.status === 3
                                      ? 'bg-green-500'
                                      : 'bg-green-800'
                                }`}
                              style={{ width: `${(trip.status as number / 4) * 100}%` }}
                            />
                          </div>
                        </div>

                        {/* LR number */}
                        <span className="text-sm text-gray-600 whitespace-nowrap">
                          {trip.LR}
                        </span>

                        {/* Start date */}
                        <span className="text-sm text-gray-600 whitespace-nowrap">
                          {new Date(trip.startDate).toISOString().split('T')[0]}
                        </span>

                        <span className="text-sm text-gray-600 whitespace-nowrap">
                          Balance : {formatNumber(trip.balance)}
                        </span>

                      </div>
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          }
            <div className="mb-4">
              <label className="">Amount</label>
              <input
                type="number"
                name="amount"
                value={formState.amount}
                onChange={handleChange}
                className="mt-1 p-2 w-full border border-gray-300 rounded-md"
                onFocus={(e) => {
                  if (e.target.value === '0') {
                    e.target.value = '';
                  }
                }}
                required
              />
            </div>
            <div className="mb-4">
              <label className="">Payment Type*</label>
              <select
                name="paymentType"
                value={formState.paymentType}
                onChange={handleChange}
                className="mt-1 p-2 w-full border border-gray-300 rounded-md"
                required
              >
                <option value="Cash">Cash</option>
                <option value="Cheque">Cheque</option>
                <option value="Online Transfer">Online Transfer</option>
              </select>
            </div>
            <div className="mb-4 flex items-center">
              <input
                type="checkbox"
                name="receivedByDriver"
                checked={formState.receivedByDriver}
                onChange={handleChange}
                className="mr-2"
              />
              <label className="block text-sm font-medium text-gray-700">Received By Driver</label>
            </div>
            <div className="mb-4">
              <label className="">Payment Date*</label>
              <input
                type="date"
                name="date"
                value={formState.date}
                onClick={(e) => (e.target as HTMLInputElement).showPicker()}
                onChange={handleChange}
                className="mt-1 p-2 w-full border border-gray-300 rounded-md"
                required
              />
            </div>
            <div className="mb-4">
              <label className="">Notes</label>
              <textarea
                name="notes"
                value={formState.notes}
                onChange={handleChange}
                className="mt-1 p-2 w-full border border-gray-300 rounded-md"
              />
            </div>
            <div className="flex justify-end space-x-4">
              <Button variant='outline' type="button" onClick={onClose}>
                Cancel
              </Button>
              <Button type="submit">
                Save
              </Button>
            </div>
          </form>
        </div>
      </motion.div>
    </>
  );
};

export default InvoicePaymentModal;
</file>

<file path="src/components/trip/tripDetail/TripFunctions/LoadingSlip.tsx">
'use client'
import { useToast } from '@/components/hooks/use-toast'
import { useExpenseData } from '@/components/hooks/useExpenseData'
import { Button } from '@/components/ui/button'
import { Dialog, DialogContent } from '@/components/ui/dialog'
import { ITrip } from '@/utils/interface'
import { formatNumber } from '@/utils/utilArray'
import { DialogTrigger } from '@radix-ui/react-dialog'
import html2canvas from 'html2canvas'
import jsPDF from 'jspdf'
import { Loader2 } from 'lucide-react'
import Image from 'next/image'
import React, { useEffect, useRef, useState } from 'react'


/**
 * Converts an image URL to a base64 Data URL for safe use in html2canvas or PDF export.
 * @param url - Image URL string
 * @returns Promise<string> - resolves to base64 Data URL string
 */
async function urlToBase64(url: string): Promise<string> {
  const response = await fetch(url);
  const blob = await response.blob();
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result as string);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}

type Props = {
    trip : ITrip | any,
    charges : number | undefined,
    haltingCharges : number | undefined
}
const LoadingSlip: React.FC<Props> = ({trip, charges,haltingCharges}) => {
    const {parties} = useExpenseData()
    const [user, setUser] = useState<any>()
    const { toast } = useToast()
    const slipRef = useRef<HTMLDivElement | null>(null)
    const [pdfDownloading, setPDFDownloading] = useState(false)
    const [isPdfExport, setIsPdfExport] = useState(false);
    const [base64Logo, setBase64Logo] = useState('');
    const [base64Signature, setBase64Signature] = useState('');
    useEffect(() => {
  if (isPdfExport && user?.logoUrl) {
    urlToBase64(user.logoUrl)
      .then(setBase64Logo)
      .catch(() => setBase64Logo(''));
  }
}, [isPdfExport, user?.logoUrl]);

useEffect(() => {
  if (isPdfExport && user?.signatureUrl) {
    urlToBase64(user.signatureUrl)
      .then(setBase64Signature)
      .catch(() => setBase64Signature(''));
  }
}, [isPdfExport, user?.signatureUrl]);



    const fetchUser = async () => {
        try {
            const res = await fetch('/api/users')
            const data = await res.json()
            setUser(data.user)
        } catch (error) {
            toast({
                description: "Failed to fetch user details",
                variant: "destructive"
            })
        }
    }

    const downloadPdf = async () => {
  if (!slipRef.current) {
    console.error('Element not found');
    return;
  }

  // 1. Set PDF export mode to true to trigger Base64 image conversion
  setIsPdfExport(true);

  // 2. Wait until base64Logo and base64Signature are loaded (max 5 seconds timeout)
  await new Promise<void>((resolve) => {
    const maxWaitTime = 5000; // 5 seconds
    let waited = 0;
    const interval = setInterval(() => {
      if (base64Logo && base64Signature) {
        clearInterval(interval);
        resolve();
      } else if (waited >= maxWaitTime) {
        // Timeout to prevent infinite wait
        clearInterval(interval);
        resolve();
      }
      waited += 100;
    }, 100);
  });

  setPDFDownloading(true);

  try {
    console.log('Capturing element as image...');
    const canvas = await html2canvas(slipRef.current, {
      scale: 2,
      logging: true,
      useCORS: true,
    });

    console.log('Canvas generated. Dimensions:', canvas.width, 'x', canvas.height);
    const imgData = canvas.toDataURL('image/jpeg');
    console.log('Image data URL length:', imgData.length);

    const padding = 10; // mm padding on all sides
    const imgWidth = canvas.width / 2;
    const imgHeight = canvas.height / 2;
    const pdfWidth = (imgWidth * 25.4) / 96 + padding * 2;
    const pdfHeight = (imgHeight * 25.4) / 96 + padding * 2;

    console.log('Calculated PDF dimensions:', pdfWidth, 'x', pdfHeight, 'mm');

    const pdf = new jsPDF({
      orientation: pdfWidth > pdfHeight ? 'landscape' : 'portrait',
      unit: 'mm',
      format: [pdfWidth, pdfHeight],
    });

    const imgX = padding;
    const imgY = padding;

    console.log('Adding image to PDF...');
    pdf.addImage(imgData, 'JPEG', imgX, imgY, pdfWidth - padding * 2, pdfHeight - padding * 2);

    console.log('Saving PDF...');
    pdf.save(`Loading Slip-${trip.LR}-${trip.truck}.pdf`);
  } catch (error) {
    toast({
      description: "Failed to generate PDF",
      variant: "destructive",
    });
  } finally {
    setPDFDownloading(false);

    // 4. Reset PDF export mode once done
    setIsPdfExport(false);
  }
};


    function numberToWordsIndian(num: number): string {
    if (num === 0) return "Zero";

    const units = ["", "one", "two", "three", "four", "five", "six", "seven", "eight", "nine"];
    const teens = [
        "eleven", "twelve", "thirteen", "fourteen", "fifteen",
        "sixteen", "seventeen", "eighteen", "nineteen"
    ];
    const tens = ["", "ten", "twenty", "thirty", "forty", "fifty", "sixty", "seventy", "eighty", "ninety"];
    const scales = ["", "thousand", "lakh", "crore"];

    const getBelowThousand = (n: number): string => {
        let str = "";
        if (n > 99) {
            str += units[Math.floor(n / 100)] + " hundred ";
            n %= 100;
        }
        if (n >= 11 && n <= 19) {
            str += teens[n - 11] + " ";
        } else {
            if (n >= 10) {
                str += tens[Math.floor(n / 10)] + " ";
                n %= 10;
            }
            if (n > 0) {
                str += units[n] + " ";
            }
        }
        return str.trim();
    };

    const parts: string[] = [];
    let scaleIndex = 0;

    while (num > 0) {
        const divisor = scaleIndex === 0 ? 1000 : 100;
        const part = num % divisor;

        if (part > 0) {
            const scale = scales[scaleIndex];
            parts.unshift(getBelowThousand(part) + (scale ? " " + scale : ""));
        }

        num = Math.floor(num / divisor);
        scaleIndex++;
    }

    // Capitalize first letter of each word
    const result = parts.join(" ").trim();
    return result.replace(/\b\w/g, (c) => c.toUpperCase());
}



    useEffect(() => {
        fetchUser()
    }, [])

    return (
        <Dialog>
            <DialogTrigger><Button className='w-full'>Loading Slip</Button></DialogTrigger>
            <DialogContent className='max-w-4xl p-8 h-[95vh] overflow-y-auto thin-scrollbar'>
                <div ref={slipRef} className="max-3-4xl w-full mx-auto p-4 border-2 border-black">
                    <div className="text-center spacing-large relative">
    <div className="absolute top-0 right-0 text-right">
        <p className="text-sm m-0">
            <i className="fas fa-phone-alt"></i>
            {user?.phone}
        </p>
        <p className="text-sm m-0">
            <i className="fas fa-phone-alt"></i>
            {user?.altPhone}
        </p>
    </div>

    <h2 className="text-blue-500">Loading Slip</h2>

    <div className="flex items-center spacing-large relative">
        <div className="absolute left-4">
  {isPdfExport ? (
    base64Logo ? (
      <img src={base64Logo} alt="logo" width={80} height={80} style={{ objectFit: 'contain' }} />
    ) : (
      <div style={{ width: 80, height: 80, backgroundColor: '#ccc' }} />
    )
  ) : (
    <Image src={user?.logoUrl || ''} alt="logo" width={80} height={80} />
  )}
</div>

        <div className="flex-grow text-center">
            <h1 className="text-4xl font-bold">{user?.company}</h1>
        </div>
    </div>
    <div className="text-sm mt-2 spacing-large">
        <p>{user?.address}, {user?.city}, {user?.pincode}</p>
        <p>{user?.email}</p>
    </div>
</div>




                    <div className="spacing-large bg-blue-500 bg-opacity-45 p-2 mt-2">
                        <div className="flex justify-between">
                            <p>No: {trip?.LR || 'N/A'}</p>
                            <p>Date: {new Date(trip?.startDate).toLocaleDateString('en-IN')}</p>
                        </div>
                    </div>
                    <div className="spacing-large mt-2">
                        <p>Party/Customer: <strong>{parties.length > 0 ? parties?.find(party=>party.party_id === trip.party)?.name || '' : ''}</strong> </p>
                        <p>As per discussion with {trip?.partyName}</p>
                        <p>We are sending</p>
                    </div>
                    <div className="spacing-large mt-2">
                        <table className="w-full border-collapse">
                            <thead>
                                <tr className="bg-blue-500 bg-opacity-45">
                                    <th className="p-2 text-center border">Vehicle No.</th>
                                    <th className="p-2 text-center border">Load</th>
                                    <th className="p-2 text-center border">From</th>
                                    <th className="p-2 text-center border">To</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td className="p-2 text-center border">{trip?.truck}</td>
                                    <td className="p-2 text-center border">{trip.material && trip?.material?.map((item : {name : string, weight : string})=>item.name + ',')}</td>
                                    <td className="p-2 text-center border">{trip?.route?.origin}</td>
                                    <td className="p-2 text-center border">{trip?.route?.destination}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div className="spacing-large grid grid-cols-2 gap-8 mt-2">
                        <div>
                            <div className="flex justify-between">
                                <p>Length:</p>
                                <p></p>
                            </div>
                            <div className="flex justify-between">
                                <p>Width:</p>
                                <p></p>
                            </div>
                            <div className="flex justify-between">
                                <p>Height:</p>
                                <p></p>
                            </div>
                            <div className="flex justify-between">
                                <p>Rate:</p>
                                <p>{trip?.rate} {trip?.billingType}</p>
                            </div>
                            <div className="flex justify-between">
                                <p>Halting Charges:</p>
                                <p>{haltingCharges || 0}</p>
                            </div>
                            <div className="flex justify-between">
                                <p>Total Freight:</p>
                                <p>{formatNumber(trip?.amount) || 0}</p>
                            </div>
                        </div>
                        <div>
                            <div className="flex justify-between">
                                <p>Other Charges:</p>
                                <p>{charges || 0}</p>
                            </div>
                            <div className="flex justify-between">
                                <p>Advance:</p>
                                <p>{formatNumber(trip?.loadingSlipDetails?.advance) || 0}</p>
                            </div>
                            <div className="flex justify-between">
                                <p>Balance Amount:</p>
                                <p>{formatNumber(trip?.loadingSlipDetails?.balance || trip?.balance || 0)}</p>
                            </div>

                            <div className="flex justify-between">
                                <p>Min Guaranteed Weight(M.T.):</p>
                                <p>{trip?.guaranteedWeight}</p>
                            </div>
                            <div className="flex justify-between">
                                <p>Maximum Weight(M.T.):</p>
                                <p></p>
                            </div>
                        </div>
                    </div>
                    <div className="spacing-large mt-2">
                        <div className="border border-black p-2 h-16">
                            <p><strong>Amount in Words:</strong> {numberToWordsIndian(trip?.amount)} Rupees Only</p>
                        </div>
                    </div>
                    <div className="mt-16 flex justify-between items-start">
                        <div className="max-w-md">
  <div className="space-y-2">
    <div className="grid grid-cols-[10rem,1fr] gap-x-8"> {/* 10rem  160px */}
      <p className="font-medium">PAN No.:</p>
      <p>{user?.panNumber}</p>

      <p className="font-medium">GST No.:</p>
      <p>{user?.gstNumber}</p>

      <p className="font-medium">MSME No.:</p>
      <p>{user?.bankDetails?.msmeNo}</p>

      <p className="font-medium">Account No.:</p>
      <p>{user?.bankDetails?.accountNo}</p>

      <p className="font-medium">Bank Name:</p>
      <p>{user?.bankDetails?.bankName}</p>

      <p className="font-medium">Branch:</p>
      <p>{user?.bankDetails?.bankBranch}</p>

      <p className="font-medium">IFSC Code:</p>
      <p>{user?.bankDetails?.ifscCode}</p>
    </div>
  </div>
</div>

                        <div
  style={{
    display: "flex",
    flexDirection: "column",
    alignItems: "center",
    gap: "1rem",
  }}
>
  <p style={{ margin: 0, textAlign: "center" }}>For <strong>{user?.company}</strong></p>
  {isPdfExport ? (
  base64Signature ? (
    <img src={base64Signature} alt="signature" width={80} height={80} style={{ display: 'block' }} />
  ) : (
    <div style={{ width: 80, height: 80, backgroundColor: '#ccc' }} />
  )
) : (
  user?.signatureUrl && (
    <Image src={user.signatureUrl} alt="Signature" width={80} height={80} style={{ display: 'block' }} />
  )
)}

  <p style={{ margin: 0, textAlign: "center" }}>Thank You</p>
</div>

                    </div>
                    <div className="text-center text-xs mt-4 py-4">
                        <p className="flex items-center justify-center">
                            Powered by
                            <Image
                                src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOQAAAD0CAYAAACLgYoWAAAACXBIWXMAACxLAAAsSwGlPZapAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAABPbSURBVHgB7Z1dchRHFoVvNRg5Yh4sr8DFCiytwGIFxitw82BiICZCYgVIK7AU4YCJmAeaFVizAqQVoFkBYgWjeTOY6XJmVrbULXVX5W/VzczzRRDIpoUA9amTefPcvERgVJq/U908p0MCQDAhMC6VEuN+c0DbBIoHghwR6Y5CkD+LD7fpMx0QKB4IckyqlaUqXBJAkGOx5I4LpEv+SqBoIMixqNYWcqZKqKBYIMgREKLbu+WON1T0hkCxQJBjUNHLjl/bU4IFRQJBDow4c5xK0XW+qEuwIGsgyOHpFxtcslggyAFR7kiGRRu4ZJFAkMNiLrLWJacEigKCHAgrd1wgXBJhgbKAIIfDfglaCQEjUlcUEOQAOLnjDYjUFQQEGRmdvPEp0CB4XhAQZHxkIqcmP+CShQBBRkS54ySIu8ElCwGCjEkbIA/lbC8RPM8fCDISa9qr/JkgLJA7EGQsqij35EwRqcsbCDICUdxxASJ1WQNBxqCKeIscgudZA0EGJqo7LoBLZgsEGZohOv7hktkCQQZEX82xR0OAqz6yBIIMyWRAkVRUN08RFsiNikAQdIB8aNe6ogf0sDoWP4MsgEOGY4xCCyJ1mQFBBsCzvcoXBM8zAoIMw5jHEHDJjIAgPRnZHRfsI3ieBxCkPxwO6bcRPM8DCNID4UpSBDXxYNr8QjsEkgaCdEQ3H0+JE/cxPSt1IEh3QlzNERZE6pIHgnRAu+MhcQTB86SBIF2omIpRApdMGgjSkkHaq3yBSyYLBGkLZ3dcgLkgyYJwuQV67/iBUqChS9qiXQTP0wIOaUMK7rgAc0GSBA5piDp0/4reU1qgPSsx4JCmpHnojuB5YsAhDRip+TgUcMmEgEOakfIxwjZ9wjFIKsAhe0jcHW+YC5f8p6i8AtbAIfvJw10qBM9TAILsgEnzcRgqeoxIHX8gyG7y2nshUsceCHIDWbnjAgTP2QNBrkHfT5Onm8AlWQNBrodf83EopEs+o8cEWAJB3oLl1RzhQcWVKRDkbdoAeU05g7kgbEEwYImk2qv8QaSOIXDIZVJqr/IHwXOGwCE1hbnjArgkM+CQC8pyxwVwSWbAIalYd1xwRXPaRfCcB3BISdnBa8wFYUTxDqmiZBN6R6Uzp0fCJc8IjAoccoJDcgUidSwoWpA6QI6JURIEz1lQukPCFZaBS45OsYLMsr3KF7jk6JTskHCDdWBPPSpFChLu2MkO5oKMR6kOCXfsQuwlmwNxPgkGpzhBiqe/FGNNYDOYCzIaRQUDdEROhgBqAn0geD4CpTlkvldzhAfB8xEoxiFZB8gbFey+kHenEi/gkgNTjkNybq9q6Ej8eEH8wFyQgSnCIbm7Y/WaHqoPn9Ox+GmfuIG5IINRhkNydsd79OT64wfqz8lveVhlMGwoEbIXpHLHShVzODKrfrtpedJ7tRPiBiJ1g5G/Q3J2x7nYO97mgVq2cnRJ7CUHIGtBsnfHNfsyuGTZ5O2QnPc+69xxQeuSl8QNuGR0shWkml9RsX2iz7qqltolj4gbrUtOCUQjX4fke3HVVac7aqpXNBNHImfEDbhkVLIUJPP2qhPjM72GpUvW4t/3kEAUcnVInk9xGZGbC+czRN0Cx9ElifbRnhWH7ATJ2h2F41knXji6JILn0cguOicEKSNyNXFjKSJn/anP6B3DAhWC5xHIyiG5uyO50izF6/gAl4xANg7JuvnYwx2vfwuewXPMBQlMTg7Jt/k4xD6QZ/Acc0ECk4UgtTtOiSfnwkFm5AnbSB3RFJG6cOThkG2AvCaOzAM+KBA8z57kBZligNwVBM/zJ32HTK29yhcEz7MmaUGW5I4LmAfP9wh4kbZDluaOGsbBc1z14UmygmTujkfRz+a4Bs/RnuVFug7J1R0tA+SusA2eT+hXBM/dSVKQaq/C1x1PBkuuIHieHUlG55iGrYNE5Ky/JILnWZGcQ6oAOderOcZwLATPsyI5h8yxvcr7Sz8Te1Z+S3i4pANJOWS27VW+bCk34hc8/4zx6LaktmTlmga5CBEgd4V58LwmYEwygmTtjhMGk6v4Bs8RFrAgJYfk6o4r8znGAsHzPEhCkOIbKsVYE0fmjM4C0Z6VPOwFybz5eMbp+grtkvwGv8IljUnBIflezWHpjjJS1vfGlA8gnzyoCp6jPStZWAtSu+Mh8cTKHZUQP9N78ffZ63mp/Du/EWeL7pnQOcOwAOaCGMHbIXkHyI3cUbmiENf1jXiN4R6vEmeLn+i9y1KPbfBcuCSC592wFSTr9qqK3pq447UrVisxst7PW/o66mpLJ7dk2p6FSF03fB2SsTuKfdph50tuu+Iy93ocslojvIVb/kI7ZAjmgqQJS0Gydsce59ngijd86XHIasObVbrLV2oJa14c+cKw4orgeSc8HZKzO26IyHW64hLexySiyCW+zgeTSFr1L7oQf+a3xA+45AbYCTJFd+x1xRsuqP9r9L9R273lByO3bJjeeA6XXAs/h+SafVzjjqauuMT/el9RWTiHgVtqR+YYPH+J4PldWAlSX82xRzxZ2Y9ZuOIyHyg0Jm7JNVKHuSB34OWQE7adAefVazqVHzi44jIfe1/ROLpGh1tiLkg6sBEk6/YqPZ/D0RVvaAz2kD50uSWC50nAySHZtlfR13Tl4Yo3fDGqsH5HvqxxS+WSPMMCCJ4vwUKQzN3x3MsVl/nbgKHvNW4plt2YC8IcLg7J9xvS7mtr8ufC6MKnKvD5XOuW767dkm/wfI/A+IJk7Y5h6T/yaPmWQiMr1xN63zylA8bBc1z1QSMLUqc1SlmumBZ0/PeQ69mm+/SrvliZX3pHzgV5irDAuA75B+1TGe5IbFxJumWjHoL8Kq730Z41miCZX80Rnnv9AhgsuVKpr8PxjV98pG48h2wD5DUVgtHNdBMErqnw4PkogmQ+2zEGZvvHOQRJhbvkOA7JefJxDOYGkTlJBUFq9ksNng8uyALdUQrtzPCVNQHJdqnB8+EdsjR3lNwzXLLCIZeZ2lxZkguDCrJIdyTDgo6kgUOucL+86VnDOmSJ7kh0bvHaWKGANCkwUjeYIHXzcXHuKDgj4E5hwfPhHLLURP/EQpBVeXumXgpzyUEEqQLkfK/miIrlqDoUddZR0MN8KIcstd/NeP+IC586KGguSHRBFtRedZemvYfHkJrAZgqZCzKEQ5bbDf7Fav+I5WoXhcwFiSrIwt3xUt0cbgoKOiZkHzyP7ZDlumNledyBUIAJ2QfPowmyeab+4WoqlYl1Vz5CAWZk7ZJRBKkjcvtUKnK5+pulQ1b0kIAJ2/Qp35VXLIeUiZyaSqVySufAIU2p6CDXY6LggtRXc5R9WdHc7kJiUfxCQceWKs/geXiHbAPkJZfwL6xnQKKgY09Fj3OM1AUVZKntVSvMHYba4MjDjQwjdWEdssz2qhs6Jiz3AEG6kGHwPJgg4Y7kWsyRQv6GgBuZuWQ4hyzdHSVzx+lSWLK6I13yGT2mTAgiSLijYmZdzKHrCityrH5kU3EN45AYlOLujqiw+pPRXBBvQeqrOfaobJzcUYHlahgymQvi75CT4t3xytkdWyDIMGQRPPcSZNHtVTecOLtjy/cEQpF88NzXIcseRS3PHV+5V5f1m6cmEIrkXdJZkHBHkjeS+40H/4Qx3hFIei6Ij0OW7Y5yqfqb552rKOjEIOm5IE6CLN4dxVKVHgQIQjT0A4EYTFON1Lk6ZOl7x0fVcYCR4HDIeCQaqbMWpHjyyL9oTaXS0AvPqmr72yChE5dEg+dWgtTNx1Mql6PqNR1TCBoUdKKToEvaOWR7T05NJdLQqc8Rxx2QbopPgi5pLEgdIC/1ao4L2vI84rgLCjpDMEkreG7ukOW2V12IimqYIo5GP7WxfxyGnZTmghgJsuD2quBiVKC6OiwJzQUxc8gS3VEOyokhxpYfCQxHQnNBqr4X6MrqByqLE1HAifINVE/qz/RfAkNzJR6wDyM9YIPR75BlueOVOmd8FfFpivzqWCQRPO8UpG4+LmPvKONwf4olaqhzxs1kc/9LgrBvz+p2yHJGSZ+IY41dq/FxrlQ47hgR9nNBNu4hdYA879sApCveoyfeXRumX06uOCb0jsC4zMVeMkD8MQb3O34tZ3eUG/sTsTw9pCGpio4d8qG9lO0RMWTtkjXj9iopxCNVbXs1QrHKdbna8HyaJwvjSN0mh8zNHZUjCiEej1X21m+AmmyRYmzE07yi94R0Tzja+sgZMeOOQ2bmjiuOOOoZlOtytaEjtd9pvG62A7dh6pJ3ijpCkDIEUFPanItHzeFQxRoTxL+rDAPYOty5eJDsXf8ez0RBCF0i4WjoTNQRWO0lVxwycXc8l4f6wg2/lW9iZmKckstyc37LVRvVccI6aZIUrUtOiRHXDqkjcrIkX1MayDfmf1TmdItmnCNRjs42Ew+WJ2t+r4NcpwePgrzK8zU9JCYsC/KlXOYRZyolwDPx5zwV5agL7rlEiWMWWN6GvrvprAxL1+AcjVJ1X4OqsjK9mkOK7ZxkC9REiDARAd7BLQvcfRu6XLqi6hoSGak75vD+ao892jdNTeNwJb7+R+EIMrZ2QffEG/GLEB/TJIU1tmeP7RLqsPO3FP82wiWPsHQNxiJ4fkgjUw3UXvVR/LhUZ2qVEtql+JpXWQlvDU7xwzk9MR2LjqVrUFi0Z923XFJ9XPr4ktp2JelwVysfT5TLXdLXdJXkMjMctgGLf5uKUbFFP4knu3yYYunqDwuXrJp/6CfsXBUS7ognZweLiRqzXdHvVp/kEHp2+jpgE53FtCHovTEAuOGwnHSu9Imlsezh3CcQgrXHTUMRZqQ5WMF6qnQ7K8S9MbqdM3JJIASjzgWBIGMwsbwqQuZVPfba6nP/FPtJEIYRG/MhyMDop6vNrXIzq0LOBtRtBzI6CPwZMXgOQYbG9uk6D9fFoe4Davi1FCXJSC4JQQZEVzz3LD7lKHhFb0stXS8J+DGSS0KQIbFJzshEToT8pNpPzserEmZFNfydUhBkIKxb15p4fXjCdc+wnwxARfXQ7Vk4hwyAvo1chr1rw08ZpLtALKF/F99h3APrx6CROjhkCP6wmJsZaam6lnaE3iUBHwa98RwO6Yl1OH/gO0GbX2iHvlKN58i7ujOYS8IhfZlY5UiPhs5JqvPJOfaTngzmknBID6yu0xj5qgjkXb0ZxCXhkI7oIbbmh8fNuLebqYleCA34IF0yekM4BOlKe0Zlui87YtHGhtCAL1P1II4IBOmAXqrumb2YTrlcoKRDA9KpLwm4ETksAEFaopeqxvtGbgf0yqnbzhDc7+pC5EgdBGmBCgDYjJO7p+7HuSRmoPLqScTgOQRpQzvsszZ89RGn29Nvo1u+MC/EhYguCUEaoveNpmdR51z2jV3oPyNE6UIkl4QgDbA64pD7xnk6g1mVKBt6S8COSHNBEAzowXrmCeNx2V2IFcBMvBt+JmCOfPhu0W7IsAAcso82GlcbvVZUVJO9NnNLLccvCJhTifdF4EgdBNmBcA15vLFj+PIjdYVGoqin/AN1RglR2rGvqu+BgCA3oKaBmRZxGB3++wBROhE0eA5BrkFVVM1H813ovsMsgCidCOaSEOQt9EVV5kmcOf2U2/wSiNKaYC6JKusSVs28bSzuUdbTu+RT/5PYF6P6akaACjscUmPZWX+Vuxgl0ilFoWoqPjwh0M/EPywAh6Trs0bTicTy2v5HKg9aEM1ztace7Yr9ZJirB/UZOVK8Qy4d/EOMHSBmZ4hnpK5oh9TLVNOD/2LFuIwuetk0Z5eHh0sW65BLe8ba4OUQo0bsKU/lUFNCk/NmPFyySEGq1hmbairEuIIqZs1xLLIRj/as4gQpllw/G+8ZF0cbEOMdpCjFvlI6JfaV63C86qMoQeqexpnZi/M/ZwyBLvbghvTbyLkgT+3DAsUUdVQ21TwOd04P6HFuCZyYWLeplYH1Xa5FOKQ4Q3tjIcYT8dTfgxjt0EtYeRE0lrA3WEfqsnZIPZVKPrVNWqhk+ibpFiouwC1XsHLJbB1SvSnaEXH9YlxUUiHGIMAtV7ByySwdUpWc205/k0rqqWyfwhI1DnBLhbygetekQJidQ+rijcmxxpW6cuN1fu1TnFhyy5IrsdumwfNsHFLvF2Uf49Tg5ReqjxFHGoOi3VIu38qcwvWncMmeM+0sBGm5LDrK4bqNlNHXah4W12fZ0JlYkXVOQUtekCp5U6liTN8S9Vw8oQ6QuuFDkcLsCZ4nLUh1K1z/RVQ4zmBOUcLscckkBamXqLKK2nekMRNnQC9QtEmDYoTZ4ZLJCdKwH+9cJnM4D7sBm9HClN9nWfypKTc6XDIZQeoLl7rvSpUH/HIEHISYDc1zVTWXP36gnJirUYWz2/87CUEadPZjn5g52bnmhrkg7AWpW6bkoeq6Jar8y5yIfeIx9onlIFxT1g6m4sePlLY47xzBsRWkfiK+kd3Xa34ZQgQKLc7Hyj0b+p7S4k7wnKUgOwo352LtPVu39gZAV9/3SAq03XOmcBHXikuyEmRH4QZVU2CNcs9GCLRdZXEV6IpLshGk7tCQrljr/yX/gHKy70w8QZCuAd7o5e3yDx6V20ZsvV7TC/nh6IJc44rnuiVqhv0hiI0S6USYwFy5qBSp3IcO76R6LsioglxyRfkP8FZ8fIplKRgbZRJflDi3hVBaN5XTkhv6jmKJVc4Yla2ANAJLrrgLNwQpodv8auWq/1cnAVKgrXjlxz6ilZE6Ghh9yL8jvvgZ+hFBrqiK731dD5krd93W4t3WH7e/Vun/JvpG/HzxFxycz+sV8RQvAAAAAElFTkSuQmCC"
                                alt="Awajahi logo"
                                width={20}
                                height={20}
                                className="mx-1"
                            />
                            Awajahi
                        </p>
                    </div>
                </div>
                <div className='flex justify-end'>
                    <Button onClick={() => downloadPdf()} disabled={pdfDownloading}>{pdfDownloading ? <Loader2 className='text-white animate-spin' /> : 'Download PDF'}</Button>
                </div>
                
            </DialogContent>
        </Dialog>
        
    )
}

export default LoadingSlip
</file>

<file path="src/components/trip/tripDetail/TripFunctions/StatusModal.tsx">
import React, { useState, useEffect } from 'react';
import { statuses } from '@/utils/schema';
import { Button } from '@/components/ui/button';
import { motion } from 'framer-motion';

interface StatusModalProps {
  status: number;
  isOpen: boolean;
  dates: Date[];
  amount: number
  onClose: () => void;
  onSave: (data: any) => void;
}

const StatusModal: React.FC<StatusModalProps> = ({ status, isOpen, onClose, onSave, dates, amount }) => {
  const [startDate, setStartDate] = useState<string>(new Date().toISOString().split('T')[0]);
  const [podReceivedDate, setPodReceivedDate] = useState<string>(new Date().toLocaleDateString());
  const [podImage, setPodImage] = useState<File | null>(null);
  const [paymentType, setPaymentType] = useState<string>('Cash');
  const [settlementDate, setSettlementDate] = useState<Date>(new Date(Date.now()));
  const [receivedByDriver, setReceivedByDriver] = useState<boolean>(false);
  const [notes, setNotes] = useState<string>('');


  useEffect(() => {
    if (status === 0) {
      setStartDate(new Date().toISOString().split('T')[0]);
    } else if (status === 1) {
      setPodReceivedDate(new Date().toISOString().split('T')[0]);
    }
  }, [status]);

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files ? e.target.files[0] : null;
    setPodImage(file);
  };


  const saveChanges = () => {
    let data: any = {};

    const convertFileToBase64 = (file: File): Promise<string> => {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onloadend = () => {
          if (reader.result) {
            resolve(reader.result.toString());
          } else {
            reject('Failed to convert file to Base64');
          }
        };
        reader.onerror = () => reject('Error reading file');
      });
    };

    const updateData = async () => {
      if (statuses[status] === 'Started') {
        dates[1] = new Date(startDate);
        data = { dates: dates, status: status + 1 };
      } else if (statuses[status] === 'Completed') {
        dates[2] = new Date(podReceivedDate);

        if (podImage) {
          try {
            const base64PodImage = await convertFileToBase64(podImage);
            data = { dates: dates, status: status + 1, podImage: base64PodImage };
          } catch (error) {
            console.error('Error converting file to Base64:', error);
          }
        } else {
          data = { dates: dates, status: status + 1 };
        }
      } else if (statuses[status] === 'POD Recieved') {
        dates[3] = new Date(startDate);
        data = { dates: dates, status: status + 1 };
      } else if (statuses[status] === 'POD Submitted') {
        dates[4] = new Date(settlementDate);
        amount === 0 ? data = { dates: dates, status: status + 1 } :
          data = {
            amount: amount,
            paymentType,
            receivedByDriver,
            notes,
            date: dates[4],
            dates: dates,
            status: status + 1,
          };
      }

      onSave(data)
      onClose()
      // You can now use the `data` object to send the request or perform further actions
      // Example: sending data to the server
      // await fetch('/api/update-status', { method: 'POST', body: JSON.stringify(data) });
    };

    updateData();

  };


  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-40 flex items-center justify-center">
      <motion.div
        initial={{ opacity: 0, scale: 0.5 }}
        animate={{ opacity: 1, scale: 1 }}
        transition={{
          duration: 0.5,
          ease: [0, 0.71, 0.2, 1.01]
        }} className="bg-white rounded-lg shadow-md overflow-hidden" style={{ maxWidth: '600px', width: '90%' }}>
        <div className="p-6">
          <h2 className="text-lg font-bold mb-4 text-black">Trip {statuses[status + 1]}</h2>
          {statuses[status] === 'Started' && (
            <div className="mb-4">
              <label className="">End Date</label>
              <input
                type="date"
                value={startDate}
                onClick={(e) => (e.target as HTMLInputElement).showPicker()}
                onChange={(e) => setStartDate(e.target.value)}
              />
            </div>
          )}
          {statuses[status] === 'Completed' && (
            <>
              <div className="mb-4">
                <label className="">POD Received Date*</label>
                <input
                  type="date"
                  value={podReceivedDate}
                  onClick={(e) => (e.target as HTMLInputElement).showPicker()}
                  onChange={(e) => setPodReceivedDate(e.target.value)}
                />
              </div>
              <div className="mb-4">
                <label className="">POD Image</label>
                <input
                  type="file"
                  accept="image/*, application/pdf"
                  onChange={handleFileChange}
                />
              </div>
            </>
          )}
          {statuses[status] === 'POD Recieved' && (
            <div className="mb-4">
              <label className="">POD Submitted Date*</label>
              <input
                type="date"
                value={startDate}
                onClick={(e) => (e.target as HTMLInputElement).showPicker()}
                onChange={(e) => setStartDate(e.target.value)}
              />
            </div>
          )}
          {statuses[status] === 'POD Submitted' && (
            <>
              <div className="mb-4">
                <label className="">Amount</label>
                <input
                  type="number"
                  value={amount}
                  disabled
                />
              </div>
              <div className="mb-4">
                <label className="">Payment Type</label>
                <select
                  className="w-full px-3 py-2 border border-lightOrange rounded-lg focus:outline-none focus:ring focus:ring-lightOrange focus:border-lightOrange"
                  value={paymentType}
                  onChange={(e) => setPaymentType(e.target.value)}
                >
                  <option value="Cash">Cash</option>
                  <option value="Cheque">Cheque</option>
                  <option value="UPI">UPI</option>
                  <option value="Bank Transfer">Bank Transfer</option>
                  <option value="Fuel">Fuel</option>
                  <option value="Others">Others</option>
                </select>
              </div>
              <div className="mb-4">
                <label className="">Settlement Date*</label>
                <input
                  type="date"
                  value={new Date(settlementDate).toISOString().split('T')[0]}
                  onClick={(e) => (e.target as HTMLInputElement).showPicker()}
                  onChange={(e) => setSettlementDate(new Date(e.target.value))}
                />
              </div>
              <div className="mb-4">
                <label className="flex items-center">
                  <input
                    type="checkbox"
                    className="form-checkbox h-4 w-4 text-lightOrange focus:ring-bottomNavBarColor"
                    checked={receivedByDriver}
                    onChange={(e) => setReceivedByDriver(e.target.checked)}
                  />
                  <span className="ml-2 text-sm text-gray-700">Received by Driver</span>
                </label>
              </div>
              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                <textarea
                  className="w-full px-3 py-2 border border-lightOrange rounded-lg focus:outline-none focus:ring focus:ring-lightOrange focus:border-bottomNavBarColor"
                  value={notes}
                  onChange={(e) => setNotes(e.target.value)}
                />
                <p className="mt-2 text-sm text-red-600 font-semibold">
                   Warning: Make sure to check all the payments and charges. Once settled, they cannot be edited.
                </p>
              </div>

            </>
          )}
          <div className="mt-4 flex justify-end space-x-2">
            <Button onClick={saveChanges}>
              Save
            </Button>
            <Button variant={'outline'} onClick={onClose}>
              Cancel
            </Button>
          </div>
        </div>
      </motion.div>
    </div>
  );
};

export default StatusModal;
</file>

<file path="src/components/trip/TruckSelect.tsx">
import React, { useState, useEffect } from 'react';
import { TruckModel, ISupplier } from '@/utils/interface';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Button } from '@/components/ui/button';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { PiPlusBold } from 'react-icons/pi';

type Props = {
  trucks: TruckModel[];
  suppliers: ISupplier[];
  formData: any; // Adjust type as per your formData structure
  handleChange: (e: React.ChangeEvent<HTMLSelectElement>) => void;
  setFormData: React.Dispatch<React.SetStateAction<any>>;
};

const TruckSelect: React.FC<Props> = ({ trucks, suppliers, formData, handleChange, setFormData }) => {
  const [supplierName, setSupplierName] = useState<string>('');
  const [selectedTruck, setSelectedTruck] = useState<TruckModel | null>(null);
  const [searchTerm, setSearchTerm] = useState<string>('');
  const [supplierSearchTerm, setSupplierSearchTerm] = useState<string>('');
  const pathname = usePathname()

  useEffect(() => {
    const selectedTruck: any = trucks.find(truck => truck.truckNo === formData.truck);
    setSelectedTruck(selectedTruck || null);
    if (selectedTruck?.supplier) {
      setSupplierName(selectedTruck.supplierName as string)
    } else {
      setSupplierName('');
      setFormData((prev: any) => ({
        ...prev,
        supplierId: null
      }));
    }
  }, [trucks, formData.truck, setFormData]);

  const handleOptionSelect = (value: string) => {
    const truck = trucks.find(truck => truck.truckNo === value);
    setFormData((prev: any) => ({
      ...prev,
      truck: value,
      driver: truck?.driver_id ? truck.driver_id : ''
    }));
  };

  const handleSupplierSelect = (value: string) => {
    setFormData((prev: any) => ({
      ...prev,
      supplierId: value
    }));
  };

  const filteredSuppliers = suppliers.filter(supplier =>
    supplier.name.toLowerCase().includes(supplierSearchTerm.toLowerCase())
  );

  const filteredTrucks = trucks.filter(truck =>
    truck.truckNo.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const truncateText = (text: string, maxLength: number) => {
    return text?.length > maxLength ? text.substring(0, maxLength) + '...' : text;
  };

  return (
    <div className="relative">
      <label className="block w-full">
        <span className="block text-xs font-medium text-gray-700 mb-1">Lorry*</span>
        <Select name="truck" defaultValue={formData.truck} value={formData.truck} onValueChange={handleOptionSelect}>
          <SelectTrigger className="w-full">
            <SelectValue placeholder="Select Lorry" />
          </SelectTrigger>
          <SelectContent className="w-full max-h-[300px]">
            <div className="flex items-center justify-between gap-2 p-2">
              <input
                type="text"
                placeholder="Search..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full p-2 border border-gray-300 rounded-md"
              />
              <Button className="rounded-full w-8 h-8 p-0" onClick={() => {
                localStorage.setItem('tripData', JSON.stringify(formData))
              }}>
                <Link href={{
                  pathname: `/user/trucks/create`, query: {
                    nextpath: pathname
                  }
                }}><PiPlusBold /></Link>
              </Button>
            </div>
            {filteredTrucks.length > 0 ? (
              filteredTrucks.map((truck: any) => (
                <SelectItem key={truck.truckNo} value={truck.truckNo} className="py-2">
                  <div className="grid grid-cols-[1fr,auto,1fr] gap-2 items-center w-full">
                    <span className="truncate text-sm">{truck.truckNo}</span>
                    <span
                      className={`px-2 py-1 rounded text-sm ${truck.status === 'Available' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}
                    >
                      {truck.status}
                    </span>
                    <TooltipProvider>
                      <Tooltip>
                        <TooltipTrigger asChild>
                          <span className="truncate text-sm text-right">{truncateText(truck.supplierName, 15)}</span>
                        </TooltipTrigger>
                        <TooltipContent side="top" align="start" className="z-50 absolute border-lightOrange">
                          <p>{truck.supplierName}</p>
                        </TooltipContent>
                      </Tooltip>
                    </TooltipProvider>
                  </div>
                </SelectItem>
              ))
            ) : (
              <div className="p-2 text-gray-500">No lorries found</div>
            )}
          </SelectContent>
        </Select>
      </label>
      {supplierName && (
        <div className="mt-2 text-sm text-gray-600">
          Supplier: {truncateText(supplierName, 30)}
        </div>
      )}
      <label className="block w-full mt-4">
        <span className="block text-xs font-medium text-gray-700 mb-1">Supplier</span>
        <Select name="supplierId" defaultValue={formData.supplierId} value={formData.supplierId} onValueChange={handleSupplierSelect}>
          <SelectTrigger className="w-full">
            <SelectValue placeholder="Select Supplier" />
          </SelectTrigger>
          <SelectContent className="w-full max-h-[300px]">
            <div className="flex items-center justify-between gap-2 p-2">
              <input
                type="text"
                placeholder="Search..."
                value={supplierSearchTerm}
                onChange={(e) => setSupplierSearchTerm(e.target.value)}
                className="w-full p-2 border border-gray-300 rounded-md"
              />
              <Button className="rounded-full w-8 h-8 p-0" onClick={() => {
                localStorage.setItem('tripData', JSON.stringify(formData))
              }}>
                <Link href={{
                  pathname: `/user/suppliers/create`, query: {
                    nextpath: pathname
                  }
                }}><PiPlusBold /></Link>
              </Button>
            </div>
            {filteredSuppliers.length > 0 ? (
              filteredSuppliers.map((supplier: any) => (
                <SelectItem key={supplier.party_id} value={supplier.party_id}>
                  {supplier.name}
                </SelectItem>
              ))
            ) : (
              <div className="p-2 text-gray-500">No suppliers found</div>
            )}
          </SelectContent>
        </Select>
      </label>
    </div>
  );
};

export default TruckSelect;
</file>

<file path="src/components/truck/SupplierSelect.tsx">
import React, { useState } from 'react';
import { ISupplier } from '@/utils/interface';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '../ui/select';
import { Input } from '../ui/input'; // Assuming you have an Input component for the search field
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { PiPlusBold } from 'react-icons/pi';

type Props = {
    suppliers: ISupplier[];
    value: string;
    onChange: (key: string, value: string) => void;
};

const SupplierSelect: React.FC<Props> = ({ suppliers, value, onChange }) => {
    const [searchTerm, setSearchTerm] = useState('');
    const router = useRouter();

    // Filter suppliers based on the search term
    const filteredSuppliers = suppliers.filter((supplier) =>
        supplier.name.toLowerCase().includes(searchTerm.toLowerCase())
    );

    return (
        <Select defaultValue={value} onValueChange={(value) => onChange('supplier', value)}>
            <SelectTrigger>
                <SelectValue placeholder="Select Supplier*" />
            </SelectTrigger>
            <SelectContent>
                {/* Search input and add button */}
                <div className="flex items-center justify-between gap-2 p-2">
                    <Input
                        type="text"
                        placeholder="Search supplier..."
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                    />
                    <Button className="rounded-full w-8 h-8 p-0" onClick={() => {
                        router.push(`/user/suppliers/create?nextpath=${window.location.pathname}`);
                    }}>
                        <PiPlusBold />
                    </Button>
                </div>
                {/* Display filtered suppliers */}
                {filteredSuppliers.length > 0 ? (
                    filteredSuppliers.map((supplier) => (
                        <SelectItem key={supplier.supplier_id} value={supplier.supplier_id}>
                            {supplier.name}
                        </SelectItem>
                    ))
                ) : (
                    <div className="p-2 text-sm text-gray-500">No suppliers found</div>
                )}
            </SelectContent>
        </Select>
    );
};

export default SupplierSelect;
</file>

<file path="src/app/user/trips/invoice/page.tsx">
'use client'

import { useToast } from '@/components/hooks/use-toast'
import { ITrip } from '@/utils/interface'
import { useRouter, useSearchParams } from 'next/navigation'
import React, { useEffect, useRef, useState } from 'react'
import Loading from '../loading'
import InvoiceForm from '@/components/trip/tripDetail/TripFunctions/InoiveForm'
import FreightInvoice from '@/components/trip/tripDetail/TripFunctions/FrieghtInvoice'
import { Button } from '@/components/ui/button'
import { Download } from 'lucide-react'
import jsPDF from 'jspdf'
import html2canvas from 'html2canvas'
import { InvoiceFormData as FormData } from '@/utils/interface'
import {
  ResizableHandle,
  ResizablePanel,
  ResizablePanelGroup,
} from "@/components/ui/resizable"
import { loadingIndicator } from '@/components/ui/LoadingIndicator'
import { saveInvoice } from '@/utils/saveTripDocs'
import { useExpenseData } from '@/components/hooks/useExpenseData'

const InvoiceGenerationPage: React.FC = () => {
  const params = useSearchParams()
  const paramtrips = JSON.parse(params.get('trips') as string)
  const party = params.get('party') as string
  const invoiceId = params.get('invoiceId') as string
  const route = JSON.parse(params.get('route') as string)

  const issuedDate = params.get('issuedDate') as string
  const dueDate = params.get('dueDate') as string
  const gst = parseFloat(params.get('gst') as string)


  const router = useRouter()
  const { toast } = useToast()

  const { invoices } = useExpenseData()

  const [trips, setTrips] = useState<ITrip[] | any[]>([])
  const [loading, setLoading] = useState(true)
  const invoiceRef = useRef<HTMLDivElement | null>(null)
  const [deletedPaymentIds, setDeletedPaymentIds] = useState<string[]>([])
  const [deletedChargeIds, setDeletedChargeIds] = useState<string[]>([])
  const [downloading, setDownloading] = useState(false)
  const [isCollapsed, setIsCollapsed] = useState(false)
  const [formData, setFormData] = useState<FormData>({
    logoUrl: '',
    color : '#d1d5db',
    partygst : "",
    partyAddress : "",
    billNo: '',
    companyName: '',
    gst : gst || 0,
    email: '',
    phone: '',
    date: new Date(issuedDate || Date.now()).toISOString().split('T')[0],
    dueDate: new Date(dueDate || Date.now()).toISOString().split('T')[0],
    to: '',
    from: '',
    branch: '',
    address: '',
    particulars: '',
    signatureUrl: '',
    rate: '',
    billingtype: '',
    stampUrl: '',
    party: '',
    freightCharges: [],
    additionalCharges: [],
    partyDetails: {
      msmeNo: '',
      gstin: '',
      pan: '',
      accNo: '',
      ifscCode: '',
      bankName: '',
      bankBranch: ''
    },
    paymentDetails: [],
    extraAdditionalCharges: [],
    extraPaymentDetails: []
  })

  const fetchData = async () => {
    try {
      const res = await fetch(`/api/trips/invoice?trips=${encodeURIComponent(JSON.stringify(paramtrips))}`)
      const data = await res.json()
      setTrips(data.trips)
      setFormData({
        ...formData,
        to: data.trips[0]?.route?.origin || '',
        from: data.trips[0]?.route?.destination || '',
        party: data.trips[0]?.partyName || '',
        partygst : data.trips[0].partyDetails.gstNumber || "",
        partyAddress : data.trips[0].partyDetails.address || "",
        freightCharges: data.trips?.map((trip: ITrip) => ({
          lrNo: trip.LR,
          truckNo: trip.truck,
          material: trip?.material ? trip.material?.map(item=>item.name) : [],
          date: new Date(trip.startDate).toISOString().split('T')[0],
          weight: trip.guaranteedWeight || 'FTL',
          charged: trip.units || '',
          rate: trip.rate || 'Fixed',
          amount: trip.amount
        })),
        additionalCharges: data.trips?.flatMap((trip: any) =>
          trip.tripCharges?.map((charge: any, index: number) => ({
            id: charge._id,
            sNo: index + 1,
            date: charge.date ? new Date(charge.date).toISOString().split('T')[0] : '',
            notes: charge.notes || '',
            expenseType: charge.expenseType || '',
            amount: charge.amount,
            edited: false
          })) || []
        ) || [],
        partyDetails: {
          msmeNo: data.trips[0]?.partyDetails?.msmeNo || '',
          gstin: data.trips[0]?.partyDetails?.gstNumber || '',
          pan: data.trips[0]?.partyDetails?.pan || '',
          accNo: '',
          ifscCode: '',
          bankName: '',
          bankBranch: ''
        },
        paymentDetails: data.trips?.flatMap((trip: any) =>
          trip.tripAccounts?.map((charge: any, index: number) => ({
            id: charge._id,
            sNo: index + 1,
            date: charge.date ? new Date(charge.date).toISOString().split('T')[0] : '',
            notes: charge.notes || '',
            paymentType: charge.paymentType || '',
            amount: charge.amount,
            edited: false
          })) || []
        ) || [],
      })
    } catch (error) {
      console.log(error)
      toast({
        description: 'Failed to fetch trips. Please try again later.',
        variant: 'destructive'
      })
    } finally {
      setLoading(false)
    }
  }


  useEffect(() => {
    fetchData()
  }, [])

  const handleDownload = async () => {
  try {
    setDownloading(true);

    // 1 Tell the hidden FreightInvoice to render in PDF mode
    // If using a state in parent to control this, set it here
    // Example: setIsPdfExport(true);
    // But if you always render hidden FreightInvoice with isPdfExport={true}, skip this

    // 2 Wait for base64 images to be ready inside FreightInvoice
    //    We poll until all 3 base64 image strings are non-empty, or timeout after 5s
    await new Promise<void>((resolve) => {
      const maxWaitTime = 5000; // ms
      let waited = 0;
      const interval = setInterval(() => {
        // @ts-ignore - You can pass refs or use a parent state to check readiness
        const invoiceEl = invoiceRef.current;
        const imgs = invoiceEl?.querySelectorAll("img") || [];
        const allHaveSrc = Array.from(imgs).every(img => img.getAttribute("src"));
        if (allHaveSrc) {
          clearInterval(interval);
          resolve();
        } else if (waited >= maxWaitTime) {
          console.warn("Timeout: continuing PDF creation without confirming all images");
          clearInterval(interval);
          resolve();
        }
        waited += 100;
      }, 100);
    });

    // 3 Generate the PDF from the prepared DOM
    if (!invoiceRef.current) throw new Error("Invoice reference not found");

    const scale = 2; // Adjust scale to control resolution
    const canvas = await html2canvas(invoiceRef.current, { scale, useCORS: true });
    const imgData = canvas.toDataURL('image/png');

    const pdf = new jsPDF({
      orientation: 'portrait',
      unit: 'mm',
      format: 'a4',
    });

    // 4 Fit content to A4
    const pdfWidth = 210;
    const pdfHeight = 297;
    const imgWidth = canvas.width / scale;
    const imgHeight = canvas.height / scale;
    const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
    const imgX = (pdfWidth - imgWidth * ratio) / 2;
    const imgY = (pdfHeight - imgHeight * ratio) / 2;

    pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
    pdf.save(`${formData.party}-${new Date().toLocaleDateString('en-IN')}-invoice.pdf`);

    toast({ description: 'Invoice downloaded successfully.' });

    // 5 Save invoice data in backend
    const totalFreight = formData.freightCharges.reduce((total, charge) => total + Number(charge.amount), 0);
    const totalAdditionalCharges =
      formData.additionalCharges.reduce((total, charge) => total + Number(charge.amount), 0) +
      formData.extraAdditionalCharges.reduce((total, charge) => total + Number(charge.amount), 0);
    const totalPayments =
      formData.paymentDetails.reduce((total, payment) => total + Number(payment.amount), 0) +
      formData.extraPaymentDetails.reduce((total, payment) => total + Number(payment.amount), 0);

    const balance = Number(totalFreight) + Number(totalAdditionalCharges) - Number(totalPayments);

    const invData = {
      balance,
      dueDate: new Date(formData.dueDate),
      date: new Date(formData.date),
      invoiceNo: invoices?.length || 1,
      route: { origin: route.origin, destination: route.destination },
      party_id: party,
      gst: formData.gst || 0,
      invoiceStatus: balance === 0 ? 'Paid' : 'Due',
      trips: paramtrips,
      advance: totalPayments,
      total: totalFreight + totalAdditionalCharges,
    };

    await saveInvoice(invData, invoiceId);
    toast({ description: 'Invoice saved successfully.' });

    // 6 Navigate after success
    setTimeout(() => router.push('/user/trips'), 500);

  } catch (error) {
    console.error("Error in handleDownload:", error);
    toast({
      description: 'Failed to download invoice.',
      variant: 'destructive',
    });
  } finally {
    setDownloading(false);
    // If you control PDF mode with state, reset it here
    // setIsPdfExport(false);
  }
};




  if (loading) {
    return <Loading />
  }

  if (!trips) {
    return (
      <div className="flex h-screen items-center justify-center">
        <div className="text-center">
          <h2 className="text-2xl font-semibold mb-2">No Trips Found</h2>
          <Button onClick={() => router.push('/user/trips')}>Back to Trips</Button>
        </div>
      </div>
    )
  }

  return (
  <div className="h-screen flex flex-col">
    <ResizablePanelGroup
      direction="horizontal"
      className="flex-grow"
    >
      <ResizablePanel defaultSize={60} minSize={40}>
        <div className="h-full overflow-y-auto p-4 thin-scrollbar">
          <InvoiceForm
            trips={trips}
            formData={formData}
            setFormData={setFormData}
            setDeletedChargeIds={setDeletedChargeIds}
            setDeletedPaymentIds={setDeletedPaymentIds}
          />
        </div>
      </ResizablePanel>
      <ResizableHandle withHandle />
      <ResizablePanel
        defaultSize={40}
        minSize={20}
        maxSize={60}
        collapsible={true}
        collapsedSize={0}
        onCollapse={() => setIsCollapsed(true)}
        onExpand={() => setIsCollapsed(false)}
      >
        <div className="h-full flex flex-col">
          <div className="flex-grow overflow-y-auto p-4 thin-scrollbar">
            <div>
              <FreightInvoice formData={formData} />
            </div>
          </div>
          <div className="p-4">
            <Button
              onClick={handleDownload}
              disabled={downloading}
              className="w-full"
            >
              <Download className="mr-2 h-4 w-4" />
              {downloading ? 'Downloading...' : 'Download Invoice'}
            </Button>
          </div>
        </div>
      </ResizablePanel>
    </ResizablePanelGroup>

    {/* Only ONE modal block, not nested or duplicated */}
    <div className={`${!downloading ? 'hidden' : 'modal-class'}`}>
      <div className='z-50 fixed flex items-center justify-center modal-class text-white'>
        {loadingIndicator}
        <p>downloading pdf...</p>
      </div>
      <div
        style={{
          position: 'fixed',
          top: '-10000px',
          left: '-10000px',
        }}
        className="bg-white max-w-lg mx-auto"
        ref={invoiceRef}
      >
        <FreightInvoice formData={formData} isPdfExport={true} />
      </div>
    </div>
  </div>
  )
}

export default InvoiceGenerationPage
</file>

<file path="src/components/AddExpenseModal.tsx">
'use client'
import React, { Dispatch, useEffect, useMemo, useRef, useState } from 'react';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Button } from '@/components/ui/button';
import { fuelAndDriverChargeTypes, maintenanceChargeTypes, officeExpenseTypes } from '@/utils/utilArray';
import { IDriver, IExpense, ITrip } from '@/utils/interface';
import { motion } from 'framer-motion';
import { usePathname } from 'next/navigation';
import { statuses } from '@/utils/schema';
import DriverSelect from './trip/DriverSelect';
import ShopSelect from './shopkhata/ShopSelect';
import Image from 'next/image';
import PreviewDocument from './documents/PreviewDocument';
import { useToast } from './hooks/use-toast';
import { loadingIndicator } from './ui/LoadingIndicator';
import { X, FileText, ImageIcon } from 'lucide-react';
import { useExpenseData } from './hooks/useExpenseData';
import TruckExpenseWrapper from '@/app/user/expenses/page';
import AdExpenseTypeModal from './AdExpenseTypeModal';

interface ChargeModalProps {
    isOpen: boolean;
    onClose: () => void;
    onSave: any;
    driverId: string;
    selected?: any;
    categories: string[]
    tripId?: string
    truckNo?: string
    setDrafts?: any
}

interface TripExpense {
    id?: string;
    trip_id: string;
    partyBill: boolean;
    amount: number;
    date: Date;
    expenseType: string;
    notes?: string;
    partyAmount: number;
    paymentMode: string;
    transactionId: string;
    driver: string;
    truck?: string
    shop_id?: string
    url?: string
}

const AddExpenseModal: React.FC<ChargeModalProps> = ({ categories, isOpen, onClose, onSave, driverId, selected, tripId, truckNo, setDrafts }) => {

    const { trips: ctxTrips, drivers, shops, trucks, isLoading, error } = useExpenseData();

    const [formData, setFormData] = useState<TripExpense>({
        id: selected?._id || undefined,
        trip_id: selected?.trip_id ? selected.trip_id : tripId ? tripId : '',
        partyBill: false,
        amount: selected?.amount || 0,
        date: selected?.date ? new Date(selected.date) : new Date(),
        expenseType: selected?.expenseType || '',
        notes: selected?.notes || '',
        partyAmount: 0,
        paymentMode: selected?.paymentMode || 'Cash',
        transactionId: selected?.transaction_id || '',
        driver: selected?.driver || driverId || '',
        truck: selected?.truck || truckNo || '',
        shop_id: selected?.shop_id || '',
        url: selected?.url ? selected?.url : ''
    });

    const pathname = usePathname()
    const truckpage = pathname === '/user/expenses/truckExpense' || pathname.startsWith('/user/trucks/')
    const trippage = pathname === '/user/expenses/tripExpense' || pathname.startsWith('/user/trips/')
    const officepage = pathname === '/user/expenses/officeExpense'
    const draftpage = pathname === '/user/expenses/draft'
    const { toast } = useToast()


    const [selectedCategory, setSelectedCategory] = useState(truckpage ? 'Truck Expense' : trippage ? 'Trip Expense' : officepage ? 'Office Expense' : '');
    const [trip, setTrip] = useState<ITrip | undefined>()
    const [file, setFile] = useState<File | null>()
    const [fileUrl, setFileUrl] = useState<string | null>(selected?.url || null);
    const [modalOpen, setModalOpen] = useState(false)
    const [loading, setLoading] = useState(false)
    const [expenseTypeModal, setExpenseTypeModal] = useState(false)
    const [userExpenseTypes, setUserExpenseTypes] = useState<string[] | []>([])
    const modalRef = useRef<HTMLDivElement | null>(null)

    // useEffect(() => {
    //     const handleClickOutside = (event: MouseEvent) => {
    //       if (modalRef.current && !modalRef.current.contains(event.target as Node)) {
    //         onClose(); // Close modal if clicked outside
    //       }
    //     };
    
    //     if (isOpen) {
    //       document.addEventListener('mousedown', handleClickOutside);
    //     }
    
    //     return () => {
    //       document.removeEventListener('mousedown', handleClickOutside);
    //     };
    //   }, [isOpen, onClose]);
    

    const fetchUserExpenseTypes = async () => {
        try {
            const res = await fetch('/api/expenses/expenseType')
            const data = await res.json()
            setUserExpenseTypes(data.expenseTypes)

        } catch (error) {
            toast({
                description: "Failed to fetch some expense types",
                variant: "destructive"
            })
        }
    }

    useEffect(() => {
        fetchUserExpenseTypes()
    }, [])

    useEffect(() => {
        if (truckNo) {
            setSelectedCategory('Trip Expense');
        }
    }, [truckNo])

    const trips = useMemo(() => {
        let initialTrips = [...ctxTrips]
        if (tripId) {
            initialTrips = initialTrips.filter(trip => trip.trip_id === tripId)
        } else if (formData.truck && selectedCategory === 'Trip Expense') {
            initialTrips = initialTrips.filter(trip => trip.truck === formData.truck)
        }
        return initialTrips
    }, [formData.truck, selectedCategory, tripId])

    const filteredTrucks = useMemo(() => {
        if (formData.trip_id) {
            const selectedTrip = trips.find(t => t.trip_id === formData.trip_id);
            if (selectedTrip) {
                return trucks?.filter(truck => truck.truckNo === selectedTrip.truck) || [];
            }
        } else if (truckNo) {
            return trucks?.filter(truck => truck.truckNo === truckNo) || [];
        }
        return trucks || [];
    }, [trucks, formData.trip_id, trips, truckNo])

    const savetoDraft = async () => {
        setLoading(true)
        try {
            const formdata = new FormData()
            if (file) {
                formdata.append('file', file);
            }
            formdata.append('expense', JSON.stringify(formData))
            const res = await fetch('/api/expenses/draft', {
                method: 'POST',
                body: formdata
            })
            if (!res.ok) throw new Error('Failed to save draft')
            const data = await res.json()
            setDrafts((prev: IExpense[]) => [
                {
                    ...data.expense,
                    driverName: data.expense.driver ? drivers.find((driver) => driver.driver_id === data.expense.driver)?.driverName : '',
                    shopName: data.expense.shop_id ? shops.find((shop) => shop.id === data.expense.shop_id)?.shop_id : ''
                },
                ...prev,
            ])
            toast({
                description: 'saved draft',
            })
        } catch (error) {
            toast({
                description: 'Failed to save draft',
                variant: 'destructive'
            })
        } finally {
            setLoading(false)
            onClose()
        }
    }

    const saveDraft = async (id: string) => {
        if (!id) {
            toast({
                description: 'No draft selected',
                variant: 'destructive'
            })
        }
        setLoading(true)
        try {
            const formdata = new FormData()
            if (file) {
                formdata.append('file', file);
            }
            formdata.append('expense', JSON.stringify(formData))
            const res = await fetch(`/api/expenses/draft/${id}`, {
                method: 'PUT',
                body: formdata
            })
            if (!res.ok) throw new Error('Failed to save draft')
            const data = await res.json()
            if (data.status === 200) {
                setDrafts((prev: IExpense[] | any[]) => prev.map(exp => exp._id === id ? {
                    ...data.expense,
                    driverName: data.expense.driver ? drivers.find((driver) => driver.driver_id === data.expense.driver)?.driverName : '',
                    shopName: data.expense.shop_id ? shops.find((shop) => shop.id === data.expense.shop_id)?.shop_id : ''
                } : exp))
            }
        } catch (error) {
            toast({
                description: 'Failed to save draft',
                variant: 'destructive'
            })
        } finally {
            setLoading(false)
            onClose()
        }
    }

    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const selectedFile = e.target.files ? e.target.files[0] : null;
        setFile(selectedFile);

        if (selectedFile) {
            setFileUrl(URL.createObjectURL(selectedFile));
        } else if (typeof e.target.value === 'string' && e.target.value.startsWith('http')) {
            setFileUrl(e.target.value);
        } else {
            setFileUrl(null);
        }
    };


    const removeFile = () => {
        setFile(null);
        setFileUrl(null);
    };

    useEffect(() => {
        if (!selected) return;
        setFormData({
            id: selected?._id || undefined,
            trip_id: selected?.trip_id ? selected.trip_id : tripId ? tripId : '',
            partyBill: false,
            amount: selected?.amount || 0,
            date: selected?.date ? new Date(selected.date) : new Date(),
            expenseType: selected?.expenseType || '',
            notes: selected?.notes || '',
            partyAmount: 0,
            paymentMode: selected?.paymentMode || 'Cash',
            transactionId: selected?.transaction_id || '',
            driver: selected?.driver || '',
            truck: selected?.truck || truckNo || '',
            shop_id: selected?.shop_id || '',
        });
        if (selected.url) {
            setFileUrl(selected.url);
        }
    }, [selected]);

    const expenseTypes = useMemo(() => {
        setFormData((prev) => ({ ...prev, expenseType: "" }))
        if (selectedCategory === 'Truck Expense') return Array.from(maintenanceChargeTypes)
        else if (selectedCategory === 'Trip Expense') return Array.from(fuelAndDriverChargeTypes)
        else if (selectedCategory === 'Office Expense') return Array.from(officeExpenseTypes)
        if (selected) {
            if ((!selected.trip_id || selected.trip_id === '') && selected.truck) {
                setSelectedCategory('Truck Expense')
                return Array.from(maintenanceChargeTypes)
            }
            if (selected.trip_id && selected.trip_id !== '') {
                setSelectedCategory('Trip Expense')
                return Array.from(fuelAndDriverChargeTypes)
            }
            if ((!selected.trip_id || selected.trip_id === '') && (!selected.truck || selected.truck === '')) {
                setSelectedCategory('Office Expense')
                return officeExpenseTypes
            }
        }

        return []

    }, [selectedCategory, selected])

    const paymentModes = useMemo(() => {
        if (selectedCategory !== 'Office Expense') {
            return ['Cash', 'Online', 'Paid By Driver', 'Credit']
        } else return ['Cash', 'Online', 'Credit']
    }, [selectedCategory])




    useEffect(() => {
        if (formData.paymentMode === 'Paid By Driver' && trip) {
            setFormData((prevData) => ({ ...prevData, driver: trip.driver }));
        }
        if (formData.paymentMode !== 'Paid By Driver' && formData.driver) {
            setFormData((prevData) => ({ ...prevData, driver: '' }));
        }
        if (formData.paymentMode !== 'Credit' && formData.shop_id) {
            setFormData((prevData) => ({ ...prevData, shop_id: '' }));
        }
    }, [trip, formData.paymentMode])

    useEffect(() => {
        if (formData.truck && pathname === '/user/expenses/tripExpense') {
            let tempTrips = trips?.filter((trip) => trip.truck === formData.truck)
            setFormData((prev) => ({
                ...prev,
                trip_id: tempTrips ? tempTrips[0]?.trip_id : ''
            }))
            setTrip(tempTrips ? tempTrips[0] : undefined)
        }
    }, [formData.truck])

    const handleSelectChange = (name: string, value: string) => {
        setFormData((prevData) => {
            let updatedData = { ...prevData, [name]: value };

            if (name === 'trip_id') {
                const selectedTrip = trips?.find((trip) => trip.trip_id === value);
                if (selectedTrip && selectedTrip.truck) {
                    updatedData = { ...updatedData, truck: selectedTrip.truck };
                }
            }

            return updatedData;
        });
    };



    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => {
        const { name, value, type } = e.target;
        setFormData({ ...formData, [name]: type === 'checkbox' ? !formData.partyBill : value });
    };

    const handleSave = () => {
        if (selectedCategory === 'Truck Expense') setFormData((prev) => ({ ...prev, trip_id: '' }))
        else if (selectedCategory === 'Office Expense') setFormData((prev) => ({ ...prev, trip_id: '', truck: '' }))
        const missingFields = [];

        if (!formData.amount) missingFields.push("Amount");
        if (!formData.date) missingFields.push("Date");
        if (!formData.expenseType) missingFields.push("Expense Type");
        if (selectedCategory === 'Truck Expense' && !formData.truck) missingFields.push("Truck");
        if (selectedCategory === 'Trip Expense' && !formData.trip_id) missingFields.push("Trip");
        if (formData.paymentMode === 'Credit' && !formData.shop_id) missingFields.push("Shop");
        if (formData.paymentMode === 'Paid By Driver' && !formData.driver) missingFields.push("Driver");

        if (missingFields.length > 0) {
            toast({
                description: `Please fill in the following fields: ${missingFields.join(", ")}`,
                variant: 'warning'
            });
            return
        }

        if (formData.paymentMode !== 'Paid By Driver') setFormData(prev => ({ ...prev, driver: '' }))
        if (formData.paymentMode !== 'Credit') setFormData(prev => ({ ...prev, shop_id: '' }))


        if (selected) {
            onSave(formData, selected._id, file);
        } else {
            onSave(formData, '', file);
        }

        onClose();
    };

    const handleFocus = (e: React.FocusEvent<HTMLInputElement>) => {
        if (e.target.value === '0') {
            handleChange({ target: { name: e.target.name, value: '' } } as React.ChangeEvent<HTMLInputElement>);
        }
    };

    if (!isOpen) return null;

    return (
        <div
            className="modal-class"
        >
                <motion.div
                    initial={{ opacity: 0, scale: 0.5 }}
                    animate={{ opacity: 1, scale: 1 }}
                    transition={{
                        duration: 0.5,
                        ease: [0, 0.71, 0.2, 1.01]
                    }}
                    ref={modalRef}
                    className="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl max-h-[700px] overflow-y-auto thin-scrollbar"
                >
                    <h2 className="text-xl font-semibold mb-4">Add Expense</h2>
                    <div className="mb-6">
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                            Expense Receipt
                        </label>
                        <div className="flex items-center justify-center w-full">
                            <label htmlFor="dropzone-file" className="flex flex-col items-center justify-center w-full h-30 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                                <div className="flex flex-col items-center justify-center pt-2 pb-2">
                                    <svg className="w-8 h-8 mb-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                                        <path stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2" />
                                    </svg>
                                    <p className="mb-2 text-sm text-gray-500"><span className="font-semibold">Click to upload</span></p>
                                    <p className="text-xs text-gray-500">PDF, PNG, JPG or GIF (MAX. 800x400px)</p>
                                </div>
                                <input
                                    id="dropzone-file"
                                    type="file"
                                    className="hidden"
                                    accept="application/pdf,image/*"
                                    onChange={handleFileChange}
                                />
                            </label>
                        </div>
                    </div>

                    {fileUrl && (
                        <div className="mb-6 p-4 bg-gray-100 rounded-lg">
                            <div className="flex items-center justify-between mb-2">
                                <h3 className="text-lg font-semibold">File Preview</h3>
                                <Button
                                    variant="ghost"
                                    size="icon"
                                    onClick={removeFile}
                                    className="text-gray-500 hover:text-red-500"
                                >
                                    <X className="h-5 w-5" />
                                </Button>
                            </div>
                            <div className="bg-white rounded-lg shadow-md overflow-hidden">
                                {(fileUrl.match(/\.(jpeg|jpg|gif|png)$/) !== null || !fileUrl.endsWith('.pdf')) ? (
                                    <div className="relative h-48 w-full">
                                        <Image
                                            src={fileUrl}
                                            alt="Preview"
                                            layout="fill"
                                            objectFit="cover"
                                            className="rounded-t-lg"
                                        />
                                    </div>
                                ) : (
                                    <div className="h-48 flex items-center justify-center bg-gray-200">
                                        <FileText className="h-16 w-16 text-gray-400" />
                                    </div>
                                )}
                                <div className="p-4">
                                    <p className="text-sm text-gray-600 truncate">
                                        {file ? file.name : 'Document'}
                                    </p>
                                    <Button
                                        variant="outline"
                                        className="mt-2"
                                        onClick={() => setModalOpen(true)}
                                    >
                                        Open Document
                                    </Button>
                                </div>
                            </div>
                        </div>
                    )}

                    <PreviewDocument isOpen={modalOpen} onClose={() => setModalOpen(false)} documentUrl={fileUrl as string} />


                    <div className='flex justify-between gap-2'>
                        {categories &&
                            <div className="mb-4 w-full">
                                <label className="block text-sm font-medium text-gray-700">Select Category*</label>
                                <Select value={selectedCategory} onValueChange={(value) => setSelectedCategory(value)}>
                                    <SelectTrigger className="w-full">
                                        <SelectValue>{selectedCategory || 'Select Category'}</SelectValue>
                                    </SelectTrigger>
                                    <SelectContent>
                                        {categories.map((type) => (
                                            <SelectItem key={type} value={type}>{type}</SelectItem>
                                        ))}
                                    </SelectContent>
                                </Select>
                            </div>
                        }
                        <div className="mb-4 w-full">
                            <label className="block text-sm font-medium text-gray-700">Expense Type*</label>
                            <Select value={formData.expenseType} onValueChange={(value) => handleSelectChange('expenseType', value)}>
                                <SelectTrigger className="w-full">
                                    <SelectValue>{formData.expenseType || 'Select Expense Type'}</SelectValue>
                                </SelectTrigger>
                                <SelectContent>


                                    {selectedCategory && <>
                                        <Button className=' w-full my-2' onClick={() => {
                                            setExpenseTypeModal(true)
                                        }
                                        }>Add Your Own</Button>
                                        <p className='p-1 text-gray-500 text-xs border-b border-gray-300 mb-1'>Added by you</p>
                                        {userExpenseTypes?.map(type => (
                                            <SelectItem key={type} value={type}>{type}</SelectItem>
                                        ))}
                                        <p className='p-1 text-gray-500 text-xs border-b border-gray-300 mb-1'>By Awajahi</p>
                                        {expenseTypes.map((type) => (
                                            <SelectItem key={type} value={type}>{type}</SelectItem>
                                        ))}
                                    </>}

                                </SelectContent>
                            </Select>
                        </div>
                    </div>

                    <div className='flex items-center space-x-2 '>
                        <div className="mb-4 w-1/2">
                            <label className="block text-sm font-medium text-gray-700">Amount*</label>
                            <input
                                type="number"
                                name="amount"
                                value={formData.amount}
                                onChange={handleChange}
                                onFocus={handleFocus}
                                className="w-full p-2 border border-gray-300 rounded-md"
                            />
                        </div>

                        <div className="mb-4 w-1/2">
                            <label className="block text-sm font-medium text-gray-700">Date*</label>
                            <input
                                type="date"
                                name="date"
                                value={new Date(formData.date).toISOString().split('T')[0]}
                                onChange={handleChange}
                                onClick={(e) => (e.target as HTMLInputElement).showPicker()}
                                className="w-full p-2 border border-gray-300 rounded-md"
                            />
                        </div>
                    </div>

                    {selectedCategory !== 'Office Expense' && <div className='flex items-center space-x-2 '>
                        {selectedCategory === 'Trip Expense' && <div className="mb-4 w-1/2">
                            <label className="block text-sm font-medium text-gray-700">Select Trip*</label>
                            <Select value={formData.trip_id} defaultValue={formData.trip_id} onValueChange={(value) => handleSelectChange('trip_id', value)}>
                                <SelectTrigger className="w-full">
                                    <SelectValue placeholder='Select Trip' />
                                </SelectTrigger>
                                <SelectContent>
                                    {trips?.map((trip: ITrip) => (
                                        <SelectItem key={trip.trip_id} value={trip.trip_id}>
                                            <div className='flex items-center space-x-2 w-full'>
                                                <span className='font-semibold w-1/2'>{trip.route.origin.split(',')[0]} &rarr; {trip.route.destination.split(',')[0]}</span>
                                                <div className="flex flex-col items-center space-x-2 w-1/2">
                                                    <span>{statuses[trip.status as number]}</span>
                                                    <div className="relative w-full bg-gray-200 h-1 rounded">
                                                        <div
                                                            className={`absolute top-0 left-0 h-1 rounded transition-width duration-500 ${trip.status === 0 ? 'bg-red-500' : trip.status === 1 ? 'bg-yellow-500' : trip.status === 2 ? 'bg-blue-500' : trip.status === 3 ? 'bg-green-500' : 'bg-green-800'}`}
                                                            style={{ width: `${(trip.status as number / 4) * 100}%` }}
                                                        ></div>
                                                    </div>
                                                </div>
                                                <p className='whitespace-nowrap'>{trip.LR}</p>
                                            </div>
                                        </SelectItem>
                                    ))}
                                </SelectContent>
                            </Select>
                        </div>}

                        <div className="mb-4 w-1/2">
                            <label className="block text-sm font-medium text-gray-700">Select Truck*</label>
                            <Select value={formData.truck} onValueChange={(value) => handleSelectChange('truck', value)}>
                                <SelectTrigger className="w-full text-black" value={formData.truck}>
                                    <SelectValue placeholder='Select Truck' />
                                </SelectTrigger>
                                <SelectContent>
                                    {filteredTrucks?.map((truck) => (
                                        <SelectItem key={truck.truckNo} value={truck.truckNo}>
                                            <span>{truck.truckNo}</span>
                                            <span
                                                className={`ml-2 p-1 rounded ${truck.status === 'Available' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}
                                            >
                                                {truck.status}
                                            </span>
                                        </SelectItem>
                                    ))}
                                </SelectContent>
                            </Select>
                        </div>


                    </div>}

                    <label className="block text-sm font-medium text-gray-700">Payment Mode*</label>
                    <div className="flex flex-row w-full justify-start gap-3 mb-3">
                        {paymentModes.map((type) => (
                            <button
                                key={type}
                                type="button"
                                className={`p-2 rounded-md ${formData.paymentMode === type ? 'bg-bottomNavBarColor text-white' : 'bg-lightOrangeButtonColor text-black'}`}
                                onClick={() => handleChange({ target: { name: 'paymentMode', value: type } } as React.ChangeEvent<HTMLInputElement | HTMLSelectElement>)}
                            >
                                {type}
                            </button>
                        ))}
                    </div>

                    {formData.paymentMode === 'Paid By Driver' && (
                        <DriverSelect
                            drivers={drivers || []}
                            formData={formData}
                            handleChange={handleChange}
                            setFormData={setFormData}
                        />
                    )}

                    {formData.paymentMode === 'Online' && (
                        <div className="mb-4">
                            <input
                                type="text"
                                name="transactionId"
                                value={formData.transactionId}
                                onChange={handleChange}
                                className="w-full p-2 border border-gray-300 rounded-md"
                                placeholder="Transaction ID"
                            />
                        </div>
                    )}

                    {formData.paymentMode === 'Credit' && (
                        <ShopSelect
                            shops={shops} // Pass the shops array as a prop
                            formData={formData}
                            handleChange={handleChange}
                            setFormData={setFormData}
                        />
                    )}

                    {formData.partyBill && (
                        <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700">Party Amount</label>
                            <input
                                type="number"
                                name="partyAmount"
                                value={formData.partyAmount}
                                onChange={handleChange}
                                onFocus={handleFocus}
                                className="w-full p-2 border border-gray-300 rounded-md"
                            />
                        </div>
                    )}

                    <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700">Notes</label>
                        <textarea
                            name="notes"
                            value={formData.notes}
                            onChange={handleChange}
                            className="w-full p-2 border border-gray-300 rounded-md"
                        />
                    </div>
                    <div className={`${!selected || (draftpage && selected) ? 'flex justify-between' : ''}`}>
                        {!selected && <Button variant={'outline'} disabled={loading} onClick={() => savetoDraft()}>{loading ? loadingIndicator : 'Save as Draft'}</Button>}
                        {draftpage && selected && <Button variant={'outline'} disabled={loading} onClick={() => saveDraft(selected?._id)}>{loading ? loadingIndicator : 'Save Draft'}</Button>}
                        <div className="flex justify-end gap-2">
                            <Button variant="outline" disabled={loading} onClick={() => {
                                onClose()
                                setFormData({
                                    id: undefined,
                                    trip_id: '',
                                    partyBill: false,
                                    amount: 0,
                                    date: new Date(Date.now()),
                                    expenseType: '',
                                    notes: '',
                                    partyAmount: 0,
                                    paymentMode: 'Cash',
                                    transactionId: '',
                                    driver: '',
                                    truck: '',
                                    shop_id: '',
                                    url: ''
                                })
                                setSelectedCategory('')
                                setFile(null)
                                setFileUrl('')
                            }}>
                                Cancel
                            </Button>
                            <Button onClick={handleSave} disabled={loading}>
                                Save
                            </Button>
                        </div>
                    </div>

                </motion.div>
                <AdExpenseTypeModal open={expenseTypeModal} setOpen={setExpenseTypeModal} setExpenses={setUserExpenseTypes} />
            </div>
    );
};

export default AddExpenseModal;
</file>

<file path="src/components/trip/tripDetail/EditChargeModal.tsx">
import React, { useState } from 'react';
import { TripExpense } from '@/utils/interface';
import { Button } from '@/components/ui/button';
import { motion } from 'framer-motion';

interface EditChargeModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSave: (editedCharge: TripExpense) => void;
  charge: TripExpense;
}

const chargeType = [
  'Detention/Halting Charges',
  'Repair Expense',
  'Loading Charges',
  'Unloading Charges',
  'Union Charges',
  'Weight Charges',
  'Other Charges'
];

const deductionType = [
  'Material Loss',
  'Brokerage',
  'Late Fees',
  'TDS',
  'Mamul',
  'Other'
];

const EditChargeModal: React.FC<EditChargeModalProps> = ({ isOpen, onClose, onSave, charge }) => {
  const [editedCharge, setEditedCharge] = useState({
    _id: charge._id,
    trip_id: charge.trip_id,
    partyBill: charge.partyBill,
    amount: charge.amount || 0,
    date: new Date(charge.date),
    expenseType: charge.expenseType || '',
    notes: charge.notes || ''
  });

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => {
    const { name, value, type } = e.target;

    if (type === 'checkbox') {
      setEditedCharge({ ...editedCharge, [name]: !editedCharge.partyBill }); // Toggle the boolean value
    } else {
      setEditedCharge({ ...editedCharge, [name]: value });
    }
  };

  const handleSave = () => {
    onSave(editedCharge as any);
  };

  if (!isOpen) return null;

  return (
    <><div className="modal-class"></div><motion.div
      initial={{ opacity: 0, scale: 0.5 }}
      animate={{ opacity: 1, scale: 1 }}
      transition={{
        duration: 0.5,
        ease: [0, 0.71, 0.2, 1.01]
      }} className="fixed inset-0 flex items-center justify-center z-50">
      <div className="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl">
        <h2 className="text-xl font-semibold mb-4">Edit Charge</h2>
        <div className="mb-4">
          <label className="block text-sm font-medium text-gray-700">Add to Party Bill</label>
          <input
            type="checkbox"
            name="partyBill"
            checked={editedCharge.partyBill}
            onChange={handleChange}
            className="p-2 border border-gray-300 rounded-md" />
        </div>
        {editedCharge.partyBill ? (
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700">Expense Type</label>
            <select
              name="expenseType"
              value={editedCharge.expenseType}
              onChange={handleChange}
              className="w-full p-2 border border-gray-300 rounded-md"
            >
              <option value="">Select Expense Type</option>
              {chargeType.map((type) => (
                <option key={type} value={type}>{type}</option>
              ))}
            </select>
          </div>
        ) : (
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700">Expense Type</label>
            <select
              name="expenseType"
              value={editedCharge.expenseType}
              onChange={handleChange}
              className="w-full p-2 border border-gray-300 rounded-md"
            >
              <option value="">Select Deduction Type</option>
              {deductionType.map((type) => (
                <option key={type} value={type}>{type}</option>
              ))}
            </select>
          </div>
        )}
        <div className="mb-4">
          <label className="block text-sm font-medium text-gray-700">Amount</label>
          <input
            type="number"
            name="amount"
            value={editedCharge.amount}
            onChange={handleChange}
            className="w-full p-2 border border-gray-300 rounded-md" />
        </div>
        <div className="mb-4">
          <label className="block text-sm font-medium text-gray-700">Date</label>
              <input
            type="date"
            name="date"
            onClick={(e) => (e.target as HTMLInputElement).showPicker()}  
            value={editedCharge.date.toISOString().split('T')[0]}
            onChange={handleChange}
            className="w-full p-2 border border-gray-300 rounded-md" />
        </div>
        <div className="mb-4">
          <label className="block text-sm font-medium text-gray-700">Notes</label>
          <textarea
            name="notes"
            value={editedCharge.notes}
            onChange={handleChange}
            className="w-full p-2 border border-gray-300 rounded-md" />
        </div>
        <div className="flex justify-end gap-2">
          <Button

            onClick={handleSave}
          >
            Save
          </Button>
          <Button variant={'outline'}

            onClick={onClose}
          >
            Cancel
          </Button>
        </div>
      </div>
    </motion.div></>
  );
};

export default EditChargeModal;
</file>

<file path="src/components/trip/TripForm.tsx">
"use client"

import type React from "react"
import { useState, useEffect, useRef } from "react"
import { PartySelect } from "./PartySelect"
import TruckSelect from "./TruckSelect"
import DriverSelect from "./DriverSelect"
import RouteInputs from "./RouteInputs"
import { BillingInfo } from "./BillingInfo"
import { DateInputs } from "./DateInputs"
import type { TruckModel } from "@/utils/interface"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Checkbox } from "@/components/ui/checkbox"
import { formatNumber } from "@/utils/utilArray"
import { createWorker } from "tesseract.js"
import { Loader2 } from "lucide-react"
import { useToast } from "../hooks/use-toast"
import { useExpenseData } from "../hooks/useExpenseData"
import { MaterialInput } from "./MaterialInput"
import LoadingSlip from "./tripDetail/TripFunctions/LoadingSlip"

type Props = {
  lr: string
  duplicate: any
  onSubmit: (trip: any) => void
}

export default function TripForm({ onSubmit, lr, duplicate }: Props = { lr: "", duplicate: null, onSubmit: () => { } }) {
  const { trucks, parties, drivers, isLoading } = useExpenseData()

  const [formData, setFormData] = useState({
    party: duplicate?.party || JSON.parse(localStorage.getItem("tripData") as any)?.party || "",
    truck: duplicate?.truck || JSON.parse(localStorage.getItem("tripData") as any)?.truck || "",
    driver: duplicate?.driver || JSON.parse(localStorage.getItem("tripData") as any)?.driver || "",
    supplierId: duplicate?.supplier || JSON.parse(localStorage.getItem("tripData") as any)?.supplierId || "",
    partyName: '',
    route: {
      origin: duplicate?.route?.origin || "",
      destination: duplicate?.route?.destination || "",
    },
    billingType: duplicate?.billingTpe || "Fixed",
    perUnit: 0,
    totalUnits: 0,
    amount: duplicate?.amount || 0,
    startDate: duplicate?.startDate || new Date(),
    truckHireCost: duplicate?.truckHireCost || 0,
    LR: lr,
    fmNo: lr.replace("LRN", "FM"),
    material: duplicate?.material || [],
    notes: duplicate?.notes || "",
    file: null,
    ewbValidity: duplicate?.ewbValidity || null,
    guaranteedWeight: duplicate?.guaranteedWeight || '',
    loadingSlipDetails: {
      balance: 0,
      charges: undefined,
      haltingCharges: undefined,
      advance: undefined
    }
  })

  const [file, setFile] = useState<File | null>(null)
  const [showDetails, setShowDetails] = useState(false)
  const [selectedTruck, setSelectedTruck] = useState<TruckModel | undefined>(undefined)
  const [hasSupplier, setHasSupplier] = useState(false)
  const [fileLoading, setFileLoading] = useState(false)
  const MAX_FILE_SIZE = 5 * 1024 * 1024 // 5 MB in bytes
  const [loadingSlip, setLoadingSlip] = useState(false)
  const { toast } = useToast()

  const worker = useRef<null | any>(null)

  useEffect(() => {
    const initWorker = async () => {
      worker.current = await createWorker("eng")
    }
    initWorker()
    return () => {
      if (worker.current) worker.current.terminate()
    }
  }, [])

  useEffect(() => {
    const tripData = localStorage.getItem("tripData")
    if (tripData) {
      const savedItem = JSON.parse(tripData)
      setFormData((prev) => ({
        ...prev,
        ...savedItem,
      }))
    }
  }, [])

  useEffect(() => {
    const updatedTruck = trucks.find((truck) => truck.truckNo === formData.truck)
    setSelectedTruck(updatedTruck)
    setFormData((prev) => ({
      ...prev,
      driver: updatedTruck?.driver_id ? updatedTruck?.driver_id : "",
      supplierId: updatedTruck?.supplier ? updatedTruck?.supplier : "",
    }))
    setHasSupplier(!!updatedTruck?.supplier)
  }, [formData.truck, trucks])

  useEffect(() => {
    if (formData.billingType !== "Fixed") {
      const newAmount = Number.parseFloat(formData.perUnit as any) * Number.parseFloat(formData.totalUnits as any)
      setFormData((prevFormData) => ({
        ...prevFormData,
        amount: newAmount,
      }))
    }
  }, [formData.billingType, formData.perUnit, formData.totalUnits])

  useEffect(() => {
    setFormData((prev) => {
      const { advance = 0, charges = 0, haltingCharges = 0, balance } = prev.loadingSlipDetails ?? {};

      return {
        ...prev,
        loadingSlipDetails: {
          ...prev.loadingSlipDetails,
          balance: Number(sanitizeInput(prev.amount.toString())) - Number(advance) + Number(charges) + Number(haltingCharges),
        },
      };
    });
  }, [
    formData.loadingSlipDetails?.advance,
    formData.loadingSlipDetails?.charges,
    formData.loadingSlipDetails?.haltingCharges,
    formData.amount
  ]);


  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const uploadedFile = e.target.files?.[0]
    if (!uploadedFile) return

    if (uploadedFile.size > MAX_FILE_SIZE) {
      toast({
        description: `File size exceeds the maximum limit of ${MAX_FILE_SIZE / (1024 * 1024)} MB.`,
        variant: "warning",
      })
      return
    }

    setFile(uploadedFile)
    setFormData((prev: any) => ({
      ...prev,
      file: uploadedFile,
    }))

    await processFileUpload(uploadedFile)
  }

  const processFileUpload = async (file: File) => {
    try {
      setFileLoading(true)
      const isPdf = file.type === "application/pdf"
      const resData = await processFile(file, isPdf)
      processTripData(resData.ewbValidityDate)
    } catch (error: any) {
      toast({
        description: `Failed to extract details from E-Way Bill`,
        variant: "warning",
      })
      console.error("Error processing e-way bill:", error)
    } finally {
      setFileLoading(false)
    }
  }

  const processFile = async (file: File, isPdf: boolean) => {
    if (!isPdf) {
      const text = await extractTextFromImage(file)
      const res = await fetch(`/api/trips/getEwaybillDetails/text`, {
        method: "POST",
        headers: {
          "Content-Type": "text/plain",
          Accept: "application/json",
        },
        body: text,
      })
      if (!res.ok) throw new Error("Failed to process file")
      return await res.json()
    } else {
      const data = new FormData()
      data.append("file", file)
      const res = await fetch(`/api/trips/getEwaybillDetails`, {
        method: "POST",
        body: data,
      })
      if (!res.ok) throw new Error("Failed to process file")
      return await res.json()
    }
  }

  const extractTextFromImage = async (file: File): Promise<string> => {
    if (!worker.current) return ""
    const {
      data: { text },
    } = await worker.current.recognize(file)
    return text
  }

  const processTripData = (tripData: any) => {
    if (!tripData) return

    const driverId = trucks.find((truck) => truck.truckNo === tripData.truckNo)?.driver_id

    setFormData((prev) => ({
      ...prev,
      startDate: new Date(tripData.startDate),
      route: {
        origin: tripData?.origin?.split("\n")[0],
        destination: tripData?.destination?.split("\n")[0],
      },
      truck: tripData.truckNo,
      ewbValidity: tripData.validity,
      driver: driverId,
    }))
  }

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => {
    const { name, value } = e.target

    if (name.includes("route.")) {
      const routeField = name.split(".")[1]
      setFormData((prevState) => ({
        ...prevState,
        route: {
          ...prevState.route,
          [routeField]: value,
        },
      }))
    } else if (name === 'party') {
      setFormData((prevState) => ({
        ...prevState,
        [name]: value,
        partyName: parties.find(party => party.party_id === value).name || ''
      }))
    }
    else {
      setFormData((prevState) => ({
        ...prevState,
        [name]: value,
      }))
    }
  }

  const handleLoadingSlipChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => {
    const { name, value } = e.target
    setFormData(prev => ({
      ...prev,
      loadingSlipDetails: {
        ...prev.loadingSlipDetails,
        [name]: value,
      }
    }))
  }

  const sanitizeInput = (value: string) => {
    const sanitizedValue = Number.parseFloat(value.replace(/,/g, "").trim())
    return !isNaN(Number(sanitizedValue)) ? sanitizedValue : null
  }


  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault()


    const sanitizedAmount = sanitizeInput(formData.amount.toString())
    const sanitizedTruckHireCost = sanitizeInput(formData.truckHireCost.toString())
    const sanitizedPerUnit = sanitizeInput(formData.perUnit.toString())
    const sanitizedTotalUnits = sanitizeInput(formData.totalUnits.toString())

    if (sanitizedAmount === null || sanitizedTruckHireCost === null) {
      toast({
        description: "Please enter valid numeric values for Amount and Truck Hire Cost.",
        variant: "warning",
      })
      return
    }

    if (!formData.supplierId && !formData.driver) {
      toast({
        description: "Driver Needs to be assigned!",
        variant: "warning",
      })
      return
    }

    if (
      !formData.party ||
      !formData.truck ||
      !formData.amount ||
      !formData.route.origin ||
      !formData.route.destination ||
      !formData.LR
    ) {
      toast({
        description: "Please fill in the required fields",
        variant: "warning",
      })
      return
    }

    onSubmit({
      ...formData,
      amount: sanitizedAmount,
      truckHireCost: sanitizedTruckHireCost,
      perUnit: sanitizedPerUnit,
      totalUnits: sanitizedTotalUnits,
      material: formData.material,
      guaranteedWeight: formData.guaranteedWeight,
    })

    localStorage.removeItem("tripData")
  }

  if (isLoading)
    return (
      <div className="flex justify-center items-center h-screen">
        <Loader2 className="text-bottomNavBarColor animate-spin" />
      </div>
    )

  return (
    <div className="bg-white text-black p-4 max-w-3xl mx-auto shadow-md rounded-md">
      <div className="mb-4">
        <LoadingSlip trip={formData} charges={formData.loadingSlipDetails.charges} haltingCharges={formData.loadingSlipDetails.haltingCharges} />
      </div>

      <div className="mb-4 flex items-center space-x-4">
        <div className="flex-grow">
          <label className="block text-xs font-medium text-gray-700 mb-1">E-Way Bill</label>
          <input
            type="file"
            accept=".pdf,image/*"
            onChange={handleFileChange}
            disabled={fileLoading}
            className="w-full"
          />
          {fileLoading && <Loader2 className="animate-spin mt-2 justify-center text-bottomNavBarColor" />}
        </div>
        <div className="flex-shrink-0 w-1/3">
          <label className="block text-xs font-medium text-gray-700 mb-1">EWB Validity Date</label>
          <input
            type="date"
            name="ewbValidity"
            onClick={(e) => (e.target as HTMLInputElement).showPicker()}
            value={formData.ewbValidity ? new Date(formData.ewbValidity).toISOString().split("T")[0] : ""}
            onChange={handleChange}
            className="w-full"
          />
        </div>
      </div>

      <form className="space-y-3" onSubmit={handleSubmit}>
        <BillingInfo formData={formData} handleChange={handleChange} setFormData={setFormData} />
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <PartySelect parties={parties} formData={formData} handleChange={handleChange} />
          <TruckSelect trucks={trucks} formData={formData} handleChange={handleChange} setFormData={setFormData} suppliers={[]} />
        </div>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <DriverSelect drivers={drivers} formData={formData} handleChange={handleChange} setFormData={setFormData} />
          <DateInputs formData={formData} handleChange={handleChange} />
        </div>
        <div className="z-50">
          <RouteInputs formData={formData} handleChange={handleChange} />
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label className="block text-xs font-medium text-gray-700 mb-1">Lorry Recipt No*</label>
            <Input type="text" name="LR" value={formData.LR} placeholder="LR No" onChange={handleChange} />
          </div>
          <div>
            <label className="block text-xs font-medium text-gray-700 mb-1">Freight Memo No</label>
            <Input type="text" name="fmNo" value={formData.fmNo} placeholder="FM No" onChange={handleChange} />
          </div>
        </div>

        <div className="flex items-center space-x-2">
          <Checkbox id="showDetails" checked={showDetails} onCheckedChange={() => setShowDetails(!showDetails)} />
          <label
            htmlFor="showDetails"
            className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
          >
            Add More Details
          </label>
        </div>



        {showDetails && (
          <>
            <MaterialInput
              materials={formData.material}
              onChange={(materials) => setFormData((prev) => ({ ...prev, material: materials }))}
              guaranteedWeight={formData.guaranteedWeight}
              onGuaranteedWeightChange={(weight) => setFormData((prev) => ({ ...prev, guaranteedWeight: weight }))}
            />
            <div className="mb-4">
              <label className="block text-xs font-medium text-gray-700 mb-1">Notes</label>
              <textarea
                name="notes"
                value={formData.notes}
                placeholder="Notes"
                onChange={handleChange}
                className="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
          </>
        )}

        <div className="flex items-center space-x-2">
          <Checkbox id="showDetails" checked={loadingSlip} onCheckedChange={() => setLoadingSlip(!loadingSlip)} />
          <label
            htmlFor="showDetails"
            className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
          >
            Loading Slip Details
          </label>
        </div>

        {
          loadingSlip && (
            <div className="grid grid-cols-2 gap-2">
              <div className="mb-4">
                <label>Advance to be paid</label>
                <input
                  type="number"
                  name="advance"
                  value={formData.loadingSlipDetails.advance}
                  placeholder="Advance"
                  onChange={handleLoadingSlipChange} />
              </div>
              <div className="mb-4">
                <label>Halting Charges</label>
                <input
                  type="number"
                  name="haltingCharges"
                  value={formData.loadingSlipDetails.haltingCharges}
                  placeholder="Halting Charges"
                  onChange={handleLoadingSlipChange} />
              </div>
              <div className="mb-4">
                <label>Other Charges</label>
                <input
                  type="number"
                  name="charges"
                  value={formData.loadingSlipDetails.charges}
                  placeholder="Other Charges"
                  onChange={handleLoadingSlipChange} />
              </div>
              <div className="mb-4">
                <label>Balance</label>
                <input
                  type="number"
                  name="balance"
                  value={formData.loadingSlipDetails.balance}
                  placeholder="Balance"
                  onChange={handleLoadingSlipChange} />
              </div>

            </div>


          )
        }



        {hasSupplier && (
          <div className="mb-4">
            <label className="block text-xs font-medium text-gray-700 mb-1">Truck Hire Cost</label>
            <Input
              type="text"
              name="truckHireCost"
              value={formatNumber(formData.truckHireCost)}
              placeholder="Truck Hire Cost"
              onChange={handleChange}
            />
          </div>
        )}

        <Button className="w-full hover:scale-100 mt-4" type="submit" disabled={fileLoading}>
          Submit
        </Button>
      </form>

    </div>
  )
}
</file>

<file path="src/components/trip/DateInputs.tsx">
import React from "react";

export const DateInputs: React.FC<{
  formData: any;
  handleChange: (
    e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>
  ) => void;
}> = ({ formData, handleChange }) => (
  <div>
    <label className="block text-xs font-medium text-gray-700 mb-1">
      Start Date*
    </label>
    <input
      type="date"
      name="startDate"
      onClick={(e) => (e.target as HTMLInputElement).showPicker()}
      // keep the date as string, no timezone conversion
      value={
        formData.startDate
          ? typeof formData.startDate === "string"
            ? formData.startDate
            : new Date(formData.startDate).toISOString().split("T")[0]
          : ""
      }
      onChange={(e) =>
        handleChange({
          target: {
            name: "startDate",
            value: e.target.value, // preserve as plain 'YYYY-MM-DD' string
          },
        } as any)
      }
      required
      className="w-full border border-gray-300 rounded-md p-2"
    />
  </div>
);
</file>

<file path="src/components/trip/EditTripForm.tsx">
"use client"

import type React from "react"
import { useState, useEffect, useCallback, useMemo } from "react"
import { PartySelect } from "./PartySelect"
import TruckSelect from "./TruckSelect"
import DriverSelect from "./DriverSelect"
import RouteInputs from "./RouteInputs"
import type { ITrip, TruckModel} from "@/utils/interface"
import { DateInputs } from "./DateInputs"
import { Button } from "../ui/button"
import { Loader2, X } from "lucide-react"
import { motion } from "framer-motion"
import { BillingInfo } from "./BillingInfo"
import { useToast } from "../hooks/use-toast"
import { useExpenseData } from "../hooks/useExpenseData"
import { MaterialInput } from "./MaterialInput"

type Props = {
  trip: ITrip
  onSubmit: (tripData: any) => void
  onClose: () => void
  isOpen: boolean
}

const EditTripForm: React.FC<Props> = ({ onSubmit, trip, onClose, isOpen }) => {
  const { parties, trucks, drivers, suppliers, isLoading } = useExpenseData()
  const { toast } = useToast()

  const [formData, setFormData] = useState(() => ({
    party: trip?.party || "",
    truck: trip?.truck || "",
    driver: trip?.driver || "",
    route: { origin: trip?.route?.origin || "", destination: trip?.route?.destination || "" },
    billingType: trip?.billingType || "Fixed",
    amount: trip?.amount || 0,
    startDate: new Date(trip?.startDate),
    truckHireCost: trip?.truckHireCost || 0,
    LR: trip?.LR || "",
    fmNo: trip?.fmNo,
    material: trip?.material || [],
    notes: trip?.notes || "",
    ewbValidity: trip?.documents?.find((doc) => doc.type === "E-Way Bill")?.validityDate || null,
    totalUnits: trip?.units || 0,
    perUnit: trip?.rate || 0,
    guaranteedWeight: trip.guaranteedWeight || '',
  }))

  const [showDetails, setShowDetails] = useState(false)
  const [selectedTruck, setSelectedTruck] = useState<TruckModel | undefined>(undefined)
  const [hasSupplier, setHasSupplier] = useState(false)

  useEffect(() => {
    const updatedTruck = trucks.find((truck) => truck.truckNo === formData.truck)
    setSelectedTruck(updatedTruck)
    setHasSupplier(!!updatedTruck?.supplier)
  }, [formData.truck, trucks])

  const handleChange = useCallback(
    (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => {
      const { name, value } = e.target

      setFormData((prevState) => {
        if (name.includes("route.")) {
          const routeField = name.split(".")[1] as "origin" | "destination"
          return {
            ...prevState,
            route: {
              ...prevState.route,
              [routeField]: value,
            },
          }
        } else {
          return {
            ...prevState,
            [name]: value,
          }
        }
      })
    },
    [],
  )

  const handleSubmit = useCallback(
    (e: React.FormEvent) => {
      e.preventDefault()
      if (formData.amount - (trip.amount - trip.balance) < 0) {
        toast({
          description: "Pending is Negative",
          variant: "warning",
        })
      }
      const sanitizeInput = (value: string) => {
        const sanitizedValue = Number.parseFloat(value.replace(/,/g, "").trim())
        return !isNaN(Number(sanitizedValue)) ? sanitizedValue : null
      }

      const sanitizedAmount = sanitizeInput(formData.amount.toString())
      onSubmit({ ...formData, units: formData.totalUnits, rate: formData.perUnit, amount: Number(sanitizedAmount) })
    },
    [formData, onSubmit, trip.amount, trip.balance, toast],
  )

  const handleMaterialChange = useCallback((materials: { name: string; weight: string }[]) => {
    setFormData((prev) => ({ ...prev, material: materials }))
  }, [])

  const handleGuaranteedWeightChange = useCallback((weight: string) => {
    setFormData((prev) => ({ ...prev, guaranteedWeight: weight || ''}))
  }, [])

  const memoizedPartySelect = useMemo(
    () => <PartySelect parties={parties} formData={formData} handleChange={handleChange} />,
    [parties, formData, handleChange],
  )

  const memoizedTruckSelect = useMemo(
  () => (
    <TruckSelect
      trucks={trucks}
      suppliers={suppliers}   // <-- Added here
      formData={formData}
      handleChange={handleChange}
      setFormData={setFormData}
    />
  ),
  [trucks, suppliers, formData, handleChange, selectedTruck, hasSupplier]
)

  const memoizedDriverSelect = useMemo(
    () => <DriverSelect drivers={drivers} formData={formData} handleChange={handleChange} setFormData={setFormData} />,
    [drivers, formData, handleChange],
  )

  if (!isOpen) {
    return null
  }
  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-full">
        <Loader2 className="animate-spin text-bottomNavBarColor" />
      </div>
    )
  }

  return (
    <div className="modal-class">
      <motion.div
        initial={{ opacity: 0, scale: 0.5 }}
        animate={{ opacity: 1, scale: 1 }}
        transition={{
          duration: 0.5,
          ease: [0, 0.71, 0.2, 1.01],
        }}
        className="relative bg-white p-6 rounded-lg shadow-lg w-full max-w-3xl max-h-[700px] overflow-y-auto thin-scrollbar"
      >
        <Button variant={"outline"} onClick={() => onClose()} className="absolute right-0 top-0 border-0 rounded-none">
          <X size={15} />
        </Button>

        <form className="space-y-4" onSubmit={handleSubmit}>
          <BillingInfo formData={formData} handleChange={handleChange} setFormData={setFormData} />
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {memoizedPartySelect}
            {memoizedTruckSelect}
          </div>

          {memoizedDriverSelect}

          <RouteInputs formData={formData} handleChange={handleChange} />

          <div className="grid grid-cols-2 gap-2">
            <div>
              <label className="block text-xs font-medium text-gray-700 mb-1">EWB Validity</label>
          <input
            type="date"
            name="ewbValidity"
            onClick={(e) => (e.target as HTMLInputElement).showPicker()}
                value={formData.ewbValidity ? new Date(formData.ewbValidity).toISOString().split("T")[0] : ""}
                onChange={handleChange}
                className="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
          </div>
          <DateInputs formData={formData} handleChange={handleChange} />

          <div className="grid grid-cols-2 gap-2">
            <div>
              <label className="block text-xs font-medium text-gray-700 mb-1">LR No</label>
              <input
                type="text"
                className="w-full p-2 border border-gray-300 rounded-md"
                name="LR"
                value={formData.LR}
                onChange={handleChange}
                placeholder="LR No"
              />
            </div>
            <div>
              <label className="block text-xs font-medium text-gray-700 mb-1">FM No</label>
              <input
                type="text"
                className="w-full p-2 border border-gray-300 rounded-md"
                name="fmNo"
                value={formData.fmNo}
                onChange={handleChange}
                placeholder="FM No"
              />
            </div>
          </div>

          <div>
            <label className="flex items-center text-sm font-medium text-gray-700">
              <input
                type="checkbox"
                className="mr-2"
                checked={showDetails}
                onChange={() => setShowDetails(!showDetails)}
              />
              Edit More Details
            </label>
          </div>

          {showDetails && (
            <>
              <MaterialInput
                materials={formData.material}
                onChange={handleMaterialChange}
                guaranteedWeight={formData.guaranteedWeight}
                onGuaranteedWeightChange={handleGuaranteedWeightChange}
              />
              <div className="mb-4">
                <label className="block text-xs font-medium text-gray-700 mb-1">Notes</label>
                <textarea
                  name="notes"
                  value={formData.notes}
                  placeholder="Notes"
                  onChange={handleChange}
                  className="w-full p-2 border border-gray-300 rounded-md"
                />
              </div>
            </>
          )}

          {hasSupplier && (
            <>
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">Truck Hire Cost</label>
                <input
                  type="text"
                  className="w-full p-2 border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-lightOrange transition-all duration-300"
                  value={formData.truckHireCost}
                  name="truckHireCost"
                  onChange={handleChange}
                  placeholder="Truck Hire Cost"
                />
              </div>
            </>
          )}
        </form>
        <div className="p-4 bg-white border-t flex items-center justify-end gap-2">
          <Button onClick={() => onClose()} variant={"outline"}>
            Cancel
          </Button>
          <Button className="" type="submit" onClick={handleSubmit}>
            Submit
          </Button>
        </div>
      </motion.div>
    </div>
  )
}

export default EditTripForm
</file>

<file path="src/components/trip/tripDetail/DataList.tsx">
import React, { useEffect, useState } from 'react';
import Modal from './Modal';
import { ITrip, PaymentBook } from '@/utils/interface';
import { MdDelete, MdEdit } from 'react-icons/md';
import { Button } from '@/components/ui/button';
import { formatNumber } from '@/utils/utilArray';
import { PiPlusBold } from 'react-icons/pi';
import { useTrip } from '@/context/tripContext';
import { useToast } from '@/components/hooks/use-toast';

interface DataListProps {
  label: string;
  modalTitle: string;
  displayLabel?: string | React.ReactNode;
  onTotalAdvanceChange?: (total: number) => void;
}

const DataList: React.FC<DataListProps> = ({ label, modalTitle, displayLabel, onTotalAdvanceChange }) => {
  const { trip, setTrip } = useTrip();
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editData, setEditData] = useState<PaymentBook | null>(null);
  const [listData, setListData] = useState<PaymentBook[]>([]);
  const [expandedItem, setExpandedItem] = useState<number | null>(null);
  const { toast } = useToast();
const [totalAdvance, setTotalAdvance] = useState<number>(0);

  // Destructure displayLabel properly here
  const labelToDisplay = displayLabel || label;

// useEffect(() => {
//   const temp = trip.tripAccounts.filter(
//     (account: PaymentBook) =>
//       account &&
//       account.accountType &&
//       account.accountType.toLowerCase() === label.toLowerCase()
//   );
//   const sortedData = temp.sort(
//     (a: PaymentBook, b: PaymentBook) =>
//       new Date(b.date).getTime() - new Date(a.date).getTime()
//   );
//   setListData(sortedData);

//   const totalAdvanceAmount = sortedData.reduce(
//     (accumulator: number, current: PaymentBook) => accumulator + (current.amount ?? 0),
//     0
//   );
//   setTotalAdvance(totalAdvanceAmount);

//   if (onTotalAdvanceChange) {
//     onTotalAdvanceChange(totalAdvanceAmount);
//   }
// }, [trip, label]);

useEffect(() => {
  if (!trip?.tripAccounts) return;

  // Determine the correct account type (Advances or Payments)
  const accountType =
    label.toLowerCase() === 'payments' ? 'Payments' : 'Advances';

  const filtered = trip.tripAccounts.filter(
    (account: PaymentBook) =>
      account?.accountType?.toLowerCase() === accountType.toLowerCase()
  );

  const sortedData = filtered.sort(
    (a: PaymentBook, b: PaymentBook) =>
      new Date(b.date).getTime() - new Date(a.date).getTime()
  );

  setListData(sortedData);

  const totalAmount = sortedData.reduce(
    (acc: number, curr: PaymentBook) => acc + (curr.amount || 0),
    0
  );

  setTotalAdvance(totalAmount);

  if (onTotalAdvanceChange) {
    onTotalAdvanceChange(totalAmount);
  }
}, [trip.tripAccounts, label]);


  const handleAddItem = async (newItem: any) => {
    const itemtosend = {
      ...newItem,
      trip_id: trip.trip_id,
      driver_id: newItem.receivedByDriver ? trip.driver : null
    }
    try {
      const res = await fetch(`/api/parties/${trip.party}/payments`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(itemtosend),
      });
      if (!res.ok) {
        throw new Error('Failed to add new item');
      }
      const resData = await res.json();
      if (resData.status == 400) {
        toast({description : resData.message, variant : 'destructive'});
        return;
      }

      setTrip((prev: ITrip | any) => ({
        ...prev,
        balance: prev.balance - newItem.amount,
        tripAccounts : [resData.payment, ...prev.tripAccounts]
      }))
      toast({
        description : 'Payment Added Successfully'
      })
      setIsModalOpen(false);
      // setTrip();
      // router.refresh();
    } catch (error) {
      toast({
        title : 'Internal Server Error',
        description : 'Failed to add payment',
        variant : 'destructive'
      })
      console.log(error);
    }
  };

  const handleEditItem = async (editedItem: any) => {
    try {
      const res = await fetch(`/api/parties/${trip.party}/payments/${editedItem.id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          ...editedItem,
          driver_id: editedItem.receivedByDriver === true ? trip.driver : null
        }),
      });
      if (!res.ok) {
        throw new Error('Failed to edit item');
      }

      const resData = await res.json();

      if (resData.status == 400) {
        toast({description : resData.message, variant : 'destructive'});
        return;
      }

      setTrip((prev: ITrip | any) => ({
        ...prev,
        balance: editData ? prev.balance + editData?.amount as number - editedItem.amount : prev.balance,
        tripAccounts : prev.tripAccounts.map((acc: any) => acc._id === resData.payment._id? resData.payment : acc),
      }))
      toast({
        description : 'Edited Sucessfully'
      })
      setEditData(null);
      setIsModalOpen(false);
    } catch (error) {
      toast({
        title : 'Internal Server Error',
        description : 'Failed to edit payment',
        variant : 'destructive'
      })
      console.log(error);
    }
  };

  const handleDeleteItem = async (item: PaymentBook) => {
    try {
      const res = await fetch(`/api/parties/${trip.party}/payments/${item._id}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        }
      });
      if (!res.ok) {
        throw new Error('Failed to delete item');
      }
      const resData = await res.json();
      setTrip((prev: ITrip | any) => ({
        ...prev,
        balance: prev.balance + item.amount,
        tripAccounts : prev.tripAccounts.filter((acc: any) => acc._id!== item._id),
      }))
      toast({
        description : 'Deleted Successfully'
      })
      // router.refresh();
    } catch (error) {
      toast({
        title : 'Internal Server Error',
        description : 'Failed to delete payment',
        variant : 'destructive'
      })
      console.log(error);
    }
  };

  const toggleItemExpansion = (index: number) => {
    setExpandedItem((prev) => (prev === index ? null : index));
  };

  const openAddModal = () => {
    if(trip.balance <= 0){
      toast({description : 'Trip Balance is zero', variant : 'warning'});
      return
    }
    setEditData(null);
    setIsModalOpen(true);
  };

  const openEditModal = (item: PaymentBook) => {
    setEditData(item);
    setIsModalOpen(true);
  };

  const closeModal = () => {
    setIsModalOpen(false);
    setEditData(null);
  };

  return (
    <div className="mt-6">
      {/* <div className="flex items-center justify-between mb-4">
        <h3 className="text-lg font-semibold text-gray-800">{labelToDisplay}</h3> 
        <Button
          className="rounded-full flex items-center w-8 h-8 p-0"
          onClick={openAddModal}
          aria-label={`Add ${label}`}
          disabled={trip.status == 4}
        >
          <PiPlusBold color='white' size={20} />
        </Button>
      </div> */}
      <div className="flex items-center justify-between mb-4">
  <div className="flex-1">
    {typeof labelToDisplay === 'string' ? (
      <h3 className="text-lg font-semibold text-gray-800">{labelToDisplay}</h3>
    ) : (
      <div className="text-lg font-semibold text-gray-800 w-full">
        {labelToDisplay}
      </div>
    )}
  </div>
  <Button
    className="rounded-full flex items-center w-8 h-8 p-0"
    onClick={openAddModal}
    aria-label={`Add ${label}`}
    disabled={trip.status == 4}
  >
    <PiPlusBold color="white" size={20} />
  </Button>
</div>

      {!listData || listData.length === 0 ? (
        <p className="text-sm text-gray-500">No {label.toLowerCase()} available.</p>
      ) : (
        <div className="bg-white shadow-lg rounded-lg divide-y divide-gray-200">
          {listData.map((item, index) => (
            <div
              key={index}
              className="flex flex-col px-4 py-4 hover:bg-gray-50 transition duration-300 ease-in-out transform hover:scale-105 rounded-lg cursor-pointer"
              onClick={() => toggleItemExpansion(index)}
            >
              <div className="flex items-center justify-between">
                <div className="flex-1">
                  <p className="text-sm font-medium text-gray-900">Amount: {formatNumber(item.amount)}</p>
                  <p className="text-xs text-gray-600">{item.paymentType}</p>
                </div>
                <div className="text-right">
                  <p className="text-xs text-gray-600">Date: {new Date(item.date).toLocaleDateString()}</p>
                </div>
              </div>
              {expandedItem === index && (
                <div className="mt-4 bg-gray-100 p-4 rounded-md border border-gray-300">
                  <p className="text-xs text-gray-600">
                    Received by Driver: {item.driver_id ? 'Yes' : 'No'}
                  </p>
                  {item.notes && (
                    <p className="text-xs text-gray-600 mb-2">Notes: {item.notes}</p>
                  )}
                  <div className="mt-2 flex justify-end gap-2">
                    <Button
                      variant={'ghost'}
                      onClick={() => openEditModal(item)}
                      disabled={trip.status == 4}
                      className="flex items-center justify-center p-2 hover:bg-gray-200"
                    >
                      <MdEdit size={20} />
                    </Button>
                    <Button
                      variant={'ghost'}
                      onClick={() => handleDeleteItem(item)}
                      disabled={trip.status == 4}
                      className="flex items-center justify-center p-2 hover:bg-gray-200"
                    >
                      <MdDelete size={20} />
                    </Button>
                  </div>
                </div>
              )}
            </div>
          ))}
        </div>
      )}
      <Modal
        isOpen={isModalOpen}
        onClose={closeModal}
        onSave={handleAddItem}
        modalTitle={modalTitle}
        accountType={label}
      />
      {editData && (
        <Modal
          isOpen={!!editData}
          onClose={closeModal}
          onSave={handleEditItem}
          modalTitle={`Edit ${label.slice(0,label.length - 1)}`}
          accountType={label}
          editData={editData}
        />
      )}
    </div>
  );
};

export default DataList;
</file>

<file path="src/components/trip/tripDetail/TripFunctions/InoiveForm.tsx">
'use client'

import React, { useEffect, useState } from "react"
import { Button } from "@/components/ui/button"
import { Plus, Trash2 } from 'lucide-react'
import { useToast } from "@/components/hooks/use-toast"
import ChargeModal from "../ChargeModal"
import { v4 as uuidv4 } from 'uuid'
import { InvoiceFormData as FormData } from '@/utils/interface'
import { formatNumber } from "@/utils/utilArray"
import InvoicePaymentModal from "./InvoicePaymentModal"
import { Input } from "@/components/ui/input"
import { Checkbox } from "@/components/ui/checkbox";


type Props = {
    setShow?: React.Dispatch<React.SetStateAction<boolean>>,
    trips: any[],
    formData: FormData,
    setFormData: React.Dispatch<React.SetStateAction<FormData>>
    setDeletedChargeIds: React.Dispatch<React.SetStateAction<string[]>>
    setDeletedPaymentIds: React.Dispatch<React.SetStateAction<string[]>>
}


export default function InvoiceForm({ setShow, trips, formData, setFormData, setDeletedChargeIds, setDeletedPaymentIds }: Props) {
    const [showInvoice, setShowInvoice] = useState(false)
    const [user, setUser] = useState<any>(null)
    const { toast } = useToast()
    const [chargeModalOpen, setChargeModalOpen] = useState(false)
    const [paymentModalOpen, setPaymentModalOpen] = useState(false)


    const addAddtionalCharge = (data: any) => {


        setFormData((prev: any) => ({
            ...prev,
            extraAdditionalCharges: [
                {
                    ...data,
                    date: new Date(data.date).toISOString(),
                    id: uuidv4(),
                    truckNo: trips.find(trip => trip.trip_id === data.trip_id).truck,
                },
                ...prev.extraAdditionalCharges
            ]

        }))
    }

    const deleteAddtionalCharge = (id: string) => {
        setFormData(prev => ({
            ...prev,
            extraAdditionalCharges: prev.extraAdditionalCharges.filter((item: any) => item.id !== id)
        }))
    }

    const saveAddtionalPayment = (data: any) => {

        setFormData(prev => ({
            ...prev,
            extraPaymentDetails: [
                data,
                ...prev.extraPaymentDetails
            ]
        }))
    }

    const fetchUser = async () => {
        try {
            const [res] = await Promise.all([fetch('/api/users')])
            if (!res.ok) {
                toast({
                    description: 'Failed to fetch Details',
                    variant: 'destructive'
                })
                return
            }
            const data = await res.json()
            const user = data.user
            setUser(user)
            setFormData((prev) => ({
                ...prev,
                companyName: user.company,
                address: user.address,
                phone: user.phone,
                gstin: user.gstNumber,
                logoUrl: user.logoUrl,
                pincode: user.pincode,
                email: user.email,
                city: user.city,
                pan: user.panNumber,
                stampUrl: user.stampUrl,
                signatureUrl: user.signatureUrl,
                altPhone : user.altPhone || "",
                partyDetails: {
                    ...prev.partyDetails,
                    msmeNo: user.bankDetails?.msmeNo || '',
                    gstin: user.gstNumber || '',
                    pan: user.panNumber || '',
                    accNo: user.bankDetails?.accountNo || '',
                    ifscCode: user.bankDetails?.ifscCode || '',
                    bankName: user.bankDetails?.bankName || '',
                    bankBranch: user.bankDetails?.bankBranch || '',
                }
            }));



        } catch (error) {
            alert('Failed to fetch User Details')
        }
    }

    useEffect(() => {
        fetchUser()
    }, [trips]);

    const handleInputChange = (section: keyof FormData, field: string, value: string) => {
        setFormData(prev => ({
            ...prev,
            [section]: typeof prev[section] === 'object' && !Array.isArray(prev[section])
                ? { ...prev[section] as object, [field]: value }
                : value
        }))
    }

    const handleArrayInputChange = (
        section: 'freightCharges' | 'additionalCharges' | 'paymentDetails' | 'extraAdditionalCharges' | 'extraPaymentDetails',
        index: number,
        field: string,
        value: string | number
    ) => {
        setFormData(prev => ({
            ...prev,
            [section]: prev[section].map((item, i) =>
                i === index ? { ...item, [field]: value, edited: true } : item
            )
        }))
    }

    const addRow = (section: 'freightCharges' | 'additionalCharges' | 'paymentDetails') => {
        setFormData(prev => ({
            ...prev,
            [section]: [
                ...prev[section],
                section === 'freightCharges'
                    ? { lrNo: '', lorryNo: '', particulars: '', weight: '', charges: '', rate: '', amount: '' }
                    : section === 'additionalCharges'
                        ? { sNo: prev[section].length + 1, lorryNo: '', particulars: '', remarks: '', amount: '' }
                        : { sNo: prev[section].length + 1, date: '', paymentMode: '', notes: '', amount: '' }
            ]
        }))
    }

    const removeRow = (section: 'freightCharges' | 'additionalCharges' | 'paymentDetails' | 'extraPaymentDetails', index: number, id: string) => {
        if (section === 'freightCharges') {
            setDeletedChargeIds((prev) => {
                return prev.length === 0 ? [id] : [...prev, id]
            })
        } else if (section === 'paymentDetails') {
            setDeletedPaymentIds((prev) => {
                return prev.length === 0 ? [id] : [...prev, id]
            })
        }
        setFormData(prev => ({
            ...prev,
            [section]: prev[section].filter((_, i) => i !== index)
        }))
    }

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        setShowInvoice(true);
    }

    return (
        <div>
            {!showInvoice ? (
                <form className="space-y-6" onSubmit={handleSubmit}>
                    {/* Invoice Details */}
                    <div className="grid grid-cols-3 gap-4 p-4 bg-gray-100 rounded-lg">
                        <div className="space-y-2">
                            <label htmlFor="billNo">Bill No.</label>
                            <input
                                id="billNo"
                                value={formData.billNo}
                                onChange={(e) => handleInputChange('billNo', 'billNo', e.target.value)}
                                className="rounded-lg text-xs"
                            />
                        </div>
                        <div className="space-y-2">
                            <label htmlFor="date">Invoice Date</label>
                            <input
                                id="date"
                                type="date"
                                value={formData.date}
                                onChange={(e) => handleInputChange('date', 'date', e.target.value)}
                                className="rounded-lg text-xs"
                            />
                        </div>
                        <div className="space-y-2">
                            <label htmlFor="to">To</label>
                            <input
                                id="to"
                                value={formData.from}
                                onChange={(e) => handleInputChange('to', 'to', e.target.value)}
                                className="rounded-lg text-xs"
                            />
                        </div>
                        <div className="space-y-2">
                            <label htmlFor="from">From</label>
                            <input
                                id="from"
                                value={formData.to}
                                onChange={(e) => handleInputChange('from', 'from', e.target.value)}
                                className="rounded-lg text-xs"
                            />
                        </div>
                        <div className="space-y-2">
                            <label htmlFor="branch">Invoicing Branch</label>
                            <input
                                id="branch"
                                value={formData.branch}
                                onChange={(e) => handleInputChange('branch', 'branch', e.target.value)}
                                className="rounded-lg text-xs"
                            />
                        </div>
                        <div className="space-y-2">
                            <label htmlFor="address">Address</label>
                            <input
                                id="address"
                                value={formData.address}
                                onChange={(e) => handleInputChange('address', 'address', e.target.value)}
                                className="rounded-lg text-xs"
                            />
                        </div>
                        <div className="space-y-2">
                            <label htmlFor="particulars">Particulars</label>
                            <input
                                id="particulars"
                                value={formData.particulars}
                                onChange={(e) => handleInputChange('particulars', 'particulars', e.target.value)}
                                className="rounded-lg text-xs"
                            />
                        </div>
                        <div className="space-y-2">
                            <label htmlFor="party">Party</label>
                            <input
                                id="party"
                                value={formData.party}
                                onChange={(e) => handleInputChange('party', 'party', e.target.value)}
                                className="rounded-lg text-xs"
                            />
                        </div>
                        <div className="space-y-2">
  <label htmlFor="startDate">Trip Start Date</label>
  <input
    type="date"
    id="dueDate"
    value={formData.dueDate || new Date().toISOString().split("T")[0]} // yyyy-mm-dd for input
    onChange={(e) => handleInputChange("dueDate", "dueDate", e.target.value)}
    className="rounded-lg text-xs"
  />
</div>

                        {/* <div className="space-y-2">
                            <label htmlFor="dueDate">Due Date</label>
                            <input
                                type="date"
                                id="dueDate"
                                value={
                                new Date(
                                    formData.startDate || formData.dueDate || new Date()
                                ).toISOString().split("T")[0]
                                }
                                onChange={(e) => {
                                const value = e.target.value;
                                // Update both startDate and dueDate to keep them in sync
                                handleInputChange("startDate", "startDate", value);
                                handleInputChange("dueDate", "dueDate", value);
                                }}
                                className="rounded-lg text-xs"
                            />
                        </div> */}

                        <div className="space-y-2">
 <div className="flex items-center gap-4">
  <label htmlFor="gst" className="font-semibold">
    GST (%)
  </label>

  <label className="flex items-center gap-1">
    <Checkbox
      checked={formData.gstType === "IGST"}
      onCheckedChange={() =>
        setFormData(prev => ({
          ...prev,
          gstType: prev.gstType === "IGST" ? "" : "IGST"
        }))
      }
    />
    <span>IGST</span>
  </label>

  <label className="flex items-center gap-1">
    <Checkbox
      checked={formData.gstType === "SGST + CGST"}
      onCheckedChange={() =>
        setFormData(prev => ({
          ...prev,
          gstType: prev.gstType === "SGST + CGST" ? "" : "SGST + CGST"
        }))
      }
    />
    <span>SGST + CGST</span>
  </label>
</div>


  <div>
    <input
      type="number"
      id="gst"
      value={formData.gst}
      onChange={(e) => handleInputChange("gst", "gst", e.target.value)}
      className="rounded-lg text-xs w-full"
      onFocus={() => setFormData((prev) => ({ ...prev, gst: undefined }))}
      placeholder="Enter GST value"
    />
  </div>
</div>


                        <div>
                            <label>color</label>
                            <Input type='color' value={formData.color} onChange={(e)=>setFormData((prev)=>({...prev,color : e.target.value}))}/>
                        </div>

                    </div>

                    {/* Freight Charges */}
                    <div className="space-y-2 p-4 bg-gray-100 rounded-lg">
                        <h3 className="font-semibold text-sm">Freight Charges</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full border-collapse text-xs">
                                <thead>
                                    <tr>
                                        <th className="p-2">LR No.</th>
                                        <th className="p-2">Lorry No.</th>
                                        <th className="p-2">Particulars</th>
                                        <th className="p-2">Weight(MT)</th>
                                        <th className="p-2">Charged(MT)</th>
                                        <th className="p-2">Rate(MT)</th>
                                        <th className="p-2">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {formData.freightCharges.map((charge, index) => (
                                        <tr key={index}>
                                            <td className="p-2"><input disabled value={charge.lrNo} /></td>
                                            <td className="p-2"><input disabled value={charge.truckNo} /></td>
                                            <td className="p-2"><input disabled value={charge.material} /></td>
                                            <td className="p-2"><input disabled value={charge.weight} /></td>
                                            <td className="p-2"><input disabled value={charge.charged} /></td>
                                            <td className="p-2"><input disabled value={charge.rate} /></td>
                                            <td className="p-2"><input disabled value={formatNumber(charge.amount)} /></td>
                                        </tr>

                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Additional Charges */}
                    <div className="space-y-2 p-4 bg-gray-100 rounded-lg">
                        <h3 className="font-semibold text-sm">Additional Charges</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full border-collapse text-xs">
                                <thead>
                                    <tr>
                                        <th className="p-2">S.No</th>
                                        <th className="p-2">Date</th>
                                        <th className="p-2">Lorry No.</th>
                                        <th className="p-2">Particulars</th>
                                        <th className="p-2">Remarks</th>
                                        <th className="p-2">Amount(MT)</th>
                                        <th className="p-2"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {formData.additionalCharges.length > 0 && formData.additionalCharges?.map((charge, index) => (
                                        <tr key={index}>
                                            <td className="p-2">{index + 1}</td>
                                            <td className="p-2"><input type="date" value={new Date(charge.date).toISOString().split('T')[0]} onChange={(e) => handleArrayInputChange('additionalCharges', index, 'date', e.target.value)} /></td>
                                            <td className="p-2"><input type="text" value={charge.truckNo} onChange={(e) => handleArrayInputChange('additionalCharges', index, 'lorryNo', e.target.value)} /></td>
                                            <td className="p-2"><input type="text" value={charge.expenseType} onChange={(e) => handleArrayInputChange('additionalCharges', index, 'expenseType', e.target.value)} /></td>
                                            <td className="p-2"><input type="text" value={charge.notes} onChange={(e) => handleArrayInputChange('additionalCharges', index, 'notes', e.target.value)} /></td>
                                            <td className="p-2"><input type="number" value={charge.amount} onChange={(e) => handleArrayInputChange('additionalCharges', index, 'amount', e.target.value)} /></td>
                                            <td className="p-2">
                                                <Button
                                                    type="button"
                                                    variant="destructive"
                                                    size="sm"
                                                    onClick={() => {
                                                        setDeletedChargeIds((prev) => ([
                                                            ...prev,
                                                            charge.id
                                                        ]))
                                                        setFormData((prev) => ({
                                                            ...prev,
                                                            additionalCharges: prev.additionalCharges.filter((_, i) => i !== index),
                                                        }))
                                                    }}
                                                >
                                                    <Trash2 className="h-4 w-4" />
                                                </Button>
                                            </td>
                                        </tr>
                                    ))}
                                    {formData.extraAdditionalCharges.length > 0 && formData.extraAdditionalCharges?.map((charge, index) => (
                                        <tr key={index}>
                                            <td className="p-2">{index + 1}</td>
                                            <td className="p-2"><input type="date" value={new Date(charge.date).toISOString().split('T')[0]} onChange={(e) => handleArrayInputChange('extraAdditionalCharges', index, 'date', e.target.value)} /></td>
                                            <td className="p-2"><input type="text" value={charge.truckNo} onChange={(e) => handleArrayInputChange('extraAdditionalCharges', index, 'lorryNo', e.target.value)} /></td>
                                            <td className="p-2"><input type="text" value={charge.expenseType} onChange={(e) => handleArrayInputChange('extraAdditionalCharges', index, 'expenseType', e.target.value)} /></td>
                                            <td className="p-2"><input type="text" value={charge.notes} onChange={(e) => handleArrayInputChange('extraAdditionalCharges', index, 'notes', e.target.value)} /></td>
                                            <td className="p-2"><input type="number" value={charge.amount} onChange={(e) => handleArrayInputChange('extraAdditionalCharges', index, 'amount', e.target.value)} /></td>
                                            <td className="p-2">
                                                <Button
                                                    type="button"
                                                    variant="destructive"
                                                    size="sm"
                                                    onClick={() => deleteAddtionalCharge(charge.id)}
                                                >
                                                    <Trash2 className="h-4 w-4" />
                                                </Button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        <div className="flex items-center justify-center">
                            <Button
                                type="button"
                                variant="outline"
                                size="sm"
                                onClick={() => setChargeModalOpen(true)}
                                className="rounded-full flex justify-center"
                            >
                                <Plus className="h-4 w-4" />
                            </Button>
                        </div>

                    </div>

                    {/* Party Details */}
                    <div className="space-y-2 p-4 bg-gray-100 rounded-lg">
                        <h3 className="font-semibold text-sm">Party Details</h3>
                        <div className="grid grid-cols-3 gap-4">
                            {Object.entries(formData.partyDetails).map(([key, value]) => (
                                <div key={key} className="space-y-2">
                                    <label htmlFor={key}>{key.toUpperCase()}</label>
                                    <input
                                        id={key}
                                        value={value}
                                        onChange={(e) => handleInputChange('partyDetails', key, e.target.value)}
                                        className="rounded-lg text-xs"
                                    />
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Payment Details */}
                    <div className="space-y-2 p-4 bg-gray-100 rounded-lg">
                        <h3 className="font-semibold text-sm">Payment Details</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full border-collapse text-xs">
                                <thead>
                                    <tr>
                                        <th className="p-2">S.No</th>
                                        <th className="p-2">Date</th>
                                        <th className="p-2">Payment Mode</th>
                                        <th className="p-2">Notes</th>
                                        <th className="p-2">Amount</th>
                                        <th className="p-2"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {formData.paymentDetails.map((payment, index) => (
                                        <tr key={index}>
                                            <td className="p-2">{index + 1}</td>
                                            <td className="p-2">
                                                <input
                                                    type="date"
                                                    value={new Date(payment.date).toISOString().split('T')[0]}
                                                    onChange={(e) => handleArrayInputChange('paymentDetails', index, 'date', e.target.value)}
                                                    className="rounded-lg"
                                                />
                                            </td>
                                            <td className="p-2">
                                                <input
                                                    value={payment.paymentType}
                                                    onChange={(e) => handleArrayInputChange('paymentDetails', index, 'paymentMode', e.target.value)}
                                                    className="rounded-lg"
                                                />
                                            </td>
                                            <td className="p-2">
                                                <input
                                                    value={payment.notes}
                                                    onChange={(e) => handleArrayInputChange('paymentDetails', index, 'notes', e.target.value)}
                                                    className="rounded-lg"
                                                />
                                            </td>
                                            <td className="p-2">
                                                <input
                                                    value={payment.amount}
                                                    onChange={(e) => handleArrayInputChange('paymentDetails', index, 'amount', e.target.value)}
                                                    className="rounded-lg"
                                                />
                                            </td>
                                            <td className="p-2">
                                                <Button
                                                    type="button"
                                                    variant="destructive"
                                                    size="icon"
                                                    onClick={() => {
                                                        removeRow('paymentDetails', index, payment.id)
                                                        setDeletedPaymentIds((prev) => [
                                                            payment.id,
                                                            ...prev
                                                        ])
                                                    }

                                                    }
                                                >
                                                    <Trash2 className="h-4 w-4" />
                                                </Button>
                                            </td>
                                        </tr>
                                    ))}
                                    {formData.extraPaymentDetails.map((payment, index) => (
                                        <tr key={index}>
                                            <td className="p-2">{index + 1}</td>
                                            <td className="p-2">
                                                <input
                                                    type="date"
                                                    value={new Date(payment.date).toISOString().split('T')[0]}
                                                    onChange={(e) => handleArrayInputChange('extraPaymentDetails', index, 'date', e.target.value)}
                                                    className="rounded-lg"
                                                />
                                            </td>
                                            <td className="p-2">
                                                <input
                                                    value={payment.paymentType}
                                                    onChange={(e) => handleArrayInputChange('extraPaymentDetails', index, 'paymentMode', e.target.value)}
                                                    className="rounded-lg"
                                                />
                                            </td>
                                            <td className="p-2">
                                                <input
                                                    value={payment.notes}
                                                    onChange={(e) => handleArrayInputChange('extraPaymentDetails', index, 'notes', e.target.value)}
                                                    className="rounded-lg"
                                                />
                                            </td>
                                            <td className="p-2">
                                                <input
                                                    value={payment.amount}
                                                    onChange={(e) => handleArrayInputChange('extraPaymentDetails', index, 'amount', e.target.value)}
                                                    className="rounded-lg"
                                                />
                                            </td>
                                            <td className="p-2">
                                                <Button
                                                    type="button"
                                                    variant="destructive"
                                                    size="icon"
                                                    onClick={() => removeRow('extraPaymentDetails', index, payment.id)}
                                                >
                                                    <Trash2 className="h-4 w-4" />
                                                </Button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        <div className="flex items-center justify-center">
                            <Button
                                type="button"
                                variant="outline"
                                size="sm"
                                onClick={() => setPaymentModalOpen(true)}
                                className="rounded-full"
                            >
                                <Plus className="h-4 w-4" />
                            </Button>
                        </div>

                    </div>
                </form>
            ) : (
                null
            )}

            <ChargeModal trips={trips} isOpen={chargeModalOpen} onClose={() => setChargeModalOpen(false)} onSave={(data: any) => addAddtionalCharge(data)} />
            <InvoicePaymentModal isOpen={paymentModalOpen} onClose={() => setPaymentModalOpen(false)} onSave={saveAddtionalPayment} trips={trips} />
        </div>
    )
}
</file>

<file path="src/services/expiryCheckService.ts">
// services/expiryCheckService.ts

import { models, model, Mongoose } from 'mongoose';
import { connectToDatabase, driverSchema, tripSchema, truckSchema } from "@/utils/schema";
import { sendNotificationToUser } from '@/services/notificationService'; // Your existing service

/**
* Finds all documents from a specific collection that are expiring on a specific day in the future.
* This is an internal helper function for this service.
* @param modelName - The name of the Mongoose model.
* @param schema - The Mongoose schema for the model.
* @param projectionFields - The fields to include from the parent document.
* @param entityType - A string identifier for the entity type (e.g., "Truck").
* @param daysUntilExpiry - The number of days from now that the document is expiring.
*/
// services/expiryCheckService.ts

// services/expiryCheckService.ts

async function findExpiringDocuments(
  modelName: string,
  schema: any,
  projectionFields: Record<string, number>,
  entityType: string,
  daysUntilExpiry: number
) {
  const Model = models[modelName] || model(modelName, schema);

  // --- START OF IST-SPECIFIC FIX ---

  // 1. Define the IST offset in milliseconds (5 hours and 30 minutes)
  const IST_OFFSET_MS = (5 * 60 + 30) * 60 * 1000;

  // 2. Get the current date and calculate the target date based on UTC
  const now = new Date();
  const targetDate = new Date(now);
  targetDate.setUTCDate(now.getUTCDate() + daysUntilExpiry);

  // 3. Calculate the start and end of the target day in PURE UTC
  const utcTargetStart = new Date(Date.UTC(
    targetDate.getUTCFullYear(),
    targetDate.getUTCMonth(),
    targetDate.getUTCDate(),
    0, 0, 0, 0
  ));

  const utcTargetEnd = new Date(Date.UTC(
    targetDate.getUTCFullYear(),
    targetDate.getUTCMonth(),
    targetDate.getUTCDate(),
    23, 59, 59, 999
  ));

  // 4. Adjust the UTC start and end times to match IST's day boundaries
  // An IST day starts at 18:30Z on the previous day. So we subtract the offset.
  const istTargetDateStart = new Date(utcTargetStart.getTime() - IST_OFFSET_MS);
  const istTargetDateEnd = new Date(utcTargetEnd.getTime() - IST_OFFSET_MS);

  // --- END OF IST-SPECIFIC FIX ---


  console.log(`[${entityType}] Checking for expiry on ${targetDate.toDateString()} (${daysUntilExpiry} days from now)`);
  // Use the adjusted IST boundaries for the query and logs
  console.log(`[${entityType}] Date range: ${istTargetDateStart.toISOString()} to ${istTargetDateEnd.toISOString()}`);

  return Model.aggregate([
    // The rest of your aggregation pipeline remains the same
    {
      $match: {
        "documents": {
          $elemMatch: {
            // Query with the correct IST-based date range
            "validityDate": { $gte: istTargetDateStart, $lte: istTargetDateEnd }
          }
        }
      }
    },
    { $unwind: "$documents" },
    {
      $match: {
        "documents.validityDate": { $gte: istTargetDateStart, $lte: istTargetDateEnd },
      }
    },
    {
      $project: {
        ...projectionFields,
        user_id: 1,
        documentName: "$documents.filename",
        validityDate: "$documents.validityDate",
        entityType: { $literal: entityType },
        daysUntilExpiry: { $literal: daysUntilExpiry }
      }
    }
  ]);
}

/**
* Creates a user-friendly time phrase based on the number of days
* @param days - The number of days until expiry.
*/
function getTimePhrase(days: number): string {
  switch (days) {
    case 1:
      return "tomorrow";
    case 3:
      return "in 3 days";
    case 7:
      return "in 1 week";
    case 30:
      return "in 1 month";
    default:
      return `in ${days} days`;
  }
}

/**
* This is the main function the cron job will trigger.
* It orchestrates fetching documents for multiple expiry intervals and sending notifications.
*/
export async function handleDailyExpiryCheck() {
  console.log("Starting daily expiry check for multiple intervals...");
  await connectToDatabase();

  const checkIntervals = [1, 3, 7, 30]; // Check for 1 day, 3 days, 1 week, and 1 months
  const allPromises = [];

  // 1. Create a list of all promises for all entities and all intervals
  for (const days of checkIntervals) {
    console.log(`Queueing checks for documents expiring in ${days} day(s)...`);
    allPromises.push(findExpiringDocuments("Trip", tripSchema, { LR: 1 }, "Trip", days));
    allPromises.push(findExpiringDocuments("Truck", truckSchema, { truckNo: 1 }, "Truck", days));
    allPromises.push(findExpiringDocuments("Driver", driverSchema, { name: 1 }, "Driver", days));
  }

  // Execute all queries in parallel and flatten the results
  const allRemindersNested = await Promise.all(allPromises);
  const allReminders = allRemindersNested.flat();

  console.log(`Found ${allReminders.length} total reminders across all intervals`);

  if (allReminders.length === 0) {
    const message = "No documents found for any expiry interval. Job finished.";
    console.log(message);
    return { success: true, message };
  }

  // 2. Send individual notifications for each reminder (better UX)
  const data = { screen: "reminders" };
  let successCount = 0;
  let failureCount = 0;
  const userNotificationCounts = new Map<string, number>();

  for (const reminder of allReminders) {
    const userId = reminder.user_id.toString();
    const timePhrase = getTimePhrase(reminder.daysUntilExpiry);

    // Create a specific title and body for each reminder
    let title = 'Document Expiry Reminder';
    let bodyMessage = ` Your document`;

    if (reminder.entityType === 'Truck') {
      title = 'Truck Document Expiry';
      bodyMessage += ` for Truck '${reminder.truckNo}'`;
    } else if (reminder.entityType === 'Driver') {
      title = 'Driver Document Expiry';
      bodyMessage += ` for Driver '${reminder.name}'`;
    } else if (reminder.entityType === 'Trip') {
      title = 'Trip Document Expiry';
      bodyMessage += ` for Trip LR '${reminder.LR}'`;
    }

    bodyMessage += ` expires ${timePhrase}.`;

    try {
      await sendNotificationToUser(userId, {
        title: title,
        body: bodyMessage,
        data: data
      });
      
      successCount++;
      userNotificationCounts.set(userId, (userNotificationCounts.get(userId) || 0) + 1);
      
      console.log(` Notification sent to user ${userId}: ${title}`);
    } catch (error) {
      failureCount++;
      console.error(` Failed to send notification to user ${userId}:`, error);
    }
  }

  const uniqueUsers = userNotificationCounts.size;
  const finalMessage = `Sent ${successCount} individual notifications to ${uniqueUsers} users across ${checkIntervals.length} intervals. ${failureCount} failures.`;
  console.log(finalMessage);
  return { success: true, message: finalMessage };
}
</file>

<file path="src/app/contact/page.tsx">
import Navigation from '@/components/Navigation';
import Footer from '@/components/Footer';
import Image from 'next/image';
import logo from '@/assets/awajahi logo.png';
import { MdEmail, MdPhone, MdLocationOn, MdAccessTime } from 'react-icons/md';

export default function Contact() {
  return (
    <div className="w-full overflow-x-hidden text-black">
      <Navigation />

      <main className="container mx-auto px-4 py-16">
        <div className="max-w-4xl mx-auto">
          <div className="text-center mb-12">
            <Image
              src={logo}
              alt="Awajahi Logo"
              width={150}
              height={150}
              className="mx-auto mb-6"
            />
            <h1 className="text-4xl font-bold mb-4 text-[#FE8631]">Contact Us</h1>
            <p className="text-xl text-gray-600">
  Get in touch with us. We&apos;d love to hear from you!
</p>

          </div>

          <div className="bg-white p-8 rounded-lg shadow-md max-w-4xl mx-auto">
            <h2 className="text-2xl font-semibold mb-8 text-[#FE8631] text-center">Contact Information</h2>
            <div className="grid md:grid-cols-4 gap-6">
              <div className="text-center">
                <div className="bg-[#FE8631] bg-opacity-10 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                  <MdEmail className="text-[#FE8631] text-3xl" />
                </div>
                <h3 className="text-lg font-semibold text-gray-800 mb-2">Email</h3>
                <p className="text-gray-600">info@awajahi.com</p>
              </div>
              <div className="text-center">
                <div className="bg-[#FE8631] bg-opacity-10 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                  <MdPhone className="text-[#FE8631] text-3xl" />
                </div>
                <h3 className="text-lg font-semibold text-gray-800 mb-2">Phone</h3>
                <p className="text-gray-600">+91 7999658438</p>
              </div>
              <div className="text-center">
                <div className="bg-[#FE8631] bg-opacity-10 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                  <MdAccessTime className="text-[#FE8631] text-3xl" />
                </div>
                <h3 className="text-lg font-semibold text-gray-800 mb-2">Business Hours</h3>
                <div className="text-gray-600 text-sm">
                  <p>Mon-Fri: 9AM-6PM</p>
                  <p>Sat: 9AM-2PM</p>
                  <p>Sun: Closed</p>
                </div>
              </div>
              <div className="text-center">
                <div className="bg-[#FE8631] bg-opacity-10 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                  <MdLocationOn className="text-[#FE8631] text-3xl" />
                </div>
                <h3 className="text-lg font-semibold text-gray-800 mb-2">Address</h3>
                <p className="text-gray-600">Noida</p>
              </div>
            </div>
          </div>

          <div className="mt-12 bg-gradient-to-r from-[#FE8631] to-[#FFC499] p-8 rounded-lg text-white text-center">
            <h2 className="text-3xl font-bold mb-4">Need Immediate Assistance?</h2>
            <p className="text-lg mb-6">
              For urgent inquiries, call our support line or email us directly.
            </p>
            <p className="text-lg font-semibold">
              Support Hotline: +91 7999658438
            </p>
          </div>
        </div>
      </main>

      <Footer />
    </div>
  );
}
</file>

<file path="src/app/user/trucks/create/page.tsx">
// CreateTruck.tsx
'use client'

import React, { useState, useEffect } from 'react';
import { minitruck, openBody, closedContainer, trailer, truckTypes } from '@/utils/utilArray';
import { validateTruckNo } from '@/utils/validate';
import { useRouter, useSearchParams } from 'next/navigation';
import SupplierSelect from '@/components/truck/SupplierSelect';
import AdditionalDetails from '@/components/truck/AdditionalDetails';
import Loading from '../loading';
import { truckTypesIcons } from '@/utils/utilArray';
import { Select, SelectTrigger, SelectContent, SelectItem, SelectLabel, SelectValue } from '@/components/ui/select';
import { Button } from '@/components/ui/button';
import DriverSelect from '@/components/trip/DriverSelect';
import { mutate } from 'swr';
import { useExpenseData } from '@/components/hooks/useExpenseData';

// Define the types
type FormData = {
    truckNo: string;
    truckType: string;
    model: string;
    capacity: string;
    bodyLength: number | null;
    ownership: string;
    supplier: string;
    driver: string;
}

// Main CreateTruck component
const CreateTruck: React.FC = () => {
    const router = useRouter();
    const [saving, setSaving] = useState(false)

    const [formdata, setFormdata] = useState<FormData>({
        truckNo: '',
        truckType: '',
        model: '',
        capacity: '',
        bodyLength: null,
        ownership: '',
        supplier: '',
        driver: ''
    });

    const [showDetails, setShowDetails] = useState<boolean>(false);
    const [error, setError] = useState<string | null>(null);
    const params = useSearchParams()
    const nextpath = params.get('nextpath')
    const {drivers, suppliers, refetchDrivers, refetchSuppliers, isLoading} = useExpenseData()

    useEffect(() => {
        refetchDrivers();
        refetchSuppliers();
    }, [refetchDrivers, refetchSuppliers])

    const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
        const { name, value } = e.target;
        const updatedFormdata = {
            ...formdata,
            [name]: name === 'truckNo'? value.toUpperCase() : value
        };
        setFormdata(updatedFormdata);
        localStorage.setItem('tripData', JSON.stringify(updatedFormdata));
    }

    const handleSelectChange = (name: string, value: string) => {
        const updatedFormdata = {
            ...formdata,
            [name]: value
        };
        setFormdata(updatedFormdata);
        localStorage.setItem('tripData', JSON.stringify(updatedFormdata));
    }

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();

        // Basic form validation
        if (!formdata.truckNo) {
            alert('Enter Truck Number');
            return;
        }

        // Validate truck number
        if (!validateTruckNo(formdata.truckNo)) {
            alert("Please enter a valid Indian truck number.");
            return;
        }

        if (!formdata.ownership) {
            alert('Select Ownership');
            return;
        }

        if (formdata.ownership === 'Market' && !formdata.supplier) {
            alert('Select Supplier');
            return;
        }

        try {
            setSaving(true);
            const response = await fetch('/api/trucks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formdata)
            });

            const data = await response.json();

            // Prioritize backend-provided error messages
            if (!response.ok) {
                // Common, harmless errors  handle gracefully
                if (data?.message) {
                    // Already exists or validation errors should not show generic alert
                    if (
                        data.message.includes('Lorry Already Exists') ||
                        data.message.includes('Ownership type is required') ||
                        data.message.includes('Supplier is required') ||
                        data.message.includes('Enter a valid Truck No')
                    ) {
                        alert(data.message);
                        return;
                    }
                }
                // Default: unexpected error
                throw new Error(data?.message || 'Failed to create truck');
            }

            // Handle backend-indicated application error (like duplicate)
            if (data?.error) {
                alert(data.error);
                return;
            }

            // Success: proceed as before
            setFormdata({
                truckNo: '',
                truckType: '',
                model: '',
                capacity: '',
                bodyLength: null,
                ownership: '',
                supplier: '',
                driver: ''
            });
            setShowDetails(false);
            if (nextpath) {
                const current = JSON.parse(localStorage.getItem('tripData') as any);
                current.truck = data.data?.truckNo || data.truck?.truckNo;
                localStorage.setItem('tripData', JSON.stringify(current));
            }
            mutate('/api/trucks');
            router.push(nextpath ? nextpath : '/user/trucks');
        } catch (error: any) {
            // Only alert for genuinely unexpected errors
            console.error('Error creating lorry:', error);
            alert(error?.message || 'Failed to add lorry. Please try again later.');
        } finally {
            setSaving(false);
        }
    };

    const renderModelOptions = () => {
        switch (formdata.truckType) {
            case 'Mini Truck / LCV':
                return minitruck;
            case 'Open Body Truck':
                return openBody;
            case 'Closed Container':
                return closedContainer;
            case 'Trailer':
                return trailer;
            default:
                return [];
        }
    }

    if (isLoading) return <Loading />;
    if (error) return <div>Error: {error}</div>;

    return (
        <>
            {saving && (
                <div className='absolute inset-0 bg-black bg-opacity-10 flex justify-center items-center z-50'>
                    <Loading />
                </div>
            )}
            <div className="bg-white text-black p-4 max-w-md mx-auto shadow-md rounded-md">
                <form className="space-y-4" onSubmit={handleSubmit}>
                    <input
                        type='text'
                        name='truckNo'
                        value={formdata.truckNo.toUpperCase()}
                        placeholder='Enter the Truck Number'
                        onChange={handleInputChange}
                        required
                    />
                    <Select onValueChange={(value) => handleSelectChange('truckType', value)}>
                        <SelectTrigger>
                            <SelectValue placeholder="Select Truck Type" />
                        </SelectTrigger>
                        <SelectContent>
                            {truckTypesIcons.map(({ type, Icon }) => (
                                <SelectItem key={type} value={type}>
                                    <Icon className="inline-block mr-2" /> {type}
                                </SelectItem>
                            ))}
                        </SelectContent>
                    </Select>
                    <Select onValueChange={(value) => handleSelectChange('ownership', value)}>
                        <SelectTrigger >
                            <SelectValue placeholder="Select Ownership*" />
                        </SelectTrigger>
                        <SelectContent>
                            <SelectItem value='Self'>Self</SelectItem>
                            <SelectItem value='Market'>Market</SelectItem>
                        </SelectContent>
                    </Select>
                    {drivers && <DriverSelect drivers={drivers} formData={formdata} setFormData={setFormdata} handleChange={handleInputChange} />}
                    {formdata.ownership === 'Market' && (
                        <SupplierSelect
                            suppliers={suppliers}
                            value={formdata.supplier}
                            onChange={handleSelectChange}
                        />
                    )}
                    {
                        formdata.truckType && !new Set(['Other', 'Tanker', 'Tipper']).has(formdata.truckType) && (
                            <Button
                                className='rounded-full w-full'
                                type="button"
                                onClick={() => setShowDetails(true)}
                            >
                                Add More Details
                            </Button>
                        )
                    }

                    {showDetails && !new Set(['Other', 'Tanker', 'Tipper']).has(formdata.truckType) && (
                        <AdditionalDetails
                            formdata={formdata}
                            renderModelOptions={renderModelOptions}
                            handleInputChange={handleInputChange}
                        />
                    )}
                    <Button className='w-full' type="submit">
                        Add Lorry
                    </Button>
                </form>
            </div>
        </>
    )
}

export default CreateTruck;
</file>

<file path="src/components/trip/tripDetail/TripFunctions/FrieghtInvoice.tsx">
import React, { useState, useEffect } from "react";
import Image from "next/image";
import { InvoiceFormData as FormData } from "@/utils/interface";
import { formatNumber } from "@/utils/utilArray";
import { useMemo } from "react";


async function urlToBase64(url: string): Promise<string> {
  const response = await fetch(url);
  const blob = await response.blob();
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result as string);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}

const FreightInvoice: React.FC<{ formData: FormData; isPdfExport?: boolean }> = ({ formData, isPdfExport = false }) => {
  const [base64Logo, setBase64Logo] = useState('');
  const [base64Signature, setBase64Signature] = useState('');
  const [base64Stamp, setBase64Stamp] = useState('');
    // const {trip} = useTrip()

    useEffect(() => {
  if (isPdfExport && formData.logoUrl) {
    urlToBase64(formData.logoUrl)
      .then(setBase64Logo)
      .catch(() => setBase64Logo(''));
  }
}, [isPdfExport, formData.logoUrl]);

useEffect(() => {
  if (isPdfExport && formData.signatureUrl) {
    urlToBase64(formData.signatureUrl)
      .then(setBase64Signature)
      .catch(() => setBase64Signature(''));
  }
}, [isPdfExport, formData.signatureUrl]);

useEffect(() => {
  if (isPdfExport && formData.stampUrl) {
    urlToBase64(formData.stampUrl)
      .then(setBase64Stamp)
      .catch(() => setBase64Stamp(''));
  }
}, [isPdfExport, formData.stampUrl]);

    function formatCurrency(amount: number): string {
        return new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(amount);
    }

    const totalAmount = formData.freightCharges.reduce(
        (total, charge) => {
            const amount = parseFloat(charge.amount as any); // Safely convert to a number
            return total + (isNaN(amount) ? 0 : amount); // Add only valid numbers
        },
        0
    ) + formData.additionalCharges.reduce((total, charge)=>total + Number(charge.amount),0) + formData.extraAdditionalCharges.reduce((total,charge)=>total + Number(charge.amount),0);

    const totalBalance = useMemo(() => {
        // Combine paymentDetails and extraPaymentDetails into a single array
        const allPayments = [
            ...(formData.paymentDetails || []),
            ...(formData.extraPaymentDetails || []),
        ];

        // Calculate the total payment amount
        const paymentTotal = allPayments.reduce((total, charge) => {
            const amount = parseFloat(charge.amount as any); // Safely convert to a number
            return total + (isNaN(amount) ? 0 : amount); // Add only valid numbers
        }, 0);

        // Return the total balance
        return totalAmount - paymentTotal;
    }, [formData, totalAmount]);



    function numberToWordsIndian(num: number): string {
    if (num === 0) return "Zero";

    const units = ["", "one", "two", "three", "four", "five", "six", "seven", "eight", "nine"];
    const teens = [
        "eleven", "twelve", "thirteen", "fourteen", "fifteen",
        "sixteen", "seventeen", "eighteen", "nineteen"
    ];
    const tens = ["", "ten", "twenty", "thirty", "forty", "fifty", "sixty", "seventy", "eighty", "ninety"];
    const scales = ["", "thousand", "lakh", "crore"];

    const getBelowThousand = (n: number): string => {
        let str = "";
        if (n > 99) {
            str += units[Math.floor(n / 100)] + " hundred ";
            n %= 100;
        }
        if (n >= 11 && n <= 19) {
            str += teens[n - 11] + " ";
        } else {
            if (n >= 10) {
                str += tens[Math.floor(n / 10)] + " ";
                n %= 10;
            }
            if (n > 0) {
                str += units[n] + " ";
            }
        }
        return str.trim();
    };

    const parts: string[] = [];
    let scaleIndex = 0;

    while (num > 0) {
        const divisor = scaleIndex === 0 ? 1000 : 100;
        const part = num % divisor;

        if (part > 0) {
            const scale = scales[scaleIndex];
            parts.unshift(getBelowThousand(part) + (scale ? " " + scale : ""));
        }

        num = Math.floor(num / divisor);
        scaleIndex++;
    }

    // Capitalize first letter of each word
    const result = parts.join(" ").trim();
    return result.replace(/\b\w/g, (c) => c.toUpperCase());
}


    return (
        <div className="w-full mx-auto my-2 border border-black relative font-sans text-[8px] pb-4">
            <div className="text-center mb-2">FREIGHT INVOICE</div>
            <div className="flex items-center justify-between w-full px-6 mb-2">
  {/* Logo on the left */}
  <div className="flex-shrink-0">
    {formData.logoUrl ? (
  isPdfExport ? (
    base64Logo ? (
      <img src={base64Logo} alt="Company Logo" width={45} height={45} className="object-contain" />
    ) : (
      <div style={{ width: 45, height: 45, backgroundColor: '#ccc' }} />
    )
  ) : (
    <Image src={formData.logoUrl} alt="Company Logo" width={45} height={45} className="object-contain" />
  )
) : null}
  </div>

  {/* Company Info centered */}
  <div className="flex-1 text-center">
    <h2 className="text-sm font-semibold text-gray-800">{formData.companyName}</h2>
    <p className="text-xs font-normal uppercase text-gray-700">
      Fleet Owners and Transport Contractors
    </p>
  </div>

  {/* Optional empty div to balance out the flex layout */}
  <div className="w-[45px]" />
</div>


            <div className="text-center mb-1">{formData.address}</div>
            <div className="absolute right-1 top-1">
                <div>{formData.phone}</div>
                <div>{formData.altPhone}</div>
            </div>
            <table className="w-full border-collapse text-[6px]">
                <tbody>
                    <tr>
                        <td colSpan={3} className="text-center font-bold border border-l-0 border-black p-1">Bill No. {formData.billNo}</td>
                        <td className="border border-black p-1">Branch: {formData.branch}</td>
                        <td className="border border-r-0 border-black p-1">Date: {new Date(formData.date).toLocaleDateString('en-IN')}</td>
                    </tr>
                    <tr>
                        <td colSpan={1} className="font-bold border border-l-0 border-black p-1">CONSIGNMENT<br />No. </td>
                        <td colSpan={1} className="font-bold border border-black p-1"> Start Date</td>
                        <td className="font-bold border border-black p-1">PARTICULARS</td>
                        <td colSpan={1} className="border border-black p-1">From: {formData.to}</td>
                        <td colSpan={1} className="border border-r-0 border-black p-1">To: {formData.from}</td>
                    </tr>
                    <tr>
                        <td className="border border-l-0 border-black p-1">{formData.freightCharges.map((charge, index)=><span key={index}>{charge.lrNo}{index === formData.freightCharges.length -1 ? '' : ', '}</span>)}</td>
                        <td className="border border-black p-1">
  {formData.dueDate
    ? new Date(formData.dueDate).toLocaleDateString("en-GB") // dd/mm/yyyy
    : ""}
</td>

                        <td className="border border-black p-1">{formData.particulars}</td>
                        <td colSpan={2} className="border border-r-0 border-black p-1">
                            <div>Party: {formData.party}</div>
                            <div>GSTIN: {formData.partygst }</div>
                            <div>{formData.partyAddress}</div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <h2 className=" text-center text-xs font-bold p-2 mt-2 mb-1" style={ {background : formData.color}}>Freight Charges</h2>
            <table className="w-full border-collapse text-[6px]">
                <thead>
                    <tr className="">
                        <td className="font-bold text-center border border-black p-2">S.N</td>
                        <td className="font-bold text-center border border-black p-2">Lorry No.</td>
                        <td className="font-bold text-center border border-black p-2" colSpan={2}>Particulars</td>
                        <td className="font-bold text-center border border-black p-2">Weight (MT)</td>
                        <td className="font-bold text-center border border-black p-2">Charged (MT)</td>
                        <td className="font-bold text-center border border-black p-2">Rate (PMT)</td>
                        <td className="font-bold text-center border border-black p-2">Amount</td>
                    </tr>
                </thead>
                <tbody>
                    {formData.freightCharges.map((charge, index) => (
                        <tr key={index}>
                            <td className="border border-black p-2">{index + 1}</td>
                            <td className="border border-black p-2">{charge.truckNo}</td>
                            <td colSpan={2} className="border border-black p-2">{charge.material?.map((item,i)=>item + (i === charge.material.length - 1 ? '' : ', ')) || ''}</td>
                            <td className="border border-black p-2">{charge.weight}</td>
                            <td className="border border-black p-2">{charge.charged}</td>
                            <td className="border border-black p-2">{formData.rate}{formData.billingtype}{charge.rate}</td>
                            <td className="border border-black p-2">{formatNumber(charge.amount)}</td>
                        </tr>
                    ))}
                </tbody>
            </table>

            {(formData.additionalCharges.length !== 0 || formData.extraAdditionalCharges.length !== 0) &&
                <>
                    <h2 className="text-center text-xs font-bold p-2 mt-4 mb-2" style={{background : formData.color}}>Additional Charges</h2>

                    <table className="w-full ">
                        <thead>
                            <tr className="">
                                <td className="font-bold text-center border border-black p-2">S.N</td>
                                <td className="font-bold text-center border border-black p-2">Lorry No.</td>
                                <td className="font-bold text-center border border-black p-2">Particulars</td>
                                <td className="font-bold text-center border border-black p-2">Remarks</td>
                                <td className="font-bold text-center border border-black p-2">Amount</td>
                            </tr>
                        </thead>
                        <tbody>
                            {formData.additionalCharges.map((charge, index) => (
                                <tr key={index}>
                                    <td className="border border-black p-2">{index + 1}</td>
                                    <td className="border border-black p-2">{charge.truckNo}</td>
                                    <td className="border border-black p-2">{charge.expenseType}</td>
                                    <td className="border border-black p-2">{charge.notes}</td>
                                    <td className="border border-black p-2">{formatNumber(charge.amount)}</td>
                                </tr>
                            ))}
                            {formData.extraAdditionalCharges.map((charge, index) => (
                                <tr key={index}>
                                    <td className="border border-black p-2">{index + 1}</td>
                                    <td className="border border-black p-2">{charge.truckNo}</td>
                                    <td className="border border-black p-2">{charge.expenseType}</td>
                                    <td className="border border-black p-2">{charge.notes}</td>
                                    <td className="border border-black p-2">{formatNumber(charge.amount)}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table></>}

            <table className="w-full border-collapse border-t border-black">
                <tbody>
                    <tr className="p-0">
                        <td className="border-r border-black p-2">
                            <div>UDYAM/MSME No. {formData.partyDetails.msmeNo}</div>
                            <div>GSTIN {formData.partyDetails.gstin}</div>
                        </td>
                        <td className="font-bold text-center p-2">TOTAL</td>
                        <td className="font-bold text-right p-2 pr-2.5">{formatNumber(totalAmount)}</td>
                    </tr>
                    <tr className="p-0">
                        <td className="border-r border-black p-2">
                            <div>PAN No {formData.partyDetails.pan}</div>
                            <div>Bank Acc No {formData.partyDetails.accNo}</div>
                        </td>
                        <td className="font-bold text-center p-2">ADVANCE</td>
                        <td className="font-bold text-right p-2 pr-2.5">{formatNumber(totalAmount - totalBalance)}</td>
                    </tr>
                    <tr className="p-0">
                        <td className="border-r border-black p-2">
                        </td>
                        <td className="font-bold text-center p-2">
  {(formData.gstType ? formData.gstType : "GST")} ({formData.gst}%)
</td>

                        <td className="font-bold text-right p-2 pr-2.5">{formatNumber((totalBalance * (formData?.gst ?? 0)) / 100)}</td>
                    </tr>
                    <tr className="p-0">
                        <td className="border-r border-black p-2">
                            <div>IFSC Code {formData.partyDetails.ifscCode}</div>
                            <div>Bank Name {formData.partyDetails.bankName}</div>
                            <div>Branch Name {formData.partyDetails.bankBranch}</div>
                        </td>
                        <td className="font-bold text-center p-2">BALANCE</td>
                        <td className="font-bold text-right p-2 pr-2.5">{formatNumber(!formData.gst ? totalBalance :  totalBalance + (totalBalance * formData.gst)/100)}</td>
                    </tr>
                    
                    <tr>
                        <td colSpan={3} className="text-center font-bold text-xs p-2.5 border-t border-b border-black">
                            Total amount in words :- {numberToWordsIndian(!formData.gst ? totalBalance :  totalBalance + (totalBalance * formData.gst)/100)} Rupees Only
                        </td>
                    </tr>
                </tbody>
            </table>

            {(formData.paymentDetails.length !== 0 || formData.extraPaymentDetails.length !== 0) && <>
                <h2 className="text-center text-sm font-bold p-1 mt-4 mb-2" style={{background : formData.color}}>Received Payment Details</h2>

                <table className="w-full border-collapse">
                    <thead>
                        <tr className="border-b border-black">
                            <td className="font-bold text-center border border-black p-2">S.N</td>
                            <td className="font-bold text-center border border-black p-2">Date</td>
                            <td className="font-bold text-center border border-black p-2">Payment Mode</td>
                            <td className="font-bold text-center border border-black p-2">Notes</td>
                            <td className="font-bold text-center border border-black p-2">Amount (-)</td>
                        </tr>
                    </thead>
                    <tbody>
                        {formData.paymentDetails.map((payment, index) => (
                            <tr key={index}>
                                <td className="border border-black p-2">{index + 1}</td>
                                <td className="border border-black p-2">{new Date(payment.date).toLocaleDateString('en-IN')}</td>
                                <td className="border border-black p-2">{payment.paymentType}</td>
                                <td className="border border-black p-2">{payment.notes}</td>
                                <td className="border border-black p-2">{formatNumber(payment.amount)}</td>
                            </tr>
                        ))}
                        {formData.extraPaymentDetails.map((payment, index) => (
                            <tr key={index}>
                                <td className="border border-black p-2">{index + 1}</td>
                                <td className="border border-black p-2">{new Date(payment.date).toLocaleDateString('en-IN')}</td>
                                <td className="border border-black p-2">{payment.paymentType}</td>
                                <td className="border border-black p-2">{payment.notes}</td>
                                <td className="border border-black p-2">{formatNumber(payment.amount)}</td>
                            </tr>
                        ))}
                    </tbody>
                </table></>}

            <div className="mt-4 text-sm">For, <strong>{formData.companyName}</strong></div>

<div className="flex items-center justify-evenly text-xs mt-2">
  {/* Logo / Checked by
  <div className="flex flex-col items-center text-center">
    <div className="w-[60px] h-[60px] flex justify-center items-center">
      {formData.logoUrl ? (
        <Image
          src={formData.logoUrl}
          alt="Logo"
          width={50}
          height={50}
          className="object-contain"
        />
      ) : (
        <div className="w-full h-full bg-gray-200" />
      )}
    </div>
    <p className="mt-1">Checked by</p>
  </div> */}

  {/* Signature / Bill Incharge */}
  <div className="flex flex-col items-center text-center">
    <div className="w-[70px] h-[70px] flex justify-center items-center">
      {formData.signatureUrl ? (
  isPdfExport ? (
    base64Signature ? (
      <img src={base64Signature} alt="Signature" width={70} height={70} className="object-contain" />
    ) : (
      <div style={{ width: 70, height: 70, backgroundColor: '#ccc' }} />
    )
  ) : (
    <Image src={formData.signatureUrl} alt="Signature" width={70} height={70} className="object-contain" />
  )
) : null}

    </div>
    <p className="mt-1">Bill Incharge</p>
  </div>

  {/* Stamp / Verified Stamp */}
  <div className="flex flex-col items-center text-center">
    <div className="w-[70px] h-[70px] flex justify-center items-center">
      {formData.stampUrl ? (
  isPdfExport ? (
    base64Stamp ? (
      <img src={base64Stamp} alt="Verified Stamp" width={70} height={70} className="object-contain" />
    ) : (
      <div style={{ width: 70, height: 70, backgroundColor: '#ccc' }} />
    )
  ) : (
    <Image src={formData.stampUrl} alt="Verified Stamp" width={70} height={70} className="object-contain" />
  )
) : null}

    </div>
    <p className="mt-1">Verified Stamp</p>
  </div>
</div>




            <div className="text-xs font-bold mt-2">
                NOTE:
                <span className="font-normal text-xs">
                    We are not liable to accept or pay GST as Goods Transport Agency
                    (GTA) fall under Reverse Charge Mechanism (RCM).
                </span>
            </div>
            <div className="text-center text-xs mt-4 py-4">
                                    <p className="flex items-center justify-center">
                                        Powered by
                                        <Image
                                            src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOQAAAD0CAYAAACLgYoWAAAACXBIWXMAACxLAAAsSwGlPZapAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAABPbSURBVHgB7Z1dchRHFoVvNRg5Yh4sr8DFCiytwGIFxitw82BiICZCYgVIK7AU4YCJmAeaFVizAqQVoFkBYgWjeTOY6XJmVrbULXVX5W/VzczzRRDIpoUA9amTefPcvERgVJq/U908p0MCQDAhMC6VEuN+c0DbBIoHghwR6Y5CkD+LD7fpMx0QKB4IckyqlaUqXBJAkGOx5I4LpEv+SqBoIMixqNYWcqZKqKBYIMgREKLbu+WON1T0hkCxQJBjUNHLjl/bU4IFRQJBDow4c5xK0XW+qEuwIGsgyOHpFxtcslggyAFR7kiGRRu4ZJFAkMNiLrLWJacEigKCHAgrd1wgXBJhgbKAIIfDfglaCQEjUlcUEOQAOLnjDYjUFQQEGRmdvPEp0CB4XhAQZHxkIqcmP+CShQBBRkS54ySIu8ElCwGCjEkbIA/lbC8RPM8fCDISa9qr/JkgLJA7EGQsqij35EwRqcsbCDICUdxxASJ1WQNBxqCKeIscgudZA0EGJqo7LoBLZgsEGZohOv7hktkCQQZEX82xR0OAqz6yBIIMyWRAkVRUN08RFsiNikAQdIB8aNe6ogf0sDoWP4MsgEOGY4xCCyJ1mQFBBsCzvcoXBM8zAoIMw5jHEHDJjIAgPRnZHRfsI3ieBxCkPxwO6bcRPM8DCNID4UpSBDXxYNr8QjsEkgaCdEQ3H0+JE/cxPSt1IEh3QlzNERZE6pIHgnRAu+MhcQTB86SBIF2omIpRApdMGgjSkkHaq3yBSyYLBGkLZ3dcgLkgyYJwuQV67/iBUqChS9qiXQTP0wIOaUMK7rgAc0GSBA5piDp0/4reU1qgPSsx4JCmpHnojuB5YsAhDRip+TgUcMmEgEOakfIxwjZ9wjFIKsAhe0jcHW+YC5f8p6i8AtbAIfvJw10qBM9TAILsgEnzcRgqeoxIHX8gyG7y2nshUsceCHIDWbnjAgTP2QNBrkHfT5Onm8AlWQNBrodf83EopEs+o8cEWAJB3oLl1RzhQcWVKRDkbdoAeU05g7kgbEEwYImk2qv8QaSOIXDIZVJqr/IHwXOGwCE1hbnjArgkM+CQC8pyxwVwSWbAIalYd1xwRXPaRfCcB3BISdnBa8wFYUTxDqmiZBN6R6Uzp0fCJc8IjAoccoJDcgUidSwoWpA6QI6JURIEz1lQukPCFZaBS45OsYLMsr3KF7jk6JTskHCDdWBPPSpFChLu2MkO5oKMR6kOCXfsQuwlmwNxPgkGpzhBiqe/FGNNYDOYCzIaRQUDdEROhgBqAn0geD4CpTlkvldzhAfB8xEoxiFZB8gbFey+kHenEi/gkgNTjkNybq9q6Ej8eEH8wFyQgSnCIbm7Y/WaHqoPn9Ox+GmfuIG5IINRhkNydsd79OT64wfqz8lveVhlMGwoEbIXpHLHShVzODKrfrtpedJ7tRPiBiJ1g5G/Q3J2x7nYO97mgVq2cnRJ7CUHIGtBsnfHNfsyuGTZ5O2QnPc+69xxQeuSl8QNuGR0shWkml9RsX2iz7qqltolj4gbrUtOCUQjX4fke3HVVac7aqpXNBNHImfEDbhkVLIUJPP2qhPjM72GpUvW4t/3kEAUcnVInk9xGZGbC+czRN0Cx9ElifbRnhWH7ATJ2h2F41knXji6JILn0cguOicEKSNyNXFjKSJn/anP6B3DAhWC5xHIyiG5uyO50izF6/gAl4xANg7JuvnYwx2vfwuewXPMBQlMTg7Jt/k4xD6QZ/Acc0ECk4UgtTtOiSfnwkFm5AnbSB3RFJG6cOThkG2AvCaOzAM+KBA8z57kBZligNwVBM/zJ32HTK29yhcEz7MmaUGW5I4LmAfP9wh4kbZDluaOGsbBc1z14UmygmTujkfRz+a4Bs/RnuVFug7J1R0tA+SusA2eT+hXBM/dSVKQaq/C1x1PBkuuIHieHUlG55iGrYNE5Ky/JILnWZGcQ6oAOderOcZwLATPsyI5h8yxvcr7Sz8Te1Z+S3i4pANJOWS27VW+bCk34hc8/4zx6LaktmTlmga5CBEgd4V58LwmYEwygmTtjhMGk6v4Bs8RFrAgJYfk6o4r8znGAsHzPEhCkOIbKsVYE0fmjM4C0Z6VPOwFybz5eMbp+grtkvwGv8IljUnBIflezWHpjjJS1vfGlA8gnzyoCp6jPStZWAtSu+Mh8cTKHZUQP9N78ffZ63mp/Du/EWeL7pnQOcOwAOaCGMHbIXkHyI3cUbmiENf1jXiN4R6vEmeLn+i9y1KPbfBcuCSC592wFSTr9qqK3pq447UrVisxst7PW/o66mpLJ7dk2p6FSF03fB2SsTuKfdph50tuu+Iy93ocslojvIVb/kI7ZAjmgqQJS0Gydsce59ngijd86XHIasObVbrLV2oJa14c+cKw4orgeSc8HZKzO26IyHW64hLexySiyCW+zgeTSFr1L7oQf+a3xA+45AbYCTJFd+x1xRsuqP9r9L9R273lByO3bJjeeA6XXAs/h+SafVzjjqauuMT/el9RWTiHgVtqR+YYPH+J4PldWAlSX82xRzxZ2Y9ZuOIyHyg0Jm7JNVKHuSB34OWQE7adAefVazqVHzi44jIfe1/ROLpGh1tiLkg6sBEk6/YqPZ/D0RVvaAz2kD50uSWC50nAySHZtlfR13Tl4Yo3fDGqsH5HvqxxS+WSPMMCCJ4vwUKQzN3x3MsVl/nbgKHvNW4plt2YC8IcLg7J9xvS7mtr8ufC6MKnKvD5XOuW767dkm/wfI/A+IJk7Y5h6T/yaPmWQiMr1xN63zylA8bBc1z1QSMLUqc1SlmumBZ0/PeQ69mm+/SrvliZX3pHzgV5irDAuA75B+1TGe5IbFxJumWjHoL8Kq730Z41miCZX80Rnnv9AhgsuVKpr8PxjV98pG48h2wD5DUVgtHNdBMErqnw4PkogmQ+2zEGZvvHOQRJhbvkOA7JefJxDOYGkTlJBUFq9ksNng8uyALdUQrtzPCVNQHJdqnB8+EdsjR3lNwzXLLCIZeZ2lxZkguDCrJIdyTDgo6kgUOucL+86VnDOmSJ7kh0bvHaWKGANCkwUjeYIHXzcXHuKDgj4E5hwfPhHLLURP/EQpBVeXumXgpzyUEEqQLkfK/miIrlqDoUddZR0MN8KIcstd/NeP+IC586KGguSHRBFtRedZemvYfHkJrAZgqZCzKEQ5bbDf7Fav+I5WoXhcwFiSrIwt3xUt0cbgoKOiZkHzyP7ZDlumNledyBUIAJ2QfPowmyeab+4WoqlYl1Vz5CAWZk7ZJRBKkjcvtUKnK5+pulQ1b0kIAJ2/Qp35VXLIeUiZyaSqVySufAIU2p6CDXY6LggtRXc5R9WdHc7kJiUfxCQceWKs/geXiHbAPkJZfwL6xnQKKgY09Fj3OM1AUVZKntVSvMHYba4MjDjQwjdWEdssz2qhs6Jiz3AEG6kGHwPJgg4Y7kWsyRQv6GgBuZuWQ4hyzdHSVzx+lSWLK6I13yGT2mTAgiSLijYmZdzKHrCityrH5kU3EN45AYlOLujqiw+pPRXBBvQeqrOfaobJzcUYHlahgymQvi75CT4t3xytkdWyDIMGQRPPcSZNHtVTecOLtjy/cEQpF88NzXIcseRS3PHV+5V5f1m6cmEIrkXdJZkHBHkjeS+40H/4Qx3hFIei6Ij0OW7Y5yqfqb552rKOjEIOm5IE6CLN4dxVKVHgQIQjT0A4EYTFON1Lk6ZOl7x0fVcYCR4HDIeCQaqbMWpHjyyL9oTaXS0AvPqmr72yChE5dEg+dWgtTNx1Mql6PqNR1TCBoUdKKToEvaOWR7T05NJdLQqc8Rxx2QbopPgi5pLEgdIC/1ao4L2vI84rgLCjpDMEkreG7ukOW2V12IimqYIo5GP7WxfxyGnZTmghgJsuD2quBiVKC6OiwJzQUxc8gS3VEOyokhxpYfCQxHQnNBqr4X6MrqByqLE1HAifINVE/qz/RfAkNzJR6wDyM9YIPR75BlueOVOmd8FfFpivzqWCQRPO8UpG4+LmPvKONwf4olaqhzxs1kc/9LgrBvz+p2yHJGSZ+IY41dq/FxrlQ47hgR9nNBNu4hdYA879sApCveoyfeXRumX06uOCb0jsC4zMVeMkD8MQb3O34tZ3eUG/sTsTw9pCGpio4d8qG9lO0RMWTtkjXj9iopxCNVbXs1QrHKdbna8HyaJwvjSN0mh8zNHZUjCiEej1X21m+AmmyRYmzE07yi94R0Tzja+sgZMeOOQ2bmjiuOOOoZlOtytaEjtd9pvG62A7dh6pJ3ijpCkDIEUFPanItHzeFQxRoTxL+rDAPYOty5eJDsXf8ez0RBCF0i4WjoTNQRWO0lVxwycXc8l4f6wg2/lW9iZmKckstyc37LVRvVccI6aZIUrUtOiRHXDqkjcrIkX1MayDfmf1TmdItmnCNRjs42Ew+WJ2t+r4NcpwePgrzK8zU9JCYsC/KlXOYRZyolwDPx5zwV5agL7rlEiWMWWN6GvrvprAxL1+AcjVJ1X4OqsjK9mkOK7ZxkC9REiDARAd7BLQvcfRu6XLqi6hoSGak75vD+ao892jdNTeNwJb7+R+EIMrZ2QffEG/GLEB/TJIU1tmeP7RLqsPO3FP82wiWPsHQNxiJ4fkgjUw3UXvVR/LhUZ2qVEtql+JpXWQlvDU7xwzk9MR2LjqVrUFi0Z923XFJ9XPr4ktp2JelwVysfT5TLXdLXdJXkMjMctgGLf5uKUbFFP4knu3yYYunqDwuXrJp/6CfsXBUS7ognZweLiRqzXdHvVp/kEHp2+jpgE53FtCHovTEAuOGwnHSu9Imlsezh3CcQgrXHTUMRZqQ5WMF6qnQ7K8S9MbqdM3JJIASjzgWBIGMwsbwqQuZVPfba6nP/FPtJEIYRG/MhyMDop6vNrXIzq0LOBtRtBzI6CPwZMXgOQYbG9uk6D9fFoe4Davi1FCXJSC4JQQZEVzz3LD7lKHhFb0stXS8J+DGSS0KQIbFJzshEToT8pNpPzserEmZFNfydUhBkIKxb15p4fXjCdc+wnwxARfXQ7Vk4hwyAvo1chr1rw08ZpLtALKF/F99h3APrx6CROjhkCP6wmJsZaam6lnaE3iUBHwa98RwO6Yl1OH/gO0GbX2iHvlKN58i7ujOYS8IhfZlY5UiPhs5JqvPJOfaTngzmknBID6yu0xj5qgjkXb0ZxCXhkI7oIbbmh8fNuLebqYleCA34IF0yekM4BOlKe0Zlui87YtHGhtCAL1P1II4IBOmAXqrumb2YTrlcoKRDA9KpLwm4ETksAEFaopeqxvtGbgf0yqnbzhDc7+pC5EgdBGmBCgDYjJO7p+7HuSRmoPLqScTgOQRpQzvsszZ89RGn29Nvo1u+MC/EhYguCUEaoveNpmdR51z2jV3oPyNE6UIkl4QgDbA64pD7xnk6g1mVKBt6S8COSHNBEAzowXrmCeNx2V2IFcBMvBt+JmCOfPhu0W7IsAAcso82GlcbvVZUVJO9NnNLLccvCJhTifdF4EgdBNmBcA15vLFj+PIjdYVGoqin/AN1RglR2rGvqu+BgCA3oKaBmRZxGB3++wBROhE0eA5BrkFVVM1H813ovsMsgCidCOaSEOQt9EVV5kmcOf2U2/wSiNKaYC6JKusSVs28bSzuUdbTu+RT/5PYF6P6akaACjscUmPZWX+Vuxgl0ilFoWoqPjwh0M/EPywAh6Trs0bTicTy2v5HKg9aEM1ztace7Yr9ZJirB/UZOVK8Qy4d/EOMHSBmZ4hnpK5oh9TLVNOD/2LFuIwuetk0Z5eHh0sW65BLe8ba4OUQo0bsKU/lUFNCk/NmPFyySEGq1hmbairEuIIqZs1xLLIRj/as4gQpllw/G+8ZF0cbEOMdpCjFvlI6JfaV63C86qMoQeqexpnZi/M/ZwyBLvbghvTbyLkgT+3DAsUUdVQ21TwOd04P6HFuCZyYWLeplYH1Xa5FOKQ4Q3tjIcYT8dTfgxjt0EtYeRE0lrA3WEfqsnZIPZVKPrVNWqhk+ibpFiouwC1XsHLJbB1SvSnaEXH9YlxUUiHGIMAtV7ByySwdUpWc205/k0rqqWyfwhI1DnBLhbygetekQJidQ+rijcmxxpW6cuN1fu1TnFhyy5IrsdumwfNsHFLvF2Uf49Tg5ReqjxFHGoOi3VIu38qcwvWncMmeM+0sBGm5LDrK4bqNlNHXah4W12fZ0JlYkXVOQUtekCp5U6liTN8S9Vw8oQ6QuuFDkcLsCZ4nLUh1K1z/RVQ4zmBOUcLscckkBamXqLKK2nekMRNnQC9QtEmDYoTZ4ZLJCdKwH+9cJnM4D7sBm9HClN9nWfypKTc6XDIZQeoLl7rvSpUH/HIEHISYDc1zVTWXP36gnJirUYWz2/87CUEadPZjn5g52bnmhrkg7AWpW6bkoeq6Jar8y5yIfeIx9onlIFxT1g6m4sePlLY47xzBsRWkfiK+kd3Xa34ZQgQKLc7Hyj0b+p7S4k7wnKUgOwo352LtPVu39gZAV9/3SAq03XOmcBHXikuyEmRH4QZVU2CNcs9GCLRdZXEV6IpLshGk7tCQrljr/yX/gHKy70w8QZCuAd7o5e3yDx6V20ZsvV7TC/nh6IJc44rnuiVqhv0hiI0S6USYwFy5qBSp3IcO76R6LsioglxyRfkP8FZ8fIplKRgbZRJflDi3hVBaN5XTkhv6jmKJVc4Yla2ANAJLrrgLNwQpodv8auWq/1cnAVKgrXjlxz6ilZE6Ghh9yL8jvvgZ+hFBrqiK731dD5krd93W4t3WH7e/Vun/JvpG/HzxFxycz+sV8RQvAAAAAElFTkSuQmCC"
                                            alt="Awajahi logo"
                                            width={20}
                                            height={20}
                                            className="mx-1"
                                        />
                                        Awajahi
                                    </p>
                                </div>
        </div>
    );
};

export default FreightInvoice
</file>

<file path="src/components/trip/tripDetail/TripDetail.tsx">
import React, { useEffect, useState } from 'react';
import { ITrip, TripExpense, } from '@/utils/interface';
import TripInfo from './TripInfo';
import TripStatus from './TripStatus';
import StatusButton from './TripFunctions/StatusButton'; // Replace with your actual StatusButton component
import ViewBillButton from './TripFunctions/ViewBill'; // Replace with your actual ViewBillButton component
import Profit from './Profit';
import DataList from './DataList';
import Charges from './Charges'; // Import the Charges component
import { Button } from '@/components/ui/button';
import { UndoIcon } from 'lucide-react';
import { formatNumber } from '@/utils/utilArray';
import Link from 'next/link';

import { useTrip } from '@/context/tripContext';
import dynamic from 'next/dynamic';
import { loadingIndicator } from '@/components/ui/LoadingIndicator';
import { useToast } from '@/components/hooks/use-toast';
import LoadingSlip from './TripFunctions/LoadingSlip';
import { useSearchParams } from 'next/navigation';

const BiltyForm = dynamic(() => import('../BiltyForm'), { ssr: false, loading: () => loadingIndicator })
const FrieghtMemo = dynamic(() => import('../FrieghtMemo'), { ssr: false, loading: () => loadingIndicator })


const TripDetails = () => {
  const params = useSearchParams()
  const actionFromhome = params.get('open')
  const { trip, setTrip } = useTrip()
  const [charges, setCharges] = useState<TripExpense[]>([])
  const [biltyModalOpen, setBiltyModalOpen] = useState(actionFromhome === 'bilty' ? true : false)
  const [fmModalOpen, setFmModalOpen] = useState(actionFromhome === 'fm' ? true : false)
  const { toast } = useToast()
  const [advanceTotal, setAdvanceTotal] = useState(0);
  const [paymentTotal, setPaymentTotal] = useState(0);





  useEffect(() => {
    const sorted = trip.tripCharges?.sort((a: any, b: any) => new Date(b.date).getTime() - new Date(a.date).getTime());
    setCharges(sorted);
  }, [trip]);

  const handleUndoStatus = async () => {
    const updateDates = (dates: (Date | null)[]): (Date | null)[] => {
      // Create a copy of the array to avoid mutating the original array
      const updatedDates = [...dates];

      for (let i = 1; i < updatedDates.length; i++) {
        if (updatedDates[i] === null) {
          updatedDates[i - 1] = null;
        }
      }

      return updatedDates;
    };
    if (trip.status == 0) {
      alert('Cannot Undo the Status')
      return
    }
    const data = {
      status: trip.status ? trip.status - 1 : alert('No Trip Status'),
      dates: updateDates(trip.dates)
    }
    try {
      const res = await fetch(`/api/trips/${trip.trip_id}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ data }),
      });

      if (!res.ok) {
        throw new Error('Failed to settle amount');
      }
      const resData = await res.json();
      setTrip((prev: ITrip | any) => ({
        ...prev,
        ...resData.trip
      }));
      toast({
        description: 'Trip Status Updated'
      })
    } catch (error) {
      alert(error)
      console.log('Error settling amount:', error);
    }
  }

  const handleStatusUpdate = async (data: any) => {
    try {
      const res = await fetch(`/api/trips/${trip.trip_id}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ data }),
      });

      if (!res.ok) {
        throw new Error('Failed to settle amount');
      }
      const resData = await res.json();
      setTrip((prev: ITrip | any) => ({
        ...prev,
        ...resData.trip
      }));
      toast({
        description: 'Trip Status Updated'
      })
    } catch (error) {
      toast({
        description: 'Failed to update Status',
        variant: 'destructive'
      })
      console.log('Error settling amount:', error);
    }

    if (data.status === 1) {
      try {
        const driverRes = await fetch(`/api/drivers/${trip.driver}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ status: 'Available' }), // Assuming your PATCH route can handle this
        });
        if (!driverRes.ok) {
          throw new Error('Failed to update driver status');
        }
        const truckRes = await fetch(`/api/trucks/${trip.truck}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ status: 'Available' }), // Assuming your PATCH route can handle this
        });
        if (!truckRes.ok) {
          throw new Error('Failed to update truck status');
        }
      } catch (error: any) {
        console.log(error);
        alert(error.message)
      }
    }

    if (data.status === 4 && trip.balance > 0) {
      const itemtosend = {
        ...data,
        accountType: 'Payments',
        trip_id: trip.trip_id,
        driver_id: data.receivedByDriver ? trip.driver : null
      }
      try {
        const res = await fetch(`/api/parties/${trip.party}/payments`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(itemtosend),
        });
        if (!res.ok) {
          throw new Error('Failed to add new item');
        }
        const resData = await res.json();
        if (resData.status == 400) {
          alert(resData.message);
        }
        setTrip((prev: ITrip | any) => ({
          ...prev,
          balance: prev.balance - resData.payment.amount,
          tripAccounts: [resData.payment, ...prev.tripAccounts]
        }))

      } catch (error: any) {
        alert('Failed to Add Payment')
      }
    }

  }

  return (
    <div>
      <div className="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
        {/* Left Side - Trip Details */}
        <div className="col-span-2 pr-4 flex flex-col gap-2">
          {/* <TruckHeader truck={trip.truck} driver={trip.driver} /> */}

          <div className='grid grid-cols-4 gap-2'>
            <Link href={`/user/trucks/${trip.truck}`}>
              <TripInfo label="Lorry" value={trip.truck || '----'} supplierId={trip.supplier || ''} supplierName={trip.supplierName || ''} />
            </Link>
            <Link href={`/user/parties/${trip.party}/trips`}>
              <TripInfo label="Party Name" value={trip.partyName || '----'} />
            </Link>
            <Link href={`/user/drivers/${trip.driver}`}>
              <TripInfo label="Driver" value={trip.driverName || '----'} />
            </Link>
            <TripInfo label="Party Balance" value={`${formatNumber(trip.balance)}`} />
          </div>

          <div className='grid grid-cols-4 gap-2'>
            <TripInfo label="FM No" value={trip.fmNo || '----'} />
            <TripInfo label="LR Number" value={trip.LR || '----'} />
            <TripInfo label="Material" value={trip.material || '----'} guaranteedWeight={trip.guaranteedWeight}/>
            <TripInfo label="Billing Type" value={trip.billingType || '----'} />
          </div>

          <TripInfo label="Route" value={`${trip.route.origin}  ${trip.route.destination}`} startDate={trip.startDate} validityDate={trip?.documents?.find((doc: any) => doc.type === 'E-Way Bill')?.validityDate || null} />
          <div className=" w-full">
            <TripStatus status={trip.status as number} dates={trip.dates} />
          </div>
          <div className="col-span-3 flex flex-col items-center justify-center space-x-4 ">
            <div className='grid grid-cols-2 gap-4'>
              <StatusButton status={trip.status as number} statusUpdate={handleStatusUpdate} dates={trip.dates} amount={trip.balance} />
              <Button variant={'destructive'} onClick={handleUndoStatus} className='h-full'>
                <div className='flex items-center space-x-2 py-2'>
                  <UndoIcon />
                  <span>Undo Status</span>
                </div>
              </Button>
            </div>
            <div className="grid grid-cols-4 gap-4 mt-4">

              <ViewBillButton trips={[]} />
              <Button variant={'outline'} onClick={() => setFmModalOpen(true)}>Generate FM/Challan</Button>
              <Button onClick={() => setBiltyModalOpen(true)}>Generate Bilty</Button>
              <LoadingSlip trip={trip} charges={trip?.loadingSlipDetails?.charges || 0} haltingCharges={trip?.loadingSlipDetails?.haltingCharges || 0}/>

              {/* Add more buttons as needed */}
            </div>
          </div>

        </div>

        {/* Right Side - Profit, Balance, and POD Viewer */}
        <div className="col-span-1 space-y-6">
          <Profit charges={charges} truckCost={trip.truckHireCost && trip.truckHireCost} amount={trip.amount} setCharges={setCharges} tripId={trip.trip_id} driverId={trip.driver} truckNo={trip.truck} tripExpense={trip.tripExpenses} />
          <TripInfo label="Notes" value={trip.notes || 'No notes available'} tripId={trip.trip_id} />
          {/* <EWayBillUpload validity={trip.ewbValidityDate ? trip.ewbValidityDate : null} tripId={trip.trip_id} ewayBillUrl={trip.documents?.find(doc => doc.type == 'ewayBill')?.url || trip.ewayBill} setEwayBillUrl={setEwayBillUrl} />
          {trip.POD ? <PODViewer podUrl={trip.POD} /> : null} */}
        </div>
      </div>
      <div className='grid grid-cols-3 gap-2 mt-4'>
        {/* <div className='col-span-1 bg-[#FAFDFF] p-2 rounded-xl shadow-xl'><DataList
  label="Advances"
  modalTitle="Add Advance"
  displayLabel={`${formatNumber(advanceTotal)}`}
  // displayLabel="Party Payments"
  onTotalAdvanceChange={setAdvanceTotal}
/>
</div> */}
<div className="col-span-1 bg-[#FAFDFF] p-2 rounded-xl shadow-xl">
  <DataList
  label="Advances"
  modalTitle="Add Advance"
  displayLabel={
  <div className="flex justify-between items-center w-full text-gray-800 font-semibold gap-x-2">
    <span>Party Payments</span>
    <span>Total: {formatNumber(advanceTotal)}</span>
  </div>
  }
  onTotalAdvanceChange={setAdvanceTotal}
/>

</div>

<div className='col-span-1 bg-[#FAFDFF] p-2 rounded-xl shadow-xl'>
  <DataList
    label="Payments"
    modalTitle="Add Payment"
    displayLabel={
      <div className="flex justify-between items-center w-full text-gray-800 font-semibold gap-x-2">
        <span>Supplier Payments</span>
        <span>Total: {formatNumber(paymentTotal)}</span>
      </div>
    }
    onTotalAdvanceChange={setPaymentTotal}
  />
</div>

        <div className='col-span-1 bg-[#FAFDFF] p-2 rounded-xl shadow-xl'><Charges tripId={trip.trip_id} /></div>


      </div>
      <BiltyForm isOpen={biltyModalOpen} onClose={() => setBiltyModalOpen(false)} trip={trip} setTrip={setTrip} />
      <FrieghtMemo isOpen={fmModalOpen} onClose={() => setFmModalOpen(false)} />
    </div>
  );
};


export default TripDetails
</file>

<file path="src/utils/DocGeneration.tsx">
import Image from "next/image";
import { useState, useEffect } from "react";
import { getBestLogoColor } from "./imgColor";
import { Card } from "@/components/ui/card";
import { formatNumber } from "./utilArray";
import { EWBFormDataType, FMDataType, PaymentBook } from "./interface";

// ============= ADD THIS FUNCTION BELOW =============
/**
 * Converts an image URL to a base64 Data URL for safe use in html2canvas or PDF export.
 * @param {string} url - The image URL.
 * @returns {Promise<string>} - A promise that resolves to the base64 Data URL.
 */
async function urlToBase64(url: string): Promise<string> {
  const response = await fetch(url);
  const blob = await response.blob();
  return await new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result as string);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}

// ============= END OF INSERT =============

function CompanyHeader({ formData }: { formData: { logo: string; companyName: string } }) {
  const [dominantColor, setDominantColor] = useState("black");

  useEffect(() => {
    async function fetchDominantColor() {
      try {
        const color = await getBestLogoColor(formData.logo);
        setDominantColor(color);
      } catch (error) {
        console.error("Failed to fetch dominant color:", error);
        setDominantColor("black"); // Fallback color
      }
    }

    if (formData.logo) {
      fetchDominantColor();
    }
  }, [formData.logo]);

  return (
    <h1
      className={`text-3xl font-bold`}
      style={{ color: dominantColor }}
    >
      {formData.companyName}
    </h1>
  );
}


export function Bilty({
  formData,
  color,
  selectedCopy,
  isPdfExport = false  // new optional prop with default false
}: {
  formData: EWBFormDataType;
  color: string;
  selectedCopy: string;
  isPdfExport?: boolean;  // add this line
}) {

  const [base64Logo, setBase64Logo] = useState('');
  const [base64Signature, setBase64Signature] = useState('');

  useEffect(() => {
    if (isPdfExport && formData.logo) {
      urlToBase64(formData.logo)
        .then(setBase64Logo)
        .catch(() => setBase64Logo(""));
    }
  }, [isPdfExport, formData.logo]);

  useEffect(() => {
    if (isPdfExport && formData.signature) {
      urlToBase64(formData.signature)
        .then(setBase64Signature)
        .catch(() => setBase64Signature(""));
    }
  }, [isPdfExport, formData.signature]);

  return (
    <div className={`border-2 border-black  w-full h-auto ${color} relative max-w-7xl`}>
      <section className="px-6 py-2 w-full">
        <div className="flex items-center gap-8 justify-center">
          <div className="flex justify-center">
            {formData.logo ? (
  isPdfExport ? (
    <img
      src={base64Logo}
      alt="Company Logo"
      width={80}
      height={80}
      style={{ objectFit: "contain", display: "block" }}
    />
  ) : (
    <Image src={formData.logo} alt="Company Logo" width={80} height={80} />
  )
) : null}



          </div>
          <div className="text-center py-2 border-b border-black">
            <CompanyHeader formData={formData} />
            <h2 className="text-xl font-normal text-gray-700">FLEET OWNERS & TRANSPORT CONTRACTOR</h2>
            <span className=" text-gray-600 whitespace-nowrap">
              {formData.address}, {formData.city}, {formData.pincode}
            </span>
          </div>

          <div className="text-right text-gray-700 absolute top-2 right-2">
            <div className="flex items-center gap-1">
              <div>
                {/* <Image src="https://img.icons8.com/ios-filled/50/000000/phone.png" alt="Phone Icon"
                  height={20} width={20} /> */}
              </div>
              <div>
                <p className="text-xs">{formData.contactNumber}</p>
                <p className="text-xs">{formData.altPhone || ""}</p>
              </div>
            </div>

          </div>
        </div>
      </section>

      <div className="grid grid-cols-4 gap-6 mt-8">
        <div className="col-span-3">
          <section className="">
            <div className="grid grid-cols-3 gap-2">
              <div className=" col-span-1 border-y-2 border-r-2 border-black">
                <p className="text-xs font-semibold text-black text-left mb-2 whitespace-nowrap p-2 border-b-2 border-black ">SCHEDULE OF
                  DEMURRAGE</p>
                <p className="text-xs text-black whitespace-nowrap pl-1">Demurrage chargebl after days</p>
                <p className="text-xs text-black whitespace-nowrap pl-1">from today@RS. perday per Qtl.</p>
                <p className="text-xs text-black whitespace-nowrap pl-1"> On weight charged</p>
              </div >
              <div className="flex flex-col ">
                <span
                  className=" font-semibold text-center p-2 border-b-2 border-black text-[#FF0000] whitespace-nowrap ">{selectedCopy.toUpperCase() + " COPY"}</span>
                <span
                  className=" font-normal text-center p-2 border-b-2 border-black text-black whitespace-nowrap">AT
                  CARRIERS RISK</span>
                <span
                  className="text-black  font-semibold text-center p-2 whitespace-nowrap">INSURANCE</span>
              </div>
              <div className="flex-col w-full col-span-1">
                <div className="border-2 p-2 border-black ">
                  <p className="text-sm text-black text-center font-semibold">Caution</p>
                  <p className="text-xs text-black" style={{ fontSize: "10px" }}>This Consignment will not be
                    detaineddiverted. rerouted or rebooked
                    withoutConsignee Bank&apos;s written permission.Will be delivered at the destination</p>
                </div>

                <div className="py-1 text-black border-b border-black">
                  <span className="text-xs font-semibold ">Address of Delivery Office :</span>
                </div>
                <div className="flex gap-24 text-xs font-semibold">
                  <p>State :</p>
                  <p>Tel : {formData.consignee.contactNumber}</p>
                </div>
              </div>
            </div>
          </section>

          <section className=" mt-4">
            <div className="grid grid-cols-9 gap-2 items-end">
              <div className="border-2 border-[#FF0000] text-[#FF0000] p-2 border-l-0 col-span-3 h-auto pb-2">
                <h3 className="text-xs text-[#FF0000] text-center">NOTICE</h3>
                <p className=" text-[10px]">The consignment covered by this Lorry ceipt shall be stored
                  at the destination Under the control of the Transport Operator
                  and shall be delivered to or to the order of the Consignee
                  Bank whose name is mentioned in the Lorry Receipt. It will
                  under no circumstances be delivered to anyone without the
                  written authority from the Consignee banker or its order.
                  endorsed on the Consignee copy</p>
              </div>
              <div className="col-span-3 border-2 border-black p-2 text-xs text-black h-auto">
                <p>The Customer has stated that:</p>
                <p>He has insured the consignment Company </p>
                <p>Policy No.  Date </p>
                <p>Amount  Date </p>
              </div>
              <div className="col-span-3 text-xs text-black p-2 border-2 border-black flex flex-col gap-1 h-auto pb-2">
                <span className="text-xs">CONSIGNMENT NOTE</span>
                <span>No. : <span className='text-red-600 font-semibold'>{formData.LR}</span></span>
                <span>Date : <span className='text-red-600 font-semibold'>{new Date(formData.date).toLocaleDateString('en-IN')}</span></span>
              </div>




            </div>
          </section>

          <section className="mt-4">
            <div className="grid grid-cols-9 gap-2 items-start">

              <div className="col-span-6 font-semibold text-black border-t-2 border-black h-auto text-sm">
                <div className="border-b-2 border-r-2 border-black px-2 pb-6 flex gap-2 items-center">
                  <p>Consigner Name and Address :</p>
                  <p className="text-red-600">{formData.consigner.name + " " + formData.consigner.address + ', ' + formData.consigner.city + ', ' + formData.consigner.pincode}</p>
                </div>
                <div className="border-b-2 border-r-2 border-black px-2 pb-6 flex gap-2 items-center">
                  <p>Consignee Name and Address :</p>
                  <p className="text-red-600">{formData.consignee.name + " " + formData.consignee.address + ', ' + formData.consignee.city + ', ' + formData.consignee.pincode}</p>
                </div>
              </div>


              <div className="col-span-3 text-xs text-black h-auto">
                <div className="space-y-1">
                  <p className="border-2 border-black p-2 text-red-600 flex items-center">
                    <span className="text-black mr-1">From:</span>{formData.from}
                  </p>
                  <p className="border-2 border-black p-2 text-red-600 flex items-center">
                    <span className="text-black mr-1">To:</span>{formData.to}
                  </p>
                </div>
              </div>
            </div>
          </section>


          <section className=" mt-2">
            <table className="table-fixed w-full text-xs border border-black border-collapse">
              <thead className="font-semibold text-center">
                <tr>
                  <th className="border border-black p-2" rowSpan={2}>Packages</th>
                  <th className="border border-black p-2" rowSpan={2}>Description (said to contain)</th>
                  <th className="border border-black p-0" colSpan={2}>
                    <p className="p-2">Weight (MT)</p>
                    <div className="grid grid-cols-2 border-t border-black">
                      <div className="border-r border-black p-2">Actual</div>
                      <div className="border-l border-black p-2">Charged</div>
                    </div>
                  </th>
                  <th className="border border-black p-2" rowSpan={2}>Rate</th>
                  <th className="border border-black p-2" rowSpan={2}>Amount to pay/paid</th>
                </tr>
              </thead>

              <tbody className="text-center text-red-600 font-semibold">
                {formData.materials.map((item, index: number) => (
                  <tr key={index}>
                    <td className="border border-black p-2">{index + 1}</td>
                    <td className="border border-black p-2">{item.name}</td>
                    <td className="border border-black p-2">{item.weight} {['fixed', 'ftl'].includes(item.weight.toLowerCase()) ? "" : "MT"}</td>

                    {index === 0 && <>
                      <td className="border border-black p-2" rowSpan={formData.materials.length}>
                        <div className="h-full flex items-center justify-center">
                          {formData.grtdWeight} {['fixed', 'ftl'].includes(formData.grtdWeight.toString().toLowerCase()) ? "" : "MT"}
                        </div>
                      </td>
                      <td className="border border-black p-2" rowSpan={formData.materials.length}>
                        <div className='flex flex-col gap-3 text-black text-left'>
                          <p>Mazdoor</p>
                          <p>Hire Charges</p>
                          <p>Sur. Ch.</p>
                          <p>St. Ch.</p>
                          <p>Risk Ch.</p>
                          <p className='mt-2 text-xs'>TOTAL</p>
                        </div>
                      </td>
                      <td className="border border-black p-2" rowSpan={formData.materials.length}>
                        <div className='flex flex-col justify-between h-full'>
                          <div className='flex font-semibold gap-4 flex-col items-center py-3 justify-between'>
                            <p>TO</p>
                            <p>BE</p>
                            <p>BILLED</p>
                          </div>
                          <div className='border-t border-black h-1'></div>
                        </div>
                      </td>
                    </>}

                  </tr>
                ))}
              </tbody>
            </table>



          </section>

        </div>
        <div className="col-span-1 border-2 border-black border-r-0">
          <div className="text-[11px] border-b-2 border-black">
            <div className="border-b-2 p-2 border-black flex flex-col">
              <span>Address of Issuing Office : </span>
              <span>Name and Address of Agent : <span className='text-red-600 font-semibold'>{formData.companyName}</span></span>
            </div>
            <div className="flex items-center justify-center text-center p-16 text-3xl font-semibold text-red-600">{formData.city}</div>
          </div>
          <div className="border-b-2 border-black">
            <div className="border-b-2 border-black p-2">
              <p className="text-xs text-black">SERVICE TAX TO BE PAID BY</p>
            </div>
            <div className="grid grid-cols-3 text-[10px] h-[25px]">
              <div className="flex items-center justify-center border-r-2 border-black p-2 overflow-hidden">
                CONSIGNER
              </div>
              <div className="flex items-center justify-center border-r-2 border-black p-2 overflow-hidden">
                CONSIGNEE
              </div>
              <div className="flex items-center justify-center p-2 overflow-hidden">
                SIGNATORY
              </div>
            </div>
          </div>

          <div className="border-b-2 border-black text-xs flex flex-col gap-4 h-auto">
            <h3 className="text-black text-center">Service Tax Reg No.</h3>
            <div>
              <p className="mt-4 text-black p-1 ">GST No. {formData.gstNumber}</p>
              <p className=" text-black mb-2 p-1 ">PAN No. {formData.pan}</p>
            </div>

          </div>
          <div className=" text-black text-sm font-semibold flex flex-col justify-evenly gap-6 p-2">
            <span className="underline text-black">Private Mark</span>
            <div className="flex flex-col gap-2">
              <span>
                ST No :
              </span>
              <span>
                CST No :
              </span>
              <span>
                DO No. :
              </span>
              <span>
                INV No. : <span className='text-red-600'>{formData.invoiceNo}</span>
              </span>
            </div>
            <span>
              Date : <span className='text-red-600'>{new Date(formData.date).toLocaleDateString('en-IN')}</span>
            </span>
            <span>
              Lorry No. : <span className='text-red-600'>{formData.truckNo}</span>
            </span>
          </div>

        </div>
        <div className="text-sm p-2 pt-0 flex items-center justify-between w-full">
  <div className="flex items-center gap-4 whitespace-nowrap">
    <span className="text-black">
      Value: <span className="text-red-600 font-semibold">{formData.value || "As Per Invoice"}</span>
    </span>
    <span className="text-black">Signature of Transport Operator:</span>
  </div>

  {formData.signature ? (
  isPdfExport ? (
    <img
      src={base64Signature}
      alt="user signature"
      width={60}
      height={60}
      style={{ objectFit: "contain", display: "block" }}
    />
  ) : (
    <Image src={formData.signature} alt="user signature" width={60} height={60} />
  )
) : null}

</div>

      </div>
<div className="text-center text-xs mt-4 py-4">
  <p className="flex items-center justify-center">
    <span>Powered to</span>
    <span style={{ display: 'inline-block', margin: '0 0.25rem', verticalAlign: 'middle' }}>
      {isPdfExport ? (
        <img
          src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOQAAAD0CAYAAACLgYoWAAAACXBIWXMAACxLAAAsSwGlPZapAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAABPbSURBVHgB7Z1dchRHFoVvNRg5Yh4sr8DFCiytwGIFxitw82BiICZCYgVIK7AU4YCJmAeaFVizAqQVoFkBYgWjeTOY6XJmVrbULXVX5W/VzczzRRDIpoUA9amTefPcvERgVJq/U908p0MCQDAhMC6VEuN+c0DbBIoHghwR6Y5CkD+LD7fpMx0QKB4IckyqlaUqXBJAkGOx5I4LpEv+SqBoIMixqNYWcqZKqKBYIMgREKLbu+WON1T0hkCxQJBjUNHLjl/bU4IFRQJBDow4c5xK0XW+qEuwIGsgyOHpFxtcslggyAFR7kiGRRu4ZJFAkMNiLrLWJacEigKCHAgrd1wgXBJhgbKAIIfDfglaCQEjUlcUEOQAOLnjDYjUFQQEGRmdvPEp0CB4XhAQZHxkIqcmP+CShQBBRkS54ySIu8ElCwGCjEkbIA/lbC8RPM8fCDISa9qr/JkgLJA7EGQsqij35EwRqcsbCDICUdxxASJ1WQNBxqCKeIscgudZA0EGJqo7LoBLZgsEGZohOv7hktkCQQZEX82xR0OAqz6yBIIMyWRAkVRUN08RFsiNikAQdIB8aNe6ogf0sDoWP4MsgEOGY4xCCyJ1mQFBBsCzvcoXBM8zAoIMw5jHEHDJjIAgPRnZHRfsI3ieBxCkPxwO6bcRPM8DCNID4UpSBDXxYNr8QjsEkgaCdEQ3H0+JE/cxPSt1IEh3QlzNERZE6pIHgnRAu+MhcQTB86SBIF2omIpRApdMGgjSkkHaq3yBSyYLBGkLZ3dcgLkgyYJwuQV67/iBUqChS9qiXQTP0wIOaUMK7rgAc0GSBA5piDp0/4reU1qgPSsx4JCmpHnojuB5YsAhDRip+TgUcMmEgEOakfIxwjZ9wjFIKsAhe0jcHW+YC5f8p6i8AtbAIfvJw10qBM9TAILsgEnzcRgqeoxIHX8gyG7y2nshUsceCHIDWbnjAgTP2QNBrkHfT5Onm8AlWQNBrodf83EopEs+o8cEWAJB3oLl1RzhQcWVKRDkbdoAeU05g7kgbEEwYImk2qv8QaSOIXDIZVJqr/IHwXOGwCE1hbnjArgkM+CQC8pyxwVwSWbAIalYd1xwRXPaRfCcB3BISdnBa8wFYUTxDqmiZBN6R6Uzp0fCJc8IjAoccoJDcgUidSwoWpA6QI6JURIEz1lQukPCFZaBS45OsYLMsr3KF7jk6JTskHCDdWBPPSpFChLu2MkO5oKMR6kOCXfsQuwlmwNxPgkGpzhBiqe/FGNNYDOYCzIaRQUDdEROhgBqAn0geD4CpTlkvldzhAfB8xEoxiFZB8gbFey+kHenEi/gkgNTjkNybq9q6Ej8eEH8wFyQgSnCIbm7Y/WaHqoPn9Ox+GmfuIG5IINRhkNydsd79OT64wfqz8lveVhlMGwoEbIXpHLHShVzODKrfrtpedJ7tRPiBiJ1g5G/Q3J2x7nYO97mgVq2cnRJ7CUHIGtBsnfHNfsyuGTZ5O2QnPc+69xxQeuSl8QNuGR0shWkml9RsX2iz7qqltolj4gbrUtOCUQjX4fke3HVVac7aqpXNBNHImfEDbhkVLIUJPP2qhPjM72GpUvW4t/3kEAUcnVInk9xGZGbC+czRN0Cx9ElifbRnhWH7ATJ2h2F41knXji6JILn0cguOicEKSNyNXFjKSJn/anP6B3DAhWC5xHIyiG5uyO50izF6/gAl4xANg7JuvnYwx2vfwuewXPMBQlMTg7Jt/k4xD6QZ/Acc0ECk4UgtTtOiSfnwkFm5AnbSB3RFJG6cOThkG2AvCaOzAM+KBA8z57kBZligNwVBM/zJ32HTK29yhcEz7MmaUGW5I4LmAfP9wh4kbZDluaOGsbBc1z14UmygmTujkfRz+a4Bs/RnuVFug7J1R0tA+SusA2eT+hXBM/dSVKQaq/C1x1PBkuuIHieHUlG55iGrYNE5Ky/JILnWZGcQ6oAOderOcZwLATPsyI5h8yxvcr7Sz8Te1Z+S3i4pANJOWS27VW+bCk34hc8/4zx6LaktmTlmga5CBEgd4V58LwmYEwygmTtjhMGk6v4Bs8RFrAgJYfk6o4r8znGAsHzPEhCkOIbKsVYE0fmjM4C0Z6VPOwFybz5eMbp+grtkvwGv8IljUnBIflezWHpjjJS1vfGlA8gnzyoCp6jPStZWAtSu+Mh8cTKHZUQP9N78ffZ63mp/Du/EWeL7pnQOcOwAOaCGMHbIXkHyI3cUbmiENf1jXiN4R6vEmeLn+i9y1KPbfBcuCSC592wFSTr9qqK3pq447UrVisxst7PW/o66mpLJ7dk2p6FSF03fB2SsTuKfdph50tuu+Iy93ocslojvIVb/kI7ZAjmgqQJS0Gydsce59ngijd86XHIasObVbrLV2oJa14c+cKw4orgeSc8HZKzO26IyHW64hLexySiyCW+zgeTSFr1L7oQf+a3xA+45AbYCTJFd+x1xRsuqP9r9L9R273lByO3bJjeeA6XXAs/h+SafVzjjqauuMT/el9RWTiHgVtqR+YYPH+J4PldWAlSX82xRzxZ2Y9ZuOIyHyg0Jm7JNVKHuSB34OWQE7adAefVazqVHzi44jIfe1/ROLpGh1tiLkg6sBEk6/YqPZ/D0RVvaAz2kD50uSWC50nAySHZtlfR13Tl4Yo3fDGqsH5HvqxxS+WSPMMCCJ4vwUKQzN3x3MsVl/nbgKHvNW4plt2YC8IcLg7J9xvS7mtr8ufC6MKnKvD5XOuW767dkm/wfI/A+IJk7Y5h6T/yaPmWQiMr1xN63zylA8bBc1z1QSMLUqc1SlmumBZ0/PeQ69mm+/SrvliZX3pHzgV5irDAuA75B+1TGe5IbFxJumWjHoL8Kq730Z41miCZX80Rnnv9AhgsuVKpr8PxjV98pG48h2wD5DUVgtHNdBMErqnw4PkogmQ+2zEGZvvHOQRJhbvkOA7JefJxDOYGkTlJBUFq9ksNng8uyALdUQrtzPCVNQHJdqnB8+EdsjR3lNwzXLLCIZeZ2lxZkguDCrJIdyTDgo6kgUOucL+86VnDOmSJ7kh0bvHaWKGANCkwUjeYIHXzcXHuKDgj4E5hwfPhHLLURP/EQpBVeXumXgpzyUEEqQLkfK/miIrlqDoUddZR0MN8KIcstd/NeP+IC586KGguSHRBFtRedZemvYfHkJrAZgqZCzKEQ5bbDf7Fav+I5WoXhcwFiSrIwt3xUt0cbgoKOiZkHzyP7ZDlumNledyBUIAJ2QfPowmyeab+4WoqlYl1Vz5CAWZk7ZJRBKkjcvtUKnK5+pulQ1b0kIAJ2/Qp35VXLIeUiZyaSqVySufAIU2p6CDXY6LggtRXc5R9WdHc7kJiUfxCQceWKs/geXiHbAPkJZfwL6xnQKKgY09Fj3OM1AUVZKntVSvMHYba4MjDjQwjdWEdssz2qhs6Jiz3AEG6kGHwPJgg4Y7kWsyRQv6GgBuZuWQ4hyzdHSVzx+lSWLK6I13yGT2mTAgiSLijYmZdzKHrCityrH5kU3EN45AYlOLujqiw+pPRXBBvQeqrOfaobJzcUYHlahgymQvi75CT4t3xytkdWyDIMGQRPPcSZNHtVTecOLtjy/cEQpF88NzXIcseRS3PHV+5V5f1m6cmEIrkXdJZkHBHkjeS+40H/4Qx3hFIei6Ij0OW7Y5yqfqb552rKOjEIOm5IE6CLN4dxVKVHgQIQjT0A4EYTFON1Lk6ZOl7x0fVcYCR4HDIeCQaqbMWpHjyyL9oTaXS0AvPqmr72yChE5dEg+dWgtTNx1Mql6PqNR1TCBoUdKKToEvaOWR7T05NJdLQqc8Rxx2QbopPgi5pLEgdIC/1ao4L2vI84rgLCjpDMEkreG7ukOW2V12IimqYIo5GP7WxfxyGnZTmghgJsuD2quBiVKC6OiwJzQUxc8gS3VEOyokhxpYfCQxHQnNBqr4X6MrqByqLE1HAifINVE/qz/RfAkNzJR6wDyM9YIPR75BlueOVOmd8FfFpivzqWCQRPO8UpG4+LmPvKONwf4olaqhzxs1kc/9LgrBvz+p2yHJGSZ+IY41dq/FxrlQ47hgR9nNBNu4hdYA879sApCveoyfeXRumX06uOCb0jsC4zMVeMkD8MQb3O34tZ3eUG/sTsTw9pCGpio4d8qG9lO0RMWTtkjXj9iopxCNVbXs1QrHKdbna8HyaJwvjSN0mh8zNHZUjCiEej1X21m+AmmyRYmzE07yi94R0Tzja+sgZMeOOQ2bmjiuOOOoZlOtytaEjtd9pvG62A7dh6pJ3ijpCkDIEUFPanItHzeFQxRoTxL+rDAPYOty5eJDsXf8ez0RBCF0i4WjoTNQRWO0lVxwycXc8l4f6wg2/lW9iZmKckstyc37LVRvVccI6aZIUrUtOiRHXDqkjcrIkX1MayDfmf1TmdItmnCNRjs42Ew+WJ2t+r4NcpwePgrzK8zU9JCYsC/KlXOYRZyolwDPx5zwV5agL7rlEiWMWWN6GvrvprAxL1+AcjVJ1X4OqsjK9mkOK7ZxkC9REiDARAd7BLQvcfRu6XLqi6hoSGak75vD+ao892jdNTeNwJb7+R+EIMrZ2QffEG/GLEB/TJIU1tmeP7RLqsPO3FP82wiWPsHQNxiJ4fkgjUw3UXvVR/LhUZ2qVEtql+JpXWQlvDU7xwzk9MR2LjqVrUFi0Z923XFJ9XPr4ktp2JelwVysfT5TLXdLXdJXkMjMctgGLf5uKUbFFP4knu3yYYunqDwuXrJp/6CfsXBUS7ognZweLiRqzXdHvVp/kEHp2+jpgE53FtCHovTEAuOGwnHSu9Imlsezh3CcQgrXHTUMRZqQ5WMF6qnQ7K8S9MbqdM3JJIASjzgWBIGMwsbwqQuZVPfba6nP/FPtJEIYRG/MhyMDop6vNrXIzq0LOBtRtBzI6CPwZMXgOQYbG9uk6D9fFoe4Davi1FCXJSC4JQQZEVzz3LD7lKHhFb0stXS8J+DGSS0KQIbFJzshEToT8pNpPzserEmZFNfydUhBkIKxb15p4fXjCdc+wnwxARfXQ7Vk4hwyAvo1chr1rw08ZpLtALKF/F99h3APrx6CROjhkCP6wmJsZaam6lnaE3iUBHwa98RwO6Yl1OH/gO0GbX2iHvlKN58i7ujOYS8IhfZlY5UiPhs5JqvPJOfaTngzmknBID6yu0xj5qgjkXb0ZxCXhkI7oIbbmh8fNuLebqYleCA34IF0yekM4BOlKe0Zlui87YtHGhtCAL1P1II4IBOmAXqrumb2YTrlcoKRDA9KpLwm4ETksAEFaopeqxvtGbgf0yqnbzhDc7+pC5EgdBGmBCgDYjJO7p+7HuSRmoPLqScTgOQRpQzvsszZ89RGn29Nvo1u+MC/EhYguCUEaoveNpmdR51z2jV3oPyNE6UIkl4QgDbA64pD7xnk6g1mVKBt6S8COSHNBEAzowXrmCeNx2V2IFcBMvBt+JmCOfPhu0W7IsAAcso82GlcbvVZUVJO9NnNLLccvCJhTifdF4EgdBNmBcA15vLFj+PIjdYVGoqin/AN1RglR2rGvqu+BgCA3oKaBmRZxGB3++wBROhE0eA5BrkFVVM1H813ovsMsgCidCOaSEOQt9EVV5kmcOf2U2/wSiNKaYC6JKusSVs28bSzuUdbTu+RT/5PYF6P6akaACjscUmPZWX+Vuxgl0ilFoWoqPjwh0M/EPywAh6Trs0bTicTy2v5HKg9aEM1ztace7Yr9ZJirB/UZOVK8Qy4d/EOMHSBmZ4hnpK5oh9TLVNOD/2LFuIwuetk0Z5eHh0sW65BLe8ba4OUQo0bsKU/lUFNCk/NmPFyySEGq1hmbairEuIIqZs1xLLIRj/as4gQpllw/G+8ZF0cbEOMdpCjFvlI6JfaV63C86qMoQeqexpnZi/M/ZwyBLvbghvTbyLkgT+3DAsUUdVQ21TwOd04P6HFuCZyYWLeplYH1Xa5FOKQ4Q3tjIcYT8dTfgxjt0EtYeRE0lrA3WEfqsnZIPZVKPrVNWqhk+ibpFiouwC1XsHLJbB1SvSnaEXH9YlxUUiHGIMAtV7ByySwdUpWc205/k0rqqWyfwhI1DnBLhbygetekQJidQ+rijcmxxpW6cuN1fu1TnFhyy5IrsdumwfNsHFLvF2Uf49Tg5ReqjxFHGoOi3VIu38qcwvWncMmeM+0sBGm5LDrK4bqNlNHXah4W12fZ0JlYkXVOQUtekCp5U6liTN8S9Vw8oQ6QuuFDkcLsCZ4nLUh1K1z/RVQ4zmBOUcLscckkBamXqLKK2nekMRNnQC9QtEmDYoTZ4ZLJCdKwH+9cJnM4D7sBm9HClN9nWfypKTc6XDIZQeoLl7rvSpUH/HIEHISYDc1zVTWXP36gnJirUYWz2/87CUEadPZjn5g52bnmhrkg7AWpW6bkoeq6Jar8y5yIfeIx9onlIFxT1g6m4sePlLY47xzBsRWkfiK+kd3Xa34ZQgQKLc7Hyj0b+p7S4k7wnKUgOwo352LtPVu39gZAV9/3SAq03XOmcBHXikuyEmRH4QZVU2CNcs9GCLRdZXEV6IpLshGk7tCQrljr/yX/gHKy70w8QZCuAd7o5e3yDx6V20ZsvV7TC/nh6IJc44rnuiVqhv0hiI0S6USYwFy5qBSp3IcO76R6LsioglxyRfkP8FZ8fIplKRgbZRJflDi3hVBaN5XTkhv6jmKJVc4Yla2ANAJLrrgLNwQpodv8auWq/1cnAVKgrXjlxz6ilZE6Ghh9yL8jvvgZ+hFBrqiK731dD5krd93W4t3WH7e/Vun/JvpG/HzxFxycz+sV8RQvAAAAAElFTkSuQmCC"
        alt="Awajahi logo"
        width={20}
        height={20}
        style={{
          verticalAlign: 'middle',
          display: 'inline-block',
          margin: '0 4px',
        }}
      />
    ) : (
      <Image
        src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOQAAAD0CAYAAACLgYoWAAAACXBIWXMAACxLAAAsSwGlPZapAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAABPbSURBVHgB7Z1dchRHFoVvNRg5Yh4sr8DFCiytwGIFxitw82BiICZCYgVIK7AU4YCJmAeaFVizAqQVoFkBYgWjeTOY6XJmVrbULXVX5W/VzczzRRDIpoUA9amTefPcvERgVJq/U908p0MCQDAhMC6VEuN+c0DbBIoHghwR6Y5CkD+LD7fpMx0QKB4IckyqlaUqXBJAkGOx5I4LpEv+SqBoIMixqNYWcqZKqKBYIMgREKLbu+WON1T0hkCxQJBjUNHLjl/bU4IFRQJBDow4c5xK0XW+qEuwIGsgyOHpFxtcslggyAFR7kiGRRu4ZJFAkMNiLrLWJacEigKCHAgrd1wgXBJhgbKAIIfDfglaCQEjUlcUEOQAOLnjDYjUFQQEGRmdvPEp0CB4XhAQZHxkIqcmP+CShQBBRkS54ySIu8ElCwGCjEkbIA/lbC8RPM8fCDISa9qr/JkgLJA7EGQsqij35EwRqcsbCDICUdxxASJ1WQNBxqCKeIscgudZA0EGJqo7LoBLZgsEGZohOv7hktkCQQZEX82xR0OAqz6yBIIMyWRAkVRUN08RFsiNikAQdIB8aNe6ogf0sDoWP4MsgEOGY4xCCyJ1mQFBBsCzvcoXBM8zAoIMw5jHEHDJjIAgPRnZHRfsI3ieBxCkPxwO6bcRPM8DCNID4UpSBDXxYNr8QjsEkgaCdEQ3H0+JE/cxPSt1IEh3QlzNERZE6pIHgnRAu+MhcQTB86SBIF2omIpRApdMGgjSkkHaq3yBSyYLBGkLZ3dcgLkgyYJwuQV67/iBUqChS9qiXQTP0wIOaUMK7rgAc0GSBA5piDp0/4reU1qgPSsx4JCmpHnojuB5YsAhDRip+TgUcMmEgEOakfIxwjZ9wjFIKsAhe0jcHW+YC5f8p6i8AtbAIfvJw10qBM9TAILsgEnzcRgqeoxIHX8gyG7y2nshUsceCHIDWbnjAgTP2QNBrkHfT5Onm8AlWQNBrodf83EopEs+o8cEWAJB3oLl1RzhQcWVKRDkbdoAeU05g7kgbEEwYImk2qv8QaSOIXDIZVJqr/IHwXOGwCE1hbnjArgkM+CQC8pyxwVwSWbAIalYd1xwRXPaRfCcB3BISdnBa8wFYUTxDqmiZBN6R6Uzp0fCJc8IjAoccoJDcgUidSwoWpA6QI6JURIEz1lQukPCFZaBS45OsYLMsr3KF7jk6JTskHCDdWBPPSpFChLu2MkO5oKMR6kOCXfsQuwlmwNxPgkGpzhBiqe/FGNNYDOYCzIaRQUDdEROhgBqAn0geD4CpTlkvldzhAfB8xEoxiFZB8gbFey+kHenEi/gkgNTjkNybq9q6Ej8eEH8wFyQgSnCIbm7Y/WaHqoPn9Ox+GmfuIG5IINRhkNydsd79OT64wfqz8lveVhlMGwoEbIXpHLHShVzODKrfrtpedJ7tRPiBiJ1g5G/Q3J2x7nYO97mgVq2cnRJ7CUHIGtBsnfHNfsyuGTZ5O2QnPc+69xxQeuSl8QNuGR0shWkml9RsX2iz7qqltolj4gbrUtOCUQjX4fke3HVVac7aqpXNBNHImfEDbhkVLIUJPP2qhPjM72GpUvW4t/3kEAUcnVInk9xGZGbC+czRN0Cx9ElifbRnhWH7ATJ2h2F41knXji6JILn0cguOicEKSNyNXFjKSJn/anP6B3DAhWC5xHIyiG5uyO50izF6/gAl4xANg7JuvnYwx2vfwuewXPMBQlMTg7Jt/k4xD6QZ/Acc0ECk4UgtTtOiSfnwkFm5AnbSB3RFJG6cOThkG2AvCaOzAM+KBA8z57kBZligNwVBM/zJ32HTK29yhcEz7MmaUGW5I4LmAfP9wh4kbZDluaOGsbBc1z14UmygmTujkfRz+a4Bs/RnuVFug7J1R0tA+SusA2eT+hXBM/dSVKQaq/C1x1PBkuuIHieHUlG55iGrYNE5Ky/JILnWZGcQ6oAOderOcZwLATPsyI5h8yxvcr7Sz8Te1Z+S3i4pANJOWS27VW+bCk34hc8/4zx6LaktmTlmga5CBEgd4V58LwmYEwygmTtjhMGk6v4Bs8RFrAgJYfk6o4r8znGAsHzPEhCkOIbKsVYE0fmjM4C0Z6VPOwFybz5eMbp+grtkvwGv8IljUnBIflezWHpjjJS1vfGlA8gnzyoCp6jPStZWAtSu+Mh8cTKHZUQP9N78ffZ63mp/Du/EWeL7pnQOcOwAOaCGMHbIXkHyI3cUbmiENf1jXiN4R6vEmeLn+i9y1KPbfBcuCSC592wFSTr9qqK3pq447UrVisxst7PW/o66mpLJ7dk2p6FSF03fB2SsTuKfdph50tuu+Iy93ocslojvIVb/kI7ZAjmgqQJS0Gydsce59ngijd86XHIasObVbrLV2oJa14c+cKw4orgeSc8HZKzO26IyHW64hLexySiyCW+zgeTSFr1L7oQf+a3xA+45AbYCTJFd+x1xRsuqP9r9L9R273lByO3bJjeeA6XXAs/h+SafVzjjqauuMT/el9RWTiHgVtqR+YYPH+J4PldWAlSX82xRzxZ2Y9ZuOIyHyg0Jm7JNVKHuSB34OWQE7adAefVazqVHzi44jIfe1/ROLpGh1tiLkg6sBEk6/YqPZ/D0RVvaAz2kD50uSWC50nAySHZtlfR13Tl4Yo3fDGqsH5HvqxxS+WSPMMCCJ4vwUKQzN3x3MsVl/nbgKHvNW4plt2YC8IcLg7J9xvS7mtr8ufC6MKnKvD5XOuW767dkm/wfI/A+IJk7Y5h6T/yaPmWQiMr1xN63zylA8bBc1z1QSMLUqc1SlmumBZ0/PeQ69mm+/SrvliZX3pHzgV5irDAuA75B+1TGe5IbFxJumWjHoL8Kq730Z41miCZX80Rnnv9AhgsuVKpr8PxjV98pG48h2wD5DUVgtHNdBMErqnw4PkogmQ+2zEGZvvHOQRJhbvkOA7JefJxDOYGkTlJBUFq9ksNng8uyALdUQrtzPCVNQHJdqnB8+EdsjR3lNwzXLLCIZeZ2lxZkguDCrJIdyTDgo6kgUOucL+86VnDOmSJ7kh0bvHaWKGANCkwUjeYIHXzcXHuKDgj4E5hwfPhHLLURP/EQpBVeXumXgpzyUEEqQLkfK/miIrlqDoUddZR0MN8KIcstd/NeP+IC586KGguSHRBFtRedZemvYfHkJrAZgqZCzKEQ5bbDf7Fav+I5WoXhcwFiSrIwt3xUt0cbgoKOiZkHzyP7ZDlumNledyBUIAJ2QfPowmyeab+4WoqlYl1Vz5CAWZk7ZJRBKkjcvtUKnK5+pulQ1b0kIAJ2/Qp35VXLIeUiZyaSqVySufAIU2p6CDXY6LggtRXc5R9WdHc7kJiUfxCQceWKs/geXiHbAPkJZfwL6xnQKKgY09Fj3OM1AUVZKntVSvMHYba4MjDjQwjdWEdssz2qhs6Jiz3AEG6kGHwPJgg4Y7kWsyRQv6GgBuZuWQ4hyzdHSVzx+lSWLK6I13yGT2mTAgiSLijYmZdzKHrCityrH5kU3EN45AYlOLujqiw+pPRXBBvQeqrOfaobJzcUYHlahgymQvi75CT4t3xytkdWyDIMGQRPPcSZNHtVTecOLtjy/cEQpF88NzXIcseRS3PHV+5V5f1m6cmEIrkXdJZkHBHkjeS+40H/4Qx3hFIei6Ij0OW7Y5yqfqb552rKOjEIOm5IE6CLN4dxVKVHgQIQjT0A4EYTFON1Lk6ZOl7x0fVcYCR4HDIeCQaqbMWpHjyyL9oTaXS0AvPqmr72yChE5dEg+dWgtTNx1Mql6PqNR1TCBoUdKKToEvaOWR7T05NJdLQqc8Rxx2QbopPgi5pLEgdIC/1ao4L2vI84rgLCjpDMEkreG7ukOW2V12IimqYIo5GP7WxfxyGnZTmghgJsuD2quBiVKC6OiwJzQUxc8gS3VEOyokhxpYfCQxHQnNBqr4X6MrqByqLE1HAifINVE/qz/RfAkNzJR6wDyM9YIPR75BlueOVOmd8FfFpivzqWCQRPO8UpG4+LmPvKONwf4olaqhzxs1kc/9LgrBvz+p2yHJGSZ+IY41dq/FxrlQ47hgR9nNBNu4hdYA879sApCveoyfeXRumX06uOCb0jsC4zMVeMkD8MQb3O34tZ3eUG/sTsTw9pCGpio4d8qG9lO0RMWTtkjXj9iopxCNVbXs1QrHKdbna8HyaJwvjSN0mh8zNHZUjCiEej1X21m+AmmyRYmzE07yi94R0Tzja+sgZMeOOQ2bmjiuOOOoZlOtytaEjtd9pvG62A7dh6pJ3ijpCkDIEUFPanItHzeFQxRoTxL+rDAPYOty5eJDsXf8ez0RBCF0i4WjoTNQRWO0lVxwycXc8l4f6wg2/lW9iZmKckstyc37LVRvVccI6aZIUrUtOiRHXDqkjcrIkX1MayDfmf1TmdItmnCNRjs42Ew+WJ2t+r4NcpwePgrzK8zU9JCYsC/KlXOYRZyolwDPx5zwV5agL7rlEiWMWWN6GvrvprAxL1+AcjVJ1X4OqsjK9mkOK7ZxkC9REiDARAd7BLQvcfRu6XLqi6hoSGak75vD+ao892jdNTeNwJb7+R+EIMrZ2QffEG/GLEB/TJIU1tmeP7RLqsPO3FP82wiWPsHQNxiJ4fkgjUw3UXvVR/LhUZ2qVEtql+JpXWQlvDU7xwzk9MR2LjqVrUFi0Z923XFJ9XPr4ktp2JelwVysfT5TLXdLXdJXkMjMctgGLf5uKUbFFP4knu3yYYunqDwuXrJp/6CfsXBUS7ognZweLiRqzXdHvVp/kEHp2+jpgE53FtCHovTEAuOGwnHSu9Imlsezh3CcQgrXHTUMRZqQ5WMF6qnQ7K8S9MbqdM3JJIASjzgWBIGMwsbwqQuZVPfba6nP/FPtJEIYRG/MhyMDop6vNrXIzq0LOBtRtBzI6CPwZMXgOQYbG9uk6D9fFoe4Davi1FCXJSC4JQQZEVzz3LD7lKHhFb0stXS8J+DGSS0KQIbFJzshEToT8pNpPzserEmZFNfydUhBkIKxb15p4fXjCdc+wnwxARfXQ7Vk4hwyAvo1chr1rw08ZpLtALKF/F99h3APrx6CROjhkCP6wmJsZaam6lnaE3iUBHwa98RwO6Yl1OH/gO0GbX2iHvlKN58i7ujOYS8IhfZlY5UiPhs5JqvPJOfaTngzmknBID6yu0xj5qgjkXb0ZxCXhkI7oIbbmh8fNuLebqYleCA34IF0yekM4BOlKe0Zlui87YtHGhtCAL1P1II4IBOmAXqrumb2YTrlcoKRDA9KpLwm4ETksAEFaopeqxvtGbgf0yqnbzhDc7+pC5EgdBGmBCgDYjJO7p+7HuSRmoPLqScTgOQRpQzvsszZ89RGn29Nvo1u+MC/EhYguCUEaoveNpmdR51z2jV3oPyNE6UIkl4QgDbA64pD7xnk6g1mVKBt6S8COSHNBEAzowXrmCeNx2V2IFcBMvBt+JmCOfPhu0W7IsAAcso82GlcbvVZUVJO9NnNLLccvCJhTifdF4EgdBNmBcA15vLFj+PIjdYVGoqin/AN1RglR2rGvqu+BgCA3oKaBmRZxGB3++wBROhE0eA5BrkFVVM1H813ovsMsgCidCOaSEOQt9EVV5kmcOf2U2/wSiNKaYC6JKusSVs28bSzuUdbTu+RT/5PYF6P6akaACjscUmPZWX+Vuxgl0ilFoWoqPjwh0M/EPywAh6Trs0bTicTy2v5HKg9aEM1ztace7Yr9ZJirB/UZOVK8Qy4d/EOMHSBmZ4hnpK5oh9TLVNOD/2LFuIwuetk0Z5eHh0sW65BLe8ba4OUQo0bsKU/lUFNCk/NmPFyySEGq1hmbairEuIIqZs1xLLIRj/as4gQpllw/G+8ZF0cbEOMdpCjFvlI6JfaV63C86qMoQeqexpnZi/M/ZwyBLvbghvTbyLkgT+3DAsUUdVQ21TwOd04P6HFuCZyYWLeplYH1Xa5FOKQ4Q3tjIcYT8dTfgxjt0EtYeRE0lrA3WEfqsnZIPZVKPrVNWqhk+ibpFiouwC1XsHLJbB1SvSnaEXH9YlxUUiHGIMAtV7ByySwdUpWc205/k0rqqWyfwhI1DnBLhbygetekQJidQ+rijcmxxpW6cuN1fu1TnFhyy5IrsdumwfNsHFLvF2Uf49Tg5ReqjxFHGoOi3VIu38qcwvWncMmeM+0sBGm5LDrK4bqNlNHXah4W12fZ0JlYkXVOQUtekCp5U6liTN8S9Vw8oQ6QuuFDkcLsCZ4nLUh1K1z/RVQ4zmBOUcLscckkBamXqLKK2nekMRNnQC9QtEmDYoTZ4ZLJCdKwH+9cJnM4D7sBm9HClN9nWfypKTc6XDIZQeoLl7rvSpUH/HIEHISYDc1zVTWXP36gnJirUYWz2/87CUEadPZjn5g52bnmhrkg7AWpW6bkoeq6Jar8y5yIfeIx9onlIFxT1g6m4sePlLY47xzBsRWkfiK+kd3Xa34ZQgQKLc7Hyj0b+p7S4k7wnKUgOwo352LtPVu39gZAV9/3SAq03XOmcBHXikuyEmRH4QZVU2CNcs9GCLRdZXEV6IpLshGk7tCQrljr/yX/gHKy70w8QZCuAd7o5e3yDx6V20ZsvV7TC/nh6IJc44rnuiVqhv0hiI0S6USYwFy5qBSp3IcO76R6LsioglxyRfkP8FZ8fIplKRgbZRJflDi3hVBaN5XTkhv6jmKJVc4Yla2ANAJLrrgLNwQpodv8auWq/1cnAVKgrXjlxz6ilZE6Ghh9yL8jvvgZ+hFBrqiK731dD5krd93W4t3WH7e/Vun/JvpG/HzxFxycz+sV8RQvAAAAAElFTkSuQmCC"
        alt="Awajahi logo"
        width={20}
        height={20}
        style={{
          verticalAlign: 'middle',
          display: 'inline-block',
          margin: '0 4px',
        }}
      />
    )}
    </span>
    <span>Awajahi</span>
  </p>
</div>



    </div>


  )
}

export function FMemo({
  formData,
  payments = [],
  isPdfExport = false, // Add this optional prop
}: {
  formData: FMDataType;
  payments?: PaymentBook[];
  isPdfExport?: boolean;
}) {
  // State to hold base64 versions of logo and signature for PDF export
  const [base64Logo, setBase64Logo] = useState('');
  const [base64Signature, setBase64Signature] = useState('');

  // Convert logo URL to base64 when exporting to PDF and when formData.logo changes
  useEffect(() => {
    if (isPdfExport && formData.logo) {
      urlToBase64(formData.logo)
        .then(setBase64Logo)
        .catch(() => setBase64Logo(''));
    }
  }, [isPdfExport, formData.logo]);

  // Convert signature URL to base64 under the same conditions
  useEffect(() => {
    if (isPdfExport && formData.signature) {
      urlToBase64(formData.signature)
        .then(setBase64Signature)
        .catch(() => setBase64Signature(''));
    }
  }, [isPdfExport, formData.signature]);

  const netBalance =
    Number(formData.totalFreight) -
    Number(formData.advance) -
    Number(formData.commision) -
    Number(formData.hamali) -
    Number(formData.cashAC) -
    Number(formData.extra) -
    Number(formData.TDS) -
    Number(formData.tire) -
    Number(formData.spareParts);

  // Prefer supplier, else user, else blank
  const displayedVehicleOwner =
    (formData.supplierName && formData.supplierName.trim()) ||
    (formData.userName && formData.userName.trim()) ||
    '';

  return (
    <Card className="relative max-w-[800px] mx-auto font-sans text-sm shadow-md bg-white p-0">
      <div className="border border-black border-b-0 p-2">
        <div className="flex justify-between items-center mb-5">
          <h1 className="text-lg font-semibold uppercase text-center border-b-2 border-gray-500 pb-1">
            Challan / Freight Memo
          </h1>
          <div className="text-right text-xs">
            <p> {formData.contactNumber}</p>
            <p> {formData.altPhone || ''}</p>
          </div>
        </div>

        <div className="text-center mb-5">
          <div className="flex items-center justify-center">
            {formData.logo ? (
              isPdfExport ? (
                <img
                  src={base64Logo}
                  alt="Company Logo"
                  width={80}
                  height={80}
                  style={{ objectFit: 'contain', display: 'block' }}
                />
              ) : (
                <Image src={formData.logo} alt="Company Logo" width={80} height={80} />
              )
            ) : null}

            <div className="ml-4">
              <h2 className="text-3xl font-semibold text-gray-800">
                <CompanyHeader formData={formData} />
              </h2>
              <p className="text-lg font-normal uppercase text-gray-700">
                Fleet Owners and Transport Contractors
              </p>
            </div>
          </div>
          <p className="text-sm text-gray-600 mt-2">
            {formData.address}, {formData.city}, {formData.pincode}
          </p>
          <p className="text-sm text-gray-600 mt-2">
            {formData.email && `  ${formData.email}`}
          </p>
        </div>
      </div>

      <table className="w-full border-collapse">
        <tbody>
          <tr>
            <td className="border border-black p-2">
              Trailer No.: <strong>{formData.truckNo}</strong>
            </td>
            <td className="border border-black p-2">
              Challan No.: <strong>{formData.challanNo}</strong>
            </td>
            <td className="border border-black p-2">
              Date:{' '}
              <strong>
                {new Date(formData.date).toLocaleDateString('en-IN')}
              </strong>
            </td>
          </tr>
          <tr>
            <td className="border border-black p-2">
              Material:{' '}
              <strong>
                {formData.material.map(
                  (item, i) =>
                    item.name + (i === formData.material.length - 1 ? '' : ',')
                )}
              </strong>
            </td>
            <td className="border border-black p-2">
              From: <strong>{formData.from}</strong>
            </td>
            <td className="border border-black p-2">
              To: <strong>{formData.to}</strong>
            </td>
          </tr>
          <tr>
            <td className="border border-black p-2">
              Vehicle Owner: <strong>{displayedVehicleOwner}</strong>
            </td>

            <td className="border border-black p-2" colSpan={2}>
              PAN No.: <strong>{formData.pan}</strong>
            </td>
          </tr>

          <tr>
  <td className="border border-black p-2" colSpan={1}>
    <strong>Dasti to Driver:</strong>{" "}
    <span>{formData?.driverName || "NA"}</span>
  </td>
  <td className="border border-black p-2">Rate</td>
  <td className="border border-black p-2">
    <strong>{formData.rate} {formData.billingtype}</strong>
  </td>
</tr>

<tr>
  <td
    className="border border-black p-2 align-top"
    rowSpan={14}
  >
    <div className="text-sm font-semibold text-gray-900 mb-2 underline">
      Advance Payments Made
    </div>

    {Array.isArray(payments) && payments.length > 0 ? (
      <div className="whitespace-pre-wrap text-sm flex flex-col gap-3">
        {payments
          .sort(
            (a: any, b: any) =>
              new Date(a.date).getTime() -
              new Date(b.date).getTime()
          )
          .map((payment: any, index: number) => (
            <div
              key={payment._id || `adv-${index}`}
              className="flex items-center gap-3"
            >
              <span>{index + 1}.</span>
              <span>
                {new Date(payment.date).toLocaleDateString("en-IN")}
              </span>
              <span>{Number(payment.amount).toLocaleString("en-IN")}/-</span>
            </div>
          ))}
      </div>
    ) : (
      <div className="italic text-gray-500 text-sm">
        
      </div>
    )}
  </td>
</tr>


          <tr>
            <td className="border border-black p-2">Weight</td>
            <td className="border border-black p-2">
              <strong>{formData.weight}</strong>
            </td>
          </tr>
          <tr>
            <td className="border border-black p-2">Total Freight</td>
            <td className="border border-black p-2">
              <strong>{formatNumber(formData.totalFreight)}</strong>
            </td>
          </tr>
          <tr>
            <td className="border border-black p-2">Advance</td>
            <td className="border border-black p-2">
              <strong>{formatNumber(formData.advance)}</strong>
            </td>
          </tr>
          <tr>
            <td className="border border-black p-2">Balance</td>
            <td className="border border-black p-2">
              <strong>{formatNumber(netBalance)}</strong>
            </td>
          </tr>
          <tr>
            <td className="border border-black p-2">Commission</td>
            <td className="border border-black p-2">
              <strong>{formatNumber(formData.commision)}</strong>
            </td>
          </tr>
          <tr>
            <td className="border border-black p-2">Hamali</td>
            <td className="border border-black p-2">
              <strong>{formatNumber(formData.hamali)}</strong>
            </td>
          </tr>
          <tr>
            <td className="border border-black p-2">Extra Weight</td>
            <td className="border border-black p-2">
              <strong>{formData.extraWeight}</strong>
            </td>
          </tr>
          <tr>
            <td className="border border-black p-2">Cash DASTI A/C</td>
            <td className="border border-black p-2">
              <strong>{formatNumber(formData.cashAC)}</strong>
            </td>
          </tr>
          <tr>
            <td className="border border-black p-2">Extra</td>
            <td className="border border-black p-2">
              <strong>{formData.extra}</strong>
            </td>
          </tr>
          <tr>
            <td className="border border-black p-2">TDS</td>
            <td className="border border-black p-2">
              <strong>{formData.TDS}</strong>
            </td>
          </tr>
          <tr>
            <td className="border border-black p-2">Tyre</td>
            <td className="border border-black p-2">
              <strong>{formData.tire}</strong>
            </td>
          </tr>
          <tr>
            <td className="border border-black p-2">Spare Parts</td>
            <td className="border border-black p-2">
              <strong>{formData.spareParts}</strong>
            </td>
          </tr>
          <tr>
            <td className="border border-black p-2 font-bold">
              Net Balance
            </td>
            <td className="border border-black p-2 font-bold">
              <strong>{formatNumber(netBalance)}</strong>
            </td>
          </tr>
          <tr>
            <td className="border border-black p-2" colSpan={3}>
              <strong>
                LR Rec. Date:{' '}
                {new Date(formData.lrdate).toLocaleDateString('en-IN')}
              </strong>
              <p>
                <strong>Payment Date:</strong>
              </p>
            </td>
          </tr>
        </tbody>
      </table>

      <div className="border border-black border-t-0 p-2">
        <div className="mt-4 text-sm">
          <strong>Conditions:</strong>
          <div className="flex flex-col items-center gap-4 md:flex-row md:justify-between md:items-center md:gap-8 mt-2">
            <p className="flex-1 min-w-0 md:text-left text-center">
              Vehicle owner is responsible for the safe and timely delivery of
              the consignment and would be fined in case of late delivery and
              damages.
            </p>
            <span className="whitespace-nowrap md:ml-8 text-center md:text-right">
              For {formData.companyName}
            </span>
          </div>
          <div className="mt-6 flex flex-col items-center md:items-end">
            {formData.signature ? (
              isPdfExport ? (
                <img
                  src={base64Signature}
                  alt="signature"
                  width={100}
                  height={100}
                  style={{ objectFit: 'contain', display: 'block' }}
                />
              ) : (
                <Image
                  src={formData.signature}
                  alt="signature"
                  width={100}
                  height={100}
                />
              )
            ) : null}

            <p>Cashier/Accountant</p>
          </div>
        </div>

        <div className="text-center text-xs mt-4 py-4">
          <p className="flex items-center justify-center">
            Powered by
            <Image
              src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOQAAAD0CAYAAACLgYoWAAAACXBIWXMAACxLAAAsSwGlPZapAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAABPbSURBVHgB7Z1dchRHFoVvNRg5Yh4sr8DFCiytwGIFxitw82BiICZCYgVIK7AU4YCJmAeaFVizAqQVoFkBYgWjeTOY6XJmVrbULXVX5W/VzczzRRDIpoUA9amTefPcvERgVJq/U908p0MCQDAhMC6VEuN+c0DbBIoHghwR6Y5CkD+LD7fpMx0QKB4IckyqlaUqXBJAkGOx5I4LpEv+SqBoIMixqNYWcqZKqKBYIMgREKLbu+WON1T0hkCxQJBjUNHLjl/bU4IFRQJBDow4c5xK0XW+qEuwIGsgyOHpFxtcslggyAFR7kiGRRu4ZJFAkMNiLrLWJacEigKCHAgrd1wgXBJhgbKAIIfDfglaCQEjUlcUEOQAOLnjDYjUFQQEGRmdvPEp0CB4XhAQZHxkIqcmP+CShQBBRkS54ySIu8ElCwGCjEkbIA/lbC8RPM8fCDISa9qr/JkgLJA7EGQsqij35EwRqcsbCDICUdxxASJ1WQNBxqCKeIscgudZA0EGJqo7LoBLZgsEGZohOv7hktkCQQZEX82xR0OAqz6yBIIMyWRAkVRUN08RFsiNikAQdIB8aNe6ogf0sDoWP4MsgEOGY4xCCyJ1mQFBBsCzvcoXBM8zAoIMw5jHEHDJjIAgPRnZHRfsI3ieBxCkPxwO6bcRPM8DCNID4UpSBDXxYNr8QjsEkgaCdEQ3H0+JE/cxPSt1IEh3QlzNERZE6pIHgnRAu+MhcQTB86SBIF2omIpRApdMGgjSkkHaq3yBSyYLBGkLZ3dcgLkgyYJwuQV67/iBUqChS9qiXQTP0wIOaUMK7rgAc0GSBA5piDp0/4reU1qgPSsx4JCmpHnojuB5YsAhDRip+TgUcMmEgEOakfIxwjZ9wjFIKsAhe0jcHW+YC5f8p6i8AtbAIfvJw10qBM9TAILsgEnzcRgqeoxIHX8gyG7y2nshUsceCHIDWbnjAgTP2QNBrkHfT5Onm8AlWQNBrodf83EopEs+o8cEWAJB3oLl1RzhQcWVKRDkbdoAeU05g7kgbEEwYImk2qv8QaSOIXDIZVJqr/IHwXOGwCE1hbnjArgkM+CQC8pyxwVwSWbAIalYd1xwRXPaRfCcB3BISdnBa8wFYUTxDqmiZBN6R6Uzp0fCJc8IjAoccoJDcgUidSwoWpA6QI6JURIEz1lQukPCFZaBS45OsYLMsr3KF7jk6JTskHCDdWBPPSpFChLu2MkO5oKMR6kOCXfsQuwlmwNxPgkGpzhBiqe/FGNNYDOYCzIaRQUDdEROhgBqAn0geD4CpTlkvldzhAfB8xEoxiFZB8gbFey+kHenEi/gkgNTjkNybq9q6Ej8eEH8wFyQgSnCIbm7Y/WaHqoPn9Ox+GmfuIG5IINRhkNydsd79OT64wfqz8lveVhlMGwoEbIXpHLHShVzODKrfrtpedJ7tRPiBiJ1g5G/Q3J2x7nYO97mgVq2cnRJ7CUHIGtBsnfHNfsyuGTZ5O2QnPc+69xxQeuSl8QNuGR0shWkml9RsX2iz7qqltolj4gbrUtOCUQjX4fke3HVVac7aqpXNBNHImfEDbhkVLIUJPP2qhPjM72GpUvW4t/3kEAUcnVInk9xGZGbC+czRN0Cx9ElifbRnhWH7ATJ2h2F41knXji6JILn0cguOicEKSNyNXFjKSJn/anP6B3DAhWC5xHIyiG5uyO50izF6/gAl4xANg7JuvnYwx2vfwuewXPMBQlMTg7Jt/k4xD6QZ/Acc0ECk4UgtTtOiSfnwkFm5AnbSB3RFJG6cOThkG2AvCaOzAM+KBA8z57kBZligNwVBM/zJ32HTK29yhcEz7MmaUGW5I4LmAfP9wh4kbZDluaOGsbBc1z14UmygmTujkfRz+a4Bs/RnuVFug7J1R0tA+SusA2eT+hXBM/dSVKQaq/C1x1PBkuuIHieHUlG55iGrYNE5Ky/JILnWZGcQ6oAOderOcZwLATPsyI5h8yxvcr7Sz8Te1Z+S3i4pANJOWS27VW+bCk34hc8/4zx6LaktmTlmga5CBEgd4V58LwmYEwygmTtjhMGk6v4Bs8RFrAgJYfk6o4r8znGAsHzPEhCkOIbKsVYE0fmjM4C0Z6VPOwFybz5eMbp+grtkvwGv8IljUnBIflezWHpjjJS1vfGlA8gnzyoCp6jPStZWAtSu+Mh8cTKHZUQP9N78ffZ63mp/Du/EWeL7pnQOcOwAOaCGMHbIXkHyI3cUbmiENf1jXiN4R6vEmeLn+i9y1KPbfBcuCSC592wFSTr9qqK3pq447UrVisxst7PW/o66mpLJ7dk2p6FSF03fB2SsTuKfdph50tuu+Iy93ocslojvIVb/kI7ZAjmgqQJS0Gydsce59ngijd86XHIasObVbrLV2oJa14c+cKw4orgeSc8HZKzO26IyHW64hLexySiyCW+zgeTSFr1L7oQf+a3xA+45AbYCTJFd+x1xRsuqP9r9L9R273lByO3bJjeeA6XXAs/h+SafVzjjqauuMT/el9RWTiHgVtqR+YYPH+J4PldWAlSX82xRzxZ2Y9ZuOIyHyg0Jm7JNVKHuSB34OWQE7adAefVazqVHzi44jIfe1/ROLpGh1tiLkg6sBEk6/YqPZ/D0RVvaAz2kD50uSWC50nAySHZtlfR13Tl4Yo3fDGqsH5HvqxxS+WSPMMCCJ4vwUKQzN3x3MsVl/nbgKHvNW4plt2YC8IcLg7J9xvS7mtr8ufC6MKnKvD5XOuW767dkm/wfI/A+IJk7Y5h6T/yaPmWQiMr1xN63zylA8bBc1z1QSMLUqc1SlmumBZ0/PeQ69mm+/SrvliZX3pHzgV5irDAuA75B+1TGe5IbFxJumWjHoL8Kq730Z41miCZX80Rnnv9AhgsuVKpr8PxjV98pG48h2wD5DUVgtHNdBMErqnw4PkogmQ+2zEGZvvHOQRJhbvkOA7JefJxDOYGkTlJBUFq9ksNng8uyALdUQrtzPCVNQHJdqnB8+EdsjR3lNwzXLLCIZeZ2lxZkguDCrJIdyTDgo6kgUOucL+86VnDOmSJ7kh0bvHaWKGANCkwUjeYIHXzcXHuKDgj4E5hwfPhHLLURP/EQpBVeXumXgpzyUEEqQLkfK/miIrlqDoUddZR0MN8KIcstd/NeP+IC586KGguSHRBFtRedZemvYfHkJrAZgqZCzKEQ5bbDf7Fav+I5WoXhcwFiSrIwt3xUt0cbgoKOiZkHzyP7ZDlumNledyBUIAJ2QfPowmyeab+4WoqlYl1Vz5CAWZk7ZJRBKkjcvtUKnK5+pulQ1b0kIAJ2/Qp35VXLIeUiZyaSqVySufAIU2p6CDXY6LggtRXc5R9WdHc7kJiUfxCQceWKs/geXiHbAPkJZfwL6xnQKKgY09Fj3OM1AUVZKntVSvMHYba4MjDjQwjdWEdssz2qhs6Jiz3AEG6kGHwPJgg4Y7kWsyRQv6GgBuZuWQ4hyzdHSVzx+lSWLK6I13yGT2mTAgiSLijYmZdzKHrCityrH5kU3EN45AYlOLujqiw+pPRXBBvQeqrOfaobJzcUYHlahgymQvi75CT4t3xytkdWyDIMGQRPPcSZNHtVTecOLtjy/cEQpF88NzXIcseRS3PHV+5V5f1m6cmEIrkXdJZkHBHkjeS+40H/4Qx3hFIei6Ij0OW7Y5yqfqb552rKOjEIOm5IE6CLN4dxVKVHgQIQjT0A4EYTFON1Lk6ZOl7x0fVcYCR4HDIeCQaqbMWpHjyyL9oTaXS0AvPqmr72yChE5dEg+dWgtTNx1Mql6PqNR1TCBoUdKKToEvaOWR7T05NJdLQqc8Rxx2QbopPgi5pLEgdIC/1ao4L2vI84rgLCjpDMEkreG7ukOW2V12IimqYIo5GP7WxfxyGnZTmghgJsuD2quBiVKC6OiwJzQUxc8gS3VEOyokhxpYfCQxHQnNBqr4X6MrqByqLE1HAifINVE/qz/RfAkNzJR6wDyM9YIPR75BlueOVOmd8FfFpivzqWCQRPO8UpG4+LmPvKONwf4olaqhzxs1kc/9LgrBvz+p2yHJGSZ+IY41dq/FxrlQ47hgR9nNBNu4hdYA879sApCveoyfeXRumX06uOCb0jsC4zMVeMkD8MQb3O34tZ3eUG/sTsTw9pCGpio4d8qG9lO0RMWTtkjXj9iopxCNVbXs1QrHKdbna8HyaJwvjSN0mh8zNHZUjCiEej1X21m+AmmyRYmzE07yi94R0Tzja+sgZMeOOQ2bmjiuOOOoZlOtytaEjtd9pvG62A7dh6pJ3ijpCkDIEUFPanItHzeFQxRoTxL+rDAPYOty5eJDsXf8ez0RBCF0i4WjoTNQRWO0lVxwycXc8l4f6wg2/lW9iZmKckstyc37LVRvVccI6aZIUrUtOiRHXDqkjcrIkX1MayDfmf1TmdItmnCNRjs42Ew+WJ2t+r4NcpwePgrzK8zU9JCYsC/KlXOYRZyolwDPx5zwV5agL7rlEiWMWWN6GvrvprAxL1+AcjVJ1X4OqsjK9mkOK7ZxkC9REiDARAd7BLQvcfRu6XLqi6hoSGak75vD+ao892jdNTeNwJb7+R+EIMrZ2QffEG/GLEB/TJIU1tmeP7RLqsPO3FP82wiWPsHQNxiJ4fkgjUw3UXvVR/LhUZ2qVEtql+JpXWQlvDU7xwzk9MR2LjqVrUFi0Z923XFJ9XPr4ktp2JelwVysfT5TLXdLXdJXkMjMctgGLf5uKUbFFP4knu3yYYunqDwuXrJp/6CfsXBUS7ognZweLiRqzXdHvVp/kEHp2+jpgE53FtCHovTEAuOGwnHSu9Imlsezh3CcQgrXHTUMRZqQ5WMF6qnQ7K8S9MbqdM3JJIASjzgWBIGMwsbwqQuZVPfba6nP/FPtJEIYRG/MhyMDop6vNrXIzq0LOBtRtBzI6CPwZMXgOQYbG9uk6D9fFoe4Davi1FCXJSC4JQQZEVzz3LD7lKHhFb0stXS8J+DGSS0KQIbFJzshEToT8pNpPzserEmZFNfydUhBkIKxb15p4fXjCdc+wnwxARfXQ7Vk4hwyAvo1chr1rw08ZpLtALKF/F99h3APrx6CROjhkCP6wmJsZaam6lnaE3iUBHwa98RwO6Yl1OH/gO0GbX2iHvlKN58i7ujOYS8IhfZlY5UiPhs5JqvPJOfaTngzmknBID6yu0xj5qgjkXb0ZxCXhkI7oIbbmh8fNuLebqYleCA34IF0yekM4BOlKe0Zlui87YtHGhtCAL1P1II4IBOmAXqrumb2YTrlcoKRDA9KpLwm4ETksAEFaopeqxvtGbgf0yqnbzhDc7+pC5EgdBGmBCgDYjJO7p+7HuSRmoPLqScTgOQRpQzvsszZ89RGn29Nvo1u+MC/EhYguCUEaoveNpmdR51z2jV3oPyNE6UIkl4QgDbA64pD7xnk6g1mVKBt6S8COSHNBEAzowXrmCeNx2V2IFcBMvBt+JmCOfPhu0W7IsAAcso82GlcbvVZUVJO9NnNLLccvCJhTifdF4EgdBNmBcA15vLFj+PIjdYVGoqin/AN1RglR2rGvqu+BgCA3oKaBmRZxGB3++wBROhE0eA5BrkFVVM1H813ovsMsgCidCOaSEOQt9EVV5kmcOf2U2/wSiNKaYC6JKusSVs28bSzuUdbTu+RT/5PYF6P6akaACjscUmPZWX+Vuxgl0ilFoWoqPjwh0M/EPywAh6Trs0bTicTy2v5HKg9aEM1ztace7Yr9ZJirB/UZOVK8Qy4d/EOMHSBmZ4hnpK5oh9TLVNOD/2LFuIwuetk0Z5eHh0sW65BLe8ba4OUQo0bsKU/lUFNCk/NmPFyySEGq1hmbairEuIIqZs1xLLIRj/as4gQpllw/G+8ZF0cbEOMdpCjFvlI6JfaV63C86qMoQeqexpnZi/M/ZwyBLvbghvTbyLkgT+3DAsUUdVQ21TwOd04P6HFuCZyYWLeplYH1Xa5FOKQ4Q3tjIcYT8dTfgxjt0EtYeRE0lrA3WEfqsnZIPZVKPrVNWqhk+ibpFiouwC1XsHLJbB1SvSnaEXH9YlxUUiHGIMAtV7ByySwdUpWc205/k0rqqWyfwhI1DnBLhbygetekQJidQ+rijcmxxpW6cuN1fu1TnFhyy5IrsdumwfNsHFLvF2Uf49Tg5ReqjxFHGoOi3VIu38qcwvWncMmeM+0sBGm5LDrK4bqNlNHXah4W12fZ0JlYkXVOQUtekCp5U6liTN8S9Vw8oQ6QuuFDkcLsCZ4nLUh1K1z/RVQ4zmBOUcLscckkBamXqLKK2nekMRNnQC9QtEmDYoTZ4ZLJCdKwH+9cJnM4D7sBm9HClN9nWfypKTc6XDIZQeoLl7rvSpUH/HIEHISYDc1zVTWXP36gnJirUYWz2/87CUEadPZjn5g52bnmhrkg7AWpW6bkoeq6Jar8y5yIfeIx9onlIFxT1g6m4sePlLY47xzBsRWkfiK+kd3Xa34ZQgQKLc7Hyj0b+p7S4k7wnKUgOwo352LtPVu39gZAV9/3SAq03XOmcBHXikuyEmRH4QZVU2CNcs9GCLRdZXEV6IpLshGk7tCQrljr/yX/gHKy70w8QZCuAd7o5e3yDx6V20ZsvV7TC/nh6IJc44rnuiVqhv0hiI0S6USYwFy5qBSp3IcO76R6LsioglxyRfkP8FZ8fIplKRgbZRJflDi3hVBaN5XTkhv6jmKJVc4Yla2ANAJLrrgLNwQpodv8auWq/1cnAVKgrXjlxz6ilZE6Ghh9yL8jvvgZ+hFBrqiK731dD5krd93W4t3WH7e/Vun/JvpG/HzxFxycz+sV8RQvAAAAAElFTkSuQmCC"
              alt="Awajahi logo"
              width={20}
              height={20}
              className="mx-1"
            />
            Awajahi
          </p>
        </div>
      </div>
    </Card>
  );
}
</file>

<file path="src/utils/interface.ts">
// interfaces/Driver.ts

import { Document } from 'mongoose';


export interface InvoiceFormData {
  color? : string;
  rate: string;
  billingtype: string;
  logoUrl: string;
  billNo: string;
  partygst :  string
  partyAddress : string;
  date: string;
  to: string;
  from: string;
  branch: string;
  address: string;
  particulars: string;
  party: string;
  companyName: string;
  phone: string
  altPhone? : string;
  email: string;
  signatureUrl : string;
  stampUrl : string
  dueDate : string
  gstType?: "IGST" | "SGST + CGST" | "";
  gst? : number | undefined,
  freightCharges: {
    lrNo: string;
    truckNo: string;
    material: string[];
    date : string
    weight: string;
    charged: string;
    rate: string;
    amount: number;
  }[] | [];
  additionalCharges: {
    id : string
    date : string
    truckNo: string;
    expenseType: string;
    notes: string;
    amount: number;
    edited : boolean
  }[] | [];
  extraAdditionalCharges: {
    id : string
    date : string
    partyBill : boolean
    truckNo: string;
    expenseType: string;
    notes: string;
    amount: number;
    trip_id : string;
  }[] | [];
  partyDetails: {
    msmeNo: string;
    gstin: string;
    pan: string;
    accNo: string;
    ifscCode: string;
    bankName: string;
    bankBranch: string;
  };
  paymentDetails: {
    id: string
    date: string;
    paymentType: string;
    notes: string;
    amount: number;
    edited: boolean
  }[] | [];
  extraPaymentDetails: {
    id: string
    date: string;
    party_id : string;
    paymentType: string;
    accountType : string;
    notes: string;
    amount: number;
    driver_id? : string;

  }[] | [];
}

// Define the interface for the driver account schema
export interface IDriverAccount {
  account_id: string
  date: Date;
  reason: string;
  gave: number;
  got: number;
}

export interface invData extends Document{
  user_id : string
  invoiceNo : number
  advance : number
  party_id : string
  date : Date
  dueDate : Date
  route : {
    origin : string,
    destination : string
  },
  balance : number
  invoiceStatus : string
  total : number
  trips : [string]
}


// Define the interface for the driver schema
export interface IDriver extends Document {
  driver_id: string;
  name: string;
  contactNumber: string;
  licenseNo : string;
  aadharNo : string;
  lastJoiningDate : Date
  status: 'Available' | 'On Trip';
  balance?: number;
  accounts: IDriverAccount[];
}
// interfaces/Trip.ts

export interface PaymentBook extends Document{
  _id: string;
  paymentBook_id: string
  accountType: string
  amount: number;
  paymentType: 'Cash' | 'Cheque' | 'Online Transfer';
  receivedByDriver: boolean;
  date: Date;
  notes?: string;
  driver_id? : string
}

interface Route {
  origin: string;
  destination: string;
}

export interface TripExpense extends Document{
  trip_id: string;
  partyBill: boolean;
  amount: number;
  date: Date;
  expenseType: string;
  notes?: string;
}

export interface ITrip extends Document {
  trip_id: string;
  advance?: number;
  party: string;
  truck: string;
  driver: string;
  supplier : string
  route: Route;
  billingType: 'Fixed' | 'Per Tonne' | 'Per Kg' | 'Per Trip' | 'Per Day' | 'Per Hour' | 'Per Litre' | 'Per Bag';
  amount: number;
  startDate: Date;
  truckHireCost: number;
  LR: string;
  fmNo? : string
  status?: 0 | 1 | 2 | 3 | 4;
  POD?: string;
  dates: Date[];
  notes?: string;
  accounts : PaymentBook[]
  tripAccounts?: PaymentBook[]; // Add this line
  advanceTotal?: number; // optional for new field
  ewayBill : string
  ewbValidityDate : Date
  documents : [{
    filename : string,
    type : string,
    validityDate : Date,
    uploadedDate : Date,
    url : string
  }]
  partyName : string;
  invoice : boolean
  balance : number
  units? : number;
  rate?: number;
  invoice_id? : string
  material? : { name: string; weight: string }[]
  guaranteedWeight? : string;
}

export interface Idoc{
  filename : string,
  type : string,
  validityDate : Date,
  uploadedDate : Date,
  url : string

}


// interfaces/Party.ts


export interface IParty extends Document {
  user_id : string
  party_id: string;
  name: string;
  contactPerson: string;
  contactNumber: string;
  address: string;
  gstNumber: string;
  balance: number;
  createdAt: Date;
  updatedAt: Date;
  email : string;
  pan : string;
  partyBalance : number
}


// interfaces/Truck.ts

export interface TruckModel extends Document {
  truckNo: string;
  truck_id : string
  truckType: string;
  model: any;
  capacity: string;
  bodyLength: string | null;
  ownership: string;
  supplier: string;
  status: 'Available' | 'On Trip'
  trip_id : string
  documents : []
  createdAt: Date;
  updatedAt: Date;
  driver_id : string
}

export interface ISupplier extends Document{
  supplier_id: string;
  name: string;
  contactNumber: string
  balance : number
}

export interface IExpense extends Document{
  user_id: string;
  trip_id: string;
  truck: string;
  expenseType: string;
  paymentMode: string;
  transaction_id?: string; // Optional
  driver?: string;         // Optional
  amount: number;
  date: Date;
  notes?: string;          // Optional
}

export interface ITripCharges extends Document{
  user_id: string;
  trip_id: string;
  partyBill: boolean;
  amount: number;
  date: Date;
  expenseType: string;
  notes?: string; // Optional field
}

export interface ISupplierAccount extends Document{
  user_id : string
  supplier_id: string;
  trip_id : string
  amount: number;
  paymentMode : string
  date : string
  notes : string
  refNo : string
}

export type ConsignerConsigneeType = {
  gstNumber: string;
  name: string;
  address: string;
  city: string;
  pincode: string;
  contactNumber: string;
};

export type EWBFormDataType = {
  gstNumber: string
  pan: string
  companyName: string
  address: string
  city: string
  pincode: string
  from : string,
  to : string;
  contactNumber: string
  altPhone? : string
  email: string
  date: Date
  LR: string
  consigner: ConsignerConsigneeType
  consignee: ConsignerConsigneeType
  materials: {name : string, weight : string}[]
  weight: string
  unit: string
  paidBy: 'consigner' | 'consignee' | 'agent'
  ewayBillNo: string
  invoiceNo: string
  truckNo: string
  logo: string
  signature: string
  value : string | number
  grtdWeight : string | number
}

export interface FMDataType {
  gstNumber: string;
  rate: string;
  pan: string;
  companyName: string;
  ownerName?: string;
  supplierName?: string;
  userName?: string; 
  address: string;
  city: string;
  pincode: string;
  altPhone? : string;
  contactNumber: string;
  email: string;
  date: Date;
  challanNo: string
  from: string;
  to: string;
  totalFreight: string;
  commision: string;
  weight: string;
  material: {name : string, weight : string}[];
  unit: string;
  noOfBags: string;
  vehicleOwner: string;
  advance: string;
  hamali: string;
  extraWeight: string;
  billingtype: string;
  cashAC: string;
  extra: string;
  TDS: string;
  tire: string;
  spareParts: string;
  truckNo: string;
  lrdate: string
  logo: string;
  signature : string;
  driverName?: string;
}
</file>

<file path="src/components/trip/FrieghtMemo.tsx">
"use client"

import type React from "react"
import { useEffect, useState } from "react"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Loader2, X } from "lucide-react"
import { motion, AnimatePresence } from "framer-motion"
import type { FMDataType, ITrip } from "@/utils/interface"
import { useToast } from "../hooks/use-toast"
import { FMemo } from "@/utils/DocGeneration"
import "jspdf/dist/polyfills.es.js"
import { jsPDF } from "jspdf"
import html2canvas from "html2canvas"
import { savePDFToBackend } from "@/utils/saveTripDocs"
import { useTrip } from "@/context/tripContext"
import { fetchDriverName } from '@/helpers/driverOperations';

type Props = {
  isOpen: boolean
  onClose: () => void
}

const placeholders: { [key: string]: string } = {
  gstNumber: "Enter GST Number",
  pan: "Enter PAN Number",
  companyName: "Enter Company Name",
  address: "Enter Full Address",
  city: "Enter City Name",
  pincode: "Enter Pincode/ZIP Code",
  contactNumber: "Enter Contact Number",
  email: "Enter Email Address",
  date: "Select Date",
  from: "Enter Starting Location",
  to: "Enter Destination Location",
  truckHireCost: "Enter Truck Hire Cost",
  totalFreight : "Enter Total Freight",
  weight: "Enter Total Weight of Goods",
  material: "Enter Material Name",
  unit: "Enter Unit (e.g., Kg, Tons)",
  noOfBags: "Enter Number of Bags",
  amount: "Enter Total Amount",
  advance: "Enter Advance Amount Paid",
  balance: "Enter Remaining Balance",
  commision: "Enter Commission Amount",
  hamali: "Enter Hamali Charges",
  extraWeight: "Enter Extra Weight (if any)",
  cashAC: "Enter Dasti Account Charges",
  extra: "Enter Extra Charges",
  TDS: "Enter TDS Amount",
  tyre: "Enter Tire Charges (if applicable)",
  spareParts: "Enter Spare Parts Cost (if applicable)",
  truckNo: "Enter Truck Number",
  logo: "Upload Company Logo",
  challanNo: "Enter Challan Number",
  lrdate: "Enter LR Rec. Date (if applicable)",
}

const steps = [
  {
    title: "Company Details",
    fields: ["gstNumber", "pan", "companyName", "address", "city", "pincode", "contactNumber", "email"],
  },
  {
    title: "Frieght Memo Details",
    fields: ["date", "challanNo", "lrdate"],
  },
  {
    title: "Trip Details",
    fields: [
      "from",
      "to",
      "truckNo",
      "totalFreight",
      "material",
      "weight",
      "unit",
      "noOfBags",
      "advance",
      "hamali",
      "commision",
    ],
  },
  {
    title: "Extra Details",
    fields: ["extraWeight", "cashAC", "extra", "TDS", "tyre", "spareParts"],
  },
]

export default function FrieghtMemo({ isOpen, onClose }: Props) {
  const [currentStep, setCurrentStep] = useState(0)
  const [showBill, setShowBill] = useState(false)
  const [pdfDownloading, setPDFDownloading] = useState(false)
  const [user, setUser] = useState<any>()
  const [payments, setPayments] = useState<any[]>([])
  const { trip, setTrip } = useTrip()
  const [formData, setFormData] = useState<FMDataType>({
    gstNumber: "",
    pan: "",
    companyName: "",
    userName: "",
    address: "",
    city: "",
    pincode: "",
    contactNumber: "",
    email: "",
    date: new Date(trip?.startDate),
    from: trip?.route?.origin || "",
    to: trip?.route?.destination || "",
    totalFreight: trip?.truckHireCost || (trip?.amount ?? ""),
    weight: trip?.weight || "",
    material: trip?.material || [],
    vehicleOwner:
      trip?.supplierName ||
      (trip?.supplier && (trip.supplier.name || "")) ||
      "",
    unit: "",
    billingtype: trip?.billingType || "",
    rate: trip?.rate || "",
    commision: "",
    noOfBags: "",
    advance: "",
    hamali: "",
    extraWeight: "",
    cashAC: "",
    extra: "",
    TDS: "",
    tire: "",
    lrdate: new Date(trip?.dates?.[2] || Date.now()).toISOString().split("T")[0],
    spareParts: "",
    truckNo: trip?.truck || "",
    driverName: trip?.driverName || "",
    challanNo: trip?.fmNo || "",
    logo: "",
    signature: "",
    altPhone: ""
  })

  const { toast } = useToast()

  // --- fetch user only (no payments) ---
  const fetchUser = async () => {
    try {
      const res = await fetch("/api/users")
      if (!res.ok) {
        console.warn("fetchUser: /api/users returned", res.status)
        toast({ description: "Failed to fetch user details", variant: "destructive" })
        return
      }
      const data = await res.json()
      const user = data.user
      setUser(user)
      setFormData((prev) => ({
        ...prev,
        companyName: user.company,
        address: user.address,
        contactNumber: user.phone,
        gstNumber: user.gstNumber,
        logo: user.logoUrl,
        pincode: user.pincode,
        email: user.email,
        city: user.city,
        pan: user.panNumber,
        signature: user.signatureUrl,
        altPhone: user.altPhone || "",
        userName: user.name || user.company,
        vehicleOwner: prev.vehicleOwner || user.name || user.company,
      }))
    } catch (error) {
      console.error("fetchUser error:", error)
      toast({ description: "An unexpected error occurred", variant: "destructive" })
    }
  }

  // --- fetch payments from backend API (only if trip.supplier + trip_id are available) ---
  const fetchPaymentsFromApi = async () => {
    if (!trip?.supplier || !trip?.trip_id) {
      console.log("Skipping payments API fetch  missing trip.supplier or trip.trip_id", { supplier: trip?.supplier, trip_id: trip?.trip_id })
      return
    }
    try {
      console.log("Fetching payments from API for supplier:", trip.supplier, "trip:", trip.trip_id)
      const res = await fetch(`/api/suppliers/${trip.supplier}/payments/trips/${trip.trip_id}`)
      if (!res.ok) {
        console.warn("Payments API returned non-OK:", res.status)
        return
      }
      const paymentsData = await res.json()
      console.log("Payments API response body:", paymentsData)

      const accountsArray = paymentsData?.supplierAccounts ?? paymentsData?.accounts ?? paymentsData?.payments ?? []
      if (!Array.isArray(accountsArray) || accountsArray.length === 0) {
        console.log("Payments API returned no accounts/empty array")
        return
      }

      const normalized = accountsArray.map((p: any, i: number) => ({
        _id: p._id || p.id || `api-${i}`,
        amount: Number(p.amount ?? p.value ?? 0),
        date: p.date || p.createdAt || new Date().toISOString(),
      })).sort((a: any, b: any) => new Date(a.date).getTime() - new Date(b.date).getTime())

      setPayments(normalized)
      const total = normalized.reduce((s: number, it: any) => s + (Number(it.amount) || 0), 0)
      setFormData(prev => ({ ...prev, advance: String(total) }))
      console.log("Payments state set from API, total advances:", total)
    } catch (err) {
      console.warn("fetchPaymentsFromApi error:", err)
    }
  }

  // When modal opens or trip changes, load user + try payments API
  useEffect(() => {
    if (!isOpen) return;
    fetchUser();
    fetchPaymentsFromApi();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isOpen, trip?.supplier, trip?.trip_id]);

  //  If API payments are not available, mirror from trip.advances first, then trip.accounts
  useEffect(() => {
    if (payments && payments.length > 0) {
      console.log("Skipping fallback, API payments already loaded:", payments);
      return;
    }

    const source =
      Array.isArray(trip?.advances) && trip.advances.length
        ? trip.advances
        : Array.isArray(trip?.accounts) && trip.accounts.length
        ? trip.accounts
        : null;

    if (!source) {
      console.log("No trip.advances or trip.accounts to mirror");
      return;
    }

    console.log("Mirroring advances into payments state:", source);

    const adv = source
      .filter((a: any) => a && (a.amount ?? a.value ?? a.amt) != null)
      .map((a: any, i: number) => ({
        _id: a._id || a.id || `adv-${i}`,
        amount: Number(a.amount ?? a.value ?? a.amt ?? 0),
        date: a.date || a.createdAt || new Date().toISOString(),
      }))
      .sort(
        (a: any, b: any) =>
          new Date(a.date).getTime() - new Date(b.date).getTime()
      );

    if (adv.length === 0) {
      console.log("Advances list empty after normalization");
      return;
    }

    setPayments(adv);
    const total = adv.reduce(
      (sum: number, item: any) => sum + (Number(item.amount) || 0),
      0
    );
    setFormData((prev) => ({ ...prev, advance: String(total) }));
    console.log("Payments set from advances, total:", total);
  }, [trip?.accounts, trip?.advances, payments.length]);

  // keep driverName in sync when trip updates
  useEffect(() => {
    if (!trip) return;
    setFormData((prev) => ({
      ...prev,
      driverName: trip.driverName || prev.driverName || "",
    }));
  }, [trip?.driverName, trip?.driver]);

  // optional: fetch driver name from API if only driver id is available
  useEffect(() => {
    if (!trip?.driver || trip?.driverName) return;
    let mounted = true;
    (async () => {
      try {
        const res = await fetch(`/api/drivers/${trip.driver}`);
        if (!res.ok) return;
        const data = await res.json();
        if (mounted) {
          setFormData((prev) => ({
            ...prev,
            driverName:
              data?.driver?.name ||
              data?.name ||
              prev.driverName ||
              "",
          }));
        }
      } catch (err) {
        console.warn("Could not fetch driver name", err);
      }
    })();
    return () => {
      mounted = false;
    };
  }, [trip?.driver, trip?.driverName]);

  // debug output
  useEffect(() => {
    console.log("Payments state updated (FreightMemo):", payments);
  }, [payments]);

  const addMaterial = () => {
    setFormData((prev) => ({
      ...prev,
      material: [...prev.material, { name: "", weight: "", unit: "" }],
    }))
  }

  const handleMaterialChange = (index: number, field: string, value: string) => {
    setFormData((prev) => {
      const updatedMaterials = [...prev.material]
      updatedMaterials[index] = { ...updatedMaterials[index], [field]: value }
      return { ...prev, material: updatedMaterials }
    })
  }

  const downloadAllPDFs = async () => {
    const element = document.getElementById("pdf-fmemo");
    if (!element) {
      console.error('Element with id "fmemo" not found')
      return
    }

    setPDFDownloading(true)
    try {
      const canvas = await html2canvas(element, {
        scale: 2,
        logging: true,
        useCORS: true,
      })

      const imgData = canvas.toDataURL("image/jpeg")
      const padding = 10
      const imgWidth = canvas.width / 2
      const imgHeight = canvas.height / 2
      const pdfWidth = (imgWidth * 25.4) / 96 + padding * 2
      const pdfHeight = (imgHeight * 25.4) / 96 + padding * 2

      const pdf = new jsPDF({
        orientation: pdfWidth > pdfHeight ? "landscape" : "portrait",
        unit: "mm",
        format: [pdfWidth, pdfHeight],
      })

      const imgX = padding
      const imgY = padding

      pdf.addImage(imgData, "JPEG", imgX, imgY, pdfWidth - padding * 2, pdfHeight - padding * 2)
      pdf.save(`Challan-${trip?.LR || ""}-${formData.truckNo}.pdf`)

      const filename = `FM-${trip?.LR || ""}-${trip?.truck || ""}.pdf`
      const docData = await savePDFToBackend(pdf, filename, "FM/Challan", trip, formData.date)
      setTrip((prev: ITrip | any) => ({
        ...prev,
        documents: docData.documents,
      }))
    } catch (error) {
      console.error("Error generating PDF:", error)
      alert("Failed to generate PDF")
    } finally {
      setPDFDownloading(false)
    }

    // sync user details back if missing in DB
    if (
      (!user?.company && formData.companyName) ||
      (!user?.address && formData.address) ||
      (!user?.gstNumber && formData.gstNumber) ||
      (!user?.panNumber && formData.pan) ||
      (!user?.pincode && formData.pincode) ||
      (!user?.city && formData.city) ||
      (!user?.email && formData.email)
    ) {
      const data = new FormData()
      data.append(
        "data",
        JSON.stringify({
          companyName: user?.company || formData.companyName,
          address: user?.address || formData.address,
          gstNumber: user?.gstNumber || formData.gstNumber,
          pincode: user?.pincode || formData.pincode,
          email: user?.email || formData.email,
          city: user?.city || formData.city,
          panNumber: user?.panNumber || formData.pan,
        }),
      )
      try {
        const res = await fetch("/api/users", {
          method: "PUT",
          body: data,
        })
        if (!res.ok) {
          alert("Failed to update user details")
        }
      } catch (error) {
        alert("Failed to update user details")
      }
    }
  }

  if (!isOpen) return null

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target
    setFormData((prev: any) => {
      if (name.includes(".")) {
        const [parent, child] = name.split(".")
        return { ...prev, [parent]: { ...prev[parent], [child]: value } }
      }
      return { ...prev, [name]: value }
    })
  }

  const handleNext = () => setCurrentStep((prev) => Math.min(prev + 1, steps.length - 1))
  const handleBack = () => setCurrentStep((prev) => Math.max(prev - 1, 0))

  const progressPercentage = ((currentStep + 1) / steps.length) * 100

  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      exit={{ opacity: 0 }}
      className="fixed inset-0 bg-black bg-opacity-70 z-40 flex items-center justify-center"
    >
      <motion.div
        initial={{ scale: 0.9, y: 20 }}
        animate={{ scale: 1, y: 0 }}
        exit={{ scale: 0.9, y: 20 }}
        transition={{ type: "spring", damping: 15 }}
        className="bg-white p-6 rounded-lg shadow-lg max-w-5xl w-full max-h-[700px] overflow-y-auto thin-scrollbar"
      >
        <div className="flex justify-between items-center mb-4">
          <h1 className="font-semibold text-xl text-black">Frieght Memo</h1>
          <Button variant="ghost" size="icon" onClick={onClose}>
            <X />
          </Button>
        </div>

        {!showBill ? (
          <>
            <div className="w-full bg-gray-200 rounded-full h-2.5 mb-4">
              <motion.div
                className="bg-lightOrange h-2.5 rounded-full"
                initial={{ width: 0 }}
                animate={{ width: `${progressPercentage}%` }}
                transition={{ duration: 0.3 }}
              />
            </div>

            <form onSubmit={(e) => e.preventDefault()} className="grid grid-cols-2 gap-4">
              <AnimatePresence mode="wait">
                <motion.div
                  key={currentStep}
                  initial={{ x: 300, opacity: 0 }}
                  animate={{ x: 0, opacity: 1 }}
                  exit={{ x: -300, opacity: 0 }}
                  transition={{ type: "spring", stiffness: 300, damping: 30 }}
                  className="col-span-2"
                >
                  <h2 className="text-lg font-semibold text-black mt-2 mb-4">{steps[currentStep].title}</h2>

                  <div className="grid grid-cols-2 gap-4">
                    {steps[currentStep].fields.map((field: string) => {
                      if (field === "date") {
                        return (
                          <div className="mb-4" key={field}>
                            <Label htmlFor="date">Date</Label>
                            <input
                              id="date"
                              name="date"
                              type="date"
                              value={new Date(formData.date).toISOString().split("T")[0]}
                              onClick={(e) => (e.target as HTMLInputElement).showPicker()}
                              onChange={handleInputChange}
                              className="mt-1 w-full p-2 border rounded"
                            />
                          </div>
                        )
                      }

                      if (field === "material") {
                        return (
                          <div className="col-span-2" key={field}>
                            <label className="text-xs text-gray-500">Materials</label>
                            {formData.material.map((mat, index) => (
                              <div key={index} className="flex gap-2 mt-2">
                                <Input
                                  placeholder="Material Name"
                                  value={mat.name}
                                  onChange={(e) => handleMaterialChange(index, "name", e.target.value)}
                                />
                                <Input
                                  placeholder="Weight"
                                  value={mat.weight}
                                  onChange={(e) => handleMaterialChange(index, "weight", e.target.value)}
                                />
                              </div>
                            ))}
                            <Button type="button" onClick={addMaterial} className="mt-2">
                              Add Material
                            </Button>
                          </div>
                        )
                      }

                      return (
                        <div key={field} className="mb-1">
                          <label htmlFor={field} className="text-xs text-gray-500">
                            {placeholders[field]}
                          </label>
                          <Input
                            id={field}
                            name={field}
                            value={(formData[field as keyof FMDataType] as string) || ""}
                            onChange={handleInputChange}
                            className="mt-1"
                          />
                        </div>
                      )
                    })}
                  </div>

                  <div className="flex justify-between mt-6 col-span-2">
                    {currentStep > 0 && (
                      <Button variant="outline" onClick={handleBack}>
                        Back
                      </Button>
                    )}
                    {currentStep < steps.length - 1 ? (
                      <Button onClick={handleNext}>Next</Button>
                    ) : (
                      <Button onClick={() => setShowBill(true)}>Generate</Button>
                    )}
                  </div>
                </motion.div>
              </AnimatePresence>
            </form>
          </>
        ) : (
          <div className="w-full">
            <div className="sticky bottom-0 left-0 right-0 bg-white p-4 border-b border-gray-200">
              <div className="flex justify-between max-w-5xl mx-auto">
                <Button variant="outline" onClick={() => setShowBill(false)}>
                  Edit Form
                </Button>
                <Button disabled={pdfDownloading} onClick={() => downloadAllPDFs()}>
                  {pdfDownloading ? <Loader2 className="text-white animate-spin" /> : "Download as PDF"}
                </Button>
              </div>
            </div>

            <div className="p-2">
              <FMemo formData={formData} payments={payments} />
            </div>

            <div style={{ position: 'fixed', top: '-10000px', left: '-10000px', height: 0, overflow: 'hidden' }}>
              <div id="pdf-fmemo">
                <FMemo formData={formData} payments={payments} isPdfExport={true} />
              </div>
            </div>

          </div>
        )}
      </motion.div>
    </motion.div>
  )
}
</file>

<file path="src/app/user/trips/page.tsx">
"use client"

import type React from "react"
import { useState, useCallback, useMemo, useEffect } from "react"
import { useRouter } from "next/navigation"
import debounce from "lodash.debounce"
import { FaTruck, FaCalendarAlt, FaSort, FaSortDown, FaSortUp } from "react-icons/fa"
import { SlOptionsVertical } from "react-icons/sl"
import { MdDelete, MdEdit } from "react-icons/md"
import { IoDuplicateOutline } from "react-icons/io5"
import { IoMdUndo } from "react-icons/io"
import { Loader2 } from "lucide-react"
import type { ITrip } from "@/utils/interface"
import { statuses } from "@/utils/schema"
import { formatNumber } from "@/utils/utilArray"
import Loading from "./loading"
import { Select, SelectTrigger, SelectValue, SelectContent, SelectItem } from "@/components/ui/select"
import { Button } from "@/components/ui/button"
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from "@/components/ui/dropdown-menu"
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table"
import dynamic from "next/dynamic"
import { useToast } from "@/components/hooks/use-toast"
import { ewbColor } from "@/utils/EwayBillColor"
import { useGetTripsQuery, useDeleteTripMutation, useUpdateTripStatusMutation, useEditTripMutation } from "@/store/api"
import { useExpenseData } from "@/components/hooks/useExpenseData"
import Link from "next/link"
import * as XLSX from "xlsx"
import { saveAs } from "file-saver"
import ExcelJS from "exceljs";

interface TripWithAdvanceTotal extends ITrip {
  advanceTotal: number;
}



function hasKey<O>(obj: O, key: PropertyKey): key is keyof O {
  return Object.prototype.hasOwnProperty.call(obj, key);
}

const EditTripForm = dynamic(() => import("@/components/trip/EditTripForm"), {
  ssr: false,
  loading: () => (
    <div className="modal-class">
      <div className="flex items-center justify-center">
        <Loader2 className="animate-spin text-bottomNavBarColor" />
      </div>
    </div>
  ),
})

const InvoiceForm = dynamic(() => import("@/components/trip/tripDetail/TripFunctions/InvoiceForm"), {
  ssr: false,
  loading: () => (
    <div className="modal-class">
      <div className="flex items-center justify-center">
        <Loader2 className="animate-spin text-bottomNavBarColor" />
      </div>
    </div>
  ),
})

const columnOptions = [
  { label: "Start Date", value: "startDate" },
  { label: "LR/FM Number", value: "LR" },
  { label: "Truck Number", value: "truck" },
  { label: "Party Name", value: "party" },
  { label: "Route", value: "route" },
  { label: "Status", value: "status" },
  { label: "Invoice Amt", value: "amount" },
  { label: "Advance", value: "advance" },
  { label: "Truck Hire Cost", value: "truckHireCost" },
]

export default function TripsPage() {
  const router = useRouter()
  const [visibleColumns, setVisibleColumns] = useState<string[]>(columnOptions.map((col) => col.label))
  const [sortConfig, setSortConfig] = useState<{ key: keyof ITrip | null; direction: "asc" | "desc" }>({
    key: null,
    direction: "asc",
  })
  const [searchQuery, setSearchQuery] = useState("")
  const [selectedStatus, setSelectedStatus] = useState<number | undefined>()
  const [startDateFilter, setStartDateFilter] = useState<Date>(new Date(Date.now() - 30 * 24 * 60 * 60 * 1000))
  const [endDateFilter, setEndDateFilter] = useState<Date>(new Date())
  const [openOptionsId, setOpenOptionsId] = useState<string | null>(null)
  const [edit, setEdit] = useState(false)
  const [selectedTrip, setSelectedTrip] = useState<ITrip | null>(null)
  const [invoiceOpen, setInvoiceOpen] = useState(false)
  const { toast } = useToast()

  const { data: trips, isLoading, error } = useGetTripsQuery(selectedStatus)
  const [deleteTrip] = useDeleteTripMutation()
  const [updateTripStatus] = useUpdateTripStatusMutation()
  const [editTrip] = useEditTripMutation()
  const { refetchTrips } = useExpenseData()

  useEffect(() => {
    refetchTrips()
  }, [refetchTrips])

  useEffect(() => {
    const storedColumns = localStorage.getItem("visibleColumns")

    if (storedColumns) {
      try {
        const parsedColumns = JSON.parse(storedColumns)
        if (Array.isArray(parsedColumns) && parsedColumns.length > 0) {
          setVisibleColumns(parsedColumns)
          return // Exit early if valid stored columns are found
        }
      } catch (error) {
        console.error("Error parsing visibleColumns from localStorage:", error)
      }
    }

    // If no valid stored columns, set default visible columns
    setVisibleColumns(columnOptions.map((col) => col.label))
  }, [])

  const handleStatusChange = useCallback((value: string) => {
    setSelectedStatus(value === "all" ? undefined : Number.parseInt(value))
  }, [])

  const handleDelete = useCallback(
    async (tripId: string) => {
      try {
        await deleteTrip(tripId).unwrap()
        toast({
          description: "Trip deleted successfully",
        })
      } catch (error) {
        console.error("Error deleting trip:", error)
        toast({
          description: "Error deleting trip",
          variant: "destructive",
        })
      }
    },
    [deleteTrip, toast],
  )

  const handleUndoStatus = useCallback(
    async (trip: ITrip) => {
      if (trip.status === 0) {
        toast({
          description: "Cannot undo status change for this trip. It's already in the initial status",
          variant: "warning",
        })
        return
      }
      const newStatus = (trip.status as number) - 1
      const newDates = trip.dates.map((date, index, array) => (index === array.length - 1 ? null : date))
      try {
        await updateTripStatus({
          tripId: trip.trip_id,
          status: newStatus,
          dates: newDates as (string | null)[],
        }).unwrap()
        toast({
          description: "Status updated successfully",
        })
      } catch (error) {
        console.error("Error updating status:", error)
        toast({
          description: "Error updating status",
          variant: "destructive",
        })
      }
    },
    [updateTripStatus, toast],
  )

  const handleDuplicate = useCallback(
    (e: React.MouseEvent, trip: ITrip) => {
      e.stopPropagation()
      router.push(`/user/trips/create?trip=${encodeURIComponent(JSON.stringify(trip))}`)
      setOpenOptionsId(null)
    },
    [router],
  )

  const debouncedSearch = useMemo(() => debounce((query: string) => setSearchQuery(query), 300), [])

  const handleSearch = useCallback(
    (e: React.ChangeEvent<HTMLInputElement>) => {
      debouncedSearch(e.target.value.toLowerCase())
    },
    [debouncedSearch],
  )

  const toggleColumn = useCallback((column: string) => {
    setVisibleColumns((prev) => {
      const updatedColumns = prev.includes(column) ? prev.filter((col) => col !== column) : [...prev, column]

      // Save to localStorage
      localStorage.setItem("visibleColumns", JSON.stringify(updatedColumns))
      return updatedColumns
    })
  }, [])

 const sortedTrips = useMemo(() => {
  if (!trips) return [];
  let filteredTrips = [...trips.trips].filter((trip) => {
    const tripDate = new Date(trip.startDate);
    return tripDate >= startDateFilter && tripDate <= endDateFilter;
  });

  if (searchQuery) {
    const lowercaseQuery = searchQuery.toLowerCase();

    // Attempt to parse the search query as a number
    const numericQuery = Number(searchQuery);
    const isNumericQuery = !isNaN(numericQuery);

    // Split the query for route matching
    const routeParts = lowercaseQuery.split(/\s*->\s*|\s+/).filter(Boolean);
    const queryOrigin = routeParts[0] || "";
    const queryDestination = routeParts[1] || "";

    // Route-based matching
    const routeMatches = filteredTrips.filter((trip) => {
      const origin = trip.route?.origin?.toLowerCase() || "";
      const destination = trip.route?.destination?.toLowerCase() || "";

      if (queryOrigin && queryDestination) {
        return (
          (origin.includes(queryOrigin) && destination.includes(queryDestination)) ||
          (origin.includes(queryDestination) && destination.includes(queryOrigin))
        );
      }

      return origin.includes(queryOrigin) || destination.includes(queryOrigin);
    });

    // Match other fields (strings and numbers)
    const otherFieldMatches = filteredTrips.filter((trip) =>
      Object.values(trip).some((value) => {
        if (typeof value === "string") {
          return value.toLowerCase().includes(lowercaseQuery);
        } else if (typeof value === "number" && isNumericQuery) {
          return value === numericQuery || value.toString().includes(searchQuery);
        }
        return false;
      })
    );

    // Combine results
    const combinedResults = [...new Set([...routeMatches, ...otherFieldMatches])];
    filteredTrips = combinedResults;
  }

  // Default safeguard: sort by startDate descending (latest trips first)
  filteredTrips.sort((a, b) => {
    const aDate = new Date(a.startDate).getTime();
    const bDate = new Date(b.startDate).getTime();
    return bDate - aDate; // descending order
  });

  // Preserve manual sort (if user clicked a column)
  if (sortConfig.key) {
    filteredTrips.sort((a, b) => {
      if (a[sortConfig.key!] < b[sortConfig.key!]) return sortConfig.direction === "asc" ? -1 : 1;
      if (a[sortConfig.key!] > b[sortConfig.key!]) return sortConfig.direction === "asc" ? 1 : -1;
      return 0;
    });
  }

  // Compute advanceTotal for each trip
  const processedTrips = filteredTrips.map(trip => {
    const advanceSum = (trip.tripAccounts ?? [])
      .filter(acc => acc.accountType === 'Advances')
      .reduce((sum, acc) => sum + (acc.amount ?? 0), 0);
    return { ...trip, advanceTotal: advanceSum };
  });

  // <-- Return the processed trips with advanceTotal
  return processedTrips;
}, [trips, sortConfig, searchQuery, startDateFilter, endDateFilter]);


  const requestSort = useCallback((key: keyof ITrip) => {
    setSortConfig((prevConfig) => ({
      key,
      direction: prevConfig.key === key && prevConfig.direction === "asc" ? "desc" : "asc",
    }))
  }, [])

  const getSortIcon = useCallback(
    (columnName: keyof ITrip) => {
      if (sortConfig.key === columnName) {
        return sortConfig.direction === "asc" ? <FaSortUp /> : <FaSortDown />
      }
      return <FaSort />
    },
    [sortConfig],
  )

  const handleEdit = useCallback(
    async (data: Partial<ITrip>) => {
      if (!selectedTrip) return
      try {
        await editTrip({ tripId: selectedTrip.trip_id, tripData: data }).unwrap()
        toast({
          description: "Trip Edited Successfully",
        })
      } catch (error) {
        console.error("Error editing trip:", error)
        toast({
          description: "Error Editing Trip",
          variant: "destructive",
        })
      } finally {
        setSelectedTrip(null)
        setEdit(false)
      }
    },
    [selectedTrip, editTrip, toast],
  )

  const handleExportToExcel = async () => {
  const selectedColumns = [
    "startDate",
    "LR",
    "truck",
    "from",
    "to",
    "partyName",
    "amount",
    "advance",
    "truckHireCost",
    "balance"
  ];

  const columnHeaders: Record<string, string> = {
    startDate: "Start Date",
    LR: "LR & FM Number",
    truck: "Truck Number",
    from: "Origin",
    to: "Destination",
    partyName: "Party Name",
    amount: "Amount",
    advance: "Advance Amount",
    truckHireCost: "Truck Hire Cost",
    balance: "Party Balance"
  };

  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet("Trips");

  // Define columns with headers and keys
  worksheet.columns = selectedColumns.map(col => ({
    header: columnHeaders[col] || col,
    key: col,
    width: 25
  }));

  // Add rows with mapped data
  sortedTrips.forEach(trip => {
    worksheet.addRow({
      startDate: trip.startDate ? new Date(trip.startDate).toLocaleDateString("en-IN") : "",
      LR: `${trip.LR ?? ""}${trip.LR && trip.fmNo ? ", " : ""}${trip.fmNo ?? ""}`,
      truck: trip.truck ?? "",
      from: trip.route?.origin ?? "",
      to: trip.route?.destination ?? "",
      partyName: trip.partyName ?? "",
      amount: trip.amount ?? 0,
      advance: trip.advanceTotal ?? 0,
      truckHireCost: trip.truckHireCost ?? 0,
      balance: trip.balance ?? 0,
    });
  });

  // Style header row (bright orange background, bold text)
  const headerRow = worksheet.getRow(1);
  headerRow.eachCell(cell => {
    cell.fill = {
      type: "pattern",
      pattern:"solid",
      fgColor:{argb:"FFFFA500"} // Bright orange
    };
    cell.font = { bold: true, color: { argb: "FFFFFFFF" } }; // White bold text
    cell.border = {
      top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'}
    }
  });

  // Style data rows: alternate light grey and light orange background
  worksheet.eachRow({ includeEmpty: false }, (row, rowNumber) => {
    if (rowNumber === 1) return; // skip header
    const fillColor = rowNumber % 2 === 0 ? "FFF5F5F5" : "FFFFFBE5"; // grey / light orange
    row.eachCell(cell => {
      cell.fill = {
        type: "pattern",
        pattern: "solid",
        fgColor: { argb: fillColor }
      };
      cell.border = {
        top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'}
      };
    });
  });

  // Generate buffer and save
  const buffer = await workbook.xlsx.writeBuffer();
  const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });

  // Generate date in DD-MM-YYYY format
  const today = new Date();
  const day = String(today.getDate()).padStart(2, '0');
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const year = today.getFullYear();
  const dateStr = `${day}-${month}-${year}`;
  const fileName = `Trips_${dateStr}.xlsx`;

  saveAs(blob, fileName);
};







//   const handleExportToExcel = () => {
//   const selectedColumns = [
//     "startDate",
//     "LR/FM",
//     "truck",
//     "from",
//     "to",
//     "partyName",
//     "amount",
//     "advance",
//     "truckHireCost",
//     "balance"
//   ]; // Define the columns you want

//   const columnHeaders: Record<string, string> = {
//     startDate: "Start Date",
//     "LR/FM": "LR/FM Number",
//     truck: "Truck Number",
//     from: "Origin",
//     to: "Destination",
//     partyName: "Party Name",
//     amount: "Amount",
//     advance: "Advance Amount",
//     truckHireCost: "Truck Hire Cost",
//     balance: "Party Balance"
//   };

//   // Map trips to export rows with custom headers and formatted date
//   const filteredData = sortedTrips.map(trip => {
//     const baseData = Object.fromEntries(
//       selectedColumns.map(col => {
//         if (col.toLowerCase() === "advance") {
//           return [columnHeaders[col] || col, trip.advanceTotal ?? 0];
//         }
//         if (col === "from") {
//           return [columnHeaders[col] || col, trip.route?.origin || ""];
//         }
//         if (col === "to") {
//           return [columnHeaders[col] || col, trip.route?.destination || ""];
//         }
//         if (hasKey(trip, col)) {
//           return [columnHeaders[col] || col, trip[col] ?? ""];
//         }
//         return [columnHeaders[col] || col, ""];
//       })
//     );

//     return {
//       ...baseData,
//       [columnHeaders["startDate"] || "startDate"]: new Date(trip.startDate).toLocaleDateString('en-IN') || "",
//     };
//   });

//   const worksheet = XLSX.utils.json_to_sheet(filteredData);

//   // Ensure worksheet range is set
//   if (!worksheet['!ref']) {
//     worksheet['!ref'] = XLSX.utils.encode_range({
//       s: { c: 0, r: 0 },
//       e: { c: selectedColumns.length - 1, r: filteredData.length - 1 },
//     });
//   }

//   // Apply orange background and borders to all cells
//   const range = XLSX.utils.decode_range(worksheet['!ref']);
//   for (let rowNum = range.s.r; rowNum <= range.e.r; ++rowNum) {
//     for (let colNum = range.s.c; colNum <= range.e.c; ++colNum) {
//       const cellRef = XLSX.utils.encode_cell({ c: colNum, r: rowNum });
//       if (!worksheet[cellRef]) continue;
//       worksheet[cellRef].s = {
//         fill: {
//           patternType: "solid",
//           fgColor: { rgb: "FFFFA500" }, // Bright Orange (RGBA)
//         },
//         border: {
//           top: { style: "thin", color: { rgb: "000000" } },
//           bottom: { style: "thin", color: { rgb: "000000" } },
//           left: { style: "thin", color: { rgb: "000000" } },
//           right: { style: "thin", color: { rgb: "000000" } }
//         }
//       };
//     }
//   }

//   const workbook = XLSX.utils.book_new();
//   XLSX.utils.book_append_sheet(workbook, worksheet, "Trips");

//   const excelBuffer = XLSX.write(workbook, {
//     bookType: "xlsx",
//     type: "array",
//     cellStyles: true, // Enable style preservation
//   });

//   const data = new Blob([excelBuffer], {
//     type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
//   });

//   saveAs(data, "trips.xlsx");
// };



  
  

  if (isLoading) return <Loading />
  if (error) return <div className="flex justify-center items-center h-full text-red-500">Error loading trips</div>

  return (
    <div className="w-full p-4 h-full bg-white">
      <div className="flex w-full px-4 md:px-60">
        <input
          type="text"
          placeholder={`Search from ${trips?.trips.length || 0} trips...`}
          onChange={handleSearch}
          className="w-full p-2 border rounded"
        />
      </div>

      <div className="flex flex-col md:flex-row items-center justify-between mt-4">
  <div className="flex items-center bg-orange-100 rounded-sm text-orange-800 p-2 mb-2 md:mb-0">
    <span>Total Balance:</span>
    <span className="ml-2 text-lg font-bold">
      {trips ? formatNumber(trips.trips.reduce((acc, trip) => acc + trip.balance, 0)) : "Calculating..."}
    </span>
  </div>

  <div className="flex items-end space-x-2 p-2">
    {/*  Date Range Filter */}
    <div className="flex items-center space-x-2 p-2">
      <div className="flex flex-col">
        <label className="text-sm font-medium text-gray-700">From</label>
        <input
          type="date"
          value={startDateFilter.toISOString().split("T")[0]}
          onChange={(e) => setStartDateFilter(new Date(e.target.value))}
          onClick={(e) => (e.target as HTMLInputElement).showPicker()}
          className="border rounded p-1"
        />
      </div>
      <div className="flex flex-col">
        <label className="text-sm font-medium text-gray-700">To</label>
        <input
          type="date"
          value={endDateFilter.toISOString().split("T")[0]}
          onChange={(e) => setEndDateFilter(new Date(e.target.value))}
          onClick={(e) => (e.target as HTMLInputElement).showPicker()}
          className="border rounded p-1"
        />
      </div>
    </div>
    {/*  End Date Range Filter */}

    <Select value={selectedStatus?.toString() ?? "all"} onValueChange={handleStatusChange}>
      <SelectTrigger className="w-[180px]">
        <SelectValue placeholder="Filter by status" />
      </SelectTrigger>
      <SelectContent>
        <SelectItem value="all">All Statuses</SelectItem>
        {statuses.map((status, index) => (
          <SelectItem key={index} value={index.toString()}>
            {status}
          </SelectItem>
        ))}
      </SelectContent>
    </Select>

    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="outline">Select Columns</Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent>
        {columnOptions.map((col) => (
          <DropdownMenuItem key={col.value} asChild>
            <label className="flex items-center space-x-2">
              <input
                type="checkbox"
                checked={visibleColumns.includes(col.label)}
                onChange={() => toggleColumn(col.label)}
              />
              <span>{col.label}</span>
            </label>
          </DropdownMenuItem>
        ))}
      </DropdownMenuContent>
    </DropdownMenu>

    <Button onClick={() => setInvoiceOpen(true)}>Generate Invoice</Button>
    <Button onClick={handleExportToExcel}>Export to Excel</Button>
  </div>
</div>


      {!trips || trips.trips.length === 0 ? (
        <div className="flex justify-center items-center h-full text-gray-500">No trips found</div>
      ) : (
        <div className="w-full overflow-x-auto">
          {edit && (
            <EditTripForm
              isOpen={edit}
              onClose={() => {
                setEdit(false)
                setSelectedTrip(null)
              }}
              trip={selectedTrip as ITrip}
              onSubmit={handleEdit}
            />
          )}

          <Table>
            <TableHeader>
              <TableRow>
                {columnOptions.map(
                  (col) =>
                    visibleColumns.includes(col.label) && (
                      <TableHead key={col.value} onClick={() => requestSort(col.value as keyof ITrip)}>
                        <div className="flex justify-center items-center">
                          {col.label} {col.value !== "route" && getSortIcon(col.value as keyof ITrip)}
                        </div>
                      </TableHead>
                    ),
                )}
                <TableHead onClick={() => requestSort("balance")}>
                  <div className="flex justify-center items-center">Party Balance {getSortIcon("balance")}</div>
                </TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {sortedTrips.map((trip: typeof sortedTrips[number], index: number) => (
                <TableRow
                  key={trip.trip_id}
                  className="hover:bg-orange-50 cursor-pointer transition-colors duration-200"
                  onClick={() => router.push(`/user/trips/${trip.trip_id}`)}
                  index={index + 1}
                >
                  {columnOptions.map(
                    (col) =>
                      visibleColumns.includes(col.label) && (
                        <TableCell key={col.value}>{renderCellContent(col.value, trip)}</TableCell>
                      ),
                  )}
                  <TableCell>
                    <div className="flex items-center justify-between">
                      <p className="text-green-600 font-semibold">{formatNumber(trip.balance)}</p>
                      <DropdownMenu>
                        <DropdownMenuTrigger asChild>
                          <button
                            className="rounded-full p-1 bg-transparent hover:bg-lightOrangeButtonColor hover:text-white transition-all duration-300 ease-in-out border-none"
                            onClick={(e) => {
                              e.stopPropagation()
                              setOpenOptionsId(openOptionsId === trip.trip_id ? null : trip.trip_id)
                            }}
                          >
                            <SlOptionsVertical />
                          </button>
                        </DropdownMenuTrigger>
                        <DropdownMenuContent>
                          <DropdownMenuItem
                            onClick={(e) => handleDuplicate(e, trip as ITrip)}
                            className="cursor-pointer hover:bg-orange-100 transition-colors duration-200"
                          >
                            <IoDuplicateOutline className="mr-2" /> Duplicate
                          </DropdownMenuItem>
                          <DropdownMenuItem
                            onClick={(e) => {
                              e.stopPropagation()
                              handleUndoStatus(trip as ITrip)
                            }}
                            className="cursor-pointer hover:bg-orange-100 transition-colors duration-200"
                          >
                            <IoMdUndo className="mr-2" />
                            Undo Status
                          </DropdownMenuItem>
                          <DropdownMenuItem
                            onClick={(e) => {
                              e.stopPropagation()
                              setEdit(true)
                              setSelectedTrip(trip as ITrip)
                            }}
                            className="cursor-pointer hover:bg-orange-100 transition-colors duration-200"
                          >
                            <MdEdit className="mr-2" /> Edit Trip
                          </DropdownMenuItem>
                          <DropdownMenuItem
                            onClick={(e) => {
                              e.stopPropagation()
                              handleDelete(trip.trip_id)
                            }}
                            className="cursor-pointer hover:bg-orange-100 transition-colors duration-200"
                          >
                            <MdDelete className="mr-2" /> Delete Trip
                          </DropdownMenuItem>
                        </DropdownMenuContent>
                      </DropdownMenu>
                    </div>
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </div>
      )}
      <InvoiceForm open={invoiceOpen} setOpen={setInvoiceOpen} />
    </div>
  )
}

function renderCellContent(columnValue: string, trip: ITrip | any) {
  switch (columnValue) {
    case "startDate":
      return (
        <div>
          <div className="flex items-center space-x-2">
            <FaCalendarAlt className="text-orange-600" />
            <span>{new Date(trip.startDate).toLocaleDateString("en-IN")}</span>
          </div>
          <div>
            <span className="font-medium flex gap-[1px] text-xs text-gray-500 whitespace-nowrap">
              EWB Validity :{ewbColor(trip)}
            </span>
          </div>
        </div>
      )
    case "LR":
  return (
    <>
      {trip.LR}
      <br />
      {trip.fmNo}
    </>
  );
    case "truck":
      return (
        <>
          <div className="flex items-center space-x-2">
            <FaTruck className="text-orange-600" />
            <span>{trip.truck}</span>
          </div>
          <Link onClick={(e) => e.stopPropagation()} href={`/user/drivers/${trip.driver}`}>
            <Button variant={"link"} className="text-xs">
              {trip.driverName}
            </Button>
          </Link>
        </>
      )
    case "party":
      return trip.partyName
    case "route":
      return `${trip.route.origin.split(",")[0]}  ${trip.route.destination.split(",")[0]}`
    case "status":
      return (
        <div className="flex flex-col items-center space-y-1">
          <span>{statuses[trip.status as number]}</span>
          <div className="relative w-full bg-gray-200 h-2 rounded">
            <div
              className={`absolute top-0 left-0 h-2 rounded transition-all duration-500 ${
                trip.status === 0
                  ? "bg-red-500"
                  : trip.status === 1
                    ? "bg-yellow-500"
                    : trip.status === 2
                      ? "bg-blue-500"
                      : trip.status === 3
                        ? "bg-green-500"
                        : "bg-green-800"
              }`}
              style={{ width: `${((trip.status as number) + 1) * 20}%` }}
            />
          </div>
        </div>
      )
    case "amount":
      return <p className="text-green-600 font-semibold">{formatNumber(trip.amount)}</p>
    case "advance":
  return (
    <p className="text-blue-600 font-semibold">
      {trip.advanceTotal ? formatNumber(trip.advanceTotal) : "0"}
    </p>
  );
    case "truckHireCost":
      return (
        <p className="text-red-500 font-semibold">
          {trip.truckHireCost ? "" + formatNumber(trip.truckHireCost) : "NA"}
        </p>
      )
    default:
      return null
  }
}
</file>

</files>
